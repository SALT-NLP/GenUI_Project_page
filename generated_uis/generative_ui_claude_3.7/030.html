<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Citation Formatter Pro</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto+Mono&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4a6fa5;
            --primary-light: #5d80b6;
            --primary-dark: #3a5a8a;
            --secondary-color: #6d98ba;
            --accent-color: #ff7e5f;
            --accent-hover: #ff6a4a;
            --text-color: #333;
            --text-light: #757575;
            --light-gray: #f5f5f5;
            --medium-gray: #e0e0e0;
            --dark-gray: #757575;
            --success-color: #4caf50;
            --error-color: #f44336;
            --warning-color: #ff9800;
            --border-radius: 8px;
            --box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            --transition: all 0.25s ease;
            --font-primary: 'Inter', 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            --font-mono: 'Roboto Mono', 'Courier New', monospace;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-primary);
            line-height: 1.6;
            color: var(--text-color);
            background-color: #f9f9f9;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            border-radius: var(--border-radius);
            background-color: white;
            box-shadow: var(--box-shadow);
            transition: var(--transition);
        }

        header:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        h1 {
            color: var(--primary-color);
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 2.2rem;
        }

        .subtitle {
            color: var(--dark-gray);
            font-size: 1.1rem;
        }

        .app-container {
            display: flex;
            flex-direction: column;
            gap: 30px;
            background-color: #fff;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 30px;
            transition: var(--transition);
        }

        .app-container:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12);
        }

        @media (min-width: 992px) {
            .app-container {
                flex-direction: row;
            }
        }

        .source-panel {
            flex: 1;
        }

        .output-panel {
            flex: 1;
        }

        .panel-title {
            color: var(--primary-color);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--medium-gray);
            font-size: 1.3rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .panel-title-icon {
            font-size: 1.4rem;
        }

        /* Source Type Selection */
        .source-type-selector {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 10px;
            scrollbar-width: thin;
            scrollbar-color: var(--medium-gray) var(--light-gray);
        }

        .source-type-selector::-webkit-scrollbar {
            height: 6px;
        }

        .source-type-selector::-webkit-scrollbar-track {
            background: var(--light-gray);
            border-radius: 10px;
        }

        .source-type-selector::-webkit-scrollbar-thumb {
            background-color: var(--medium-gray);
            border-radius: 10px;
        }

        .source-type-btn {
            background-color: var(--light-gray);
            border: none;
            border-radius: var(--border-radius);
            padding: 10px 15px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            position: relative;
            overflow: hidden;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .source-type-btn::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background-color: var(--primary-color);
            transition: var(--transition);
        }

        .source-type-btn:hover {
            background-color: var(--medium-gray);
        }

        .source-type-btn:hover::after {
            width: 100%;
        }

        .source-type-btn:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(74, 111, 165, 0.3);
        }

        .source-type-btn.active {
            background-color: var(--primary-color);
            color: white;
        }

        .source-type-btn.active::after {
            width: 100%;
            background-color: white;
        }

        /* Source Form */
        .source-form {
            display: none;
            animation: fadeIn 0.3s ease;
            background-color: var(--light-gray);
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .source-form.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: var(--dark-gray);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .required-field::after {
            content: '*';
            color: var(--error-color);
            margin-left: 4px;
        }

        .input-wrapper {
            position: relative;
        }

        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background-color: white;
            font-family: var(--font-primary);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(74, 111, 165, 0.2);
        }

        input:hover, select:hover, textarea:hover {
            border-color: var(--dark-gray);
        }

        input.error, select.error, textarea.error {
            border-color: var(--error-color);
            background-color: rgba(244, 67, 54, 0.05);
        }

        .error-message {
            color: var(--error-color);
            font-size: 0.8rem;
            margin-top: 5px;
            display: none;
        }

        .error-message.visible {
            display: block;
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes shake {
            10%, 90% { transform: translateX(-1px); }
            20%, 80% { transform: translateX(2px); }
            30%, 50%, 70% { transform: translateX(-4px); }
            40%, 60% { transform: translateX(4px); }
        }

        .help-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--dark-gray);
            cursor: pointer;
            font-size: 1rem;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background-color: var(--light-gray);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .help-icon:hover {
            background-color: var(--medium-gray);
            color: var(--primary-color);
        }

        .tooltip {
            position: absolute;
            right: -10px;
            top: calc(100% + 5px);
            background-color: #333;
            color: white;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            font-size: 0.8rem;
            width: 250px;
            z-index: 10;
            display: none;
            box-shadow: var(--box-shadow);
            line-height: 1.4;
        }

        .tooltip::before {
            content: '';
            position: absolute;
            top: -5px;
            right: 20px;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 5px solid #333;
        }

        .help-icon:hover .tooltip {
            display: block;
        }

        .actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }

        button::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.1);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }

        button:hover::after {
            transform: translateX(0);
        }

        button:active {
            transform: translateY(1px);
        }

        button:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(74, 111, 165, 0.3);
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--medium-gray);
            color: var(--text-color);
        }

        .btn-secondary:hover {
            background-color: #c7c7c7;
        }

        .btn-icon {
            font-size: 1.2rem;
        }

        /* Source List */
        .source-list {
            margin-top: 30px;
        }

        .source-list-title {
            font-size: 1.1rem;
            margin-bottom: 10px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .source-count {
            font-size: 0.9rem;
            color: var(--dark-gray);
            background-color: var(--light-gray);
            padding: 4px 8px;
            border-radius: 20px;
        }

        .source-item {
            padding: 15px;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            background-color: white;
            transition: var(--transition);
            position: relative;
        }

        .source-item:hover {
            box-shadow: var(--box-shadow);
            border-color: var(--primary-light);
            transform: translateY(-2px);
        }

        .source-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
        }

        .source-item-title {
            font-weight: 600;
            color: var(--primary-color);
        }

        .source-item-type {
            color: var(--dark-gray);
            font-size: 0.9rem;
            background-color: var(--light-gray);
            padding: 2px 8px;
            border-radius: 20px;
        }

        .source-item-details {
            font-size: 0.9rem;
            color: var(--dark-gray);
        }

        .source-item-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            justify-content: flex-end;
        }

        .action-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            padding: 5px 8px;
            transition: var(--transition);
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 4px;
            border-radius: var(--border-radius);
        }

        .action-btn:hover {
            color: var(--accent-color);
            background-color: var(--light-gray);
        }

        /* Citation Style */
        .citation-style {
            margin-bottom: 20px;
        }

        .style-selector {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background-color: white;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23757575' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
            cursor: pointer;
        }

        .style-selector:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(74, 111, 165, 0.2);
        }

        .style-selector:hover {
            border-color: var(--dark-gray);
        }

        /* Output Areas */
        .output-area {
            margin-bottom: 20px;
            background-color: var(--light-gray);
            padding: 20px;
            border-radius: var(--border-radius);
            transition: var(--transition);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .output-area:hover {
            box-shadow: var(--box-shadow);
        }

        .output-area h3 {
            margin-bottom: 10px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: space-between;
        }

        .output-content {
            background-color: white;
            padding: 15px;
            border-radius: var(--border-radius);
            min-height: 100px;
            margin-bottom: 10px;
            white-space: pre-wrap;
            font-family: var(--font-mono);
            line-height: 1.5;
            border: 1px solid var(--medium-gray);
            position: relative;
            overflow-y: auto;
            max-height: 300px;
        }

        .output-content::-webkit-scrollbar {
            width: 8px;
        }

        .output-content::-webkit-scrollbar-track {
            background: var(--light-gray);
            border-radius: 10px;
        }

        .output-content::-webkit-scrollbar-thumb {
            background: var(--medium-gray);
            border-radius: 10px;
        }

        .output-content::-webkit-scrollbar-thumb:hover {
            background: var(--dark-gray);
        }

        .copy-btn {
            display: flex;
            align-items: center;
            gap: 5px;
            background-color: var(--secondary-color);
            color: white;
        }

        .copy-btn:hover {
            background-color: #5a81a0;
        }

        .empty-message {
            color: var(--dark-gray);
            font-style: italic;
            text-align: center;
            padding: 20px;
        }

        /* Notifications */
        .notification {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: var(--border-radius);
            color: white;
            opacity: 0;
            transition: opacity 0.3s ease, transform 0.3s ease;
            z-index: 100;
            transform: translateY(20px);
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: var(--box-shadow);
        }

        .notification.success {
            background-color: var(--success-color);
        }

        .notification.error {
            background-color: var(--error-color);
        }

        .notification.warning {
            background-color: var(--warning-color);
        }

        .notification.show {
            opacity: 1;
            transform: translateY(0);
        }

        /* Preview Section */
        .style-preview {
            background-color: white;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-top: 10px;
            font-size: 0.9rem;
            border: 1px solid var(--medium-gray);
            transition: var(--transition);
        }

        .style-preview:hover {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .preview-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .preview-content p {
            margin-bottom: 8px;
        }

        /* Loading indicator */
        .loading-indicator {
            display: none;
            justify-content: center;
            align-items: center;
            gap: 10px;
            padding: 10px 0;
        }

        .loading-indicator.active {
            display: flex;
        }

        .spinner {
            border: 3px solid var(--light-gray);
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Keyboard shortcuts */
        .keyboard-shortcut {
            display: inline-flex;
            align-items: center;
            margin-left: auto;
            color: var(--dark-gray);
            font-size: 0.8rem;
        }

        .key {
            background-color: var(--light-gray);
            border: 1px solid var(--medium-gray);
            border-radius: 4px;
            padding: 1px 6px;
            margin: 0 2px;
            font-family: var(--font-mono);
        }

        /* Dark mode toggle */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: var(--box-shadow);
            z-index: 100;
            transition: var(--transition);
        }

        .theme-toggle:hover {
            background-color: var(--primary-dark);
            transform: scale(1.05);
        }

        /* Search functionality */
        .search-container {
            margin-bottom: 20px;
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 12px 40px 12px 12px;
            border: 1px solid var(--medium-gray);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(74, 111, 165, 0.2);
        }

        .search-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--dark-gray);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .app-container {
                padding: 20px;
            }
            
            .source-type-selector {
                overflow-x: auto;
                padding-bottom: 10px;
            }
            
            .source-type-btn {
                white-space: nowrap;
            }
            
            .actions {
                flex-direction: column;
            }
            
            button {
                width: 100%;
                justify-content: center;
            }

            .theme-toggle {
                top: 10px;
                right: 10px;
                width: 36px;
                height: 36px;
            }
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #121212;
            color: #e0e0e0;
        }

        body.dark-mode header,
        body.dark-mode .app-container,
        body.dark-mode .source-item,
        body.dark-mode .style-preview,
        body.dark-mode .output-content {
            background-color: #1e1e1e;
            border-color: #333;
        }

        body.dark-mode h1,
        body.dark-mode .panel-title,
        body.dark-mode .source-item-title,
        body.dark-mode .preview-title {
            color: #7ba4d9;
        }

        body.dark-mode .subtitle,
        body.dark-mode .source-item-details,
        body.dark-mode .empty-message {
            color: #b0b0b0;
        }

        body.dark-mode input, 
        body.dark-mode select, 
        body.dark-mode textarea {
            background-color: #2a2a2a;
            border-color: #444;
            color: #e0e0e0;
        }

        body.dark-mode .source-form,
        body.dark-mode .output-area,
        body.dark-mode .light-gray-bg {
            background-color: #252525;
        }

        body.dark-mode .source-type-btn {
            background-color: #333;
        }

        body.dark-mode .source-type-btn.active {
            background-color: var(--primary-color);
        }

        body.dark-mode .btn-secondary {
            background-color: #444;
            color: #e0e0e0;
        }

        body.dark-mode .btn-secondary:hover {
            background-color: #555;
        }

        body.dark-mode .key {
            background-color: #333;
            border-color: #555;
            color: #e0e0e0;
        }

        body.dark-mode .theme-toggle {
            background-color: #7ba4d9;
        }

        body.dark-mode .theme-toggle:hover {
            background-color: #6a93c8;
        }

        /* Drag and drop for sources */
        .source-item.dragging {
            opacity: 0.5;
            border: 2px dashed var(--primary-color);
        }

        .drag-handle {
            cursor: grab;
            color: var(--dark-gray);
            margin-right: 8px;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        /* Export/Import functionality */
        .export-import-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .export-btn, .import-btn {
            padding: 8px 12px;
            font-size: 0.9rem;
        }

        #import-file {
            display: none;
        }

        /* Tooltips for formatted content */
        .citation-tooltip {
            position: absolute;
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            padding: 8px 12px;
            border-radius: var(--border-radius);
            font-size: 0.85rem;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
            z-index: 100;
            max-width: 300px;
            display: none;
        }

        body.dark-mode .citation-tooltip {
            background-color: #2a2a2a;
            border-color: #444;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }

        /* Keyboard navigation highlight */
        *:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* Accessibility improvements */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }
    </style>
</head>
<body>
    <div class="theme-toggle" role="button" aria-label="Toggle dark mode" tabindex="0">
        <span class="material-icons" id="theme-icon">dark_mode</span>
    </div>
    
    <div class="container">
        <header>
            <h1>Citation Formatter Pro</h1>
            <p class="subtitle">Format your citations and bibliography with ease for your thesis</p>
        </header>

        <div class="app-container">
            <div class="source-panel">
                <h2 class="panel-title">
                    <span class="material-icons panel-title-icon">add_circle</span>
                    Add Sources
                </h2>
                
                <div class="search-container">
                    <input type="text" id="source-search" class="search-input" placeholder="Search your sources..." aria-label="Search sources">
                    <span class="material-icons search-icon">search</span>
                </div>
                
                <div class="export-import-container">
                    <button id="export-sources" class="btn-secondary export-btn">
                        <span class="material-icons">file_download</span>
                        Export
                    </button>
                    <button id="import-trigger" class="btn-secondary import-btn">
                        <span class="material-icons">file_upload</span>
                        Import
                    </button>
                    <input type="file" id="import-file" accept=".json">
                </div>
                
                <div class="source-type-selector">
                    <button class="source-type-btn active" data-type="book" aria-pressed="true">
                        <span class="material-icons">menu_book</span> Book
                    </button>
                    <button class="source-type-btn" data-type="article" aria-pressed="false">
                        <span class="material-icons">article</span> Journal Article
                    </button>
                    <button class="source-type-btn" data-type="website" aria-pressed="false">
                        <span class="material-icons">language</span> Website
                    </button>
                    <button class="source-type-btn" data-type="thesis" aria-pressed="false">
                        <span class="material-icons">school</span> Thesis
                    </button>
                    <button class="source-type-btn" data-type="chapter" aria-pressed="false">
                        <span class="material-icons">bookmark</span> Book Chapter
                    </button>
                </div>

                <!-- Book Form -->
                <form id="book-form" class="source-form active">
                    <div class="form-group">
                        <label for="book-title" class="required-field">Book Title</label>
                        <div class="input-wrapper">
                            <input type="text" id="book-title" required aria-required="true">
                            <div class="help-icon" tabindex="0" aria-label="Help for book title">?
                                <span class="tooltip">Enter the full title of the book as it appears on the title page</span>
                            </div>
                        </div>
                        <div class="error-message" id="book-title-error">Please enter the book title</div>
                    </div>
                    <div class="form-group">
                        <label for="book-authors" class="required-field">Author(s)</label>
                        <div class="input-wrapper">
                            <input type="text" id="book-authors" placeholder="e.g., Smith, J., & Jones, M." required aria-required="true">
                            <div class="help-icon" tabindex="0" aria-label="Help for book authors">?
                                <span class="tooltip">Enter author names in the format: Last, First, & Last, First. For multiple authors, separate with commas and ampersand (&)</span>
                            </div>
                        </div>
                        <div class="error-message" id="book-authors-error">Please enter at least one author</div>
                    </div>
                    <div class="form-group">
                        <label for="book-year" class="required-field">Year Published</label>
                        <div class="input-wrapper">
                            <input type="number" id="book-year" min="1000" max="2099" required aria-required="true">
                            <div class="help-icon" tabindex="0" aria-label="Help for publication year">?
                                <span class="tooltip">Enter the year the book was published (e.g., 2023)</span>
                            </div>
                        </div>
                        <div class="error-message" id="book-year-error">Please enter a valid year (1000-2099)</div>
                    </div>
                    <div class="form-group">
                        <label for="book-publisher" class="required-field">Publisher</label>
                        <input type="text" id="book-publisher" required aria-required="true">
                        <div class="error-message" id="book-publisher-error">Please enter the publisher</div>
                    </div>
                    <div class="form-group">
                        <label for="book-place">Place of Publication</label>
                        <input type="text" id="book-place" placeholder="e.g., New York, NY">
                    </div>
                    <div class="form-group">
                        <label for="book-edition">Edition</label>
                        <input type="text" id="book-edition" placeholder="e.g., 2nd">
                    </div>
                    <div class="form-group">
                        <label for="book-isbn">ISBN</label>
                        <input type="text" id="book-isbn" placeholder="e.g., 978-3-16-148410-0">
                    </div>
                    <div class="actions">
                        <button type="submit" class="btn-primary">
                            <span class="material-icons btn-icon">add</span>
                            Add Book
                        </button>
                        <button type="reset" class="btn-secondary">
                            <span class="material-icons btn-icon">clear</span>
                            Clear
                        </button>
                    </div>
                </form>

                <!-- Journal Article Form -->
                <form id="article-form" class="source-form">
                    <div class="form-group">
                        <label for="article-title" class="required-field">Article Title</label>
                        <input type="text" id="article-title" required aria-required="true">
                        <div class="error-message" id="article-title-error">Please enter the article title</div>
                    </div>
                    <div class="form-group">
                        <label for="article-authors" class="required-field">Author(s)</label>
                        <div class="input-wrapper">
                            <input type="text" id="article-authors" placeholder="e.g., Smith, J., & Jones, M." required aria-required="true">
                            <div class="help-icon" tabindex="0" aria-label="Help for article authors">?
                                <span class="tooltip">Enter author names in the format: Last, First, & Last, First. For multiple authors, separate with commas and ampersand (&)</span>
                            </div>
                        </div>
                        <div class="error-message" id="article-authors-error">Please enter at least one author</div>
                    </div>
                    <div class="form-group">
                        <label for="article-year" class="required-field">Year Published</label>
                        <input type="number" id="article-year" min="1000" max="2099" required aria-required="true">
                        <div class="error-message" id="article-year-error">Please enter a valid year (1000-2099)</div>
                    </div>
                    <div class="form-group">
                        <label for="article-journal" class="required-field">Journal Name</label>
                        <div class="input-wrapper">
                            <input type="text" id="article-journal" required aria-required="true">
                            <div class="help-icon" tabindex="0" aria-label="Help for journal name">?
                                <span class="tooltip">Enter the full journal name (not abbreviated)</span>
                            </div>
                        </div>
                        <div class="error-message" id="article-journal-error">Please enter the journal name</div>
                    </div>
                    <div class="form-group">
                        <label for="article-volume">Volume</label>
                        <input type="text" id="article-volume">
                    </div>
                    <div class="form-group">
                        <label for="article-issue">Issue</label>
                        <input type="text" id="article-issue">
                    </div>
                    <div class="form-group">
                        <label for="article-pages">Pages</label>
                        <div class="input-wrapper">
                            <input type="text" id="article-pages" placeholder="e.g., 123-145">
                            <div class="help-icon" tabindex="0" aria-label="Help for article pages">?
                                <span class="tooltip">Enter page range (e.g., 123-145) or article number for electronic journals</span>
                            </div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="article-doi">DOI</label>
                        <div class="input-wrapper">
                            <input type="text" id="article-doi" placeholder="e.g., 10.1000/xyz123">
                            <div class="help-icon" tabindex="0" aria-label="Help for DOI">?
                                <span class="tooltip">Digital Object Identifier, usually found on the article page or PDF (e.g., 10.1000/xyz123)</span>
                            </div>
                        </div>
                    </div>
                    <div class="actions">
                        <button type="submit" class="btn-primary">
                            <span class="material-icons btn-icon">add</span>
                            Add Article
                        </button>
                        <button type="reset" class="btn-secondary">
                            <span class="material-icons btn-icon">clear</span>
                            Clear
                        </button>
                    </div>
                </form>

                <!-- Website Form -->
                <form id="website-form" class="source-form">
                    <div class="form-group">
                        <label for="website-title" class="required-field">Page Title</label>
                        <input type="text" id="website-title" required aria-required="true">
                        <div class="error-message" id="website-title-error">Please enter the page title</div>
                    </div>
                    <div class="form-group">
                        <label for="website-authors" class="required-field">Author(s)/Organization</label>
                        <input type="text" id="website-authors" required aria-required="true">
                        <div class="error-message" id="website-authors-error">Please enter the author or organization</div>
                    </div>
                    <div class="form-group">
                        <label for="website-year" class="required-field">Year Published/Updated</label>
                        <input type="number" id="website-year" min="1000" max="2099" required aria-required="true">
                        <div class="error-message" id="website-year-error">Please enter a valid year (1000-2099)</div>
                    </div>
                    <div class="form-group">
                        <label for="website-url" class="required-field">URL</label>
                        <input type="url" id="website-url" placeholder="https://example.com/page" required aria-required="true">
                        <div class="error-message" id="website-url-error">Please enter a valid URL (include https://)</div>
                    </div>
                    <div class="form-group">
                        <label for="website-accessed" class="required-field">Date Accessed</label>
                        <div class="input-wrapper">
                            <input type="date" id="website-accessed" required aria-required="true">
                            <div class="help-icon" tabindex="0" aria-label="Help for access date">?
                                <span class="tooltip">Enter the date when you accessed the website</span>
                            </div>
                        </div>
                        <div class="error-message" id="website-accessed-error">Please enter the date you accessed the website</div>
                    </div>
                    <div class="form-group">
                        <label for="website-site">Website Name</label>
                        <input type="text" id="website-site" placeholder="e.g., BBC News, Wikipedia">
                    </div>
                    <div class="actions">
                        <button type="submit" class="btn-primary">
                            <span class="material-icons btn-icon">add</span>
                            Add Website
                        </button>
                        <button type="reset" class="btn-secondary">
                            <span class="material-icons btn-icon">clear</span>
                            Clear
                        </button>
                    </div>
                </form>

                <!-- Thesis Form -->
                <form id="thesis-form" class="source-form">
                    <div class="form-group">
                        <label for="thesis-title" class="required-field">Thesis Title</label>
                        <input type="text" id="thesis-title" required aria-required="true">
                        <div class="error-message" id="thesis-title-error">Please enter the thesis title</div>
                    </div>
                    <div class="form-group">
                        <label for="thesis-author" class="required-field">Author</label>
                        <input type="text" id="thesis-author" required aria-required="true">
                        <div class="error-message" id="thesis-author-error">Please enter the author</div>
                    </div>
                    <div class="form-group">
                        <label for="thesis-year" class="required-field">Year</label>
                        <input type="number" id="thesis-year" min="1000" max="2099" required aria-required="true">
                        <div class="error-message" id="thesis-year-error">Please enter a valid year (1000-2099)</div>
                    </div>
                    <div class="form-group">
                        <label for="thesis-type" class="required-field">Type</label>
                        <select id="thesis-type" required aria-required="true">
                            <option value="doctoral">Doctoral dissertation</option>
                            <option value="masters">Master's thesis</option>
                            <option value="undergraduate">Undergraduate thesis</option>
                        </select>
                        <div class="error-message" id="thesis-type-error">Please select the thesis type</div>
                    </div>
                    <div class="form-group">
                        <label for="thesis-university" class="required-field">University/Institution</label>
                        <input type="text" id="thesis-university" required aria-required="true">
                        <div class="error-message" id="thesis-university-error">Please enter the university or institution</div>
                    </div>
                    <div class="form-group">
                        <label for="thesis-location">Location</label>
                        <input type="text" id="thesis-location" placeholder="e.g., Boston, MA">
                    </div>
                    <div class="form-group">
                        <label for="thesis-database">Database/Repository</label>
                        <div class="input-wrapper">
                            <input type="text" id="thesis-database" placeholder="e.g., ProQuest Dissertations">
                            <div class="help-icon" tabindex="0" aria-label="Help for database">?
                                <span class="tooltip">If the thesis was retrieved from an online database, enter the database name</span>
                            </div>
                        </div>
                    </div>
                    <div class="actions">
                        <button type="submit" class="btn-primary">
                            <span class="material-icons btn-icon">add</span>
                            Add Thesis
                        </button>
                        <button type="reset" class="btn-secondary">
                            <span class="material-icons btn-icon">clear</span>
                            Clear
                        </button>
                    </div>
                </form>

                <!-- Book Chapter Form -->
                <form id="chapter-form" class="source-form">
                    <div class="form-group">
                        <label for="chapter-title" class="required-field">Chapter Title</label>
                        <input type="text" id="chapter-title" required aria-required="true">
                        <div class="error-message" id="chapter-title-error">Please enter the chapter title</div>
                    </div>
                    <div class="form-group">
                        <label for="chapter-authors" class="required-field">Chapter Author(s)</label>
                        <input type="text" id="chapter-authors" placeholder="e.g., Smith, J., & Jones, M." required aria-required="true">
                        <div class="error-message" id="chapter-authors-error">Please enter at least one author</div>
                    </div>
                    <div class="form-group">
                        <label for="chapter-book-title" class="required-field">Book Title</label>
                        <input type="text" id="chapter-book-title" required aria-required="true">
                        <div class="error-message" id="chapter-book-title-error">Please enter the book title</div>
                    </div>
                    <div class="form-group">
                        <label for="chapter-editors" class="required-field">Editor(s)</label>
                        <div class="input-wrapper">
                            <input type="text" id="chapter-editors" placeholder="e.g., Smith, J., & Jones, M." required aria-required="true">
                            <div class="help-icon" tabindex="0" aria-label="Help for editors">?
                                <span class="tooltip">Enter editor names in the format: Last, First, & Last, First. For multiple editors, separate with commas and ampersand (&)</span>
                            </div>
                        </div>
                        <div class="error-message" id="chapter-editors-error">Please enter at least one editor</div>
                    </div>
                    <div class="form-group">
                        <label for="chapter-year" class="required-field">Year Published</label>
                        <input type="number" id="chapter-year" min="1000" max="2099" required aria-required="true">
                        <div class="error-message" id="chapter-year-error">Please enter a valid year (1000-2099)</div>
                    </div>
                    <div class="form-group">
                        <label for="chapter-pages" class="required-field">Page Range</label>
                        <input type="text" id="chapter-pages" placeholder="e.g., 123-145" required aria-required="true">
                        <div class="error-message" id="chapter-pages-error">Please enter the page range</div>
                    </div>
                    <div class="form-group">
                        <label for="chapter-publisher" class="required-field">Publisher</label>
                        <input type="text" id="chapter-publisher" required aria-required="true">
                        <div class="error-message" id="chapter-publisher-error">Please enter the publisher</div>
                    </div>
                    <div class="form-group">
                        <label for="chapter-place">Place of Publication</label>
                        <input type="text" id="chapter-place" placeholder="e.g., New York, NY">
                    </div>
                    <div class="actions">
                        <button type="submit" class="btn-primary">
                            <span class="material-icons btn-icon">add</span>
                            Add Chapter
                        </button>
                        <button type="reset" class="btn-secondary">
                            <span class="material-icons btn-icon">clear</span>
                            Clear
                        </button>
                    </div>
                </form>

                <div class="source-list">
                    <h3 class="source-list-title">
                        <div class="title-with-icon">
                            <span class="material-icons">format_list_bulleted</span>
                            Your Sources
                        </div>
                        <span class="source-count" id="source-count">0 sources</span>
                    </h3>
                    <div id="sources-container">
                        <p class="empty-message">No sources added yet. Add your first source above.</p>
                    </div>
                </div>
            </div>

            <div class="output-panel">
                <h2 class="panel-title">
                    <span class="material-icons panel-title-icon">format_quote</span>
                    Formatted Citations
                </h2>
                
                <div class="citation-style">
                    <label for="style-select">Citation Style</label>
                    <select id="style-select" class="style-selector">
                        <option value="apa">APA 7th Edition</option>
                        <option value="mla">MLA 9th Edition</option>
                        <option value="chicago">Chicago 17th Edition</option>
                        <option value="harvard">Harvard</option>
                        <option value="ieee">IEEE</option>
                        <option value="vancouver">Vancouver</option>
                    </select>
                </div>

                <div class="style-preview">
                    <p class="preview-title">
                        <span class="material-icons">preview</span>
                        Style Preview
                    </p>
                    <div id="style-preview-content" class="preview-content">
                        <p><strong>Book:</strong> Smith, J. (2020). <em>The comprehensive guide to citation styles</em>. Academic Press.</p>
                        <p><strong>Article:</strong> Jones, M., & Brown, L. (2021). Understanding citation formats. <em>Journal of Academic Writing</em>, 12(3), 45-67.</p>
                    </div>
                </div>

                <div class="output-area">
                    <h3>
                        <span class="material-icons">text_format</span>
                        In-Text Citations
                        <span class="keyboard-shortcut"><span class="key">Ctrl</span>+<span class="key">C</span> to copy</span>
                    </h3>
                    <div id="citations-output" class="output-content" tabindex="0">
                        <p class="empty-message">Add sources to generate citations</p>
                    </div>
                    <div class="loading-indicator" id="citations-loading">
                        <div class="spinner"></div>
                        <span>Formatting citations...</span>
                    </div>
                    <button id="copy-citations" class="copy-btn" aria-label="Copy citations to clipboard">
                        <span class="material-icons">content_copy</span>
                        <span>Copy Citations</span>
                    </button>
                </div>

                <div class="output-area">
                    <h3>
                        <span class="material-icons">sort</span>
                        Bibliography
                        <span class="keyboard-shortcut"><span class="key">Ctrl</span>+<span class="key">B</span> to copy</span>
                    </h3>
                    <div id="bibliography-output" class="output-content" tabindex="0">
                        <p class="empty-message">Add sources to generate bibliography</p>
                    </div>
                    <div class="loading-indicator" id="bibliography-loading">
                        <div class="spinner"></div>
                        <span>Formatting bibliography...</span>
                    </div>
                    <button id="copy-bibliography" class="copy-btn" aria-label="Copy bibliography to clipboard">
                        <span class="material-icons">content_copy</span>
                        <span>Copy Bibliography</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="notification" class="notification"></div>
    <div id="citation-tooltip" class="citation-tooltip"></div>

    <script>
        // Store sources
        let sources = [];
        let currentStyle = 'apa';
        let isDarkMode = false;
        
        // DOM elements
        const sourceTypeBtns = document.querySelectorAll('.source-type-btn');
        const sourceForms = document.querySelectorAll('.source-form');
        const sourcesContainer = document.getElementById('sources-container');
        const styleSelect = document.getElementById('style-select');
        const citationsOutput = document.getElementById('citations-output');
        const bibliographyOutput = document.getElementById('bibliography-output');
        const copyBibliographyBtn = document.getElementById('copy-bibliography');
        const copyCitationsBtn = document.getElementById('copy-citations');
        const notification = document.getElementById('notification');
        const stylePreviewContent = document.getElementById('style-preview-content');
        const sourceCountElement = document.getElementById('source-count');
        const citationsLoading = document.getElementById('citations-loading');
        const bibliographyLoading = document.getElementById('bibliography-loading');
        const themeToggle = document.querySelector('.theme-toggle');
        const themeIcon = document.getElementById('theme-icon');
        const sourceSearch = document.getElementById('source-search');
        const exportBtn = document.getElementById('export-sources');
        const importTrigger = document.getElementById('import-trigger');
        const importFile = document.getElementById('import-file');
        const citationTooltip = document.getElementById('citation-tooltip');

        // Source type switching
        sourceTypeBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                // Update active button
                sourceTypeBtns.forEach(b => {
                    b.classList.remove('active');
                    b.setAttribute('aria-pressed', 'false');
                });
                btn.classList.add('active');
                btn.setAttribute('aria-pressed', 'true');
                
                // Show corresponding form
                const type = btn.dataset.type;
                sourceForms.forEach(form => {
                    form.classList.remove('active');
                    if (form.id === `${type}-form`) {
                        form.classList.add('active');
                    }
                });
            });
        });

        // Dark mode toggle
        themeToggle.addEventListener('click', toggleDarkMode);
        
        function toggleDarkMode() {
            isDarkMode = !isDarkMode;
            document.body.classList.toggle('dark-mode', isDarkMode);
            themeIcon.textContent = isDarkMode ? 'light_mode' : 'dark_mode';
            
            // Save preference to local storage
            localStorage.setItem('darkMode', isDarkMode);
        }
        
        // Check for saved dark mode preference
        if (localStorage.getItem('darkMode') === 'true') {
            toggleDarkMode();
        }

        // Form validation function
        function validateForm(form) {
            let isValid = true;
            const requiredInputs = form.querySelectorAll('[required]');
            
            requiredInputs.forEach(input => {
                const errorElement = document.getElementById(`${input.id}-error`);
                if (!input.value.trim()) {
                    input.classList.add('error');
                    if (errorElement) {
                        errorElement.classList.add('visible');
                    }
                    isValid = false;
                } else {
                    input.classList.remove('error');
                    if (errorElement) {
                        errorElement.classList.remove('visible');
                    }
                }
                
                // Special validation for URL
                if (input.type === 'url' && input.value.trim() && !isValidUrl(input.value)) {
                    input.classList.add('error');
                    if (errorElement) {
                        errorElement.classList.add('visible');
                    }
                    isValid = false;
                }
                
                // Year validation
                if (input.type === 'number' && input.id.includes('year')) {
                    const year = parseInt(input.value);
                    if (isNaN(year) || year < 1000 || year > 2099) {
                        input.classList.add('error');
                        if (errorElement) {
                            errorElement.classList.add('visible');
                        }
                        isValid = false;
                    }
                }
            });
            
            return isValid;
        }

        // URL validation
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }

        // Form submissions with validation
        document.getElementById('book-form').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!validateForm(this)) return;
            
            addSource('book', {
                title: document.getElementById('book-title').value,
                authors: document.getElementById('book-authors').value,
                year: document.getElementById('book-year').value,
                publisher: document.getElementById('book-publisher').value,
                place: document.getElementById('book-place').value,
                edition: document.getElementById('book-edition').value,
                isbn: document.getElementById('book-isbn').value
            });
            this.reset();
        });

        document.getElementById('article-form').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!validateForm(this)) return;
            
            addSource('article', {
                title: document.getElementById('article-title').value,
                authors: document.getElementById('article-authors').value,
                year: document.getElementById('article-year').value,
                journal: document.getElementById('article-journal').value,
                volume: document.getElementById('article-volume').value,
                issue: document.getElementById('article-issue').value,
                pages: document.getElementById('article-pages').value,
                doi: document.getElementById('article-doi').value
            });
            this.reset();
        });

        document.getElementById('website-form').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!validateForm(this)) return;
            
            addSource('website', {
                title: document.getElementById('website-title').value,
                authors: document.getElementById('website-authors').value,
                year: document.getElementById('website-year').value,
                url: document.getElementById('website-url').value,
                accessed: document.getElementById('website-accessed').value,
                site: document.getElementById('website-site').value
            });
            this.reset();
        });

        document.getElementById('thesis-form').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!validateForm(this)) return;
            
            addSource('thesis', {
                title: document.getElementById('thesis-title').value,
                author: document.getElementById('thesis-author').value,
                year: document.getElementById('thesis-year').value,
                type: document.getElementById('thesis-type').value,
                university: document.getElementById('thesis-university').value,
                location: document.getElementById('thesis-location').value,
                database: document.getElementById('thesis-database').value
            });
            this.reset();
        });

        document.getElementById('chapter-form').addEventListener('submit', function(e) {
            e.preventDefault();
            if (!validateForm(this)) return;
            
            addSource('chapter', {
                title: document.getElementById('chapter-title').value,
                authors: document.getElementById('chapter-authors').value,
                bookTitle: document.getElementById('chapter-book-title').value,
                editors: document.getElementById('chapter-editors').value,
                year: document.getElementById('chapter-year').value,
                pages: document.getElementById('chapter-pages').value,
                publisher: document.getElementById('chapter-publisher').value,
                place: document.getElementById('chapter-place').value
            });
            this.reset();
        });

        // Citation style change
        styleSelect.addEventListener('change', function() {
            currentStyle = this.value;
            updateStylePreview();
            
            // Show loading indicators
            if (sources.length > 0) {
                citationsLoading.classList.add('active');
                bibliographyLoading.classList.add('active');
                
                // Simulate processing time for better UX
                setTimeout(() => {
                    updateOutputs();
                    citationsLoading.classList.remove('active');
                    bibliographyLoading.classList.remove('active');
                }, 500);
            } else {
                updateOutputs();
            }
        });

        // Copy buttons
        copyBibliographyBtn.addEventListener('click', function() {
            copyToClipboard(bibliographyOutput.innerText);
            showNotification('Bibliography copied to clipboard!', 'success');
        });

        copyCitationsBtn.addEventListener('click', function() {
            copyToClipboard(citationsOutput.innerText);
            showNotification('Citations copied to clipboard!', 'success');
        });

        // Export sources
        exportBtn.addEventListener('click', function() {
            if (sources.length === 0) {
                showNotification('No sources to export', 'warning');
                return;
            }
            
            const dataStr = JSON.stringify(sources, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = 'citation-sources.json';
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
            
            showNotification('Sources exported successfully!', 'success');
        });
        
        // Import sources
        importTrigger.addEventListener('click', function() {
            importFile.click();
        });
        
        importFile.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedSources = JSON.parse(e.target.result);
                    if (Array.isArray(importedSources)) {
                        sources = importedSources;
                        updateSourceCount();
                        renderSourcesList();
                        updateOutputs();
                        saveToLocalStorage();
                        showNotification(`Imported ${sources.length} sources successfully!`, 'success');
                    } else {
                        throw new Error('Invalid format');
                    }
                } catch (err) {
                    showNotification('Invalid file format. Please select a valid JSON file.', 'error');
                }
            };
            reader.readAsText(file);
            
            // Reset the input so the same file can be selected again
            this.value = '';
        });

        // Search functionality
        sourceSearch.addEventListener('input', function() {
            const searchTerm = this.value.toLowerCase().trim();
            
            if (searchTerm === '') {
                renderSourcesList();
                return;
            }
            
            const filteredSources = sources.filter(source => {
                const sourceData = source.data;
                const searchFields = [];
                
                // Add relevant fields based on source type
                switch(source.type) {
                    case 'book':
                        searchFields.push(
                            sourceData.title,
                            sourceData.authors,
                            sourceData.publisher,
                            sourceData.year
                        );
                        break;
                    case 'article':
                        searchFields.push(
                            sourceData.title,
                            sourceData.authors,
                            sourceData.journal,
                            sourceData.year
                        );
                        break;
                    case 'website':
                        searchFields.push(
                            sourceData.title,
                            sourceData.authors,
                            sourceData.site,
                            sourceData.url,
                            sourceData.year
                        );
                        break;
                    case 'thesis':
                        searchFields.push(
                            sourceData.title,
                            sourceData.author,
                            sourceData.university,
                            sourceData.year
                        );
                        break;
                    case 'chapter':
                        searchFields.push(
                            sourceData.title,
                            sourceData.authors,
                            sourceData.bookTitle,
                            sourceData.editors,
                            sourceData.publisher,
                            sourceData.year
                        );
                        break;
                }
                
                // Join all fields and search in the combined text
                return searchFields.join(' ').toLowerCase().includes(searchTerm);
            });
            
            renderSourcesList(filteredSources);
        });

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+C to copy citations when focused
            if (e.ctrlKey && e.key === 'c' && document.activeElement === citationsOutput) {
                e.preventDefault();
                copyToClipboard(citationsOutput.innerText);
                showNotification('Citations copied to clipboard!', 'success');
            }
            
            // Ctrl+B to copy bibliography when focused
            if (e.ctrlKey && e.key === 'b' && document.activeElement === bibliographyOutput) {
                e.preventDefault();
                copyToClipboard(bibliographyOutput.innerText);
                showNotification('Bibliography copied to clipboard!', 'success');
            }
            
            // Escape key to close tooltips
            if (e.key === 'Escape') {
                citationTooltip.style.display = 'none';
            }
        });

        // Add source to the list
        function addSource(type, data) {
            const id = Date.now().toString();
            const source = {
                id,
                type,
                data
            };
            
            sources.push(source);
            updateSourceCount();
            renderSourcesList();
            saveToLocalStorage();
            
            // Show loading indicators
            citationsLoading.classList.add('active');
            bibliographyLoading.classList.add('active');
            
            // Simulate processing time for better UX
            setTimeout(() => {
                updateOutputs();
                citationsLoading.classList.remove('active');
                bibliographyLoading.classList.remove('active');
                showNotification('Source added successfully!', 'success');
            }, 500);
        }

        // Update source count
        function updateSourceCount() {
            sourceCountElement.textContent = `${sources.length} ${sources.length === 1 ? 'source' : 'sources'}`;
        }

        // Render sources list
        function renderSourcesList(sourcesToRender = sources) {
            if (sourcesToRender.length === 0) {
                sourcesContainer.innerHTML = '<p class="empty-message">No sources added yet. Add your first source above.</p>';
                return;
            }
            
            let html = '';
            sourcesToRender.forEach(source => {
                html += createSourceItemHTML(source);
            });
            
            sourcesContainer.innerHTML = html;
            
            // Add event listeners for delete and edit buttons
            document.querySelectorAll('.delete-source').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.dataset.id;
                    deleteSource(id);
                });
            });
            
            // Setup drag and drop functionality
            setupDragAndDrop();
        }

        // Setup drag and drop for source items
        function setupDragAndDrop() {
            const sourceItems = document.querySelectorAll('.source-item');
            const dragHandles = document.querySelectorAll('.drag-handle');
            
            sourceItems.forEach(item => {
                item.setAttribute('draggable', 'true');
                
                item.addEventListener('dragstart', function(e) {
                    e.dataTransfer.setData('text/plain', this.dataset.id);
                    this.classList.add('dragging');
                });
                
                item.addEventListener('dragend', function() {
                    this.classList.remove('dragging');
                });
                
                item.addEventListener('dragover', function(e) {
                    e.preventDefault();
                    const draggingItem = document.querySelector('.dragging');
                    if (draggingItem !== this) {
                        const rect = this.getBoundingClientRect();
                        const y = e.clientY;
                        
                        if (y < rect.top + rect.height / 2) {
                            this.parentNode.insertBefore(draggingItem, this);
                        } else {
                            this.parentNode.insertBefore(draggingItem, this.nextSibling);
                        }
                    }
                });
                
                item.addEventListener('drop', function(e) {
                    e.preventDefault();
                    const sourceId = e.dataTransfer.getData('text/plain');
                    
                    // Update sources array to match the new order
                    const newOrder = [];
                    document.querySelectorAll('.source-item').forEach(item => {
                        const id = item.dataset.id;
                        const source = sources.find(s => s.id === id);
                        if (source) {
                            newOrder.push(source);
                        }
                    });
                    
                    sources = newOrder;
                    saveToLocalStorage();
                    updateOutputs();
                });
            });
            
            // Make drag handles trigger dragging
            dragHandles.forEach(handle => {
                handle.addEventListener('mousedown', function(e) {
                    const sourceItem = this.closest('.source-item');
                    if (sourceItem) {
                        sourceItem.setAttribute('draggable', 'true');
                    }
                });
                
                handle.addEventListener('mouseup', function() {
                    const sourceItem = this.closest('.source-item');
                    if (sourceItem) {
                        sourceItem.setAttribute('draggable', 'false');
                    }
                });
            });
        }

        // Create HTML for a source item
        function createSourceItemHTML(source) {
            let title = '';
            let details = '';
            let typeLabel = '';
            
            switch(source.type) {
                case 'book':
                    title = source.data.title;
                    details = `${source.data.authors} (${source.data.year}). ${source.data.publisher}`;
                    typeLabel = 'Book';
                    break;
                case 'article':
                    title = source.data.title;
                    details = `${source.data.authors} (${source.data.year}). ${source.data.journal}`;
                    typeLabel = 'Article';
                    break;
                case 'website':
                    title = source.data.title;
                    details = `${source.data.authors} (${source.data.year}). ${source.data.url}`;
                    typeLabel = 'Website';
                    break;
                case 'thesis':
                    title = source.data.title;
                    details = `${source.data.author} (${source.data.year}). ${source.data.university}`;
                    typeLabel = 'Thesis';
                    break;
                case 'chapter':
                    title = source.data.title;
                    details = `In: ${source.data.bookTitle} (${source.data.year}). Eds: ${source.data.editors}`;
                    typeLabel = 'Chapter';
                    break;
            }
            
            return `
                <div class="source-item" data-id="${source.id}" tabindex="0">
                    <div class="source-item-header">
                        <div class="source-item-title">
                            <span class="material-icons drag-handle" aria-label="Drag to reorder">drag_indicator</span>
                            ${title}
                        </div>
                        <div class="source-item-type">${typeLabel}</div>
                    </div>
                    <div class="source-item-details">${details}</div>
                    <div class="source-item-actions">
                        <button class="action-btn delete-source" data-id="${source.id}" aria-label="Delete source">
                            <span class="material-icons">delete</span>
                            Delete
                        </button>
                    </div>
                </div>
            `;
        }

        // Delete a source
        function deleteSource(id) {
            sources = sources.filter(source => source.id !== id);
            updateSourceCount();
            renderSourcesList();
            saveToLocalStorage();
            
            // Show loading indicators
            if (sources.length > 0) {
                citationsLoading.classList.add('active');
                bibliographyLoading.classList.add('active');
                
                // Simulate processing time for better UX
                setTimeout(() => {
                    updateOutputs();
                    citationsLoading.classList.remove('active');
                    bibliographyLoading.classList.remove('active');
                    showNotification('Source deleted', 'success');
                }, 300);
            } else {
                updateOutputs();
                showNotification('Source deleted', 'success');
            }
        }

        // Update citations and bibliography outputs
        function updateOutputs() {
            if (sources.length === 0) {
                citationsOutput.innerHTML = '<p class="empty-message">Add sources to generate citations</p>';
                bibliographyOutput.innerHTML = '<p class="empty-message">Add sources to generate bibliography</p>';
                return;
            }
            
            // Generate in-text citations
            let citationsHTML = '';
            sources.forEach(source => {
                citationsHTML += formatInTextCitation(source, currentStyle) + '\n\n';
            });
            citationsOutput.innerHTML = citationsHTML;
            
            // Generate bibliography
            let bibliographyHTML = '';
            // Sort sources alphabetically by first author's last name
            const sortedSources = [...sources].sort((a, b) => {
                const aName = getAuthorLastName(a);
                const bName = getAuthorLastName(b);
                return aName.localeCompare(bName);
            });
            
            sortedSources.forEach(source => {
                bibliographyHTML += formatBibliographyEntry(source, currentStyle) + '\n\n';
            });
            bibliographyOutput.innerHTML = bibliographyHTML;
            
            // Add tooltip event listeners to formatted content
            setupCitationTooltips();
        }

        // Setup citation tooltips
        function setupCitationTooltips() {
            const citationElements = citationsOutput.querySelectorAll('p');
            const bibliographyElements = bibliographyOutput.querySelectorAll('p');
            
            // Add tooltip for citations
            citationElements.forEach(element => {
                if (!element.classList.contains('empty-message')) {
                    element.addEventListener('mouseenter', function(e) {
                        showCitationTooltip(e, 'Click to copy this citation');
                    });
                    
                    element.addEventListener('mouseleave', function() {
                        hideCitationTooltip();
                    });
                    
                    element.addEventListener('click', function() {
                        copyToClipboard(this.innerText);
                        showNotification('Citation copied to clipboard!', 'success');
                    });
                }
            });
            
            // Add tooltip for bibliography entries
            bibliographyElements.forEach(element => {
                if (!element.classList.contains('empty-message')) {
                    element.addEventListener('mouseenter', function(e) {
                        showCitationTooltip(e, 'Click to copy this entry');
                    });
                    
                    element.addEventListener('mouseleave', function() {
                        hideCitationTooltip();
                    });
                    
                    element.addEventListener('click', function() {
                        copyToClipboard(this.innerText);
                        showNotification('Bibliography entry copied to clipboard!', 'success');
                    });
                }
            });
        }

        // Show citation tooltip
        function showCitationTooltip(event, message) {
            citationTooltip.textContent = message;
            citationTooltip.style.display = 'block';
            citationTooltip.style.top = `${event.clientY + 10}px`;
            citationTooltip.style.left = `${event.clientX + 10}px`;
        }

        // Hide citation tooltip
        function hideCitationTooltip() {
            citationTooltip.style.display = 'none';
        }

        // Get author's last name for sorting
        function getAuthorLastName(source) {
            let authors = '';
            
            if (source.type === 'thesis') {
                authors = source.data.author;
            } else {
                authors = source.data.authors || source.data.editors || '';
            }
            
            // Extract first author's last name
            if (authors.includes(',')) {
                return authors.split(',')[0].trim();
            }
            return authors;
        }

        // Format in-text citation based on style
        function formatInTextCitation(source, style) {
            let citation = '';
            let authors = source.type === 'thesis' ? source.data.author : source.data.authors;
            let year = source.data.year;
            
            switch(style) {
                case 'apa':
                    // Extract last name(s)
                    let lastNames = extractLastNames(authors);
                    if (lastNames.length === 1) {
                        citation = `(${lastNames[0]}, ${year})`;
                    } else if (lastNames.length === 2) {
                        citation = `(${lastNames[0]} & ${lastNames[1]}, ${year})`;
                    } else if (lastNames.length > 2) {
                        citation = `(${lastNames[0]} et al., ${year})`;
                    }
                    break;
                    
                case 'mla':
                    let mlaNames = extractLastNames(authors);
                    if (mlaNames.length === 1) {
                        citation = `(${mlaNames[0]} ${year})`;
                    } else if (mlaNames.length === 2) {
                        citation = `(${mlaNames[0]} and ${mlaNames[1]} ${year})`;
                    } else if (mlaNames.length > 2) {
                        citation = `(${mlaNames[0]} et al. ${year})`;
                    }
                    break;
                    
                case 'chicago':
                    let chicagoNames = extractLastNames(authors);
                    if (chicagoNames.length === 1) {
                        citation = `(${chicagoNames[0]} ${year})`;
                    } else if (chicagoNames.length === 2) {
                        citation = `(${chicagoNames[0]} and ${chicagoNames[1]} ${year})`;
                    } else if (chicagoNames.length > 2) {
                        citation = `(${chicagoNames[0]} et al. ${year})`;
                    }
                    break;
                    
                case 'harvard':
                    let harvardNames = extractLastNames(authors);
                    if (harvardNames.length === 1) {
                        citation = `(${harvardNames[0]}, ${year})`;
                    } else if (harvardNames.length === 2) {
                        citation = `(${harvardNames[0]} and ${harvardNames[1]}, ${year})`;
                    } else if (harvardNames.length > 2) {
                        citation = `(${harvardNames[0]} et al., ${year})`;
                    }
                    break;
                    
                case 'ieee':
                    // IEEE uses numbered citations
                    const index = sources.indexOf(source) + 1;
                    citation = `[${index}]`;
                    break;
                    
                case 'vancouver':
                    // Vancouver also uses numbered citations
                    const vIndex = sources.indexOf(source) + 1;
                    citation = `(${vIndex})`;
                    break;
            }
            
            return citation;
        }

        // Format bibliography entry based on style
        function formatBibliographyEntry(source, style) {
            let entry = '';
            
            switch(style) {
                case 'apa':
                    entry = formatAPAEntry(source);
                    break;
                case 'mla':
                    entry = formatMLAEntry(source);
                    break;
                case 'chicago':
                    entry = formatChicagoEntry(source);
                    break;
                case 'harvard':
                    entry = formatHarvardEntry(source);
                    break;
                case 'ieee':
                    entry = formatIEEEEntry(source);
                    break;
                case 'vancouver':
                    entry = formatVancouverEntry(source);
                    break;
            }
            
            return entry;
        }

        // Format APA style entry
        function formatAPAEntry(source) {
            let entry = '';
            
            switch(source.type) {
                case 'book':
                    entry = `${formatAuthors(source.data.authors, 'apa')}. (${source.data.year}). `;
                    entry += `<em>${source.data.title}</em>`;
                    if (source.data.edition) {
                        entry += ` (${source.data.edition} ed.)`;
                    }
                    if (source.data.place) {
                        entry += `. ${source.data.place}: `;
                    } else {
                        entry += `. `;
                    }
                    entry += source.data.publisher + '.';
                    if (source.data.isbn) {
                        entry += ` ISBN: ${source.data.isbn}`;
                    }
                    break;
                    
                case 'article':
                    entry = `${formatAuthors(source.data.authors, 'apa')}. (${source.data.year}). `;
                    entry += `${source.data.title}. <em>${source.data.journal}</em>`;
                    if (source.data.volume) {
                        entry += `, ${source.data.volume}`;
                        if (source.data.issue) {
                            entry += `(${source.data.issue})`;
                        }
                    }
                    if (source.data.pages) {
                        entry += `, ${source.data.pages}`;
                    }
                    entry += '.';
                    if (source.data.doi) {
                        entry += ` https://doi.org/${source.data.doi}`;
                    }
                    break;
                    
                case 'website':
                    entry = `${formatAuthors(source.data.authors, 'apa')}. (${source.data.year}). `;
                    entry += `${source.data.title}. `;
                    if (source.data.site) {
                        entry += `${source.data.site}. `;
                    }
                    entry += `Retrieved ${formatDate(source.data.accessed)} from ${source.data.url}`;
                    break;
                    
                case 'thesis':
                    entry = `${formatAuthors(source.data.author, 'apa')}. (${source.data.year}). `;
                    entry += `<em>${source.data.title}</em> `;
                    entry += `[${getThesisType(source.data.type, 'apa')}`;
                    if (source.data.location) {
                        entry += `, ${source.data.university}, ${source.data.location}`;
                    } else {
                        entry += `, ${source.data.university}`;
                    }
                    entry += `]`;
                    if (source.data.database) {
                        entry += `. ${source.data.database}.`;
                    } else {
                        entry += '.';
                    }
                    break;
                    
                case 'chapter':
                    entry = `${formatAuthors(source.data.authors, 'apa')}. (${source.data.year}). `;
                    entry += `${source.data.title}. `;
                    entry += `In ${formatAuthors(source.data.editors, 'apa')} (Ed.), `;
                    entry += `<em>${source.data.bookTitle}</em> (pp. ${source.data.pages})`;
                    if (source.data.place) {
                        entry += `. ${source.data.place}: `;
                    } else {
                        entry += `. `;
                    }
                    entry += `${source.data.publisher}.`;
                    break;
            }
            
            return entry;
        }

        // Format MLA style entry
        function formatMLAEntry(source) {
            let entry = '';
            
            switch(source.type) {
                case 'book':
                    entry = `${formatAuthors(source.data.authors, 'mla')}. `;
                    entry += `<em>${source.data.title}</em>`;
                    if (source.data.edition) {
                        entry += `, ${source.data.edition} ed.`;
                    }
                    if (source.data.place) {
                        entry += `, ${source.data.place}`;
                    }
                    entry += `, ${source.data.publisher}, ${source.data.year}.`;
                    if (source.data.isbn) {
                        entry += ` ISBN: ${source.data.isbn}.`;
                    }
                    break;
                    
                case 'article':
                    entry = `${formatAuthors(source.data.authors, 'mla')}. `;
                    entry += `"${source.data.title}." <em>${source.data.journal}</em>`;
                    if (source.data.volume) {
                        entry += `, vol. ${source.data.volume}`;
                        if (source.data.issue) {
                            entry += `, no. ${source.data.issue}`;
                        }
                    }
                    entry += `, ${source.data.year}`;
                    if (source.data.pages) {
                        entry += `, pp. ${source.data.pages}`;
                    }
                    entry += '.';
                    if (source.data.doi) {
                        entry += ` DOI: ${source.data.doi}`;
                    }
                    break;
                    
                case 'website':
                    entry = `${formatAuthors(source.data.authors, 'mla')}. `;
                    entry += `"${source.data.title}." `;
                    if (source.data.site) {
                        entry += `<em>${source.data.site}</em>, `;
                    }
                    entry += `${source.data.year}, ${source.data.url}. Accessed ${formatDate(source.data.accessed, 'mla')}.`;
                    break;
                    
                case 'thesis':
                    entry = `${formatAuthors(source.data.author, 'mla')}. `;
                    entry += `<em>${source.data.title}</em>. `;
                    entry += `${getThesisType(source.data.type, 'mla')}`;
                    if (source.data.location) {
                        entry += `, ${source.data.university}, ${source.data.location}, ${source.data.year}`;
                    } else {
                        entry += `, ${source.data.university}, ${source.data.year}`;
                    }
                    if (source.data.database) {
                        entry += `, ${source.data.database}`;
                    }
                    entry += '.';
                    break;
                    
                case 'chapter':
                    entry = `${formatAuthors(source.data.authors, 'mla')}. `;
                    entry += `"${source.data.title}." `;
                    entry += `<em>${source.data.bookTitle}</em>, edited by ${formatAuthors(source.data.editors, 'mla')}`;
                    if (source.data.place) {
                        entry += `, ${source.data.place}`;
                    }
                    entry += `, ${source.data.publisher}, ${source.data.year}, pp. ${source.data.pages}.`;
                    break;
            }
            
            return entry;
        }

        // Format Chicago style entry
        function formatChicagoEntry(source) {
            let entry = '';
            
            switch(source.type) {
                case 'book':
                    entry = `${formatAuthors(source.data.authors, 'chicago')}. `;
                    entry += `<em>${source.data.title}</em>`;
                    if (source.data.edition) {
                        entry += `, ${source.data.edition} ed.`;
                    }
                    if (source.data.place) {
                        entry += ` ${source.data.place}:`;
                    } else {
                        entry += ` `;
                    }
                    entry += ` ${source.data.publisher}, ${source.data.year}.`;
                    if (source.data.isbn) {
                        entry += ` ISBN: ${source.data.isbn}.`;
                    }
                    break;
                    
                case 'article':
                    entry = `${formatAuthors(source.data.authors, 'chicago')}. `;
                    entry += `"${source.data.title}." <em>${source.data.journal}</em>`;
                    if (source.data.volume) {
                        entry += ` ${source.data.volume}`;
                        if (source.data.issue) {
                            entry += `, no. ${source.data.issue}`;
                        }
                    }
                    entry += ` (${source.data.year})`;
                    if (source.data.pages) {
                        entry += `: ${source.data.pages}`;
                    }
                    entry += '.';
                    if (source.data.doi) {
                        entry += ` https://doi.org/${source.data.doi}.`;
                    }
                    break;
                    
                case 'website':
                    entry = `${formatAuthors(source.data.authors, 'chicago')}. `;
                    entry += `"${source.data.title}." `;
                    if (source.data.site) {
                        entry += `<em>${source.data.site}</em>. `;
                    }
                    entry += `${source.data.year}. ${source.data.url}. Accessed ${formatDate(source.data.accessed, 'chicago')}.`;
                    break;
                    
                case 'thesis':
                    entry = `${formatAuthors(source.data.author, 'chicago')}. `;
                    entry += `"${source.data.title}." `;
                    entry += `${getThesisType(source.data.type, 'chicago')}`;
                    if (source.data.location) {
                        entry += `, ${source.data.university}, ${source.data.location}, ${source.data.year}`;
                    } else {
                        entry += `, ${source.data.university}, ${source.data.year}`;
                    }
                    if (source.data.database) {
                        entry += `. ${source.data.database}`;
                    }
                    entry += '.';
                    break;
                    
                case 'chapter':
                    entry = `${formatAuthors(source.data.authors, 'chicago')}. `;
                    entry += `"${source.data.title}." `;
                    entry += `In <em>${source.data.bookTitle}</em>, edited by ${formatAuthors(source.data.editors, 'chicago')}`;
                    entry += `, ${source.data.pages}`;
                    if (source.data.place) {
                        entry += `. ${source.data.place}:`;
                    } else {
                        entry += `.`;
                    }
                    entry += ` ${source.data.publisher}, ${source.data.year}.`;
                    break;
            }
            
            return entry;
        }

        // Format Harvard style entry
        function formatHarvardEntry(source) {
            let entry = '';
            
            switch(source.type) {
                case 'book':
                    entry = `${formatAuthors(source.data.authors, 'harvard')}. `;
                    entry += `${source.data.year}. `;
                    entry += `<em>${source.data.title}</em>`;
                    if (source.data.edition) {
                        entry += `, ${source.data.edition} ed.`;
                    }
                    if (source.data.place) {
                        entry += ` ${source.data.place}:`;
                    } else {
                        entry += ` `;
                    }
                    entry += ` ${source.data.publisher}.`;
                    if (source.data.isbn) {
                        entry += ` ISBN: ${source.data.isbn}.`;
                    }
                    break;
                    
                case 'article':
                    entry = `${formatAuthors(source.data.authors, 'harvard')}. `;
                    entry += `${source.data.year}. `;
                    entry += `${source.data.title}. <em>${source.data.journal}</em>`;
                    if (source.data.volume) {
                        entry += `, ${source.data.volume}`;
                        if (source.data.issue) {
                            entry += `(${source.data.issue})`;
                        }
                    }
                    if (source.data.pages) {
                        entry += `, pp. ${source.data.pages}`;
                    }
                    entry += '.';
                    if (source.data.doi) {
                        entry += ` doi: ${source.data.doi}`;
                    }
                    break;
                    
                case 'website':
                    entry = `${formatAuthors(source.data.authors, 'harvard')}. `;
                    entry += `${source.data.year}. `;
                    entry += `${source.data.title}. `;
                    if (source.data.site) {
                        entry += `[online] ${source.data.site}. `;
                    } else {
                        entry += `[online] `;
                    }
                    entry += `Available at: ${source.data.url} [Accessed ${formatDate(source.data.accessed, 'harvard')}].`;
                    break;
                    
                case 'thesis':
                    entry = `${formatAuthors(source.data.author, 'harvard')}. `;
                    entry += `${source.data.year}. `;
                    entry += `<em>${source.data.title}</em>. `;
                    entry += `${getThesisType(source.data.type, 'harvard')}`;
                    if (source.data.location) {
                        entry += `. ${source.data.university}, ${source.data.location}`;
                    } else {
                        entry += `. ${source.data.university}`;
                    }
                    if (source.data.database) {
                        entry += `. ${source.data.database}`;
                    }
                    entry += '.';
                    break;
                    
                case 'chapter':
                    entry = `${formatAuthors(source.data.authors, 'harvard')}. `;
                    entry += `${source.data.year}. `;
                    entry += `${source.data.title}. `;
                    entry += `In: ${formatAuthors(source.data.editors, 'harvard')} ed., `;
                    entry += `<em>${source.data.bookTitle}</em>`;
                    if (source.data.place) {
                        entry += `. ${source.data.place}:`;
                    } else {
                        entry += `.`;
                    }
                    entry += ` ${source.data.publisher}, pp. ${source.data.pages}.`;
                    break;
            }
            
            return entry;
        }

        // Format IEEE style entry
        function formatIEEEEntry(source) {
            const index = sources.indexOf(source) + 1;
            let entry = `[${index}] `;
            
            switch(source.type) {
                case 'book':
                    entry += `${formatAuthors(source.data.authors, 'ieee')}, `;
                    entry += `<em>${source.data.title}</em>`;
                    if (source.data.edition) {
                        entry += `, ${source.data.edition} ed.`;
                    }
                    if (source.data.place) {
                        entry += ` ${source.data.place}:`;
                    } else {
                        entry += ` `;
                    }
                    entry += ` ${source.data.publisher}, ${source.data.year}.`;
                    if (source.data.isbn) {
                        entry += ` ISBN: ${source.data.isbn}.`;
                    }
                    break;
                    
                case 'article':
                    entry += `${formatAuthors(source.data.authors, 'ieee')}, `;
                    entry += `"${source.data.title}," `;
                    entry += `<em>${source.data.journal}</em>`;
                    if (source.data.volume) {
                        entry += `, vol. ${source.data.volume}`;
                        if (source.data.issue) {
                            entry += `, no. ${source.data.issue}`;
                        }
                    }
                    if (source.data.pages) {
                        entry += `, pp. ${source.data.pages}`;
                    }
                    entry += `, ${source.data.year}`;
                    if (source.data.doi) {
                        entry += `, doi: ${source.data.doi}`;
                    }
                    entry += '.';
                    break;
                    
                case 'website':
                    entry += `${formatAuthors(source.data.authors, 'ieee')}, `;
                    entry += `"${source.data.title}," `;
                    if (source.data.site) {
                        entry += `${source.data.site}, `;
                    }
                    entry += `${source.data.year}. [Online]. Available: ${source.data.url}. [Accessed: ${formatDate(source.data.accessed, 'ieee')}].`;
                    break;
                    
                case 'thesis':
                    entry += `${formatAuthors(source.data.author, 'ieee')}, `;
                    entry += `"${source.data.title}," `;
                    entry += `${getThesisType(source.data.type, 'ieee')}`;
                    if (source.data.location) {
                        entry += `, ${source.data.university}, ${source.data.location}, ${source.data.year}`;
                    } else {
                        entry += `, ${source.data.university}, ${source.data.year}`;
                    }
                    if (source.data.database) {
                        entry += `, ${source.data.database}`;
                    }
                    entry += '.';
                    break;
                    
                case 'chapter':
                    entry += `${formatAuthors(source.data.authors, 'ieee')}, `;
                    entry += `"${source.data.title}," `;
                    entry += `in <em>${source.data.bookTitle}</em>, ${formatAuthors(source.data.editors, 'ieee')}, Ed.`;
                    if (source.data.place) {
                        entry += ` ${source.data.place}:`;
                    } else {
                        entry += ``;
                    }
                    entry += ` ${source.data.publisher}, ${source.data.year}, pp. ${source.data.pages}.`;
                    break;
            }
            
            return entry;
        }

        // Format Vancouver style entry
        function formatVancouverEntry(source) {
            const index = sources.indexOf(source) + 1;
            let entry = `${index}. `;
            
            switch(source.type) {
                case 'book':
                    entry += `${formatAuthors(source.data.authors, 'vancouver')}. `;
                    entry += `${source.data.title}`;
                    if (source.data.edition) {
                        entry += `. ${source.data.edition} ed`;
                    }
                    entry += `. `;
                    if (source.data.place) {
                        entry += `${source.data.place}: `;
                    }
                    entry += `${source.data.publisher}; ${source.data.year}`;
                    if (source.data.isbn) {
                        entry += `. ISBN: ${source.data.isbn}`;
                    }
                    entry += `.`;
                    break;
                    
                case 'article':
                    entry += `${formatAuthors(source.data.authors, 'vancouver')}. `;
                    entry += `${source.data.title}. `;
                    entry += `${source.data.journal}`;
                    if (source.data.year) {
                        entry += ` ${source.data.year}`;
                    }
                    if (source.data.volume) {
                        entry += `;${source.data.volume}`;
                        if (source.data.issue) {
                            entry += `(${source.data.issue})`;
                        }
                    }
                    if (source.data.pages) {
                        entry += `:${source.data.pages}`;
                    }
                    if (source.data.doi) {
                        entry += `. doi: ${source.data.doi}`;
                    }
                    entry += `.`;
                    break;
                    
                case 'website':
                    entry += `${formatAuthors(source.data.authors, 'vancouver')}. `;
                    entry += `${source.data.title} [Internet]. `;
                    if (source.data.site) {
                        entry += `${source.data.site}; `;
                    }
                    entry += `${source.data.year} `;
                    entry += `[cited ${formatDate(source.data.accessed, 'vancouver')}]. `;
                    entry += `Available from: ${source.data.url}`;
                    break;
                    
                case 'thesis':
                    entry += `${formatAuthors(source.data.author, 'vancouver')}. `;
                    entry += `${source.data.title} `;
                    entry += `[${getThesisType(source.data.type, 'vancouver')}]. `;
                    if (source.data.location) {
                        entry += `${source.data.location}: `;
                    }
                    entry += `${source.data.university}; ${source.data.year}`;
                    if (source.data.database) {
                        entry += `. Available from: ${source.data.database}`;
                    }
                    entry += `.`;
                    break;
                    
                case 'chapter':
                    entry += `${formatAuthors(source.data.authors, 'vancouver')}. `;
                    entry += `${source.data.title}. `;
                    entry += `In: ${formatAuthors(source.data.editors, 'vancouver')}, editors. `;
                    entry += `${source.data.bookTitle}. `;
                    if (source.data.place) {
                        entry += `${source.data.place}: `;
                    }
                    entry += `${source.data.publisher}; ${source.data.year}. `;
                    entry += `p. ${source.data.pages}.`;
                    break;
            }
            
            return entry;
        }

        // Format authors based on citation style
        function formatAuthors(authors, style) {
            if (!authors) return '';
            
            // Split authors by comma and ampersand
            let authorList = authors.split(/,\s*|\s*&\s*|\s*and\s*/).filter(a => a.trim() !== '');
            
            switch(style) {
                case 'apa':
                    if (authorList.length === 1) {
                        return authorList[0];
                    } else if (authorList.length <= 7) {
                        const lastAuthor = authorList.pop();
                        return authorList.join(', ') + ', & ' + lastAuthor;
                    } else {
                        // APA 7th: first 6 authors, then ellipsis, then last author
                        return authorList.slice(0, 6).join(', ') + ', ... ' + authorList[authorList.length - 1];
                    }
                    
                case 'mla':
                    if (authorList.length === 1) {
                        return authorList[0];
                    } else if (authorList.length === 2) {
                        return authorList[0] + ', and ' + authorList[1];
                    } else if (authorList.length === 3) {
                        return authorList[0] + ', ' + authorList[1] + ', and ' + authorList[2];
                    } else {
                        // MLA: first author followed by "et al."
                        return authorList[0] + ', et al';
                    }
                    
                case 'chicago':
                    if (authorList.length === 1) {
                        return authorList[0];
                    } else if (authorList.length === 2) {
                        return authorList[0] + ' and ' + authorList[1];
                    } else if (authorList.length <= 7) {
                        const lastAuthor = authorList.pop();
                        return authorList.join(', ') + ', and ' + lastAuthor;
                    } else {
                        // Chicago: first author followed by "et al."
                        return authorList[0] + ' et al';
                    }
                    
                case 'harvard':
                    if (authorList.length === 1) {
                        return authorList[0];
                    } else if (authorList.length === 2) {
                        return authorList[0] + ' and ' + authorList[1];
                    } else if (authorList.length === 3) {
                        return authorList[0] + ', ' + authorList[1] + ' and ' + authorList[2];
                    } else {
                        // Harvard: first author followed by "et al."
                        return authorList[0] + ' et al.';
                    }
                    
                case 'ieee':
                    if (authorList.length === 1) {
                        // Reverse first and last name for IEEE
                        const nameParts = authorList[0].split(' ');
                        if (nameParts.length > 1) {
                            const lastName = nameParts.pop();
                            return lastName + ', ' + nameParts.join(' ');
                        }
                        return authorList[0];
                    } else if (authorList.length <= 6) {
                        // IEEE: list all authors
                        return authorList.map(author => {
                            const nameParts = author.split(' ');
                            if (nameParts.length > 1) {
                                const lastName = nameParts.pop();
                                return lastName + ', ' + nameParts.join(' ').charAt(0) + '.';
                            }
                            return author;
                        }).join(', ');
                    } else {
                        // IEEE: first author followed by "et al."
                        const firstAuthor = authorList[0].split(' ');
                        if (firstAuthor.length > 1) {
                            const lastName = firstAuthor.pop();
                            return lastName + ', ' + firstAuthor.join(' ').charAt(0) + '. et al.';
                        }
                        return authorList[0] + ' et al.';
                    }
                    
                case 'vancouver':
                    // Vancouver: list all authors (up to 6), followed by "et al."
                    if (authorList.length <= 6) {
                        return authorList.map(author => {
                            const nameParts = author.split(' ');
                            if (nameParts.length > 1) {
                                const lastName = nameParts.pop();
                                const initials = nameParts.map(name => name.charAt(0)).join('');
                                return lastName + ' ' + initials;
                            }
                            return author;
                        }).join(', ');
                    } else {
                        // Vancouver: first 6 authors followed by "et al."
                        return authorList.slice(0, 6).map(author => {
                            const nameParts = author.split(' ');
                            if (nameParts.length > 1) {
                                const lastName = nameParts.pop();
                                const initials = nameParts.map(name => name.charAt(0)).join('');
                                return lastName + ' ' + initials;
                            }
                            return author;
                        }).join(', ') + ', et al.';
                    }
            }
            
            return authors;
        }

        // Extract last names for in-text citations
        function extractLastNames(authors) {
            if (!authors) return [];
            
            const authorList = authors.split(/,\s*|\s*&\s*|\s*and\s*/).filter(a => a.trim() !== '');
            return authorList.map(author => {
                // Assume the first part before any space is the last name
                return author.split(' ')[0].replace(/,$/, '');
            });
        }

        // Format date based on style
        function formatDate(dateString, style = 'apa') {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            const day = date.getDate();
            const month = date.getMonth();
            const year = date.getFullYear();
            
            const months = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            
            const shortMonths = [
                'Jan.', 'Feb.', 'Mar.', 'Apr.', 'May', 'Jun.',
                'Jul.', 'Aug.', 'Sep.', 'Oct.', 'Nov.', 'Dec.'
            ];
            
            switch(style) {
                case 'apa':
                    return `${months[month]} ${day}, ${year}`;
                case 'mla':
                    return `${day} ${months[month]} ${year}`;
                case 'chicago':
                    return `${months[month]} ${day}, ${year}`;
                case 'harvard':
                    return `${day} ${months[month]} ${year}`;
                case 'ieee':
                    return `${day} ${shortMonths[month]} ${year}`;
                case 'vancouver':
                    return `${year} ${shortMonths[month]} ${day}`;
                default:
                    return `${months[month]} ${day}, ${year}`;
            }
        }

        // Get thesis type based on style
        function getThesisType(type, style) {
            switch(type) {
                case 'doctoral':
                    if (style === 'apa') return 'Doctoral dissertation';
                    if (style === 'mla') return 'PhD dissertation';
                    if (style === 'chicago') return 'PhD diss.';
                    if (style === 'harvard') return 'PhD thesis';
                    if (style === 'ieee') return 'Ph.D. dissertation';
                    if (style === 'vancouver') return 'Doctoral dissertation';
                    return 'Doctoral dissertation';
                    
                case 'masters':
                    if (style === 'apa') return 'Master\'s thesis';
                    if (style === 'mla') return 'Master\'s thesis';
                    if (style === 'chicago') return 'Master\'s thesis';
                    if (style === 'harvard') return 'Master\'s thesis';
                    if (style === 'ieee') return 'M.S. thesis';
                    if (style === 'vancouver') return 'Master\'s thesis';
                    return 'Master\'s thesis';
                    
                case 'undergraduate':
                    if (style === 'apa') return 'Undergraduate thesis';
                    if (style === 'mla') return 'Undergraduate thesis';
                    if (style === 'chicago') return 'Undergraduate thesis';
                    if (style === 'harvard') return 'Undergraduate thesis';
                    if (style === 'ieee') return 'B.S. thesis';
                    if (style === 'vancouver') return 'Undergraduate thesis';
                    return 'Undergraduate thesis';
                    
                default:
                    return 'Thesis';
            }
        }

        // Update style preview
        function updateStylePreview() {
            let previewContent = '';
            
            switch(currentStyle) {
                case 'apa':
                    previewContent = `
                        <p><strong>Book:</strong> Smith, J. (2020). <em>The comprehensive guide to citation styles</em>. Academic Press.</p>
                        <p><strong>Article:</strong> Jones, M., & Brown, L. (2021). Understanding citation formats. <em>Journal of Academic Writing</em>, 12(3), 45-67.</p>
                    `;
                    break;
                    
                case 'mla':
                    previewContent = `
                        <p><strong>Book:</strong> Smith, John. <em>The Comprehensive Guide to Citation Styles</em>. Academic Press, 2020.</p>
                        <p><strong>Article:</strong> Jones, Mary, and Liam Brown. "Understanding Citation Formats." <em>Journal of Academic Writing</em>, vol. 12, no. 3, 2021, pp. 45-67.</p>
                    `;
                    break;
                    
                case 'chicago':
                    previewContent = `
                        <p><strong>Book:</strong> Smith, John. <em>The Comprehensive Guide to Citation Styles</em>. Academic Press, 2020.</p>
                        <p><strong>Article:</strong> Jones, Mary, and Liam Brown. "Understanding Citation Formats." <em>Journal of Academic Writing</em> 12, no. 3 (2021): 45-67.</p>
                    `;
                    break;
                    
                case 'harvard':
                    previewContent = `
                        <p><strong>Book:</strong> Smith, J. 2020. <em>The comprehensive guide to citation styles</em>. Academic Press.</p>
                        <p><strong>Article:</strong> Jones, M. and Brown, L. 2021. Understanding citation formats. <em>Journal of Academic Writing</em>, 12(3), pp. 45-67.</p>
                    `;
                    break;
                    
                case 'ieee':
                    previewContent = `
                        <p><strong>Book:</strong> [1] J. Smith, <em>The comprehensive guide to citation styles</em>. Academic Press, 2020.</p>
                        <p><strong>Article:</strong> [2] M. Jones and L. Brown, "Understanding citation formats," <em>Journal of Academic Writing</em>, vol. 12, no. 3, pp. 45-67, 2021.</p>
                    `;
                    break;
                    
                case 'vancouver':
                    previewContent = `
                        <p><strong>Book:</strong> 1. Smith J. The comprehensive guide to citation styles. Academic Press; 2020.</p>
                        <p><strong>Article:</strong> 2. Jones M, Brown L. Understanding citation formats. Journal of Academic Writing 2021;12(3):45-67.</p>
                    `;
                    break;
            }
            
            stylePreviewContent.innerHTML = previewContent;
        }

        // Copy text to clipboard
        function copyToClipboard(text) {
            // Remove empty messages if present
            text = text.replace(/No sources added yet\.|Add sources to generate citations|Add sources to generate bibliography/g, '').trim();
            
            if (!text) {
                showNotification('No content to copy', 'error');
                return;
            }
            
            try {
                // Modern clipboard API
                navigator.clipboard.writeText(text).then(() => {
                    showNotification('Copied to clipboard!', 'success');
                }).catch(err => {
                    // Fallback method
                    fallbackCopyToClipboard(text);
                });
            } catch (err) {
                // Fallback method for older browsers
                fallbackCopyToClipboard(text);
            }
        }

        // Fallback copy method
        function fallbackCopyToClipboard(text) {
            // Create temporary element
            const el = document.createElement('textarea');
            el.value = text;
            el.setAttribute('readonly', '');
            el.style.position = 'absolute';
            el.style.left = '-9999px';
            document.body.appendChild(el);
            
            // Select and copy
            const selected = document.getSelection().rangeCount > 0 
                ? document.getSelection().getRangeAt(0)
                : false;
            el.select();
            
            let success = false;
            try {
                success = document.execCommand('copy');
            } catch (err) {
                success = false;
            }
            
            // Clean up
            document.body.removeChild(el);
            
            if (selected) {
                document.getSelection().removeAllRanges();
                document.getSelection().addRange(selected);
            }
            
            if (success) {
                showNotification('Copied to clipboard!', 'success');
            } else {
                showNotification('Failed to copy. Please try again.', 'error');
            }
        }

        // Show notification
        function showNotification(message, type) {
            let icon = '';
            
            switch(type) {
                case 'success':
                    icon = '<span class="material-icons">check_circle</span>';
                    break;
                case 'error':
                    icon = '<span class="material-icons">error</span>';
                    break;
                case 'warning':
                    icon = '<span class="material-icons">warning</span>';
                    break;
            }
            
            notification.innerHTML = icon + message;
            notification.className = `notification ${type}`;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // Save sources to localStorage
        function saveToLocalStorage() {
            try {
                localStorage.setItem('citationSources', JSON.stringify(sources));
            } catch (e) {
                console.error('Could not save to localStorage:', e);
            }
        }

        // Load sources from localStorage
        function loadFromLocalStorage() {
            try {
                const savedSources = localStorage.getItem('citationSources');
                if (savedSources) {
                    sources = JSON.parse(savedSources);
                    updateSourceCount();
                    renderSourcesList();
                    updateOutputs();
                }
            } catch (e) {
                console.error('Could not load from localStorage:', e);
            }
        }

        // Initialize style preview
        updateStylePreview();
        
        // Set today's date as default for website accessed date
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('website-accessed').value = today;
        
        // Load saved sources from localStorage
        loadFromLocalStorage();
        
        // Keyboard navigation for theme toggle
        themeToggle.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                toggleDarkMode();
            }
        });
        
        // Accessibility for help icons
        document.querySelectorAll('.help-icon').forEach(icon => {
            icon.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    const tooltip = this.querySelector('.tooltip');
                    if (tooltip) {
                        tooltip.style.display = tooltip.style.display === 'block' ? 'none' : 'block';
                    }
                }
            });
        });
    </script>
</body>
</html>