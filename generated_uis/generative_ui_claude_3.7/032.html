<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Event Poster Designer</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Roboto:wght@400;500;700&family=Pacifico&display=swap"
        rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        :root {
            --primary-color: #4a6bff;
            --primary-hover: #3a5be0;
            --primary-light: #eef1ff;
            --secondary-color: #ff5e7d;
            --secondary-hover: #e54d6c;
            --accent-color: #ffbb38;
            --accent-hover: #e9aa2f;
            --text-color: #333333;
            --text-light: #666666;
            --bg-color: #f5f7fa;
            --panel-color: #ffffff;
            --border-color: #e0e0e0;
            --shadow-color: rgba(0, 0, 0, 0.08);
            --success-color: #4caf50;
            --danger-color: #f44336;
            --info-color: #2196f3;
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --border-radius: 8px;
            --shadow-sm: 0 2px 4px var(--shadow-color);
            --shadow-md: 0 4px 8px var(--shadow-color);
            --shadow-lg: 0 8px 16px var(--shadow-color);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', 'Segoe UI', sans-serif;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        header {
            background-color: var(--panel-color);
            box-shadow: var(--shadow-sm);
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .material-symbols-rounded {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        .logo .material-symbols-rounded {
            font-variation-settings: 'FILL' 1;
            color: var(--primary-color);
        }

        .header-actions {
            display: flex;
            gap: 12px;
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 10px 18px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow-sm);
        }

        .btn:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }

        .btn:focus {
            outline: 2px solid var(--primary-light);
            outline-offset: 2px;
        }

        .btn-outline {
            background-color: transparent;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
            box-shadow: none;
        }

        .btn-outline:hover {
            background-color: var(--primary-light);
            box-shadow: none;
        }

        .btn-accent {
            background-color: var(--accent-color);
        }

        .btn-accent:hover {
            background-color: var(--accent-hover);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
        }

        .btn-secondary:hover {
            background-color: var(--secondary-hover);
        }

        .btn[disabled] {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        main {
            display: flex;
            flex: 1;
            height: calc(100vh - 130px);
        }

        .tools-panel {
            width: 280px;
            background-color: var(--panel-color);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
            box-shadow: var(--shadow-sm);
            z-index: 5;
        }

        .panel-section {
            padding: 18px;
            border-bottom: 1px solid var(--border-color);
        }

        .panel-title {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 14px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tool-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }

        .tool-btn {
            background-color: var(--panel-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 12px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 6px;
            cursor: pointer;
            transition: var(--transition);
        }

        .tool-btn:hover {
            background-color: var(--primary-light);
            border-color: var(--primary-color);
            transform: translateY(-2px);
        }

        .tool-btn:active {
            transform: translateY(0);
        }

        .tool-btn .material-symbols-rounded {
            font-size: 22px;
            color: var(--primary-color);
        }

        .tool-btn span.tool-name {
            font-size: 12px;
            font-weight: 500;
        }

        .templates-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .template-item {
            border-radius: var(--border-radius);
            overflow: hidden;
            cursor: pointer;
            position: relative;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
        }

        .template-item:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-md);
        }

        .template-item:active {
            transform: scale(1);
        }

        .template-item img {
            width: 100%;
            height: auto;
            display: block;
            transition: var(--transition);
        }

        .template-item .template-name {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 6px 10px;
            font-size: 12px;
            text-align: center;
            font-weight: 500;
            opacity: 0.9;
            transition: var(--transition);
        }

        .template-item:hover .template-name {
            opacity: 1;
            padding-bottom: 10px;
        }

        .canvas-container {
            flex: 1;
            background-color: var(--bg-color);
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
            overflow: auto;
            position: relative;
        }

        .canvas-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-conic-gradient(#ddd 0% 25%, #eee 0% 50%) 50% / 20px 20px;
            opacity: 0.5;
            z-index: 0;
        }

        .canvas {
            background-color: white;
            box-shadow: var(--shadow-md);
            width: 600px;
            height: 800px;
            position: relative;
            overflow: hidden;
            z-index: 1;
            transition: transform 0.3s ease;
        }

        .canvas-element {
            position: absolute;
            cursor: move;
            user-select: none;
            border: 2px solid transparent;
            transition: border 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
        }

        .canvas-element:hover {
            box-shadow: 0 0 0 1px rgba(74, 107, 255, 0.3);
        }

        .canvas-element.selected {
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 0 4px rgba(74, 107, 255, 0.2);
        }

        .canvas-element .resize-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background-color: var(--primary-color);
            border: 2px solid white;
            border-radius: 50%;
            cursor: nwse-resize;
            z-index: 10;
        }

        .canvas-element .resize-handle.top-left {
            top: -6px;
            left: -6px;
            cursor: nwse-resize;
        }

        .canvas-element .resize-handle.top-right {
            top: -6px;
            right: -6px;
            cursor: nesw-resize;
        }

        .canvas-element .resize-handle.bottom-left {
            bottom: -6px;
            left: -6px;
            cursor: nesw-resize;
        }

        .canvas-element .resize-handle.bottom-right {
            bottom: -6px;
            right: -6px;
            cursor: nwse-resize;
        }

        .canvas-element .rotate-handle {
            position: absolute;
            top: -30px;
            left: 50%;
            transform: translateX(-50%);
            width: 24px;
            height: 24px;
            background-color: var(--primary-color);
            border: 2px solid white;
            border-radius: 50%;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
        }

        .text-element {
            min-width: 50px;
            min-height: 20px;
            padding: 4px;
        }

        .text-element:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .image-element img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            pointer-events: none;
        }

        .shape-element {
            min-width: 50px;
            min-height: 50px;
        }

        .properties-panel {
            width: 300px;
            background-color: var(--panel-color);
            border-left: 1px solid var(--border-color);
            overflow-y: auto;
            box-shadow: var(--shadow-sm);
            z-index: 5;
        }

        .property-group {
            padding: 18px;
            border-bottom: 1px solid var(--border-color);
        }

        .property-row {
            margin-bottom: 14px;
        }

        .property-row:last-child {
            margin-bottom: 0;
        }

        .property-label {
            display: block;
            font-size: 12px;
            margin-bottom: 6px;
            color: var(--text-light);
            font-weight: 500;
        }

        .property-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 14px;
            transition: var(--transition);
            background-color: white;
        }

        .property-input:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 107, 255, 0.1);
        }

        .property-input:hover {
            border-color: #b0b0b0;
        }

        .color-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .color-preview {
            width: 32px;
            height: 32px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.05);
        }

        input[type="color"] {
            -webkit-appearance: none;
            width: 100%;
            height: 40px;
            padding: 2px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: white;
            cursor: pointer;
        }

        input[type="color"]::-webkit-color-swatch-wrapper {
            padding: 0;
        }

        input[type="color"]::-webkit-color-swatch {
            border: none;
            border-radius: calc(var(--border-radius) - 2px);
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #e0e0e0;
            outline: none;
            margin: 10px 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.2);
            transition: var(--transition);
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.3);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: var(--primary-color);
            cursor: pointer;
            box-shadow: 0 0 2px rgba(0, 0, 0, 0.2);
            transition: var(--transition);
            border: none;
        }

        input[type="range"]::-moz-range-thumb:hover {
            transform: scale(1.1);
            box-shadow: 0 0 4px rgba(0, 0, 0, 0.3);
        }

        .range-value-display {
            text-align: right;
            font-size: 12px;
            color: var(--text-light);
            font-weight: 500;
            margin-top: 4px;
        }

        select.font-select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 14px;
            background-color: white;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%23666' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            background-size: 16px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            cursor: pointer;
            transition: var(--transition);
        }

        select.font-select:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(74, 107, 255, 0.1);
        }

        select.font-select:hover {
            border-color: #b0b0b0;
        }

        .alignment-buttons {
            display: flex;
            gap: 6px;
        }

        .alignment-btn {
            flex: 1;
            padding: 8px 0;
            background-color: var(--panel-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .alignment-btn:hover {
            background-color: var(--primary-light);
            border-color: var(--primary-color);
        }

        .alignment-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .alignment-btn .material-symbols-rounded {
            font-size: 18px;
        }

        .upload-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 24px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .upload-area:hover {
            border-color: var(--primary-color);
            background-color: var(--primary-light);
        }

        .upload-area.highlight {
            border-color: var(--primary-color);
            background-color: var(--primary-light);
        }

        .upload-icon {
            font-size: 32px;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .upload-text {
            font-size: 14px;
            color: var(--text-light);
            line-height: 1.4;
        }

        footer {
            background-color: var(--panel-color);
            border-top: 1px solid var(--border-color);
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 -2px 5px var(--shadow-color);
            z-index: 10;
        }

        .history-buttons {
            display: flex;
            gap: 10px;
        }

        .zoom-controls {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .zoom-level {
            font-size: 14px;
            color: var(--text-light);
            font-weight: 500;
            min-width: 60px;
            text-align: center;
        }

        .zoom-btn {
            background-color: var(--panel-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .zoom-btn:hover {
            background-color: var(--primary-light);
            border-color: var(--primary-color);
        }

        .zoom-btn:active {
            transform: scale(0.95);
        }

        .template-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .template-modal.active {
            opacity: 1;
            display: flex;
        }

        .modal-content {
            background-color: var(--panel-color);
            border-radius: var(--border-radius);
            width: 850px;
            max-width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .template-modal.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            padding: 18px 24px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            background-color: var(--panel-color);
            z-index: 5;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 600;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            width: 36px;
            height: 36px;
            border-radius: 50%;
        }

        .close-modal:hover {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--text-color);
        }

        .modal-body {
            padding: 24px;
        }

        .templates-modal-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }

        .template-category {
            margin-top: 30px;
            margin-bottom: 15px;
        }

        .template-category-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: var(--panel-color);
            color: var(--text-color);
            padding: 12px 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            transition: var(--transition);
            transform: translateY(100px);
            opacity: 0;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .toast.success {
            border-left: 4px solid var(--success-color);
        }

        .toast.error {
            border-left: 4px solid var(--danger-color);
        }

        .toast.info {
            border-left: 4px solid var(--info-color);
        }

        .toast-icon {
            color: var(--success-color);
        }

        .toast.error .toast-icon {
            color: var(--danger-color);
        }

        .toast.info .toast-icon {
            color: var(--info-color);
        }

        .toast-message {
            font-size: 14px;
            font-weight: 500;
        }

        /* Export modal */
        .export-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .export-modal.active {
            opacity: 1;
            display: flex;
        }

        .export-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 15px;
        }

        .export-option {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .export-option:hover {
            border-color: var(--primary-color);
            background-color: var(--primary-light);
            transform: translateY(-3px);
        }

        .export-option-icon {
            font-size: 32px;
            color: var(--primary-color);
            margin-bottom: 10px;
        }

        .export-option-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .export-option-desc {
            font-size: 12px;
            color: var(--text-light);
        }

        /* Loading indicator */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .loading-overlay.show {
            display: flex;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(74, 107, 255, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* Context menu */
        .context-menu {
            position: absolute;
            background-color: var(--panel-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            z-index: 100;
            min-width: 180px;
            padding: 8px 0;
            display: none;
        }

        .context-menu-item {
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
        }

        .context-menu-item:hover {
            background-color: var(--primary-light);
        }

        .context-menu-divider {
            height: 1px;
            background-color: var(--border-color);
            margin: 6px 0;
        }

        /* Keyboard shortcuts help */
        .shortcuts-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .shortcuts-modal.active {
            opacity: 1;
            display: flex;
        }

        .shortcuts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .shortcut-group {
            margin-bottom: 20px;
        }

        .shortcut-group-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .shortcut-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .shortcut-keys {
            display: flex;
            gap: 5px;
        }

        .key {
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 3px 6px;
            font-size: 12px;
            font-family: 'Roboto Mono', monospace;
            box-shadow: 0 2px 0 #ccc;
            min-width: 20px;
            text-align: center;
        }

        /* No selection message animation */
        @keyframes pulse {
            0% {
                opacity: 0.6;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.6;
            }
        }

        #no-selection-message p {
            animation: pulse 2s infinite;
        }

        /* Responsive styles */
        @media (max-width: 1200px) {

            .tools-panel,
            .properties-panel {
                width: 250px;
            }

            .tool-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 992px) {
            main {
                flex-direction: column;
                height: auto;
            }

            .tools-panel {
                width: 100%;
                flex-direction: row;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                overflow-x: auto;
                overflow-y: hidden;
            }

            .panel-section {
                min-width: 220px;
                border-bottom: none;
                border-right: 1px solid var(--border-color);
            }

            .canvas-container {
                height: 500px;
            }

            .properties-panel {
                width: 100%;
                border-left: none;
                border-top: 1px solid var(--border-color);
            }

            .templates-modal-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 576px) {
            .header-actions {
                gap: 8px;
            }

            .btn {
                padding: 8px 12px;
                font-size: 13px;
            }

            .templates-modal-grid {
                grid-template-columns: 1fr;
            }

            .export-options {
                grid-template-columns: 1fr;
            }

            .shortcuts-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Accessibility focus styles */
        button:focus-visible,
        input:focus-visible,
        select:focus-visible,
        .tool-btn:focus-visible,
        .template-item:focus-visible {
            outline: 3px solid rgba(74, 107, 255, 0.5);
            outline-offset: 2px;
        }

        /* Better keyboard focus indication */
        .keyboard-focus :focus {
            outline: 3px solid rgba(74, 107, 255, 0.5);
            outline-offset: 2px;
        }

        /* Add new confirm dialog styles */
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .confirm-dialog.active {
            opacity: 1;
            display: flex;
        }

        .confirm-dialog-content {
            background-color: var(--panel-color);
            border-radius: var(--border-radius);
            width: 400px;
            max-width: 90%;
            padding: 24px;
            box-shadow: var(--shadow-lg);
        }

        .confirm-dialog-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 12px;
        }

        .confirm-dialog-message {
            margin-bottom: 24px;
            color: var(--text-light);
            line-height: 1.5;
        }

        .confirm-dialog-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Layer panel styles */
        .layers-panel {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-top: 10px;
        }

        .layer-item {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            transition: var(--transition);
        }

        .layer-item:last-child {
            border-bottom: none;
        }

        .layer-item:hover {
            background-color: var(--primary-light);
        }

        .layer-item.selected {
            background-color: var(--primary-light);
            border-left: 3px solid var(--primary-color);
        }

        .layer-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .layer-icon {
            color: var(--primary-color);
            font-size: 18px;
        }

        .layer-name {
            font-size: 14px;
            font-weight: 500;
        }

        .layer-actions {
            display: flex;
            gap: 5px;
        }

        .layer-action {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
        }

        .layer-action:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .layer-action .material-symbols-rounded {
            font-size: 16px;
        }

        /* Font preview styles */
        .font-preview-wrapper {
            margin-top: 10px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: #f9f9f9;
        }

        .font-preview {
            min-height: 40px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Onboarding tooltip styles */
        .onboarding-tooltip {
            position: absolute;
            background-color: var(--primary-color);
            color: white;
            padding: 12px 16px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            z-index: 1000;
            max-width: 250px;
            font-size: 14px;
            animation: fadeIn 0.3s ease-in-out;
        }

        .onboarding-tooltip:after {
            content: '';
            position: absolute;
            width: 0;
            height: 0;
            border: 8px solid transparent;
        }

        .onboarding-tooltip.top:after {
            border-top-color: var(--primary-color);
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
        }

        .onboarding-tooltip.bottom:after {
            border-bottom-color: var(--primary-color);
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
        }

        .onboarding-tooltip.left:after {
            border-left-color: var(--primary-color);
            left: 100%;
            top: 50%;
            transform: translateY(-50%);
        }

        .onboarding-tooltip.right:after {
            border-right-color: var(--primary-color);
            right: 100%;
            top: 50%;
            transform: translateY(-50%);
        }

        .onboarding-tooltip .tooltip-close {
            position: absolute;
            top: 5px;
            right: 5px;
            color: white;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .onboarding-tooltip .tooltip-close:hover {
            opacity: 1;
        }

        .onboarding-tooltip .tooltip-next {
            background-color: white;
            color: var(--primary-color);
            border: none;
            border-radius: 4px;
            padding: 6px 12px;
            margin-top: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
        }

        .onboarding-tooltip .tooltip-next:hover {
            background-color: #f0f0f0;
            transform: translateY(-2px);
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Download progress styles */
        .download-progress {
            margin-top: 15px;
            display: none;
        }

        .download-progress.show {
            display: block;
        }

        .progress-bar-container {
            width: 100%;
            height: 8px;
            background-color: #f0f0f0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.3s ease-in-out;
        }

        .progress-status {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-light);
        }
    </style>
</head>

<body>
    <header>
        <div class="logo">
            <span class="material-symbols-rounded">event</span>
            Event Poster Designer
        </div>
        <div class="header-actions">
            <button class="btn btn-outline" id="new-poster-btn" aria-label="Create new poster">
                <span class="material-symbols-rounded">add</span>
                New
            </button>
            <button class="btn" id="save-btn" aria-label="Save poster">
                <span class="material-symbols-rounded">save</span>
                Save
            </button>
            <button class="btn btn-accent" id="export-btn" aria-label="Export poster">
                <span class="material-symbols-rounded">file_download</span>
                Export
            </button>
            <button class="btn btn-outline" id="shortcuts-btn" aria-label="Keyboard shortcuts">
                <span class="material-symbols-rounded">keyboard</span>
            </button>
        </div>
    </header>

    <main>
        <aside class="tools-panel">
            <div class="panel-section">
                <h3 class="panel-title">
                    <span class="material-symbols-rounded">category</span>
                    Tools
                </h3>
                <div class="tool-grid">
                    <div class="tool-btn" id="text-tool" tabindex="0" role="button" aria-label="Add text">
                        <span class="material-symbols-rounded">title</span>
                        <span class="tool-name">Text</span>
                    </div>
                    <div class="tool-btn" id="image-tool" tabindex="0" role="button" aria-label="Add image">
                        <span class="material-symbols-rounded">image</span>
                        <span class="tool-name">Image</span>
                    </div>
                    <div class="tool-btn" id="shape-tool" tabindex="0" role="button" aria-label="Add shape">
                        <span class="material-symbols-rounded">crop_square</span>
                        <span class="tool-name">Shape</span>
                    </div>
                    <div class="tool-btn" id="background-tool" tabindex="0" role="button"
                        aria-label="Change background">
                        <span class="material-symbols-rounded">format_color_fill</span>
                        <span class="tool-name">Background</span>
                    </div>
                    <div class="tool-btn" id="template-tool" tabindex="0" role="button" aria-label="Browse templates">
                        <span class="material-symbols-rounded">dashboard</span>
                        <span class="tool-name">Templates</span>
                    </div>
                    <div class="tool-btn" id="layers-tool" tabindex="0" role="button" aria-label="Manage layers">
                        <span class="material-symbols-rounded">layers</span>
                        <span class="tool-name">Layers</span>
                    </div>
                </div>
            </div>

            <div class="panel-section">
                <h3 class="panel-title">
                    <span class="material-symbols-rounded">view_quilt</span>
                    Quick Templates
                </h3>
                <div class="templates-grid">
                    <div class="template-item" data-template="template1" tabindex="0" role="button"
                        aria-label="Basic Event template">
                        <img src="https://placehold.co/100x150/4a6bff/ffffff?text=Event" alt="Event Template">
                        <div class="template-name">Basic Event</div>
                    </div>
                    <div class="template-item" data-template="template2" tabindex="0" role="button"
                        aria-label="Concert template">
                        <img src="https://placehold.co/100x150/ff5e7d/ffffff?text=Concert" alt="Concert Template">
                        <div class="template-name">Concert</div>
                    </div>
                    <div class="template-item" data-template="template3" tabindex="0" role="button"
                        aria-label="Workshop template">
                        <img src="https://placehold.co/100x150/ffbb38/333333?text=Workshop" alt="Workshop Template">
                        <div class="template-name">Workshop</div>
                    </div>
                    <div class="template-item" data-template="template4" tabindex="0" role="button"
                        aria-label="Community template">
                        <img src="https://placehold.co/100x150/4caf50/ffffff?text=Community" alt="Community Template">
                        <div class="template-name">Community</div>
                    </div>
                </div>
                <div style="text-align: center; margin-top: 14px;">
                    <button class="btn btn-outline" id="more-templates-btn">
                        <span class="material-symbols-rounded">add</span>
                        More Templates
                    </button>
                </div>
            </div>
        </aside>

        <section class="canvas-container">
            <div class="canvas-backdrop"></div>
            <div class="canvas" id="design-canvas">
                <!-- Canvas elements will be added here dynamically -->
            </div>
        </section>

        <aside class="properties-panel">
            <div class="property-group">
                <h3 class="panel-title">
                    <span class="material-symbols-rounded">tune</span>
                    Properties
                </h3>
                <div id="no-selection-message">
                    <p style="text-align: center; color: #666; padding: 20px; font-size: 14px;">
                        <span class="material-symbols-rounded"
                            style="font-size: 48px; display: block; margin: 0 auto 10px; opacity: 0.5;">touch_app</span>
                        Select an element on the canvas<br>to edit its properties
                    </p>
                </div>
                <div id="text-properties" style="display: none;">
                    <div class="property-row">
                        <label class="property-label" for="text-content">Text Content</label>
                        <textarea class="property-input" id="text-content" rows="3"
                            placeholder="Enter your text here"></textarea>
                    </div>
                    <div class="property-row">
                        <label class="property-label" for="font-family">Font Family</label>
                        <select class="font-select" id="font-family">
                            <option value="'Poppins', sans-serif">Poppins</option>
                            <option value="'Roboto', sans-serif">Roboto</option>
                            <option value="Arial, sans-serif">Arial</option>
                            <option value="'Times New Roman', serif">Times New Roman</option>
                            <option value="'Courier New', monospace">Courier New</option>
                            <option value="Georgia, serif">Georgia</option>
                            <option value="Impact, sans-serif">Impact</option>
                            <option value="'Pacifico', cursive">Pacifico</option>
                        </select>
                    </div>
                    <div class="font-preview-wrapper">
                        <div class="font-preview" id="font-preview">Preview Text</div>
                    </div>
                    <div class="property-row">
                        <label class="property-label" for="font-size">Font Size</label>
                        <input type="range" id="font-size" min="8" max="120" value="16">
                        <div class="range-value-display">
                            <span id="font-size-value">16</span>px
                        </div>
                    </div>
                    <div class="property-row">
                        <label class="property-label" for="text-color">Text Color</label>
                        <input type="color" id="text-color" value="#000000">
                    </div>
                    <div class="property-row">
                        <label class="property-label">Text Alignment</label>
                        <div class="alignment-buttons">
                            <button class="alignment-btn active" data-align="left" aria-label="Align left">
                                <span class="material-symbols-rounded">format_align_left</span>
                            </button>
                            <button class="alignment-btn" data-align="center" aria-label="Align center">
                                <span class="material-symbols-rounded">format_align_center</span>
                            </button>
                            <button class="alignment-btn" data-align="right" aria-label="Align right">
                                <span class="material-symbols-rounded">format_align_right</span>
                            </button>
                            <button class="alignment-btn" data-align="justify" aria-label="Justify text">
                                <span class="material-symbols-rounded">format_align_justify</span>
                            </button>
                        </div>
                    </div>
                    <div class="property-row">
                        <label class="property-label">Text Style</label>
                        <div class="alignment-buttons">
                            <button class="alignment-btn" data-style="bold" aria-label="Bold text">
                                <span class="material-symbols-rounded">format_bold</span>
                            </button>
                            <button class="alignment-btn" data-style="italic" aria-label="Italic text">
                                <span class="material-symbols-rounded">format_italic</span>
                            </button>
                            <button class="alignment-btn" data-style="underline" aria-label="Underline text">
                                <span class="material-symbols-rounded">format_underlined</span>
                            </button>
                            <button class="alignment-btn" data-style="uppercase" aria-label="Uppercase text">
                                <span class="material-symbols-rounded">text_fields</span>
                            </button>
                        </div>
                    </div>
                    <div class="property-row">
                        <label class="property-label" for="text-spacing">Letter Spacing</label>
                        <input type="range" id="text-spacing" min="-2" max="10" value="0" step="0.5">
                        <div class="range-value-display">
                            <span id="text-spacing-value">0</span>px
                        </div>
                    </div>
                    <div class="property-row">
                        <label class="property-label" for="text-line-height">Line Height</label>
                        <input type="range" id="text-line-height" min="0.5" max="3" value="1.2" step="0.1">
                        <div class="range-value-display">
                            <span id="text-line-height-value">1.2</span>
                        </div>
                    </div>
                </div>

                <div id="image-properties" style="display: none;">
                    <div class="property-row">
                        <label class="property-label">Replace Image</label>
                        <div class="upload-area" id="image-upload-area" tabindex="0" role="button"
                            aria-label="Upload image">
                            <span class="material-symbols-rounded upload-icon">file_upload</span>
                            <div class="upload-text">Click to upload or drag image here</div>
                        </div>
                        <input type="file" id="image-upload-input" accept="image/*" style="display: none;">
                    </div>
                    <div class="property-row">
                        <label class="property-label" for="image-opacity">Image Opacity</label>
                        <input type="range" id="image-opacity" min="0" max="100" value="100">
                        <div class="range-value-display">
                            <span id="opacity-value">100</span>%
                        </div>
                    </div>
                    <div class="property-row">
                        <label class="property-label" for="image-border-width">Border Width</label>
                        <input type="range" id="image-border-width" min="0" max="20" value="0">
                        <div class="range-value-display">
                            <span id="border-width-value">0</span>px
                        </div>
                    </div>
                    <div class="property-row">
                        <label class="property-label" for="image-border-color">Border Color</label>
                        <input type="color" id="image-border-color" value="#000000">
                    </div>
                    <div class="property-row">
                        <label class="property-label" for="image-border-radius">Border Radius</label>
                        <input type="range" id="image-border-radius" min="0" max="50" value="0">
                        <div class="range-value-display">
                            <span id="border-radius-value">0</span>px
                        </div>
                    </div>
                    <div class="property-row">
                        <label class="property-label" for="image-brightness">Brightness</label>
                        <input type="range" id="image-brightness" min="0" max="200" value="100">
                        <div class="range-value-display">
                            <span id="brightness-value">100</span>%
                        </div>
                    </div>
                    <div class="property-row">
                        <label class="property-label" for="image-contrast">Contrast</label>
                        <input type="range" id="image-contrast" min="0" max="200" value="100">
                        <div class="range-value-display">
                            <span id="contrast-value">100</span>%
                        </div>
                    </div>
                </div>

                <div id="shape-properties" style="display: none;">
                    <div class="property-row">
                        <label class="property-label" for="shape-type">Shape Type</label>
                        <select class="font-select" id="shape-type">
                            <option value="rectangle">Rectangle</option>
                            <option value="circle">Circle</option>
                            <option value="triangle">Triangle</option>
                            <option value="star">Star</option>
                            <option value="hexagon">Hexagon</option>
                            <option value="heart">Heart</option>
                        </select>
                    </div>
                    <div class="property-row">
                        <label class="property-label" for="shape-fill-color">Fill Color</label>
                        <input type="color" id="shape-fill-color" value="#4a6bff">
                    </div>
                    <div class="property-row">
                        <label class="property-label" for="shape-border-width">Border Width</label>
                        <input type="range" id="shape-border-width" min="0" max="20" value="0">
                        <div class="range-value-display">
                            <span id="shape-border-width-value">0</span>px
                        </div>
                    </div>
                    <div class="property-row">
                        <label class="property-label" for="shape-border-color">Border Color</label>
                        <input type="color" id="shape-border-color" value="#000000">
                    </div>
                    <div class="property-row">
                        <label class="property-label" for="shape-opacity">Opacity</label>
                        <input type="range" id="shape-opacity" min="0" max="100" value="100">
                        <div class="range-value-display">
                            <span id="shape-opacity-value">100</span>%
                        </div>
                    </div>
                    <div class="property-row">
                        <label class="property-label" for="shape-border-radius">Corner Radius</label>
                        <input type="range" id="shape-border-radius" min="0" max="50" value="0">
                        <div class="range-value-display">
                            <span id="shape-radius-value">0</span>px
                        </div>
                    </div>
                </div>

                <div id="background-properties" style="display: none;">
                    <div class="property-row">
                        <label class="property-label" for="bg-color">Background Color</label>
                        <input type="color" id="bg-color" value="#ffffff">
                    </div>
                    <div class="property-row">
                        <label class="property-label">Background Image</label>
                        <div class="upload-area" id="bg-upload-area" tabindex="0" role="button"
                            aria-label="Upload background image">
                            <span class="material-symbols-rounded upload-icon">file_upload</span>
                            <div class="upload-text">Click to upload or drag image here</div>
                        </div>
                        <input type="file" id="bg-upload-input" accept="image/*" style="display: none;">
                    </div>
                    <div class="property-row">
                        <label class="property-label" for="bg-opacity">Background Opacity</label>
                        <input type="range" id="bg-opacity" min="0" max="100" value="100">
                        <div class="range-value-display">
                            <span id="bg-opacity-value">100</span>%
                        </div>
                    </div>
                    <div class="property-row">
                        <label class="property-label" for="bg-pattern">Background Pattern</label>
                        <select class="font-select" id="bg-pattern">
                            <option value="none">None</option>
                            <option value="dots">Dots</option>
                            <option value="lines">Lines</option>
                            <option value="grid">Grid</option>
                            <option value="diagonal">Diagonal</option>
                        </select>
                    </div>
                    <div class="property-row">
                        <label class="property-label" for="bg-gradient">Gradient</label>
                        <select class="font-select" id="bg-gradient">
                            <option value="none">None</option>
                            <option value="linear-vertical">Linear Vertical</option>
                            <option value="linear-horizontal">Linear Horizontal</option>
                            <option value="radial">Radial</option>
                        </select>
                    </div>
                    <div class="property-row" id="gradient-colors" style="display: none;">
                        <label class="property-label">Gradient Colors</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                            <input type="color" id="gradient-color-1" value="#4a6bff" style="flex: 1;">
                            <input type="color" id="gradient-color-2" value="#ff5e7d" style="flex: 1;">
                        </div>
                    </div>
                </div>

                <div id="layers-properties" style="display: none;">
                    <div class="property-row">
                        <label class="property-label">Layers</label>
                        <div class="layers-panel" id="layers-list">
                            <!-- Layers will be populated dynamically -->
                        </div>
                    </div>
                    <div class="property-row" style="margin-top: 15px;">
                        <div class="alignment-buttons">
                            <button class="alignment-btn" id="layer-duplicate" aria-label="Duplicate layer">
                                <span class="material-symbols-rounded">content_copy</span>
                            </button>
                            <button class="alignment-btn" id="layer-delete" aria-label="Delete layer">
                                <span class="material-symbols-rounded">delete</span>
                            </button>
                            <button class="alignment-btn" id="layer-up" aria-label="Move layer up">
                                <span class="material-symbols-rounded">arrow_upward</span>
                            </button>
                            <button class="alignment-btn" id="layer-down" aria-label="Move layer down">
                                <span class="material-symbols-rounded">arrow_downward</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="property-group">
                <h3 class="panel-title">
                    <span class="material-symbols-rounded">straighten</span>
                    Position & Size
                </h3>
                <div class="property-row">
                    <label class="property-label" for="element-width">Width (px)</label>
                    <input type="number" class="property-input" id="element-width" min="10" value="100">
                </div>
                <div class="property-row">
                    <label class="property-label" for="element-height">Height (px)</label>
                    <input type="number" class="property-input" id="element-height" min="10" value="100">
                </div>
                <div class="property-row">
                    <label class="property-label" for="element-x">X Position (px)</label>
                    <input type="number" class="property-input" id="element-x" value="0">
                </div>
                <div class="property-row">
                    <label class="property-label" for="element-y">Y Position (px)</label>
                    <input type="number" class="property-input" id="element-y" value="0">
                </div>
                <div class="property-row">
                    <label class="property-label" for="element-rotation">Rotation (degrees)</label>
                    <input type="range" id="element-rotation" min="0" max="360" value="0">
                    <div class="range-value-display">
                        <span id="rotation-value">0</span>°
                    </div>
                </div>
                <div class="property-row">
                    <div class="alignment-buttons">
                        <button class="alignment-btn" id="align-left" aria-label="Align left">
                            <span class="material-symbols-rounded">align_horizontal_left</span>
                        </button>
                        <button class="alignment-btn" id="align-center-h" aria-label="Align center horizontally">
                            <span class="material-symbols-rounded">align_horizontal_center</span>
                        </button>
                        <button class="alignment-btn" id="align-right" aria-label="Align right">
                            <span class="material-symbols-rounded">align_horizontal_right</span>
                        </button>
                    </div>
                </div>
                <div class="property-row">
                    <div class="alignment-buttons">
                        <button class="alignment-btn" id="align-top" aria-label="Align top">
                            <span class="material-symbols-rounded">align_vertical_top</span>
                        </button>
                        <button class="alignment-btn" id="align-center-v" aria-label="Align center vertically">
                            <span class="material-symbols-rounded">align_vertical_center</span>
                        </button>
                        <button class="alignment-btn" id="align-bottom" aria-label="Align bottom">
                            <span class="material-symbols-rounded">align_vertical_bottom</span>
                        </button>
                    </div>
                </div>
            </div>
        </aside>
    </main>

    <footer>
        <div class="history-buttons">
            <button class="btn btn-outline" id="undo-btn" disabled aria-label="Undo">
                <span class="material-symbols-rounded">undo</span>
                Undo
            </button>
            <button class="btn btn-outline" id="redo-btn" disabled aria-label="Redo">
                <span class="material-symbols-rounded">redo</span>
                Redo
            </button>
        </div>
        <div class="zoom-controls">
            <button class="zoom-btn" id="zoom-out" aria-label="Zoom out">
                <span class="material-symbols-rounded">remove</span>
            </button>
            <span class="zoom-level" id="zoom-level">100%</span>
            <button class="zoom-btn" id="zoom-in" aria-label="Zoom in">
                <span class="material-symbols-rounded">add</span>
            </button>
        </div>
    </footer>

    <!-- Template Modal -->
    <div class="template-modal" id="templates-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Choose a Template</h3>
                <button class="close-modal" id="close-modal" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="template-category">
                    <h4 class="template-category-title">Event Posters</h4>
                    <div class="templates-modal-grid">
                        <div class="template-item" data-template="template1" tabindex="0" role="button"
                            aria-label="Basic Event template">
                            <img src="https://placehold.co/200x300/4a6bff/ffffff?text=Event" alt="Event Template">
                            <div class="template-name">Basic Event</div>
                        </div>
                        <div class="template-item" data-template="template2" tabindex="0" role="button"
                            aria-label="Concert template">
                            <img src="https://placehold.co/200x300/ff5e7d/ffffff?text=Concert" alt="Concert Template">
                            <div class="template-name">Concert</div>
                        </div>
                        <div class="template-item" data-template="template3" tabindex="0" role="button"
                            aria-label="Workshop template">
                            <img src="https://placehold.co/200x300/ffbb38/333333?text=Workshop" alt="Workshop Template">
                            <div class="template-name">Workshop</div>
                        </div>
                    </div>
                </div>

                <div class="template-category">
                    <h4 class="template-category-title">Community & Social</h4>
                    <div class="templates-modal-grid">
                        <div class="template-item" data-template="template4" tabindex="0" role="button"
                            aria-label="Community template">
                            <img src="https://placehold.co/200x300/4caf50/ffffff?text=Community"
                                alt="Community Template">
                            <div class="template-name">Community</div>
                        </div>
                        <div class="template-item" data-template="template5" tabindex="0" role="button"
                            aria-label="Festival template">
                            <img src="https://placehold.co/200x300/9c27b0/ffffff?text=Festival" alt="Festival Template">
                            <div class="template-name">Festival</div>
                        </div>
                        <div class="template-item" data-template="template8" tabindex="0" role="button"
                            aria-label="Meetup template">
                            <img src="https://placehold.co/200x300/ff9800/ffffff?text=Meetup" alt="Meetup Template">
                            <div class="template-name">Meetup</div>
                        </div>
                    </div>
                </div>

                <div class="template-category">
                    <h4 class="template-category-title">Business & Education</h4>
                    <div class="templates-modal-grid">
                        <div class="template-item" data-template="template6" tabindex="0" role="button"
                            aria-label="Sale template">
                            <img src="https://placehold.co/200x300/f44336/ffffff?text=Sale" alt="Sale Template">
                            <div class="template-name">Sale</div>
                        </div>
                        <div class="template-item" data-template="template7" tabindex="0" role="button"
                            aria-label="Seminar template">
                            <img src="https://placehold.co/200x300/2196f3/ffffff?text=Seminar" alt="Seminar Template">
                            <div class="template-name">Seminar</div>
                        </div>
                        <div class="template-item" data-template="template9" tabindex="0" role="button"
                            aria-label="Charity template">
                            <img src="https://placehold.co/200x300/795548/ffffff?text=Charity" alt="Charity Template">
                            <div class="template-name">Charity</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="export-modal" id="export-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Export Your Poster</h3>
                <button class="close-modal" id="close-export-modal" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 15px;">Choose a format to export your poster:</p>
                <div class="export-options">
                    <div class="export-option" id="export-png" tabindex="0" role="button" aria-label="Export as PNG">
                        <span class="material-symbols-rounded export-option-icon">image</span>
                        <div class="export-option-title">PNG</div>
                        <div class="export-option-desc">Best for web & digital sharing</div>
                    </div>
                    <div class="export-option" id="export-jpg" tabindex="0" role="button" aria-label="Export as JPG">
                        <span class="material-symbols-rounded export-option-icon">photo</span>
                        <div class="export-option-title">JPG</div>
                        <div class="export-option-desc">Smaller file size, good for photos</div>
                    </div>
                    <div class="export-option" id="export-pdf" tabindex="0" role="button" aria-label="Export as PDF">
                        <span class="material-symbols-rounded export-option-icon">picture_as_pdf</span>
                        <div class="export-option-title">PDF</div>
                        <div class="export-option-desc">Best for printing</div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <div class="property-row">
                        <label class="property-label" for="export-quality">Quality</label>
                        <input type="range" id="export-quality" min="1" max="10" value="8">
                        <div class="range-value-display">
                            <span id="quality-value">8</span>/10
                        </div>
                    </div>
                    <div class="property-row">
                        <label class="property-label" for="export-scale">Scale</label>
                        <select class="font-select" id="export-scale">
                            <option value="1">1x (600 × 800px)</option>
                            <option value="2" selected>2x (1200 × 1600px)</option>
                            <option value="3">3x (1800 × 2400px)</option>
                        </select>
                    </div>
                </div>
                <div class="download-progress" id="download-progress">
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="progress-bar"></div>
                    </div>
                    <div class="progress-status">
                        <span>Processing...</span>
                        <span id="progress-percent">0%</span>
                    </div>
                </div>
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-accent" id="download-btn">
                        <span class="material-symbols-rounded">file_download</span>
                        Download
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Keyboard Shortcuts Modal -->
    <div class="shortcuts-modal" id="shortcuts-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Keyboard Shortcuts</h3>
                <button class="close-modal" id="close-shortcuts-modal" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="shortcuts-grid">
                    <div>
                        <div class="shortcut-group">
                            <h4 class="shortcut-group-title">General</h4>
                            <div class="shortcut-item">
                                <span>Save</span>
                                <div class="shortcut-keys">
                                    <span class="key">Ctrl</span>
                                    <span>+</span>
                                    <span class="key">S</span>
                                </div>
                            </div>
                            <div class="shortcut-item">
                                <span>Export</span>
                                <div class="shortcut-keys">
                                    <span class="key">Ctrl</span>
                                    <span>+</span>
                                    <span class="key">E</span>
                                </div>
                            </div>
                            <div class="shortcut-item">
                                <span>New Poster</span>
                                <div class="shortcut-keys">
                                    <span class="key">Ctrl</span>
                                    <span>+</span>
                                    <span class="key">N</span>
                                </div>
                            </div>
                            <div class="shortcut-item">
                                <span>Zoom In</span>
                                <div class="shortcut-keys">
                                    <span class="key">Ctrl</span>
                                    <span>+</span>
                                    <span class="key">+</span>
                                </div>
                            </div>
                            <div class="shortcut-item">
                                <span>Zoom Out</span>
                                <div class="shortcut-keys">
                                    <span class="key">Ctrl</span>
                                    <span>+</span>
                                    <span class="key">-</span>
                                </div>
                            </div>
                        </div>

                        <div class="shortcut-group">
                            <h4 class="shortcut-group-title">Element Actions</h4>
                            <div class="shortcut-item">
                                <span>Delete Element</span>
                                <div class="shortcut-keys">
                                    <span class="key">Delete</span>
                                </div>
                            </div>
                            <div class="shortcut-item">
                                <span>Copy Element</span>
                                <div class="shortcut-keys">
                                    <span class="key">Ctrl</span>
                                    <span>+</span>
                                    <span class="key">C</span>
                                </div>
                            </div>
                            <div class="shortcut-item">
                                <span>Paste Element</span>
                                <div class="shortcut-keys">
                                    <span class="key">Ctrl</span>
                                    <span>+</span>
                                    <span class="key">V</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <div class="shortcut-group">
                            <h4 class="shortcut-group-title">Edit History</h4>
                            <div class="shortcut-item">
                                <span>Undo</span>
                                <div class="shortcut-keys">
                                    <span class="key">Ctrl</span>
                                    <span>+</span>
                                    <span class="key">Z</span>
                                </div>
                            </div>
                            <div class="shortcut-item">
                                <span>Redo</span>
                                <div class="shortcut-keys">
                                    <span class="key">Ctrl</span>
                                    <span>+</span>
                                    <span class="key">Y</span>
                                </div>
                            </div>
                        </div>

                        <div class="shortcut-group">
                            <h4 class="shortcut-group-title">Tools</h4>
                            <div class="shortcut-item">
                                <span>Add Text</span>
                                <div class="shortcut-keys">
                                    <span class="key">T</span>
                                </div>
                            </div>
                            <div class="shortcut-item">
                                <span>Add Image</span>
                                <div class="shortcut-keys">
                                    <span class="key">I</span>
                                </div>
                            </div>
                            <div class="shortcut-item">
                                <span>Add Shape</span>
                                <div class="shortcut-keys">
                                    <span class="key">S</span>
                                </div>
                            </div>
                            <div class="shortcut-item">
                                <span>Select All</span>
                                <div class="shortcut-keys">
                                    <span class="key">Ctrl</span>
                                    <span>+</span>
                                    <span class="key">A</span>
                                </div>
                            </div>
                            <div class="shortcut-item">
                                <span>Deselect All</span>
                                <div class="shortcut-keys">
                                    <span class="key">Esc</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="context-menu">
        <div class="context-menu-item" id="context-copy">
            <span class="material-symbols-rounded">content_copy</span>
            Copy
        </div>
        <div class="context-menu-item" id="context-paste">
            <span class="material-symbols-rounded">content_paste</span>
            Paste
        </div>
        <div class="context-menu-item" id="context-duplicate">
            <span class="material-symbols-rounded">file_copy</span>
            Duplicate
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" id="context-bring-forward">
            <span class="material-symbols-rounded">flip_to_front</span>
            Bring Forward
        </div>
        <div class="context-menu-item" id="context-send-backward">
            <span class="material-symbols-rounded">flip_to_back</span>
            Send Backward
        </div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" id="context-delete">
            <span class="material-symbols-rounded">delete</span>
            Delete
        </div>
    </div>

    <!-- Toast Notification -->
    <div class="toast" id="toast">
        <span class="material-symbols-rounded toast-icon">check_circle</span>
        <span class="toast-message">Action completed successfully</span>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Confirm Dialog -->
    <div class="confirm-dialog" id="confirm-dialog">
        <div class="confirm-dialog-content">
            <h3 class="confirm-dialog-title">Confirm Action</h3>
            <p class="confirm-dialog-message" id="confirm-message">Are you sure you want to proceed?</p>
            <div class="confirm-dialog-actions">
                <button class="btn btn-outline" id="confirm-cancel">Cancel</button>
                <button class="btn btn-secondary" id="confirm-ok">OK</button>
            </div>
        </div>
    </div>

    <!-- Onboarding Tooltip -->
    <div class="onboarding-tooltip" id="onboarding-tooltip" style="display: none;">
        <button class="tooltip-close" id="tooltip-close">&times;</button>
        <div id="tooltip-content">Welcome to the Event Poster Designer!</div>
        <button class="tooltip-next" id="tooltip-next">Next</button>
    </div>

    <script>
        // Global variables
        let selectedElement = null;
        let canvasElements = [];
        let isDragging = false;
        let isResizing = false;
        let isRotating = false;
        let startX, startY;
        let elementStartX, elementStartY;
        let currentZoom = 100;
        let historyStack = [];
        let historyIndex = -1;
        let clipboardElement = null;
        let isKeyboardUser = false;
        let bgPattern = 'none';
        let bgGradient = 'none';
        let confirmCallback = null;
        let onboardingStep = 0;
        let hasSeenOnboarding = localStorage.getItem('hasSeenOnboarding') === 'true';

        // DOM elements
        const canvas = document.getElementById('design-canvas');
        const templateModal = document.getElementById('templates-modal');
        const exportModal = document.getElementById('export-modal');
        const shortcutsModal = document.getElementById('shortcuts-modal');
        const confirmDialog = document.getElementById('confirm-dialog');
        const closeModalBtn = document.getElementById('close-modal');
        const closeExportModalBtn = document.getElementById('close-export-modal');
        const closeShortcutsModalBtn = document.getElementById('close-shortcuts-modal');
        const confirmCancelBtn = document.getElementById('confirm-cancel');
        const confirmOkBtn = document.getElementById('confirm-ok');
        const confirmMessageEl = document.getElementById('confirm-message');
        const moreTemplatesBtn = document.getElementById('more-templates-btn');
        const templateTool = document.getElementById('template-tool');
        const textTool = document.getElementById('text-tool');
        const imageTool = document.getElementById('image-tool');
        const shapeTool = document.getElementById('shape-tool');
        const backgroundTool = document.getElementById('background-tool');
        const layersTool = document.getElementById('layers-tool');
        const undoBtn = document.getElementById('undo-btn');
        const redoBtn = document.getElementById('redo-btn');
        const zoomInBtn = document.getElementById('zoom-in');
        const zoomOutBtn = document.getElementById('zoom-out');
        const zoomLevelEl = document.getElementById('zoom-level');
        const fontSizeInput = document.getElementById('font-size');
        const fontSizeValue = document.getElementById('font-size-value');
        const textSpacingInput = document.getElementById('text-spacing');
        const textSpacingValue = document.getElementById('text-spacing-value');
        const textLineHeightInput = document.getElementById('text-line-height');
        const textLineHeightValue = document.getElementById('text-line-height-value');
        const imageOpacityInput = document.getElementById('image-opacity');
        const opacityValue = document.getElementById('opacity-value');
        const imageBorderWidthInput = document.getElementById('image-border-width');
        const borderWidthValue = document.getElementById('border-width-value');
        const imageBorderRadiusInput = document.getElementById('image-border-radius');
        const borderRadiusValue = document.getElementById('border-radius-value');
        const imageBrightnessInput = document.getElementById('image-brightness');
        const brightnessValue = document.getElementById('brightness-value');
        const imageContrastInput = document.getElementById('image-contrast');
        const contrastValue = document.getElementById('contrast-value');
        const shapeBorderWidthInput = document.getElementById('shape-border-width');
        const shapeBorderWidthValue = document.getElementById('shape-border-width-value');
        const shapeBorderRadiusInput = document.getElementById('shape-border-radius');
        const shapeRadiusValue = document.getElementById('shape-radius-value');
        const shapeOpacityInput = document.getElementById('shape-opacity');
        const shapeOpacityValue = document.getElementById('shape-opacity-value');
        const bgOpacityInput = document.getElementById('bg-opacity');
        const bgOpacityValue = document.getElementById('bg-opacity-value');
        const elementRotationInput = document.getElementById('element-rotation');
        const rotationValue = document.getElementById('rotation-value');
        const exportQualityInput = document.getElementById('export-quality');
        const qualityValue = document.getElementById('quality-value');
        const imageUploadInput = document.getElementById('image-upload-input');
        const bgUploadInput = document.getElementById('bg-upload-input');
        const contextMenu = document.getElementById('context-menu');
        const toast = document.getElementById('toast');
        const loadingOverlay = document.getElementById('loading-overlay');
        const saveBtn = document.getElementById('save-btn');
        const exportBtn = document.getElementById('export-btn');
        const newPosterBtn = document.getElementById('new-poster-btn');
        const shortcutsBtn = document.getElementById('shortcuts-btn');
        const downloadBtn = document.getElementById('download-btn');
        const bgPatternSelect = document.getElementById('bg-pattern');
        const bgGradientSelect = document.getElementById('bg-gradient');
        const gradientColorsDiv = document.getElementById('gradient-colors');
        const alignLeftBtn = document.getElementById('align-left');
        const alignCenterHBtn = document.getElementById('align-center-h');
        const alignRightBtn = document.getElementById('align-right');
        const alignTopBtn = document.getElementById('align-top');
        const alignCenterVBtn = document.getElementById('align-center-v');
        const alignBottomBtn = document.getElementById('align-bottom');
        const fontPreview = document.getElementById('font-preview');
        const layersList = document.getElementById('layers-list');
        const layerDuplicateBtn = document.getElementById('layer-duplicate');
        const layerDeleteBtn = document.getElementById('layer-delete');
        const layerUpBtn = document.getElementById('layer-up');
        const layerDownBtn = document.getElementById('layer-down');
        const onboardingTooltip = document.getElementById('onboarding-tooltip');
        const tooltipContent = document.getElementById('tooltip-content');
        const tooltipNext = document.getElementById('tooltip-next');
        const tooltipClose = document.getElementById('tooltip-close');
        const progressBar = document.getElementById('progress-bar');
        const progressPercent = document.getElementById('progress-percent');
        const downloadProgress = document.getElementById('download-progress');

        // Initialize the application
        function init() {
            // Set up event listeners
            setupEventListeners();

            // Set canvas background color
            canvas.style.backgroundColor = '#ffffff';

            // Create empty history state
            saveToHistory();

            // Show welcome toast
            showToast('Welcome to Event Poster Designer!', 'success');

            // Detect keyboard users
            window.addEventListener('keydown', function () {
                if (!isKeyboardUser) {
                    isKeyboardUser = true;
                    document.body.classList.add('keyboard-focus');
                }
            });

            window.addEventListener('mousedown', function () {
                if (isKeyboardUser) {
                    isKeyboardUser = false;
                    document.body.classList.remove('keyboard-focus');
                }
            });

            // Initialize font preview
            updateFontPreview();

            // Load from local storage if available
            tryLoadFromLocalStorage();

            // Start onboarding if it's the first visit
            if (!hasSeenOnboarding) {
                startOnboarding();
            }
        }

        // Set up event listeners
        function setupEventListeners() {
            // Template modal events
            moreTemplatesBtn.addEventListener('click', openTemplatesModal);
            templateTool.addEventListener('click', openTemplatesModal);
            closeModalBtn.addEventListener('click', closeTemplatesModal);

            // Export modal events
            exportBtn.addEventListener('click', openExportModal);
            closeExportModalBtn.addEventListener('click', closeExportModal);
            downloadBtn.addEventListener('click', downloadPoster);

            // Shortcuts modal events
            shortcutsBtn.addEventListener('click', openShortcutsModal);
            closeShortcutsModalBtn.addEventListener('click', closeShortcutsModal);

            // Confirm dialog events
            confirmCancelBtn.addEventListener('click', () => {
                confirmDialog.classList.remove('active');
                confirmCallback = null;
            });
            confirmOkBtn.addEventListener('click', () => {
                confirmDialog.classList.remove('active');
                if (confirmCallback) {
                    confirmCallback();
                    confirmCallback = null;
                }
            });

            // Tool events
            textTool.addEventListener('click', addTextElement);
            imageTool.addEventListener('click', () => imageUploadInput.click());
            shapeTool.addEventListener('click', addShapeElement);
            backgroundTool.addEventListener('click', () => {
                deselectAllElements();
                showPropertyPanel('background-properties');
            });
            layersTool.addEventListener('click', () => {
                deselectAllElements();
                showPropertyPanel('layers-properties');
                updateLayersPanel();
            });

            // File upload events
            imageUploadInput.addEventListener('change', handleImageUpload);
            document.getElementById('image-upload-area').addEventListener('click', () => imageUploadInput.click());
            bgUploadInput.addEventListener('change', handleBackgroundImageUpload);
            document.getElementById('bg-upload-area').addEventListener('click', () => bgUploadInput.click());

            // Canvas events
            canvas.addEventListener('click', handleCanvasClick);
            canvas.addEventListener('mousedown', handleCanvasMouseDown);
            canvas.addEventListener('contextmenu', handleContextMenu);
            document.addEventListener('mousemove', handleMouseMove);
            document.addEventListener('mouseup', handleMouseUp);

            // 添加touchstart、touchmove和touchend事件支持触摸设备
            canvas.addEventListener('touchstart', function (e) {
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                handleCanvasMouseDown(mouseEvent);
            });

            document.addEventListener('touchmove', function (e) {
                if (isDragging || isResizing || isRotating) {
                    e.preventDefault(); // 防止页面滚动
                    const touch = e.touches[0];
                    const mouseEvent = new MouseEvent('mousemove', {
                        clientX: touch.clientX,
                        clientY: touch.clientY
                    });
                    handleMouseMove(mouseEvent);
                }
            }, { passive: false });

            document.addEventListener('touchend', function (e) {
                const mouseEvent = new MouseEvent('mouseup', {});
                handleMouseUp(mouseEvent);
            });

            // History events
            undoBtn.addEventListener('click', undo);
            redoBtn.addEventListener('click', redo);

            // Zoom events
            zoomInBtn.addEventListener('click', () => changeZoom(10));
            zoomOutBtn.addEventListener('click', () => changeZoom(-10));

            // Property input events
            setupPropertyInputEvents();

            // Template selection events
            document.querySelectorAll('.template-item').forEach(item => {
                item.addEventListener('click', () => loadTemplate(item.dataset.template));
                item.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        loadTemplate(item.dataset.template);
                        e.preventDefault();
                    }
                });
            });

            // Context menu events
            setupContextMenuEvents();

            // Save and export events
            saveBtn.addEventListener('click', saveDesign);
            newPosterBtn.addEventListener('click', confirmNewPoster);

            // Alignment button events
            alignLeftBtn.addEventListener('click', () => alignElement('left'));
            alignCenterHBtn.addEventListener('click', () => alignElement('centerH'));
            alignRightBtn.addEventListener('click', () => alignElement('right'));
            alignTopBtn.addEventListener('click', () => alignElement('top'));
            alignCenterVBtn.addEventListener('click', () => alignElement('centerV'));
            alignBottomBtn.addEventListener('click', () => alignElement('bottom'));

            // Background pattern and gradient events
            bgPatternSelect.addEventListener('change', updateBackgroundPattern);
            bgGradientSelect.addEventListener('change', updateBackgroundGradient);
            document.getElementById('gradient-color-1').addEventListener('input', updateBackgroundGradient);
            document.getElementById('gradient-color-2').addEventListener('input', updateBackgroundGradient);

            // Layer panel button events
            layerDuplicateBtn.addEventListener('click', duplicateSelectedLayer);
            layerDeleteBtn.addEventListener('click', deleteSelectedLayer);
            layerUpBtn.addEventListener('click', moveLayerUp);
            layerDownBtn.addEventListener('click', moveLayerDown);

            // Onboarding tooltip events
            tooltipNext.addEventListener('click', nextOnboardingStep);
            tooltipClose.addEventListener('click', closeOnboarding);

            // Close context menu on click outside
            document.addEventListener('click', () => {
                contextMenu.style.display = 'none';
            });

            // Global keyboard shortcuts
            document.addEventListener('keydown', handleKeyboardShortcuts);

            // Drag and drop for images
            setupDragAndDrop();

            // Window resize event
            window.addEventListener('resize', handleWindowResize);
        }

        // Start onboarding
        function startOnboarding() {
            onboardingStep = 0;
            showOnboardingStep();
        }

        // Show current onboarding step
        function showOnboardingStep() {
            const steps = [
                {
                    element: textTool,
                    content: "Welcome to Event Poster Designer! Click here to add text to your poster.",
                    position: "right"
                },
                {
                    element: document.querySelector('.templates-grid'),
                    content: "Choose from these templates to quickly start your design.",
                    position: "right"
                },
                {
                    element: canvas,
                    content: "This is your canvas where you'll design your poster. Click and drag elements to position them.",
                    position: "left"
                },
                {
                    element: document.querySelector('.properties-panel'),
                    content: "Use these panels to customize your elements. Select an element to see its properties.",
                    position: "left"
                },
                {
                    element: exportBtn,
                    content: "When you're finished, click here to export your poster as an image or PDF.",
                    position: "bottom"
                }
            ];

            if (onboardingStep >= steps.length) {
                closeOnboarding();
                return;
            }

            const currentStep = steps[onboardingStep];
            const element = currentStep.element;
            const rect = element.getBoundingClientRect();

            // Position tooltip
            onboardingTooltip.style.display = 'block';
            onboardingTooltip.className = 'onboarding-tooltip ' + currentStep.position;
            tooltipContent.textContent = currentStep.content;

            switch (currentStep.position) {
                case 'top':
                    onboardingTooltip.style.left = (rect.left + rect.width / 2 - onboardingTooltip.offsetWidth / 2) + 'px';
                    onboardingTooltip.style.top = (rect.top - onboardingTooltip.offsetHeight - 10) + 'px';
                    break;
                case 'bottom':
                    onboardingTooltip.style.left = (rect.left + rect.width / 2 - onboardingTooltip.offsetWidth / 2) + 'px';
                    onboardingTooltip.style.top = (rect.bottom + 10) + 'px';
                    break;
                case 'left':
                    onboardingTooltip.style.left = (rect.left - onboardingTooltip.offsetWidth - 10) + 'px';
                    onboardingTooltip.style.top = (rect.top + rect.height / 2 - onboardingTooltip.offsetHeight / 2) + 'px';
                    break;
                case 'right':
                    onboardingTooltip.style.left = (rect.right + 10) + 'px';
                    onboardingTooltip.style.top = (rect.top + rect.height / 2 - onboardingTooltip.offsetHeight / 2) + 'px';
                    break;
            }

            // Update next button text for last step
            if (onboardingStep === steps.length - 1) {
                tooltipNext.textContent = "Finish";
            } else {
                tooltipNext.textContent = "Next";
            }
        }

        // Go to next onboarding step
        function nextOnboardingStep() {
            onboardingStep++;
            showOnboardingStep();
        }

        // Close onboarding
        function closeOnboarding() {
            onboardingTooltip.style.display = 'none';
            localStorage.setItem('hasSeenOnboarding', 'true');
            hasSeenOnboarding = true;
        }

        // Handle window resize
        function handleWindowResize() {
            // Adjust canvas container if needed
            const canvasContainer = document.querySelector('.canvas-container');
            if (window.innerWidth < 992) {
                canvasContainer.style.height = '500px';
            } else {
                canvasContainer.style.height = 'calc(100vh - 130px)';
            }

            // Reposition onboarding tooltip if visible
            if (onboardingTooltip.style.display === 'block') {
                showOnboardingStep();
            }
        }

        // Update font preview
        function updateFontPreview() {
            const fontFamily = document.getElementById('font-family').value;
            const fontSize = document.getElementById('font-size').value;
            const textColor = document.getElementById('text-color').value;
            const textContent = document.getElementById('text-content').value || 'Preview Text';

            fontPreview.style.fontFamily = fontFamily;
            fontPreview.style.fontSize = `${fontSize}px`;
            fontPreview.style.color = textColor;
            fontPreview.textContent = textContent;

            // Apply other text styles if they are active
            const boldBtn = document.querySelector('.alignment-btn[data-style="bold"]');
            const italicBtn = document.querySelector('.alignment-btn[data-style="italic"]');
            const underlineBtn = document.querySelector('.alignment-btn[data-style="underline"]');
            const uppercaseBtn = document.querySelector('.alignment-btn[data-style="uppercase"]');

            fontPreview.style.fontWeight = boldBtn.classList.contains('active') ? 'bold' : 'normal';
            fontPreview.style.fontStyle = italicBtn.classList.contains('active') ? 'italic' : 'normal';
            fontPreview.style.textDecoration = underlineBtn.classList.contains('active') ? 'underline' : 'none';
            fontPreview.style.textTransform = uppercaseBtn.classList.contains('active') ? 'uppercase' : 'none';

            // Apply text alignment if it's active
            const alignmentBtns = document.querySelectorAll('.alignment-btn[data-align]');
            alignmentBtns.forEach(btn => {
                if (btn.classList.contains('active')) {
                    fontPreview.style.textAlign = btn.dataset.align;
                }
            });

            // Apply letter spacing and line height
            fontPreview.style.letterSpacing = `${document.getElementById('text-spacing').value}px`;
            fontPreview.style.lineHeight = document.getElementById('text-line-height').value;
        }

        // Set up property input event listeners
        function setupPropertyInputEvents() {
            // Text properties
            document.getElementById('text-content').addEventListener('input', () => {
                updateTextContent();
                updateFontPreview();
            });
            document.getElementById('font-family').addEventListener('change', () => {
                updateTextFont();
                updateFontPreview();
            });
            document.getElementById('font-size').addEventListener('input', () => {
                updateTextSize();
                updateFontPreview();
            });
            document.getElementById('text-color').addEventListener('input', () => {
                updateTextColor();
                updateFontPreview();
            });
            document.getElementById('text-spacing').addEventListener('input', () => {
                updateTextSpacing();
                updateFontPreview();
            });
            document.getElementById('text-line-height').addEventListener('input', () => {
                updateTextLineHeight();
                updateFontPreview();
            });

            // Font size value display
            fontSizeInput.addEventListener('input', () => {
                fontSizeValue.textContent = fontSizeInput.value;
            });

            // Text spacing value display
            textSpacingInput.addEventListener('input', () => {
                textSpacingValue.textContent = textSpacingInput.value;
            });

            // Line height value display
            textLineHeightInput.addEventListener('input', () => {
                textLineHeightValue.textContent = textLineHeightInput.value;
            });

            // Image properties
            document.getElementById('image-opacity').addEventListener('input', updateImageOpacity);
            document.getElementById('image-border-width').addEventListener('input', updateImageBorder);
            document.getElementById('image-border-color').addEventListener('input', updateImageBorderColor);
            document.getElementById('image-border-radius').addEventListener('input', updateImageBorderRadius);
            document.getElementById('image-brightness').addEventListener('input', updateImageFilters);
            document.getElementById('image-contrast').addEventListener('input', updateImageFilters);

            // Image opacity value display
            imageOpacityInput.addEventListener('input', () => {
                opacityValue.textContent = imageOpacityInput.value;
            });

            // Image border width value display
            imageBorderWidthInput.addEventListener('input', () => {
                borderWidthValue.textContent = imageBorderWidthInput.value;
            });

            // Image border radius value display
            imageBorderRadiusInput.addEventListener('input', () => {
                borderRadiusValue.textContent = imageBorderRadiusInput.value;
            });

            // Image brightness value display
            imageBrightnessInput.addEventListener('input', () => {
                brightnessValue.textContent = imageBrightnessInput.value;
            });

            // Image contrast value display
            imageContrastInput.addEventListener('input', () => {
                contrastValue.textContent = imageContrastInput.value;
            });

            // Shape properties
            document.getElementById('shape-type').addEventListener('change', updateShapeType);
            document.getElementById('shape-fill-color').addEventListener('input', updateShapeFillColor);
            document.getElementById('shape-border-width').addEventListener('input', updateShapeBorder);
            document.getElementById('shape-border-color').addEventListener('input', updateShapeBorderColor);
            document.getElementById('shape-opacity').addEventListener('input', updateShapeOpacity);
            document.getElementById('shape-border-radius').addEventListener('input', updateShapeBorderRadius);

            // Shape border width value display
            shapeBorderWidthInput.addEventListener('input', () => {
                shapeBorderWidthValue.textContent = shapeBorderWidthInput.value;
            });

            // Shape border radius value display
            shapeBorderRadiusInput.addEventListener('input', () => {
                shapeRadiusValue.textContent = shapeBorderRadiusInput.value;
            });

            // Shape opacity value display
            shapeOpacityInput.addEventListener('input', () => {
                shapeOpacityValue.textContent = shapeOpacityInput.value;
            });

            // Background properties
            document.getElementById('bg-color').addEventListener('input', updateBackgroundColor);
            document.getElementById('bg-opacity').addEventListener('input', updateBackgroundOpacity);

            // Background opacity value display
            bgOpacityInput.addEventListener('input', () => {
                bgOpacityValue.textContent = bgOpacityInput.value;
            });

            // Position & Size properties
            document.getElementById('element-width').addEventListener('change', updateElementWidth);
            document.getElementById('element-height').addEventListener('change', updateElementHeight);
            document.getElementById('element-x').addEventListener('change', updateElementX);
            document.getElementById('element-y').addEventListener('change', updateElementY);
            document.getElementById('element-rotation').addEventListener('input', updateElementRotation);

            // Rotation value display
            elementRotationInput.addEventListener('input', () => {
                rotationValue.textContent = elementRotationInput.value;
            });

            // Export quality value display
            exportQualityInput.addEventListener('input', () => {
                qualityValue.textContent = exportQualityInput.value;
            });

            // Text alignment buttons
            document.querySelectorAll('.alignment-btn[data-align]').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.alignment-btn[data-align]').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    updateTextAlignment(btn.dataset.align);
                    updateFontPreview();
                });
            });

            // Text style buttons
            document.querySelectorAll('.alignment-btn[data-style]').forEach(btn => {
                btn.addEventListener('click', () => {
                    btn.classList.toggle('active');
                    updateTextStyle(btn.dataset.style, btn.classList.contains('active'));
                    updateFontPreview();
                });
            });
        }

        // Set up context menu events
        function setupContextMenuEvents() {
            document.getElementById('context-copy').addEventListener('click', copyElement);
            document.getElementById('context-paste').addEventListener('click', pasteElement);
            document.getElementById('context-duplicate').addEventListener('click', duplicateElement);
            document.getElementById('context-bring-forward').addEventListener('click', bringElementForward);
            document.getElementById('context-send-backward').addEventListener('click', sendElementBackward);
            document.getElementById('context-delete').addEventListener('click', deleteSelectedElement);
        }

        // Set up drag and drop for images
        function setupDragAndDrop() {
            const imageUploadArea = document.getElementById('image-upload-area');
            const bgUploadArea = document.getElementById('bg-upload-area');

            // Prevent default behavior to allow drop
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                imageUploadArea.addEventListener(eventName, preventDefaults, false);
                bgUploadArea.addEventListener(eventName, preventDefaults, false);
                canvas.addEventListener(eventName, preventDefaults, false);
            });

            // Highlight drop area when item is dragged over
            ['dragenter', 'dragover'].forEach(eventName => {
                imageUploadArea.addEventListener(eventName, () => {
                    imageUploadArea.classList.add('highlight');
                }, false);

                bgUploadArea.addEventListener(eventName, () => {
                    bgUploadArea.classList.add('highlight');
                }, false);
            });

            // Remove highlight when item is dragged away
            ['dragleave', 'drop'].forEach(eventName => {
                imageUploadArea.addEventListener(eventName, () => {
                    imageUploadArea.classList.remove('highlight');
                }, false);

                bgUploadArea.addEventListener(eventName, () => {
                    bgUploadArea.classList.remove('highlight');
                }, false);
            });

            // Handle dropped files
            imageUploadArea.addEventListener('drop', e => {
                const dt = e.dataTransfer;
                const files = dt.files;

                if (files.length) {
                    imageUploadInput.files = files;
                    handleImageUpload({ target: imageUploadInput });
                }
            }, false);

            bgUploadArea.addEventListener('drop', e => {
                const dt = e.dataTransfer;
                const files = dt.files;

                if (files.length) {
                    bgUploadInput.files = files;
                    handleBackgroundImageUpload({ target: bgUploadInput });
                }
            }, false);

            // Handle dropping images directly onto canvas
            canvas.addEventListener('drop', e => {
                const dt = e.dataTransfer;
                const files = dt.files;

                if (files.length && files[0].type.match('image.*')) {
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        addImageElement(event.target.result, e.offsetX, e.offsetY);
                    };
                    reader.readAsDataURL(files[0]);
                }
            }, false);
        }

        // Prevent default behavior for drag and drop events
        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        // Open templates modal
        function openTemplatesModal() {
            templateModal.classList.add('active');
        }

        // Close templates modal
        function closeTemplatesModal() {
            templateModal.classList.remove('active');
        }

        // Open export modal
        function openExportModal() {
            exportModal.classList.add('active');
            downloadProgress.classList.remove('show');
            progressBar.style.width = '0%';
            progressPercent.textContent = '0%';
        }

        // Close export modal
        function closeExportModal() {
            exportModal.classList.remove('active');
        }

        // Open shortcuts modal
        function openShortcutsModal() {
            shortcutsModal.classList.add('active');
        }

        // Close shortcuts modal
        function closeShortcutsModal() {
            shortcutsModal.classList.remove('active');
        }

        // Show confirm dialog
        function showConfirmDialog(message, callback) {
            confirmMessageEl.textContent = message;
            confirmCallback = callback;
            confirmDialog.classList.add('active');
        }

        // Add a new text element to the canvas
        function addTextElement() {
            const element = document.createElement('div');
            element.className = 'canvas-element text-element';
            element.innerHTML = 'Your Text Here';
            element.style.fontFamily = "'Poppins', sans-serif";
            element.style.fontSize = '24px';
            element.style.color = '#000000';
            element.style.left = '50px';
            element.style.top = '50px';
            element.style.minWidth = '100px';
            element.style.minHeight = '30px';
            element.setAttribute('tabindex', '0');
            element.setAttribute('role', 'textbox');
            element.setAttribute('aria-label', 'Text element');

            canvas.appendChild(element);

            // Add element to the canvas elements array
            const newElement = {
                id: 'text-' + Date.now(),
                type: 'text',
                element: element,
                name: 'Text Element'
            };

            element.id = newElement.id;
            canvasElements.push(newElement);

            // Select the new element
            selectElement(element);

            // Make text editable on double-click
            element.addEventListener('dblclick', handleTextDoubleClick);

            // Save state to history
            saveToHistory();

            // Update layers panel if visible
            if (document.getElementById('layers-properties').style.display === 'block') {
                updateLayersPanel();
            }

            // Show toast
            showToast('Text element added', 'success');
        }

        // Handle text element double-click for inline editing
        function handleTextDoubleClick(e) {
            const textElement = e.target;
            textElement.contentEditable = true;
            textElement.focus();

            // Select all text
            const selection = window.getSelection();
            const range = document.createRange();
            range.selectNodeContents(textElement);
            selection.removeAllRanges();
            selection.addRange(range);

            // Save text when focus is lost
            const saveFn = () => {
                textElement.contentEditable = false;
                textElement.removeEventListener('blur', saveFn);
                document.getElementById('text-content').value = textElement.innerHTML;
                updateFontPreview();
                saveToHistory();
            };

            textElement.addEventListener('blur', saveFn);

            // Prevent event propagation to avoid drag start
            e.stopPropagation();
        }

        // Add a new image element to the canvas
        function addImageElement(imageUrl, x = 50, y = 50) {
            const element = document.createElement('div');
            element.className = 'canvas-element image-element';
            element.style.width = '200px';
            element.style.height = '200px';
            element.style.left = `${x}px`;
            element.style.top = `${y}px`;
            element.setAttribute('tabindex', '0');
            element.setAttribute('role', 'img');
            element.setAttribute('aria-label', 'Image element');

            const img = document.createElement('img');
            img.src = imageUrl;
            img.alt = 'User uploaded image';
            img.draggable = false;

            element.appendChild(img);
            canvas.appendChild(element);

            // Add element to the canvas elements array
            const newElement = {
                id: 'image-' + Date.now(),
                type: 'image',
                element: element,
                name: 'Image Element'
            };

            element.id = newElement.id;
            canvasElements.push(newElement);

            // Select the new element
            selectElement(element);

            // Save state to history
            saveToHistory();

            // Update layers panel if visible
            if (document.getElementById('layers-properties').style.display === 'block') {
                updateLayersPanel();
            }

            // Show toast
            showToast('Image added successfully', 'success');
        }

        // Handle image upload
        function handleImageUpload(e) {
            const file = e.target.files[0];
            if (file && file.type.match('image.*')) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    if (selectedElement && canvasElements.find(el => el.element === selectedElement)?.type === 'image') {
                        // Replace image in selected element
                        const img = selectedElement.querySelector('img');
                        img.src = event.target.result;
                        saveToHistory();
                        showToast('Image replaced successfully', 'success');
                    } else {
                        // Add new image element
                        addImageElement(event.target.result);
                    }
                };
                reader.readAsDataURL(file);
            }
        }

        // Handle background image upload
        function handleBackgroundImageUpload(e) {
            const file = e.target.files[0];
            if (file && file.type.match('image.*')) {
                const reader = new FileReader();
                reader.onload = function (event) {
                    canvas.style.backgroundImage = `url(${event.target.result})`;
                    canvas.style.backgroundSize = 'cover';
                    canvas.style.backgroundPosition = 'center';
                    saveToHistory();
                    showToast('Background image added', 'success');
                };
                reader.readAsDataURL(file);
            }
        }

        // Add a new shape element to the canvas
        function addShapeElement() {
            const element = document.createElement('div');
            element.className = 'canvas-element shape-element';
            element.style.width = '100px';
            element.style.height = '100px';
            element.style.backgroundColor = '#4a6bff';
            element.style.left = '50px';
            element.style.top = '50px';
            element.setAttribute('tabindex', '0');
            element.setAttribute('role', 'img');
            element.setAttribute('aria-label', 'Shape element');

            // 阻止事件冒泡，确保shape元素可以正确接收拖动事件
            element.addEventListener('mousedown', function (e) {
                e.stopPropagation();
            });

            canvas.appendChild(element);

            // Add element to the canvas elements array
            const newElement = {
                id: 'shape-' + Date.now(),
                type: 'shape',
                element: element,
                shapeType: 'rectangle',
                name: 'Shape Element'
            };

            element.id = newElement.id;
            canvasElements.push(newElement);

            // Select the new element
            selectElement(element);

            // Save state to history
            saveToHistory();

            // Update layers panel if visible
            if (document.getElementById('layers-properties').style.display === 'block') {
                updateLayersPanel();
            }

            // Show toast
            showToast('Shape added', 'success');
        }

        // Handle canvas click event
        function handleCanvasClick(e) {
            if (e.target === canvas) {
                // Clicked on the canvas background, deselect any selected element
                deselectAllElements();
                showPropertyPanel('background-properties');
            }
        }

        // Handle canvas mousedown event
        function handleCanvasMouseDown(e) {
            e.preventDefault(); // 阻止默认行为，防止屏幕变大

            if (e.target !== canvas && (e.target.classList.contains('canvas-element') || e.target.closest('.canvas-element'))) {
                // Get the actual element (could be the div or a child)
                const element = e.target.classList.contains('canvas-element') ? e.target : e.target.closest('.canvas-element');

                // Check if clicking on a resize handle
                if (e.target.classList.contains('resize-handle')) {
                    startResizing(e, element, e.target);
                    return;
                }

                // Check if clicking on a rotate handle
                if (e.target.classList.contains('rotate-handle')) {
                    startRotating(e, element);
                    return;
                }

                // Clicked on a canvas element
                selectElement(element);

                // Start dragging
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;

                elementStartX = parseInt(element.style.left) || 0;
                elementStartY = parseInt(element.style.top) || 0;
            }
        }

        // Start resizing an element
        function startResizing(e, element, handle) {
            isResizing = true;
            isDragging = false;

            startX = e.clientX;
            startY = e.clientY;

            const rect = element.getBoundingClientRect();
            const canvasRect = canvas.getBoundingClientRect();

            const startWidth = element.offsetWidth;
            const startHeight = element.offsetHeight;
            const startLeft = parseInt(element.style.left) || 0;
            const startTop = parseInt(element.style.top) || 0;

            const resizeType = handle.className.replace('resize-handle ', '');

            const onMouseMove = (moveEvent) => {
                if (!isResizing) return;

                const dx = (moveEvent.clientX - startX) / (currentZoom / 100);
                const dy = (moveEvent.clientY - startY) / (currentZoom / 100);

                let newWidth = startWidth;
                let newHeight = startHeight;
                let newLeft = startLeft;
                let newTop = startTop;

                // Handle different resize directions
                if (resizeType === 'bottom-right' || resizeType === '') {
                    newWidth = startWidth + dx;
                    newHeight = startHeight + dy;
                } else if (resizeType === 'bottom-left') {
                    newWidth = startWidth - dx;
                    newHeight = startHeight + dy;
                    newLeft = startLeft + dx;
                } else if (resizeType === 'top-right') {
                    newWidth = startWidth + dx;
                    newHeight = startHeight - dy;
                    newTop = startTop + dy;
                } else if (resizeType === 'top-left') {
                    newWidth = startWidth - dx;
                    newHeight = startHeight - dy;
                    newLeft = startLeft + dx;
                    newTop = startTop + dy;
                }

                // Apply minimum size constraints
                newWidth = Math.max(20, newWidth);
                newHeight = Math.max(20, newHeight);

                // Update element style
                element.style.width = `${newWidth}px`;
                element.style.height = `${newHeight}px`;
                element.style.left = `${newLeft}px`;
                element.style.top = `${newTop}px`;

                // Update position & size inputs
                document.getElementById('element-width').value = Math.round(newWidth);
                document.getElementById('element-height').value = Math.round(newHeight);
                document.getElementById('element-x').value = Math.round(newLeft);
                document.getElementById('element-y').value = Math.round(newTop);
            };

            const onMouseUp = () => {
                if (isResizing) {
                    isResizing = false;
                    saveToHistory();
                }

                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            };

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);

            e.preventDefault();
            e.stopPropagation();
        }

        // Start rotating an element
        function startRotating(e, element) {
            isRotating = true;
            isDragging = false;

            const rect = element.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            const startAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX) * (180 / Math.PI);
            const currentRotation = getCurrentRotation(element);

            const onMouseMove = (moveEvent) => {
                if (!isRotating) return;

                const newAngle = Math.atan2(moveEvent.clientY - centerY, moveEvent.clientX - centerX) * (180 / Math.PI);
                const angleDiff = newAngle - startAngle;
                let newRotation = (currentRotation + angleDiff) % 360;

                // Normalize to 0-360
                if (newRotation < 0) newRotation += 360;

                // Update element style
                element.style.transform = `rotate(${newRotation}deg)`;

                // Update rotation input
                document.getElementById('element-rotation').value = Math.round(newRotation);
                document.getElementById('rotation-value').textContent = Math.round(newRotation);
            };

            const onMouseUp = () => {
                if (isRotating) {
                    isRotating = false;
                    saveToHistory();
                }

                document.removeEventListener('mousemove', onMouseMove);
                document.removeEventListener('mouseup', onMouseUp);
            };

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mouseup', onMouseUp);

            e.preventDefault();
            e.stopPropagation();
        }

        // Get the current rotation of an element
        function getCurrentRotation(element) {
            const transform = element.style.transform;
            if (!transform || !transform.includes('rotate')) return 0;

            const match = transform.match(/rotate\(([0-9.]+)deg\)/);
            return match ? parseFloat(match[1]) : 0;
        }

        // Handle context menu event
        function handleContextMenu(e) {
            e.preventDefault();

            contextMenu.style.display = 'block';
            contextMenu.style.left = `${e.clientX}px`;
            contextMenu.style.top = `${e.clientY}px`;

            // If clicked on a canvas element, select it
            if (e.target !== canvas && (e.target.classList.contains('canvas-element') || e.target.closest('.canvas-element'))) {
                const element = e.target.classList.contains('canvas-element') ? e.target : e.target.closest('.canvas-element');
                selectElement(element);
            }
        }

        // Handle mouse move for dragging elements
        function handleMouseMove(e) {
            if (isDragging && selectedElement) {
                e.preventDefault(); // 阻止默认行为

                const dx = (e.clientX - startX) / (currentZoom / 100);
                const dy = (e.clientY - startY) / (currentZoom / 100);

                selectedElement.style.left = `${elementStartX + dx}px`;
                selectedElement.style.top = `${elementStartY + dy}px`;

                // Update position inputs
                document.getElementById('element-x').value = Math.round(elementStartX + dx);
                document.getElementById('element-y').value = Math.round(elementStartY + dy);
            } else if (isResizing && selectedElement) {
                e.preventDefault(); // 阻止默认行为

                const dx = (e.clientX - startX) / (currentZoom / 100);
                const dy = (e.clientY - startY) / (currentZoom / 100);

                const startWidth = parseInt(selectedElement.getAttribute('data-start-width')) || selectedElement.offsetWidth;
                const startHeight = parseInt(selectedElement.getAttribute('data-start-height')) || selectedElement.offsetHeight;
                const startLeft = parseInt(selectedElement.getAttribute('data-start-left')) || 0;
                const startTop = parseInt(selectedElement.getAttribute('data-start-top')) || 0;
                const resizeType = selectedElement.getAttribute('data-resize-type') || 'bottom-right';

                let newWidth = startWidth;
                let newHeight = startHeight;
                let newLeft = startLeft;
                let newTop = startTop;

                // Handle different resize directions
                if (resizeType === 'bottom-right' || resizeType === '') {
                    newWidth = startWidth + dx;
                    newHeight = startHeight + dy;
                } else if (resizeType === 'bottom-left') {
                    newWidth = startWidth - dx;
                    newHeight = startHeight + dy;
                    newLeft = startLeft + dx;
                } else if (resizeType === 'top-right') {
                    newWidth = startWidth + dx;
                    newHeight = startHeight - dy;
                    newTop = startTop + dy;
                } else if (resizeType === 'top-left') {
                    newWidth = startWidth - dx;
                    newHeight = startHeight - dy;
                    newLeft = startLeft + dx;
                    newTop = startTop + dy;
                }

                // Apply minimum size constraints
                newWidth = Math.max(20, newWidth);
                newHeight = Math.max(20, newHeight);

                // Update element style
                selectedElement.style.width = `${newWidth}px`;
                selectedElement.style.height = `${newHeight}px`;
                selectedElement.style.left = `${newLeft}px`;
                selectedElement.style.top = `${newTop}px`;

                // Update position & size inputs
                document.getElementById('element-width').value = Math.round(newWidth);
                document.getElementById('element-height').value = Math.round(newHeight);
                document.getElementById('element-x').value = Math.round(newLeft);
                document.getElementById('element-y').value = Math.round(newTop);
            } else if (isRotating && selectedElement) {
                e.preventDefault(); // 阻止默认行为

                const rect = selectedElement.getBoundingClientRect();
                const centerX = rect.left + rect.width / 2;
                const centerY = rect.top + rect.height / 2;

                const startAngle = parseFloat(selectedElement.getAttribute('data-start-angle')) || 0;
                const currentRotation = parseFloat(selectedElement.getAttribute('data-current-rotation')) || 0;
                const mouseStartAngle = parseFloat(selectedElement.getAttribute('data-mouse-start-angle')) || 0;

                const newAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX) * (180 / Math.PI);
                const angleDiff = newAngle - mouseStartAngle;
                let newRotation = (currentRotation + angleDiff) % 360;

                // Normalize to 0-360
                if (newRotation < 0) newRotation += 360;

                // Update element style
                selectedElement.style.transform = `rotate(${newRotation}deg)`;

                // Update rotation input
                document.getElementById('element-rotation').value = Math.round(newRotation);
                document.getElementById('rotation-value').textContent = Math.round(newRotation);
            }
        }

        // Handle mouse up to end dragging, resizing, or rotating
        function handleMouseUp(e) {
            if (isDragging || isResizing || isRotating) {
                e.preventDefault(); // 阻止默认行为

                isDragging = false;
                isResizing = false;
                isRotating = false;
                saveToHistory();

                // Clear temporary data attributes
                if (selectedElement) {
                    selectedElement.removeAttribute('data-start-width');
                    selectedElement.removeAttribute('data-start-height');
                    selectedElement.removeAttribute('data-start-left');
                    selectedElement.removeAttribute('data-start-top');
                    selectedElement.removeAttribute('data-resize-type');
                    selectedElement.removeAttribute('data-start-angle');
                    selectedElement.removeAttribute('data-current-rotation');
                    selectedElement.removeAttribute('data-mouse-start-angle');
                }
            }
        }

        // Start resizing an element
        function startResizing(e, element, handle) {
            isResizing = true;
            isDragging = false;
            isRotating = false;

            startX = e.clientX;
            startY = e.clientY;

            const startWidth = element.offsetWidth;
            const startHeight = element.offsetHeight;
            const startLeft = parseInt(element.style.left) || 0;
            const startTop = parseInt(element.style.top) || 0;
            const resizeType = handle.className.replace('resize-handle ', '');

            // Store starting values as data attributes
            element.setAttribute('data-start-width', startWidth);
            element.setAttribute('data-start-height', startHeight);
            element.setAttribute('data-start-left', startLeft);
            element.setAttribute('data-start-top', startTop);
            element.setAttribute('data-resize-type', resizeType);

            e.preventDefault();
            e.stopPropagation();
        }

        // Start rotating an element
        function startRotating(e, element) {
            isRotating = true;
            isDragging = false;
            isResizing = false;

            const rect = element.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;

            const mouseStartAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX) * (180 / Math.PI);
            const currentRotation = getCurrentRotation(element);

            // Store starting values as data attributes
            element.setAttribute('data-mouse-start-angle', mouseStartAngle);
            element.setAttribute('data-current-rotation', currentRotation);

            e.preventDefault();
            e.stopPropagation();
        }

        // Select an element
        function selectElement(element) {
            // Deselect any currently selected element
            deselectAllElements();

            // Select the new element
            selectedElement = element;
            element.classList.add('selected');

            // Add resize handles
            addResizeHandles(element);

            // Update properties panel based on element type
            const elementData = canvasElements.find(el => el.element === element);
            if (elementData) {
                switch (elementData.type) {
                    case 'text':
                        showPropertyPanel('text-properties');
                        updateTextPropertiesPanel(element);
                        break;
                    case 'image':
                        showPropertyPanel('image-properties');
                        updateImagePropertiesPanel(element);
                        break;
                    case 'shape':
                        showPropertyPanel('shape-properties');
                        updateShapePropertiesPanel(element);
                        break;
                }

                // Update position & size inputs
                updatePositionSizeInputs(element);
            }
        }

        // Deselect all elements
        function deselectAllElements() {
            // Remove selected class from all elements
            document.querySelectorAll('.canvas-element').forEach(el => {
                el.classList.remove('selected');
                // Remove resize handles
                const handles = el.querySelectorAll('.resize-handle, .rotate-handle');
                handles.forEach(handle => handle.remove());
            });

            selectedElement = null;
            document.getElementById('no-selection-message').style.display = 'block';
        }

        // Add resize handles to a selected element
        function addResizeHandles(element) {
            // Create resize handles
            const positions = ['top-left', 'top-right', 'bottom-left', 'bottom-right'];
            positions.forEach(position => {
                const handle = document.createElement('div');
                handle.className = `resize-handle ${position}`;
                element.appendChild(handle);
            });

            // Create rotate handle
            const rotateHandle = document.createElement('div');
            rotateHandle.className = 'rotate-handle';
            rotateHandle.innerHTML = '<span class="material-symbols-rounded">rotate_right</span>';
            element.appendChild(rotateHandle);
        }

        // Update position and size inputs
        function updatePositionSizeInputs(element) {
            document.getElementById('element-width').value = element.offsetWidth;
            document.getElementById('element-height').value = element.offsetHeight;
            document.getElementById('element-x').value = parseInt(element.style.left) || 0;
            document.getElementById('element-y').value = parseInt(element.style.top) || 0;

            const rotation = getCurrentRotation(element);
            document.getElementById('element-rotation').value = rotation;
            document.getElementById('rotation-value').textContent = rotation;
        }

        // Convert RGB to HEX color
        function rgbToHex(rgb) {
            if (!rgb || rgb === 'transparent') return '#000000';

            // Check if already a hex color
            if (rgb.startsWith('#')) return rgb;

            // Extract RGB values
            const rgbMatch = rgb.match(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*[\d.]+)?\)/i);
            if (!rgbMatch) return rgb;

            const r = parseInt(rgbMatch[1]);
            const g = parseInt(rgbMatch[2]);
            const b = parseInt(rgbMatch[3]);

            return `#${((1 << 24) + (r << 16) + (g << 8) + b).toString(16).slice(1)}`;
        }

        // Update text content
        function updateTextContent() {
            if (selectedElement && canvasElements.find(el => el.element === selectedElement)?.type === 'text') {
                selectedElement.innerHTML = document.getElementById('text-content').value;
                saveToHistory();
            }
        }

        // Update text font
        function updateTextFont() {
            if (selectedElement && canvasElements.find(el => el.element === selectedElement)?.type === 'text') {
                selectedElement.style.fontFamily = document.getElementById('font-family').value;
                saveToHistory();
            }
        }

        // Update text size
        function updateTextSize() {
            if (selectedElement && canvasElements.find(el => el.element === selectedElement)?.type === 'text') {
                const fontSize = document.getElementById('font-size').value;
                selectedElement.style.fontSize = `${fontSize}px`;
                fontSizeValue.textContent = fontSize;
                saveToHistory();
            }
        }

        // Update text color
        function updateTextColor() {
            if (selectedElement && canvasElements.find(el => el.element === selectedElement)?.type === 'text') {
                selectedElement.style.color = document.getElementById('text-color').value;
                saveToHistory();
            }
        }

        // Update text alignment
        function updateTextAlignment(alignment) {
            if (selectedElement && canvasElements.find(el => el.element === selectedElement)?.type === 'text') {
                selectedElement.style.textAlign = alignment;
                saveToHistory();
            }
        }

        // Update text style (bold, italic, underline, uppercase)
        function updateTextStyle(style, isActive) {
            if (selectedElement && canvasElements.find(el => el.element === selectedElement)?.type === 'text') {
                switch (style) {
                    case 'bold':
                        selectedElement.style.fontWeight = isActive ? 'bold' : 'normal';
                        break;
                    case 'italic':
                        selectedElement.style.fontStyle = isActive ? 'italic' : 'normal';
                        break;
                    case 'underline':
                        selectedElement.style.textDecoration = isActive ? 'underline' : 'none';
                        break;
                    case 'uppercase':
                        selectedElement.style.textTransform = isActive ? 'uppercase' : 'none';
                        break;
                }
                saveToHistory();
            }
        }

        // Update text letter spacing
        function updateTextSpacing() {
            if (selectedElement && canvasElements.find(el => el.element === selectedElement)?.type === 'text') {
                const spacing = document.getElementById('text-spacing').value;
                selectedElement.style.letterSpacing = `${spacing}px`;
                textSpacingValue.textContent = spacing;
                saveToHistory();
            }
        }

        // Update text line height
        function updateTextLineHeight() {
            if (selectedElement && canvasElements.find(el => el.element === selectedElement)?.type === 'text') {
                const lineHeight = document.getElementById('text-line-height').value;
                selectedElement.style.lineHeight = lineHeight;
                textLineHeightValue.textContent = lineHeight;
                saveToHistory();
            }
        }

        // Update image opacity
        function updateImageOpacity() {
            if (selectedElement && canvasElements.find(el => el.element === selectedElement)?.type === 'image') {
                const opacity = document.getElementById('image-opacity').value;
                selectedElement.style.opacity = opacity / 100;
                opacityValue.textContent = opacity;
                saveToHistory();
            }
        }

        // Update image border
        function updateImageBorder() {
            if (selectedElement && canvasElements.find(el => el.element === selectedElement)?.type === 'image') {
                const borderWidth = document.getElementById('image-border-width').value;
                selectedElement.style.borderWidth = `${borderWidth}px`;
                selectedElement.style.borderStyle = borderWidth > 0 ? 'solid' : 'none';
                borderWidthValue.textContent = borderWidth;
                saveToHistory();
            }
        }

        // Update image border color
        function updateImageBorderColor() {
            if (selectedElement && canvasElements.find(el => el.element === selectedElement)?.type === 'image') {
                selectedElement.style.borderColor = document.getElementById('image-border-color').value;
                saveToHistory();
            }
        }

        // Update image border radius
        function updateImageBorderRadius() {
            if (selectedElement && canvasElements.find(el => el.element === selectedElement)?.type === 'image') {
                const borderRadius = document.getElementById('image-border-radius').value;
                selectedElement.style.borderRadius = `${borderRadius}px`;
                borderRadiusValue.textContent = borderRadius;
                saveToHistory();
            }
        }

        // Update image filters (brightness, contrast)
        function updateImageFilters() {
            if (selectedElement && canvasElements.find(el => el.element === selectedElement)?.type === 'image') {
                const brightness = document.getElementById('image-brightness').value;
                const contrast = document.getElementById('image-contrast').value;

                selectedElement.style.filter = `brightness(${brightness}%) contrast(${contrast}%)`;

                brightnessValue.textContent = brightness;
                contrastValue.textContent = contrast;

                saveToHistory();
            }
        }

        // Update shape type
        function updateShapeType() {
            if (selectedElement && canvasElements.find(el => el.element === selectedElement)?.type === 'shape') {
                const shapeType = document.getElementById('shape-type').value;
                const elementData = canvasElements.find(el => el.element === selectedElement);

                if (elementData) {
                    elementData.shapeType = shapeType;

                    // Apply shape styles based on shape type
                    switch (shapeType) {
                        case 'rectangle':
                            selectedElement.style.borderRadius = '0';
                            selectedElement.style.clipPath = 'none';
                            break;
                        case 'circle':
                            selectedElement.style.borderRadius = '50%';
                            selectedElement.style.clipPath = 'none';
                            break;
                        case 'triangle':
                            selectedElement.style.borderRadius = '0';
                            selectedElement.style.clipPath = 'polygon(50% 0%, 0% 100%, 100% 100%)';
                            break;
                        case 'star':
                            selectedElement.style.borderRadius = '0';
                            selectedElement.style.clipPath = 'polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)';
                            break;
                        case 'hexagon':
                            selectedElement.style.borderRadius = '0';
                            selectedElement.style.clipPath = 'polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%)';
                            break;
                        case 'heart':
                            selectedElement.style.borderRadius = '0';
                            selectedElement.style.clipPath = 'path("M12,21.35L10.55,20.03C5.4,15.36 2,12.27 2,8.5C2,5.41 4.42,3 7.5,3C9.24,3 10.91,3.81 12,5.08C13.09,3.81 14.76,3 16.5,3C19.58,3 22,5.41 22,8.5C22,12.27 18.6,15.36 13.45,20.03L12,21.35Z")';
                            break;
                    }

                    saveToHistory();
                }
            }
        }

        // Update shape fill color
        function updateShapeFillColor() {
            if (selectedElement && canvasElements.find(el => el.element === selectedElement)?.type === 'shape') {
                selectedElement.style.backgroundColor = document.getElementById('shape-fill-color').value;
                saveToHistory();
            }
        }

        // Update shape border
        function updateShapeBorder() {
            if (selectedElement && canvasElements.find(el => el.element === selectedElement)?.type === 'shape') {
                const borderWidth = document.getElementById('shape-border-width').value;
                selectedElement.style.borderWidth = `${borderWidth}px`;
                selectedElement.style.borderStyle = borderWidth > 0 ? 'solid' : 'none';
                shapeBorderWidthValue.textContent = borderWidth;
                saveToHistory();
            }
        }

        // Update shape border color
        function updateShapeBorderColor() {
            if (selectedElement && canvasElements.find(el => el.element === selectedElement)?.type === 'shape') {
                selectedElement.style.borderColor = document.getElementById('shape-border-color').value;
                saveToHistory();
            }
        }

        // Update shape opacity
        function updateShapeOpacity() {
            if (selectedElement && canvasElements.find(el => el.element === selectedElement)?.type === 'shape') {
                const opacity = document.getElementById('shape-opacity').value;
                selectedElement.style.opacity = opacity / 100;
                shapeOpacityValue.textContent = opacity;
                saveToHistory();
            }
        }

        // Update shape border radius (for rectangle)
        function updateShapeBorderRadius() {
            if (selectedElement && canvasElements.find(el => el.element === selectedElement)?.type === 'shape') {
                const elementData = canvasElements.find(el => el.element === selectedElement);

                if (elementData && elementData.shapeType === 'rectangle') {
                    const borderRadius = document.getElementById('shape-border-radius').value;
                    selectedElement.style.borderRadius = `${borderRadius}px`;
                    shapeRadiusValue.textContent = borderRadius;
                    saveToHistory();
                }
            }
        }

        // Update background color
        function updateBackgroundColor() {
            canvas.style.backgroundColor = document.getElementById('bg-color').value;
            saveToHistory();
        }

        // Update background opacity
        function updateBackgroundOpacity() {
            const opacity = document.getElementById('bg-opacity').value;
            canvas.style.opacity = opacity / 100;
            bgOpacityValue.textContent = opacity;
            saveToHistory();
        }

        // Update background pattern
        function updateBackgroundPattern() {
            bgPattern = document.getElementById('bg-pattern').value;

            // Clear existing background pattern
            canvas.style.backgroundImage = canvas.style.backgroundImage.startsWith('url') ?
                canvas.style.backgroundImage : 'none';

            // Apply selected pattern
            switch (bgPattern) {
                case 'dots':
                    canvas.style.backgroundImage = 'radial-gradient(circle, #00000010 1px, transparent 1px)';
                    canvas.style.backgroundSize = '15px 15px';
                    break;
                case 'lines':
                    canvas.style.backgroundImage = 'linear-gradient(0deg, #00000010 1px, transparent 1px), linear-gradient(90deg, #00000010 1px, transparent 1px)';
                    canvas.style.backgroundSize = '20px 20px';
                    break;
                case 'grid':
                    canvas.style.backgroundImage = 'linear-gradient(#00000010 1px, transparent 1px), linear-gradient(90deg, #00000010 1px, transparent 1px)';
                    canvas.style.backgroundSize = '20px 20px';
                    break;
                case 'diagonal':
                    canvas.style.backgroundImage = 'repeating-linear-gradient(45deg, #00000010, #00000010 1px, transparent 1px, transparent 10px)';
                    canvas.style.backgroundSize = '20px 20px';
                    break;
                default:
                    // Do nothing as we've already cleared the pattern
                    break;
            }

            saveToHistory();
        }

        // Update background gradient
        function updateBackgroundGradient() {
            bgGradient = document.getElementById('bg-gradient').value;

            // Show/hide gradient colors
            gradientColorsDiv.style.display = bgGradient !== 'none' ? 'block' : 'none';

            // Get gradient colors
            const color1 = document.getElementById('gradient-color-1').value;
            const color2 = document.getElementById('gradient-color-2').value;

            // Clear existing gradient
            if (bgGradient === 'none') {
                // Preserve background image if it's a URL
                canvas.style.backgroundImage = canvas.style.backgroundImage.startsWith('url') ?
                    canvas.style.backgroundImage : (bgPattern !== 'none' ? canvas.style.backgroundImage : 'none');
            } else {
                // Apply selected gradient
                switch (bgGradient) {
                    case 'linear-vertical':
                        canvas.style.backgroundImage = `linear-gradient(to bottom, ${color1}, ${color2})`;
                        break;
                    case 'linear-horizontal':
                        canvas.style.backgroundImage = `linear-gradient(to right, ${color1}, ${color2})`;
                        break;
                    case 'radial':
                        canvas.style.backgroundImage = `radial-gradient(circle, ${color1}, ${color2})`;
                        break;
                }
            }

            saveToHistory();
        }

        // Update element width
        function updateElementWidth() {
            if (selectedElement) {
                const width = document.getElementById('element-width').value;
                selectedElement.style.width = `${width}px`;
                saveToHistory();
            }
        }

        // Update element height
        function updateElementHeight() {
            if (selectedElement) {
                const height = document.getElementById('element-height').value;
                selectedElement.style.height = `${height}px`;
                saveToHistory();
            }
        }

        // Update element X position
        function updateElementX() {
            if (selectedElement) {
                const x = document.getElementById('element-x').value;
                selectedElement.style.left = `${x}px`;
                saveToHistory();
            }
        }

        // Update element Y position
        function updateElementY() {
            if (selectedElement) {
                const y = document.getElementById('element-y').value;
                selectedElement.style.top = `${y}px`;
                saveToHistory();
            }
        }

        // Update element rotation
        function updateElementRotation() {
            if (selectedElement) {
                const rotation = document.getElementById('element-rotation').value;
                selectedElement.style.transform = `rotate(${rotation}deg)`;
                rotationValue.textContent = rotation;
                saveToHistory();
            }
        }

        // Align element (left, center, right, top, center, bottom)
        function alignElement(alignment) {
            if (!selectedElement) return;

            const canvasRect = canvas.getBoundingClientRect();
            const elementRect = selectedElement.getBoundingClientRect();

            const canvasWidth = canvas.offsetWidth;
            const canvasHeight = canvas.offsetHeight;

            let newLeft, newTop;

            switch (alignment) {
                case 'left':
                    newLeft = 0;
                    selectedElement.style.left = `${newLeft}px`;
                    break;
                case 'centerH':
                    newLeft = (canvasWidth - elementRect.width) / 2;
                    selectedElement.style.left = `${newLeft}px`;
                    break;
                case 'right':
                    newLeft = canvasWidth - elementRect.width;
                    selectedElement.style.left = `${newLeft}px`;
                    break;
                case 'top':
                    newTop = 0;
                    selectedElement.style.top = `${newTop}px`;
                    break;
                case 'centerV':
                    newTop = (canvasHeight - elementRect.height) / 2;
                    selectedElement.style.top = `${newTop}px`;
                    break;
                case 'bottom':
                    newTop = canvasHeight - elementRect.height;
                    selectedElement.style.top = `${newTop}px`;
                    break;
            }

            // Update position inputs
            if (alignment === 'left' || alignment === 'centerH' || alignment === 'right') {
                document.getElementById('element-x').value = Math.round(newLeft);
            } else {
                document.getElementById('element-y').value = Math.round(newTop);
            }

            saveToHistory();
        }

        // Update layers panel
        function updateLayersPanel() {
            // Clear current layers
            layersList.innerHTML = '';

            // Add layers in reverse order (top layer first)
            [...canvasElements].reverse().forEach(el => {
                const layerItem = document.createElement('div');
                layerItem.className = 'layer-item';
                if (el.element === selectedElement) {
                    layerItem.classList.add('selected');
                }
                layerItem.dataset.id = el.id;

                layerItem.innerHTML = `
                    <div class="layer-info">
                        <span class="material-symbols-rounded layer-icon">${getLayerIcon(el.type)}</span>
                        <span class="layer-name">${el.name}</span>
                    </div>
                    <div class="layer-actions">
                        <div class="layer-action layer-visibility" title="Toggle visibility">
                            <span class="material-symbols-rounded">visibility</span>
                        </div>
                        <div class="layer-action layer-lock" title="Lock layer">
                            <span class="material-symbols-rounded">lock_open</span>
                        </div>
                    </div>
                `;

                // Add click event to select layer
                layerItem.addEventListener('click', () => {
                    const element = document.getElementById(el.id);
                    if (element) {
                        selectElement(element);
                        updateLayersPanel();
                    }
                });

                // Add visibility toggle
                const visibilityBtn = layerItem.querySelector('.layer-visibility');
                visibilityBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const element = document.getElementById(el.id);
                    if (element) {
                        if (element.style.display === 'none') {
                            element.style.display = '';
                            visibilityBtn.querySelector('.material-symbols-rounded').textContent = 'visibility';
                        } else {
                            element.style.display = 'none';
                            visibilityBtn.querySelector('.material-symbols-rounded').textContent = 'visibility_off';
                        }
                        saveToHistory();
                    }
                });

                // Add lock toggle
                const lockBtn = layerItem.querySelector('.layer-lock');
                lockBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const element = document.getElementById(el.id);
                    if (element) {
                        if (element.classList.contains('locked')) {
                            element.classList.remove('locked');
                            lockBtn.querySelector('.material-symbols-rounded').textContent = 'lock_open';
                        } else {
                            element.classList.add('locked');
                            lockBtn.querySelector('.material-symbols-rounded').textContent = 'lock';
                        }
                        saveToHistory();
                    }
                });

                layersList.appendChild(layerItem);
            });
        }

        // Get icon for layer type
        function getLayerIcon(type) {
            switch (type) {
                case 'text':
                    return 'title';
                case 'image':
                    return 'image';
                case 'shape':
                    return 'crop_square';
                default:
                    return 'layers';
            }
        }

        // Duplicate selected layer
        function duplicateSelectedLayer() {
            if (selectedElement) {
                duplicateElement();
            }
        }

        // Delete selected layer
        function deleteSelectedLayer() {
            if (selectedElement) {
                deleteSelectedElement();
            }
        }

        // Move layer up (forward in z-index)
        function moveLayerUp() {
            if (!selectedElement) return;

            const index = canvasElements.findIndex(el => el.element === selectedElement);
            if (index < canvasElements.length - 1) {
                // Swap elements in array
                [canvasElements[index], canvasElements[index + 1]] = [canvasElements[index + 1], canvasElements[index]];

                // Move element forward in DOM
                canvas.insertBefore(canvasElements[index].element, canvasElements[index + 1].element);

                saveToHistory();
                updateLayersPanel();
            }
        }

        // Move layer down (backward in z-index)
        function moveLayerDown() {
            if (!selectedElement) return;

            const index = canvasElements.findIndex(el => el.element === selectedElement);
            if (index > 0) {
                // Swap elements in array
                [canvasElements[index], canvasElements[index - 1]] = [canvasElements[index - 1], canvasElements[index]];

                // Move element backward in DOM
                canvas.insertBefore(canvasElements[index].element, canvasElements[index - 1].element);

                saveToHistory();
                updateLayersPanel();
            }
        }

        // Copy selected element to clipboard
        function copyElement() {
            if (!selectedElement) return;

            const elementData = canvasElements.find(el => el.element === selectedElement);
            if (elementData) {
                // Store element data in clipboard
                clipboardElement = {
                    type: elementData.type,
                    html: selectedElement.outerHTML,
                    shapeType: elementData.shapeType
                };

                showToast('Element copied to clipboard', 'success');
            }
        }

        // Paste element from clipboard
        function pasteElement() {
            if (!clipboardElement) {
                showToast('Nothing to paste', 'info');
                return;
            }

            // Create temporary container to parse HTML
            const temp = document.createElement('div');
            temp.innerHTML = clipboardElement.html;

            // Get the element
            const newElement = temp.firstChild;

            // Generate new ID
            const newId = `${clipboardElement.type}-${Date.now()}`;
            newElement.id = newId;

            // Offset position slightly
            const left = parseInt(newElement.style.left) || 0;
            const top = parseInt(newElement.style.top) || 0;
            newElement.style.left = `${left + 20}px`;
            newElement.style.top = `${top + 20}px`;

            // Remove selection styling
            newElement.classList.remove('selected');
            const handles = newElement.querySelectorAll('.resize-handle, .rotate-handle');
            handles.forEach(handle => handle.remove());

            // Add to canvas
            canvas.appendChild(newElement);

            // Create element data
            const newElementData = {
                id: newId,
                type: clipboardElement.type,
                element: newElement,
                name: `${clipboardElement.type.charAt(0).toUpperCase() + clipboardElement.type.slice(1)} Element`
            };

            // Add shape type if it's a shape
            if (clipboardElement.type === 'shape') {
                newElementData.shapeType = clipboardElement.shapeType;
            }

            // Add to elements array
            canvasElements.push(newElementData);

            // Add event listeners
            if (clipboardElement.type === 'text') {
                newElement.addEventListener('dblclick', handleTextDoubleClick);
            }

            // Select the new element
            selectElement(newElement);

            // Save to history
            saveToHistory();

            // Update layers panel if visible
            if (document.getElementById('layers-properties').style.display === 'block') {
                updateLayersPanel();
            }

            showToast('Element pasted', 'success');
        }

        // Duplicate selected element
        function duplicateElement() {
            if (!selectedElement) return;

            // Use copy and paste to duplicate
            copyElement();
            pasteElement();
        }

        // Delete selected element
        function deleteSelectedElement() {
            if (!selectedElement) return;

            // Find element in array
            const index = canvasElements.findIndex(el => el.element === selectedElement);
            if (index !== -1) {
                // Remove from DOM
                selectedElement.remove();

                // Remove from array
                canvasElements.splice(index, 1);

                // Deselect
                selectedElement = null;

                // Save to history
                saveToHistory();

                // Update layers panel if visible
                if (document.getElementById('layers-properties').style.display === 'block') {
                    updateLayersPanel();
                }

                // Show default properties panel
                showPropertyPanel('background-properties');

                showToast('Element deleted', 'success');
            }
        }

        // Bring element one layer forward
        function bringElementForward() {
            if (!selectedElement) return;

            const index = canvasElements.findIndex(el => el.element === selectedElement);
            if (index < canvasElements.length - 1) {
                // Swap elements in array
                [canvasElements[index], canvasElements[index + 1]] = [canvasElements[index + 1], canvasElements[index]];

                // Move element forward in DOM
                canvas.insertBefore(canvasElements[index].element, canvasElements[index + 1].element);

                saveToHistory();

                // Update layers panel if visible
                if (document.getElementById('layers-properties').style.display === 'block') {
                    updateLayersPanel();
                }

                showToast('Moved element forward', 'success');
            }
        }

        // Send element one layer backward
        function sendElementBackward() {
            if (!selectedElement) return;

            const index = canvasElements.findIndex(el => el.element === selectedElement);
            if (index > 0) {
                // Swap elements in array
                [canvasElements[index], canvasElements[index - 1]] = [canvasElements[index - 1], canvasElements[index]];

                // Move element backward in DOM
                canvas.insertBefore(canvasElements[index].element, canvasElements[index - 1].element);

                saveToHistory();

                // Update layers panel if visible
                if (document.getElementById('layers-properties').style.display === 'block') {
                    updateLayersPanel();
                }

                showToast('Moved element backward', 'success');
            }
        }

        // Save current state to history
        function saveToHistory() {
            // Get the current canvas HTML
            const canvasHTML = canvas.innerHTML;
            const canvasStyle = {
                backgroundColor: canvas.style.backgroundColor,
                backgroundImage: canvas.style.backgroundImage,
                backgroundSize: canvas.style.backgroundSize,
                backgroundPosition: canvas.style.backgroundPosition,
                opacity: canvas.style.opacity
            };

            // If we're not at the end of the history array, truncate it
            if (historyIndex < historyStack.length - 1) {
                historyStack = historyStack.slice(0, historyIndex + 1);
            }

            // Add current state to history
            historyStack.push({
                canvasHTML,
                canvasStyle,
                elements: JSON.stringify(canvasElements.map(el => ({
                    id: el.id,
                    type: el.type,
                    name: el.name,
                    shapeType: el.shapeType
                })))
            });

            // Limit history size
            if (historyStack.length > 50) {
                historyStack.shift();
            }

            // Update history index
            historyIndex = historyStack.length - 1;

            // Update undo/redo buttons
            updateUndoRedoButtons();

            // Save to local storage
            saveToLocalStorage();
        }

        // Undo last action
        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                loadFromHistory(historyIndex);
                updateUndoRedoButtons();
            }
        }

        // Redo last undone action
        function redo() {
            if (historyIndex < historyStack.length - 1) {
                historyIndex++;
                loadFromHistory(historyIndex);
                updateUndoRedoButtons();
            }
        }

        // Load state from history
        function loadFromHistory(index) {
            const state = historyStack[index];
            if (!state) return;

            // Restore canvas HTML
            canvas.innerHTML = state.canvasHTML;

            // Restore canvas style
            canvas.style.backgroundColor = state.canvasStyle.backgroundColor;
            canvas.style.backgroundImage = state.canvasStyle.backgroundImage;
            canvas.style.backgroundSize = state.canvasStyle.backgroundSize;
            canvas.style.backgroundPosition = state.canvasStyle.backgroundPosition;
            canvas.style.opacity = state.canvasStyle.opacity;

            // Recreate elements array
            const savedElements = JSON.parse(state.elements);
            canvasElements = [];

            savedElements.forEach(savedEl => {
                const element = document.getElementById(savedEl.id);
                if (element) {
                    canvasElements.push({
                        id: savedEl.id,
                        type: savedEl.type,
                        element: element,
                        name: savedEl.name,
                        shapeType: savedEl.shapeType
                    });

                    // Reattach event listener for text elements
                    if (savedEl.type === 'text') {
                        element.addEventListener('dblclick', handleTextDoubleClick);
                    }
                }
            });

            // Deselect all elements
            selectedElement = null;
            showPropertyPanel('background-properties');

            // Update layers panel if visible
            if (document.getElementById('layers-properties').style.display === 'block') {
                updateLayersPanel();
            }
        }

        // Update undo/redo buttons state
        function updateUndoRedoButtons() {
            undoBtn.disabled = historyIndex <= 0;
            redoBtn.disabled = historyIndex >= historyStack.length - 1;
        }

        // Change zoom level
        function changeZoom(amount) {
            currentZoom = Math.max(10, Math.min(200, currentZoom + amount));
            zoomLevelEl.textContent = `${currentZoom}%`;

            canvas.style.transform = `scale(${currentZoom / 100})`;
        }

        // Load template
        function loadTemplate(templateId) {
            // Clear canvas
            canvas.innerHTML = '';
            canvasElements = [];

            // Set default background
            canvas.style.backgroundColor = '#ffffff';
            canvas.style.backgroundImage = 'none';

            // Add template elements based on templateId
            switch (templateId) {
                case 'template1': // Basic Event
                    // Background
                    canvas.style.backgroundColor = '#eef1ff';

                    // Title
                    addTextWithStyles('EVENT TITLE', 50, 100, {
                        fontSize: '48px',
                        fontWeight: 'bold',
                        color: '#4a6bff',
                        textAlign: 'center',
                        width: '500px',
                        left: '50px',
                        textTransform: 'uppercase',
                        letterSpacing: '2px'
                    });

                    // Date & Time
                    addTextWithStyles('SATURDAY, JUNE 15, 2024 • 6:00 PM', 50, 180, {
                        fontSize: '18px',
                        color: '#333333',
                        textAlign: 'center',
                        width: '500px',
                        fontWeight: '500'
                    });

                    // Location
                    addTextWithStyles('123 MAIN STREET, ANYTOWN', 50, 220, {
                        fontSize: '16px',
                        color: '#666666',
                        textAlign: 'center',
                        width: '500px'
                    });

                    // Description
                    addTextWithStyles('Join us for an amazing community event with food, music, and fun activities for the whole family. Don\'t miss out on this special occasion!', 100, 300, {
                        fontSize: '16px',
                        color: '#333333',
                        textAlign: 'center',
                        width: '400px',
                        lineHeight: '1.5'
                    });

                    // Add shape for decoration
                    addShapeWithStyles({
                        left: '150px',
                        top: '400px',
                        width: '300px',
                        height: '100px',
                        backgroundColor: '#4a6bff',
                        borderRadius: '8px'
                    });

                    // Add text over shape
                    addTextWithStyles('REGISTER NOW', 150, 440, {
                        fontSize: '24px',
                        color: '#ffffff',
                        textAlign: 'center',
                        width: '300px',
                        fontWeight: 'bold'
                    });

                    // Contact info
                    addTextWithStyles('For more information: info@example.com | (555) 123-4567', 100, 550, {
                        fontSize: '14px',
                        color: '#666666',
                        textAlign: 'center',
                        width: '400px'
                    });
                    break;

                case 'template2': // Concert
                    // Background
                    canvas.style.backgroundColor = '#000000';

                    // Title
                    addTextWithStyles('SUMMER CONCERT SERIES', 50, 100, {
                        fontSize: '42px',
                        fontWeight: 'bold',
                        color: '#ff5e7d',
                        textAlign: 'center',
                        width: '500px',
                        textTransform: 'uppercase',
                        letterSpacing: '3px'
                    });

                    // Band name
                    addTextWithStyles('THE MIDNIGHT ECHOES', 50, 180, {
                        fontSize: '32px',
                        color: '#ffffff',
                        textAlign: 'center',
                        width: '500px',
                        fontWeight: 'bold'
                    });

                    // With special guests
                    addTextWithStyles('with special guests', 50, 230, {
                        fontSize: '18px',
                        color: '#cccccc',
                        textAlign: 'center',
                        width: '500px',
                        fontStyle: 'italic'
                    });

                    // Supporting band
                    addTextWithStyles('COSMIC WAVES', 50, 260, {
                        fontSize: '22px',
                        color: '#ff5e7d',
                        textAlign: 'center',
                        width: '500px'
                    });

                    // Date & Time
                    addTextWithStyles('FRIDAY, JULY 20, 2024 • DOORS: 7PM • SHOW: 8PM', 50, 350, {
                        fontSize: '18px',
                        color: '#ffffff',
                        textAlign: 'center',
                        width: '500px',
                        letterSpacing: '1px'
                    });

                    // Venue
                    addTextWithStyles('STARLIGHT ARENA', 50, 390, {
                        fontSize: '24px',
                        color: '#ffffff',
                        textAlign: 'center',
                        width: '500px',
                        fontWeight: '500'
                    });

                    // Location
                    addTextWithStyles('789 MUSIC LANE, DOWNTOWN', 50, 430, {
                        fontSize: '16px',
                        color: '#cccccc',
                        textAlign: 'center',
                        width: '500px'
                    });

                    // Ticket info
                    addShapeWithStyles({
                        left: '150px',
                        top: '500px',
                        width: '300px',
                        height: '60px',
                        backgroundColor: '#ff5e7d',
                        borderRadius: '30px'
                    });

                    addTextWithStyles('TICKETS $25-45', 150, 530, {
                        fontSize: '22px',
                        color: '#ffffff',
                        textAlign: 'center',
                        width: '300px',
                        fontWeight: 'bold'
                    });

                    // Website
                    addTextWithStyles('WWW.CONCERTTICKETS.COM', 50, 600, {
                        fontSize: '18px',
                        color: '#ffffff',
                        textAlign: 'center',
                        width: '500px'
                    });
                    break;

                case 'template3': // Workshop
                    // Background
                    canvas.style.backgroundColor = '#fff9e6';

                    // Title
                    addTextWithStyles('CREATIVE WORKSHOP', 50, 80, {
                        fontSize: '44px',
                        fontWeight: 'bold',
                        color: '#ffbb38',
                        textAlign: 'center',
                        width: '500px',
                        fontFamily: "'Pacifico', cursive"
                    });

                    // Subtitle
                    addTextWithStyles('Learn. Create. Inspire.', 50, 150, {
                        fontSize: '22px',
                        color: '#333333',
                        textAlign: 'center',
                        width: '500px',
                        letterSpacing: '2px'
                    });

                    // Decoration line
                    addShapeWithStyles({
                        left: '200px',
                        top: '190px',
                        width: '200px',
                        height: '3px',
                        backgroundColor: '#ffbb38'
                    });

                    // Workshop details
                    addTextWithStyles('Join us for a hands-on workshop where you\'ll learn essential techniques from industry professionals. Perfect for beginners and experienced creators alike!', 100, 240, {
                        fontSize: '16px',
                        color: '#333333',
                        textAlign: 'center',
                        width: '400px',
                        lineHeight: '1.6'
                    });

                    // What you'll learn
                    addTextWithStyles('WHAT YOU\'LL LEARN:', 50, 340, {
                        fontSize: '18px',
                        color: '#333333',
                        textAlign: 'center',
                        width: '500px',
                        fontWeight: 'bold'
                    });

                    // Topics list
                    addTextWithStyles('• Fundamental techniques\n• Professional tools & materials\n• Creative problem solving\n• Industry best practices', 150, 380, {
                        fontSize: '16px',
                        color: '#333333',
                        textAlign: 'left',
                        width: '300px',
                        lineHeight: '1.8'
                    });

                    // Event details
                    addShapeWithStyles({
                        left: '100px',
                        top: '520px',
                        width: '400px',
                        height: '120px',
                        backgroundColor: '#ffbb38',
                        borderRadius: '8px'
                    });

                    addTextWithStyles('SATURDAY, AUGUST 10, 2024\n10:00 AM - 4:00 PM\nCREATIVE STUDIO\n456 WORKSHOP AVE, CRAFTTOWN', 100, 540, {
                        fontSize: '16px',
                        color: '#333333',
                        textAlign: 'center',
                        width: '400px',
                        fontWeight: '500',
                        lineHeight: '1.5'
                    });

                    // Registration
                    addTextWithStyles('REGISTER ONLINE: WWW.CREATIVEWORKSHOPS.COM\nFEE: $75 (MATERIALS INCLUDED)', 50, 680, {
                        fontSize: '16px',
                        color: '#333333',
                        textAlign: 'center',
                        width: '500px',
                        fontWeight: '500'
                    });
                    break;

                // Add more templates as needed...
                case 'template4': // Community
                    // Background
                    canvas.style.backgroundColor = '#e8f5e9';

                    // Title
                    addTextWithStyles('COMMUNITY CLEANUP DAY', 50, 100, {
                        fontSize: '40px',
                        fontWeight: 'bold',
                        color: '#4caf50',
                        textAlign: 'center',
                        width: '500px',
                        letterSpacing: '1px'
                    });

                    // Tagline
                    addTextWithStyles('Let\'s Work Together for a Cleaner Neighborhood', 50, 160, {
                        fontSize: '20px',
                        color: '#2e7d32',
                        textAlign: 'center',
                        width: '500px',
                        fontStyle: 'italic'
                    });

                    // Circle shape
                    addShapeWithStyles({
                        left: '250px',
                        top: '220px',
                        width: '100px',
                        height: '100px',
                        backgroundColor: '#4caf50',
                        borderRadius: '50%'
                    });

                    // Date
                    addTextWithStyles('SATURDAY\nJUNE 22\n2024', 250, 245, {
                        fontSize: '18px',
                        color: '#ffffff',
                        textAlign: 'center',
                        width: '100px',
                        fontWeight: 'bold',
                        lineHeight: '1.2'
                    });

                    // Details
                    addTextWithStyles('Join your neighbors for a day of community service. Help clean up parks, streets, and public spaces to make our community shine!', 100, 350, {
                        fontSize: '16px',
                        color: '#333333',
                        textAlign: 'center',
                        width: '400px',
                        lineHeight: '1.5'
                    });

                    // What to bring
                    addTextWithStyles('WHAT TO BRING:', 150, 430, {
                        fontSize: '18px',
                        color: '#2e7d32',
                        textAlign: 'left',
                        width: '300px',
                        fontWeight: 'bold'
                    });

                    addTextWithStyles('• Gloves\n• Water bottle\n• Sun protection\n• Comfortable clothes', 150, 460, {
                        fontSize: '16px',
                        color: '#333333',
                        textAlign: 'left',
                        width: '300px',
                        lineHeight: '1.5'
                    });

                    // Event details box
                    addShapeWithStyles({
                        left: '100px',
                        top: '560px',
                        width: '400px',
                        height: '80px',
                        backgroundColor: '#4caf50',
                        borderRadius: '8px'
                    });

                    addTextWithStyles('9:00 AM - 1:00 PM\nMEET AT CENTRAL PARK PAVILION\nLUNCH PROVIDED FOR VOLUNTEERS', 100, 575, {
                        fontSize: '16px',
                        color: '#ffffff',
                        textAlign: 'center',
                        width: '400px',
                        fontWeight: '500',
                        lineHeight: '1.4'
                    });

                    // Contact
                    addTextWithStyles('QUESTIONS? CONTACT: CLEANUP@COMMUNITY.ORG\nPHONE: (555) 987-6543', 100, 680, {
                        fontSize: '14px',
                        color: '#333333',
                        textAlign: 'center',
                        width: '400px'
                    });
                    break;

                default:
                    // Default empty template
                    break;
            }

            // Close template modal
            closeTemplatesModal();

            // Save to history
            saveToHistory();

            // Show toast
            showToast('Template loaded successfully', 'success');
        }

        // Helper function to add text element with specific styles
        function addTextWithStyles(content, left, top, styles) {
            const element = document.createElement('div');
            element.className = 'canvas-element text-element';
            element.innerHTML = content;
            element.style.position = 'absolute';
            element.style.left = `${left}px`;
            element.style.top = `${top}px`;
            element.style.fontFamily = "'Poppins', sans-serif";
            element.style.fontSize = '16px';
            element.style.color = '#000000';

            // Apply additional styles
            for (const [key, value] of Object.entries(styles)) {
                element.style[key] = value;
            }

            element.setAttribute('tabindex', '0');
            element.setAttribute('role', 'textbox');
            element.setAttribute('aria-label', 'Text element');

            canvas.appendChild(element);

            // Add element to the canvas elements array
            const newElement = {
                id: 'text-' + Date.now() + Math.floor(Math.random() * 1000),
                type: 'text',
                element: element,
                name: 'Text Element'
            };

            element.id = newElement.id;
            canvasElements.push(newElement);

            // Make text editable on double-click
            element.addEventListener('dblclick', handleTextDoubleClick);

            return element;
        }

        // Helper function to add shape element with specific styles
        function addShapeWithStyles(styles) {
            const element = document.createElement('div');
            element.className = 'canvas-element shape-element';
            element.style.position = 'absolute';
            element.style.width = '100px';
            element.style.height = '100px';
            element.style.backgroundColor = '#4a6bff';
            element.style.left = '50px';
            element.style.top = '50px';

            // Apply additional styles
            for (const [key, value] of Object.entries(styles)) {
                element.style[key] = value;
            }

            element.setAttribute('tabindex', '0');
            element.setAttribute('role', 'img');
            element.setAttribute('aria-label', 'Shape element');

            // 阻止事件冒泡，确保shape元素可以正确接收拖动事件
            element.addEventListener('mousedown', function (e) {
                e.stopPropagation();
            });

            canvas.appendChild(element);

            // Add element to the canvas elements array
            const newElement = {
                id: 'shape-' + Date.now() + Math.floor(Math.random() * 1000),
                type: 'shape',
                element: element,
                shapeType: 'rectangle',
                name: 'Shape Element'
            };

            element.id = newElement.id;
            canvasElements.push(newElement);

            return element;
        }

        // Show toast notification
        function showToast(message, type = 'success') {
            const toastEl = document.getElementById('toast');
            const toastIcon = toastEl.querySelector('.toast-icon');
            const toastMessage = toastEl.querySelector('.toast-message');

            // Set message and icon
            toastMessage.textContent = message;

            // Remove any existing classes
            toastEl.classList.remove('success', 'error', 'info');

            // Add the appropriate class based on the type
            toastEl.classList.add(type);

            // Set the appropriate icon
            switch (type) {
                case 'success':
                    toastIcon.textContent = 'check_circle';
                    break;
                case 'error':
                    toastIcon.textContent = 'error';
                    break;
                case 'info':
                    toastIcon.textContent = 'info';
                    break;
            }

            // Show the toast
            toastEl.classList.add('show');

            // Hide after 3 seconds
            setTimeout(() => {
                toastEl.classList.remove('show');
            }, 3000);
        }

        // Save design
        function saveDesign() {
            // Show loading overlay
            loadingOverlay.classList.add('show');

            // Save to local storage
            saveToLocalStorage();

            // Simulate saving delay
            setTimeout(() => {
                loadingOverlay.classList.remove('show');
                showToast('Design saved successfully', 'success');
            }, 1000);
        }

        // Save to local storage
        function saveToLocalStorage() {
            try {
                const designData = {
                    canvasHTML: canvas.innerHTML,
                    canvasStyle: {
                        backgroundColor: canvas.style.backgroundColor,
                        backgroundImage: canvas.style.backgroundImage,
                        backgroundSize: canvas.style.backgroundSize,
                        backgroundPosition: canvas.style.backgroundPosition,
                        opacity: canvas.style.opacity
                    },
                    elements: canvasElements.map(el => ({
                        id: el.id,
                        type: el.type,
                        name: el.name,
                        shapeType: el.shapeType
                    }))
                };

                localStorage.setItem('posterDesignData', JSON.stringify(designData));
            } catch (error) {
                console.error('Error saving to local storage:', error);
            }
        }

        // Try to load design from local storage
        function tryLoadFromLocalStorage() {
            try {
                const savedData = localStorage.getItem('posterDesignData');
                if (savedData) {
                    const designData = JSON.parse(savedData);

                    // Restore canvas HTML
                    canvas.innerHTML = designData.canvasHTML;

                    // Restore canvas style
                    if (designData.canvasStyle) {
                        canvas.style.backgroundColor = designData.canvasStyle.backgroundColor || '';
                        canvas.style.backgroundImage = designData.canvasStyle.backgroundImage || '';
                        canvas.style.backgroundSize = designData.canvasStyle.backgroundSize || '';
                        canvas.style.backgroundPosition = designData.canvasStyle.backgroundPosition || '';
                        canvas.style.opacity = designData.canvasStyle.opacity || '';
                    }

                    // Recreate elements array
                    canvasElements = [];

                    designData.elements.forEach(savedEl => {
                        const element = document.getElementById(savedEl.id);
                        if (element) {
                            canvasElements.push({
                                id: savedEl.id,
                                type: savedEl.type,
                                element: element,
                                name: savedEl.name,
                                shapeType: savedEl.shapeType
                            });

                            // Reattach event listener for text elements
                            if (savedEl.type === 'text') {
                                element.addEventListener('dblclick', handleTextDoubleClick);
                            }
                        }
                    });

                    // Save initial state to history
                    saveToHistory();

                    showToast('Design loaded from previous session', 'info');
                }
            } catch (error) {
                console.error('Error loading from local storage:', error);
            }
        }

        // Confirm new poster creation
        function confirmNewPoster() {
            showConfirmDialog('Are you sure you want to create a new poster? Any unsaved changes will be lost.', () => {
                // Clear canvas
                canvas.innerHTML = '';
                canvasElements = [];

                // Reset background
                canvas.style.backgroundColor = '#ffffff';
                canvas.style.backgroundImage = 'none';

                // Reset history
                historyStack = [];
                historyIndex = -1;
                saveToHistory();

                // Show default properties panel
                showPropertyPanel('background-properties');

                showToast('New poster created', 'success');
            });
        }

        // Download poster
        function downloadPoster() {
            // Show progress indicator
            downloadProgress.classList.add('show');

            // Simulate progress
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 10;
                progressBar.style.width = `${progress}%`;
                progressPercent.textContent = `${progress}%`;

                if (progress >= 100) {
                    clearInterval(progressInterval);

                    setTimeout(() => {
                        // Get export options
                        const format = document.querySelector('.export-option:hover')?.id.replace('export-', '') || 'png';
                        const quality = document.getElementById('export-quality').value / 10;
                        const scale = document.getElementById('export-scale').value;

                        // Create a clone of the canvas to render without selection handles
                        const tempCanvas = canvas.cloneNode(true);
                        tempCanvas.style.transform = 'none';

                        // Remove resize handles and selection styling
                        tempCanvas.querySelectorAll('.resize-handle, .rotate-handle').forEach(handle => handle.remove());
                        tempCanvas.querySelectorAll('.canvas-element').forEach(el => el.classList.remove('selected'));

                        // Use html2canvas to create an image (mock implementation)
                        const filename = `poster_design_${new Date().toISOString().slice(0, 10)}.${format}`;

                        // Show success message
                        showToast(`Poster downloaded as ${filename}`, 'success');

                        // Close export modal
                        closeExportModal();

                        // Hide progress indicator
                        downloadProgress.classList.remove('show');
                    }, 500);
                }
            }, 200);
        }

        // Handle keyboard shortcuts
        function handleKeyboardShortcuts(e) {
            // Skip if inside text input fields
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) {
                return;
            }

            if (e.ctrlKey) {
                switch (e.key) {
                    case 's':
                        e.preventDefault();
                        saveDesign();
                        break;
                    case 'z':
                        e.preventDefault();
                        undo();
                        break;
                    case 'y':
                        e.preventDefault();
                        redo();
                        break;
                    case 'c':
                        if (selectedElement) {
                            e.preventDefault();
                            copyElement();
                        }
                        break;
                    case 'v':
                        e.preventDefault();
                        pasteElement();
                        break;
                    case 'a':
                        e.preventDefault();
                        // Select all elements (not implemented)
                        break;
                    case 'e':
                        e.preventDefault();
                        openExportModal();
                        break;
                    case 'n':
                        e.preventDefault();
                        confirmNewPoster();
                        break;
                    case '+':
                    case '=':
                        e.preventDefault();
                        changeZoom(10);
                        break;
                    case '-':
                        e.preventDefault();
                        changeZoom(-10);
                        break;
                }
            } else {
                switch (e.key) {
                    case 'Delete':
                        if (selectedElement) {
                            e.preventDefault();
                            deleteSelectedElement();
                        }
                        break;
                    case 'Escape':
                        e.preventDefault();
                        deselectAllElements();
                        break;
                    case 't':
                        if (!e.ctrlKey && !e.altKey) {
                            e.preventDefault();
                            addTextElement();
                        }
                        break;
                    case 'i':
                        if (!e.ctrlKey && !e.altKey) {
                            e.preventDefault();
                            imageUploadInput.click();
                        }
                        break;
                    case 's':
                        if (!e.ctrlKey && !e.altKey) {
                            e.preventDefault();
                            addShapeElement();
                        }
                        break;
                }
            }
        }

        // Initialize the application
        init();

        // Show property panel
        function showPropertyPanel(panelId) {
            // Hide all property panels
            document.getElementById('text-properties').style.display = 'none';
            document.getElementById('image-properties').style.display = 'none';
            document.getElementById('shape-properties').style.display = 'none';
            document.getElementById('background-properties').style.display = 'none';
            document.getElementById('layers-properties').style.display = 'none';

            // Show no selection message if no panel is specified
            document.getElementById('no-selection-message').style.display =
                panelId ? 'none' : 'block';

            // Show the specified panel
            if (panelId) {
                document.getElementById(panelId).style.display = 'block';
            }
        }

        // Update text properties panel
        function updateTextPropertiesPanel(element) {
            // ... existing code ...
        }
    </script>
</body>

</html>