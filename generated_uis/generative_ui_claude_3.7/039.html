<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Survey Data Analyzer</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <style>
        :root {
            --primary: #4361ee;
            --primary-light: #6c8aff;
            --primary-dark: #0039cb;
            --secondary: #3a0ca3;
            --accent: #f72585;
            --success: #4caf50;
            --warning: #ff9800;
            --error: #f44336;
            --text-primary: #212121;
            --text-secondary: #757575;
            --background: #f5f7fa;
            --card-bg: #ffffff;
            --border: #e0e0e0;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            display: grid;
            grid-template-columns: 300px 1fr;
            grid-template-rows: auto 1fr auto;
            grid-template-areas:
                "header header"
                "sidebar main"
                "footer footer";
            height: 100vh;
            width: 100%;
        }

        header {
            grid-area: header;
            background-color: var(--card-bg);
            padding: 1rem 2rem;
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 700;
            font-size: 1.5rem;
            color: var(--primary);
        }

        .logo .material-icons {
            font-size: 2rem;
        }

        .sidebar {
            grid-area: sidebar;
            background-color: var(--card-bg);
            border-right: 1px solid var(--border);
            padding: 1.5rem;
            overflow-y: auto;
        }

        .main {
            grid-area: main;
            padding: 1.5rem;
            overflow-y: auto;
        }

        .footer {
            grid-area: footer;
            background-color: var(--card-bg);
            border-top: 1px solid var(--border);
            padding: 1rem 2rem;
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 500;
            margin-bottom: 1rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .upload-area {
            border: 2px dashed var(--border);
            border-radius: 8px;
            padding: 2rem;
            text-align: center;
            transition: var(--transition);
            cursor: pointer;
            margin-bottom: 1rem;
        }

        .upload-area:hover,
        .upload-area.dragover {
            border-color: var(--primary);
            background-color: rgba(67, 97, 238, 0.05);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .upload-text {
            margin-bottom: 1rem;
            color: var(--text-secondary);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            border: none;
            font-size: 0.875rem;
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: transparent;
            color: var(--primary);
            border: 1px solid var(--primary);
        }

        .btn-secondary:hover {
            background-color: rgba(67, 97, 238, 0.05);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-success:hover {
            background-color: #388e3c;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .form-control {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 0.875rem;
            transition: var(--transition);
        }

        .form-control:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 2px rgba(67, 97, 238, 0.2);
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            font-size: 0.875rem;
        }

        .data-table th,
        .data-table td {
            padding: 0.75rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .data-table th {
            font-weight: 500;
            background-color: #f5f5f5;
        }

        .data-table tbody tr:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: 1.5rem;
        }

        .stat-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 1.5rem;
            background-color: var(--card-bg);
            border-radius: 8px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .filter-section {
            margin-bottom: 1.5rem;
        }

        .filter-title {
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .filter-content {
            margin-top: 0.5rem;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .range-slider {
            width: 100%;
            margin: 0.5rem 0;
        }

        .range-values {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .tab-container {
            margin-bottom: 1.5rem;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            margin-bottom: 1rem;
        }

        .tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            transition: var(--transition);
            border-bottom: 2px solid transparent;
        }

        .tab.active {
            border-bottom-color: var(--primary);
            color: var(--primary);
            font-weight: 500;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            width: 100vw;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 1000;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(67, 97, 238, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .floating-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            opacity: 0;
            transform: translateY(-10px);
            transition: var(--transition);
            pointer-events: none;
            z-index: 100;
        }

        .floating-controls.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        .control-group {
            margin: 10px 0;
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
            z-index: 1000;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-areas:
                    "header"
                    "main"
                    "footer";
            }

            .sidebar {
                position: fixed;
                left: -300px;
                top: 0;
                height: 100%;
                z-index: 1000;
                transition: var(--transition);
            }

            .sidebar.open {
                left: 0;
            }

            .sidebar-toggle {
                display: block;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="logo">
                <span class="material-icons">analytics</span>
                <span>Survey Analyzer</span>
            </div>
            <button class="btn btn-secondary sidebar-toggle" id="sidebarToggle">
                <span class="material-icons">menu</span>
            </button>
        </header>

        <aside class="sidebar" id="sidebar">
            <div class="card">
                <div class="card-title">
                    <span class="material-icons">filter_alt</span>
                    <span>Filters</span>
                </div>
                <div id="filterContainer" class="hidden">
                    <div class="filter-section">
                        <div class="filter-title">
                            <span>Date Range</span>
                        </div>
                        <div class="filter-content">
                            <div class="form-group">
                                <label class="form-label" for="startDate">Start Date</label>
                                <input type="date" id="startDate" class="form-control">
                            </div>
                            <div class="form-group">
                                <label class="form-label" for="endDate">End Date</label>
                                <input type="date" id="endDate" class="form-control">
                            </div>
                        </div>
                    </div>

                    <div class="filter-section">
                        <div class="filter-title">
                            <span>Categories</span>
                        </div>
                        <div class="filter-content">
                            <div class="checkbox-group" id="categoryFilters">
                                <!-- Categories will be dynamically populated -->
                            </div>
                        </div>
                    </div>

                    <div class="filter-section">
                        <div class="filter-title">
                            <span>Rating Range</span>
                        </div>
                        <div class="filter-content">
                            <input type="range" min="1" max="5" step="1" value="1" class="range-slider" id="minRating">
                            <div class="range-values">
                                <span>Min: <span id="minRatingValue">1</span></span>
                                <span>Max: 5</span>
                            </div>
                        </div>
                    </div>

                    <button class="btn btn-primary" id="applyFilters">
                        <span class="material-icons">check</span>
                        Apply Filters
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="card-title">
                    <span class="material-icons">bar_chart</span>
                    <span>Visualization</span>
                </div>
                <div id="visualizationOptions" class="hidden">
                    <div class="form-group">
                        <label class="form-label" for="chartType">Chart Type</label>
                        <select id="chartType" class="form-control">
                            <option value="bar">Bar Chart</option>
                            <option value="pie">Pie Chart</option>
                            <option value="line">Line Chart</option>
                            <option value="radar">Radar Chart</option>
                            <option value="doughnut">Doughnut Chart</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="xAxis">X-Axis</label>
                        <select id="xAxis" class="form-control">
                            <!-- Options will be dynamically populated -->
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="yAxis">Y-Axis/Measure</label>
                        <select id="yAxis" class="form-control">
                            <option value="count">Count</option>
                            <option value="average">Average</option>
                            <option value="sum">Sum</option>
                        </select>
                    </div>

                    <button class="btn btn-primary" id="generateVisualization">
                        <span class="material-icons">auto_graph</span>
                        Generate Chart
                    </button>
                </div>
            </div>
        </aside>

        <main class="main">
            <div class="card" id="uploadCard">
                <div class="card-title">
                    <span class="material-icons">cloud_upload</span>
                    <span>Upload Survey Data</span>
                </div>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">
                        <span class="material-icons">upload_file</span>
                    </div>
                    <div class="upload-text">
                        <p>Drag and drop your CSV or Excel file here</p>
                        <p>or</p>
                    </div>
                    <button class="btn btn-primary" id="browseFiles">
                        <span class="material-icons">folder_open</span>
                        Browse Files
                    </button>
                    <input type="file" id="fileInput" accept=".csv,.xlsx,.xls" style="display: none;">
                </div>

                <div class="form-group">
                    <label class="form-label" for="pasteData">Or paste your data:</label>
                    <textarea id="pasteData" class="form-control" placeholder="Paste CSV data here..."></textarea>
                </div>

                <div class="form-group">
                    <button class="btn btn-success" id="analyzeData">
                        <span class="material-icons">analytics</span>
                        Analyze Data
                    </button>
                </div>
            </div>

            <div id="dataPreview" class="card hidden">
                <div class="card-title">
                    <span class="material-icons">table_view</span>
                    <span>Data Preview</span>
                </div>
                <div class="table-responsive">
                    <table class="data-table" id="previewTable">
                        <thead>
                            <tr id="tableHeader">
                                <!-- Headers will be dynamically populated -->
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- Data rows will be dynamically populated -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="analysisResults" class="hidden">
                <div class="stats-grid" id="summaryStats">
                    <!-- Summary statistics will be dynamically populated -->
                </div>

                <div class="card">
                    <div class="tab-container">
                        <div class="tabs">
                            <div class="tab active" data-tab="overview">Overview</div>
                            <div class="tab" data-tab="trends">Trends</div>
                            <div class="tab" data-tab="comparisons">Comparisons</div>
                        </div>

                        <div class="tab-content active" id="overview">
                            <div class="chart-container">
                                <canvas id="overviewChart"></canvas>
                                <div class="floating-controls" id="overviewControls">
                                    <div class="control-group">
                                        <label>Chart Type</label>
                                        <select id="overviewChartType">
                                            <option value="bar">Bar</option>
                                            <option value="pie">Pie</option>
                                            <option value="doughnut">Doughnut</option>
                                        </select>
                                    </div>
                                    <div class="control-group">
                                        <label>Color Scheme</label>
                                        <select id="overviewColorScheme">
                                            <option value="default">Default</option>
                                            <option value="pastel">Pastel</option>
                                            <option value="vibrant">Vibrant</option>
                                        </select>
                                    </div>
                                    <div class="control-group">
                                        <button class="btn btn-secondary" id="exportOverviewChart">
                                            <span class="material-icons">download</span>
                                            Export
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-content" id="trends">
                            <div class="chart-container">
                                <canvas id="trendsChart"></canvas>
                                <div class="floating-controls" id="trendsControls">
                                    <div class="control-group">
                                        <label>Time Period</label>
                                        <select id="trendsPeriod">
                                            <option value="daily">Daily</option>
                                            <option value="weekly">Weekly</option>
                                            <option value="monthly">Monthly</option>
                                        </select>
                                    </div>
                                    <div class="control-group">
                                        <label>Line Style</label>
                                        <select id="trendsLineStyle">
                                            <option value="solid">Solid</option>
                                            <option value="dashed">Dashed</option>
                                            <option value="dotted">Dotted</option>
                                        </select>
                                    </div>
                                    <div class="control-group">
                                        <button class="btn btn-secondary" id="exportTrendsChart">
                                            <span class="material-icons">download</span>
                                            Export
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="tab-content" id="comparisons">
                            <div class="chart-container">
                                <canvas id="comparisonsChart"></canvas>
                                <div class="floating-controls" id="comparisonsControls">
                                    <div class="control-group">
                                        <label>Group By</label>
                                        <select id="comparisonsGroupBy">
                                            <option value="category">Category</option>
                                            <option value="rating">Rating</option>
                                            <option value="date">Date</option>
                                        </select>
                                    </div>
                                    <div class="control-group">
                                        <label>Chart Type</label>
                                        <select id="comparisonsChartType">
                                            <option value="bar">Bar</option>
                                            <option value="radar">Radar</option>
                                            <option value="polarArea">Polar Area</option>
                                        </select>
                                    </div>
                                    <div class="control-group">
                                        <button class="btn btn-secondary" id="exportComparisonsChart">
                                            <span class="material-icons">download</span>
                                            Export
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">
                        <span class="material-icons">insights</span>
                        <span>Key Insights</span>
                    </div>
                    <div id="insightsContainer">
                        <!-- Insights will be dynamically populated -->
                    </div>
                </div>

                <div class="form-group">
                    <button class="btn btn-primary" id="exportResults">
                        <span class="material-icons">download</span>
                        Export Results
                    </button>
                </div>
            </div>
        </main>

        <footer class="footer">
            <p>© 2023 Survey Analyzer | All data is processed locally in your browser</p>
        </footer>
    </div>

    <div id="tooltip" class="tooltip"></div>

    <div id="loadingIndicator" class="loading hidden">
        <div class="spinner"></div>
    </div>

    <script>
        // DOM Elements
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const browseFiles = document.getElementById('browseFiles');
        const pasteData = document.getElementById('pasteData');
        const analyzeData = document.getElementById('analyzeData');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const dataPreview = document.getElementById('dataPreview');
        const tableHeader = document.getElementById('tableHeader');
        const tableBody = document.getElementById('tableBody');
        const analysisResults = document.getElementById('analysisResults');
        const summaryStats = document.getElementById('summaryStats');
        const insightsContainer = document.getElementById('insightsContainer');
        const filterContainer = document.getElementById('filterContainer');
        const visualizationOptions = document.getElementById('visualizationOptions');
        const categoryFilters = document.getElementById('categoryFilters');
        const minRating = document.getElementById('minRating');
        const minRatingValue = document.getElementById('minRatingValue');
        const applyFilters = document.getElementById('applyFilters');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');
        const xAxis = document.getElementById('xAxis');
        const generateVisualization = document.getElementById('generateVisualization');
        const exportResults = document.getElementById('exportResults');
        const tooltip = document.getElementById('tooltip');

        // Chart instances
        let overviewChart = null;
        let trendsChart = null;
        let comparisonsChart = null;

        // Data storage
        let surveyData = [];
        let headers = [];
        let filteredData = [];

        // Color schemes
        const colorSchemes = {
            default: ['#4361ee', '#3a0ca3', '#7209b7', '#f72585', '#4cc9f0', '#4895ef', '#560bad', '#b5179e'],
            pastel: ['#ffd6ff', '#e7c6ff', '#c8b6ff', '#b8c0ff', '#bbd0ff', '#a0c4ff', '#9bf6ff', '#caffbf'],
            vibrant: ['#ff595e', '#ffca3a', '#8ac926', '#1982c4', '#6a4c93', '#f15bb5', '#00bbf9', '#00f5d4']
        };

        // Initialize the app
        function init() {
            setupEventListeners();
            setupTabNavigation();
            setupChartControls();

            // Load Chart.js from CDN
            loadChartJs().then(() => {
                console.log('Chart.js loaded successfully');
            }).catch(error => {
                console.error('Failed to load Chart.js:', error);
            });
        }

        // Load Chart.js from CDN
        function loadChartJs() {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // Set up event listeners
        function setupEventListeners() {
            // File upload events
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');

                if (e.dataTransfer.files.length) {
                    fileInput.files = e.dataTransfer.files;
                    handleFileUpload(e.dataTransfer.files[0]);
                }
            });

            browseFiles.addEventListener('click', () => {
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length) {
                    handleFileUpload(e.target.files[0]);
                }
            });

            // Analyze button event
            analyzeData.addEventListener('click', () => {
                const pastedData = pasteData.value.trim();
                if (pastedData) {
                    handlePastedData(pastedData);
                } else if (fileInput.files.length) {
                    handleFileUpload(fileInput.files[0]);
                } else {
                    alert('Please upload a file or paste data to analyze.');
                }
            });

            // Filter events
            minRating.addEventListener('input', () => {
                minRatingValue.textContent = minRating.value;
            });

            applyFilters.addEventListener('click', applyDataFilters);

            // Sidebar toggle for mobile
            sidebarToggle.addEventListener('click', () => {
                sidebar.classList.toggle('open');
            });

            // Generate visualization button
            generateVisualization.addEventListener('click', generateCustomVisualization);

            // Export results button
            exportResults.addEventListener('click', exportAnalysisResults);
        }

        // Set up tab navigation
        function setupTabNavigation() {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');

                    // Update active tab
                    tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');

                    // Update active content
                    tabContents.forEach(content => {
                        content.classList.remove('active');
                        if (content.id === tabId) {
                            content.classList.add('active');
                        }
                    });
                });
            });
        }

        // Set up chart controls
        function setupChartControls() {
            const chartContainers = document.querySelectorAll('.chart-container');

            chartContainers.forEach(container => {
                const canvas = container.querySelector('canvas');
                const controls = container.querySelector('.floating-controls');

                canvas.addEventListener('click', () => {
                    document.querySelectorAll('.floating-controls').forEach(c => {
                        c.classList.remove('active');
                    });
                    controls.classList.toggle('active');
                });
            });

            // Close controls when clicking outside
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.floating-controls') && !e.target.closest('canvas')) {
                    document.querySelectorAll('.floating-controls').forEach(c => {
                        c.classList.remove('active');
                    });
                }
            });

            // Overview chart controls
            document.getElementById('overviewChartType').addEventListener('change', updateOverviewChart);
            document.getElementById('overviewColorScheme').addEventListener('change', updateOverviewChart);
            document.getElementById('exportOverviewChart').addEventListener('click', () => exportChart(overviewChart, 'overview-chart'));

            // Trends chart controls
            document.getElementById('trendsPeriod').addEventListener('change', updateTrendsChart);
            document.getElementById('trendsLineStyle').addEventListener('change', updateTrendsChart);
            document.getElementById('exportTrendsChart').addEventListener('click', () => exportChart(trendsChart, 'trends-chart'));

            // Comparisons chart controls
            document.getElementById('comparisonsGroupBy').addEventListener('change', updateComparisonsChart);
            document.getElementById('comparisonsChartType').addEventListener('change', updateComparisonsChart);
            document.getElementById('exportComparisonsChart').addEventListener('click', () => exportChart(comparisonsChart, 'comparisons-chart'));
        }

        // Handle file upload
        function handleFileUpload(file) {
            showLoading(true);

            try {
                // Check file type and parse accordingly
                if (file.name.endsWith('.csv')) {
                    parseCSVFile(file);
                } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    alert('Excel file support will be added soon. Please use CSV format for now.');
                    showLoading(false);
                } else {
                    alert('Unsupported file format. Please upload a CSV or Excel file.');
                    showLoading(false);
                }
            } catch (error) {
                console.error('Error processing file:', error);
                alert('Error processing file: ' + error.message);
                showLoading(false);
            }
        }

        // Parse CSV file
        function parseCSVFile(file) {
            const reader = new FileReader();

            reader.onload = function (e) {
                try {
                    const csvData = e.target.result;
                    const parsedData = parseCSV(csvData);
                    processData(parsedData);
                    showLoading(false);
                } catch (error) {
                    console.error('Error parsing CSV:', error);
                    alert('Error parsing CSV: ' + error.message);
                    showLoading(false);
                }
            };

            reader.onerror = function () {
                console.error('Error reading file');
                alert('Error reading file');
                showLoading(false);
            };

            reader.readAsText(file);
        }

        // Basic CSV parser
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const result = [];

            // Extract headers
            const headers = lines[0].split(',').map(header => header.trim());

            // Parse data rows
            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (line) {
                    const values = line.split(',');
                    const obj = {};

                    for (let j = 0; j < headers.length; j++) {
                        obj[headers[j]] = values[j] ? values[j].trim() : '';
                    }

                    result.push(obj);
                }
            }

            return result;
        }

        // Handle pasted data
        function handlePastedData(data) {
            showLoading(true);

            try {
                const parsedData = parseCSV(data);
                processData(parsedData);
                showLoading(false);
            } catch (error) {
                console.error('Error parsing pasted data:', error);
                alert('Error parsing pasted data: ' + error.message);
                showLoading(false);

                // Fallback to mock data for demo purposes
                const mockData = generateMockData();
                processData(mockData);
                showLoading(false);
            }
        }

        // Process the data
        function processData(data) {
            if (!data || data.length === 0) {
                alert('No data to process. Please check your file or pasted content.');
                showLoading(false);
                return;
            }

            surveyData = data;
            headers = Object.keys(data[0]);
            filteredData = [...surveyData];

            // Display data preview
            displayDataPreview();

            // Show filter options
            populateFilterOptions();
            filterContainer.classList.remove('hidden');

            // Show visualization options
            populateVisualizationOptions();
            visualizationOptions.classList.remove('hidden');

            // Generate analysis
            generateAnalysis();
        }

        // Display data preview
        function displayDataPreview() {
            // Clear existing content
            tableHeader.innerHTML = '';
            tableBody.innerHTML = '';

            // Add headers
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                tableHeader.appendChild(th);
            });

            // Add data rows (limit to 10 for preview)
            const previewData = surveyData.slice(0, 10);
            previewData.forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = row[header];
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });

            // Show the data preview
            dataPreview.classList.remove('hidden');
        }

        // Populate filter options
        function populateFilterOptions() {
            // Clear existing content
            categoryFilters.innerHTML = '';

            // Find the category field - assume it's called 'Category' or similar
            let categoryField = headers.find(h => h.toLowerCase().includes('category')) || headers[0];

            // Get unique categories
            const categories = [...new Set(surveyData.map(item => item[categoryField]))];

            // Add category checkboxes
            categories.forEach(category => {
                if (!category) return;

                const div = document.createElement('div');
                div.className = 'checkbox-item';

                const input = document.createElement('input');
                input.type = 'checkbox';
                input.id = `category-${category}`;
                input.value = category;
                input.checked = true;

                const label = document.createElement('label');
                label.htmlFor = `category-${category}`;
                label.textContent = category;

                div.appendChild(input);
                div.appendChild(label);
                categoryFilters.appendChild(div);
            });
        }

        // Populate visualization options
        function populateVisualizationOptions() {
            // Clear existing content
            xAxis.innerHTML = '';

            // Add options for each header
            headers.forEach(header => {
                const option = document.createElement('option');
                option.value = header;
                option.textContent = header;
                xAxis.appendChild(option);
            });
        }

        // Apply data filters
        function applyDataFilters() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const minRatingValue = parseInt(minRating.value);

            // Find the date and rating fields
            const dateField = headers.find(h => h.toLowerCase().includes('date')) || 'Date';
            const ratingField = headers.find(h => h.toLowerCase().includes('rating')) || 'Rating';
            const categoryField = headers.find(h => h.toLowerCase().includes('category')) || 'Category';

            // Get selected categories
            const selectedCategories = Array.from(document.querySelectorAll('#categoryFilters input:checked'))
                .map(input => input.value);

            // Filter the data
            filteredData = surveyData.filter(item => {
                // Filter by category
                if (selectedCategories.length > 0 && !selectedCategories.includes(item[categoryField])) {
                    return false;
                }

                // Filter by rating
                if (ratingField in item && parseInt(item[ratingField]) < minRatingValue) {
                    return false;
                }

                // Filter by date (if applicable)
                if (startDate && dateField in item && item[dateField] && new Date(item[dateField]) < new Date(startDate)) {
                    return false;
                }

                if (endDate && dateField in item && item[dateField] && new Date(item[dateField]) > new Date(endDate)) {
                    return false;
                }

                return true;
            });

            // Regenerate analysis with filtered data
            generateAnalysis();
        }

        // Generate analysis
        function generateAnalysis() {
            // Generate summary statistics
            generateSummaryStats();

            // Generate charts
            generateOverviewChart();
            generateTrendsChart();
            generateComparisonsChart();

            // Generate insights
            generateInsights();

            // Show analysis results
            analysisResults.classList.remove('hidden');
        }

        // Generate summary statistics
        function generateSummaryStats() {
            // Clear existing content
            summaryStats.innerHTML = '';

            // Total responses
            addStatCard('Total Responses', filteredData.length);

            // Find rating field
            const ratingField = headers.find(h => h.toLowerCase().includes('rating')) || 'Rating';

            // Average rating (if rating field exists)
            if (ratingField in filteredData[0]) {
                const validRatings = filteredData.filter(item => !isNaN(parseInt(item[ratingField])));
                if (validRatings.length > 0) {
                    const avgRating = validRatings.reduce((sum, item) => sum + parseInt(item[ratingField]), 0) / validRatings.length;
                    addStatCard('Average Rating', avgRating.toFixed(1));
                }
            }

            // Response rate (based on data completeness)
            const completeness = calculateDataCompleteness(filteredData, headers);
            addStatCard('Data Completeness', `${completeness.toFixed(0)}%`);

            // Most common category
            const categoryField = headers.find(h => h.toLowerCase().includes('category')) || 'Category';
            if (categoryField in filteredData[0]) {
                const categoryCounts = {};
                filteredData.forEach(item => {
                    const category = item[categoryField];
                    categoryCounts[category] = (categoryCounts[category] || 0) + 1;
                });

                let mostCommonCategory = '';
                let highestCount = 0;

                for (const category in categoryCounts) {
                    if (categoryCounts[category] > highestCount) {
                        highestCount = categoryCounts[category];
                        mostCommonCategory = category;
                    }
                }

                addStatCard('Most Common Category', mostCommonCategory);
            }
        }

        // Calculate data completeness
        function calculateDataCompleteness(data, fields) {
            let totalCells = data.length * fields.length;
            let filledCells = 0;

            data.forEach(item => {
                fields.forEach(field => {
                    if (item[field] && item[field].trim() !== '') {
                        filledCells++;
                    }
                });
            });

            return (filledCells / totalCells) * 100;
        }

        // Add a stat card
        function addStatCard(label, value) {
            const div = document.createElement('div');
            div.className = 'stat-card';

            const valueEl = document.createElement('div');
            valueEl.className = 'stat-value';
            valueEl.textContent = value;

            const labelEl = document.createElement('div');
            labelEl.className = 'stat-label';
            labelEl.textContent = label;

            div.appendChild(valueEl);
            div.appendChild(labelEl);
            summaryStats.appendChild(div);
        }

        // Generate overview chart
        function generateOverviewChart() {
            const ctx = document.getElementById('overviewChart').getContext('2d');

            // Find the category field
            const categoryField = headers.find(h => h.toLowerCase().includes('category')) || headers[0];

            // Count responses by category
            const categories = [...new Set(filteredData.map(item => item[categoryField]))];
            const counts = categories.map(category =>
                filteredData.filter(item => item[categoryField] === category).length
            );

            // Create chart configuration
            const config = {
                type: 'bar',
                data: {
                    labels: categories,
                    datasets: [{
                        label: 'Responses by Category',
                        data: counts,
                        backgroundColor: colorSchemes.default,
                        borderColor: 'rgba(0, 0, 0, 0.1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return `${context.label}: ${context.raw} responses`;
                                }
                            }
                        }
                    }
                }
            };

            // Create or update chart
            if (overviewChart) {
                overviewChart.destroy();
            }

            try {
                overviewChart = new Chart(ctx, config);
            } catch (error) {
                console.error('Error generating overview chart:', error);
                ctx.font = '14px Arial';
                ctx.fillText('Error generating chart. Please check console for details.', 10, 30);
            }
        }

        // Update overview chart based on controls
        function updateOverviewChart() {
            if (!overviewChart) return;

            const chartType = document.getElementById('overviewChartType').value;
            const colorScheme = document.getElementById('overviewColorScheme').value;

            overviewChart.config.type = chartType;
            overviewChart.data.datasets[0].backgroundColor = colorSchemes[colorScheme];

            overviewChart.update();
        }

        // Generate trends chart
        function generateTrendsChart() {
            const ctx = document.getElementById('trendsChart').getContext('2d');

            // Find date and rating fields
            const dateField = headers.find(h => h.toLowerCase().includes('date')) || 'Date';
            const ratingField = headers.find(h => h.toLowerCase().includes('rating')) || 'Rating';

            let dates = [];
            let ratings = [];
            let responses = [];

            // Check if we have date and rating fields
            if (dateField in filteredData[0] && ratingField in filteredData[0]) {
                // Group data by date
                const dateGroups = {};

                filteredData.forEach(item => {
                    if (!item[dateField]) return;

                    const date = new Date(item[dateField]);
                    const dateStr = date.toISOString().split('T')[0];

                    if (!dateGroups[dateStr]) {
                        dateGroups[dateStr] = {
                            count: 0,
                            totalRating: 0
                        };
                    }

                    if (!isNaN(parseInt(item[ratingField]))) {
                        dateGroups[dateStr].count++;
                        dateGroups[dateStr].totalRating += parseInt(item[ratingField]);
                    }
                });

                // Sort dates and calculate average ratings
                dates = Object.keys(dateGroups).sort();

                dates.forEach(date => {
                    const group = dateGroups[date];
                    if (group.count > 0) {
                        ratings.push(group.totalRating / group.count);
                        responses.push(group.count);
                    } else {
                        ratings.push(0);
                        responses.push(0);
                    }
                });

                // Format dates for display (e.g., 'Jan 1')
                dates = dates.map(date => {
                    const d = new Date(date);
                    return d.toLocaleDateString(undefined, { month: 'short', day: 'numeric' });
                });
            } else {
                // Use mock data if required fields are not present
                dates = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
                ratings = [4.2, 4.3, 4.1, 4.4, 4.5, 4.6];
                responses = [42, 45, 50, 48, 52, 60];
            }

            // Create chart configuration
            const config = {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Average Rating',
                            data: ratings,
                            borderColor: colorSchemes.default[0],
                            backgroundColor: 'rgba(67, 97, 238, 0.1)',
                            yAxisID: 'y',
                            tension: 0.3
                        },
                        {
                            label: 'Number of Responses',
                            data: responses,
                            borderColor: colorSchemes.default[1],
                            backgroundColor: 'rgba(58, 12, 163, 0.1)',
                            yAxisID: 'y1',
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Average Rating'
                            },
                            min: 0,
                            max: 5
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Number of Responses'
                            },
                            grid: {
                                drawOnChartArea: false
                            }
                        }
                    }
                }
            };

            // Create or update chart
            if (trendsChart) {
                trendsChart.destroy();
            }

            try {
                trendsChart = new Chart(ctx, config);
            } catch (error) {
                console.error('Error generating trends chart:', error);
                ctx.font = '14px Arial';
                ctx.fillText('Error generating chart. Please check console for details.', 10, 30);
            }
        }

        // Update trends chart based on controls
        function updateTrendsChart() {
            if (!trendsChart) return;

            const period = document.getElementById('trendsPeriod').value;
            const lineStyle = document.getElementById('trendsLineStyle').value;

            // Update line style
            let borderDash = [];
            if (lineStyle === 'dashed') {
                borderDash = [5, 5];
            } else if (lineStyle === 'dotted') {
                borderDash = [2, 2];
            }

            trendsChart.data.datasets[0].borderDash = borderDash;
            trendsChart.data.datasets[1].borderDash = borderDash;

            // Change date grouping based on period (would need more implementation in real app)

            trendsChart.update();
        }

        // Generate comparisons chart
        function generateComparisonsChart() {
            const ctx = document.getElementById('comparisonsChart').getContext('2d');

            // Find rating field
            const ratingField = headers.find(h => h.toLowerCase().includes('rating')) || 'Rating';

            let labels = [];
            let counts = [];

            // Check if rating field exists
            if (ratingField in filteredData[0]) {
                // Group data by rating
                const ratingCounts = {};

                filteredData.forEach(item => {
                    if (!item[ratingField] || isNaN(parseInt(item[ratingField]))) return;

                    const rating = parseInt(item[ratingField]);
                    ratingCounts[rating] = (ratingCounts[rating] || 0) + 1;
                });

                // Sort ratings and get counts
                const sortedRatings = Object.keys(ratingCounts)
                    .map(Number)
                    .sort((a, b) => a - b);

                labels = sortedRatings.map(rating => `${rating} Star${rating !== 1 ? 's' : ''}`);
                counts = sortedRatings.map(rating => ratingCounts[rating]);
            } else {
                // Use mock data if rating field is not present
                labels = ['1 Star', '2 Stars', '3 Stars', '4 Stars', '5 Stars'];
                counts = [5, 10, 15, 30, 40];
            }

            // Create chart configuration
            const config = {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Responses by Rating',
                        data: counts,
                        backgroundColor: colorSchemes.default,
                        borderColor: 'rgba(0, 0, 0, 0.1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Responses'
                            }
                        }
                    }
                }
            };

            // Create or update chart
            if (comparisonsChart) {
                comparisonsChart.destroy();
            }

            try {
                comparisonsChart = new Chart(ctx, config);
            } catch (error) {
                console.error('Error generating comparisons chart:', error);
                ctx.font = '14px Arial';
                ctx.fillText('Error generating chart. Please check console for details.', 10, 30);
            }
        }

        // Update comparisons chart based on controls
        function updateComparisonsChart() {
            if (!comparisonsChart) return;

            const chartType = document.getElementById('comparisonsChartType').value;
            comparisonsChart.config.type = chartType;

            // Adjust options based on chart type
            if (chartType === 'radar') {
                comparisonsChart.options.scales = {};
            } else {
                comparisonsChart.options.scales = {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Number of Responses'
                        }
                    }
                };
            }

            comparisonsChart.update();
        }

        // Generate custom visualization
        function generateCustomVisualization() {
            const chartType = document.getElementById('chartType').value;
            const xAxisField = document.getElementById('xAxis').value;
            const yAxisMeasure = document.getElementById('yAxis').value;

            // Show a toast or notification
            alert(`Custom visualization generated with: 
                Chart Type: ${chartType}
                X-Axis: ${xAxisField}
                Y-Axis Measure: ${yAxisMeasure}`);

            // In a real implementation, this would create a custom chart based on user selections
            // For this demo, we'll simply update one of the existing charts

            // Get unique values for the selected x-axis field
            const xValues = [...new Set(filteredData.map(item => item[xAxisField]))];

            // Calculate y-values based on the selected measure
            let yValues = [];

            if (yAxisMeasure === 'count') {
                yValues = xValues.map(x =>
                    filteredData.filter(item => item[xAxisField] === x).length
                );
            } else if (yAxisMeasure === 'average') {
                // Find a numeric field to average
                const numericField = headers.find(h => {
                    const sample = filteredData[0][h];
                    return !isNaN(parseFloat(sample));
                }) || headers[0];

                yValues = xValues.map(x => {
                    const items = filteredData.filter(item => item[xAxisField] === x);
                    const validItems = items.filter(item => !isNaN(parseFloat(item[numericField])));
                    if (validItems.length === 0) return 0;

                    const sum = validItems.reduce((total, item) => total + parseFloat(item[numericField]), 0);
                    return sum / validItems.length;
                });
            } else if (yAxisMeasure === 'sum') {
                // Find a numeric field to sum
                const numericField = headers.find(h => {
                    const sample = filteredData[0][h];
                    return !isNaN(parseFloat(sample));
                }) || headers[0];

                yValues = xValues.map(x => {
                    const items = filteredData.filter(item => item[xAxisField] === x);
                    return items.reduce((total, item) => {
                        const value = parseFloat(item[numericField]);
                        return total + (isNaN(value) ? 0 : value);
                    }, 0);
                });
            }

            // Update the overview chart with the custom visualization
            overviewChart.config.type = chartType;
            overviewChart.data.labels = xValues;
            overviewChart.data.datasets[0].data = yValues;
            overviewChart.data.datasets[0].label = `${yAxisMeasure} by ${xAxisField}`;

            overviewChart.update();
        }

        // Generate insights
        function generateInsights() {
            // Clear existing content
            insightsContainer.innerHTML = '';

            // Find rating and category fields
            const ratingField = headers.find(h => h.toLowerCase().includes('rating')) || 'Rating';
            const categoryField = headers.find(h => h.toLowerCase().includes('category')) || 'Category';

            // Insight 1: Average rating
            if (ratingField in filteredData[0]) {
                const validRatings = filteredData.filter(item => !isNaN(parseInt(item[ratingField])));
                if (validRatings.length > 0) {
                    const avgRating = validRatings.reduce((sum, item) => sum + parseInt(item[ratingField]), 0) / validRatings.length;
                    addInsight(`Average rating across all responses is ${avgRating.toFixed(1)} out of 5`);
                }
            }

            // Insight 2: Most common rating
            if (ratingField in filteredData[0]) {
                const ratingCounts = {};
                filteredData.forEach(item => {
                    if (!item[ratingField] || isNaN(parseInt(item[ratingField]))) return;

                    const rating = parseInt(item[ratingField]);
                    ratingCounts[rating] = (ratingCounts[rating] || 0) + 1;
                });

                let mostCommonRating = 0;
                let highestCount = 0;

                for (const rating in ratingCounts) {
                    if (ratingCounts[rating] > highestCount) {
                        highestCount = ratingCounts[rating];
                        mostCommonRating = rating;
                    }
                }

                if (mostCommonRating > 0) {
                    const percentage = (highestCount / filteredData.length * 100).toFixed(0);
                    addInsight(`Most common rating is ${mostCommonRating} stars (${percentage}% of responses)`);
                }
            }

            // Insight 3: Top rated category
            if (categoryField in filteredData[0] && ratingField in filteredData[0]) {
                const categoryRatings = {};
                const categoryCounts = {};

                filteredData.forEach(item => {
                    if (!item[categoryField] || !item[ratingField] || isNaN(parseInt(item[ratingField]))) return;

                    const category = item[categoryField];
                    const rating = parseInt(item[ratingField]);

                    if (!categoryRatings[category]) {
                        categoryRatings[category] = 0;
                        categoryCounts[category] = 0;
                    }

                    categoryRatings[category] += rating;
                    categoryCounts[category]++;
                });

                let topCategory = '';
                let highestAvg = 0;

                for (const category in categoryRatings) {
                    const avg = categoryRatings[category] / categoryCounts[category];
                    if (avg > highestAvg) {
                        highestAvg = avg;
                        topCategory = category;
                    }
                }

                if (topCategory) {
                    addInsight(`Highest rated category is "${topCategory}" with an average rating of ${highestAvg.toFixed(1)}`);
                }
            }

            // Insight 4: Data distribution
            const totalResponses = filteredData.length;
            if (totalResponses > 0) {
                addInsight(`Analysis based on ${totalResponses} responses${surveyData.length !== totalResponses ? ' (filtered from ' + surveyData.length + ' total)' : ''}`);
            }
        }

        // Add an insight
        function addInsight(text) {
            const p = document.createElement('p');
            p.innerHTML = `<span class="material-icons" style="color: var(--primary); vertical-align: middle; margin-right: 8px;">lightbulb</span> ${text}`;
            p.style.marginBottom = '0.75rem';
            insightsContainer.appendChild(p);
        }

        // Export chart as image
        function exportChart(chart, filename) {
            if (!chart) {
                alert('No chart to export');
                return;
            }

            try {
                const link = document.createElement('a');
                link.download = `${filename}.png`;
                link.href = chart.toBase64Image();
                link.click();
            } catch (error) {
                console.error('Error exporting chart:', error);
                alert('Error exporting chart: ' + error.message);
            }
        }

        // Export analysis results
        function exportAnalysisResults() {
            // Create a text representation of the data
            let content = 'Survey Analysis Results\n\n';

            // Add summary stats
            content += 'Summary Statistics:\n';
            document.querySelectorAll('.stat-card').forEach(card => {
                const label = card.querySelector('.stat-label').textContent;
                const value = card.querySelector('.stat-value').textContent;
                content += `${label}: ${value}\n`;
            });

            content += '\nInsights:\n';
            document.querySelectorAll('#insightsContainer p').forEach(p => {
                content += `- ${p.textContent.trim()}\n`;
            });

            content += '\nData Preview:\n';
            content += headers.join(',') + '\n';
            filteredData.slice(0, 10).forEach(row => {
                content += headers.map(h => row[h]).join(',') + '\n';
            });

            // Create and download file
            const blob = new Blob([content], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.download = 'survey-analysis.csv';
            link.href = url;
            link.click();
        }

        // Show or hide loading indicator
        function showLoading(show) {
            if (show) {
                loadingIndicator.classList.remove('hidden');
            } else {
                loadingIndicator.classList.add('hidden');
            }
        }

        // Generate mock data for demonstration
        function generateMockData() {
            const categories = ['Product', 'Service', 'Support', 'Website', 'App'];
            const data = [];

            for (let i = 0; i < 100; i++) {
                const date = new Date(2023, Math.floor(Math.random() * 6), Math.floor(Math.random() * 28) + 1);
                data.push({
                    ID: i + 1,
                    Date: date.toISOString().split('T')[0],
                    Category: categories[Math.floor(Math.random() * categories.length)],
                    Rating: Math.floor(Math.random() * 5) + 1,
                    Comment: `Sample comment ${i + 1}`,
                    Email: `customer${i + 1}@example.com`
                });
            }

            return data;
        }

        // Initialize the app
        document.addEventListener('DOMContentLoaded', () => {
            loadingIndicator.classList.add('hidden');
            init();
        });
    </script>
</body>

</html>