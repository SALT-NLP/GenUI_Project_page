<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quantum Physics Explorer</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/core-js/3.27.1/minified.min.js" crossorigin="anonymous"
        referrerpolicy="no-referrer"></script>
    <script>
        // Fallback for ES6 polyfill if CDN fails
        (function () {
            var script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/core-js-bundle@3.27.1/minified.min.js';
            script.onerror = function () {
                console.warn('CDN polyfill failed to load, falling back to MathJax without polyfill');
            };
            document.head.appendChild(script);
        })();
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        :root {
            --primary-color: #3f51b5;
            --primary-light: #757de8;
            --primary-dark: #002984;
            --secondary-color: #7e57c2;
            --secondary-light: #b085f5;
            --secondary-dark: #4d2c91;
            --text-color: #333;
            --text-light: #666;
            --text-dark: #111;
            --background-color: #f9f9ff;
            --card-color: #fff;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --error-color: #f44336;
            --border-radius: 8px;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.15);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--background-color);
            padding: 0;
            margin: 0;
        }

        .container {
            display: grid;
            grid-template-columns: 250px 1fr;
            grid-template-rows: auto 1fr;
            grid-template-areas:
                "header header"
                "sidebar main";
            min-height: 100vh;
        }

        header {
            grid-area: header;
            background-color: var(--primary-color);
            color: white;
            padding: 1rem 2rem;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
            font-weight: 500;
            transition: var(--transition);
        }

        .logo:hover {
            transform: scale(1.05);
        }

        .logo .material-symbols-rounded {
            font-size: 2rem;
        }

        nav ul {
            display: flex;
            list-style: none;
            gap: 1.5rem;
        }

        nav a {
            color: white;
            text-decoration: none;
            padding: 0.5rem 0;
            position: relative;
            font-weight: 500;
            transition: var(--transition);
        }

        nav a:after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: 0;
            left: 0;
            background-color: white;
            transition: var(--transition);
        }

        nav a:hover:after {
            width: 100%;
        }

        nav a.active:after {
            width: 100%;
        }

        .theme-toggle {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            transition: var(--transition);
        }

        .theme-toggle:hover {
            transform: rotate(30deg);
        }

        .sidebar {
            grid-area: sidebar;
            background-color: var(--card-color);
            box-shadow: var(--shadow);
            padding: 1.5rem 0;
            overflow-y: auto;
            transition: var(--transition);
        }

        .sidebar-title {
            padding: 0 1.5rem;
            margin-bottom: 1rem;
            font-weight: 500;
            color: var(--primary-dark);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-title .material-symbols-rounded {
            font-size: 1.2rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .sidebar-title .material-symbols-rounded:hover {
            color: var(--primary-color);
        }

        .sidebar-nav {
            list-style: none;
        }

        .sidebar-nav-item {
            margin-bottom: 0.5rem;
        }

        .sidebar-nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1.5rem;
            color: var(--text-color);
            text-decoration: none;
            transition: var(--transition);
            border-left: 3px solid transparent;
        }

        .sidebar-nav-link .material-symbols-rounded {
            margin-right: 0.5rem;
            font-size: 1.2rem;
        }

        .sidebar-nav-link:hover {
            background-color: rgba(0, 0, 0, 0.05);
            border-left-color: var(--primary-light);
        }

        .sidebar-nav-link.active {
            background-color: rgba(63, 81, 181, 0.1);
            border-left-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 500;
        }

        .sidebar-subnav {
            list-style: none;
            padding-left: 1.5rem;
            max-height: 0;
            overflow: hidden;
            transition: var(--transition);
        }

        .sidebar-nav-item.open .sidebar-subnav {
            max-height: 500px;
        }

        .sidebar-subnav-link {
            display: flex;
            align-items: center;
            padding: 0.5rem 1.5rem;
            color: var(--text-light);
            text-decoration: none;
            transition: var(--transition);
            font-size: 0.9rem;
            width: 100%;
        }

        .sidebar-subnav-link:before {
            content: '';
            display: inline-block;
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background-color: var(--text-light);
            margin-right: 0.5rem;
            transition: var(--transition);
        }

        .sidebar-subnav-link:hover {
            color: var(--primary-color);
        }

        .sidebar-subnav-link:hover:before {
            background-color: var(--primary-color);
        }

        .sidebar-subnav-link.active {
            color: var(--primary-color);
            font-weight: 500;
        }

        .sidebar-subnav-link.active:before {
            background-color: var(--primary-color);
        }

        .progress-indicator {
            display: inline-block;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            margin-left: auto;
            position: relative;
            border: 2px solid var(--text-light);
            flex-shrink: 0;
        }

        .progress-indicator.completed {
            border-color: var(--success-color);
            background-color: var(--success-color);
        }

        .progress-indicator.completed:after {
            content: "✓";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 0.7rem;
        }

        .progress-indicator.in-progress {
            border-color: var(--primary-color);
            border-top-color: transparent;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        main {
            grid-area: main;
            padding: 2rem;
            overflow-y: auto;
        }

        .page-title {
            margin-bottom: 2rem;
            color: var(--primary-dark);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .page-title .material-symbols-rounded {
            font-size: 2rem;
            color: var(--primary-color);
        }

        .breadcrumb {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: var(--text-light);
        }

        .breadcrumb a {
            color: var(--primary-color);
            text-decoration: none;
            transition: var(--transition);
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        .breadcrumb .separator {
            margin: 0 0.5rem;
        }

        .card {
            background-color: var(--card-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 2rem;
            transition: var(--transition);
        }

        .card:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }

        .card-title {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--primary-color);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .card-title .material-symbols-rounded {
            font-size: 1.5rem;
        }

        .card-content {
            margin-bottom: 1.5rem;
        }

        .card-content p {
            margin-bottom: 1rem;
        }

        .card-content ul {
            margin-bottom: 1rem;
            padding-left: 1.5rem;
        }

        .card-content li {
            margin-bottom: 0.5rem;
        }

        .card-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .concept-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .concept-card {
            background-color: var(--card-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        .concept-card:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }

        .concept-card:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background-color: var(--primary-color);
            transition: var(--transition);
        }

        .concept-card:hover:before {
            background-color: var(--secondary-color);
        }

        .concept-card-title {
            font-size: 1.25rem;
            margin-bottom: 0.75rem;
            color: var(--primary-color);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .concept-card-title .material-symbols-rounded {
            font-size: 1.25rem;
        }

        .concept-card-content {
            flex-grow: 1;
        }

        .concept-card-link {
            display: inline-flex;
            align-items: center;
            margin-top: 1rem;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            transition: var(--transition);
        }

        .concept-card-link:hover {
            color: var(--primary-dark);
        }

        .concept-card-link .material-symbols-rounded {
            font-size: 1.2rem;
            margin-left: 0.25rem;
            transition: var(--transition);
        }

        .concept-card-link:hover .material-symbols-rounded {
            transform: translateX(3px);
        }

        .simulation-container {
            background-color: var(--card-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 2rem;
            transition: var(--transition);
        }

        .simulation-container:hover {
            box-shadow: var(--shadow-hover);
        }

        .simulation-title {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: var(--primary-color);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .simulation-title .material-symbols-rounded {
            font-size: 1.25rem;
        }

        .simulation-description {
            margin-bottom: 1rem;
        }

        .simulation-canvas {
            width: 100%;
            height: 300px;
            background-color: #f1f1f1;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            transition: var(--transition);
        }

        .simulation-controls {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            padding: 0.5rem 1rem;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn:hover {
            background-color: var(--primary-dark);
        }

        .btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.3);
        }

        .btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .btn .material-symbols-rounded {
            font-size: 1.2rem;
        }

        .btn-secondary {
            background-color: var(--secondary-color);
        }

        .btn-secondary:hover {
            background-color: var(--secondary-dark);
        }

        .btn-success {
            background-color: var(--success-color);
        }

        .btn-success:hover {
            background-color: #3d8b40;
        }

        .btn-warning {
            background-color: var(--warning-color);
        }

        .btn-warning:hover {
            background-color: #e68900;
        }

        .btn-error {
            background-color: var(--error-color);
        }

        .btn-error:hover {
            background-color: #d32f2f;
        }

        .slider-container {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            flex-grow: 1;
            min-width: 200px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .slider-value {
            background-color: rgba(0, 0, 0, 0.05);
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 500;
            min-width: 40px;
            text-align: center;
        }

        .slider {
            width: 100%;
            height: 6px;
            background-color: #ddd;
            border-radius: 3px;
            appearance: none;
            outline: none;
            cursor: pointer;
        }

        .slider::-webkit-slider-thumb {
            appearance: none;
            width: 18px;
            height: 18px;
            background-color: var(--primary-color);
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition);
        }

        .slider::-webkit-slider-thumb:hover {
            background-color: var(--primary-dark);
            transform: scale(1.1);
        }

        .slider::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background-color: var(--primary-color);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            transition: var(--transition);
        }

        .slider::-moz-range-thumb:hover {
            background-color: var(--primary-dark);
            transform: scale(1.1);
        }

        .equation {
            background-color: rgba(0, 0, 0, 0.05);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin: 1rem 0;
            overflow-x: auto;
            text-align: center;
            position: relative;
        }

        .equation-label {
            position: absolute;
            right: 10px;
            top: 5px;
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .glossary-container {
            background-color: var(--card-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            transition: var(--transition);
        }

        .glossary-container:hover {
            box-shadow: var(--shadow-hover);
        }

        .glossary-title {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            color: var(--primary-color);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .glossary-title .material-symbols-rounded {
            font-size: 1.5rem;
        }

        .glossary-search {
            margin-bottom: 1.5rem;
            position: relative;
        }

        .glossary-search input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
        }

        .glossary-search input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.2);
        }

        .glossary-search .material-symbols-rounded {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-light);
        }

        .glossary-list {
            list-style: none;
        }

        .glossary-item {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            transition: var(--transition);
        }

        .glossary-item:hover {
            background-color: rgba(0, 0, 0, 0.01);
        }

        .glossary-term {
            font-weight: 500;
            color: var(--primary-dark);
            margin-bottom: 0.25rem;
            display: block;
            font-size: 1.1rem;
        }

        .glossary-definition {
            color: var(--text-light);
        }

        .highlighted-term {
            color: var(--primary-color);
            font-weight: 500;
            cursor: pointer;
            position: relative;
            border-bottom: 1px dotted var(--primary-color);
            transition: var(--transition);
        }

        .highlighted-term:hover {
            color: var(--primary-dark);
        }

        .tooltip {
            position: absolute;
            background-color: var(--card-color);
            box-shadow: var(--shadow);
            border-radius: var(--border-radius);
            padding: 0.75rem;
            width: 250px;
            z-index: 100;
            font-weight: normal;
            color: var(--text-color);
            font-size: 0.9rem;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 0.5rem;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
            border-left: 3px solid var(--primary-color);
        }

        .highlighted-term:hover .tooltip {
            opacity: 1;
            visibility: visible;
        }

        .tooltip:after {
            content: '';
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -8px;
            border-width: 8px;
            border-style: solid;
            border-color: var(--card-color) transparent transparent transparent;
        }

        .tabs {
            display: flex;
            margin-bottom: 1rem;
            border-bottom: 1px solid #ddd;
        }

        .tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: var(--transition);
            font-weight: 500;
            color: var(--text-light);
        }

        .tab:hover {
            color: var(--primary-color);
        }

        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .modal.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--card-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(-20px);
            transition: var(--transition);
        }

        .modal.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 500;
            color: var(--primary-color);
        }

        .modal-close {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.5rem;
            color: var(--text-light);
            transition: var(--transition);
        }

        .modal-close:hover {
            color: var(--error-color);
        }

        .modal-body {
            margin-bottom: 1.5rem;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .progress-bar-container {
            width: 100%;
            height: 6px;
            background-color: #ddd;
            border-radius: 3px;
            margin: 1rem 0;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--primary-color);
            border-radius: 3px;
            transition: width 0.3s ease;
        }

        .quiz-container {
            background-color: var(--card-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .quiz-question {
            margin-bottom: 1.5rem;
        }

        .quiz-options {
            list-style: none;
            margin-bottom: 1.5rem;
        }

        .quiz-option {
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: var(--transition);
        }

        .quiz-option:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }

        .quiz-option.selected {
            border-color: var(--primary-color);
            background-color: rgba(63, 81, 181, 0.1);
        }

        .quiz-option.correct {
            border-color: var(--success-color);
            background-color: rgba(76, 175, 80, 0.1);
        }

        .quiz-option.incorrect {
            border-color: var(--error-color);
            background-color: rgba(244, 67, 54, 0.1);
        }

        .quiz-feedback {
            margin-bottom: 1.5rem;
            padding: 1rem;
            border-radius: var(--border-radius);
            display: none;
        }

        .quiz-feedback.correct {
            background-color: rgba(76, 175, 80, 0.1);
            color: var(--success-color);
            display: block;
        }

        .quiz-feedback.incorrect {
            background-color: rgba(244, 67, 54, 0.1);
            color: var(--error-color);
            display: block;
        }

        .notes-container {
            background-color: var(--card-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .notes-title {
            font-size: 1.25rem;
            margin-bottom: 1rem;
            color: var(--primary-color);
            font-weight: 500;
        }

        .notes-textarea {
            width: 100%;
            min-height: 150px;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            font-family: 'Roboto', sans-serif;
            resize: vertical;
            transition: var(--transition);
        }

        .notes-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(63, 81, 181, 0.2);
        }

        .notes-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-areas:
                    "header"
                    "main";
            }

            .sidebar {
                display: none;
                position: fixed;
                top: 60px;
                left: 0;
                width: 250px;
                height: calc(100vh - 60px);
                z-index: 99;
            }

            .sidebar.active {
                display: block;
            }

            .menu-toggle {
                display: block;
                background: none;
                border: none;
                color: white;
                font-size: 1.5rem;
                cursor: pointer;
            }

            .concept-grid {
                grid-template-columns: 1fr;
            }

            .simulation-controls {
                flex-direction: column;
            }

            .slider-container {
                width: 100%;
            }
        }

        /* Dark Theme Styles */
        body.dark-theme {
            --primary-color: #5c6bc0;
            --primary-light: #8e99f3;
            --primary-dark: #26418f;
            --secondary-color: #9575cd;
            --secondary-light: #c7a4ff;
            --secondary-dark: #65499c;
            --text-color: #e0e0e0;
            --text-light: #b0b0b0;
            --text-dark: #f5f5f5;
            --background-color: #121212;
            --card-color: #1e1e1e;
            --success-color: #66bb6a;
            --warning-color: #ffa726;
            --error-color: #ef5350;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.4);
            --shadow-hover: 0 4px 12px rgba(0, 0, 0, 0.6);
        }

        body.dark-theme .equation {
            background-color: rgba(255, 255, 255, 0.05);
        }

        body.dark-theme .simulation-canvas {
            background-color: #2a2a2a;
        }

        body.dark-theme .slider {
            background-color: #444;
        }

        body.dark-theme .glossary-search input,
        body.dark-theme .notes-textarea,
        body.dark-theme .quiz-option {
            background-color: #2a2a2a;
            border-color: #444;
            color: var(--text-color);
        }

        body.dark-theme .glossary-search input:focus,
        body.dark-theme .notes-textarea:focus {
            border-color: var(--primary-color);
        }

        body.dark-theme .progress-bar-container {
            background-color: #444;
        }

        body.dark-theme .tooltip {
            background-color: #2a2a2a;
        }

        body.dark-theme .tooltip:after {
            border-color: #2a2a2a transparent transparent transparent;
        }

        body.dark-theme .quiz-option:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        body.dark-theme .quiz-option.selected {
            background-color: rgba(92, 107, 192, 0.2);
        }

        body.dark-theme .quiz-option.correct {
            background-color: rgba(102, 187, 106, 0.2);
        }

        body.dark-theme .quiz-option.incorrect {
            background-color: rgba(239, 83, 80, 0.2);
        }

        body.dark-theme .quiz-feedback.correct {
            background-color: rgba(102, 187, 106, 0.2);
        }

        body.dark-theme .quiz-feedback.incorrect {
            background-color: rgba(239, 83, 80, 0.2);
        }

        body.dark-theme .tabs {
            border-bottom-color: #444;
        }

        /* Styles for sub-tabs */
        .sub-tabs-container {
            width: 100%;
            margin-bottom: 1.5rem;
            /* Space before content area */
        }

        .sub-tabs {
            display: flex;
            margin-bottom: 1rem;
            /* Space between sub-tabs and their content */
            border-bottom: 1px solid #ddd;
            /* Similar to main tabs */
        }

        .sub-tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: var(--transition);
            font-weight: 500;
            color: var(--text-light);
            font-size: 0.9rem;
            /* Slightly smaller than main tabs */
        }

        .sub-tab:hover {
            color: var(--primary-color);
        }

        .sub-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .sub-tab-content-area {
            /* This area will be populated by JS; specific styling might be added later */
            padding: 0;
            /* No padding here, content cards will have their own */
        }

        /* Dark theme for sub-tabs */
        body.dark-theme .sub-tabs {
            border-bottom-color: #444;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="logo">
                <span class="material-symbols-rounded">science</span>
                <span>Quantum Physics Explorer</span>
            </div>
            <nav>
                <ul>
                    <li><a href="#" class="active">Home</a></li>
                    <li><a href="#">Concepts</a></li>
                    <li><a href="#">Simulations</a></li>
                    <li><a href="#">Glossary</a></li>
                </ul>
            </nav>
            <button class="theme-toggle" aria-label="Toggle dark mode">
                <span class="material-symbols-rounded">dark_mode</span>
            </button>
        </header>

        <aside class="sidebar">
            <h3 class="sidebar-title">
                Learning Path
                <span class="material-symbols-rounded" id="collapseAll">unfold_less</span>
            </h3>
            <ul class="sidebar-nav">
                <li class="sidebar-nav-item open">
                    <a href="#" class="sidebar-nav-link active">
                        <span class="material-symbols-rounded">school</span>
                        Introduction to Quantum Physics
                    </a>
                    <ul class="sidebar-subnav">
                        <li><a href="#" class="sidebar-subnav-link active" data-topic-id="what-is-quantum-physics">What
                                is Quantum Physics?<span class="progress-indicator completed"></span></a></li>
                        <li><a href="#" class="sidebar-subnav-link" data-topic-id="historical-development">Historical
                                Development<span class="progress-indicator"></span></a></li>
                        <li><a href="#" class="sidebar-subnav-link" data-topic-id="key-differences">Key Differences from
                                Classical Physics<span class="progress-indicator"></span></a></li>
                    </ul>
                </li>
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link">
                        <span class="material-symbols-rounded">psychology</span>
                        Fundamental Concepts
                    </a>
                    <ul class="sidebar-subnav">
                        <li><a href="#" class="sidebar-subnav-link" data-topic-id="wave-particle-duality">Wave-Particle
                                Duality<span class="progress-indicator"></span></a></li>
                        <li><a href="#" class="sidebar-subnav-link" data-topic-id="uncertainty-principle">Uncertainty
                                Principle<span class="progress-indicator"></span></a></li>
                        <li><a href="#" class="sidebar-subnav-link" data-topic-id="quantum-superposition">Quantum
                                Superposition<span class="progress-indicator"></span></a></li>
                        <li><a href="#" class="sidebar-subnav-link" data-topic-id="quantum-entanglement">Quantum
                                Entanglement<span class="progress-indicator"></span></a></li>
                    </ul>
                </li>
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link">
                        <span class="material-symbols-rounded">functions</span>
                        Quantum Mechanics
                    </a>
                    <ul class="sidebar-subnav">
                        <li><a href="#" class="sidebar-subnav-link">Schrödinger's Equation<span
                                    class="progress-indicator"></span></a></li>
                        <li><a href="#" class="sidebar-subnav-link">Wave Functions<span
                                    class="progress-indicator"></span></a></li>
                        <li><a href="#" class="sidebar-subnav-link">Quantum Operators<span
                                    class="progress-indicator"></span></a></li>
                        <li><a href="#" class="sidebar-subnav-link">Quantum Measurement<span
                                    class="progress-indicator"></span></a></li>
                    </ul>
                </li>
                <li class="sidebar-nav-item">
                    <a href="#" class="sidebar-nav-link">
                        <span class="material-symbols-rounded">rocket_launch</span>
                        Applications
                    </a>
                    <ul class="sidebar-subnav">
                        <li><a href="#" class="sidebar-subnav-link">Quantum Computing<span
                                    class="progress-indicator"></span></a></li>
                        <li><a href="#" class="sidebar-subnav-link">Quantum Cryptography<span
                                    class="progress-indicator"></span></a></li>
                        <li><a href="#" class="sidebar-subnav-link">Quantum Teleportation<span
                                    class="progress-indicator"></span></a></li>
                    </ul>
                </li>
            </ul>
        </aside>

        <main>
            <div class="breadcrumb">
                <a href="#">Home</a>
                <span class="separator">/</span>
                <a href="#">Introduction</a>
                <span class="separator">/</span>
                <span>What is Quantum Physics?</span>
            </div>

            <h1 class="page-title">
                <span class="material-symbols-rounded">science</span>
                Introduction to Quantum Physics
            </h1>

            <div class="tabs">
                <div class="tab active" data-tab="overview">Overview</div>
                <div class="tab" data-tab="learn">Learn</div>
                <div class="tab" data-tab="quiz">Quiz</div>
                <div class="tab" data-tab="notes">Notes</div>
            </div>

            <div class="tab-content active" id="overview">
                <div class="card">
                    <h2 class="card-title">
                        <span class="material-symbols-rounded">lightbulb</span>
                        What is Quantum Physics?
                    </h2>
                    <div class="card-content">
                        <p>Quantum physics, also known as quantum mechanics, is a fundamental theory in physics that
                            provides a description of the physical properties of nature at the scale of atoms and
                            subatomic particles. It is the foundation of all quantum physics including quantum
                            chemistry, quantum field theory, quantum technology, and quantum information science.</p>
                        <p>Unlike classical physics, which describes how objects move and interact at everyday scales,
                            quantum physics deals with the behavior of matter and light on the atomic and subatomic
                            scale. At these tiny scales, many of the equations of classical physics do not yield
                            accurate descriptions of nature. Instead, quantum theory provides mathematical descriptions
                            of the <span class="highlighted-term">wave-particle duality<span class="tooltip">The concept
                                    that every particle or quantum entity may be described as either a particle or a
                                    wave, depending on the experimental setup.</span></span>, the <span
                                class="highlighted-term">uncertainty principle<span class="tooltip">A fundamental
                                    principle stating that there is a limit to the precision with which complementary
                                    variables, such as position and momentum, can be known.</span></span>, and <span
                                class="highlighted-term">quantum entanglement<span class="tooltip">A quantum phenomenon
                                    where pairs or groups of particles are generated or interact in ways such that the
                                    quantum state of each particle cannot be described independently of the
                                    others.</span></span>.</p>

                        <div class="progress-bar-container">
                            <div class="progress-bar" style="width: 25%"></div>
                        </div>
                    </div>
                    <div class="card-actions">
                        <button class="btn" id="startLearningBtn">
                            <span class="material-symbols-rounded">play_arrow</span>
                            Start Learning
                        </button>
                    </div>
                </div>

                <h2 class="card-title">
                    <span class="material-symbols-rounded">category</span>
                    Core Quantum Concepts
                </h2>
                <div class="concept-grid">
                    <div class="concept-card">
                        <h3 class="concept-card-title">
                            <span class="material-symbols-rounded">waves</span>
                            Wave-Particle Duality
                        </h3>
                        <div class="concept-card-content">
                            <p>The concept that every particle or quantum entity exhibits both wave and particle
                                properties. This duality addresses the inability of classical concepts like "particle"
                                or "wave" to fully describe quantum objects.</p>
                        </div>
                        <a href="#" class="concept-card-link">Explore this concept
                            <span class="material-symbols-rounded">arrow_forward</span>
                        </a>
                    </div>

                    <div class="concept-card">
                        <h3 class="concept-card-title">
                            <span class="material-symbols-rounded">blur_on</span>
                            Uncertainty Principle
                        </h3>
                        <div class="concept-card-content">
                            <p>Formulated by Werner Heisenberg, this principle states that there is a fundamental limit
                                to the precision with which complementary variables (such as position and momentum) can
                                be known simultaneously.</p>
                        </div>
                        <a href="#" class="concept-card-link">Explore this concept <span
                                class="material-symbols-rounded">arrow_forward</span></a>
                    </div>

                    <div class="concept-card">
                        <h3 class="concept-card-title">
                            <span class="material-symbols-rounded">layers</span>
                            Quantum Superposition
                        </h3>
                        <div class="concept-card-content">
                            <p>A principle that states quantum systems can exist in multiple states simultaneously until
                                measured or observed, at which point they collapse into a single definite state.</p>
                        </div>
                        <a href="#" class="concept-card-link">Explore this concept <span
                                class="material-symbols-rounded">arrow_forward</span></a>
                    </div>

                    <div class="concept-card">
                        <h3 class="concept-card-title">
                            <span class="material-symbols-rounded">link</span>
                            Quantum Entanglement
                        </h3>
                        <div class="concept-card-content">
                            <p>A quantum phenomenon where pairs or groups of particles are generated or interact in ways
                                such that the quantum state of each particle cannot be described independently of the
                                others.</p>
                        </div>
                        <a href="#" class="concept-card-link">Explore this concept <span
                                class="material-symbols-rounded">arrow_forward</span></a>
                    </div>
                </div>
            </div>

            <div class="tab-content" id="learn">
                <div class="sub-tabs-container">
                    <div class="sub-tabs">
                        <!-- Sub-tabs will be dynamically populated here -->
                    </div>
                    <div class="sub-tab-content-area">
                        <!-- Content for the active sub-tab + specific topic will be shown here -->
                    </div>
                </div>
            </div>

            <div class="tab-content" id="quiz">
                <div class="quiz-container">
                    <h2 class="card-title">
                        <span class="material-symbols-rounded">quiz</span>
                        Test Your Knowledge
                    </h2>
                    <div class="quiz-question">
                        <p><strong>Question 1:</strong> Which of the following phenomena led to the development of
                            quantum physics?</p>
                    </div>
                    <ul class="quiz-options">
                        <li class="quiz-option" data-correct="false">Newton's laws failing to explain planetary motion
                        </li>
                        <li class="quiz-option" data-correct="true">The photoelectric effect showing light behaves as
                            particles</li>
                        <li class="quiz-option" data-correct="false">The discovery of nuclear fission</li>
                        <li class="quiz-option" data-correct="false">Einstein's theory of general relativity</li>
                    </ul>
                    <div class="quiz-feedback"></div>
                    <button class="btn" id="checkAnswerBtn">
                        <span class="material-symbols-rounded">check_circle</span>
                        Check Answer
                    </button>
                    <button class="btn" id="nextQuestionBtn" style="display: none;">
                        <span class="material-symbols-rounded">arrow_forward</span>
                        Next Question
                    </button>
                </div>
            </div>

            <div class="tab-content" id="notes">
                <div class="notes-container">
                    <h2 class="notes-title">Your Notes</h2>
                    <textarea class="notes-textarea"
                        placeholder="Take notes on quantum physics concepts here..."></textarea>
                    <div class="notes-actions">
                        <button class="btn btn-secondary" id="clearNotesBtn">
                            <span class="material-symbols-rounded">delete</span>
                            Clear
                        </button>
                        <button class="btn" id="saveNotesBtn">
                            <span class="material-symbols-rounded">save</span>
                            Save Notes
                        </button>
                    </div>
                </div>
            </div>

            <div class="glossary-container">
                <h2 class="glossary-title">
                    <span class="material-symbols-rounded">menu_book</span>
                    Quantum Physics Glossary
                </h2>
                <div class="glossary-search">
                    <span class="material-symbols-rounded">search</span>
                    <input type="text" placeholder="Search glossary terms..." id="glossarySearch">
                </div>
                <ul class="glossary-list" id="glossaryList">
                    <li class="glossary-item">
                        <span class="glossary-term">Wave Function (Ψ)</span>
                        <p class="glossary-definition">A mathematical description of the quantum state of a system. The
                            square of the wave function's absolute value gives the probability density of finding a
                            particle in a specific state.</p>
                    </li>
                    <li class="glossary-item">
                        <span class="glossary-term">Quantum State</span>
                        <p class="glossary-definition">The condition in which a quantum mechanical system exists,
                            described by a set of quantum numbers or a wave function.</p>
                    </li>
                    <li class="glossary-item">
                        <span class="glossary-term">Planck's Constant (h)</span>
                        <p class="glossary-definition">A fundamental physical constant that relates the energy of a
                            photon to its frequency. It has a value of approximately 6.626 × 10^-34 joule-seconds.</p>
                    </li>
                    <li class="glossary-item">
                        <span class="glossary-term">Quantum Tunneling</span>
                        <p class="glossary-definition">A quantum mechanical phenomenon where a particle passes through a
                            potential energy barrier that it classically could not surmount.</p>
                    </li>
                    <li class="glossary-item">
                        <span class="glossary-term">Quantum Decoherence</span>
                        <p class="glossary-definition">The process by which quantum systems lose coherence and their
                            quantum behavior due to interaction with their environment.</p>
                    </li>
                </ul>
            </div>
        </main>
    </div>

    <div class="modal" id="termModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modalTitle">Term Definition</h3>
                <button class="modal-close" id="modalClose">×</button>
            </div>
            <div class="modal-body" id="modalBody">
                Definition content will appear here.
            </div>
            <div class="modal-footer">
                <button class="btn" id="modalOkBtn">OK</button>
            </div>
        </div>
    </div>

    <script>
        // Mobile menu toggle
        const menuToggle = document.createElement('button');
        menuToggle.className = 'menu-toggle';
        menuToggle.innerHTML = '<span class="material-symbols-rounded">menu</span>';
        menuToggle.style.display = 'none';

        document.querySelector('header').prepend(menuToggle);

        menuToggle.addEventListener('click', () => {
            document.querySelector('.sidebar').classList.toggle('active');
        });

        // Check if we need to show the menu toggle
        function checkMobileView() {
            if (window.innerWidth <= 768) {
                menuToggle.style.display = 'block';
            } else {
                menuToggle.style.display = 'none';
                document.querySelector('.sidebar').classList.remove('active');
            }
        }

        window.addEventListener('resize', checkMobileView);
        checkMobileView();

        // Helper function to get visible text content from a link, excluding spans
        function getVisibleTextContent(element) {
            if (!element) return 'Unknown';
            const clone = element.cloneNode(true);
            clone.querySelectorAll('span.material-symbols-rounded').forEach(span => span.remove());
            let text = clone.textContent.trim();
            text = text.replace(/\s+/g, ' '); // Consolidate multiple spaces
            return text || 'Unnamed Text';
        }

        // Global state for current topic
        let currentTopicId = 'what-is-quantum-physics';
        let currentTopicTitle = 'What is Quantum Physics?';
        let currentParentCategoryId = 'introduction-to-quantum-physics'; // To track the parent category for sub-tabs
        let currentResizeHandler = null; // For managing active simulation's resize

        // --- Content Definitions for Learn Sub-Tabs ---
        const learnTabContentDetails = {
            'introduction-to-quantum-physics': {
                titleSuffix: "Overview",
                simulation: {
                    id: 'simulationIntro',
                    title: 'Interactive: Bohr Model of the Atom',
                    description: 'Visualize electron energy levels and transitions in a simple Bohr model. Excite the electron to higher orbits or observe photon emission as it returns to lower states.',
                    initFunction: 'initIntroSimulation',
                    canvasId: 'introSimCanvas'
                },
                extraContentHTML: () => `
            <div class="card">
                <h2 class="card-title"><span class="material-symbols-rounded">article</span>Key Ideas of Introduction</h2>
                <p>This section introduces the fundamental principles of quantum physics, its historical context, and the key distinctions from classical physics. Explore why a new theory was needed to describe the universe at atomic and subatomic scales.</p>
            </div>`
            },
            'fundamental-concepts': {
                titleSuffix: "Core Ideas",
                simulation: {
                    id: 'simulationFundConcepts',
                    title: 'Interactive: Double-Slit Experiment',
                    description: 'The double-slit experiment demonstrates the wave-particle duality of quantum objects. Observe how particles, fired one at a time, create an interference pattern, behaving like waves passing through both slits.',
                    initFunction: 'initDoubleSlitSimulation',
                    canvasId: 'doubleSlitCanvas' // Specific canvas ID for this sim
                },
                extraContentHTML: () => `
            <div class="card">
                <h2 class="card-title"><span class="material-symbols-rounded">article</span>Exploring Fundamental Concepts</h2>
                <p>Delve into core quantum phenomena: wave-particle duality, the uncertainty principle, quantum superposition (systems existing in multiple states at once), and quantum entanglement (interconnected particle states regardless of distance).</p>
            </div>`
            },
            'quantum-mechanics': {
                titleSuffix: "Formalism",
                simulation: {
                    id: 'simulationQM',
                    title: 'Interactive: Particle in a 1D Box',
                    description: 'Explore the behavior of a quantum particle confined within an infinitely deep potential well. Observe quantized energy levels and their corresponding wave functions or probability densities.',
                    initFunction: 'initQMSimulation',
                    canvasId: 'qmSimCanvas'
                },
                extraContentHTML: () => `
            <div class="card">
                <h2 class="card-title">
                    <span class="material-symbols-rounded">functions</span>
                    Mathematical Foundation: Schrödinger's Equation
                </h2>
                <div class="card-content">
                    <p>The Schrödinger equation is a linear partial differential equation that describes how the quantum state of a physical system changes over time. It is central to quantum mechanics and its solutions, called wave functions, provide a probabilistic interpretation of the behavior of particles.</p>
                    <div class="equation">
                        <span class="equation-label">(Eq. 1)</span>
                        \\[ i\\hbar \\frac{\partial\\Psi(x, t)}{\partial t} = \\hat{H}\\Psi(x, t) \\]
                    </div>
                    <p>Where:</p>
                    <ul>
                        <li>\\(i\\) is the imaginary unit</li>
                        <li>\\(\\hbar\\) is the reduced Planck constant</li>
                        <li>\\(\\Psi(x, t)\\) (psi) is the wave function</li>
                        <li>\\(\\hat{H}\\) is the Hamiltonian operator (total energy)</li>
                    </ul>
                    <p>For a single particle in one dimension, the time-independent Schrödinger equation takes the form:</p>
                    <div class="equation">
                        <span class="equation-label">(Eq. 2)</span>
                        \\[ -\\frac{\\hbar^2}{2m}\\frac{\\mathrm{d}^2\\Psi(x)}{\\mathrm{d}x^2} + V(x)\\Psi(x) = E\\Psi(x) \\]
                    </div>
                    <p>This equation forms the foundation for predicting the probability of finding a particle in a specific location or state. Unlike classical mechanics, which provides exact predictions, quantum mechanics gives probability distributions.</p>
                </div>
            </div>`
            },
            'applications': {
                titleSuffix: "In Practice",
                simulation: {
                    id: 'simulationApps',
                    title: 'Interactive: Qubit on the Bloch Sphere',
                    description: 'Visualize a qubit using the Bloch sphere representation. Adjust angles θ (theta) and φ (phi) to see how they define the qubit state as a superposition of |0⟩ and |1⟩.',
                    initFunction: 'initAppsSimulation',
                    canvasId: 'appsSimCanvas'
                },
                extraContentHTML: () => `
            <div class="card">
                <h2 class="card-title"><span class="material-symbols-rounded">article</span>Real-World Applications</h2>
                <p>Discover how quantum mechanics principles are applied in technologies like quantum computing (harnessing superposition and entanglement for powerful computation), quantum cryptography (ultra-secure communication), and quantum sensors (highly precise measurement devices).</p>
            </div>`
            }
        };

        // --- Generate Content for Learn Sub-Tab ---
        function getTopicLearnContent(parentCategoryId, parentCategoryTitle, activeTopicId, activeTopicTitle) {
            const container = document.createElement('div');
            const categoryDetails = learnTabContentDetails[parentCategoryId];

            if (!categoryDetails) {
                const card = document.createElement('div');
                card.className = 'card';
                const cardTitleEl = document.createElement('h2');
                cardTitleEl.className = 'card-title';
                cardTitleEl.innerHTML = `<span class="material-symbols-rounded">article</span> ${activeTopicTitle || parentCategoryTitle}`;
                const cardContentEl = document.createElement('div');
                cardContentEl.className = 'card-content';
                cardContentEl.innerHTML = `<p>Detailed learning content for <strong>${activeTopicTitle || parentCategoryTitle}</strong> (ID: ${activeTopicId || parentCategoryId}) goes here. This section would include text, images, and relevant equations if applicable.</p>`;
                card.appendChild(cardTitleEl);
                card.appendChild(cardContentEl);
                container.appendChild(card);
                return container;
            }

            const titleCard = document.createElement('div');
            titleCard.className = 'card';
            const titleElement = document.createElement('h2');
            titleElement.className = 'card-title';
            titleElement.innerHTML = `<span class="material-symbols-rounded">school</span> ${parentCategoryTitle}: ${categoryDetails.titleSuffix}`;
            titleCard.appendChild(titleElement);

            const specificTopicIntro = document.createElement('div');
            specificTopicIntro.className = 'card-content'; // Use card-content for consistent padding
            specificTopicIntro.innerHTML = `<p>You are currently viewing content related to <strong>"${activeTopicTitle}"</strong> within the broader category of <em>${parentCategoryTitle}</em>. The interactive simulation and additional information below pertain to the overall category.</p>`;
            titleCard.appendChild(specificTopicIntro);
            container.appendChild(titleCard);

            if (categoryDetails.simulation) {
                const simDetails = categoryDetails.simulation;
                const simContainer = document.createElement('div');
                simContainer.className = 'simulation-container card'; // Added card for consistent styling
                simContainer.id = simDetails.id;

                const simTitle = document.createElement('h3');
                simTitle.className = 'simulation-title';
                simTitle.innerHTML = `<span class="material-symbols-rounded">science</span> ${simDetails.title}`;
                simContainer.appendChild(simTitle);

                const simDesc = document.createElement('p');
                simDesc.className = 'simulation-description';
                simDesc.textContent = simDetails.description;
                simContainer.appendChild(simDesc);

                const canvas = document.createElement('canvas');
                canvas.id = simDetails.canvasId; // Use specific canvas ID
                canvas.className = 'simulation-canvas';
                simContainer.appendChild(canvas);

                const controlsDiv = document.createElement('div');
                controlsDiv.className = 'simulation-controls';

                if (parentCategoryId === 'fundamental-concepts') { // Specific controls for Double-Slit
                    controlsDiv.innerHTML = `
                <button id="playDoubleSlitBtn" class="btn"><span class="material-symbols-rounded">play_arrow</span> Play</button>
                <button id="pauseDoubleSlitBtn" class="btn"><span class="material-symbols-rounded">pause</span> Pause</button>
                <button id="resetDoubleSlitBtn" class="btn"><span class="material-symbols-rounded">restart_alt</span> Reset</button>
                <div class="slider-container">
                    <div class="slider-label"><span>Particle Rate</span><span id="particleRateDoubleSlitValue" class="slider-value">50</span></div>
                    <input type="range" min="1" max="100" value="50" class="slider" id="particleRateDoubleSlitSlider">
                </div>
                <div class="slider-container">
                    <div class="slider-label"><span>Slit Width</span><span id="slitWidthDoubleSlitValue" class="slider-value">25</span></div>
                    <input type="range" min="5" max="50" value="25" class="slider" id="slitWidthDoubleSlitSlider">
                </div>`;
                } else if (parentCategoryId === 'introduction-to-quantum-physics') { // Specific controls for Bohr Model (Intro Sim)
                    controlsDiv.innerHTML = `
                <button id="exciteElectronBtn" class="btn"><span class="material-symbols-rounded">arrow_upward</span> Excite Electron</button>
                <button id="emitPhotonBtn" class="btn"><span class="material-symbols-rounded">lightbulb</span> Emit Photon</button>
                <div class="slider-container">
                    <div class="slider-label"><span>Energy Level</span><span id="energyLevelIntroValue" class="slider-value">1</span></div>
                    <input type="range" min="1" max="3" value="1" class="slider" id="energyLevelIntroSlider">
                </div>`;
                } else if (parentCategoryId === 'quantum-mechanics') { // Specific controls for Particle in a Box (QM Sim)
                    controlsDiv.innerHTML = `
                <div class="slider-container">
                    <div class="slider-label"><span>Quantum Number (n)</span><span id="quantumNumberQMValue" class="slider-value">1</span></div>
                    <input type="range" min="1" max="5" value="1" class="slider" id="quantumNumberQMSlider">
                </div>
                <button id="showProbDensityQMBtn" class="btn"><span class="material-symbols-rounded">visibility</span> Show Prob. Density</button>`;
                } else if (parentCategoryId === 'applications') { // Specific controls for Qubit (Apps Sim)
                    controlsDiv.innerHTML = `
                <div class="slider-container">
                    <div class="slider-label"><span>Angle Theta (θ)</span><span id="thetaAppsValue" class="slider-value">90</span>°</div>
                    <input type="range" min="0" max="180" value="90" class="slider" id="thetaAppsSlider">
                </div>
                <div class="slider-container">
                    <div class="slider-label"><span>Angle Phi (φ)</span><span id="phiAppsValue" class="slider-value">0</span>°</div>
                    <input type="range" min="0" max="360" value="0" class="slider" id="phiAppsSlider">
                </div>
                <p style="font-size:0.9em; width:100%; margin-top:5px;">Qubit state: <strong id="qubitStateDisplay">|ψ⟩ = cos(θ/2)|0⟩ + e<sup>iφ</sup>sin(θ/2)|1⟩</strong></p>`;
                } else {
                    controlsDiv.innerHTML = `<p>Controls for ${simDetails.title} would be here.</p>`;
                }
                simContainer.appendChild(controlsDiv);
                container.appendChild(simContainer);
            }

            if (categoryDetails.extraContentHTML) {
                const extraContentDiv = document.createElement('div');
                // Wrap in a div to ensure proper parsing if it's just a string of multiple elements
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = categoryDetails.extraContentHTML();
                while (tempDiv.firstChild) {
                    extraContentDiv.appendChild(tempDiv.firstChild);
                }
                // Prepend to ensure it appears before simulation if both exist
                // Actually, let's append to keep order consistent with definition
                container.appendChild(extraContentDiv);
            }
            return container;
        }

        // --- Simulation Initialization Placeholder Functions ---

        // --- Bohr Model Simulation (Replaces initIntroSimulation Placeholder) ---
        let intro_canvas = null;
        let intro_ctx = null;
        let intro_electronLevel = 1;
        const intro_orbitRadii = [50, 80, 110]; // Radii for n=1, 2, 3
        const intro_nucleusRadius = 10;
        let intro_photon = null; // { startY, endY, progress }
        let intro_animationFrameId = null;

        function intro_drawNucleus() {
            if (!intro_ctx || !intro_canvas) return;
            const centerX = intro_canvas.width / 2;
            const centerY = intro_canvas.height / 2;
            intro_ctx.beginPath();
            intro_ctx.arc(centerX, centerY, intro_nucleusRadius, 0, Math.PI * 2);
            intro_ctx.fillStyle = document.body.classList.contains('dark-theme') ? '#FF6B6B' : '#D32F2F';
            intro_ctx.fill();
        }

        function intro_drawOrbits() {
            if (!intro_ctx || !intro_canvas) return;
            const centerX = intro_canvas.width / 2;
            const centerY = intro_canvas.height / 2;
            intro_ctx.strokeStyle = document.body.classList.contains('dark-theme') ? '#666' : '#ccc';
            intro_ctx.lineWidth = 1;
            intro_orbitRadii.forEach(radius => {
                intro_ctx.beginPath();
                intro_ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
                intro_ctx.stroke();
            });
        }

        function intro_drawElectron() {
            if (!intro_ctx || !intro_canvas) return;
            const centerX = intro_canvas.width / 2;
            const centerY = intro_canvas.height / 2;
            const electronRadius = 5;
            const orbitRadius = intro_orbitRadii[intro_electronLevel - 1];

            // For simplicity, place electron on the right side of the orbit
            const electronX = centerX + orbitRadius;
            const electronY = centerY;

            intro_ctx.beginPath();
            intro_ctx.arc(electronX, electronY, electronRadius, 0, Math.PI * 2);
            intro_ctx.fillStyle = document.body.classList.contains('dark-theme') ? '#82AAFF' : '#3F51B5';
            intro_ctx.fill();
        }

        function intro_drawPhoton() {
            if (!intro_photon || !intro_ctx || !intro_canvas) return;
            const centerX = intro_canvas.width / 2;
            const photonLength = 20;
            const photonX = centerX + intro_orbitRadii[Math.min(intro_photon.levelFrom, intro_photon.levelTo) - 1] + intro_nucleusRadius + 10; // Position it outside the inner orbit

            const startY = intro_photon.startY;
            const endY = intro_photon.endY;
            const currentY = startY + (endY - startY) * intro_photon.progress;

            intro_ctx.beginPath();
            intro_ctx.moveTo(photonX, currentY - photonLength / 2);
            intro_ctx.lineTo(photonX, currentY + photonLength / 2);
            intro_ctx.strokeStyle = document.body.classList.contains('dark-theme') ? '#FFEB3B' : '#FBC02D'; // Yellowish
            intro_ctx.lineWidth = 3;
            intro_ctx.stroke();

            // Simple wave pattern for photon
            intro_ctx.beginPath();
            for (let i = 0; i <= photonLength; i += 2) {
                const waveOffset = Math.sin((i / photonLength) * Math.PI * 2 + intro_photon.progress * Math.PI * 4) * 4;
                if (i === 0) intro_ctx.moveTo(photonX + waveOffset, currentY - photonLength / 2 + i);
                else intro_ctx.lineTo(photonX + waveOffset, currentY - photonLength / 2 + i);
            }
            intro_ctx.lineWidth = 1.5;
            intro_ctx.stroke();

        }

        function intro_animatePhoton() {
            if (!intro_photon) {
                if (intro_animationFrameId) cancelAnimationFrame(intro_animationFrameId);
                intro_animationFrameId = null;
                intro_drawScene(); // Final draw after animation
                return;
            }
            intro_photon.progress += 0.02; // Speed of photon animation
            if (intro_photon.progress >= 1) {
                intro_photon = null;
            }
            intro_drawScene();
            intro_animationFrameId = requestAnimationFrame(intro_animatePhoton);
        }

        function intro_drawScene() {
            if (!intro_ctx || !intro_canvas) return;
            intro_ctx.fillStyle = document.body.classList.contains('dark-theme') ? '#2a2a2a' : '#f1f1f1';
            intro_ctx.fillRect(0, 0, intro_canvas.width, intro_canvas.height);
            intro_drawNucleus();
            intro_drawOrbits();
            intro_drawElectron();
            if (intro_photon) {
                intro_drawPhoton();
            }
        }

        function initIntroSimulation() {
            console.log("Initializing Bohr Model Simulation (Intro)");
            intro_canvas = document.getElementById('introSimCanvas');
            if (!intro_canvas) {
                console.error("Intro Sim Canvas ('introSimCanvas') not found!");
                return;
            }
            intro_ctx = intro_canvas.getContext('2d');
            if (!intro_ctx) {
                console.error("Failed to get 2D context for introSimCanvas");
                return;
            }

            if (intro_animationFrameId) {
                cancelAnimationFrame(intro_animationFrameId);
                intro_animationFrameId = null;
            }
            intro_photon = null;

            // Ensure canvas dimensions are set based on its display size
            // This should be part of a resize handler too if layout can change
            if (intro_canvas.offsetWidth > 0 && intro_canvas.offsetHeight > 0) {
                intro_canvas.width = intro_canvas.offsetWidth;
                intro_canvas.height = intro_canvas.offsetHeight;
            } else {
                intro_canvas.width = 600; // Default if not visible
                intro_canvas.height = 300;
            }

            const exciteBtn = document.getElementById('exciteElectronBtn');
            const emitBtn = document.getElementById('emitPhotonBtn');
            const energyLevelSlider = document.getElementById('energyLevelIntroSlider');
            const energyLevelValue = document.getElementById('energyLevelIntroValue');

            if (exciteBtn) {
                exciteBtn.onclick = () => {
                    if (intro_electronLevel < intro_orbitRadii.length) {
                        intro_electronLevel++;
                        if (energyLevelSlider) energyLevelSlider.value = intro_electronLevel;
                        if (energyLevelValue) energyLevelValue.textContent = intro_electronLevel;
                        intro_drawScene();
                    }
                };
            }

            if (emitBtn) {
                emitBtn.onclick = () => {
                    if (intro_electronLevel > 1) {
                        const oldLevel = intro_electronLevel;
                        intro_electronLevel--;
                        if (energyLevelSlider) energyLevelSlider.value = intro_electronLevel;
                        if (energyLevelValue) energyLevelValue.textContent = intro_electronLevel;

                        // Trigger photon animation
                        const centerY = intro_canvas.height / 2;
                        intro_photon = {
                            startY: centerY - 30, // Arbitrary start/end for visual effect
                            endY: centerY + 30,
                            progress: 0,
                            levelFrom: oldLevel,
                            levelTo: intro_electronLevel
                        };
                        if (intro_animationFrameId) cancelAnimationFrame(intro_animationFrameId);
                        intro_animationFrameId = requestAnimationFrame(intro_animatePhoton);
                        // intro_drawScene() will be called by animation loop
                    }
                };
            }

            if (energyLevelSlider) {
                intro_electronLevel = parseInt(energyLevelSlider.value);
                if (energyLevelValue) energyLevelValue.textContent = intro_electronLevel;
                energyLevelSlider.oninput = (e) => {
                    const newLevel = parseInt(e.target.value);
                    if (newLevel !== intro_electronLevel) {
                        // If jumping down, simulate emission
                        if (newLevel < intro_electronLevel && intro_electronLevel > 1) {
                            const oldLevelForPhoton = intro_electronLevel;
                            intro_electronLevel = newLevel;
                            const centerY = intro_canvas.height / 2;
                            intro_photon = {
                                startY: centerY - 30,
                                endY: centerY + 30,
                                progress: 0,
                                levelFrom: oldLevelForPhoton,
                                levelTo: newLevel
                            };
                            if (intro_animationFrameId) cancelAnimationFrame(intro_animationFrameId);
                            intro_animationFrameId = requestAnimationFrame(intro_animatePhoton);
                        } else {
                            intro_electronLevel = newLevel;
                            intro_drawScene(); // Just update if not emitting
                        }
                    }
                    if (energyLevelValue) energyLevelValue.textContent = intro_electronLevel;
                };
            }

            intro_drawScene(); // Initial draw
            console.log("Bohr Model simulation initialized.");
        }
        // --- End of Bohr Model Simulation ---

        // --- Particle in a Box Simulation (Replaces initQMSimulation Placeholder) ---
        let qm_canvas = null;
        let qm_ctx = null;
        let qm_quantumNumber_n = 1;
        let qm_showProbabilityDensity = false;
        const qm_boxMargin = 30;
        const qm_amplitudeFactor = 50; // Scales the wave function display

        function qm_drawBox() {
            if (!qm_ctx || !qm_canvas) return;
            const boxWidth = qm_canvas.width - 2 * qm_boxMargin;
            const boxHeight = qm_canvas.height - 2 * qm_boxMargin;

            qm_ctx.strokeStyle = document.body.classList.contains('dark-theme') ? '#999' : '#666';
            qm_ctx.lineWidth = 2;
            qm_ctx.strokeRect(qm_boxMargin, qm_boxMargin, boxWidth, boxHeight);

            // Draw energy levels (simplified representation)
            const numLevelsToDraw = 5;
            for (let i = 1; i <= numLevelsToDraw; i++) {
                const energy = i * i; // E is proportional to n^2
                const levelY = qm_canvas.height - qm_boxMargin - (energy / (numLevelsToDraw * numLevelsToDraw)) * (boxHeight * 0.8);
                qm_ctx.beginPath();
                qm_ctx.moveTo(qm_boxMargin, levelY);
                qm_ctx.lineTo(qm_boxMargin + boxWidth, levelY);
                qm_ctx.strokeStyle = document.body.classList.contains('dark-theme') ? '#555' : '#ddd';
                qm_ctx.lineWidth = 1;
                qm_ctx.stroke();
                if (i === qm_quantumNumber_n) {
                    qm_ctx.fillStyle = document.body.classList.contains('dark-theme') ? '#82AAFF' : '#3F51B5';
                    qm_ctx.fillText(`E${i}`, qm_boxMargin - 25, levelY + 4);
                }
            }
        }

        function qm_drawWaveFunction() {
            if (!qm_ctx || !qm_canvas) return;
            const boxWidth = qm_canvas.width - 2 * qm_boxMargin;
            const boxHeight = qm_canvas.height - 2 * qm_boxMargin;
            const baselineY = qm_canvas.height - qm_boxMargin - (qm_quantumNumber_n * qm_quantumNumber_n / (5 * 5)) * (boxHeight * 0.8); // Align with energy level line

            qm_ctx.beginPath();
            qm_ctx.strokeStyle = document.body.classList.contains('dark-theme') ? '#FFAB40' : '#FF6F00';
            qm_ctx.lineWidth = 2;

            const L = boxWidth; // Length of the box
            for (let x_pixel = 0; x_pixel <= boxWidth; x_pixel++) {
                const x_coord = x_pixel; // x relative to box start
                let psi_x = Math.sqrt(2 / L) * Math.sin((qm_quantumNumber_n * Math.PI * x_coord) / L);
                let y_pixel_offset = psi_x * qm_amplitudeFactor;

                if (qm_showProbabilityDensity) {
                    psi_x = psi_x * psi_x; // psi^2
                    y_pixel_offset = -psi_x * qm_amplitudeFactor * 3; // Invert and scale for visibility
                }

                const plot_x = qm_boxMargin + x_pixel;
                const plot_y = baselineY - y_pixel_offset;

                if (x_pixel === 0) {
                    qm_ctx.moveTo(plot_x, plot_y);
                } else {
                    qm_ctx.lineTo(plot_x, plot_y);
                }
            }
            qm_ctx.stroke();
        }

        function qm_drawScene() {
            if (!qm_ctx || !qm_canvas) return;
            qm_ctx.fillStyle = document.body.classList.contains('dark-theme') ? '#2a2a2a' : '#f1f1f1';
            qm_ctx.fillRect(0, 0, qm_canvas.width, qm_canvas.height);
            qm_ctx.font = '12px Roboto';
            qm_drawBox();
            qm_drawWaveFunction();
        }

        function initQMSimulation() {
            console.log("Initializing Particle in a Box Simulation (QM)");
            qm_canvas = document.getElementById('qmSimCanvas');
            if (!qm_canvas) {
                console.error("QM Sim Canvas ('qmSimCanvas') not found!");
                return;
            }
            qm_ctx = qm_canvas.getContext('2d');
            if (!qm_ctx) {
                console.error("Failed to get 2D context for qmSimCanvas");
                return;
            }

            if (qm_canvas.offsetWidth > 0 && qm_canvas.offsetHeight > 0) {
                qm_canvas.width = qm_canvas.offsetWidth;
                qm_canvas.height = qm_canvas.offsetHeight;
            } else {
                qm_canvas.width = 600;
                qm_canvas.height = 400;
            }

            const quantumNumberSlider = document.getElementById('quantumNumberQMSlider');
            const quantumNumberValue = document.getElementById('quantumNumberQMValue');
            const probDensityBtn = document.getElementById('showProbDensityQMBtn');

            if (quantumNumberSlider) {
                qm_quantumNumber_n = parseInt(quantumNumberSlider.value);
                if (quantumNumberValue) quantumNumberValue.textContent = qm_quantumNumber_n;
                quantumNumberSlider.oninput = (e) => {
                    qm_quantumNumber_n = parseInt(e.target.value);
                    if (quantumNumberValue) quantumNumberValue.textContent = qm_quantumNumber_n;
                    qm_drawScene();
                };
            }

            if (probDensityBtn) {
                probDensityBtn.onclick = () => {
                    qm_showProbabilityDensity = !qm_showProbabilityDensity;
                    probDensityBtn.innerHTML = `<span class="material-symbols-rounded">${qm_showProbabilityDensity ? 'visibility_off' : 'visibility'}</span> ${qm_showProbabilityDensity ? 'Show Wave Function' : 'Show Prob. Density'}`;
                    qm_drawScene();
                };
            }

            qm_drawScene(); // Initial draw
            console.log("Particle in a Box simulation initialized.");
        }
        // --- End of Particle in a Box Simulation ---

        // --- Qubit States & Superposition Simulation (Replaces initAppsSimulation Placeholder) ---
        let apps_canvas = null;
        let apps_ctx = null;
        let apps_theta = Math.PI / 2; // Angle from Z-axis (90 degrees)
        let apps_phi = 0;           // Angle from X-axis in XY-plane (0 degrees)
        const apps_sphereRadius = 100;
        const apps_sphereCenter = { x: 0, y: 0 }; // Relative to canvas center

        function apps_project3Dto2D(x, y, z) {
            if (!apps_canvas) return { x: 0, y: 0 };
            // Simple orthographic projection for now, could add perspective
            const canvasCenterX = apps_canvas.width / 2;
            const canvasCenterY = apps_canvas.height / 2;
            return {
                x: canvasCenterX + apps_sphereCenter.x + x,
                y: canvasCenterY + apps_sphereCenter.y - y // Y is typically inverted in 2D canvas
            };
        }

        function apps_drawBlochSphere() {
            if (!apps_ctx || !apps_canvas) return;

            // Sphere outline
            let p = apps_project3Dto2D(0, 0, 0);
            apps_ctx.beginPath();
            apps_ctx.arc(p.x, p.y, apps_sphereRadius, 0, Math.PI * 2);
            apps_ctx.strokeStyle = document.body.classList.contains('dark-theme') ? '#888' : '#bbb';
            apps_ctx.lineWidth = 1;
            apps_ctx.stroke();

            // Axes (X, Y, Z)
            const axisLength = apps_sphereRadius * 1.2;
            const axisColor = document.body.classList.contains('dark-theme') ? '#666' : '#999';
            apps_ctx.font = "12px Roboto";
            apps_ctx.fillStyle = axisColor;

            // Z-axis (|0> and |1>)
            let p_z_top = apps_project3Dto2D(0, axisLength, 0);
            let p_z_bottom = apps_project3Dto2D(0, -axisLength, 0);
            apps_ctx.beginPath();
            apps_ctx.moveTo(p_z_top.x, p_z_top.y);
            apps_ctx.lineTo(p_z_bottom.x, p_z_bottom.y);
            apps_ctx.stroke();
            apps_ctx.fillText("|0⟩ (Z+)", p_z_top.x + 5, p_z_top.y);
            apps_ctx.fillText("|1⟩ (Z-)", p_z_bottom.x + 5, p_z_bottom.y);

            // X-axis (|+> and |->)
            let p_x_pos = apps_project3Dto2D(axisLength, 0, 0);
            let p_x_neg = apps_project3Dto2D(-axisLength, 0, 0);
            apps_ctx.beginPath();
            apps_ctx.moveTo(p_x_pos.x, p_x_pos.y);
            apps_ctx.lineTo(p_x_neg.x, p_x_neg.y);
            apps_ctx.stroke();
            apps_ctx.fillText("|+⟩ (X+)", p_x_pos.x + 5, p_x_pos.y + 4);

            // Y-axis (|i> and |-i>)
            // Projected Y axis will appear tilted due to simple orthographic from front
            // For a better Y-axis illusion, we'd need more complex projection or rotation
            let p_y_pos = apps_project3Dto2D(0, 0, axisLength); // Y-axis on sphere surface (coming out/in)
            let p_y_neg = apps_project3Dto2D(0, 0, -axisLength);
            apps_ctx.beginPath();
            apps_ctx.moveTo(p_y_pos.x, p_y_pos.y); // This will look like a point if not rotated
            apps_ctx.lineTo(p_y_neg.x, p_y_neg.y); // This line will actually be vertical
            // Dashed line for Y might be better for 2D projection
            apps_ctx.setLineDash([5, 5]);
            apps_ctx.stroke();
            apps_ctx.setLineDash([]);
            apps_ctx.fillText("|i⟩ (Y+)", apps_project3Dto2D(0, 0, apps_sphereRadius).x - 30, apps_project3Dto2D(0, 0, apps_sphereRadius).y - 5);
        }

        function apps_drawQubitVector() {
            if (!apps_ctx || !apps_canvas) return;

            // Convert spherical to Cartesian coordinates
            const x = apps_sphereRadius * Math.sin(apps_theta) * Math.cos(apps_phi);
            const y = apps_sphereRadius * Math.sin(apps_theta) * Math.sin(apps_phi);
            const z = apps_sphereRadius * Math.cos(apps_theta);

            // Project to 2D (Bloch sphere view: x -> screen x, z -> screen y)
            const screen_x = apps_canvas.width / 2 + apps_sphereCenter.x + x;
            const screen_y = apps_canvas.height / 2 + apps_sphereCenter.y - z; // z maps to screen y

            const origin_screen = apps_project3Dto2D(0, 0, 0); // Center of sphere

            apps_ctx.beginPath();
            apps_ctx.moveTo(origin_screen.x, origin_screen.y);
            apps_ctx.lineTo(screen_x, screen_y);
            apps_ctx.strokeStyle = document.body.classList.contains('dark-theme') ? '#82AAFF' : '#3F51B5'; // Qubit vector color
            apps_ctx.lineWidth = 3;
            apps_ctx.stroke();

            // Draw a small circle at the tip of the vector
            apps_ctx.beginPath();
            apps_ctx.arc(screen_x, screen_y, 5, 0, Math.PI * 2);
            apps_ctx.fillStyle = document.body.classList.contains('dark-theme') ? '#82AAFF' : '#3F51B5';
            apps_ctx.fill();
        }

        function apps_updateQubitStateDisplay() {
            const displayEl = document.getElementById('qubitStateDisplay');
            if (displayEl) {
                const cosThetaOver2 = Math.cos(apps_theta / 2).toFixed(2);
                const sinThetaOver2 = Math.sin(apps_theta / 2).toFixed(2);
                const phiDeg = (apps_phi * 180 / Math.PI).toFixed(0);
                // Displaying complex exponentiation simply for now
                displayEl.innerHTML = `|ψ⟩ = ${cosThetaOver2}|0⟩ + ${sinThetaOver2}e<sup>i${phiDeg}°</sup>|1⟩`;
            }
        }

        function apps_drawScene() {
            if (!apps_ctx || !apps_canvas) return;
            apps_ctx.fillStyle = document.body.classList.contains('dark-theme') ? '#2a2a2a' : '#f1f1f1';
            apps_ctx.fillRect(0, 0, apps_canvas.width, apps_canvas.height);

            // Adjust sphereCenter based on canvas size
            apps_sphereCenter.x = 0;
            apps_sphereCenter.y = 0; // Keep it centered vertically for now

            apps_drawBlochSphere();
            apps_drawQubitVector();
        }

        function initAppsSimulation() {
            console.log("Initializing Qubit Simulation (Apps)");
            apps_canvas = document.getElementById('appsSimCanvas');
            if (!apps_canvas) {
                console.error("Apps Sim Canvas ('appsSimCanvas') not found!");
                return;
            }
            apps_ctx = apps_canvas.getContext('2d');
            if (!apps_ctx) {
                console.error("Failed to get 2D context for appsSimCanvas");
                return;
            }

            if (apps_canvas.offsetWidth > 0 && apps_canvas.offsetHeight > 0) {
                apps_canvas.width = apps_canvas.offsetWidth;
                // Make height a bit smaller to accommodate controls if they are tall
                apps_canvas.height = Math.min(apps_canvas.offsetHeight, apps_canvas.width * 0.75, 350);
            } else {
                apps_canvas.width = 500;
                apps_canvas.height = 350;
            }

            const thetaSlider = document.getElementById('thetaAppsSlider');
            const thetaValue = document.getElementById('thetaAppsValue');
            const phiSlider = document.getElementById('phiAppsSlider');
            const phiValue = document.getElementById('phiAppsValue');

            if (thetaSlider) {
                apps_theta = (parseInt(thetaSlider.value) * Math.PI) / 180;
                if (thetaValue) thetaValue.textContent = thetaSlider.value;
                thetaSlider.oninput = (e) => {
                    apps_theta = (parseInt(e.target.value) * Math.PI) / 180;
                    if (thetaValue) thetaValue.textContent = e.target.value;
                    apps_drawScene();
                    apps_updateQubitStateDisplay();
                };
            }
            if (phiSlider) {
                apps_phi = (parseInt(phiSlider.value) * Math.PI) / 180;
                if (phiValue) phiValue.textContent = phiSlider.value;
                phiSlider.oninput = (e) => {
                    apps_phi = (parseInt(e.target.value) * Math.PI) / 180;
                    if (phiValue) phiValue.textContent = e.target.value;
                    apps_drawScene();
                    apps_updateQubitStateDisplay();
                };
            }

            apps_drawScene(); // Initial draw
            apps_updateQubitStateDisplay();
            console.log("Qubit (Bloch Sphere) simulation initialized.");
        }
        // --- End of Qubit States & Superposition Simulation ---


        // --- Refactored Double-Slit Experiment ---
        let doubleSlit_animationFrameId;
        let doubleSlit_particles = [];
        let doubleSlit_isPlaying = false;
        let doubleSlit_particleRate = 50;
        let doubleSlit_slitWidth = 25;
        let doubleSlit_screenHits = [];
        const doubleSlit_slitSeparation = 100;
        const doubleSlit_wallThickness = 20;
        const doubleSlit_screenDistance = 400;
        const doubleSlit_binHeight = 8;
        let doubleSlit_ctx = null;
        let doubleSlit_canvas = null;
        let doubleSlit_lastParticleTime = 0;


        function doubleSlit_drawSlits() {
            if (!doubleSlit_ctx || !doubleSlit_canvas) return;
            const canvasWidth = doubleSlit_canvas.width;
            const canvasHeight = doubleSlit_canvas.height;
            const wallX = canvasWidth / 3;

            doubleSlit_ctx.fillStyle = document.body.classList.contains('dark-theme') ? '#555' : '#ccc';
            doubleSlit_ctx.fillRect(wallX - doubleSlit_wallThickness / 2, 0, doubleSlit_wallThickness, (canvasHeight / 2 - doubleSlit_slitSeparation / 2) - doubleSlit_slitWidth / 2);
            doubleSlit_ctx.fillRect(wallX - doubleSlit_wallThickness / 2, (canvasHeight / 2 + doubleSlit_slitSeparation / 2) + doubleSlit_slitWidth / 2, doubleSlit_wallThickness, canvasHeight - ((canvasHeight / 2 + doubleSlit_slitSeparation / 2) + doubleSlit_slitWidth / 2));
            doubleSlit_ctx.fillRect(wallX - doubleSlit_wallThickness / 2, (canvasHeight / 2 - doubleSlit_slitSeparation / 2) + doubleSlit_slitWidth / 2, doubleSlit_wallThickness, doubleSlit_slitSeparation - doubleSlit_slitWidth);
        }

        function doubleSlit_drawScreen() {
            if (!doubleSlit_ctx || !doubleSlit_canvas) return;
            const canvasWidth = doubleSlit_canvas.width;
            const canvasHeight = doubleSlit_canvas.height;
            const screenX = canvasWidth / 3 + doubleSlit_screenDistance;

            doubleSlit_ctx.fillStyle = document.body.classList.contains('dark-theme') ? '#444' : '#ddd';
            doubleSlit_ctx.fillRect(screenX, 0, 10, canvasHeight);
        }

        function doubleSlit_drawInterferencePattern() {
            if (!doubleSlit_ctx || !doubleSlit_canvas) return;
            const screenX = doubleSlit_canvas.width / 3 + doubleSlit_screenDistance;
            const maxHits = Math.max(...doubleSlit_screenHits, 1);

            for (let i = 0; i < doubleSlit_screenHits.length; i++) {
                if (doubleSlit_screenHits[i] > 0) {
                    const intensity = doubleSlit_screenHits[i] / maxHits;
                    const barHeight = intensity * 80;
                    doubleSlit_ctx.fillStyle = document.body.classList.contains('dark-theme') ?
                        `rgba(102, 187, 106, ${0.2 + intensity * 0.8})` :
                        `rgba(76, 175, 80, ${0.2 + intensity * 0.8})`;
                    doubleSlit_ctx.fillRect(screenX + 15, i * doubleSlit_binHeight, barHeight, doubleSlit_binHeight);
                }
            }
        }

        function doubleSlit_drawBackground() {
            if (!doubleSlit_canvas || !doubleSlit_ctx) return;

            // Ensure canvas dimensions are set based on its display size only if it's visible
            if (doubleSlit_canvas.offsetWidth > 0 && doubleSlit_canvas.offsetHeight > 0) {
                doubleSlit_canvas.width = doubleSlit_canvas.offsetWidth;
                doubleSlit_canvas.height = doubleSlit_canvas.offsetHeight;
            } else if (doubleSlit_canvas.width === 0 || doubleSlit_canvas.height === 0) {
                // Fallback if not visible, use a default
                doubleSlit_canvas.width = 600; // Default width
                doubleSlit_canvas.height = 300; // Default height
            }


            doubleSlit_ctx.fillStyle = document.body.classList.contains('dark-theme') ? '#2a2a2a' : '#f1f1f1';
            doubleSlit_ctx.fillRect(0, 0, doubleSlit_canvas.width, doubleSlit_canvas.height);

            const requiredNumBins = Math.max(0, Math.floor(doubleSlit_canvas.height / doubleSlit_binHeight));
            if (doubleSlit_screenHits.length !== requiredNumBins) {
                doubleSlit_screenHits = new Array(requiredNumBins).fill(0);
            }

            doubleSlit_drawSlits();
            doubleSlit_drawScreen();
            doubleSlit_drawInterferencePattern();
        }

        class DoubleSlitParticle {
            constructor() {
                if (!doubleSlit_canvas) return; // Should not happen if canvas is initialized
                this.x = 10;
                this.y = doubleSlit_canvas.height / 2 + (Math.random() - 0.5) * 100;
                this.vx = 2 + Math.random() * 2;
                this.vy = (Math.random() - 0.5) * 0.5;
                this.radius = 2;
                this.color = document.body.classList.contains('dark-theme') ? 'rgba(138, 153, 243, 0.8)' : 'rgba(63, 81, 181, 0.8)';
                this.path = [{ x: this.x, y: this.y }];
                this.maxPathLength = 50;
                this.passedSlit = null;
            }

            update() {
                if (!doubleSlit_canvas) return;
                const wallX = doubleSlit_canvas.width / 3;
                const slitCenterY1 = doubleSlit_canvas.height / 2 - doubleSlit_slitSeparation / 2;
                const slitCenterY2 = doubleSlit_canvas.height / 2 + doubleSlit_slitSeparation / 2;

                if (!this.passedSlit && this.x + this.radius > wallX - doubleSlit_wallThickness / 2 && this.x - this.radius < wallX + doubleSlit_wallThickness / 2) {
                    if (this.y > slitCenterY1 - doubleSlit_slitWidth / 2 && this.y < slitCenterY1 + doubleSlit_slitWidth / 2) {
                        this.passedSlit = 'top';
                        this.vy += (Math.random() - 0.5) * 1;
                        this.vx *= 0.9;
                    } else if (this.y > slitCenterY2 - doubleSlit_slitWidth / 2 && this.y < slitCenterY2 + doubleSlit_slitWidth / 2) {
                        this.passedSlit = 'bottom';
                        this.vy += (Math.random() - 0.5) * 1;
                        this.vx *= 0.9;
                    } else {
                        this.vx = 0; this.vy = 0;
                    }
                }

                this.x += this.vx;
                this.y += this.vy;

                this.path.push({ x: this.x, y: this.y });
                if (this.path.length > this.maxPathLength) this.path.shift();

                if (this.y < -this.radius * 10 || this.y > doubleSlit_canvas.height + this.radius * 10) {
                    this.vx = 0; this.vy = 0;
                }
            }

            draw() {
                if (!doubleSlit_ctx) return;
                doubleSlit_ctx.beginPath();
                doubleSlit_ctx.moveTo(this.path[0].x, this.path[0].y);
                for (let i = 1; i < this.path.length; i++) {
                    const opacity = i / this.path.length;
                    const trailColor = document.body.classList.contains('dark-theme') ?
                        `rgba(138, 153, 243, ${opacity * 0.5})` : `rgba(63, 81, 181, ${opacity * 0.5})`;
                    doubleSlit_ctx.strokeStyle = trailColor;
                    doubleSlit_ctx.lineTo(this.path[i].x, this.path[i].y);
                }
                doubleSlit_ctx.lineWidth = this.radius;
                doubleSlit_ctx.stroke();

                doubleSlit_ctx.beginPath();
                doubleSlit_ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                doubleSlit_ctx.fillStyle = this.color;
                doubleSlit_ctx.fill();
            }
        }

        function doubleSlit_simulationLoop(timestamp) {
            if (!doubleSlit_isPlaying) {
                if (doubleSlit_animationFrameId) doubleSlit_animationFrameId = requestAnimationFrame(doubleSlit_simulationLoop);
                return;
            }
            if (!doubleSlit_ctx || !doubleSlit_canvas) return;

            const timeSinceLastParticle = timestamp - doubleSlit_lastParticleTime;
            const particleInterval = 1000 / doubleSlit_particleRate;

            if (timeSinceLastParticle > particleInterval) {
                doubleSlit_particles.push(new DoubleSlitParticle());
                doubleSlit_lastParticleTime = timestamp;
            }

            doubleSlit_ctx.fillStyle = document.body.classList.contains('dark-theme') ? '#2a2a2a' : '#f1f1f1';
            doubleSlit_ctx.fillRect(0, 0, doubleSlit_canvas.width, doubleSlit_canvas.height);

            doubleSlit_drawSlits();
            doubleSlit_drawScreen();
            doubleSlit_drawInterferencePattern();

            doubleSlit_particles.forEach((particle, index) => {
                particle.update();
                particle.draw();
                const screenXPosition = doubleSlit_canvas.width / 3 + doubleSlit_screenDistance;
                if (particle.x > screenXPosition && particle.vx > 0) {
                    const binIndex = Math.floor(particle.y / doubleSlit_binHeight);
                    if (binIndex >= 0 && binIndex < doubleSlit_screenHits.length) {
                        doubleSlit_screenHits[binIndex]++;
                    }
                    doubleSlit_particles.splice(index, 1);
                } else if (particle.x > doubleSlit_canvas.width + 50 || (particle.vx === 0 && particle.vy === 0)) {
                    doubleSlit_particles.splice(index, 1);
                }
            });
            doubleSlit_animationFrameId = requestAnimationFrame(doubleSlit_simulationLoop);
        }

        function doubleSlit_startSimulation() {
            const playBtn = document.getElementById('playDoubleSlitBtn');
            const pauseBtn = document.getElementById('pauseDoubleSlitBtn');
            if (!doubleSlit_isPlaying) {
                doubleSlit_isPlaying = true;
                if (playBtn) playBtn.disabled = true;
                if (pauseBtn) pauseBtn.disabled = false;
                if (!doubleSlit_animationFrameId) {
                    doubleSlit_drawBackground(); // Redraw before starting loop
                    doubleSlit_animationFrameId = requestAnimationFrame(doubleSlit_simulationLoop);
                }
            }
        }

        function doubleSlit_pauseSimulation() {
            const playBtn = document.getElementById('playDoubleSlitBtn');
            const pauseBtn = document.getElementById('pauseDoubleSlitBtn');
            if (doubleSlit_isPlaying) {
                doubleSlit_isPlaying = false;
                if (playBtn) playBtn.disabled = false;
                if (pauseBtn) pauseBtn.disabled = true;
            }
        }

        function doubleSlit_resetSimulation() {
            const playBtn = document.getElementById('playDoubleSlitBtn');
            const pauseBtn = document.getElementById('pauseDoubleSlitBtn');

            doubleSlit_pauseSimulation();
            if (doubleSlit_animationFrameId) {
                cancelAnimationFrame(doubleSlit_animationFrameId);
                doubleSlit_animationFrameId = null;
            }
            doubleSlit_particles = [];
            if (doubleSlit_screenHits && doubleSlit_screenHits.fill) doubleSlit_screenHits.fill(0);
            else doubleSlit_screenHits = new Array(Math.floor((doubleSlit_canvas?.height || 300) / doubleSlit_binHeight)).fill(0);

            doubleSlit_drawBackground();
            if (playBtn) playBtn.disabled = false;
            if (pauseBtn) pauseBtn.disabled = true;
        }

        function initDoubleSlitSimulation() {
            console.log("Initializing Double Slit Simulation JS");
            doubleSlit_canvas = document.getElementById('doubleSlitCanvas');
            if (!doubleSlit_canvas) {
                console.error("Double Slit Canvas ('doubleSlitCanvas') not found!");
                return;
            }
            doubleSlit_ctx = doubleSlit_canvas.getContext('2d');
            if (!doubleSlit_ctx) {
                console.error("Failed to get 2D context for doubleSlitCanvas");
                return;
            }

            // Stop any previous animation loop before reassigning listeners
            if (doubleSlit_animationFrameId) {
                cancelAnimationFrame(doubleSlit_animationFrameId);
                doubleSlit_animationFrameId = null;
            }
            doubleSlit_isPlaying = false; // Reset playing state


            const playBtn = document.getElementById('playDoubleSlitBtn');
            const pauseBtn = document.getElementById('pauseDoubleSlitBtn');
            const resetBtn = document.getElementById('resetDoubleSlitBtn');
            const particleRateSlider = document.getElementById('particleRateDoubleSlitSlider');
            const particleRateValue = document.getElementById('particleRateDoubleSlitValue');
            const slitWidthSlider = document.getElementById('slitWidthDoubleSlitSlider');
            const slitWidthValue = document.getElementById('slitWidthDoubleSlitValue');

            if (playBtn) playBtn.onclick = doubleSlit_startSimulation; // Use onclick to simplify listener management
            if (pauseBtn) {
                pauseBtn.onclick = doubleSlit_pauseSimulation;
                pauseBtn.disabled = true;
            }
            if (resetBtn) resetBtn.onclick = doubleSlit_resetSimulation;

            if (particleRateSlider) {
                doubleSlit_particleRate = parseInt(particleRateSlider.value); // Initialize
                if (particleRateValue) particleRateValue.textContent = doubleSlit_particleRate;
                particleRateSlider.oninput = (e) => {
                    doubleSlit_particleRate = parseInt(e.target.value);
                    if (particleRateValue) particleRateValue.textContent = doubleSlit_particleRate;
                };
            }
            if (slitWidthSlider) {
                doubleSlit_slitWidth = parseInt(slitWidthSlider.value); // Initialize
                if (slitWidthValue) slitWidthValue.textContent = doubleSlit_slitWidth;
                slitWidthSlider.oninput = (e) => {
                    doubleSlit_slitWidth = parseInt(e.target.value);
                    if (slitWidthValue) slitWidthValue.textContent = doubleSlit_slitWidth;
                    doubleSlit_drawBackground(); // Redraw slits with new width
                };
            }
            doubleSlit_resetSimulation(); // Perform initial draw and setup
            console.log("Double Slit Simulation initialized");
        }
        // --- End of Refactored Double-Slit Experiment ---


        // --- Sub-Tab Management & Content Update ---
        const subTabsContainer = document.querySelector('#learn .sub-tabs-container .sub-tabs');
        const subTabContentArea = document.querySelector('#learn .sub-tabs-container .sub-tab-content-area');

        function updateLearnTabsAndContent(newTopicId, newTopicTitle, parentCategoryId) {
            if (!subTabsContainer || !subTabContentArea) return;

            currentTopicId = newTopicId;
            currentTopicTitle = newTopicTitle;
            currentParentCategoryId = parentCategoryId;

            const mainCategories = [];
            document.querySelectorAll('.sidebar-nav > .sidebar-nav-item').forEach(item => {
                const link = item.querySelector('.sidebar-nav-link');
                if (link) {
                    const title = getVisibleTextContent(link);
                    const id = title.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                    mainCategories.push({ id, title });
                }
            });

            subTabsContainer.innerHTML = '';
            let parentCategoryTitleForDisplay = "Learn"; // Default

            mainCategories.forEach(cat => {
                const subTabEl = document.createElement('div');
                subTabEl.className = 'sub-tab';
                subTabEl.textContent = cat.title;
                subTabEl.dataset.categoryId = cat.id;
                if (cat.id === currentParentCategoryId) {
                    subTabEl.classList.add('active');
                    parentCategoryTitleForDisplay = cat.title; // Get title of active category
                }
                subTabEl.addEventListener('click', () => {
                    document.querySelectorAll('#learn .sub-tabs .sub-tab').forEach(st => st.classList.remove('active'));
                    subTabEl.classList.add('active');
                    currentParentCategoryId = cat.id; // Update global parent category

                    // Find first child topic of this category and click it to update content
                    let firstChildTopicLink = null;
                    const sidebarNavItems = document.querySelectorAll('.sidebar-nav > .sidebar-nav-item');
                    for (const item of sidebarNavItems) {
                        const mainLink = item.querySelector('.sidebar-nav-link');
                        if (mainLink && (getVisibleTextContent(mainLink).toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '')) === cat.id) {
                            const firstSubLink = item.querySelector('.sidebar-subnav-link');
                            if (firstSubLink) {
                                firstChildTopicLink = firstSubLink;
                                break;
                            }
                        }
                    }
                    if (firstChildTopicLink) {
                        firstChildTopicLink.click(); // This will trigger displayContent & updateLearnTabs again
                    } else {
                        // Fallback: if category has no sub-topics, display its own overview
                        // This case might need a refined getTopicLearnContent if no sub-topics exist.
                        // For now, clicking a sub-link is the primary way to refresh content.
                        // We'll rely on the existing logic which *should* have a firstChildTopicLink from sidebar.
                        // If not, then `displayContent` itself would have called `updateLearnTabsAndContent`
                        // with the current `currentTopicId` which might be the category itself if sidebar structure allows.
                        // Let's ensure `getTopicLearnContent` can handle `parentCategoryId` as `activeTopicId` too.
                        // The current `getTopicLearnContent` is called with parentCatID, its title, currentTopicId, and its title.
                        // This direct click on subtab changes currentParentCategoryId. Then we need to find a new currentTopicId
                        // and title from its children.
                        // The line `firstChildTopicLink.click()` should handle this.
                        // If there are no children, then we need to decide what `currentTopicId` and `currentTopicTitle` should be.
                        // Perhaps the category ID and title itself.
                        const categoryTitle = subTabEl.textContent;
                        // Simulate a click or directly update content for the category itself
                        // This assumes `getTopicLearnContent` can generate a category overview.
                        // The current call below to `getTopicLearnContent` already uses `currentParentCategoryId` for the structure
                        // and `currentTopicId` for the specific highlighted article.
                        // If `firstChildTopicLink` isn't found, we might need to update `currentTopicId` to `cat.id`
                        // and `currentTopicTitle` to `cat.title` before calling `getTopicLearnContent` again.
                        subTabContentArea.innerHTML = '';
                        const categoryIntroCard = getTopicLearnContent(cat.id, cat.title, cat.id, cat.title);
                        subTabContentArea.appendChild(categoryIntroCard);
                        initializeActiveSimulation(cat.id);
                        if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                            MathJax.typesetPromise([subTabContentArea]).catch(err => console.error("MathJax typesetting error:", err));
                        }
                    }
                });
                subTabsContainer.appendChild(subTabEl);
            });

            subTabContentArea.innerHTML = ''; // Clear previous content
            // parentCategoryTitleForDisplay should be correct from the loop above if a tab is active.
            // If no tab was active matching currentParentCategoryId (e.g., initial load), we need to find it.
            if (currentParentCategoryId) {
                const activeCatInfo = mainCategories.find(c => c.id === currentParentCategoryId);
                if (activeCatInfo) parentCategoryTitleForDisplay = activeCatInfo.title;
            }

            const topicContentElement = getTopicLearnContent(currentParentCategoryId, parentCategoryTitleForDisplay, currentTopicId, currentTopicTitle);
            subTabContentArea.appendChild(topicContentElement);

            initializeActiveSimulation(currentParentCategoryId); // Initialize simulation for the new content

            if (typeof MathJax !== 'undefined' && MathJax.typesetPromise) {
                MathJax.typesetPromise([subTabContentArea]).catch(err => console.error("MathJax typesetting error:", err));
            }

            const learnTabContent = document.getElementById('learn');
            const learnSubTabsOuterContainer = document.querySelector('#learn .sub-tabs-container');

            if (learnTabContent && learnSubTabsOuterContainer) {
                learnSubTabsOuterContainer.style.display = 'block';
            }
            // learn-original-content is removed, so no need to hide it.
        }

        function initializeActiveSimulation(parentCategoryId) {
            console.log("Attempting to initialize simulation for category:", parentCategoryId);
            // Teardown previous simulation's specific listeners or resources if necessary
            // For example, if a simulation loop is running for the old sim, cancel it.
            if (doubleSlit_animationFrameId) { // Specifically for double slit
                cancelAnimationFrame(doubleSlit_animationFrameId);
                doubleSlit_animationFrameId = null;
                doubleSlit_isPlaying = false; // Ensure it's marked as not playing
            }
            // Add similar for other potential active simulations if they have global animation frames

            // Remove old global resize handler
            if (currentResizeHandler) {
                window.removeEventListener('resize', currentResizeHandler);
                currentResizeHandler = null;
            }

            const categoryDetails = learnTabContentDetails[parentCategoryId];
            if (categoryDetails && categoryDetails.simulation) {
                const simInitFunctionName = categoryDetails.simulation.initFunction;
                if (typeof window[simInitFunctionName] === 'function') {
                    console.log("Calling simulation init function:", simInitFunctionName);
                    window[simInitFunctionName](); // Call the specific init function

                    // Setup new resize handler for the current simulation's background drawing
                    // This assumes each init function makes its drawBackground available or handles resize itself.
                    // For double slit, it's doubleSlit_drawBackground
                    if (simInitFunctionName === 'initDoubleSlitSimulation' && typeof doubleSlit_drawBackground === 'function') {
                        currentResizeHandler = doubleSlit_drawBackground;
                        window.addEventListener('resize', currentResizeHandler);
                        doubleSlit_drawBackground(); // Initial draw after init
                    } else if (simInitFunctionName === 'initIntroSimulation' && typeof intro_drawScene === 'function') {
                        currentResizeHandler = () => {
                            if (intro_canvas && intro_canvas.getContext) {
                                if (intro_canvas.offsetWidth > 0 && intro_canvas.offsetHeight > 0) {
                                    intro_canvas.width = intro_canvas.offsetWidth;
                                    intro_canvas.height = intro_canvas.offsetHeight;
                                }
                                intro_drawScene();
                            }
                        };
                        window.addEventListener('resize', currentResizeHandler);
                        intro_drawScene(); // Initial draw
                    } else if (simInitFunctionName === 'initQMSimulation' && typeof qm_drawScene === 'function') {
                        currentResizeHandler = () => {
                            if (qm_canvas && qm_canvas.getContext) {
                                if (qm_canvas.offsetWidth > 0 && qm_canvas.offsetHeight > 0) {
                                    qm_canvas.width = qm_canvas.offsetWidth;
                                    qm_canvas.height = qm_canvas.offsetHeight;
                                }
                                qm_drawScene();
                            }
                        };
                        window.addEventListener('resize', currentResizeHandler);
                        qm_drawScene();
                    } else if (simInitFunctionName === 'initAppsSimulation' && typeof apps_drawScene === 'function') {
                        currentResizeHandler = () => {
                            if (apps_canvas && apps_canvas.getContext) {
                                if (apps_canvas.offsetWidth > 0 && apps_canvas.offsetHeight > 0) {
                                    apps_canvas.width = apps_canvas.offsetWidth;
                                    apps_canvas.height = Math.min(apps_canvas.offsetHeight, apps_canvas.width * 0.75, 350);
                                }
                                apps_drawScene();
                            }
                        };
                        window.addEventListener('resize', currentResizeHandler);
                        apps_drawScene();
                    }

                } else {
                    console.warn("Simulation init function not found:", simInitFunctionName);
                }
            } else {
                console.log("No simulation defined for category or category details not found:", parentCategoryId);
            }
        }


        // Function to update content based on topic and tab
        function displayContent(topicId, topicTitle, tabId) {
            const learnSubTabsContainerParent = document.querySelector('#learn .sub-tabs-container');

            // Default: hide Learn tab's dynamic structures, will be shown if 'learn' tab is active
            if (learnSubTabsContainerParent) {
                learnSubTabsContainerParent.style.display = 'none';
            }
            // If an old simulation loop is running, stop it.
            // initializeActiveSimulation will handle stopping the specific one.
            // but for safety, if not 'learn' tab, try to stop double slit if it was running.
            if (tabId !== 'learn' && doubleSlit_animationFrameId) {
                doubleSlit_pauseSimulation(); // Try to pause it
            }


            if (tabId === 'overview') {
                const overviewCardTitle = document.querySelector('#overview .card-title');
                if (overviewCardTitle) { // Update title to reflect the current topic from sidebar
                    overviewCardTitle.innerHTML = `<span class="material-symbols-rounded">lightbulb</span> Overview: ${topicTitle}`;
                }
                // Ensure the main overview content sections are visible
                // (though CSS for .active tab-content should handle this primarily)
                const overviewConceptGrid = document.querySelector('#overview .concept-grid');
                if (overviewConceptGrid) overviewConceptGrid.style.display = 'grid';
                const overviewMainCard = document.querySelector('#overview > .card'); // The main card holding the detailed text
                if (overviewMainCard) overviewMainCard.style.display = 'block';
                // The actual text content of the overview page is expected to be static HTML within the #overview div.
            } else if (tabId === 'learn') {
                // updateLearnTabsAndContent will make its own container visible
                // It's called with specific topicId, topicTitle, and currentParentCategoryId
                updateLearnTabsAndContent(topicId, topicTitle, currentParentCategoryId);
                if (learnSubTabsContainerParent) {
                    learnSubTabsContainerParent.style.display = 'block';
                }

            } else if (tabId === 'quiz') {
                loadQuizForTopic(topicId, topicTitle);
            } else if (tabId === 'notes') {
                setupNotesForTopic(topicId, topicTitle);
            }
        }

        // Sidebar navigation
        const sidebarNavLinks = document.querySelectorAll('.sidebar-nav-link');
        sidebarNavLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const navItem = link.parentElement;
                navItem.classList.toggle('open');
            });
        });

        // Sidebar sub-navigation
        const sidebarSubNavLinks = document.querySelectorAll('.sidebar-subnav-link');
        sidebarSubNavLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('.sidebar-subnav-link').forEach(l => l.classList.remove('active'));
                link.classList.add('active');

                const newTopicId = link.dataset.topicId || getVisibleTextContent(link).toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                const newTopicTitle = link.textContent.trim().split(/<span/)[0].trim();

                const parentNavItem = link.closest('.sidebar-nav-item');
                const parentLink = parentNavItem ? parentNavItem.querySelector('.sidebar-nav-link') : null;

                const parentCategoryTitleText = getVisibleTextContent(parentLink);
                const parentCatId = parentCategoryTitleText.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');

                currentTopicId = newTopicId;
                currentTopicTitle = newTopicTitle;
                currentParentCategoryId = parentCatId; // CRITICAL: Update global parent category

                const breadcrumbParentText = parentCategoryTitleText;
                const breadcrumb = document.querySelector('.breadcrumb');
                breadcrumb.innerHTML = `
            <a href="#">Home</a>
            <span class="separator">/</span>
            <a href="#">${breadcrumbParentText}</a>
            <span class="separator">/</span>
            <span>${currentTopicTitle}</span>
        `;

                document.querySelector('.page-title').innerHTML = `
            <span class="material-symbols-rounded">science</span>
            ${breadcrumbParentText}: ${currentTopicTitle}
        `;

                const progressIndicator = link.querySelector('.progress-indicator');
                if (progressIndicator) progressIndicator.classList.add('completed');

                const learnTabButton = document.querySelector('.tab[data-tab="learn"]');
                const currentActiveTab = document.querySelector('.tab.active');

                if (currentActiveTab && currentActiveTab.dataset.tab === 'learn') {
                    // If Learn tab is already active, just update its content
                    displayContent(currentTopicId, currentTopicTitle, 'learn');
                } else if (learnTabButton) {
                    // If Learn tab is not active, click it (which will then trigger displayContent)
                    learnTabButton.click();
                } else {
                    // Fallback if somehow learn tab button isn't found (should not happen)
                    displayContent(currentTopicId, currentTopicTitle, 'learn');
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    const learnContentEl = document.getElementById('learn');
                    if (learnContentEl) learnContentEl.classList.add('active');
                }
            });
        });

        // Collapse all sidebar sections
        document.getElementById('collapseAll').addEventListener('click', () => {
            const openItems = document.querySelectorAll('.sidebar-nav-item.open');
            if (openItems.length > 0) {
                openItems.forEach(item => item.classList.remove('open'));
            } else {
                document.querySelectorAll('.sidebar-nav-item').forEach(item => item.classList.add('open'));
            }
        });

        // Concept card links
        const conceptCardLinks = document.querySelectorAll('.concept-card-link');
        conceptCardLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const conceptTitle = link.closest('.concept-card').querySelector('.concept-card-title').textContent.trim();
                const sidebarItems = document.querySelectorAll('.sidebar-subnav-link');
                for (const item of sidebarItems) {
                    if (item.textContent.includes(conceptTitle)) {
                        item.click();
                        return;
                    }
                }
                document.querySelectorAll('.sidebar-nav-item')[1].classList.add('open');
                document.querySelectorAll('.sidebar-nav-item')[1].querySelectorAll('.sidebar-subnav-link')[0].click();
            });
        });

        // Tabs functionality
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const tabId = tab.getAttribute('data-tab');
                tabs.forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                const activeContentContainer = document.getElementById(tabId);
                if (activeContentContainer) {
                    activeContentContainer.classList.add('active');
                }
                displayContent(currentTopicId, currentTopicTitle, tabId);
            });
        });

        // Start Learning button
        document.getElementById('startLearningBtn').addEventListener('click', () => {
            document.querySelector('[data-tab="learn"]').click();
        });

        // Theme toggle
        const themeToggle = document.querySelector('.theme-toggle');
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark-theme');
            const icon = themeToggle.querySelector('.material-symbols-rounded');
            if (document.body.classList.contains('dark-theme')) {
                icon.textContent = 'light_mode';
            } else {
                icon.textContent = 'dark_mode';
            }
            // Redraw ACTIVE canvas for theme
            if (currentResizeHandler) {
                currentResizeHandler(); // This should call the active simulation's drawBackground
            }
        });


        // Initial app setup
        function initializeApp() {
            // 1. Set initial currentTopicId, currentTopicTitle, and currentParentCategoryId
            //    based on the initially active sidebar link or default to the first one.
            const initialActiveSidebarLink = document.querySelector('.sidebar-subnav-link.active');
            let firstClickTarget = null;

            if (initialActiveSidebarLink) {
                firstClickTarget = initialActiveSidebarLink;
            } else {
                const firstSidebarSubLink = document.querySelector('.sidebar-subnav-link');
                if (firstSidebarSubLink) {
                    firstClickTarget = firstSidebarSubLink;
                    // Note: .active class will be set below if it's the definitive active link.
                }
            }

            // 2. If a target sidebar link is found, extract its info, set globals,
            //    and update UI elements (breadcrumbs, page title, sidebar active state).
            if (firstClickTarget) {
                const newTopicId = firstClickTarget.dataset.topicId || getVisibleTextContent(firstClickTarget).toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');
                const newTopicTitle = firstClickTarget.textContent.trim().split(/<span/)[0].trim();
                const parentNavItem = firstClickTarget.closest('.sidebar-nav-item');
                const parentLink = parentNavItem ? parentNavItem.querySelector('.sidebar-nav-link') : null;
                const parentCategoryTitleText = getVisibleTextContent(parentLink);
                const parentCatId = parentCategoryTitleText.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, '');

                currentTopicId = newTopicId;
                currentTopicTitle = newTopicTitle;
                currentParentCategoryId = parentCatId;

                // Update breadcrumb
                const breadcrumb = document.querySelector('.breadcrumb');
                if (breadcrumb) {
                    breadcrumb.innerHTML = `
                <a href="#">Home</a>
                <span class="separator">/</span>
                <a href="#">${parentCategoryTitleText}</a>
                <span class="separator">/</span>
                <span>${currentTopicTitle}</span>
            `;
                }

                // Update page title
                const pageTitleEl = document.querySelector('.page-title');
                if (pageTitleEl) {
                    pageTitleEl.innerHTML = `
                <span class="material-symbols-rounded">science</span>
                ${parentCategoryTitleText}: ${currentTopicTitle}
            `;
                }

                // Mark sidebar item as active and open its parent category
                document.querySelectorAll('.sidebar-subnav-link').forEach(l => l.classList.remove('active'));
                firstClickTarget.classList.add('active');
                const progressIndicator = firstClickTarget.querySelector('.progress-indicator');
                // Preserve existing progress indicator state or mark as completed if desired
                if (progressIndicator && !progressIndicator.classList.contains('completed')) {
                    // Example: progressIndicator.classList.add('completed');
                }
                if (parentNavItem) parentNavItem.classList.add('open');

            } else {
                // Fallback if no sidebar link found - set default globals and UI
                currentTopicId = 'what-is-quantum-physics'; // Default
                currentTopicTitle = 'What is Quantum Physics?';
                currentParentCategoryId = 'introduction-to-quantum-physics';

                const defaultParentCategoryTitle = 'Introduction to Quantum Physics';
                const defaultTopicTitle = 'What is Quantum Physics?';

                const breadcrumb = document.querySelector('.breadcrumb');
                if (breadcrumb) {
                    breadcrumb.innerHTML = `
                <a href="#">Home</a>
                <span class="separator">/</span>
                <a href="#">${defaultParentCategoryTitle}</a>
                <span class="separator">/</span>
                <span>${defaultTopicTitle}</span>
            `;
                }
                const pageTitleEl = document.querySelector('.page-title');
                if (pageTitleEl) {
                    pageTitleEl.innerHTML = `
                <span class="material-symbols-rounded">science</span>
                ${defaultParentCategoryTitle}: ${defaultTopicTitle}
            `;
                }
            }

            // 3. Ensure "Overview" tab is active and displays its content
            const overviewTab = document.querySelector('.tab[data-tab="overview"]');
            if (overviewTab) {
                // Deactivate all tabs and tab contents first
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

                // Activate Overview tab and its content area
                overviewTab.classList.add('active');
                const overviewContent = document.getElementById('overview');
                if (overviewContent) {
                    overviewContent.classList.add('active');
                }
                // Call displayContent to update the Overview tab's title based on the current topic
                displayContent(currentTopicId, currentTopicTitle, 'overview');
            }

            checkMobileView(); // Ensure mobile menu toggle is correctly set on load
        }


        // --- Quiz Logic (largely unchanged, ensure selectors are robust if quiz structure changes) ---
        const quizContainer = document.querySelector('.quiz-container'); // Assuming one quiz container
        const quizCardTitle = quizContainer ? quizContainer.querySelector('.card-title') : null;
        const quizQuestionEl = quizContainer ? quizContainer.querySelector('.quiz-question p') : null;
        const quizOptionsUl = quizContainer ? quizContainer.querySelector('.quiz-options') : null;
        const quizCheckAnswerBtn = document.getElementById('checkAnswerBtn');
        const quizNextQuestionBtn = document.getElementById('nextQuestionBtn');
        const quizFeedbackEl = quizContainer ? quizContainer.querySelector('.quiz-feedback') : null;

        const quizzes = {
            'what-is-quantum-physics': {
                title: 'What is Quantum Physics?',
                questions: [
                    {
                        question: "Which of the following phenomena led to the development of quantum physics?",
                        options: [
                            { text: "Newton's laws failing to explain planetary motion", correct: false },
                            { text: "The photoelectric effect showing light behaves as particles", correct: true },
                            { text: "The discovery of nuclear fission", correct: false },
                            { text: "Einstein's theory of general relativity", correct: false }
                        ],
                        feedback: "Correct! The photoelectric effect was a key phenomenon establishing the particle nature of light.",
                        explanation: "The photoelectric effect, where electrons are emitted from a material when light shines on it, could only be explained by considering light as composed of discrete energy packets (photons)."
                    },
                    {
                        question: "Quantum physics primarily describes behavior at what scale?",
                        options: [
                            { text: "Cosmological scales (galaxies, universe)", correct: false },
                            { text: "Everyday macroscopic scales (balls, cars)", correct: false },
                            { text: "Atomic and subatomic scales (electrons, photons)", correct: true },
                            { text: "Microscopic, but still classical, scales (bacteria, cells)", correct: false }
                        ],
                        feedback: "Correct! It governs the incredibly small world of atoms and their constituents.",
                        explanation: "Classical physics works well for large objects, but quantum mechanics is necessary to understand the behavior of matter and energy at the atomic and subatomic levels."
                    }
                ]
            },
            'historical-development': {
                title: 'Historical Development',
                questions: [
                    {
                        question: "Who introduced the concept of energy quanta in 1900, laying the groundwork for quantum theory?",
                        options: [
                            { text: "Albert Einstein", correct: false },
                            { text: "Niels Bohr", correct: false },
                            { text: "Max Planck", correct: true },
                            { text: "Werner Heisenberg", correct: false }
                        ],
                        feedback: "Correct! Max Planck's work on blackbody radiation was a pivotal first step.",
                        explanation: "Max Planck proposed that energy is radiated and absorbed in discrete packets called quanta, which was a revolutionary departure from classical physics."
                    }
                ]
            },
            'wave-particle-duality': {
                title: 'Wave-Particle Duality',
                questions: [
                    {
                        question: "Wave-particle duality implies that entities like electrons and photons can exhibit properties of:",
                        options: [
                            { text: "Only particles", correct: false },
                            { text: "Only waves", correct: false },
                            { text: "Both particles and waves, depending on the experiment", correct: true },
                            { text: "Neither particles nor waves, but something entirely different", correct: false }
                        ],
                        feedback: "Correct! This is a cornerstone of quantum mechanics, showing the dual nature of quantum objects.",
                        explanation: "Experiments like the double-slit experiment demonstrate that particles can behave like waves (showing interference) and waves can behave like particles (like photons in the photoelectric effect)."
                    }
                ]
            },
            'uncertainty-principle': {
                title: 'Uncertainty Principle',
                questions: [
                    {
                        question: "The Heisenberg Uncertainty Principle states that there is a fundamental limit to the precision with which one can simultaneously know certain pairs of physical properties. Which is a common example of such a pair?",
                        options: [
                            { text: "Mass and charge", correct: false },
                            { text: "Position and momentum", correct: true },
                            { text: "Energy and temperature", correct: false },
                            { text: "Speed and color", correct: false }
                        ],
                        feedback: "Correct! The more precisely you know the position of a particle, the less precisely you can know its momentum, and vice-versa.",
                        explanation: "This isn't due to limitations in measurement equipment, but is an inherent property of quantum systems described by the inequality Δx * Δp ≥ ħ/2."
                    },
                    {
                        question: "Who is primarily credited with formulating the Uncertainty Principle?",
                        options: [
                            { text: "Albert Einstein", correct: false },
                            { text: "Erwin Schrödinger", correct: false },
                            { text: "Niels Bohr", correct: false },
                            { text: "Werner Heisenberg", correct: true }
                        ],
                        feedback: "Correct! Werner Heisenberg introduced this principle in 1927.",
                        explanation: "His work was crucial in the development of quantum mechanics and our understanding of the limits of measurement at the quantum scale."
                    }
                ]
            },
            'quantum-superposition': {
                title: 'Quantum Superposition',
                questions: [
                    {
                        question: "What does the principle of quantum superposition imply?",
                        options: [
                            { text: "A quantum system can only exist in one definite state at any time.", correct: false },
                            { text: "A quantum system can exist in multiple states simultaneously until a measurement is made.", correct: true },
                            { text: "Quantum particles are always more powerful than classical particles.", correct: false },
                            { text: "The position of a particle is always uncertain.", correct: false }
                        ],
                        feedback: "Correct! Superposition means a system can be in a combination of states at once.",
                        explanation: "For example, an electron can be in a superposition of spin-up and spin-down states until it's measured, at which point it collapses to one specific state."
                    }
                ]
            }
        };

        let currentQuizData = {};
        let currentQuizQuestionIndex = 0;

        function loadQuizForTopic(topicId, topicTitleFromDisplay) {
            currentQuizData = quizzes[topicId];
            currentQuizQuestionIndex = 0;

            if (quizCardTitle) quizCardTitle.innerHTML = `<span class="material-symbols-rounded">quiz</span> Test Your Knowledge: ${currentQuizData ? currentQuizData.title : topicTitleFromDisplay}`;

            if (currentQuizData && currentQuizData.questions && currentQuizData.questions.length > 0) {
                displayCurrentQuizQuestion();
                if (quizCheckAnswerBtn) quizCheckAnswerBtn.style.display = 'inline-flex';
                if (quizNextQuestionBtn) quizNextQuestionBtn.style.display = 'none';
                if (quizFeedbackEl) {
                    quizFeedbackEl.style.display = 'none';
                    quizFeedbackEl.className = 'quiz-feedback';
                    quizFeedbackEl.innerHTML = '';
                }
                if (quizOptionsUl) quizOptionsUl.style.display = 'block'; // Make sure options are visible
            } else {
                if (quizQuestionEl) quizQuestionEl.innerHTML = `<strong>No quiz available for ${topicTitleFromDisplay}.</strong>`;
                if (quizOptionsUl) {
                    quizOptionsUl.innerHTML = ''; // Clear any old options
                    quizOptionsUl.style.display = 'none'; // Hide options area
                }
                if (quizCheckAnswerBtn) quizCheckAnswerBtn.style.display = 'none';
                if (quizNextQuestionBtn) quizNextQuestionBtn.style.display = 'none';
                if (quizFeedbackEl) {
                    quizFeedbackEl.style.display = 'none';
                    quizFeedbackEl.innerHTML = '';
                }
            }
        }

        function displayCurrentQuizQuestion() {
            if (!currentQuizData || !currentQuizData.questions || currentQuizQuestionIndex >= currentQuizData.questions.length) return;

            const q = currentQuizData.questions[currentQuizQuestionIndex];
            if (quizQuestionEl) quizQuestionEl.innerHTML = `<strong>Question ${currentQuizQuestionIndex + 1}:</strong> ${q.question}`;
            if (quizOptionsUl) {
                quizOptionsUl.innerHTML = ''; // Clear previous options
                q.options.forEach(opt => {
                    const li = document.createElement('li');
                    li.className = 'quiz-option';
                    li.textContent = opt.text;
                    li.dataset.correct = opt.correct;
                    li.addEventListener('click', () => {
                        if (quizOptionsUl) quizOptionsUl.querySelectorAll('.quiz-option').forEach(o => o.classList.remove('selected'));
                        li.classList.add('selected');
                    });
                    quizOptionsUl.appendChild(li);
                });
                quizOptionsUl.style.display = 'block'; // Ensure options are visible
            }
            if (quizFeedbackEl) {
                quizFeedbackEl.className = 'quiz-feedback';
                quizFeedbackEl.innerHTML = '';
                quizFeedbackEl.style.display = 'none';
            }
            if (quizCheckAnswerBtn) quizCheckAnswerBtn.style.display = 'inline-flex';
            if (quizNextQuestionBtn) quizNextQuestionBtn.style.display = 'none';
        }

        if (quizCheckAnswerBtn) quizCheckAnswerBtn.onclick = () => {
            const selectedOption = quizOptionsUl ? quizOptionsUl.querySelector('.quiz-option.selected') : null;
            if (!selectedOption) {
                if (quizFeedbackEl) {
                    quizFeedbackEl.innerHTML = 'Please select an answer.';
                    quizFeedbackEl.className = 'quiz-feedback incorrect';
                    quizFeedbackEl.style.display = 'block';
                }
                return;
            }
            if (!currentQuizData || !currentQuizData.questions || currentQuizQuestionIndex >= currentQuizData.questions.length) return;

            const isCorrect = selectedOption.getAttribute('data-correct') === 'true';
            const currentQuestionData = currentQuizData.questions[currentQuizQuestionIndex];
            let feedbackHTML = '';

            if (isCorrect) {
                selectedOption.classList.add('correct');
                feedbackHTML = currentQuestionData.feedback || 'Correct!';
                if (currentQuestionData.explanation) {
                    feedbackHTML += `<br><small style="font-style: italic;">${currentQuestionData.explanation}</small>`;
                }
                if (quizFeedbackEl) quizFeedbackEl.className = 'quiz-feedback correct';
            } else {
                selectedOption.classList.add('incorrect');
                const correctOptionEl = quizOptionsUl.querySelector('.quiz-option[data-correct="true"]');
                if (correctOptionEl) correctOptionEl.classList.add('correct');
                feedbackHTML = (currentQuestionData.feedback ? `Incorrect. The explanation is: ` : 'Incorrect.') + (currentQuestionData.explanation || "The correct answer is highlighted.");
                if (quizFeedbackEl) quizFeedbackEl.className = 'quiz-feedback incorrect';
            }
            if (quizFeedbackEl) {
                quizFeedbackEl.innerHTML = feedbackHTML;
                quizFeedbackEl.style.display = 'block';
            }

            if (quizOptionsUl) quizOptionsUl.querySelectorAll('.quiz-option').forEach(opt => opt.style.pointerEvents = 'none');
            if (quizCheckAnswerBtn) quizCheckAnswerBtn.style.display = 'none';
            if (currentQuizData.questions && currentQuizQuestionIndex < currentQuizData.questions.length - 1) {
                if (quizNextQuestionBtn) quizNextQuestionBtn.style.display = 'inline-flex';
            } else {
                if (quizNextQuestionBtn) quizNextQuestionBtn.style.display = 'none';
                if (quizFeedbackEl && currentQuizData.questions && currentQuizQuestionIndex === currentQuizData.questions.length - 1) {
                    const completionMessage = document.createElement('p');
                    completionMessage.innerHTML = "<strong>Quiz for this topic completed!</strong>";
                    completionMessage.style.marginTop = "1rem";
                    quizFeedbackEl.appendChild(completionMessage);
                }
            }
        };

        if (quizNextQuestionBtn) quizNextQuestionBtn.onclick = () => {
            currentQuizQuestionIndex++;
            if (currentQuizData && currentQuizData.questions && currentQuizQuestionIndex < currentQuizData.questions.length) {
                displayCurrentQuizQuestion();
            } else {
                if (quizQuestionEl) quizQuestionEl.innerHTML = `<strong>Quiz for ${currentQuizData.title} completed!</strong>`;
                if (quizOptionsUl) quizOptionsUl.innerHTML = '';
                if (quizCheckAnswerBtn) quizCheckAnswerBtn.style.display = 'none';
                if (quizNextQuestionBtn) quizNextQuestionBtn.style.display = 'none';
                if (quizFeedbackEl) {
                    quizFeedbackEl.innerHTML = 'You have completed all questions for this topic.';
                    quizFeedbackEl.className = 'quiz-feedback correct'; // Or neutral
                    quizFeedbackEl.style.display = 'block';
                }
            }
        };


        // Notes functionality
        const notesTextarea = document.querySelector('.notes-textarea');
        const notesTitleEl = document.querySelector('.notes-container .notes-title'); // Assuming one notes area
        let currentNotesTopicKey = '';

        function setupNotesForTopic(topicId, topicTitleFromDisplay) {
            currentNotesTopicKey = `quantumNotes_${topicId}`;
            if (notesTitleEl) notesTitleEl.textContent = `Your Notes on ${topicTitleFromDisplay}`;
            if (notesTextarea) notesTextarea.value = localStorage.getItem(currentNotesTopicKey) || '';
        }
        // Save notes (example, actual save logic for clear/save buttons would be separate)
        if (notesTextarea) {
            notesTextarea.addEventListener('blur', () => {
                if (currentNotesTopicKey) { // Ensure a topic is set
                    localStorage.setItem(currentNotesTopicKey, notesTextarea.value);
                }
            });
        }
        const saveNotesBtn = document.getElementById('saveNotesBtn');
        if (saveNotesBtn && notesTextarea) {
            saveNotesBtn.addEventListener('click', () => {
                if (currentNotesTopicKey) {
                    localStorage.setItem(currentNotesTopicKey, notesTextarea.value);
                    alert('Notes saved!'); // Simple feedback
                } else {
                    alert('No topic selected for notes.');
                }
            });
        }
        const clearNotesBtn = document.getElementById('clearNotesBtn');
        if (clearNotesBtn && notesTextarea) {
            clearNotesBtn.addEventListener('click', () => {
                notesTextarea.value = '';
                if (currentNotesTopicKey) {
                    localStorage.removeItem(currentNotesTopicKey);
                    alert('Notes cleared!');
                }
            });
        }


        // Glossary search
        const glossarySearch = document.getElementById('glossarySearch');
        const glossaryList = document.getElementById('glossaryList');

        if (glossarySearch && glossaryList) {
            const glossaryItems = glossaryList.querySelectorAll('.glossary-item');
            glossarySearch.addEventListener('input', () => {
                const searchTerm = glossarySearch.value.toLowerCase();
                glossaryItems.forEach(item => {
                    const term = item.querySelector('.glossary-term').textContent.toLowerCase();
                    const definition = item.querySelector('.glossary-definition').textContent.toLowerCase();
                    if (term.includes(searchTerm) || definition.includes(searchTerm)) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        }

        // Modal for term definitions
        const modal = document.getElementById('termModal');
        const modalTitle = document.getElementById('modalTitle');
        const modalBody = document.getElementById('modalBody');
        const modalClose = document.getElementById('modalClose');
        const modalOkBtn = document.getElementById('modalOkBtn');

        if (modal && modalClose && modalOkBtn) {
            modalClose.addEventListener('click', () => modal.classList.remove('active'));
            modalOkBtn.addEventListener('click', () => modal.classList.remove('active'));
            window.addEventListener('click', (e) => {
                if (e.target === modal) modal.classList.remove('active');
            });
        }

        document.querySelectorAll('.highlighted-term').forEach(term => {
            term.addEventListener('click', () => {
                const tooltip = term.querySelector('.tooltip'); // Tooltip might be for hover, modal for click
                if (modal && modalTitle && modalBody) {
                    modalTitle.textContent = term.textContent.replace(/\s+/g, ' ').trim().split(/\n/)[0]; // Get term text
                    // Find definition for modal (could be from tooltip or a data attribute)
                    modalBody.textContent = tooltip ? tooltip.textContent : "Definition not found.";
                    modal.classList.add('active');
                }
            });
        });

        // Navigation menu items in header
        document.querySelectorAll('header nav ul li a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('header nav ul li a').forEach(l => l.classList.remove('active'));
                link.classList.add('active');
                const text = link.textContent.trim();
                if (text === 'Home') {
                    document.querySelector('[data-tab="overview"]').click();
                } else if (text === 'Concepts') {
                    document.querySelectorAll('.sidebar-nav-item')[1].classList.add('open'); // Assumes "Fundamental Concepts" is 2nd
                    document.querySelectorAll('.sidebar-nav-item')[1].querySelectorAll('.sidebar-subnav-link')[0].click();
                } else if (text === 'Simulations') {
                    // Find the "Fundamental Concepts" category in sidebar
                    const fundConceptsLink = Array.from(document.querySelectorAll('.sidebar-nav-link')).find(sl => getVisibleTextContent(sl).includes('Fundamental Concepts'));
                    if (fundConceptsLink) {
                        const subLinkForSim = fundConceptsLink.closest('.sidebar-nav-item').querySelector('.sidebar-subnav-link[data-topic-id="wave-particle-duality"]');
                        if (subLinkForSim) {
                            subLinkForSim.click(); // This will navigate to Learn tab and select wave-particle duality
                        } else { // Fallback to clicking category if specific sublink not found
                            fundConceptsLink.click();
                            // Then click the first sub-link
                            const firstSub = fundConceptsLink.closest('.sidebar-nav-item').querySelector('.sidebar-subnav-link');
                            if (firstSub) firstSub.click();
                        }
                    }
                    // Ensure Learn tab is active
                    const learnTab = document.querySelector('[data-tab="learn"]');
                    if (learnTab && !learnTab.classList.contains('active')) {
                        learnTab.click();
                    }
                    // Scroll to simulation (might need to be more specific if multiple sims on page)
                    setTimeout(() => { // Timeout to allow content to render
                        const simContainer = document.getElementById('simulationFundConcepts') || document.querySelector('.simulation-container');
                        if (simContainer) simContainer.scrollIntoView({ behavior: 'smooth' });
                    }, 100);

                } else if (text === 'Glossary') {
                    const glossaryContainer = document.querySelector('.glossary-container');
                    if (glossaryContainer) glossaryContainer.scrollIntoView({ behavior: 'smooth' });
                }
            });
        });

        // Call initializeApp after the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>

</html>