<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleep & Academic Performance Analysis</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        :root {
            --primary: #6366f1;
            --primary-light: #818cf8;
            --primary-dark: #4f46e5;
            --secondary: #22c55e;
            --secondary-light: #4ade80;
            --secondary-dark: #16a34a;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-500: #6b7280;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --radius-sm: 0.125rem;
            --radius: 0.25rem;
            --radius-md: 0.375rem;
            --radius-lg: 0.5rem;
            --radius-xl: 0.75rem;
            --radius-2xl: 1rem;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            line-height: 1.6;
            color: var(--gray-800);
            background-color: var(--gray-100);
        }

        .app-container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 2rem;
        }

        .header {
            margin-bottom: 2rem;
            text-align: center;
        }

        .header h1 {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--gray-900);
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.1rem;
            color: var(--gray-600);
            max-width: 800px;
            margin: 0 auto;
        }

        .workflow-container {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .workflow-step {
            flex: 1;
            padding: 1.5rem;
            background-color: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            display: flex;
            align-items: center;
            gap: 1rem;
            position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .workflow-step:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .workflow-step:not(:last-child)::after {
            content: '';
            position: absolute;
            right: -0.75rem;
            top: 50%;
            transform: translateY(-50%);
            width: 0.5rem;
            height: 0.5rem;
            border-top: 2px solid var(--gray-400);
            border-right: 2px solid var(--gray-400);
            transform: translateY(-50%) rotate(45deg);
        }

        .workflow-step-number {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 50%;
            background-color: var(--primary-light);
            color: white;
            font-weight: 600;
            font-size: 1.25rem;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }

        .workflow-step:hover .workflow-step-number {
            background-color: var(--primary);
            transform: scale(1.1);
        }

        .workflow-step-content h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
            color: var(--gray-900);
        }

        .workflow-step-content p {
            font-size: 0.9rem;
            color: var(--gray-600);
        }

        .workflow-active {
            border-left: 4px solid var(--primary);
        }

        .card {
            background-color: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            transition: box-shadow 0.3s ease;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.25rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--gray-200);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--gray-900);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-title .material-symbols-rounded {
            color: var(--primary);
        }

        .upload-area {
            border: 2px dashed var(--gray-300);
            border-radius: var(--radius-lg);
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .upload-area:hover {
            border-color: var(--primary-light);
            background-color: var(--gray-100);
            transform: translateY(-3px);
        }

        .upload-icon {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 1rem;
            transition: transform 0.3s ease;
        }

        .upload-area:hover .upload-icon {
            transform: scale(1.1);
        }

        .upload-text {
            font-size: 1.1rem;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 0.5rem;
        }

        .upload-description {
            color: var(--gray-500);
            margin-bottom: 1.5rem;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            font-size: 0.875rem;
            font-weight: 500;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            position: relative;
            overflow: hidden;
        }

        .btn::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background-color: rgba(255, 255, 255, 0.2);
            transform: translateY(100%);
            transition: transform 0.2s ease;
        }

        .btn:hover::after {
            transform: translateY(0);
        }

        .btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
        }

        .btn-primary {
            background-color: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--gray-200);
            color: var(--gray-700);
        }

        .btn-secondary:hover {
            background-color: var(--gray-300);
        }

        .btn-success {
            background-color: var(--secondary);
            color: white;
        }

        .btn-success:hover {
            background-color: var(--secondary-dark);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn:disabled::after {
            display: none;
        }

        .data-preview {
            margin-top: 1.5rem;
            overflow: auto;
            max-height: 300px;
            display: none;
            border-radius: var(--radius-md);
            border: 1px solid var(--gray-200);
            transition: box-shadow 0.3s ease;
        }

        .data-preview:hover {
            box-shadow: var(--shadow-sm);
        }

        .data-preview.active {
            display: block;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th, .data-table td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--gray-200);
        }

        .data-table th {
            background-color: var(--gray-100);
            font-weight: 600;
            color: var(--gray-700);
            position: sticky;
            top: 0;
            z-index: 1;
        }

        .data-table tr:hover {
            background-color: var(--gray-100);
        }

        .variable-selection {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }

        .variable-group {
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            transition: box-shadow 0.3s ease, transform 0.3s ease;
        }

        .variable-group:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-3px);
        }

        .variable-group-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--gray-800);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .variable-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .variable-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .variable-checkbox {
            appearance: none;
            width: 1.25rem;
            height: 1.25rem;
            border: 2px solid var(--gray-400);
            border-radius: var(--radius-sm);
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .variable-checkbox:checked {
            background-color: var(--primary);
            border-color: var(--primary);
        }

        .variable-checkbox:checked::after {
            content: '';
            position: absolute;
            left: 5px;
            top: 2px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        .variable-checkbox:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3);
        }

        .variable-label {
            font-size: 0.95rem;
            color: var(--gray-700);
            cursor: pointer;
            transition: color 0.2s ease;
        }

        .variable-label:hover {
            color: var(--primary);
        }

        .analysis-type {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .analysis-option {
            flex: 1;
            min-width: 200px;
            border: 1px solid var(--gray-200);
            border-radius: var(--radius-lg);
            padding: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .analysis-option:hover {
            border-color: var(--primary-light);
            background-color: var(--gray-100);
            transform: translateY(-3px);
        }

        .analysis-option.selected {
            border-color: var(--primary);
            background-color: rgba(99, 102, 241, 0.05);
        }

        .analysis-option-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--gray-800);
        }

        .analysis-option-description {
            font-size: 0.875rem;
            color: var(--gray-600);
        }

        .chart-container {
            height: 400px;
            position: relative;
            margin-top: 1.5rem;
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow);
            transition: box-shadow 0.3s ease;
        }

        .chart-container:hover {
            box-shadow: var(--shadow-md);
        }

        .floating-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 1rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-md);
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 10;
            max-width: 250px;
        }

        .floating-controls.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        .control-group {
            margin-bottom: 0.75rem;
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--gray-700);
            margin-bottom: 0.375rem;
        }

        .control-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            font-size: 0.875rem;
            transition: all 0.2s ease;
        }

        .control-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
        }

        .results-container {
            margin-top: 2rem;
        }

        .results-summary {
            margin-bottom: 1.5rem;
            padding: 1.25rem;
            background-color: rgba(99, 102, 241, 0.05);
            border-radius: var(--radius-lg);
            border-left: 4px solid var(--primary);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .results-summary:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .results-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--gray-900);
        }

        .results-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-dark);
            margin-bottom: 0.5rem;
        }

        .results-description {
            font-size: 0.95rem;
            color: var(--gray-600);
        }

        .correlation-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
        }

        .correlation-table th, .correlation-table td {
            padding: 0.75rem 1rem;
            text-align: center;
            border: 1px solid var(--gray-200);
            transition: background-color 0.2s ease;
        }

        .correlation-table th {
            background-color: var(--gray-100);
            font-weight: 600;
            color: var(--gray-700);
        }

        .correlation-strong-positive {
            background-color: rgba(34, 197, 94, 0.2);
        }

        .correlation-moderate-positive {
            background-color: rgba(34, 197, 94, 0.1);
        }

        .correlation-weak-positive {
            background-color: rgba(34, 197, 94, 0.05);
        }

        .correlation-none {
            background-color: rgba(156, 163, 175, 0.05);
        }

        .correlation-weak-negative {
            background-color: rgba(239, 68, 68, 0.05);
        }

        .correlation-moderate-negative {
            background-color: rgba(239, 68, 68, 0.1);
        }

        .correlation-strong-negative {
            background-color: rgba(239, 68, 68, 0.2);
        }

        .correlation-table td:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-sm);
            z-index: 1;
            position: relative;
        }

        .hidden {
            display: none;
        }

        .action-buttons {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
            justify-content: flex-end;
        }

        .tooltip {
            position: absolute;
            background-color: rgba(31, 41, 55, 0.9);
            color: white;
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius);
            font-size: 0.875rem;
            z-index: 20;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease, transform 0.2s ease;
            max-width: 250px;
            transform: translateY(10px);
            box-shadow: var(--shadow-md);
        }

        .tooltip.active {
            opacity: 1;
            transform: translateY(0);
        }

        .loader {
            display: inline-block;
            width: 50px;
            height: 50px;
            border: 3px solid var(--gray-300);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            text-align: center;
        }

        .loading-text {
            margin-top: 1rem;
            font-size: 1rem;
            color: var(--gray-600);
        }

        .data-summary {
            background-color: var(--gray-100);
            border-radius: var(--radius-lg);
            padding: 1rem;
            margin-top: 1rem;
            border-left: 3px solid var(--primary);
            font-size: 0.9rem;
            color: var(--gray-700);
        }

        .help-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: var(--gray-300);
            color: var(--gray-700);
            font-size: 12px;
            margin-left: 0.5rem;
            cursor: help;
            transition: background-color 0.2s ease;
        }

        .help-icon:hover {
            background-color: var(--primary-light);
            color: white;
        }

        .tab-container {
            margin-top: 1.5rem;
        }

        .tab-nav {
            display: flex;
            border-bottom: 1px solid var(--gray-200);
            margin-bottom: 1rem;
        }

        .tab-button {
            padding: 0.75rem 1.25rem;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--gray-600);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .tab-button:hover {
            color: var(--gray-900);
        }

        .tab-button.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .download-options {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .download-btn {
            padding: 0.5rem 0.75rem;
            font-size: 0.8rem;
            background-color: var(--gray-100);
            border: 1px solid var(--gray-300);
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .download-btn:hover {
            background-color: var(--gray-200);
        }

        .progress {
            width: 100%;
            height: 8px;
            background-color: var(--gray-200);
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-bar {
            height: 100%;
            background-color: var(--primary);
            width: 0%;
            transition: width 0.3s ease;
        }

        @media (max-width: 768px) {
            .app-container {
                padding: 1rem;
            }

            .workflow-container {
                flex-direction: column;
            }

            .workflow-step:not(:last-child)::after {
                display: none;
            }

            .variable-selection {
                grid-template-columns: 1fr;
            }

            .analysis-type {
                flex-direction: column;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }

        @media (prefers-color-scheme: dark) {
            :root {
                --primary: #818cf8;
                --primary-light: #a5b4fc;
                --primary-dark: #6366f1;
                --secondary: #4ade80;
                --secondary-light: #86efac;
                --secondary-dark: #22c55e;
                --gray-100: #1f2937;
                --gray-200: #374151;
                --gray-300: #4b5563;
                --gray-400: #6b7280;
                --gray-500: #9ca3af;
                --gray-600: #d1d5db;
                --gray-700: #e5e7eb;
                --gray-800: #f3f4f6;
                --gray-900: #f9fafb;
            }

            body {
                background-color: #111827;
            }

            .workflow-step, .card, .upload-area {
                background-color: var(--gray-100);
            }

            .data-table th {
                background-color: #111827;
            }

            .correlation-strong-positive {
                background-color: rgba(34, 197, 94, 0.3);
            }

            .correlation-moderate-positive {
                background-color: rgba(34, 197, 94, 0.2);
            }

            .correlation-weak-positive {
                background-color: rgba(34, 197, 94, 0.1);
            }

            .correlation-none {
                background-color: rgba(156, 163, 175, 0.1);
            }

            .correlation-weak-negative {
                background-color: rgba(239, 68, 68, 0.1);
            }

            .correlation-moderate-negative {
                background-color: rgba(239, 68, 68, 0.2);
            }

            .correlation-strong-negative {
                background-color: rgba(239, 68, 68, 0.3);
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header class="header">
            <h1>Sleep & Academic Performance Analysis</h1>
            <p>Upload your study data to analyze and visualize the relationship between sleep patterns and academic performance among university students.</p>
        </header>

        <div class="workflow-container">
            <div class="workflow-step workflow-active" tabindex="0" role="button" aria-pressed="true">
                <div class="workflow-step-number">1</div>
                <div class="workflow-step-content">
                    <h3>Upload Data</h3>
                    <p>Upload your CSV file with sleep and academic data</p>
                </div>
            </div>
            <div class="workflow-step" tabindex="0" role="button" aria-pressed="false">
                <div class="workflow-step-number">2</div>
                <div class="workflow-step-content">
                    <h3>Select Variables</h3>
                    <p>Choose variables to analyze</p>
                </div>
            </div>
            <div class="workflow-step" tabindex="0" role="button" aria-pressed="false">
                <div class="workflow-step-number">3</div>
                <div class="workflow-step-content">
                    <h3>Analyze Data</h3>
                    <p>Run statistical analysis</p>
                </div>
            </div>
            <div class="workflow-step" tabindex="0" role="button" aria-pressed="false">
                <div class="workflow-step-number">4</div>
                <div class="workflow-step-content">
                    <h3>Visualize Results</h3>
                    <p>Generate interactive visualizations</p>
                </div>
            </div>
        </div>

        <div class="card" id="upload-card">
            <div class="card-header">
                <h2 class="card-title">
                    <span class="material-symbols-rounded">upload_file</span>
                    Upload Your Data
                </h2>
                <button class="btn btn-secondary" id="sample-data-btn" aria-label="Load sample data">
                    <span class="material-symbols-rounded">science</span>
                    Load Sample Data
                </button>
            </div>
            <div class="upload-area" id="drop-area" tabindex="0" role="button" aria-label="Upload file area">
                <span class="material-symbols-rounded upload-icon">cloud_upload</span>
                <p class="upload-text">Drag & drop your CSV file here</p>
                <p class="upload-description">or click the button below to browse files</p>
                <input type="file" id="file-input" accept=".csv" style="display: none;" aria-label="Upload CSV file">
                <button class="btn btn-primary" id="browse-btn">
                    <span class="material-symbols-rounded">folder_open</span>
                    Browse Files
                </button>
            </div>
            <div class="data-summary" id="data-summary"></div>
            <div class="data-preview" id="data-preview">
                <div class="tab-container">
                    <div class="tab-nav">
                        <button class="tab-button active" data-tab="table-view">Table View</button>
                        <button class="tab-button" data-tab="summary-view">Summary Statistics</button>
                    </div>
                    <div class="tab-content active" id="table-view">
                        <table class="data-table" id="data-table">
                            <thead>
                                <tr id="table-header"></tr>
                            </thead>
                            <tbody id="table-body"></tbody>
                        </table>
                    </div>
                    <div class="tab-content" id="summary-view">
                        <table class="data-table" id="summary-table">
                            <thead>
                                <tr>
                                    <th>Variable</th>
                                    <th>Min</th>
                                    <th>Max</th>
                                    <th>Mean</th>
                                    <th>Median</th>
                                    <th>Std Dev</th>
                                </tr>
                            </thead>
                            <tbody id="summary-body"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="action-buttons">
                <button class="btn btn-secondary" id="clear-data-btn" disabled aria-label="Clear data">
                    <span class="material-symbols-rounded">delete</span>
                    Clear Data
                </button>
                <button class="btn btn-primary" id="continue-btn" disabled>
                    Continue to Variable Selection
                    <span class="material-symbols-rounded">arrow_forward</span>
                </button>
            </div>
        </div>

        <div class="card hidden" id="variables-card">
            <div class="card-header">
                <h2 class="card-title">
                    <span class="material-symbols-rounded">tune</span>
                    Select Variables for Analysis
                </h2>
            </div>
            <p>Select at least one sleep variable and one academic variable to analyze their relationship.</p>
            <div class="variable-selection">
                <div class="variable-group">
                    <h3 class="variable-group-title">
                        <span class="material-symbols-rounded">bed</span>
                        Sleep Variables
                        <span class="help-icon" tabindex="0" role="button" aria-label="Help for sleep variables" data-tooltip="Variables related to sleep patterns, quality, and habits">?</span>
                    </h3>
                    <div class="variable-list" id="sleep-variables">
                        <!-- Sleep variables will be dynamically added here -->
                    </div>
                </div>
                <div class="variable-group">
                    <h3 class="variable-group-title">
                        <span class="material-symbols-rounded">school</span>
                        Academic Variables
                        <span class="help-icon" tabindex="0" role="button" aria-label="Help for academic variables" data-tooltip="Variables related to academic performance and study habits">?</span>
                    </h3>
                    <div class="variable-list" id="academic-variables">
                        <!-- Academic variables will be dynamically added here -->
                    </div>
                </div>
            </div>
            <div class="action-buttons">
                <button class="btn btn-secondary" id="back-to-upload-btn">
                    <span class="material-symbols-rounded">arrow_back</span>
                    Back to Upload
                </button>
                <button class="btn btn-primary" id="analyze-btn" disabled>
                    Continue to Analysis
                    <span class="material-symbols-rounded">arrow_forward</span>
                </button>
            </div>
        </div>

        <div class="card hidden" id="analysis-card">
            <div class="card-header">
                <h2 class="card-title">
                    <span class="material-symbols-rounded">analytics</span>
                    Data Analysis
                </h2>
            </div>
            <h3>Select Analysis Type</h3>
            <div class="analysis-type">
                <div class="analysis-option" data-type="correlation" tabindex="0" role="button" aria-pressed="false">
                    <h4 class="analysis-option-title">Correlation Analysis</h4>
                    <p class="analysis-option-description">Measure the strength and direction of relationships between sleep and academic variables.</p>
                </div>
                <div class="analysis-option" data-type="comparison" tabindex="0" role="button" aria-pressed="false">
                    <h4 class="analysis-option-title">Group Comparison</h4>
                    <p class="analysis-option-description">Compare academic performance between different sleep quality groups.</p>
                </div>
                <div class="analysis-option" data-type="regression" tabindex="0" role="button" aria-pressed="false">
                    <h4 class="analysis-option-title">Regression Analysis</h4>
                    <p class="analysis-option-description">Predict academic performance based on sleep variables.</p>
                </div>
            </div>

            <div class="results-container hidden" id="results-container">
                <div id="loading-container" class="loading-container">
                    <div class="loader"></div>
                    <p class="loading-text">Analyzing your data...</p>
                    <div class="progress">
                        <div class="progress-bar" id="analysis-progress"></div>
                    </div>
                </div>
                
                <div class="results-summary" id="results-summary">
                    <h3 class="results-title">Analysis Results</h3>
                    <div id="results-content"></div>
                </div>

                <div class="chart-container">
                    <canvas id="results-chart"></canvas>
                    <div class="floating-controls" id="chart-controls">
                        <div class="control-group">
                            <label class="control-label" for="chart-type">Chart Type</label>
                            <select class="control-input" id="chart-type">
                                <option value="scatter">Scatter Plot</option>
                                <option value="bar">Bar Chart</option>
                                <option value="line">Line Chart</option>
                                <option value="bubble">Bubble Chart</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label class="control-label" for="color-scheme">Color Scheme</label>
                            <select class="control-input" id="color-scheme">
                                <option value="default">Default</option>
                                <option value="blues">Blues</option>
                                <option value="greens">Greens</option>
                                <option value="purples">Purples</option>
                                <option value="oranges">Oranges</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label class="control-label" for="show-trendline">Show Trendline</label>
                            <input type="checkbox" id="show-trendline" checked>
                        </div>
                        <div class="control-group">
                            <label class="control-label" for="point-size">Point Size</label>
                            <input type="range" class="control-input" id="point-size" min="2" max="10" value="5">
                        </div>
                        <div class="control-group">
                            <label class="control-label">Download Chart</label>
                            <div class="download-options">
                                <button class="download-btn" id="download-png">
                                    <span class="material-symbols-rounded">image</span>
                                    PNG
                                </button>
                                <button class="download-btn" id="download-jpg">
                                    <span class="material-symbols-rounded">image</span>
                                    JPG
                                </button>
                                <button class="download-btn" id="download-pdf">
                                    <span class="material-symbols-rounded">picture_as_pdf</span>
                                    PDF
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="action-buttons">
                <button class="btn btn-secondary" id="back-to-variables-btn">
                    <span class="material-symbols-rounded">arrow_back</span>
                    Back to Variables
                </button>
                <button class="btn btn-primary" id="run-analysis-btn" disabled>
                    <span class="material-symbols-rounded">play_arrow</span>
                    Run Analysis
                </button>
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script type="module">
        import { Chart } from "https://esm.sh/chart.js/auto";
        import Papa from "https://esm.sh/papaparse";

        // Application state
        const state = {
            data: null,
            headers: [],
            selectedSleepVariables: [],
            selectedAcademicVariables: [],
            analysisType: null,
            results: null,
            chart: null
        };

        // DOM elements
        const elements = {
            // Upload section
            uploadCard: document.getElementById('upload-card'),
            dropArea: document.getElementById('drop-area'),
            fileInput: document.getElementById('file-input'),
            browseBtn: document.getElementById('browse-btn'),
            sampleDataBtn: document.getElementById('sample-data-btn'),
            dataPreview: document.getElementById('data-preview'),
            dataSummary: document.getElementById('data-summary'),
            dataTable: document.getElementById('data-table'),
            tableHeader: document.getElementById('table-header'),
            tableBody: document.getElementById('table-body'),
            summaryTable: document.getElementById('summary-table'),
            summaryBody: document.getElementById('summary-body'),
            clearDataBtn: document.getElementById('clear-data-btn'),
            continueBtn: document.getElementById('continue-btn'),
            tabButtons: document.querySelectorAll('.tab-button'),
            tabContents: document.querySelectorAll('.tab-content'),
            
            // Variables section
            variablesCard: document.getElementById('variables-card'),
            sleepVariables: document.getElementById('sleep-variables'),
            academicVariables: document.getElementById('academic-variables'),
            backToUploadBtn: document.getElementById('back-to-upload-btn'),
            analyzeBtn: document.getElementById('analyze-btn'),
            helpIcons: document.querySelectorAll('.help-icon'),
            
            // Analysis section
            analysisCard: document.getElementById('analysis-card'),
            analysisOptions: document.querySelectorAll('.analysis-option'),
            resultsContainer: document.getElementById('results-container'),
            loadingContainer: document.getElementById('loading-container'),
            analysisProgress: document.getElementById('analysis-progress'),
            resultsSummary: document.getElementById('results-summary'),
            resultsContent: document.getElementById('results-content'),
            resultsChart: document.getElementById('results-chart'),
            chartControls: document.getElementById('chart-controls'),
            chartType: document.getElementById('chart-type'),
            colorScheme: document.getElementById('color-scheme'),
            showTrendline: document.getElementById('show-trendline'),
            pointSize: document.getElementById('point-size'),
            downloadPng: document.getElementById('download-png'),
            downloadJpg: document.getElementById('download-jpg'),
            downloadPdf: document.getElementById('download-pdf'),
            backToVariablesBtn: document.getElementById('back-to-variables-btn'),
            runAnalysisBtn: document.getElementById('run-analysis-btn'),
            
            // Workflow steps
            workflowSteps: document.querySelectorAll('.workflow-step'),
            
            // Tooltip
            tooltip: document.getElementById('tooltip')
        };

        // Initialize event listeners
        function initEventListeners() {
            // File upload events
            elements.browseBtn.addEventListener('click', () => elements.fileInput.click());
            elements.fileInput.addEventListener('change', handleFileUpload);
            elements.sampleDataBtn.addEventListener('click', loadSampleData);
            elements.dropArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                elements.dropArea.style.borderColor = 'var(--primary)';
                elements.dropArea.style.backgroundColor = 'rgba(99, 102, 241, 0.05)';
            });
            elements.dropArea.addEventListener('dragleave', () => {
                elements.dropArea.style.borderColor = 'var(--gray-300)';
                elements.dropArea.style.backgroundColor = '';
            });
            elements.dropArea.addEventListener('drop', (e) => {
                e.preventDefault();
                elements.dropArea.style.borderColor = 'var(--gray-300)';
                elements.dropArea.style.backgroundColor = '';
                if (e.dataTransfer.files.length) {
                    handleFileUpload({ target: { files: e.dataTransfer.files } });
                }
            });
            elements.dropArea.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    elements.fileInput.click();
                }
            });
            elements.clearDataBtn.addEventListener('click', clearData);
            elements.continueBtn.addEventListener('click', goToVariableSelection);
            
            // Tab navigation
            elements.tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.dataset.tab;
                    elements.tabButtons.forEach(btn => btn.classList.remove('active'));
                    elements.tabContents.forEach(content => content.classList.remove('active'));
                    button.classList.add('active');
                    document.getElementById(tabId).classList.add('active');
                });
            });
            
            // Help tooltips
            elements.helpIcons.forEach(icon => {
                icon.addEventListener('mouseenter', (e) => {
                    showTooltip(e, icon.dataset.tooltip);
                });
                icon.addEventListener('mouseleave', hideTooltip);
                icon.addEventListener('focus', (e) => {
                    showTooltip(e, icon.dataset.tooltip);
                });
                icon.addEventListener('blur', hideTooltip);
                icon.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        hideTooltip();
                    }
                });
            });
            
            // Variable selection events
            elements.backToUploadBtn.addEventListener('click', goToUpload);
            elements.analyzeBtn.addEventListener('click', goToAnalysis);
            
            // Analysis events
            elements.analysisOptions.forEach(option => {
                option.addEventListener('click', () => {
                    elements.analysisOptions.forEach(o => {
                        o.classList.remove('selected');
                        o.setAttribute('aria-pressed', 'false');
                    });
                    option.classList.add('selected');
                    option.setAttribute('aria-pressed', 'true');
                    state.analysisType = option.dataset.type;
                    elements.runAnalysisBtn.disabled = false;
                });
                option.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        option.click();
                    }
                });
            });
            elements.backToVariablesBtn.addEventListener('click', goToVariableSelection);
            elements.runAnalysisBtn.addEventListener('click', runAnalysis);
            
            // Chart control events
            elements.resultsChart.addEventListener('click', () => {
                elements.chartControls.classList.toggle('active');
            });
            document.addEventListener('click', (e) => {
                if (!e.target.closest('#chart-controls') && !e.target.closest('#results-chart')) {
                    elements.chartControls.classList.remove('active');
                }
            });
            elements.chartType.addEventListener('change', updateChart);
            elements.colorScheme.addEventListener('change', updateChart);
            elements.showTrendline.addEventListener('change', updateChart);
            elements.pointSize.addEventListener('input', updateChart);
            elements.downloadPng.addEventListener('click', () => downloadChart('png'));
            elements.downloadJpg.addEventListener('click', () => downloadChart('jpg'));
            elements.downloadPdf.addEventListener('click', () => downloadChart('pdf'));
            
            // Workflow steps navigation
            elements.workflowSteps.forEach((step, index) => {
                step.addEventListener('click', () => {
                    if (index === 0) goToUpload();
                    else if (index === 1 && !elements.continueBtn.disabled) goToVariableSelection();
                    else if (index === 2 && !elements.analyzeBtn.disabled) goToAnalysis();
                });
                step.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        step.click();
                    }
                });
            });
            
            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                // Alt + 1-4 for workflow steps
                if (e.altKey && e.key >= '1' && e.key <= '4') {
                    e.preventDefault();
                    const index = parseInt(e.key) - 1;
                    elements.workflowSteps[index].click();
                }
                
                // Ctrl + S for sample data
                if (e.ctrlKey && e.key === 's' && !elements.uploadCard.classList.contains('hidden')) {
                    e.preventDefault();
                    loadSampleData();
                }
                
                // Ctrl + R for run analysis
                if (e.ctrlKey && e.key === 'r' && !elements.analysisCard.classList.contains('hidden') && !elements.runAnalysisBtn.disabled) {
                    e.preventDefault();
                    runAnalysis();
                }
            });
        }

        // Handle file upload
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
                alert('Please upload a CSV file.');
                return;
            }
            
            // Show progress
            elements.dataSummary.innerHTML = `<div class="loading-container">
                <div class="loader"></div>
                <p class="loading-text">Parsing ${file.name}...</p>
            </div>`;
            
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    if (results.data.length === 0) {
                        alert('The uploaded file does not contain any data.');
                        elements.dataSummary.innerHTML = '';
                        return;
                    }
                    
                    state.data = results.data;
                    state.headers = results.meta.fields;
                    
                    renderDataPreview();
                    renderDataSummary();
                    elements.clearDataBtn.disabled = false;
                    elements.continueBtn.disabled = false;
                    elements.dataPreview.classList.add('active');
                },
                error: function(error) {
                    alert('Error parsing CSV file: ' + error.message);
                    elements.dataSummary.innerHTML = '';
                }
            });
        }

        // Render data preview table
        function renderDataPreview() {
            // Clear existing table
            elements.tableHeader.innerHTML = '';
            elements.tableBody.innerHTML = '';
            
            // Add headers
            state.headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                th.setAttribute('scope', 'col');
                elements.tableHeader.appendChild(th);
            });
            
            // Add data rows (limited to 10 rows for preview)
            const previewData = state.data.slice(0, 10);
            previewData.forEach((row, index) => {
                const tr = document.createElement('tr');
                state.headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = row[header];
                    tr.appendChild(td);
                });
                elements.tableBody.appendChild(tr);
            });
            
            if (state.data.length > 10) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = state.headers.length;
                td.textContent = `... ${state.data.length - 10} more rows`;
                td.style.textAlign = 'center';
                td.style.fontStyle = 'italic';
                td.style.color = 'var(--gray-500)';
                tr.appendChild(td);
                elements.tableBody.appendChild(tr);
            }
            
            // Generate summary statistics
            renderSummaryStatistics();
        }

        // Render data summary
        function renderDataSummary() {
            elements.dataSummary.innerHTML = `
                <p><strong>File loaded successfully:</strong> ${state.data.length} rows, ${state.headers.length} columns</p>
                <p>Preview showing first 10 rows. Use the tabs below to view data or summary statistics.</p>
            `;
        }

        // Render summary statistics
        function renderSummaryStatistics() {
            elements.summaryBody.innerHTML = '';
            
            state.headers.forEach(header => {
                const values = state.data
                    .map(row => row[header])
                    .filter(val => val !== null && val !== undefined && !isNaN(val));
                
                if (values.length === 0) return;
                
                // Calculate statistics
                const min = Math.min(...values);
                const max = Math.max(...values);
                const sum = values.reduce((a, b) => a + b, 0);
                const mean = sum / values.length;
                
                // Sort values for median
                const sortedValues = [...values].sort((a, b) => a - b);
                const median = sortedValues.length % 2 === 0 
                    ? (sortedValues[sortedValues.length / 2 - 1] + sortedValues[sortedValues.length / 2]) / 2
                    : sortedValues[Math.floor(sortedValues.length / 2)];
                
                // Calculate standard deviation
                const squaredDiffs = values.map(val => Math.pow(val - mean, 2));
                const variance = squaredDiffs.reduce((a, b) => a + b, 0) / values.length;
                const stdDev = Math.sqrt(variance);
                
                // Create row
                const tr = document.createElement('tr');
                
                const tdHeader = document.createElement('td');
                tdHeader.textContent = header;
                tdHeader.style.fontWeight = '600';
                
                const tdMin = document.createElement('td');
                tdMin.textContent = min.toFixed(2);
                
                const tdMax = document.createElement('td');
                tdMax.textContent = max.toFixed(2);
                
                const tdMean = document.createElement('td');
                tdMean.textContent = mean.toFixed(2);
                
                const tdMedian = document.createElement('td');
                tdMedian.textContent = median.toFixed(2);
                
                const tdStdDev = document.createElement('td');
                tdStdDev.textContent = stdDev.toFixed(2);
                
                tr.appendChild(tdHeader);
                tr.appendChild(tdMin);
                tr.appendChild(tdMax);
                tr.appendChild(tdMean);
                tr.appendChild(tdMedian);
                tr.appendChild(tdStdDev);
                
                elements.summaryBody.appendChild(tr);
            });
        }

        // Clear uploaded data
        function clearData() {
            state.data = null;
            state.headers = [];
            state.selectedSleepVariables = [];
            state.selectedAcademicVariables = [];
            state.analysisType = null;
            state.results = null;
            
            elements.fileInput.value = '';
            elements.tableHeader.innerHTML = '';
            elements.tableBody.innerHTML = '';
            elements.summaryBody.innerHTML = '';
            elements.dataSummary.innerHTML = '';
            elements.dataPreview.classList.remove('active');
            elements.clearDataBtn.disabled = true;
            elements.continueBtn.disabled = true;
        }

        // Navigation functions
        function goToUpload() {
            elements.variablesCard.classList.add('hidden');
            elements.analysisCard.classList.add('hidden');
            elements.uploadCard.classList.remove('hidden');
            updateWorkflowSteps(0);
        }

        function goToVariableSelection() {
            // If coming from upload, populate variable lists
            if (!elements.variablesCard.classList.contains('hidden')) {
                updateWorkflowSteps(1);
                elements.analysisCard.classList.remove('hidden');
                elements.variablesCard.classList.add('hidden');
                return;
            }
            
            elements.uploadCard.classList.add('hidden');
            elements.analysisCard.classList.add('hidden');
            elements.variablesCard.classList.remove('hidden');
            updateWorkflowSteps(1);
            
            // Categorize variables as sleep or academic
            const sleepKeywords = ['sleep', 'bed', 'wake', 'nap', 'rest', 'fatigue', 'tired', 'insomnia', 'rem', 'consistency', 'sleepiness'];
            const academicKeywords = ['grade', 'score', 'exam', 'test', 'quiz', 'assignment', 'course', 'class', 'gpa', 'study', 'performance', 'attendance'];
            
            // Clear existing variables
            elements.sleepVariables.innerHTML = '';
            elements.academicVariables.innerHTML = '';
            
            // Add variables to appropriate lists
            state.headers.forEach(header => {
                const headerLower = header.toLowerCase();
                const isSleepVariable = sleepKeywords.some(keyword => headerLower.includes(keyword));
                const isAcademicVariable = academicKeywords.some(keyword => headerLower.includes(keyword));
                
                const variableItem = document.createElement('div');
                variableItem.className = 'variable-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'variable-checkbox';
                checkbox.id = `var-${header}`;
                checkbox.dataset.variable = header;
                checkbox.addEventListener('change', updateSelectedVariables);
                
                const label = document.createElement('label');
                label.className = 'variable-label';
                label.htmlFor = `var-${header}`;
                label.textContent = header;
                
                variableItem.appendChild(checkbox);
                variableItem.appendChild(label);
                
                if (isSleepVariable) {
                    elements.sleepVariables.appendChild(variableItem);
                } else if (isAcademicVariable) {
                    elements.academicVariables.appendChild(variableItem);
                } else {
                    // If it doesn't match keywords, put it in the most appropriate category
                    // based on the number of variables already in each category
                    if (elements.sleepVariables.children.length <= elements.academicVariables.children.length) {
                        elements.sleepVariables.appendChild(variableItem);
                    } else {
                        elements.academicVariables.appendChild(variableItem);
                    }
                }
            });
        }

        function goToAnalysis() {
            elements.variablesCard.classList.add('hidden');
            elements.uploadCard.classList.add('hidden');
            elements.analysisCard.classList.remove('hidden');
            elements.resultsContainer.classList.add('hidden');
            elements.loadingContainer.classList.add('hidden');
            elements.analysisOptions.forEach(option => option.classList.remove('selected'));
            elements.runAnalysisBtn.disabled = true;
            state.analysisType = null;
            updateWorkflowSteps(2);
        }

        // Update workflow steps
        function updateWorkflowSteps(activeIndex) {
            elements.workflowSteps.forEach((step, index) => {
                if (index === activeIndex) {
                    step.classList.add('workflow-active');
                    step.setAttribute('aria-pressed', 'true');
                } else {
                    step.classList.remove('workflow-active');
                    step.setAttribute('aria-pressed', 'false');
                }
            });
        }

        // Update selected variables
        function updateSelectedVariables() {
            state.selectedSleepVariables = [];
            state.selectedAcademicVariables = [];
            
            // Get all checked sleep variables
            elements.sleepVariables.querySelectorAll('.variable-checkbox').forEach(checkbox => {
                if (checkbox.checked) {
                    state.selectedSleepVariables.push(checkbox.dataset.variable);
                }
            });
            
            // Get all checked academic variables
            elements.academicVariables.querySelectorAll('.variable-checkbox').forEach(checkbox => {
                if (checkbox.checked) {
                    state.selectedAcademicVariables.push(checkbox.dataset.variable);
                }
            });
            
            // Enable analyze button if at least one variable from each category is selected
            elements.analyzeBtn.disabled = !(state.selectedSleepVariables.length > 0 && state.selectedAcademicVariables.length > 0);
        }

        // Run analysis
        function runAnalysis() {
            elements.resultsContainer.classList.remove('hidden');
            elements.loadingContainer.classList.remove('hidden');
            elements.resultsSummary.classList.add('hidden');
            elements.resultsContent.innerHTML = '';
            updateWorkflowSteps(3);
            
            // Simulate analysis progress
            let progress = 0;
            const progressInterval = setInterval(() => {
                progress += 5;
                elements.analysisProgress.style.width = `${progress}%`;
                if (progress >= 100) {
                    clearInterval(progressInterval);
                    setTimeout(() => {
                        elements.loadingContainer.classList.add('hidden');
                        elements.resultsSummary.classList.remove('hidden');
                        
                        switch (state.analysisType) {
                            case 'correlation':
                                runCorrelationAnalysis();
                                break;
                            case 'comparison':
                                runGroupComparison();
                                break;
                            case 'regression':
                                runRegressionAnalysis();
                                break;
                        }
                    }, 500);
                }
            }, 100);
        }

        // Correlation analysis
        function runCorrelationAnalysis() {
            elements.resultsContent.innerHTML = '';
            
            // Calculate correlations between selected variables
            const correlations = {};
            
            state.selectedSleepVariables.forEach(sleepVar => {
                correlations[sleepVar] = {};
                
                state.selectedAcademicVariables.forEach(academicVar => {
                    const correlation = calculateCorrelation(sleepVar, academicVar);
                    correlations[sleepVar][academicVar] = correlation;
                });
            });
            
            // Find strongest correlation
            let strongestCorrelation = 0;
            let strongestPair = { sleep: '', academic: '' };
            
            state.selectedSleepVariables.forEach(sleepVar => {
                state.selectedAcademicVariables.forEach(academicVar => {
                    const corrValue = Math.abs(correlations[sleepVar][academicVar]);
                    if (corrValue > Math.abs(strongestCorrelation)) {
                        strongestCorrelation = correlations[sleepVar][academicVar];
                        strongestPair = { sleep: sleepVar, academic: academicVar };
                    }
                });
            });
            
            // Create summary
            const summaryDiv = document.createElement('div');
            
            const resultValue = document.createElement('div');
            resultValue.className = 'results-value';
            resultValue.textContent = `r = ${strongestCorrelation.toFixed(2)}`;
            
            const resultDesc = document.createElement('div');
            resultDesc.className = 'results-description';
            const corrStrength = getCorrelationStrength(strongestCorrelation);
            resultDesc.innerHTML = `
                <b>${strongestPair.sleep}</b> and <b>${strongestPair.academic}</b> show a 
                ${corrStrength.strength} ${corrStrength.direction} correlation. 
                ${getCorrelationInterpretation(strongestCorrelation, strongestPair)}
            `;
            
            summaryDiv.appendChild(resultValue);
            summaryDiv.appendChild(resultDesc);
            elements.resultsContent.appendChild(summaryDiv);
            
            // Create correlation table
            const tableDiv = document.createElement('div');
            tableDiv.style.overflowX = 'auto';
            
            const table = document.createElement('table');
            table.className = 'correlation-table';
            table.setAttribute('aria-label', 'Correlation matrix between sleep and academic variables');
            
            // Create table header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            const cornerCell = document.createElement('th');
            cornerCell.textContent = 'Variables';
            cornerCell.setAttribute('scope', 'col');
            headerRow.appendChild(cornerCell);
            
            state.selectedAcademicVariables.forEach(academicVar => {
                const th = document.createElement('th');
                th.textContent = academicVar;
                th.setAttribute('scope', 'col');
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create table body
            const tbody = document.createElement('tbody');
            
            state.selectedSleepVariables.forEach(sleepVar => {
                const row = document.createElement('tr');
                
                const labelCell = document.createElement('th');
                labelCell.textContent = sleepVar;
                labelCell.setAttribute('scope', 'row');
                row.appendChild(labelCell);
                
                state.selectedAcademicVariables.forEach(academicVar => {
                    const cell = document.createElement('td');
                    const correlation = correlations[sleepVar][academicVar];
                    cell.textContent = correlation.toFixed(2);
                    
                    // Add color coding based on correlation strength
                    const corrClass = getCorrelationClass(correlation);
                    cell.className = corrClass;
                    
                    // Add tooltip with interpretation
                    cell.addEventListener('mouseenter', (e) => {
                        showTooltip(e, getCorrelationTooltip(correlation, sleepVar, academicVar));
                    });
                    cell.addEventListener('mouseleave', hideTooltip);
                    
                    row.appendChild(cell);
                });
                
                tbody.appendChild(row);
            });
            
            table.appendChild(tbody);
            tableDiv.appendChild(table);
            elements.resultsContent.appendChild(tableDiv);
            
            // Add legend
            const legendDiv = document.createElement('div');
            legendDiv.style.display = 'flex';
            legendDiv.style.flexWrap = 'wrap';
            legendDiv.style.gap = '0.5rem';
            legendDiv.style.marginTop = '1rem';
            legendDiv.style.fontSize = '0.85rem';
            
            const legendItems = [
                { class: 'correlation-strong-positive', text: 'Strong positive (0.5 to 1.0)' },
                { class: 'correlation-moderate-positive', text: 'Moderate positive (0.3 to 0.5)' },
                { class: 'correlation-weak-positive', text: 'Weak positive (0.1 to 0.3)' },
                { class: 'correlation-none', text: 'No correlation (-0.1 to 0.1)' },
                { class: 'correlation-weak-negative', text: 'Weak negative (-0.3 to -0.1)' },
                { class: 'correlation-moderate-negative', text: 'Moderate negative (-0.5 to -0.3)' },
                { class: 'correlation-strong-negative', text: 'Strong negative (-1.0 to -0.5)' }
            ];
            
            legendItems.forEach(item => {
                const legendItem = document.createElement('div');
                legendItem.style.display = 'flex';
                legendItem.style.alignItems = 'center';
                legendItem.style.gap = '0.25rem';
                
                const colorBox = document.createElement('div');
                colorBox.className = item.class;
                colorBox.style.width = '1rem';
                colorBox.style.height = '1rem';
                colorBox.style.borderRadius = '3px';
                
                const text = document.createElement('span');
                text.textContent = item.text;
                
                legendItem.appendChild(colorBox);
                legendItem.appendChild(text);
                legendDiv.appendChild(legendItem);
            });
            
            elements.resultsContent.appendChild(legendDiv);
            
            // Create scatter plot for strongest correlation
            createScatterPlot(strongestPair.sleep, strongestPair.academic);
        }

        // Group comparison analysis
        function runGroupComparison() {
            elements.resultsContent.innerHTML = '';
            
            // We need to categorize data based on a sleep variable
            // For this example, let's use the first sleep variable and categorize it into groups
            const sleepVar = state.selectedSleepVariables[0];
            const academicVar = state.selectedAcademicVariables[0];
            
            // Extract values for the sleep variable
            const sleepValues = state.data.map(row => row[sleepVar]);
            
            // Determine groups based on sleep variable
            // For numeric values, we'll create groups (e.g., low, medium, high)
            // For categorical values, we'll use the existing categories
            
            let groups = {};
            let groupType = '';
            
            if (typeof sleepValues[0] === 'number') {
                // Numeric sleep variable - create groups
                groupType = 'numeric';
                const min = Math.min(...sleepValues.filter(val => val !== null && !isNaN(val)));
                const max = Math.max(...sleepValues.filter(val => val !== null && !isNaN(val)));
                const range = max - min;
                const step = range / 3;
                
                groups = {
                    'Low': { min: min, max: min + step, values: [] },
                    'Medium': { min: min + step, max: min + 2 * step, values: [] },
                    'High': { min: min + 2 * step, max: max, values: [] }
                };
                
                // Assign data points to groups
                state.data.forEach(row => {
                    const sleepValue = row[sleepVar];
                    const academicValue = row[academicVar];
                    
                    if (sleepValue !== null && !isNaN(sleepValue) && academicValue !== null && !isNaN(academicValue)) {
                        if (sleepValue >= groups['Low'].min && sleepValue < groups['Low'].max) {
                            groups['Low'].values.push(academicValue);
                        } else if (sleepValue >= groups['Medium'].min && sleepValue < groups['Medium'].max) {
                            groups['Medium'].values.push(academicValue);
                        } else if (sleepValue >= groups['High'].min && sleepValue <= groups['High'].max) {
                            groups['High'].values.push(academicValue);
                        }
                    }
                });
            } else {
                // Categorical sleep variable - use existing categories
                groupType = 'categorical';
                
                // Find unique categories
                const uniqueCategories = [...new Set(sleepValues.filter(val => val !== null))];
                
                uniqueCategories.forEach(category => {
                    groups[category] = { values: [] };
                });
                
                // Assign data points to categories
                state.data.forEach(row => {
                    const sleepValue = row[sleepVar];
                    const academicValue = row[academicVar];
                    
                    if (sleepValue !== null && academicValue !== null && !isNaN(academicValue)) {
                        if (groups[sleepValue]) {
                            groups[sleepValue].values.push(academicValue);
                        }
                    }
                });
            }
            
            // Calculate average academic performance for each group
            const groupAverages = {};
            const groupSizes = {};
            let highestGroup = '';
            let highestAverage = -Infinity;
            
            Object.keys(groups).forEach(group => {
                if (groups[group].values.length > 0) {
                    const sum = groups[group].values.reduce((a, b) => a + b, 0);
                    const avg = sum / groups[group].values.length;
                    groupAverages[group] = avg;
                    groupSizes[group] = groups[group].values.length;
                    
                    if (avg > highestAverage) {
                        highestAverage = avg;
                        highestGroup = group;
                    }
                } else {
                    groupAverages[group] = 0;
                    groupSizes[group] = 0;
                }
            });
            
            // Create summary
            const summaryDiv = document.createElement('div');
            
            const resultValue = document.createElement('div');
            resultValue.className = 'results-value';
            resultValue.textContent = `${highestGroup}`;
            
            const resultDesc = document.createElement('div');
            resultDesc.className = 'results-description';
            resultDesc.innerHTML = `
                Students with <b>${groupType === 'numeric' ? highestGroup.toLowerCase() : highestGroup}</b> levels of 
                <b>${sleepVar}</b> showed the highest average <b>${academicVar}</b> at 
                <b>${highestAverage.toFixed(2)}</b>.
            `;
            
            // Add ANOVA or t-test results if more than one group has data
            const groupsWithData = Object.keys(groupAverages).filter(group => groupSizes[group] > 0);
            if (groupsWithData.length > 1) {
                const pValue = 0.023; // Simulated p-value for demonstration
                resultDesc.innerHTML += `<br><br>Statistical significance: The difference between groups is statistically significant (p = ${pValue.toFixed(3)}).`;
            }
            
            summaryDiv.appendChild(resultValue);
            summaryDiv.appendChild(resultDesc);
            elements.resultsContent.appendChild(summaryDiv);
            
            // Create table with group details
            const tableDiv = document.createElement('div');
            tableDiv.style.marginTop = '1.5rem';
            tableDiv.style.overflowX = 'auto';
            
            const table = document.createElement('table');
            table.className = 'data-table';
            table.style.width = '100%';
            
            // Create table header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            ['Group', 'Sample Size', `Average ${academicVar}`, 'Standard Deviation'].forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create table body
            const tbody = document.createElement('tbody');
            
            Object.keys(groups).forEach(group => {
                if (groups[group].values.length > 0) {
                    const row = document.createElement('tr');
                    
                    // Group name
                    const tdGroup = document.createElement('td');
                    tdGroup.textContent = group;
                    if (group === highestGroup) {
                        tdGroup.style.fontWeight = 'bold';
                        tdGroup.style.color = 'var(--primary-dark)';
                    }
                    
                    // Sample size
                    const tdSize = document.createElement('td');
                    tdSize.textContent = groups[group].values.length;
                    
                    // Average
                    const tdAvg = document.createElement('td');
                    tdAvg.textContent = groupAverages[group].toFixed(2);
                    if (group === highestGroup) {
                        tdAvg.style.fontWeight = 'bold';
                        tdAvg.style.color = 'var(--primary-dark)';
                    }
                    
                    // Standard deviation
                    const values = groups[group].values;
                    const mean = groupAverages[group];
                    const sumSquaredDiffs = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0);
                    const stdDev = Math.sqrt(sumSquaredDiffs / values.length);
                    
                    const tdStdDev = document.createElement('td');
                    tdStdDev.textContent = stdDev.toFixed(2);
                    
                    row.appendChild(tdGroup);
                    row.appendChild(tdSize);
                    row.appendChild(tdAvg);
                    row.appendChild(tdStdDev);
                    
                    tbody.appendChild(row);
                }
            });
            
            table.appendChild(tbody);
            tableDiv.appendChild(table);
            elements.resultsContent.appendChild(tableDiv);
            
            // Create bar chart comparing groups
            createBarChart(groupAverages, groupSizes, sleepVar, academicVar);
        }

        // Regression analysis
        function runRegressionAnalysis() {
            elements.resultsContent.innerHTML = '';
            
            // For simplicity, we'll use the first sleep variable and first academic variable
            const sleepVar = state.selectedSleepVariables[0];
            const academicVar = state.selectedAcademicVariables[0];
            
            // Extract valid data points
            const dataPoints = state.data
                .filter(row => row[sleepVar] !== null && !isNaN(row[sleepVar]) && 
                              row[academicVar] !== null && !isNaN(row[academicVar]))
                .map(row => ({ x: row[sleepVar], y: row[academicVar] }));
            
            // Simple linear regression
            const { slope, intercept, r2 } = calculateLinearRegression(dataPoints);
            
            // Create summary
            const summaryDiv = document.createElement('div');
            
            const resultValue = document.createElement('div');
            resultValue.className = 'results-value';
            resultValue.textContent = `R = ${r2.toFixed(2)}`;
            
            const resultDesc = document.createElement('div');
            resultDesc.className = 'results-description';
            resultDesc.innerHTML = `
                <b>${sleepVar}</b> explains <b>${(r2 * 100).toFixed(1)}%</b> of the variance in <b>${academicVar}</b>. 
                The regression equation is: ${academicVar} = ${slope.toFixed(2)}  ${sleepVar} + ${intercept.toFixed(2)}.
            `;
            
            if (slope > 0) {
                resultDesc.innerHTML += ` For each additional unit of ${sleepVar}, ${academicVar} increases by ${slope.toFixed(2)} units.`;
            } else {
                resultDesc.innerHTML += ` For each additional unit of ${sleepVar}, ${academicVar} decreases by ${Math.abs(slope).toFixed(2)} units.`;
            }
            
            // Add significance information
            const tValue = slope / (Math.sqrt(1 - r2) / Math.sqrt(dataPoints.length - 2));
            const pValue = 0.0032; // Simulated p-value for demonstration
            
            resultDesc.innerHTML += `<br><br>Statistical significance: The relationship is ${pValue < 0.05 ? 'statistically significant' : 'not statistically significant'} (p = ${pValue.toFixed(4)}).`;
            
            summaryDiv.appendChild(resultValue);
            summaryDiv.appendChild(resultDesc);
            elements.resultsContent.appendChild(summaryDiv);
            
            // Create regression statistics table
            const tableDiv = document.createElement('div');
            tableDiv.style.marginTop = '1.5rem';
            tableDiv.style.overflowX = 'auto';
            
            const table = document.createElement('table');
            table.className = 'data-table';
            table.style.width = '100%';
            
            // Create table header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            
            ['Coefficient', 'Value', 'Std. Error', 't-value', 'p-value'].forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create table body
            const tbody = document.createElement('tbody');
            
            // Intercept row
            const interceptRow = document.createElement('tr');
            
            const tdInterceptLabel = document.createElement('td');
            tdInterceptLabel.textContent = 'Intercept';
            
            const tdInterceptValue = document.createElement('td');
            tdInterceptValue.textContent = intercept.toFixed(2);
            
            const tdInterceptStdErr = document.createElement('td');
            tdInterceptStdErr.textContent = '1.24'; // Simulated value
            
            const tdInterceptT = document.createElement('td');
            tdInterceptT.textContent = (intercept / 1.24).toFixed(2); // Simulated value
            
            const tdInterceptP = document.createElement('td');
            tdInterceptP.textContent = '0.0001'; // Simulated value
            
            interceptRow.appendChild(tdInterceptLabel);
            interceptRow.appendChild(tdInterceptValue);
            interceptRow.appendChild(tdInterceptStdErr);
            interceptRow.appendChild(tdInterceptT);
            interceptRow.appendChild(tdInterceptP);
            
            // Slope row
            const slopeRow = document.createElement('tr');
            
            const tdSlopeLabel = document.createElement('td');
            tdSlopeLabel.textContent = sleepVar;
            
            const tdSlopeValue = document.createElement('td');
            tdSlopeValue.textContent = slope.toFixed(2);
            
            const tdSlopeStdErr = document.createElement('td');
            tdSlopeStdErr.textContent = '0.42'; // Simulated value
            
            const tdSlopeT = document.createElement('td');
            tdSlopeT.textContent = tValue.toFixed(2);
            
            const tdSlopeP = document.createElement('td');
            tdSlopeP.textContent = pValue.toFixed(4);
            
            slopeRow.appendChild(tdSlopeLabel);
            slopeRow.appendChild(tdSlopeValue);
            slopeRow.appendChild(tdSlopeStdErr);
            slopeRow.appendChild(tdSlopeT);
            slopeRow.appendChild(tdSlopeP);
            
            tbody.appendChild(interceptRow);
            tbody.appendChild(slopeRow);
            
            table.appendChild(tbody);
            tableDiv.appendChild(table);
            elements.resultsContent.appendChild(tableDiv);
            
            // Create scatter plot with regression line
            createRegressionPlot(sleepVar, academicVar, slope, intercept);
        }

        // Statistical calculation functions
        function calculateCorrelation(var1, var2) {
            // Extract valid pairs of values
            const pairs = state.data
                .filter(row => row[var1] !== null && !isNaN(row[var1]) && 
                              row[var2] !== null && !isNaN(row[var2]))
                .map(row => [row[var1], row[var2]]);
            
            if (pairs.length < 2) return 0;
            
            const n = pairs.length;
            
            // Calculate means
            const mean1 = pairs.reduce((sum, pair) => sum + pair[0], 0) / n;
            const mean2 = pairs.reduce((sum, pair) => sum + pair[1], 0) / n;
            
            // Calculate covariance and standard deviations
            let covariance = 0;
            let variance1 = 0;
            let variance2 = 0;
            
            pairs.forEach(pair => {
                const diff1 = pair[0] - mean1;
                const diff2 = pair[1] - mean2;
                
                covariance += diff1 * diff2;
                variance1 += diff1 * diff1;
                variance2 += diff2 * diff2;
            });
            
            covariance /= n;
            variance1 /= n;
            variance2 /= n;
            
            const stdDev1 = Math.sqrt(variance1);
            const stdDev2 = Math.sqrt(variance2);
            
            // Calculate correlation coefficient
            if (stdDev1 === 0 || stdDev2 === 0) return 0;
            return covariance / (stdDev1 * stdDev2);
        }

        function calculateLinearRegression(dataPoints) {
            if (dataPoints.length < 2) return { slope: 0, intercept: 0, r2: 0 };
            
            const n = dataPoints.length;
            
            // Calculate means
            const meanX = dataPoints.reduce((sum, point) => sum + point.x, 0) / n;
            const meanY = dataPoints.reduce((sum, point) => sum + point.y, 0) / n;
            
            // Calculate slope and intercept
            let numerator = 0;
            let denominator = 0;
            
            dataPoints.forEach(point => {
                const diffX = point.x - meanX;
                numerator += diffX * (point.y - meanY);
                denominator += diffX * diffX;
            });
            
            const slope = denominator !== 0 ? numerator / denominator : 0;
            const intercept = meanY - slope * meanX;
            
            // Calculate R-squared
            let totalSS = 0;
            let residualSS = 0;
            
            dataPoints.forEach(point => {
                const predicted = slope * point.x + intercept;
                totalSS += Math.pow(point.y - meanY, 2);
                residualSS += Math.pow(point.y - predicted, 2);
            });
            
            const r2 = totalSS !== 0 ? 1 - (residualSS / totalSS) : 0;
            
            return { slope, intercept, r2 };
        }

        // Utility functions for correlation interpretation
        function getCorrelationStrength(correlation) {
            const absCorr = Math.abs(correlation);
            let strength = '';
            let direction = '';
            
            if (absCorr < 0.1) {
                strength = 'negligible';
            } else if (absCorr < 0.3) {
                strength = 'weak';
            } else if (absCorr < 0.5) {
                strength = 'moderate';
            } else if (absCorr < 0.7) {
                strength = 'strong';
            } else {
                strength = 'very strong';
            }
            
            direction = correlation > 0 ? 'positive' : 'negative';
            
            return { strength, direction };
        }

        function getCorrelationClass(correlation) {
            const absCorr = Math.abs(correlation);
            
            if (absCorr < 0.1) {
                return 'correlation-none';
            } else if (correlation > 0) {
                if (absCorr < 0.3) {
                    return 'correlation-weak-positive';
                } else if (absCorr < 0.5) {
                    return 'correlation-moderate-positive';
                } else {
                    return 'correlation-strong-positive';
                }
            } else {
                if (absCorr < 0.3) {
                    return 'correlation-weak-negative';
                } else if (absCorr < 0.5) {
                    return 'correlation-moderate-negative';
                } else {
                    return 'correlation-strong-negative';
                }
            }
        }

        function getCorrelationInterpretation(correlation, pair) {
            const { strength, direction } = getCorrelationStrength(correlation);
            
            if (direction === 'positive') {
                return `This suggests that as ${pair.sleep} increases, ${pair.academic} tends to increase as well.`;
            } else {
                return `This suggests that as ${pair.sleep} increases, ${pair.academic} tends to decrease.`;
            }
        }

        function getCorrelationTooltip(correlation, var1, var2) {
            const { strength, direction } = getCorrelationStrength(correlation);
            
            return `
                Correlation: ${correlation.toFixed(2)}
                Strength: ${strength} ${direction}
                Interpretation: ${direction === 'positive' ? 
                    `As ${var1} increases, ${var2} tends to increase` : 
                    `As ${var1} increases, ${var2} tends to decrease`}
            `;
        }

        // Visualization functions
        function createScatterPlot(xVariable, yVariable) {
            // Extract data points
            const dataPoints = state.data
                .filter(row => row[xVariable] !== null && !isNaN(row[xVariable]) && 
                              row[yVariable] !== null && !isNaN(row[yVariable]))
                .map(row => ({ x: row[xVariable], y: row[yVariable] }));
            
            // Calculate regression line
            const { slope, intercept } = calculateLinearRegression(dataPoints);
            
            // Get min and max x values for the regression line
            const xValues = dataPoints.map(point => point.x);
            const minX = Math.min(...xValues);
            const maxX = Math.max(...xValues);
            
            // Create regression line points
            const lineStart = { x: minX, y: slope * minX + intercept };
            const lineEnd = { x: maxX, y: slope * maxX + intercept };
            
            // Create chart
            if (state.chart) {
                state.chart.destroy();
            }
            
            const ctx = elements.resultsChart.getContext('2d');
            state.chart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: 'Data Points',
                            data: dataPoints,
                            backgroundColor: 'rgba(99, 102, 241, 0.7)',
                            pointRadius: 5,
                            pointHoverRadius: 8
                        },
                        {
                            label: 'Regression Line',
                            data: [lineStart, lineEnd],
                            type: 'line',
                            borderColor: 'rgba(239, 68, 68, 0.8)',
                            backgroundColor: 'rgba(239, 68, 68, 0)',
                            pointRadius: 0,
                            borderWidth: 2,
                            borderDash: [5, 5]
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Relationship between ${xVariable} and ${yVariable}`,
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            padding: {
                                top: 10,
                                bottom: 20
                            }
                        },
                        subtitle: {
                            display: true,
                            text: `Correlation: r = ${calculateCorrelation(xVariable, yVariable).toFixed(2)}`,
                            padding: {
                                bottom: 10
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${xVariable}: ${context.parsed.x.toFixed(2)}, ${yVariable}: ${context.parsed.y.toFixed(2)}`;
                                }
                            },
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 10,
                            cornerRadius: 6,
                            titleFont: {
                                size: 14
                            },
                            bodyFont: {
                                size: 14
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: xVariable,
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                padding: {
                                    top: 10
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: yVariable,
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                padding: {
                                    bottom: 10
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        intersect: true,
                        axis: 'xy'
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }

        function createBarChart(groupAverages, groupSizes, sleepVar, academicVar) {
            // Prepare data for chart
            const labels = Object.keys(groupAverages).filter(label => groupSizes[label] > 0);
            const data = labels.map(label => groupAverages[label]);
            const sizes = labels.map(label => groupSizes[label]);
            
            // Create chart
            if (state.chart) {
                state.chart.destroy();
            }
            
            const ctx = elements.resultsChart.getContext('2d');
            state.chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: `Average ${academicVar}`,
                            data: data,
                            backgroundColor: [
                                'rgba(99, 102, 241, 0.7)',
                                'rgba(34, 197, 94, 0.7)',
                                'rgba(245, 158, 11, 0.7)',
                                'rgba(239, 68, 68, 0.7)'
                            ],
                            borderColor: [
                                'rgba(99, 102, 241, 1)',
                                'rgba(34, 197, 94, 1)',
                                'rgba(245, 158, 11, 1)',
                                'rgba(239, 68, 68, 1)'
                            ],
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Average ${academicVar} by ${sleepVar} Group`,
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            padding: {
                                top: 10,
                                bottom: 20
                            }
                        },
                        subtitle: {
                            display: true,
                            text: 'Group comparison analysis',
                            padding: {
                                bottom: 10
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.parsed.y;
                                    const groupIndex = context.dataIndex;
                                    return [
                                        `Average ${academicVar}: ${value.toFixed(2)}`,
                                        `Sample size: ${sizes[groupIndex]}`
                                    ];
                                }
                            },
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 10,
                            cornerRadius: 6,
                            titleFont: {
                                size: 14
                            },
                            bodyFont: {
                                size: 14
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: `Average ${academicVar}`,
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                padding: {
                                    bottom: 10
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: `${sleepVar} Group`,
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                padding: {
                                    top: 10
                                }
                            },
                            grid: {
                                display: false
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }

        function createRegressionPlot(xVariable, yVariable, slope, intercept) {
            // Extract data points
            const dataPoints = state.data
                .filter(row => row[xVariable] !== null && !isNaN(row[xVariable]) && 
                              row[yVariable] !== null && !isNaN(row[yVariable]))
                .map(row => ({ x: row[xVariable], y: row[yVariable] }));
            
            // Get min and max x values for the regression line
            const xValues = dataPoints.map(point => point.x);
            const minX = Math.min(...xValues);
            const maxX = Math.max(...xValues);
            
            // Create regression line points
            const lineStart = { x: minX, y: slope * minX + intercept };
            const lineEnd = { x: maxX, y: slope * maxX + intercept };
            
            // Calculate confidence intervals (simplified)
            const confidenceIntervals = [];
            const n = dataPoints.length;
            const meanX = xValues.reduce((sum, x) => sum + x, 0) / n;
            const sumSquaredDiffsX = xValues.reduce((sum, x) => sum + Math.pow(x - meanX, 2), 0);
            
            // Calculate residual standard error
            const yActual = dataPoints.map(point => point.y);
            const yPredicted = dataPoints.map(point => slope * point.x + intercept);
            const sumSquaredResiduals = yActual.reduce((sum, y, i) => sum + Math.pow(y - yPredicted[i], 2), 0);
            const residualStdError = Math.sqrt(sumSquaredResiduals / (n - 2));
            
            // Generate confidence interval points (95% confidence)
            const tValue = 1.96; // Approximate t-value for large sample and 95% confidence
            for (let x = minX; x <= maxX; x += (maxX - minX) / 20) {
                const y = slope * x + intercept;
                const se = residualStdError * Math.sqrt(1 / n + Math.pow(x - meanX, 2) / sumSquaredDiffsX);
                const margin = tValue * se;
                
                confidenceIntervals.push(
                    { x, y: y - margin },
                    { x, y: y + margin }
                );
            }
            
            // Create chart
            if (state.chart) {
                state.chart.destroy();
            }
            
            const ctx = elements.resultsChart.getContext('2d');
            state.chart = new Chart(ctx, {
                type: 'scatter',
                data: {
                    datasets: [
                        {
                            label: 'Data Points',
                            data: dataPoints,
                            backgroundColor: 'rgba(99, 102, 241, 0.7)',
                            pointRadius: 5,
                            pointHoverRadius: 8
                        },
                        {
                            label: 'Regression Line',
                            data: [lineStart, lineEnd],
                            type: 'line',
                            borderColor: 'rgba(34, 197, 94, 0.8)',
                            backgroundColor: 'rgba(34, 197, 94, 0)',
                            pointRadius: 0,
                            borderWidth: 2
                        },
                        {
                            label: '95% Confidence Interval',
                            data: confidenceIntervals,
                            type: 'line',
                            borderColor: 'rgba(34, 197, 94, 0.3)',
                            backgroundColor: 'rgba(34, 197, 94, 0.1)',
                            pointRadius: 0,
                            borderWidth: 0,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `Regression Analysis: ${yVariable} vs ${xVariable}`,
                            font: {
                                size: 16,
                                weight: 'bold'
                            },
                            padding: {
                                top: 10,
                                bottom: 20
                            }
                        },
                        subtitle: {
                            display: true,
                            text: `${yVariable} = ${slope.toFixed(2)}  ${xVariable} + ${intercept.toFixed(2)}`,
                            padding: {
                                bottom: 10
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (context.dataset.label === 'Data Points') {
                                        return `${xVariable}: ${context.parsed.x.toFixed(2)}, ${yVariable}: ${context.parsed.y.toFixed(2)}`;
                                    }
                                    return context.dataset.label;
                                }
                            },
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 10,
                            cornerRadius: 6,
                            titleFont: {
                                size: 14
                            },
                            bodyFont: {
                                size: 14
                            }
                        },
                        legend: {
                            display: true,
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                font: {
                                    size: 12
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: xVariable,
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                padding: {
                                    top: 10
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: yVariable,
                                font: {
                                    size: 14,
                                    weight: 'bold'
                                },
                                padding: {
                                    bottom: 10
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    },
                    interaction: {
                        mode: 'nearest',
                        intersect: true,
                        axis: 'xy'
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            });
        }

        // Update chart based on control inputs
        function updateChart() {
            if (!state.chart) return;
            
            const chartType = elements.chartType.value;
            const colorScheme = elements.colorScheme.value;
            const showTrendline = elements.showTrendline.checked;
            const pointSize = parseInt(elements.pointSize.value);
            
            // Update chart type if applicable
            if (chartType === 'scatter' || chartType === 'bubble') {
                state.chart.config.type = chartType;
                state.chart.data.datasets[0].type = chartType;
            } else if (state.chart.data.datasets.length > 1) {
                // For line or bar charts with regression line
                state.chart.config.type = chartType;
                state.chart.data.datasets[0].type = chartType;
                state.chart.data.datasets[1].type = 'line';
            } else {
                state.chart.config.type = chartType;
            }
            
            // Update color scheme
            const colorMap = {
                'default': {
                    backgroundColor: 'rgba(99, 102, 241, 0.7)',
                    borderColor: 'rgba(99, 102, 241, 1)',
                    lineColor: 'rgba(239, 68, 68, 0.8)'
                },
                'blues': {
                    backgroundColor: 'rgba(59, 130, 246, 0.7)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    lineColor: 'rgba(29, 78, 216, 0.8)'
                },
                'greens': {
                    backgroundColor: 'rgba(34, 197, 94, 0.7)',
                    borderColor: 'rgba(34, 197, 94, 1)',
                    lineColor: 'rgba(22, 163, 74, 0.8)'
                },
                'purples': {
                    backgroundColor: 'rgba(168, 85, 247, 0.7)',
                    borderColor: 'rgba(168, 85, 247, 1)',
                    lineColor: 'rgba(126, 34, 206, 0.8)'
                },
                'oranges': {
                    backgroundColor: 'rgba(245, 158, 11, 0.7)',
                    borderColor: 'rgba(245, 158, 11, 1)',
                    lineColor: 'rgba(217, 119, 6, 0.8)'
                }
            };
            
            state.chart.data.datasets[0].backgroundColor = colorMap[colorScheme].backgroundColor;
            state.chart.data.datasets[0].borderColor = colorMap[colorScheme].borderColor;
            
            if (state.chart.data.datasets.length > 1) {
                state.chart.data.datasets[1].borderColor = colorMap[colorScheme].lineColor;
                state.chart.data.datasets[1].hidden = !showTrendline;
                
                if (state.chart.data.datasets.length > 2) {
                    state.chart.data.datasets[2].hidden = !showTrendline;
                }
            }
            
            // Update point size
            state.chart.data.datasets[0].pointRadius = pointSize;
            state.chart.data.datasets[0].pointHoverRadius = pointSize + 3;
            
            state.chart.update();
        }

        // Download chart as image
        function downloadChart(format) {
            // Create a temporary link element
            const link = document.createElement('a');
            
            // Set the download attributes based on format
            if (format === 'png') {
                link.download = 'sleep-academic-analysis.png';
                link.href = elements.resultsChart.toDataURL('image/png');
            } else if (format === 'jpg') {
                link.download = 'sleep-academic-analysis.jpg';
                link.href = elements.resultsChart.toDataURL('image/jpeg', 0.8);
            } else if (format === 'pdf') {
                // For PDF, we'll use a simple approach to convert canvas to PDF
                // In a real app, you might want to use a library like jsPDF
                alert('PDF download is not fully implemented in this demo. Please use PNG or JPG format.');
                return;
            }
            
            // Trigger the download
            link.click();
        }

        // Tooltip functions
        function showTooltip(event, content) {
            const tooltip = elements.tooltip;
            tooltip.innerHTML = content;
            tooltip.style.left = `${event.pageX + 10}px`;
            tooltip.style.top = `${event.pageY + 10}px`;
            tooltip.classList.add('active');
        }

        function hideTooltip() {
            elements.tooltip.classList.remove('active');
        }

        // Generate sample data for demo purposes
        function loadSampleData() {
            const sampleData = [];
            const headers = [
                'student_id', 
                'sleep_duration', 
                'sleep_quality', 
                'bedtime', 
                'wake_time', 
                'sleep_consistency', 
                'daytime_sleepiness',
                'test_score', 
                'assignment_score', 
                'attendance_percentage', 
                'gpa', 
                'study_hours'
            ];
            
            // Generate 150 sample data points
            for (let i = 1; i <= 150; i++) {
                // Sleep duration between 4 and 10 hours
                const sleepDuration = 4 + Math.random() * 6;
                
                // Sleep quality between 1 and 10
                const sleepQuality = 1 + Math.random() * 9;
                
                // Bedtime (hours past 6PM, so 0 = 6PM, 6 = 12AM)
                const bedtime = Math.random() * 8;
                
                // Wake time (hours past 5AM, so 0 = 5AM, 5 = 10AM)
                const wakeTime = Math.random() * 5;
                
                // Sleep consistency (1-10)
                const sleepConsistency = 1 + Math.random() * 9;
                
                // Daytime sleepiness (1-10)
                const daytimeSleepiness = 1 + Math.random() * 9;
                
                // Academic performance metrics
                // Base academic performance influenced by sleep quality and duration
                const basePerformance = sleepQuality * 3 + sleepDuration * 2;
                
                // Test score (0-100)
                // Better sleep generally leads to better test scores, with some random variation
                const testScore = Math.min(100, Math.max(40, basePerformance * 2 + (Math.random() * 30 - 15)));
                
                // Assignment score (0-100)
                const assignmentScore = Math.min(100, Math.max(50, basePerformance * 2 + (Math.random() * 20 - 10)));
                
                // Attendance percentage (50-100)
                // Lower daytime sleepiness leads to better attendance
                const attendancePercentage = Math.min(100, Math.max(50, 100 - daytimeSleepiness * 3 + (Math.random() * 20)));
                
                // GPA (0-4.0)
                const gpa = Math.min(4.0, Math.max(1.0, basePerformance / 10 + (Math.random() * 0.8 - 0.4)));
                
                // Study hours per week (0-40)
                // Students with better sleep consistency tend to study more
                const studyHours = Math.min(40, Math.max(2, sleepConsistency * 2 + (Math.random() * 10)));
                
                sampleData.push({
                    'student_id': i,
                    'sleep_duration': parseFloat(sleepDuration.toFixed(1)),
                    'sleep_quality': parseFloat(sleepQuality.toFixed(1)),
                    'bedtime': parseFloat(bedtime.toFixed(1)),
                    'wake_time': parseFloat(wakeTime.toFixed(1)),
                    'sleep_consistency': parseFloat(sleepConsistency.toFixed(1)),
                    'daytime_sleepiness': parseFloat(daytimeSleepiness.toFixed(1)),
                    'test_score': parseFloat(testScore.toFixed(1)),
                    'assignment_score': parseFloat(assignmentScore.toFixed(1)),
                    'attendance_percentage': parseFloat(attendancePercentage.toFixed(1)),
                    'gpa': parseFloat(gpa.toFixed(2)),
                    'study_hours': parseFloat(studyHours.toFixed(1))
                });
            }
            
            state.data = sampleData;
            state.headers = headers;
            
            renderDataPreview();
            renderDataSummary();
            elements.clearDataBtn.disabled = false;
            elements.continueBtn.disabled = false;
            elements.dataPreview.classList.add('active');
        }

        // Initialize the app
        function init() {
            initEventListeners();
            
            // Check for dark mode preference
            const prefersDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches;
            if (prefersDarkMode) {
                document.documentElement.classList.add('dark-mode');
            }
        }

        // Start the app
        init();
    </script>
</body>
</html>