<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Series Visualization Dashboard</title>
    <style>
        :root {
            --primary-color: #4285f4;
            --secondary-color: #34a853;
            --accent-color: #ea4335;
            --background-color: #ffffff;
            --text-color: #333333;
            --border-color: #e0e0e0;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --chart-background: #f8f9fa;
            --success-color: #34a853;
            --warning-color: #fbbc05;
            --error-color: #ea4335;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Roboto, Arial, sans-serif;
        }

        body {
            background-color: #f8f9fa;
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
        }

        .dashboard {
            max-width: 1200px;
            margin: 0 auto;
            background-color: var(--background-color);
            border-radius: 12px;
            box-shadow: 0 4px 12px var(--shadow-color);
            overflow: hidden;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 30px;
        }

        h1 {
            font-size: 24px;
            font-weight: 500;
        }

        .description {
            font-size: 14px;
            margin-top: 8px;
            opacity: 0.9;
        }

        .controls-container {
            padding: 20px 30px;
            background-color: #f5f7f9;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .control-group label {
            font-size: 13px;
            font-weight: 500;
            color: #555;
        }

        select, input, button {
            padding: 10px 12px;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            font-size: 14px;
            background-color: white;
            transition: all 0.2s ease;
        }

        select:hover, input:hover, button:hover {
            border-color: #bbb;
        }

        select:focus, input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
        }

        button {
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            font-weight: 500;
            border: none;
            transition: background-color 0.2s, transform 0.1s;
        }

        button:hover {
            background-color: #3367d6;
        }
        
        button:active {
            transform: translateY(1px);
        }

        .date-range {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .preset-buttons {
            display: flex;
            gap: 8px;
        }

        .preset-button {
            background-color: white;
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 8px 12px;
            font-size: 13px;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .preset-button:hover {
            background-color: #f0f0f0;
        }

        .preset-button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .visualization-container {
            padding: 20px 30px;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px var(--shadow-color);
            padding: 20px;
            margin-bottom: 20px;
            position: relative;
        }

        .chart-container {
            height: 400px;
            position: relative;
            cursor: pointer;
        }

        .card-title {
            font-size: 18px;
            color: var(--text-color);
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .floating-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.98);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 100;
            width: 250px;
        }

        .floating-controls.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        .control-group {
            margin: 10px 0;
            display: flex;
            align-items: flex-start;
            gap: 10px;
            flex-direction: column;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            position: relative;
        }

        .tab.active {
            border-bottom-color: var(--primary-color);
            color: var(--primary-color);
            font-weight: 500;
        }

        .tab:hover:not(.active) {
            background-color: #f5f5f5;
        }
        
        .tab:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        .legend-item {
            display: flex;
            align-items: center;
            font-size: 13px;
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .legend-item:hover {
            background-color: #f5f5f5;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            margin-right: 6px;
        }

        .info-tooltip {
            display: inline-block;
            width: 18px;
            height: 18px;
            background-color: #eee;
            border-radius: 50%;
            text-align: center;
            line-height: 18px;
            font-size: 12px;
            margin-left: 6px;
            cursor: help;
            position: relative;
            color: #666;
        }

        .info-tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #333;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }
        
        .chart-actions {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .chart-action-btn {
            background-color: #f5f7f9;
            border: 1px solid var(--border-color);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.2s;
        }
        
        .chart-action-btn:hover {
            background-color: #e9ecef;
        }
        
        .chart-action-btn i {
            font-size: 16px;
        }
        
        .anomaly-badge {
            display: inline-block;
            background-color: var(--error-color);
            color: white;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: 10px;
        }
        
        .insights-panel {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
            font-size: 14px;
        }
        
        .insights-panel h4 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        .insights-panel ul {
            margin-left: 20px;
        }
        
        .insights-panel li {
            margin-bottom: 5px;
        }
        
        .checkbox-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-control input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .color-picker-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .color-picker-group input[type="color"] {
            width: 30px;
            height: 30px;
            padding: 2px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .range-control {
            width: 100%;
        }
        
        .range-control input[type="range"] {
            width: 100%;
        }
        
        .range-values {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
        }
        
        .keyboard-shortcut {
            background-color: #f1f3f5;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 1px 5px;
            font-size: 11px;
            color: #495057;
            margin-left: 5px;
        }

        .visualization-types {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .viz-type-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px var(--shadow-color);
            overflow: hidden;
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .viz-type-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        .viz-type-card.selected {
            border: 2px solid var(--primary-color);
        }

        .viz-type-preview {
            height: 160px;
            background-color: #f5f7f9;
            display: flex;
            align-items: center;
            justify-content: center;
            border-bottom: 1px solid var(--border-color);
        }

        .viz-type-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .viz-type-info {
            padding: 15px;
        }

        .viz-type-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .viz-type-desc {
            font-size: 13px;
            color: #666;
            line-height: 1.4;
        }

        .suitability-tag {
            display: inline-block;
            padding: 3px 8px;
            font-size: 12px;
            border-radius: 12px;
            margin-top: 10px;
            background-color: #e9ecef;
        }

        .suitability-tag.best {
            background-color: var(--success-color);
            color: white;
        }

        .suitability-tag.good {
            background-color: var(--warning-color);
            color: white;
        }

        .suitability-tag.limited {
            background-color: var(--error-color);
            color: white;
        }

        .best-practices {
            background-color: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }

        .best-practices h3 {
            font-size: 18px;
            color: var(--primary-color);
            margin-bottom: 15px;
        }

        .best-practices ul {
            margin-left: 20px;
        }

        .best-practices li {
            margin-bottom: 10px;
        }
        
        /* Responsive styles */
        @media (max-width: 768px) {
            .controls-container {
                flex-direction: column;
                align-items: stretch;
            }
            
            .date-range {
                flex-direction: column;
                align-items: stretch;
            }
            
            .preset-buttons {
                flex-wrap: wrap;
            }
            
            .floating-controls {
                width: 80%;
                max-width: 300px;
            }

            .visualization-types {
                grid-template-columns: 1fr;
            }
        }
        
        /* Accessibility focus styles */
        button:focus, select:focus, input:focus, .legend-item:focus, .viz-type-card:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.4);
        }
        
        /* Dark mode support */
        @media (prefers-color-scheme: dark) {
            :root {
                --primary-color: #4285f4;
                --secondary-color: #34a853;
                --accent-color: #ea4335;
                --background-color: #202124;
                --text-color: #e8eaed;
                --border-color: #5f6368;
                --shadow-color: rgba(0, 0, 0, 0.3);
                --chart-background: #2d2e30;
            }
            
            body {
                background-color: #202124;
            }
            
            select, input, .preset-button {
                background-color: #2d2e30;
                color: var(--text-color);
            }
            
            .floating-controls {
                background: rgba(45, 46, 48, 0.98);
            }
            
            .card, .info-tooltip, .viz-type-card {
                background-color: #2d2e30;
            }

            .viz-type-preview {
                background-color: #3c3c3d;
            }
            
            .chart-action-btn, .insights-panel, .best-practices {
                background-color: #3c3c3d;
                color: var(--text-color);
            }
            
            .chart-action-btn:hover {
                background-color: #4d4d4e;
            }
            
            .tab:hover:not(.active) {
                background-color: #3c3c3d;
            }
            
            .legend-item:hover {
                background-color: #3c3c3d;
            }
            
            .keyboard-shortcut {
                background-color: #3c3c3d;
                border-color: #5f6368;
                color: #e8eaed;
            }

            .suitability-tag {
                background-color: #4d4d4e;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <header>
            <h1>Time Series Visualization Guide</h1>
            <div class="description">
                Comparing different visualization techniques for temporal data analysis and pattern recognition
            </div>
        </header>

        <div class="visualization-container">
            <div class="best-practices">
                <h3>Best Practices for Time Series Visualization</h3>
                <ul>
                    <li><strong>Choose appropriate time scales</strong> - Match the granularity of your data (hourly, daily, monthly) with your analysis goals</li>
                    <li><strong>Highlight trends and patterns</strong> - Use smoothing techniques or trend lines to emphasize underlying patterns</li>
                    <li><strong>Enable interaction</strong> - Allow users to zoom, pan, and filter to explore different time periods</li>
                    <li><strong>Provide context</strong> - Include annotations for significant events or anomalies</li>
                    <li><strong>Consider multiple views</strong> - Combine different visualizations to provide complementary perspectives</li>
                </ul>
            </div>

            <h2 style="margin-bottom: 15px;">Visualization Types for Time Series Data</h2>
            <div class="visualization-types">
                <div class="viz-type-card selected" tabindex="0" role="button" aria-pressed="true">
                    <div class="viz-type-preview">
                        <canvas id="lineChartPreview" width="280" height="160"></canvas>
                    </div>
                    <div class="viz-type-info">
                        <div class="viz-type-title">Line Chart</div>
                        <div class="viz-type-desc">
                            Connects data points with lines to show continuous changes over time. Ideal for visualizing trends, patterns, and fluctuations.
                        </div>
                        <div class="suitability-tag best">Best Choice</div>
                    </div>
                </div>

                <div class="viz-type-card" tabindex="0" role="button" aria-pressed="false">
                    <div class="viz-type-preview">
                        <canvas id="areaChartPreview" width="280" height="160"></canvas>
                    </div>
                    <div class="viz-type-info">
                        <div class="viz-type-title">Area Chart</div>
                        <div class="viz-type-desc">
                            Similar to line charts but with the area below the line filled. Great for showing volume and cumulative values over time.
                        </div>
                        <div class="suitability-tag best">Best Choice</div>
                    </div>
                </div>

                <div class="viz-type-card" tabindex="0" role="button" aria-pressed="false">
                    <div class="viz-type-preview">
                        <canvas id="barChartPreview" width="280" height="160"></canvas>
                    </div>
                    <div class="viz-type-info">
                        <div class="viz-type-title">Bar Chart</div>
                        <div class="viz-type-desc">
                            Uses rectangular bars to represent data values at specific time points. Good for comparing discrete time periods.
                        </div>
                        <div class="suitability-tag good">Good Choice</div>
                    </div>
                </div>

                <div class="viz-type-card" tabindex="0" role="button" aria-pressed="false">
                    <div class="viz-type-preview">
                        <canvas id="candlestickPreview" width="280" height="160"></canvas>
                    </div>
                    <div class="viz-type-info">
                        <div class="viz-type-title">Candlestick Chart</div>
                        <div class="viz-type-desc">
                            Shows open, high, low, and close values. Essential for financial time series and stock price analysis.
                        </div>
                        <div class="suitability-tag good">Good for Financial Data</div>
                    </div>
                </div>

                <div class="viz-type-card" tabindex="0" role="button" aria-pressed="false">
                    <div class="viz-type-preview">
                        <canvas id="heatmapPreview" width="280" height="160"></canvas>
                    </div>
                    <div class="viz-type-info">
                        <div class="viz-type-title">Calendar Heatmap</div>
                        <div class="viz-type-desc">
                            Uses color intensity to show values across a calendar grid. Excellent for showing patterns by day of week or month.
                        </div>
                        <div class="suitability-tag good">Good for Patterns</div>
                    </div>
                </div>

                <div class="viz-type-card" tabindex="0" role="button" aria-pressed="false">
                    <div class="viz-type-preview">
                        <canvas id="scatterPreview" width="280" height="160"></canvas>
                    </div>
                    <div class="viz-type-info">
                        <div class="viz-type-title">Scatter Plot</div>
                        <div class="viz-type-desc">
                            Plots individual data points without connecting lines. Useful for showing distribution and outliers over time.
                        </div>
                        <div class="suitability-tag limited">Limited Use Case</div>
                    </div>
                </div>
            </div>

            <div class="tabs" role="tablist">
                <div class="tab active" data-tab="line" role="tab" tabindex="0" aria-selected="true">Line Chart</div>
                <div class="tab" data-tab="area" role="tab" tabindex="0" aria-selected="false">Area Chart</div>
                <div class="tab" data-tab="bar" role="tab" tabindex="0" aria-selected="false">Bar Chart</div>
                <div class="tab" data-tab="candlestick" role="tab" tabindex="0" aria-selected="false">Candlestick</div>
            </div>

            <div class="card" role="tabpanel">
                <div class="card-title">
                    <span>
                        Interactive Time Series Example
                        <span class="info-tooltip" data-tooltip="Demonstrates best practices for time series visualization" role="tooltip" tabindex="0">i</span>
                    </span>
                    <div class="chart-actions">
                        <button class="chart-action-btn" id="resetZoomBtn" aria-label="Reset zoom">
                            <i>⟲</i> Reset Zoom
                        </button>
                        <button class="chart-action-btn" id="exportDataBtn" aria-label="Export data">
                            <i>↓</i> Export
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="timeSeriesChart" aria-label="Time series chart" role="img"></canvas>
                    <div class="floating-controls" id="chartControls">
                        <div class="control-group">
                            <label for="chartType">Chart Type</label>
                            <select id="chartType" aria-label="Select chart type">
                                <option value="line">Line</option>
                                <option value="bar">Bar</option>
                                <option value="area">Area</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label for="lineSmoothing">Line Smoothing</label>
                            <select id="lineSmoothing" aria-label="Select line smoothing">
                                <option value="0">None</option>
                                <option value="0.2">Low</option>
                                <option value="0.4" selected>Medium</option>
                                <option value="0.6">High</option>
                            </select>
                        </div>
                        <div class="control-group range-control">
                            <label for="pointSize">Point Size</label>
                            <input type="range" id="pointSize" min="0" max="10" value="3" aria-label="Adjust point size">
                            <div class="range-values">
                                <span>None</span>
                                <span>Large</span>
                            </div>
                        </div>
                        <div class="control-group">
                            <label for="yAxisScale">Y-Axis Scale</label>
                            <select id="yAxisScale" aria-label="Select Y-axis scale">
                                <option value="linear">Linear</option>
                                <option value="logarithmic">Logarithmic</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label for="colorScheme">Color Scheme</label>
                            <select id="colorScheme" aria-label="Select color scheme">
                                <option value="default">Default</option>
                                <option value="monochrome">Monochrome</option>
                                <option value="rainbow">Rainbow</option>
                                <option value="warm">Warm</option>
                                <option value="cool">Cool</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <div class="checkbox-control">
                                <input type="checkbox" id="showGrid" checked aria-label="Show grid">
                                <label for="showGrid">Show Grid</label>
                            </div>
                        </div>
                        <div class="control-group">
                            <div class="checkbox-control">
                                <input type="checkbox" id="animateTransitions" checked aria-label="Animate transitions">
                                <label for="animateTransitions">Animate Transitions</label>
                            </div>
                        </div>
                        <div class="control-group">
                            <div class="checkbox-control">
                                <input type="checkbox" id="showAnnotations" checked aria-label="Show annotations">
                                <label for="showAnnotations">Show Annotations</label>
                            </div>
                        </div>
                        <div class="control-group color-picker-group">
                            <label for="backgroundColor">Background:</label>
                            <input type="color" id="backgroundColor" value="#f8f9fa" aria-label="Select background color">
                        </div>
                    </div>
                </div>
                <div class="legend" id="chartLegend" role="region" aria-label="Chart legend"></div>
                <div class="insights-panel">
                    <h4>Why Line Charts Excel for Time Series</h4>
                    <ul>
                        <li><strong>Continuity</strong> - Line charts show the continuous nature of time data</li>
                        <li><strong>Trend Visibility</strong> - Makes upward and downward trends immediately apparent</li>
                        <li><strong>Multiple Series</strong> - Can effectively display multiple data series for comparison</li>
                        <li><strong>Density</strong> - Can display many data points while maintaining readability</li>
                        <li><strong>Familiarity</strong> - Widely understood visualization that requires minimal training to interpret</li>
                    </ul>
                </div>
            </div>

            <div class="card" role="tabpanel">
                <div class="card-title">
                    <span>
                        Advanced Time Series Analysis
                        <span class="info-tooltip" data-tooltip="Shows statistical measures and anomaly detection" role="tooltip" tabindex="0">i</span>
                        <span class="anomaly-badge" id="anomalyCount">3 anomalies</span>
                    </span>
                    <div class="chart-actions">
                        <button class="chart-action-btn" id="resetStatsZoomBtn" aria-label="Reset zoom">
                            <i>⟲</i> Reset Zoom <span class="keyboard-shortcut">Esc</span>
                        </button>
                        <button class="chart-action-btn" id="downloadStatsBtn" aria-label="Download statistics">
                            <i>↓</i> Download
                        </button>
                    </div>
                </div>
                <div class="chart-container">
                    <canvas id="statsChart" aria-label="Statistical analysis chart" role="img"></canvas>
                    <div class="floating-controls" id="statsControls">
                        <div class="control-group">
                            <label for="movingAverage">Moving Average</label>
                            <select id="movingAverage" aria-label="Select moving average period">
                                <option value="none">None</option>
                                <option value="7" selected>7-day</option>
                                <option value="14">14-day</option>
                                <option value="30">30-day</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <div class="checkbox-control">
                                <input type="checkbox" id="showTrendLine" checked aria-label="Show trend line">
                                <label for="showTrendLine">Show Trend Line</label>
                            </div>
                        </div>
                        <div class="control-group">
                            <div class="checkbox-control">
                                <input type="checkbox" id="showConfidenceInterval" checked aria-label="Show confidence interval">
                                <label for="showConfidenceInterval">Show Confidence Interval</label>
                            </div>
                        </div>
                        <div class="control-group">
                            <label for="anomalyDetection">Anomaly Detection</label>
                            <select id="anomalyDetection" aria-label="Select anomaly detection method">
                                <option value="none">None</option>
                                <option value="zscore" selected>Z-Score</option>
                                <option value="iqr">IQR</option>
                            </select>
                        </div>
                        <div class="control-group range-control">
                            <label for="anomalyThreshold">Anomaly Threshold</label>
                            <input type="range" id="anomalyThreshold" min="1" max="5" step="0.1" value="2.5" aria-label="Adjust anomaly threshold">
                            <div class="range-values">
                                <span>More Sensitive</span>
                                <span>Less Sensitive</span>
                            </div>
                        </div>
                        <div class="control-group">
                            <div class="checkbox-control">
                                <input type="checkbox" id="showSeasonality" aria-label="Show seasonality">
                                <label for="showSeasonality">Show Seasonality</label>
                            </div>
                        </div>
                        <div class="control-group">
                            <label for="forecastPeriod">Forecast Period</label>
                            <select id="forecastPeriod" aria-label="Select forecast period">
                                <option value="0">No Forecast</option>
                                <option value="7">7 Days</option>
                                <option value="14">14 Days</option>
                                <option value="30">30 Days</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="legend" id="statsLegend" role="region" aria-label="Statistics legend"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { Chart } from "https://esm.sh/chart.js/auto";
        import { annotationPlugin } from "https://esm.sh/chartjs-plugin-annotation";
        import { zoomPlugin } from "https://esm.sh/chartjs-plugin-zoom";

        Chart.register(annotationPlugin, zoomPlugin);

        // Define color palettes
        const colorPalettes = {
            default: ['#4285f4', '#34a853', '#fbbc05', '#ea4335', '#5f6368'],
            monochrome: ['#4285f4', '#72a0f4', '#a0bef5', '#cddcf7', '#e8eff8'],
            rainbow: ['#4285f4', '#34a853', '#fbbc05', '#ea4335', '#9c27b0'],
            warm: ['#ea4335', '#fbbc05', '#ff7043', '#ff5722', '#e64a19'],
            cool: ['#4285f4', '#03a9f4', '#00bcd4', '#009688', '#34a853']
        };

        // Generate sample time series data
        function generateTimeSeriesData(days, type = 'sales') {
            const data = [];
            const today = new Date();
            let baseValue = type === 'sales' ? 1000 : 
                           type === 'temperature' ? 20 : 
                           type === 'stock' ? 150 : 500;
            
            let volatility = type === 'stock' ? 0.05 : 0.02;
            let seasonality = type === 'temperature' ? 10 : 
                             type === 'website' ? 200 : 0;
            
            let trend = type === 'sales' ? 0.5 : 
                       type === 'stock' ? 0.2 : 0;
            
            for (let i = days; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                
                // Add trend component
                const trendComponent = trend * (days - i);
                
                // Add seasonality component (weekly pattern for most, yearly for temperature)
                const seasonalComponent = type === 'temperature' 
                    ? seasonality * Math.sin((i / 365) * Math.PI * 2)
                    : seasonality * Math.sin((i % 7) / 7 * Math.PI * 2);
                
                // Add random component
                const randomComponent = baseValue * volatility * (Math.random() * 2 - 1);
                
                // Calculate final value
                let value = baseValue + trendComponent + seasonalComponent + randomComponent;
                value = Math.max(0, value); // Ensure non-negative values
                
                data.push({
                    date: date,
                    value: Math.round(value * 100) / 100
                });
            }
            
            return data;
        }

        // Generate multiple time series for comparison
        function generateMultipleTimeSeries(days, type = 'sales') {
            const mainData = generateTimeSeriesData(days, type);
            let secondaryData, tertiaryData;
            
            if (type === 'sales') {
                // Generate data for different product categories
                secondaryData = mainData.map(point => ({
                    date: new Date(point.date),
                    value: Math.round(point.value * 0.7 * (1 + Math.random() * 0.3))
                }));
                
                tertiaryData = mainData.map(point => ({
                    date: new Date(point.date),
                    value: Math.round(point.value * 0.4 * (1 + Math.random() * 0.3))
                }));
                
                return [
                    { name: 'Product A', data: mainData },
                    { name: 'Product B', data: secondaryData },
                    { name: 'Product C', data: tertiaryData }
                ];
            } else if (type === 'temperature') {
                // Generate temperature data for different cities
                secondaryData = mainData.map(point => ({
                    date: new Date(point.date),
                    value: point.value - 5 + Math.random() * 3
                }));
                
                tertiaryData = mainData.map(point => ({
                    date: new Date(point.date),
                    value: point.value + 5 + Math.random() * 3
                }));
                
                return [
                    { name: 'New York', data: mainData },
                    { name: 'Chicago', data: secondaryData },
                    { name: 'Miami', data: tertiaryData }
                ];
            } else if (type === 'stock') {
                // Generate stock data for different companies
                secondaryData = mainData.map(point => ({
                    date: new Date(point.date),
                    value: 80 + Math.random() * 30
                }));
                
                tertiaryData = mainData.map(point => ({
                    date: new Date(point.date),
                    value: 200 + Math.random() * 50
                }));
                
                return [
                    { name: 'AAPL', data: mainData },
                    { name: 'MSFT', data: secondaryData },
                    { name: 'GOOG', data: tertiaryData }
                ];
            } else { // website traffic
                // Generate traffic data for different sources
                secondaryData = mainData.map(point => ({
                    date: new Date(point.date),
                    value: Math.round(point.value * 0.6 * (1 + Math.random() * 0.4))
                }));
                
                tertiaryData = mainData.map(point => ({
                    date: new Date(point.date),
                    value: Math.round(point.value * 0.3 * (1 + Math.random() * 0.4))
                }));
                
                return [
                    { name: 'Direct', data: mainData },
                    { name: 'Organic Search', data: secondaryData },
                    { name: 'Social Media', data: tertiaryData }
                ];
            }
        }

        // Generate data for candlestick chart
        function generateCandlestickData(days) {
            const data = [];
            const today = new Date();
            let baseValue = 150;
            let volatility = 0.03;
            
            for (let i = days; i >= 0; i--) {
                const date = new Date(today);
                date.setDate(today.getDate() - i);
                
                // Calculate random changes
                const change = baseValue * volatility * (Math.random() * 2 - 1);
                const open = baseValue;
                baseValue = baseValue + change;
                const close = baseValue;
                
                // Determine high and low values
                const high = Math.max(open, close) + Math.random() * 5;
                const low = Math.min(open, close) - Math.random() * 5;
                
                data.push({
                    date: date,
                    open: Math.round(open * 100) / 100,
                    high: Math.round(high * 100) / 100,
                    low: Math.round(low * 100) / 100,
                    close: Math.round(close * 100) / 100
                });
            }
            
            return data;
        }

        // Calculate moving average
        function calculateMovingAverage(data, window) {
            const result = [];
            
            for (let i = 0; i < data.length; i++) {
                if (i < window - 1) {
                    result.push(null); // Not enough data points yet
                    continue;
                }
                
                let sum = 0;
                for (let j = 0; j < window; j++) {
                    sum += data[i - j].value;
                }
                
                result.push({
                    date: new Date(data[i].date),
                    value: sum / window
                });
            }
            
            return result;
        }

        // Calculate linear regression for trend line
        function calculateTrendLine(data) {
            const n = data.length;
            let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
            
            // Use day index as x value for simplicity
            for (let i = 0; i < n; i++) {
                const x = i;
                const y = data[i].value;
                
                sumX += x;
                sumY += y;
                sumXY += x * y;
                sumX2 += x * x;
            }
            
            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            
            // Generate trend line points
            return data.map((point, i) => ({
                date: new Date(point.date),
                value: intercept + slope * i
            }));
        }

        // Detect anomalies using Z-score method
        function detectAnomaliesZScore(data, threshold = 2.5) {
            // Calculate mean and standard deviation
            const values = data.map(d => d.value);
            const mean = values.reduce((sum, val) => sum + val, 0) / values.length;
            
            const squaredDiffs = values.map(val => Math.pow(val - mean, 2));
            const variance = squaredDiffs.reduce((sum, val) => sum + val, 0) / values.length;
            const stdDev = Math.sqrt(variance);
            
            // Identify anomalies
            return data.map((point, i) => {
                const zScore = Math.abs((point.value - mean) / stdDev);
                return {
                    date: new Date(point.date),
                    value: point.value,
                    isAnomaly: zScore > threshold
                };
            });
        }

        // Create preview charts
        function createPreviewCharts() {
            const previewData = generateTimeSeriesData(20, 'sales');
            const labels = previewData.map(d => d.date);
            const values = previewData.map(d => d.value);
            
            // Line Chart Preview
            new Chart(document.getElementById('lineChartPreview').getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Sales',
                        data: values,
                        borderColor: colorPalettes.default[0],
                        backgroundColor: 'transparent',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    },
                    elements: {
                        point: { radius: 0 }
                    }
                }
            });
            
            // Area Chart Preview
            new Chart(document.getElementById('areaChartPreview').getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Sales',
                        data: values,
                        borderColor: colorPalettes.default[0],
                        backgroundColor: `${colorPalettes.default[0]}33`,
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    },
                    elements: {
                        point: { radius: 0 }
                    }
                }
            });
            
            // Bar Chart Preview
            new Chart(document.getElementById('barChartPreview').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Sales',
                        data: values,
                        backgroundColor: colorPalettes.default[0]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    }
                }
            });
            
            // Candlestick Preview (simulated with box plot)
            const candlestickData = generateCandlestickData(10);
            const ctx = document.getElementById('candlestickPreview').getContext('2d');
            
            // Draw custom candlestick chart
            ctx.fillStyle = '#f8f9fa';
            ctx.fillRect(0, 0, 280, 160);
            
            const width = 280;
            const height = 160;
            const padding = 20;
            const barWidth = (width - 2 * padding) / candlestickData.length;
            
            const min = Math.min(...candlestickData.map(d => d.low));
            const max = Math.max(...candlestickData.map(d => d.high));
            const range = max - min;
            
            candlestickData.forEach((d, i) => {
                const x = padding + i * barWidth + barWidth / 2;
                const openY = height - padding - (d.open - min) / range * (height - 2 * padding);
                const closeY = height - padding - (d.close - min) / range * (height - 2 * padding);
                const highY = height - padding - (d.high - min) / range * (height - 2 * padding);
                const lowY = height - padding - (d.low - min) / range * (height - 2 * padding);
                
                // Draw the wick
                ctx.beginPath();
                ctx.moveTo(x, highY);
                ctx.lineTo(x, lowY);
                ctx.strokeStyle = '#666';
                ctx.lineWidth = 1;
                ctx.stroke();
                
                // Draw the body
                ctx.fillStyle = d.close > d.open ? '#34a853' : '#ea4335';
                const bodyHeight = Math.abs(closeY - openY);
                const bodyY = Math.min(closeY, openY);
                ctx.fillRect(x - barWidth / 4, bodyY, barWidth / 2, bodyHeight);
            });
            
            // Heatmap Preview
            const heatmapCtx = document.getElementById('heatmapPreview').getContext('2d');
            
            // Draw custom heatmap
            heatmapCtx.fillStyle = '#f8f9fa';
            heatmapCtx.fillRect(0, 0, 280, 160);
            
            const cellSize = 20;
            const rows = 7; // days of week
            const cols = 12; // months or weeks
            
            for (let row = 0; row < rows; row++) {
                for (let col = 0; col < cols; col++) {
                    const value = Math.random();
                    const intensity = Math.floor(value * 255);
                    heatmapCtx.fillStyle = `rgba(66, 133, 244, ${value.toFixed(2)})`;
                    heatmapCtx.fillRect(
                        padding + col * cellSize, 
                        padding + row * cellSize, 
                        cellSize - 2, 
                        cellSize - 2
                    );
                }
            }
            
            // Scatter Plot Preview
            new Chart(document.getElementById('scatterPreview').getContext('2d'), {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Sales',
                        data: previewData.map(d => ({
                            x: d.date,
                            y: d.value
                        })),
                        backgroundColor: colorPalettes.default[0]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    },
                    scales: {
                        x: { display: false },
                        y: { display: false }
                    }
                }
            });
        }

        // Initialize charts
        let timeSeriesChart, statsChart;
        let currentData, currentType = 'sales';
        
        function initializeCharts() {
            // Create preview charts
            createPreviewCharts();
            
            // Get the context for the time series chart
            const timeSeriesCtx = document.getElementById('timeSeriesChart').getContext('2d');
            
            // Initialize with 30 days of data
            currentData = generateMultipleTimeSeries(30, currentType);
            
            // Create the time series chart
            timeSeriesChart = new Chart(timeSeriesCtx, {
                type: 'line',
                data: {
                    datasets: currentData.map((series, i) => ({
                        label: series.name,
                        data: series.data.map(point => ({
                            x: point.date,
                            y: point.value
                        })),
                        borderColor: colorPalettes.default[i],
                        backgroundColor: `${colorPalettes.default[i]}33`,
                        borderWidth: 2,
                        tension: 0.4,
                        pointRadius: 3,
                        pointHoverRadius: 6
                    }))
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    onClick: (e) => {
                        document.getElementById('chartControls').classList.toggle('active');
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.7)',
                            titleFont: {
                                size: 14
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                title: function(context) {
                                    return new Date(context[0].parsed.x).toLocaleDateString();
                                }
                            }
                        },
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'x',
                                modifierKey: 'ctrl'
                            },
                            zoom: {
                                wheel: {
                                    enabled: true,
                                    modifierKey: 'ctrl'
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x',
                                onZoomComplete: function() {
                                    // Update UI to show zoom state
                                    document.getElementById('resetZoomBtn').style.display = 'flex';
                                }
                            }
                        },
                        annotation: {
                            annotations: {
                                line1: {
                                    type: 'line',
                                    yMin: calculateAverage(currentData[0].data),
                                    yMax: calculateAverage(currentData[0].data),
                                    borderColor: 'rgba(66, 133, 244, 0.3)',
                                    borderWidth: 2,
                                    borderDash: [5, 5],
                                    label: {
                                        content: 'Average',
                                        display: true,
                                        position: 'start',
                                        backgroundColor: 'rgba(66, 133, 244, 0.7)',
                                        color: 'white',
                                        font: {
                                            size: 12
                                        }
                                    }
                                },
                                point1: {
                                    type: 'point',
                                    xValue: currentData[0].data[15].date,
                                    yValue: currentData[0].data[15].value,
                                    backgroundColor: 'rgba(255, 99, 132, 0.8)',
                                    borderWidth: 3,
                                    borderColor: 'white',
                                    radius: 8,
                                    label: {
                                        content: 'Key Event',
                                        display: true,
                                        backgroundColor: 'rgba(255, 99, 132, 0.8)',
                                        color: 'white',
                                        font: {
                                            size: 12
                                        }
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                tooltipFormat: 'PP'
                            },
                            title: {
                                display: true,
                                text: 'Date'
                            },
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: getYAxisLabel()
                            },
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuad'
                    },
                    transitions: {
                        active: {
                            animation: {
                                duration: 400
                            }
                        }
                    }
                }
            });
            
            // Create legend items
            updateLegend();
            
            // Get the context for the stats chart
            const statsCtx = document.getElementById('statsChart').getContext('2d');
            
            // Create datasets for the stats chart
            const mainSeries = currentData[0].data;
            const movingAvgData = calculateMovingAverage(mainSeries, 7);
            const trendLineData = calculateTrendLine(mainSeries);
            const anomalies = detectAnomaliesZScore(mainSeries);
            
            // Create the stats chart
            statsChart = new Chart(statsCtx, {
                type: 'line',
                data: {
                    datasets: [
                        {
                            label: currentData[0].name,
                            data: mainSeries.map(point => ({
                                x: point.date,
                                y: point.value
                            })),
                            borderColor: colorPalettes.default[0],
                            backgroundColor: `${colorPalettes.default[0]}33`,
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 3,
                            pointHoverRadius: 6
                        },
                        {
                            label: '7-Day Moving Average',
                            data: movingAvgData.map(point => point ? {
                                x: point.date,
                                y: point.value
                            } : null),
                            borderColor: colorPalettes.default[1],
                            borderWidth: 2,
                            borderDash: [5, 5],
                            tension: 0.4,
                            pointRadius: 0,
                            fill: false
                        },
                        {
                            label: 'Trend Line',
                            data: trendLineData.map(point => ({
                                x: point.date,
                                y: point.value
                            })),
                            borderColor: colorPalettes.default[2],
                            borderWidth: 2,
                            tension: 0,
                            pointRadius: 0,
                            fill: false
                        },
                        {
                            label: 'Anomalies',
                            data: anomalies.filter(point => point.isAnomaly).map(point => ({
                                x: point.date,
                                y: point.value
                            })),
                            backgroundColor: colorPalettes.default[3],
                            borderColor: colorPalettes.default[3],
                            pointRadius: 6,
                            pointHoverRadius: 8,
                            pointStyle: 'circle',
                            showLine: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false
                    },
                    onClick: (e) => {
                        document.getElementById('statsControls').classList.toggle('active');
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.7)',
                            titleFont: {
                                size: 14
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                title: function(context) {
                                    return new Date(context[0].parsed.x).toLocaleDateString();
                                },
                                afterLabel: function(context) {
                                    if (context.datasetIndex === 3) { // Anomalies
                                        return 'This point is an anomaly';
                                    }
                                    return '';
                                }
                            }
                        },
                        zoom: {
                            pan: {
                                enabled: true,
                                mode: 'x',
                                modifierKey: 'ctrl'
                            },
                            zoom: {
                                wheel: {
                                    enabled: true,
                                    modifierKey: 'ctrl'
                                },
                                pinch: {
                                    enabled: true
                                },
                                mode: 'x',
                                onZoomComplete: function() {
                                    // Update UI to show zoom state
                                    document.getElementById('resetStatsZoomBtn').style.display = 'flex';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                tooltipFormat: 'PP'
                            },
                            title: {
                                display: true,
                                text: 'Date'
                            },
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: getYAxisLabel()
                            },
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuad'
                    }
                }
            });
            
            // Create legend for stats chart
            updateStatsLegend();
            
            // Update anomaly count badge
            updateAnomalyCount(anomalies);
        }
        
        function calculateAverage(data) {
            const sum = data.reduce((total, point) => total + point.value, 0);
            return sum / data.length;
        }
        
        function updateAnomalyCount(anomalies) {
            const count = anomalies.filter(point => point.isAnomaly).length;
            const badge = document.getElementById('anomalyCount');
            badge.textContent = `${count} anomalies`;
            
            if (count === 0) {
                badge.style.display = 'none';
            } else {
                badge.style.display = 'inline-block';
            }
        }

        function getYAxisLabel() {
            switch(currentType) {
                case 'sales': return 'Sales ($)';
                case 'temperature': return 'Temperature (°C)';
                case 'stock': return 'Price ($)';
                case 'website': return 'Visitors';
                default: return 'Value';
            }
        }

        function updateLegend() {
            const legendContainer = document.getElementById('chartLegend');
            legendContainer.innerHTML = '';
            
            currentData.forEach((series, i) => {
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.dataset.index = i;
                legendItem.setAttribute('tabindex', '0');
                legendItem.setAttribute('role', 'button');
                legendItem.setAttribute('aria-label', `Toggle ${series.name} visibility`);
                
                const colorBox = document.createElement('div');
                colorBox.className = 'legend-color';
                colorBox.style.backgroundColor = timeSeriesChart.data.datasets[i].borderColor;
                
                const label = document.createElement('span');
                label.textContent = series.name;
                
                legendItem.appendChild(colorBox);
                legendItem.appendChild(label);
                
                // Add click event to toggle visibility
                legendItem.addEventListener('click', () => {
                    toggleDatasetVisibility(legendItem, i, timeSeriesChart);
                });
                
                // Add keyboard support
                legendItem.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        toggleDatasetVisibility(legendItem, i, timeSeriesChart);
                    }
                });
                
                legendContainer.appendChild(legendItem);
            });
        }
        
        function toggleDatasetVisibility(legendItem, index, chart) {
            const isDatasetVisible = chart.isDatasetVisible(index);
            const colorBox = legendItem.querySelector('.legend-color');
            const label = legendItem.querySelector('span');
            
            if (isDatasetVisible) {
                chart.hide(index);
                colorBox.style.opacity = 0.3;
                label.style.opacity = 0.3;
                legendItem.setAttribute('aria-pressed', 'false');
            } else {
                chart.show(index);
                colorBox.style.opacity = 1;
                label.style.opacity = 1;
                legendItem.setAttribute('aria-pressed', 'true');
            }
        }

        function updateStatsLegend() {
            const legendContainer = document.getElementById('statsLegend');
            legendContainer.innerHTML = '';
            
            const labels = [
                currentData[0].name,
                '7-Day Moving Average',
                'Trend Line',
                'Anomalies'
            ];
            
            labels.forEach((label, i) => {
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                legendItem.dataset.index = i;
                legendItem.setAttribute('tabindex', '0');
                legendItem.setAttribute('role', 'button');
                legendItem.setAttribute('aria-label', `Toggle ${label} visibility`);
                
                const colorBox = document.createElement('div');
                colorBox.className = 'legend-color';
                colorBox.style.backgroundColor = statsChart.data.datasets[i].borderColor;
                
                const labelSpan = document.createElement('span');
                labelSpan.textContent = label;
                
                legendItem.appendChild(colorBox);
                legendItem.appendChild(labelSpan);
                
                // Add click event to toggle visibility
                legendItem.addEventListener('click', () => {
                    toggleDatasetVisibility(legendItem, i, statsChart);
                });
                
                // Add keyboard support
                legendItem.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        toggleDatasetVisibility(legendItem, i, statsChart);
                    }
                });
                
                legendContainer.appendChild(legendItem);
            });
        }

        // Reset zoom buttons
        document.getElementById('resetZoomBtn').addEventListener('click', () => {
            timeSeriesChart.resetZoom();
        });
        
        document.getElementById('resetStatsZoomBtn').addEventListener('click', () => {
            statsChart.resetZoom();
        });
        
        // Export data buttons
        document.getElementById('exportDataBtn').addEventListener('click', () => {
            exportToCSV(currentData, 'time_series_data.csv');
        });
        
        document.getElementById('downloadStatsBtn').addEventListener('click', () => {
            const mainSeries = currentData[0].data;
            const movingAvgData = calculateMovingAverage(mainSeries, parseInt(document.getElementById('movingAverage').value) || 7);
            const trendLineData = calculateTrendLine(mainSeries);
            const anomalies = detectAnomaliesZScore(mainSeries);
            
            const exportData = [
                { name: currentData[0].name, data: mainSeries },
                { name: 'Moving Average', data: movingAvgData },
                { name: 'Trend Line', data: trendLineData },
                { name: 'Anomalies', data: anomalies.filter(point => point.isAnomaly) }
            ];
            
            exportToCSV(exportData, 'statistical_analysis.csv');
        });
        
        function exportToCSV(data, filename) {
            // Prepare CSV content
            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Add header row
            let headers = ["Date"];
            data.forEach(series => {
                headers.push(series.name);
            });
            csvContent += headers.join(",") + "\r\n";
            
            // Create a map of dates to values for each series
            const dateMap = new Map();
            
            data.forEach(series => {
                series.data.forEach(point => {
                    if (point) {
                        const dateStr = point.date.toISOString().split('T')[0];
                        if (!dateMap.has(dateStr)) {
                            dateMap.set(dateStr, Array(data.length).fill(""));
                        }
                        const index = headers.indexOf(series.name) - 1;
                        dateMap.get(dateStr)[index] = point.value;
                    }
                });
            });
            
            // Sort dates and add to CSV
            Array.from(dateMap.keys()).sort().forEach(dateStr => {
                const values = dateMap.get(dateStr);
                csvContent += dateStr + "," + values.join(",") + "\r\n";
            });
            
            // Create download link
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        
        // Chart type tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => {
                    t.classList.remove('active');
                    t.setAttribute('aria-selected', 'false');
                });
                tab.classList.add('active');
                tab.setAttribute('aria-selected', 'true');
                
                const chartType = tab.dataset.tab;
                if (chartType === 'line' || chartType === 'bar') {
                    timeSeriesChart.config.type = chartType;
                    timeSeriesChart.data.datasets.forEach(dataset => {
                        dataset.fill = false;
                    });
                    timeSeriesChart.update();
                } else if (chartType === 'area') {
                    timeSeriesChart.config.type = 'line';
                    timeSeriesChart.data.datasets.forEach(dataset => {
                        dataset.fill = true;
                    });
                    timeSeriesChart.update();
                } else if (chartType === 'candlestick') {
                    // For simplicity, we're not implementing a full candlestick chart
                    // Just changing to a bar chart to indicate a different visualization
                    timeSeriesChart.config.type = 'bar';
                    timeSeriesChart.update();
                }
            });
            
            // Add keyboard support for tabs
            tab.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    tab.click();
                }
            });
        });
        
        // Visualization type cards
        document.querySelectorAll('.viz-type-card').forEach(card => {
            card.addEventListener('click', () => {
                document.querySelectorAll('.viz-type-card').forEach(c => {
                    c.classList.remove('selected');
                    c.setAttribute('aria-pressed', 'false');
                });
                card.classList.add('selected');
                card.setAttribute('aria-pressed', 'true');
            });
            
            // Add keyboard support
            card.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    card.click();
                }
            });
        });
        
        // Chart controls
        document.getElementById('chartType').addEventListener('change', e => {
            const type = e.target.value;
            timeSeriesChart.config.type = type === 'area' ? 'line' : type;
            
            if (type === 'area') {
                timeSeriesChart.data.datasets.forEach(dataset => {
                    dataset.fill = true;
                });
            } else {
                timeSeriesChart.data.datasets.forEach(dataset => {
                    dataset.fill = false;
                });
            }
            
            timeSeriesChart.update();
        });
        
        document.getElementById('lineSmoothing').addEventListener('change', e => {
            const tension = parseFloat(e.target.value);
            timeSeriesChart.data.datasets.forEach(dataset => {
                dataset.tension = tension;
            });
            timeSeriesChart.update();
        });
        
        document.getElementById('pointSize').addEventListener('input', e => {
            const size = parseInt(e.target.value);
            timeSeriesChart.data.datasets.forEach(dataset => {
                dataset.pointRadius = size;
                dataset.pointHoverRadius = size + 3;
            });
            timeSeriesChart.update();
        });
        
        document.getElementById('yAxisScale').addEventListener('change', e => {
            const scale = e.target.value;
            timeSeriesChart.options.scales.y.type = scale;
            statsChart.options.scales.y.type = scale;
            timeSeriesChart.update();
            statsChart.update();
        });
        
        document.getElementById('colorScheme').addEventListener('change', e => {
            const scheme = e.target.value;
            const palette = colorPalettes[scheme] || colorPalettes.default;
            
            timeSeriesChart.data.datasets.forEach((dataset, i) => {
                dataset.borderColor = palette[i % palette.length];
                dataset.backgroundColor = `${palette[i % palette.length]}33`;
            });
            
            statsChart.data.datasets.forEach((dataset, i) => {
                dataset.borderColor = palette[i % palette.length];
                if (i === 0) {
                    dataset.backgroundColor = `${palette[i % palette.length]}33`;
                } else if (i === 3) { // Anomalies
                    dataset.backgroundColor = palette[i % palette.length];
                }
            });
            
            timeSeriesChart.update();
            statsChart.update();
            updateLegend();
            updateStatsLegend();
        });
        
        document.getElementById('showGrid').addEventListener('change', e => {
            const showGrid = e.target.checked;
            timeSeriesChart.options.scales.x.grid.display = showGrid;
            timeSeriesChart.options.scales.y.grid.display = showGrid;
            timeSeriesChart.update();
        });
        
        document.getElementById('animateTransitions').addEventListener('change', e => {
            const animate = e.target.checked;
            timeSeriesChart.options.animation.duration = animate ? 1000 : 0;
            timeSeriesChart.update();
        });
        
        document.getElementById('showAnnotations').addEventListener('change', e => {
            const showAnnotations = e.target.checked;
            timeSeriesChart.options.plugins.annotation.annotations.point1.display = showAnnotations;
            timeSeriesChart.update();
        });
        
        document.getElementById('backgroundColor').addEventListener('change', e => {
            const color = e.target.value;
            document.documentElement.style.setProperty('--chart-background', color);
            timeSeriesChart.update();
        });
        
        // Stats controls
        document.getElementById('movingAverage').addEventListener('change', e => {
            const window = parseInt(e.target.value);
            if (window === 'none') {
                statsChart.hide(1);
                return;
            }
            
            const mainSeries = currentData[0].data;
            const movingAvgData = calculateMovingAverage(mainSeries, window);
            
            statsChart.data.datasets[1].data = movingAvgData.map(point => point ? {
                x: point.date,
                y: point.value
            } : null);
            
            statsChart.data.datasets[1].label = `${window}-Day Moving Average`;
            statsChart.show(1);
            statsChart.update();
            updateStatsLegend();
        });
        
        document.getElementById('showTrendLine').addEventListener('change', e => {
            if (e.target.checked) {
                statsChart.show(2);
            } else {
                statsChart.hide(2);
            }
        });
        
        document.getElementById('showConfidenceInterval').addEventListener('change', e => {
            // For simplicity, we're not implementing a full confidence interval
            // This would require adding additional datasets
        });
        
        document.getElementById('anomalyDetection').addEventListener('change', e => {
            const method = e.target.value;
            if (method === 'none') {
                statsChart.hide(3);
                return;
            }
            
            const mainSeries = currentData[0].data;
            const threshold = parseFloat(document.getElementById('anomalyThreshold').value);
            const anomalies = method === 'zscore' 
                ? detectAnomaliesZScore(mainSeries, threshold) 
                : detectAnomaliesZScore(mainSeries, threshold * 0.6); // Using Z-score with different threshold for IQR
            
            statsChart.data.datasets[3].data = anomalies.filter(point => point.isAnomaly).map(point => ({
                x: point.date,
                y: point.value
            }));
            
            statsChart.show(3);
            statsChart.update();
            
            // Update anomaly count badge
            updateAnomalyCount(anomalies);
        });
        
        document.getElementById('anomalyThreshold').addEventListener('input', e => {
            const threshold = parseFloat(e.target.value);
            const method = document.getElementById('anomalyDetection').value;
            
            if (method === 'none') return;
            
            const mainSeries = currentData[0].data;
            const anomalies = method === 'zscore' 
                ? detectAnomaliesZScore(mainSeries, threshold) 
                : detectAnomaliesZScore(mainSeries, threshold * 0.6);
            
            statsChart.data.datasets[3].data = anomalies.filter(point => point.isAnomaly).map(point => ({
                x: point.date,
                y: point.value
            }));
            
            statsChart.update();
            
            // Update anomaly count badge
            updateAnomalyCount(anomalies);
        });
        
        document.getElementById('showSeasonality').addEventListener('change', e => {
            // For simplicity, we're not implementing full seasonality detection
        });
        
        document.getElementById('forecastPeriod').addEventListener('change', e => {
            const days = parseInt(e.target.value);
            
            if (days === 0) {
                // Remove forecast dataset if it exists
                if (statsChart.data.datasets.length > 4) {
                    statsChart.data.datasets.pop();
                    statsChart.update();
                    updateStatsLegend();
                }
                return;
            }
            
            // Simple forecast based on trend line
            const mainSeries = currentData[0].data;
            const trendLineData = calculateTrendLine(mainSeries);
            
            // Get the slope from the trend line
            const lastDay = mainSeries[mainSeries.length - 1].date;
            const lastValue = trendLineData[trendLineData.length - 1].value;
            
            // Calculate daily change from trend
            const dailyChange = (trendLineData[trendLineData.length - 1].value - trendLineData[0].value) / trendLineData.length;
            
            // Generate forecast data points
            const forecastData = [];
            for (let i = 1; i <= days; i++) {
                const forecastDate = new Date(lastDay);
                forecastDate.setDate(lastDay.getDate() + i);
                
                // Add some random variation
                const randomFactor = 1 + (Math.random() * 0.1 - 0.05); // ±5%
                const forecastValue = lastValue + dailyChange * i * randomFactor;
                
                forecastData.push({
                    x: forecastDate,
                    y: forecastValue
                });
            }
            
            // Add or update forecast dataset
            if (statsChart.data.datasets.length > 4) {
                statsChart.data.datasets[4].data = forecastData;
            } else {
                statsChart.data.datasets.push({
                    label: 'Forecast',
                    data: forecastData,
                    borderColor: colorPalettes.default[4],
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    borderDash: [10, 5],
                    pointRadius: 3,
                    pointStyle: 'triangle',
                    pointHoverRadius: 6
                });
            }
            
            statsChart.update();
            updateStatsLegend();
        });
        
        // Close control panels when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.floating-controls') && !e.target.closest('canvas')) {
                document.querySelectorAll('.floating-controls').forEach(controls => {
                    controls.classList.remove('active');
                });
            }
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Escape to close control panels
            if (e.key === 'Escape') {
                document.querySelectorAll('.floating-controls').forEach(controls => {
                    controls.classList.remove('active');
                });
                
                // Reset zoom
                timeSeriesChart.resetZoom();
                statsChart.resetZoom();
            }
            
            // Ctrl+Z to reset zoom
            if (e.key === 'z' && (e.ctrlKey || e.metaKey)) {
                timeSeriesChart.resetZoom();
                statsChart.resetZoom();
            }
            
            // Ctrl+E to export data
            if (e.key === 'e' && (e.ctrlKey || e.metaKey)) {
                e.preventDefault();
                exportToCSV(currentData, 'time_series_data.csv');
            }
        });
        
        // Initialize the charts when the page loads
        initializeCharts();
    </script>
</body>
</html>