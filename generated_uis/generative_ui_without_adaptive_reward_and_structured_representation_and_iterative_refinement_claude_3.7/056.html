<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ecosystem Explorers</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #4CAF50; /* Green */
            --secondary-color: #FFC107; /* Amber */
            --accent-color: #2196F3; /* Blue */
            --background-color: #FFFFFF; /* White */
            --card-background: #F9F9F9; /* Light Grey */
            --text-color: #333333; /* Dark Grey */
            --border-color: #DDDDDD; /* Light Grey */
            --success-color: #8BC34A; /* Light Green */
            --error-color: #F44336; /* Red */
            --hover-color: rgba(0, 0, 0, 0.05);
            --transition-speed: 0.3s;
            --border-radius: 8px;
            --spacing-unit: 16px;
        }

        body {
            font-family: 'Nunito', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            display: grid;
            grid-template-rows: auto 1fr auto;
            min-height: 100vh;
        }

        header {
            background-color: var(--primary-color);
            color: white;
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        header h1 {
            margin: 0;
            font-size: 1.8em;
        }

        .nav-buttons {
            display: flex;
            gap: var(--spacing-unit);
        }

        .nav-button, .control-button {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: calc(var(--spacing-unit) * 0.75) calc(var(--spacing-unit) * 1.5);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1em;
            transition: background-color var(--transition-speed) ease, transform var(--transition-speed) ease;
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-unit) * 0.5);
        }

        .nav-button:hover, .control-button:hover {
            background-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .nav-button:active, .control-button:active {
            transform: translateY(0);
        }

        .nav-button.active {
            background-color: var(--secondary-color);
            color: var(--text-color);
        }

        .control-panel {
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 2);
            background-color: var(--card-background);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            gap: var(--spacing-unit);
            align-items: center;
        }

        .control-panel label {
            font-weight: 600;
            margin-right: calc(var(--spacing-unit) * 0.5);
        }

        .control-panel button {
             background-color: var(--accent-color);
             color: white;
             border: none;
             padding: calc(var(--spacing-unit) * 0.5) var(--spacing-unit);
             border-radius: var(--border-radius);
             cursor: pointer;
             font-size: 0.9em;
             transition: background-color var(--transition-speed) ease;
        }

        .control-panel button:hover {
            background-color: #1976D2; /* Darker Blue */
        }

        main {
            padding: calc(var(--spacing-unit) * 2);
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing-unit) * 2);
        }

        .module-section {
            display: none; /* Hidden by default */
            background-color: var(--card-background);
            padding: calc(var(--spacing-unit) * 2);
            border-radius: var(--border-radius);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .module-section.active {
            display: block;
        }

        .module-section h2 {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: calc(var(--spacing-unit) * 1.5);
            font-size: 1.5em;
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: var(--spacing-unit);
        }

        /* Food Web Builder Specific Styles */
        .food-web-container {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: calc(var(--spacing-unit) * 2);
            min-height: 500px;
        }

        .organism-palette {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-unit);
            background-color: var(--background-color);
            overflow-y: auto;
        }

        .organism-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: var(--spacing-unit);
            cursor: grab;
            padding: var(--spacing-unit) * 0.5;
            border-radius: var(--border-radius) * 0.5;
            transition: background-color var(--transition-speed) ease;
        }

        .organism-item:hover {
            background-color: var(--hover-color);
        }

        .organism-item img {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 50%;
            border: 2px solid var(--primary-color);
        }

        .organism-item span {
            margin-top: calc(var(--spacing-unit) * 0.5);
            font-size: 0.9em;
            text-align: center;
        }

        .food-web-area {
            border: 1px dashed var(--border-color);
            border-radius: var(--border-radius);
            position: relative;
            background-color: var(--background-color);
            overflow: hidden; /* Hide overflow from SVG lines */
        }

        .food-web-area svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Allow clicks to pass through to nodes */
        }

        .food-web-node {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: move;
            padding: calc(var(--spacing-unit) * 0.5);
            background-color: var(--card-background);
            border: 2px solid var(--accent-color);
            border-radius: var(--border-radius);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: box-shadow var(--transition-speed) ease;
        }

        .food-web-node:hover {
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        .food-web-node img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 50%;
        }

        .food-web-node span {
            margin-top: calc(var(--spacing-unit) * 0.5);
            font-size: 0.8em;
            text-align: center;
        }

        .food-web-area line {
            stroke: var(--primary-color);
            stroke-width: 2;
            marker-end: url(#arrowhead);
        }

        /* Energy Flow Specific Styles */
        .energy-flow-diagram {
            /* Styles for the energy flow visualization area */
            min-height: 400px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-unit);
            background-color: var(--background-color);
            position: relative;
        }

        .energy-flow-diagram .energy-indicator {
            position: absolute;
            width: 20px;
            height: 20px;
            background-color: var(--secondary-color);
            border-radius: 50%;
            opacity: 0.8;
            animation: flow 2s linear infinite;
        }

        @keyframes flow {
            0% { transform: translate(0, 0); opacity: 0.8; }
            100% { transform: translate(var(--flow-dx), var(--flow-dy)); opacity: 0.2; }
        }


        /* Habitat Specific Styles */
        .habitat-container {
            position: relative;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden;
            background-color: var(--background-color);
        }

        .habitat-container img {
            display: block;
            width: 100%;
            height: auto;
        }

        .habitat-hotspot {
            position: absolute;
            background-color: rgba(var(--accent-color), 0.3);
            border: 2px solid var(--accent-color);
            border-radius: var(--border-radius) * 0.5;
            cursor: pointer;
            transition: background-color var(--transition-speed) ease;
        }

        .habitat-hotspot:hover {
            background-color: rgba(var(--accent-color), 0.5);
        }

        .habitat-info-popup {
            position: absolute;
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-unit);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            z-index: 10;
            max-width: 300px;
            opacity: 0;
            transform: translateY(10px);
            transition: opacity var(--transition-speed) ease, transform var(--transition-speed) ease;
            pointer-events: none;
        }

        .habitat-info-popup.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        .habitat-info-popup h3 {
            margin-top: 0;
            color: var(--primary-color);
        }

        .habitat-info-popup .close-button {
            position: absolute;
            top: var(--spacing-unit) * 0.5;
            right: var(--spacing-unit) * 0.5;
            background: none;
            border: none;
            font-size: 1.2em;
            cursor: pointer;
            color: var(--text-color);
        }


        /* Glossary Specific Styles */
        .glossary-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: calc(var(--spacing-unit) * 2);
            min-height: 400px;
        }

        .glossary-list {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-unit);
            background-color: var(--background-color);
            overflow-y: auto;
        }

        .glossary-list ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .glossary-list li {
            padding: calc(var(--spacing-unit) * 0.75) var(--spacing-unit);
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background-color var(--transition-speed) ease;
        }

        .glossary-list li:last-child {
            border-bottom: none;
        }

        .glossary-list li:hover {
            background-color: var(--hover-color);
        }

        .glossary-detail {
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: calc(var(--spacing-unit) * 2);
            background-color: var(--background-color);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-unit);
        }

        .glossary-detail h3 {
            margin-top: 0;
            color: var(--primary-color);
        }

        .glossary-detail img {
            max-width: 150px;
            height: auto;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            align-self: center;
        }

        .glossary-detail .audio-buttons {
            display: flex;
            gap: var(--spacing-unit);
            justify-content: center;
        }

        .glossary-detail button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: var(--spacing-unit);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1em;
            transition: background-color var(--transition-speed) ease;
        }

        .glossary-detail button:hover {
            background-color: #1976D2; /* Darker Blue */
        }


        /* Quiz Specific Styles */
        .quiz-container {
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing-unit) * 1.5);
        }

        .quiz-question {
            font-size: 1.2em;
            margin-bottom: var(--spacing-unit);
            color: var(--primary-color);
        }

        .quiz-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-unit);
        }

        .quiz-option-button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: var(--spacing-unit);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1em;
            transition: background-color var(--transition-speed) ease, transform var(--transition-speed) ease;
            text-align: center;
        }

        .quiz-option-button:hover {
            background-color: #1976D2; /* Darker Blue */
            transform: translateY(-2px);
        }

        .quiz-option-button:active {
            transform: translateY(0);
        }

        .quiz-option-button.correct {
            background-color: var(--success-color);
        }

        .quiz-option-button.incorrect {
            background-color: var(--error-color);
        }

        .quiz-feedback {
            margin-top: var(--spacing-unit);
            font-weight: 600;
            min-height: 1.5em; /* Reserve space */
        }

        .quiz-feedback.correct {
            color: var(--success-color);
        }

        .quiz-feedback.incorrect {
            color: var(--error-color);
        }

        /* Accessibility & Control Styles */
        .accessibility-controls {
            display: flex;
            gap: var(--spacing-unit);
            align-items: center;
        }

        .accessibility-controls button {
            background-color: var(--accent-color);
            color: white;
            border: none;
            padding: calc(var(--spacing-unit) * 0.5) var(--spacing-unit);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color var(--transition-speed) ease;
        }

         .accessibility-controls button:hover {
            background-color: #1976D2; /* Darker Blue */
        }

        .simplified-text {
            /* Style for simplified text */
            font-size: 1.1em; /* Slightly larger */
            line-height: 1.8; /* More spacing */
        }

        /* Footer */
        footer {
            background-color: var(--text-color);
            color: white;
            text-align: center;
            padding: var(--spacing-unit);
            font-size: 0.9em;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: var(--spacing-unit);
            }

            .nav-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }

            .food-web-container, .glossary-container {
                grid-template-columns: 1fr;
            }

            .organism-palette {
                max-height: 200px;
                overflow-y: auto;
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
                gap: var(--spacing-unit) * 0.5;
            }

             .organism-item {
                margin-bottom: 0;
            }

            .glossary-detail {
                padding: var(--spacing-unit);
            }

            .control-panel {
                flex-direction: column;
                align-items: stretch;
            }

             .accessibility-controls {
                justify-content: center;
             }
        }

        /* Focus styles for accessibility */
        *:focus {
            outline: 2px solid var(--accent-color);
            outline-offset: 2px;
        }
    </style>
</head>
<body>

    <header>
        <h1>Ecosystem Explorers</h1>
        <div class="nav-buttons">
            <button class="nav-button active" data-module="food-web">Food Web</button>
            <button class="nav-button" data-module="energy-flow">Energy Flow</button>
            <button class="nav-button" data-module="habitat">Habitat</button>
            <button class="nav-button" data-module="glossary">Glossary</button>
            <button class="nav-button" data-module="quiz">Quiz</button>
        </div>
    </header>

    <div class="control-panel">
         <div class="accessibility-controls">
            <label for="tts-toggle">Read Aloud:</label>
            <button id="tts-toggle" aria-label="Toggle Text to Speech">üîä On/Off</button>
            <label for="language-toggle">Language:</label>
            <button id="language-toggle" aria-label="Toggle Simplified Language">üó£Ô∏è Simple Text</button>
        </div>
        <!-- Module-specific controls can go here -->
        <div id="food-web-controls" class="module-controls">
             <button id="clear-web-button">Clear Food Web</button>
             <button id="simulate-web-button">Simulate Energy Flow</button>
        </div>
         <div id="energy-flow-controls" class="module-controls" style="display: none;">
             <!-- Energy flow specific controls -->
             <button id="start-energy-sim">Start Simulation</button>
         </div>
          <div id="habitat-controls" class="module-controls" style="display: none;">
             <!-- Habitat specific controls -->
              <span>Click on parts of the habitat!</span>
         </div>
          <div id="glossary-controls" class="module-controls" style="display: none;">
             <!-- Glossary specific controls -->
              <span>Select a term to learn more!</span>
         </div>
          <div id="quiz-controls" class="module-controls" style="display: none;">
             <!-- Quiz specific controls -->
              <span id="quiz-score">Score: 0/0</span>
         </div>
    </div>

    <main>
        <!-- Food Web Builder Module -->
        <section id="food-web" class="module-section active">
            <h2>Build a Food Web</h2>
            <p>Drag organisms from the palette into the area below. Click and drag between organisms to show who eats whom!</p>
            <div class="food-web-container">
                <div class="organism-palette">
                    <div class="organism-item" draggable="true" data-organism="sun">
                        <img src="https://placehold.co/60x60?text=Sun" alt="Sun icon">
                        <span>Sun</span>
                    </div>
                    <div class="organism-item" draggable="true" data-organism="grass">
                        <img src="https://placehold.co/60x60?text=Grass" alt="Grass icon">
                        <span>Grass</span>
                    </div>
                     <div class="organism-item" draggable="true" data-organism="flower">
                        <img src="https://placehold.co/60x60?text=Flower" alt="Flower icon">
                        <span>Flower</span>
                    </div>
                    <div class="organism-item" draggable="true" data-organism="rabbit">
                        <img src="https://placehold.co/60x60?text=Rabbit" alt="Rabbit icon">
                        <span>Rabbit</span>
                    </div>
                    <div class="organism-item" draggable="true" data-organism="mouse">
                        <img src="https://placehold.co/60x60?text=Mouse" alt="Mouse icon">
                        <span>Mouse</span>
                    </div>
                     <div class="organism-item" draggable="true" data-organism="bird">
                        <img src="https://placehold.co/60x60?text=Bird" alt="Bird icon">
                        <span>Bird</span>
                    </div>
                    <div class="organism-item" draggable="true" data-organism="snake">
                        <img src="https://placehold.co/60x60?text=Snake" alt="Snake icon">
                        <span>Snake</span>
                    </div>
                    <div class="organism-item" draggable="true" data-organism="hawk">
                        <img src="https://placehold.co/60x60?text=Hawk" alt="Hawk icon">
                        <span>Hawk</span>
                    </div>
                     <div class="organism-item" draggable="true" data-organism="fox">
                        <img src="https://placehold.co/60x60?text=Fox" alt="Fox icon">
                        <span>Fox</span>
                    </div>
                </div>
                <div class="food-web-area" id="food-web-area">
                     <svg>
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="7"
                            refX="0" refY="3.5" orient="auto">
                            <polygon points="0 0, 10 3.5, 0 7" fill="var(--primary-color)" />
                            </marker>
                        </defs>
                    </svg>
                </div>
            </div>
        </section>

        <!-- Energy Flow Module -->
        <section id="energy-flow" class="module-section">
             <h2>Energy Flow</h2>
             <p>Observe how energy moves through an ecosystem, starting from the sun!</p>
             <div class="energy-flow-diagram" id="energy-flow-diagram">
                 <!-- Energy flow visualization content will be added here by JS -->
                 <p>Build a food web first, or click "Start Simulation" to see a basic example.</p>
             </div>
        </section>

        <!-- Habitat Interdependence Module -->
        <section id="habitat" class="module-section">
            <h2>Habitat Interdependence</h2>
            <p>Explore a habitat and learn how living things depend on each other and their environment.</p>
            <div class="habitat-container" id="habitat-container">
                <img src="https://placehold.co/800x500?text=Forest+Habitat" alt="Illustration of a forest habitat">
                <!-- Hotspots will be added here by JS -->
                <!-- Example Hotspot (positioned via JS) -->
                <!-- <div class="habitat-hotspot" style="top: 50%; left: 30%; width: 50px; height: 50px;" data-info="tree"></div> -->
                <div class="habitat-info-popup" id="habitat-info-popup">
                    <button class="close-button" aria-label="Close information popup">X</button>
                    <h3 id="popup-title"></h3>
                    <p id="popup-text"></p>
                </div>
            </div>
        </section>

        <!-- Glossary Module -->
        <section id="glossary" class="module-section">
            <h2>Glossary</h2>
            <p>Learn the meaning of important words about ecosystems.</p>
            <div class="glossary-container">
                <div class="glossary-list">
                    <ul id="glossary-list">
                        <!-- Glossary terms will be added here by JS -->
                        <!-- Example: <li data-term="ecosystem">Ecosystem</li> -->
                    </ul>
                </div>
                <div class="glossary-detail" id="glossary-detail">
                     <p>Select a term from the list to see its definition.</p>
                    <!-- Detail content will be added here by JS -->
                    <!-- Example:
                    <h3>Ecosystem</h3>
                    <img src="https://placehold.co/150x100?text=Ecosystem" alt="Ecosystem illustration">
                    <p>A community of living organisms interacting with each other and their physical environment.</p>
                    <div class="audio-buttons">
                        <button class="pronounce-button">Pronounce</button>
                        <button class="tts-button">Read Definition</button>
                    </div>
                    -->
                </div>
            </div>
        </section>

        <!-- Quiz & Activities Module -->
        <section id="quiz" class="module-section">
            <h2>Quiz Time!</h2>
            <p>Test your knowledge about ecosystems, food webs, and energy flow.</p>
            <div class="quiz-container">
                <div id="quiz-question-area">
                     <!-- Quiz question and options will be added here by JS -->
                     <p>Quiz will load here.</p>
                </div>
                 <div id="quiz-feedback" class="quiz-feedback"></div>
                 <button id="next-question-button" style="display: none;">Next Question</button>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2023 Ecosystem Explorers. Created for elementary students.</p>
    </footer>

    <script>
        const modules = ['food-web', 'energy-flow', 'habitat', 'glossary', 'quiz'];
        const navButtons = document.querySelectorAll('.nav-button');
        const moduleSections = document.querySelectorAll('.module-section');
        const controlPanels = document.querySelectorAll('.module-controls');
        const ttsToggle = document.getElementById('tts-toggle');
        const languageToggle = document.getElementById('language-toggle');
        let isTTSActive = false;
        let isSimplifiedLanguageActive = false;

        // --- Navigation ---
        navButtons.forEach(button => {
            button.addEventListener('click', () => {
                const targetModule = button.dataset.module;
                activateModule(targetModule);
            });
        });

        function activateModule(moduleName) {
            moduleSections.forEach(section => {
                section.classList.remove('active');
                if (section.id === moduleName) {
                    section.classList.add('active');
                }
            });
            navButtons.forEach(button => {
                button.classList.remove('active');
                if (button.dataset.module === moduleName) {
                    button.classList.add('active');
                }
            });
             controlPanels.forEach(panel => {
                panel.style.display = 'none';
            });
            const activeControlPanel = document.getElementById(`${moduleName}-controls`);
            if (activeControlPanel) {
                activeControlPanel.style.display = 'flex';
            }
        }

        // --- Accessibility Controls ---
        ttsToggle.addEventListener('click', () => {
            isTTSActive = !isTTSActive;
            ttsToggle.textContent = isTTSActive ? 'üîä On' : 'üîä Off';
            ttsToggle.setAttribute('aria-pressed', isTTSActive);
            // Implement global TTS logic if needed, otherwise rely on individual buttons
        });

        languageToggle.addEventListener('click', () => {
            isSimplifiedLanguageActive = !isSimplifiedLanguageActive;
            languageToggle.textContent = isSimplifiedLanguageActive ? 'üó£Ô∏è Simple Text On' : 'üó£Ô∏è Simple Text Off';
            languageToggle.setAttribute('aria-pressed', isSimplifiedLanguageActive);
            // Apply/remove simplified text class to relevant elements
            document.querySelectorAll('.module-section p, .glossary-detail p, .quiz-question').forEach(el => {
                el.classList.toggle('simplified-text', isSimplifiedLanguageActive);
                // In a real app, you'd swap text content here based on a data source
            });
        });

        function speakText(text) {
            if (!isTTSActive || !('speechSynthesis' in window)) {
                console.log("TTS not active or not supported.");
                return;
            }
            const utterance = new SpeechSynthesisUtterance(text);
            // Optional: configure voice, rate, pitch
            // utterance.voice = ...;
            // utterance.rate = 0.9;
            // utterance.pitch = 1;
            window.speechSynthesis.speak(utterance);
        }

        // Add click listeners to speak text content within active module (basic example)
        document.addEventListener('click', (event) => {
             if (isTTSActive && event.target.closest('.module-section.active')) {
                // Find the closest text element (p, h2, li, span etc.)
                const textElement = event.target.closest('p, h2, h3, li, span, button');
                 if (textElement && !textElement.classList.contains('close-button')) { // Avoid reading close button
                    // Check if the element has significant text content
                    const textToSpeak = textElement.textContent.trim();
                    if (textToSpeak.length > 0 && textToSpeak.length < 200) { // Avoid reading too much text at once
                         // Basic filtering to avoid reading control text repeatedly
                         const isControlText = textElement.closest('.control-panel') || textElement.closest('.nav-buttons') || textElement.classList.contains('quiz-feedback');
                         if (!isControlText) {
                             speakText(textToSpeak);
                         }
                    }
                }
            }
        });


        // --- Food Web Builder ---
        const foodWebArea = document.getElementById('food-web-area');
        const organismPalette = document.querySelector('.organism-palette');
        const clearWebButton = document.getElementById('clear-web-button');
        const simulateWebButton = document.getElementById('simulate-web-button');
        const svg = foodWebArea.querySelector('svg');
        let draggedOrganism = null;
        let foodWebNodes = []; // Array to store node elements and their data
        let connections = []; // Array to store connection data { fromId, toId, lineElement }
        let connectingLine = null; // Line element being drawn
        let startNode = null; // Node where connection drawing started

        // Drag from palette
        organismPalette.addEventListener('dragstart', (event) => {
            draggedOrganism = event.target.closest('.organism-item');
            if (draggedOrganism) {
                event.dataTransfer.effectAllowed = 'copy';
                event.dataTransfer.setData('text/plain', draggedOrganism.dataset.organism);
                draggedOrganism.classList.add('dragging');
            }
        });

         organismPalette.addEventListener('dragend', (event) => {
            if (draggedOrganism) {
                draggedOrganism.classList.remove('dragging');
                draggedOrganism = null;
            }
        });

        // Drag over food web area
        foodWebArea.addEventListener('dragover', (event) => {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'copy';
        });

        // Drop onto food web area
        foodWebArea.addEventListener('drop', (event) => {
            event.preventDefault();
            const organismType = event.dataTransfer.getData('text/plain');
            if (organismType) {
                const rect = foodWebArea.getBoundingClientRect();
                const dropX = event.clientX - rect.left;
                const dropY = event.clientY - rect.top;

                addOrganismNode(organismType, dropX, dropY);
            }
        });

        // Add organism node to the food web area
        function addOrganismNode(type, x, y) {
            const node = document.createElement('div');
            node.classList.add('food-web-node');
            node.dataset.organism = type;
            node.dataset.nodeId = Date.now() + Math.random().toString(16).slice(2); // Simple unique ID
            node.style.left = `${x - 30}px`; // Adjust for center of the node image (approx)
            node.style.top = `${y - 30}px`;

            const img = document.createElement('img');
            img.src = `https://placehold.co/60x60?text=${type.charAt(0).toUpperCase() + type.slice(1)}`;
            img.alt = `${type} icon`;

            const span = document.createElement('span');
            span.textContent = type.charAt(0).toUpperCase() + type.slice(1);

            node.appendChild(img);
            node.appendChild(span);
            foodWebArea.appendChild(node);

            foodWebNodes.push({ element: node, id: node.dataset.nodeId, type: type, x: x - 30, y: y - 30 });

            makeNodeDraggable(node);
            makeNodeConnectable(node);
        }

        // Make node draggable within the food web area
        function makeNodeDraggable(node) {
            let active = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;

            node.addEventListener("touchstart", dragStart, false);
            node.addEventListener("touchend", dragEnd, false);
            node.addEventListener("touchmove", drag, false);

            node.addEventListener("mousedown", dragStart, false);
            node.addEventListener("mouseup", dragEnd, false);
            node.addEventListener("mousemove", drag, false);

            function dragStart(e) {
                 // Prevent starting connection drag if it's a node drag
                 if (connectingLine) return;

                if (e.type === "touchstart") {
                    initialX = e.touches[0].clientX - xOffset;
                    initialY = e.touches[0].clientY - yOffset;
                } else {
                    initialX = e.clientX - xOffset;
                    initialY = e.clientY - yOffset;
                }

                 // Check if the click is on the node element itself, not just the foodWebArea
                 if (e.target === node || node.contains(e.target)) {
                    active = true;
                    node.classList.add('dragging');
                 }
            }

            function dragEnd(e) {
                 if (!active) return;

                initialX = currentX;
                initialY = currentY;

                active = false;
                node.classList.remove('dragging');

                // Update node position in the foodWebNodes array
                const nodeId = node.dataset.nodeId;
                const nodeData = foodWebNodes.find(n => n.id === nodeId);
                if (nodeData) {
                    nodeData.x = parseFloat(node.style.left);
                    nodeData.y = parseFloat(node.style.top);
                }

                // Redraw connections after node moves
                redrawConnections();
            }

            function drag(e) {
                if (!active) return;
                e.preventDefault();

                const rect = foodWebArea.getBoundingClientRect();

                if (e.type === "touchmove") {
                    currentX = e.touches[0].clientX - initialX;
                    currentY = e.touches[0].clientY - initialY;
                } else {
                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;
                }

                xOffset = currentX;
                yOffset = currentY;

                 // Clamp position within foodWebArea bounds
                const maxX = rect.width - node.offsetWidth;
                const maxY = rect.height - node.offsetHeight;
                const newLeft = Math.max(0, Math.min(currentX, maxX));
                const newTop = Math.max(0, Math.min(currentY, maxY));

                node.style.left = `${newLeft}px`;
                node.style.top = `${newTop}px`;

                 // Redraw connections while dragging
                 redrawConnections();
            }
        }

        // Make node connectable (drawing lines)
        function makeNodeConnectable(node) {
            node.addEventListener('mousedown', (event) => {
                // Only start connecting if not dragging the node itself
                if (!node.classList.contains('dragging')) {
                    startNode = node;
                    const startRect = startNode.getBoundingClientRect();
                    const foodWebRect = foodWebArea.getBoundingClientRect();
                    const startX = startRect.left + startRect.width / 2 - foodWebRect.left;
                    const startY = startRect.top + startRect.height / 2 - foodWebRect.top;

                    connectingLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    connectingLine.setAttribute('x1', startX);
                    connectingLine.setAttribute('y1', startY);
                    connectingLine.setAttribute('x2', startX); // Start and end at the same point initially
                    connectingLine.setAttribute('y2', startY);
                    connectingLine.setAttribute('stroke', 'var(--accent-color)');
                    connectingLine.setAttribute('stroke-width', '2');
                    connectingLine.setAttribute('marker-end', 'url(#arrowhead)');
                    connectingLine.classList.add('temp-line'); // Class to identify temporary line
                    svg.appendChild(connectingLine);

                    foodWebArea.addEventListener('mousemove', drawConnectingLine);
                    foodWebArea.addEventListener('mouseup', endConnectingLine);
                }
            });
        }

        function drawConnectingLine(event) {
            if (!connectingLine) return;

            const foodWebRect = foodWebArea.getBoundingClientRect();
            const endX = event.clientX - foodWebRect.left;
            const endY = event.clientY - foodWebRect.top;

            connectingLine.setAttribute('x2', endX);
            connectingLine.setAttribute('y2', endY);
        }

        function endConnectingLine(event) {
            if (!connectingLine) return;

            foodWebArea.removeEventListener('mousemove', drawConnectingLine);
            foodWebArea.removeEventListener('mouseup', endConnectingLine);

            const endNodeElement = event.target.closest('.food-web-node');

            if (endNodeElement && endNodeElement !== startNode) {
                // Valid connection
                const startId = startNode.dataset.nodeId;
                const endId = endNodeElement.dataset.nodeId;

                // Check if connection already exists (simple check)
                const connectionExists = connections.some(conn => conn.fromId === startId && conn.toId === endId);

                if (!connectionExists) {
                    // Remove temp line
                    svg.removeChild(connectingLine);

                    // Create permanent line
                    const startRect = startNode.getBoundingClientRect();
                    const endRect = endNodeElement.getBoundingClientRect();
                    const foodWebRect = foodWebArea.getBoundingClientRect();

                    const startX = startRect.left + startRect.width / 2 - foodWebRect.left;
                    const startY = startRect.top + startRect.height / 2 - foodWebRect.top;
                    const endX = endRect.left + endRect.width / 2 - foodWebRect.left;
                    const endY = endRect.top + endRect.height / 2 - foodWebRect.top;

                    const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                    line.setAttribute('x1', startX);
                    line.setAttribute('y1', startY);
                    line.setAttribute('x2', endX);
                    line.setAttribute('y2', endY);
                    line.setAttribute('stroke', 'var(--primary-color)');
                    line.setAttribute('stroke-width', '2');
                    line.setAttribute('marker-end', 'url(#arrowhead)');
                     line.dataset.from = startId;
                     line.dataset.to = endId;
                    svg.appendChild(line);

                    connections.push({ fromId: startId, toId: endId, lineElement: line });
                    console.log(`Connection added: ${startId} -> ${endId}`);

                    // Add click listener to remove connection
                    line.addEventListener('click', removeConnection);

                } else {
                     console.log('Connection already exists.');
                     // Remove temp line
                     svg.removeChild(connectingLine);
                }

            } else {
                // Invalid drop, remove the temporary line
                if (connectingLine && connectingLine.parentNode === svg) {
                     svg.removeChild(connectingLine);
                }
            }

            connectingLine = null;
            startNode = null;
        }

        function redrawConnections() {
            const foodWebRect = foodWebArea.getBoundingClientRect();
            connections.forEach(conn => {
                const fromNode = foodWebNodes.find(n => n.id === conn.fromId);
                const toNode = foodWebNodes.find(n => n.id === conn.toId);

                if (fromNode && toNode) {
                    const fromRect = fromNode.element.getBoundingClientRect();
                    const toRect = toNode.element.getBoundingClientRect();

                    const startX = fromRect.left + fromRect.width / 2 - foodWebRect.left;
                    const startY = fromRect.top + fromRect.height / 2 - foodWebRect.top;
                    const endX = toRect.left + toRect.width / 2 - foodWebRect.left;
                    const endY = toRect.top + toRect.height / 2 - foodWebRect.top;

                    conn.lineElement.setAttribute('x1', startX);
                    conn.lineElement.setAttribute('y1', startY);
                    conn.lineElement.setAttribute('x2', endX);
                    conn.lineElement.setAttribute('y2', endY);
                } else {
                    // Node removed, remove connection later
                }
            });
             // Clean up connections if nodes were removed (basic cleanup)
             connections = connections.filter(conn => {
                 const fromNodeExists = foodWebNodes.some(n => n.id === conn.fromId);
                 const toNodeExists = foodWebNodes.some(n => n.id === conn.toId);
                 if (!fromNodeExists || !toNodeExists) {
                     if (conn.lineElement && conn.lineElement.parentNode === svg) {
                         svg.removeChild(conn.lineElement);
                     }
                     return false; // Remove this connection
                 }
                 return true;
             });
        }

        function removeConnection(event) {
             const line = event.target;
             const fromId = line.dataset.from;
             const toId = line.dataset.to;

             connections = connections.filter(conn => !(conn.fromId === fromId && conn.toId === toId));
             if (line && line.parentNode === svg) {
                 svg.removeChild(line);
             }
             console.log(`Connection removed: ${fromId} -> ${toId}`);
        }


        clearWebButton.addEventListener('click', () => {
            foodWebNodes.forEach(node => node.element.remove());
            foodWebNodes = [];
            connections.forEach(conn => {
                 if (conn.lineElement && conn.lineElement.parentNode === svg) {
                    svg.removeChild(conn.lineElement);
                 }
            });
            connections = [];
            // Clear any energy flow visualization if active
             const energyFlowDiagram = document.getElementById('energy-flow-diagram');
             energyFlowDiagram.innerHTML = '<p>Build a food web first, or click "Start Simulation" to see a basic example.</p>';
        });

        simulateWebButton.addEventListener('click', () => {
             // Basic simulation visualization on the food web itself
             // This could be more complex, but for elementary, maybe just highlight paths or show simple indicators
             console.log("Simulating energy flow on current web...");
             // Example: Add temporary visual indicators moving along connections
             connections.forEach(conn => {
                 const fromNode = foodWebNodes.find(n => n.id === conn.fromId);
                 const toNode = foodWebNodes.find(n => n.id === conn.toId);

                 if (fromNode && toNode) {
                     const fromRect = fromNode.element.getBoundingClientRect();
                     const toRect = toNode.element.getBoundingClientRect();
                     const foodWebRect = foodWebArea.getBoundingClientRect();

                     const startX = fromRect.left + fromRect.width / 2 - foodWebRect.left;
                     const startY = fromRect.top + fromRect.height / 2 - foodWebRect.top;
                     const endX = toRect.left + toRect.width / 2 - foodWebRect.left;
                     const endY = toRect.top + toRect.height / 2 - foodWebRect.top;

                     const indicator = document.createElement('div');
                     indicator.classList.add('energy-indicator');
                     indicator.style.left = `${startX}px`;
                     indicator.style.top = `${startY}px`;

                     // Calculate distance and direction for animation
                     const dx = endX - startX;
                     const dy = endY - startY;
                     const distance = Math.sqrt(dx*dx + dy*dy);
                     const duration = Math.max(1, distance / 100); // Speed based on distance

                     indicator.style.setProperty('--flow-dx', `${dx}px`);
                     indicator.style.setProperty('--flow-dy', `${dy}px`);
                     indicator.style.animationDuration = `${duration}s`;

                     foodWebArea.appendChild(indicator);

                     // Remove indicator after animation
                     indicator.addEventListener('animationiteration', () => {
                         indicator.remove();
                     });
                      indicator.addEventListener('animationend', () => {
                         indicator.remove();
                     });
                 }
             });
        });


        // --- Energy Flow Module ---
         const startEnergySimButton = document.getElementById('start-energy-sim');
         const energyFlowDiagram = document.getElementById('energy-flow-diagram');

         startEnergySimButton.addEventListener('click', () => {
             // A more structured energy flow visualization could go here
             // For simplicity, let's show a basic trophic level diagram example
             energyFlowDiagram.innerHTML = `
                 <h3>Example Energy Pyramid</h3>
                 <p>Energy decreases as it moves up the food chain. Only about 10% of energy from one level is transferred to the next.</p>
                 <div style="display: flex; flex-direction: column; align-items: center; gap: 5px; margin-top: 20px;">
                     <div style="background-color: rgba(255, 99, 132, 0.8); width: 100px; height: 30px; text-align: center; color: white; font-weight: bold; display: flex; justify-content: center; align-items: center; border-radius: 4px;">Hawk (Top Consumer)</div>
                     <div style="background-color: rgba(255, 159, 64, 0.8); width: 150px; height: 30px; text-align: center; color: white; font-weight: bold; display: flex; justify-content: center; align-items: center; border-radius: 4px;">Snake (Secondary Consumer)</div>
                     <div style="background-color: rgba(75, 192, 192, 0.8); width: 200px; height: 30px; text-align: center; color: white; font-weight: bold; display: flex; justify-content: center; align-items: center; border-radius: 4px;">Mouse (Primary Consumer)</div>
                     <div style="background-color: rgba(54, 162, 235, 0.8); width: 250px; height: 30px; text-align: center; color: white; font-weight: bold; display: flex; justify-content: center; align-items: center; border-radius: 4px;">Grass (Producer)</div>
                      <div style="background-color: rgba(255, 205, 86, 0.8); width: 300px; height: 30px; text-align: center; color: ${getContrastColor('rgba(255, 205, 86, 0.8)')}; font-weight: bold; display: flex; justify-content: center; align-items: center; border-radius: 4px;">Sun (Energy Source)</div>
                 </div>
             `;
              speakText("Energy flows from the sun to producers, then to consumers. Most energy is lost at each step!");
         });

         // Helper to get contrasting text color for dynamic backgrounds
         function getContrastColor(bgColor) {
            // Simple luminance check (not perfect for all color formats)
            // Assumes bgColor is rgba or similar
            let r, g, b;
             if (bgColor.startsWith('rgba')) {
                 [r, g, b] = bgColor.match(/\d+/g).map(Number);
             } else if (bgColor.startsWith('#')) {
                 const hex = bgColor.slice(1);
                 r = parseInt(hex.substring(0, 2), 16);
                 g = parseInt(hex.substring(2, 4), 16);
                 b = parseInt(hex.substring(4, 6), 16);
             } else {
                 return 'black'; // Default
             }

            const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            return luminance > 0.5 ? 'black' : 'white';
        }


        // --- Habitat Interdependence Module ---
        const habitatContainer = document.getElementById('habitat-container');
        const habitatInfoPopup = document.getElementById('habitat-info-popup');
        const popupTitle = document.getElementById('popup-title');
        const popupText = document.getElementById('popup-text');
        const popupCloseButton = habitatInfoPopup.querySelector('.close-button');

        // Define habitat hotspots (example data)
        const habitatHotspots = [
            { x: 30, y: 40, width: 10, height: 20, title: "Tall Tree", info: "Tall trees provide shelter for birds and squirrels. Their leaves are food for some insects." },
            { x: 60, y: 70, width: 15, height: 10, title: "Small Bush", info: "Bushes offer berries for animals to eat and hiding places from predators." },
            { x: 45, y: 85, width: 10, height: 5, title: "Forest Floor", info: "The forest floor is home to decomposers like fungi and worms, which break down dead leaves and logs." },
             { x: 75, y: 55, width: 8, height: 8, title: "Bird's Nest", info: "Birds build nests in trees or bushes to raise their young, depending on plants for safety." },
             { x: 20, y: 75, width: 12, height: 6, title: "Rabbit Burrow", info: "Rabbits dig burrows underground for shelter. They eat plants from the habitat." }
        ];

        function addHabitatHotspots() {
             const img = habitatContainer.querySelector('img');
             // Wait for image to load to get correct dimensions
             img.onload = () => {
                 const imgWidth = img.offsetWidth;
                 const imgHeight = img.offsetHeight;

                 habitatHotspots.forEach(hotspot => {
                     const div = document.createElement('div');
                     div.classList.add('habitat-hotspot');
                     // Position using percentage relative to image size
                     div.style.left = `${hotspot.x}%`;
                     div.style.top = `${hotspot.y}%`;
                     div.style.width = `${hotspot.width}%`;
                     div.style.height = `${hotspot.height}%`;
                     div.dataset.title = hotspot.title;
                     div.dataset.info = hotspot.info;
                     div.setAttribute('aria-label', `Information about ${hotspot.title}`);

                     div.addEventListener('click', handleHotspotClick);
                     habitatContainer.appendChild(div);
                 });
             };
             // If image is already loaded (e.g. cached)
             if (img.complete) {
                 img.onload(); // Manually trigger onload
             }
        }

        function handleHotspotClick(event) {
            const hotspot = event.target;
            const title = hotspot.dataset.title;
            const info = hotspot.dataset.info;

            popupTitle.textContent = title;
            popupText.textContent = info;

            // Position popup near the hotspot (simple example)
            const hotspotRect = hotspot.getBoundingClientRect();
            const containerRect = habitatContainer.getBoundingClientRect();
            const popupRect = habitatInfoPopup.getBoundingClientRect(); // Get current popup size

            let popupLeft = hotspotRect.left - containerRect.left + hotspotRect.width / 2 - popupRect.width / 2;
            let popupTop = hotspotRect.top - containerRect.top - popupRect.height - 10; // Position above hotspot

            // Clamp to container bounds
            popupLeft = Math.max(0, Math.min(popupLeft, containerRect.width - popupRect.width));
            popupTop = Math.max(0, Math.min(popupTop, containerRect.height - popupRect.height)); // Clamp top

            // Adjust top if it goes above the container
            if (popupTop < 0) {
                 popupTop = hotspotRect.top - containerRect.top + hotspotRect.height + 10; // Position below
                 popupTop = Math.min(popupTop, containerRect.height - popupRect.height); // Re-clamp bottom
            }


            habitatInfoPopup.style.left = `${popupLeft}px`;
            habitatInfoPopup.style.top = `${popupTop}px`;
            habitatInfoPopup.classList.add('active');

            speakText(`${title}. ${info}`);
        }

        popupCloseButton.addEventListener('click', () => {
            habitatInfoPopup.classList.remove('active');
        });

        // Close popup if clicking outside it or any hotspot
        document.addEventListener('click', (event) => {
             if (habitatInfoPopup.classList.contains('active') &&
                 !habitatInfoPopup.contains(event.target) &&
                 !event.target.closest('.habitat-hotspot') &&
                 event.target.closest('.module-section.active')?.id === 'habitat') { // Only close if in habitat module
                 habitatInfoPopup.classList.remove('active');
             }
        });

         // Initial call to add hotspots when the module is first activated or on load
         addHabitatHotspots();


        // --- Glossary Module ---
        const glossaryListElement = document.getElementById('glossary-list');
        const glossaryDetailElement = document.getElementById('glossary-detail');

        // Example Glossary Data
        const glossaryTerms = [
            { term: "Ecosystem", definition: "A community of living organisms interacting with each other and their physical environment.", image: "https://placehold.co/150x100?text=Ecosystem" },
            { term: "Habitat", definition: "The natural home or environment of an animal, plant, or other organism.", image: "https://placehold.co/150x100?text=Habitat" },
            { term: "Food Chain", definition: "A linear sequence of organisms where nutrients and energy are transferred from one organism to another as one eats another.", image: "https://placehold.co/150x100?text=Food+Chain" },
            { term: "Food Web", definition: "A system of interlocking and interdependent food chains.", image: "https://placehold.co/150x100?text=Food+Web" },
            { term: "Producer", definition: "An organism that produces its own food, usually through photosynthesis (like plants).", image: "https://placehold.co/150x100?text=Producer" },
            { term: "Consumer", definition: "An organism that obtains energy by feeding on other organisms.", image: "https://placehold.co/150x100?text=Consumer" },
            { term: "Herbivore", definition: "An animal that feeds on plants.", image: "https://placehold.co/150x100?text=Herbivore" },
            { term: "Carnivore", definition: "An animal that feeds on other animals.", image: "https://placehold.co/150x100?text=Carnivore" },
            { term: "Omnivore", definition: "An animal or person that eats food of both plant and animal origins.", image: "https://placehold.co/150x100?text=Omnivore" },
            { term: "Decomposer", definition: "An organism, especially a soil bacterium, fungus, or invertebrate, that decomposes organic material.", image: "https://placehold.co/150x100?text=Decomposer" },
             { term: "Energy Flow", definition: "The movement of energy through an ecosystem, usually starting with the sun.", image: "https://placehold.co/150x100?text=Energy+Flow" }
        ];

        function populateGlossary() {
            glossaryListElement.innerHTML = ''; // Clear existing list
            glossaryTerms.sort((a, b) => a.term.localeCompare(b.term)); // Sort alphabetically
            glossaryTerms.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item.term;
                li.dataset.term = item.term;
                li.setAttribute('role', 'button'); // Make list items behave like buttons for accessibility
                li.setAttribute('tabindex', '0'); // Make them focusable
                li.addEventListener('click', () => displayGlossaryTerm(item));
                 li.addEventListener('keydown', (event) => { // Allow activation with Enter/Space
                    if (event.key === 'Enter' || event.key === ' ') {
                        event.preventDefault();
                        displayGlossaryTerm(item);
                    }
                });
                glossaryListElement.appendChild(li);
            });
        }

        function displayGlossaryTerm(item) {
            glossaryDetailElement.innerHTML = `
                <h3>${item.term}</h3>
                ${item.image ? `<img src="${item.image}" alt="Illustration for ${item.term}">` : ''}
                <p>${item.definition}</p>
                <div class="audio-buttons">
                    <button class="tts-button" aria-label="Read definition">Read Definition</button>
                </div>
            `;
             // Add event listeners for buttons *after* they are added to the DOM
             glossaryDetailElement.querySelector('.tts-button').addEventListener('click', () => {
                 speakText(item.definition);
             });

             // Highlight the selected term in the list
             glossaryListElement.querySelectorAll('li').forEach(li => {
                 li.style.fontWeight = 'normal';
             });
             glossaryListElement.querySelector(`li[data-term="${item.term}"]`).style.fontWeight = 'bold';

             speakText(`${item.term}. ${item.definition}`);
        }

        // Initial population of the glossary
        populateGlossary();


        // --- Quiz Module ---
        const quizQuestionArea = document.getElementById('quiz-question-area');
        const quizFeedback = document.getElementById('quiz-feedback');
        const nextQuestionButton = document.getElementById('next-question-button');
        const quizScoreSpan = document.getElementById('quiz-score');

        let currentQuestionIndex = 0;
        let score = 0;

        // Example Quiz Data
        const quizQuestions = [
            {
                question: "What is a living thing that makes its own food?",
                options: ["Consumer", "Producer", "Decomposer", "Herbivore"],
                correctAnswer: "Producer",
                explanation: "Producers, like plants, use sunlight to make their own food through photosynthesis."
            },
             {
                question: "Which of these is a primary consumer?",
                options: ["Hawk (eats snakes)", "Snake (eats mice)", "Mouse (eats grass)", "Grass (makes food)"],
                correctAnswer: "Mouse (eats grass)",
                explanation: "Primary consumers are herbivores that eat producers (plants)."
            },
             {
                question: "Energy flows from the sun to...",
                options: ["Consumers", "Decomposers", "Producers", "Omnivores"],
                correctAnswer: "Producers",
                explanation: "The sun provides energy for producers (plants) to grow, starting the energy flow."
            },
             {
                question: "What do you call the natural home of an animal?",
                options: ["Ecosystem", "Food Web", "Habitat", "Community"],
                correctAnswer: "Habitat",
                explanation: "A habitat is the place where an organism lives."
            },
             {
                question: "Which diagram shows many interconnected food chains?",
                options: ["Energy Pyramid", "Food Chain", "Habitat Map", "Food Web"],
                correctAnswer: "Food Web",
                explanation: "A food web shows how different food chains are linked together in an ecosystem."
            }
        ];

        function loadQuestion(index) {
            if (index >= quizQuestions.length) {
                displayQuizResult();
                return;
            }

            const questionData = quizQuestions[index];
            quizQuestionArea.innerHTML = ''; // Clear previous question
            quizFeedback.textContent = '';
            quizFeedback.className = 'quiz-feedback'; // Reset classes
            nextQuestionButton.style.display = 'none';

            const questionElement = document.createElement('p');
            questionElement.classList.add('quiz-question');
            questionElement.textContent = questionData.question;
             questionElement.classList.toggle('simplified-text', isSimplifiedLanguageActive); // Apply simplified class
            quizQuestionArea.appendChild(questionElement);

            const optionsElement = document.createElement('div');
            optionsElement.classList.add('quiz-options');
            quizQuestionArea.appendChild(optionsElement);

            questionData.options.forEach(option => {
                const optionButton = document.createElement('button');
                optionButton.classList.add('quiz-option-button');
                optionButton.textContent = option;
                optionButton.dataset.answer = option;
                 optionButton.classList.toggle('simplified-text', isSimplifiedLanguageActive); // Apply simplified class
                optionButton.addEventListener('click', handleAnswerClick);
                optionsElement.appendChild(optionButton);
            });

             updateScoreDisplay();
             speakText(questionData.question);
        }

        function handleAnswerClick(event) {
            const selectedAnswer = event.target.dataset.answer;
            const questionData = quizQuestions[currentQuestionIndex];
            const optionsButtons = quizQuestionArea.querySelectorAll('.quiz-option-button');

            // Disable all buttons after an answer is selected
            optionsButtons.forEach(button => button.disabled = true);

            if (selectedAnswer === questionData.correctAnswer) {
                score++;
                quizFeedback.textContent = "Correct! " + questionData.explanation;
                quizFeedback.classList.add('correct');
                event.target.classList.add('correct');
                 speakText("Correct! " + questionData.explanation);
            } else {
                quizFeedback.textContent = "Incorrect. " + questionData.explanation;
                quizFeedback.classList.add('incorrect');
                event.target.classList.add('incorrect');
                 // Highlight the correct answer
                 optionsButtons.forEach(button => {
                     if (button.dataset.answer === questionData.correctAnswer) {
                         button.classList.add('correct');
                     }
                 });
                 speakText("Incorrect. " + questionData.explanation);
            }

            nextQuestionButton.style.display = 'block';
            updateScoreDisplay();
        }

        nextQuestionButton.addEventListener('click', () => {
            currentQuestionIndex++;
            loadQuestion(currentQuestionIndex);
        });

        function displayQuizResult() {
            quizQuestionArea.innerHTML = `
                <h3>Quiz Complete!</h3>
                <p>You got ${score} out of ${quizQuestions.length} questions correct!</p>
                <button id="restart-quiz-button">Try Again</button>
            `;
             quizFeedback.textContent = '';
             nextQuestionButton.style.display = 'none';
             updateScoreDisplay(); // Show final score

             const restartButton = document.getElementById('restart-quiz-button');
             restartButton.addEventListener('click', () => {
                 currentQuestionIndex = 0;
                 score = 0;
                 loadQuestion(currentQuestionIndex);
             });
             speakText(`Quiz complete! You got ${score} out of ${quizQuestions.length} correct.`);
        }

        function updateScoreDisplay() {
             quizScoreSpan.textContent = `Score: ${score}/${currentQuestionIndex < quizQuestions.length ? currentQuestionIndex : quizQuestions.length}`;
        }

        // Initial load of the first quiz question
        loadQuestion(currentQuestionIndex);


        // --- Initial Setup ---
        // Activate the first module on page load
        activateModule('food-web');

    </script>
</body>
</html>
