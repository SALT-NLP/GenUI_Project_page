<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Longitudinal Study Data Analysis</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007bff;
            --primary-dark: #0056b3;
            --secondary-color: #6c757d;
            --secondary-dark: #545b62;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --background-color: #f8f9fa;
            --surface-color: #ffffff;
            --text-color: #343a40;
            --text-light: #6c757d;
            --border-color: #dee2e6;
            --spacing-unit: 8px;
            --border-radius: 4px;
            --shadow-subtle: 0 1px 3px rgba(0, 0, 0, 0.05);
            --shadow-medium: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--background-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }

        header {
            background-color: var(--surface-color);
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 3);
            box-shadow: var(--shadow-subtle);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        header h1 {
            margin: 0;
            font-size: 1.5rem;
            color: var(--primary-color);
        }

        .container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .sidebar {
            width: 300px;
            background-color: var(--surface-color);
            padding: calc(var(--spacing-unit) * 2);
            box-shadow: var(--shadow-subtle);
            overflow-y: auto;
            flex-shrink: 0;
        }

        .main-content {
            flex: 1;
            padding: calc(var(--spacing-unit) * 3);
            overflow-y: auto;
        }

        section {
            background-color: var(--surface-color);
            padding: calc(var(--spacing-unit) * 3);
            margin-bottom: calc(var(--spacing-unit) * 3);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
        }

        h2 {
            margin-top: 0;
            color: var(--primary-color);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: var(--spacing-unit);
            margin-bottom: calc(var(--spacing-unit) * 2);
        }

        .form-group {
            margin-bottom: calc(var(--spacing-unit) * 2);
        }

        label {
            display: block;
            margin-bottom: var(--spacing-unit);
            font-weight: 500;
            color: var(--text-color);
        }

        input[type="text"],
        input[type="number"],
        select,
        textarea {
            width: 100%;
            padding: var(--spacing-unit);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            box-sizing: border-box;
        }

        button {
            display: inline-block;
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 2);
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
            text-decoration: none;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color 0.2s ease, opacity 0.2s ease;
        }

        button.primary {
            background-color: var(--primary-color);
            color: white;
        }

        button.primary:hover {
            background-color: var(--primary-dark);
        }

        button.secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        button.secondary:hover {
            background-color: var(--secondary-dark);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .file-upload-area {
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: calc(var(--spacing-unit) * 4);
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s ease, background-color 0.2s ease;
        }

        .file-upload-area:hover {
            border-color: var(--primary-color);
            background-color: #e9ecef;
        }

        .file-upload-area input[type="file"] {
            display: none;
        }

        .file-list {
            margin-top: calc(var(--spacing-unit) * 2);
            list-style: none;
            padding: 0;
        }

        .file-list li {
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            padding: var(--spacing-unit);
            margin-bottom: var(--spacing-unit);
            border-radius: var(--border-radius);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: calc(var(--spacing-unit) * 2);
        }

        th, td {
            padding: var(--spacing-unit);
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: var(--background-color);
            font-weight: 600;
        }

        .chart-container {
            position: relative;
            height: 400px; /* Fixed height for chart */
            margin-top: calc(var(--spacing-unit) * 2);
        }

        .loading-indicator {
            display: none;
            text-align: center;
            margin-top: calc(var(--spacing-unit) * 3);
            color: var(--primary-color);
        }

        .loading-indicator.active {
            display: block;
        }

        .loading-spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto var(--spacing-unit);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Chart Controls - Similar to example */
        .floating-controls {
            position: absolute;
            top: var(--spacing-unit);
            right: var(--spacing-unit);
            background: rgba(255, 255, 255, 0.95);
            padding: calc(var(--spacing-unit) * 2);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-subtle);
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 10; /* Ensure controls are above chart */
        }
        .floating-controls.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }
        .control-group {
            margin-bottom: var(--spacing-unit);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-unit);
        }
        .control-group label {
             margin-bottom: 0; /* Adjust label spacing */
             font-size: 0.9rem;
             font-weight: 400;
        }
         .control-group input[type="color"],
         .control-group input[type="number"],
         .control-group select {
             padding: calc(var(--spacing-unit) * 0.5);
             font-size: 0.9rem;
         }

         .chart-card {
             position: relative; /* Needed for absolute positioning of controls */
         }

         /* Responsive adjustments */
         @media (max-width: 768px) {
             .container {
                 flex-direction: column;
             }
             .sidebar {
                 width: 100%;
                 max-height: 40vh; /* Limit height on smaller screens */
                 box-shadow: 0 2px 4px rgba(0,0,0,0.05);
             }
             .main-content {
                 padding: calc(var(--spacing-unit) * 2);
             }
             header {
                 padding: var(--spacing-unit) calc(var(--spacing-unit) * 2);
             }
         }
    </style>
</head>
<body>
    <header>
        <h1>Longitudinal Study Analysis</h1>
        <!-- Navigation Placeholder -->
        <nav>
            <!-- <a href="#">Data</a> | <a href="#">Analysis</a> | <a href="#">Visualizations</a> -->
        </nav>
    </header>

    <div class="container">
        <aside class="sidebar">
            <section>
                <h2>üìä Data Upload</h2>
                <div class="file-upload-area" id="fileUploadArea">
                    <input type="file" id="fileInput" multiple accept=".csv, .xlsx">
                    <p>Drag & drop files here or click to select</p>
                </div>
                <ul class="file-list" id="fileList">
                    <!-- Uploaded files will be listed here -->
                </ul>
            </section>

            <section>
                <h2>‚öôÔ∏è Analysis Configuration</h2>
                <div class="form-group">
                    <label for="dependentVariable">Dependent Variable:</label>
                    <select id="dependentVariable">
                        <option value="">Select variable...</option>
                        <!-- Options populated by JS after data upload -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="independentVariable">Independent Variable (Intervention):</label>
                    <select id="independentVariable">
                        <option value="">Select variable...</option>
                        <!-- Options populated by JS -->
                    </select>
                </div>
                 <div class="form-group">
                    <label for="timeVariable">Time Variable:</label>
                    <select id="timeVariable">
                        <option value="">Select variable...</option>
                        <!-- Options populated by JS -->
                    </select>
                </div>
                <div class="form-group">
                    <label for="confoundingVariables">Confounding Variables:</label>
                    <select id="confoundingVariables" multiple>
                         <option value="">Select variables...</option>
                        <!-- Options populated by JS -->
                    </select>
                </div>
                 <div class="form-group">
                    <label for="subgroupVariable">Subgroup Variable:</label>
                    <select id="subgroupVariable">
                        <option value="">Select variable...</option>
                        <!-- Options populated by JS -->
                    </select>
                </div>
                 <div class="form-group">
                    <label for="analysisType">Analysis Type:</label>
                    <select id="analysisType">
                        <option value="longitudinal-regression">Longitudinal Regression</option>
                        <option value="anova">ANOVA (Repeated Measures)</option>
                        <option value="mixed-effects">Mixed Effects Model</option>
                    </select>
                </div>
                <button class="primary" id="runAnalysisButton">Run Analysis</button>
            </section>
        </aside>

        <main class="main-content">
            <section id="dataPreviewSection">
                <h2>üìã Data Preview</h2>
                <div style="max-height: 400px; overflow-y: auto;">
                     <table id="dataTable">
                        <thead>
                            <tr>
                                <!-- Table headers populated by JS -->
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table rows populated by JS -->
                        </tbody>
                    </table>
                </div>
            </section>

            <section id="analysisResultsSection" style="display: none;">
                <h2>üìà Analysis Results</h2>
                 <div class="loading-indicator" id="analysisLoading">
                    <div class="loading-spinner"></div>
                    <p>Running analysis...</p>
                </div>
                <div id="analysisResultsContent">
                    <!-- Analysis results table/text will be displayed here -->
                     <h3>Summary Statistics</h3>
                     <table id="summaryStatsTable">
                         <thead><tr><th>Variable</th><th>Mean</th><th>Median</th><th>SD</th><th>Min</th><th>Max</th></tr></thead>
                         <tbody></tbody>
                     </table>

                     <h3>Model Results</h3>
                      <table id="modelResultsTable">
                         <thead><tr><th>Term</th><th>Estimate</th><th>Std. Error</th><th>t-value</th><th>p-value</th></tr></thead>
                         <tbody></tbody>
                     </table>
                </div>
            </section>

            <section id="visualizationSection" style="display: none;">
                <h2>üìä Visualizations</h2>
                 <div class="loading-indicator" id="chartLoading">
                    <div class="loading-spinner"></div>
                    <p>Generating chart...</p>
                </div>
                 <div id="chartControls">
                      <div class="form-group">
                            <label for="chartType">Chart Type:</label>
                            <select id="chartType">
                                <option value="line">Line Chart (Longitudinal Trend)</option>
                                <option value="bar">Bar Chart (Comparison)</option>
                                <option value="scatter">Scatter Plot (Relationship)</option>
                                <option value="boxplot">Box Plot (Distribution)</option>
                            </select>
                        </div>
                         <div class="form-group">
                            <label for="chartXVariable">X-Axis Variable:</label>
                            <select id="chartXVariable">
                                <option value="">Select variable...</option>
                            </select>
                        </div>
                         <div class="form-group">
                            <label for="chartYVariable">Y-Axis Variable:</label>
                            <select id="chartYVariable">
                                <option value="">Select variable...</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="chartColorVariable">Color by Variable:</label>
                            <select id="chartColorVariable">
                                <option value="">None</option>
                                 <!-- Options populated by JS -->
                            </select>
                        </div>
                        <button class="secondary" id="generateChartButton">Generate Chart</button>
                 </div>
                 <div id="chartArea" class="chart-card">
                    <!-- Charts will be rendered here -->
                    <p>Select variables and click "Generate Chart" to see visualizations.</p>
                 </div>
            </section>

             <section id="exportSection" style="display: none;">
                <h2>üíæ Export</h2>
                <p>Export your data, analysis results, or visualizations.</p>
                 <div class="form-group">
                    <label for="exportFormat">Format:</label>
                    <select id="exportFormat">
                        <option value="csv">CSV (Data/Results)</option>
                        <option value="png">PNG (Chart)</option>
                        <option value="pdf">PDF (Report)</option>
                    </select>
                </div>
                 <button class="primary" id="exportButton">Export</button>
            </section>
        </main>
    </div>

    <script type="module">
        // Import Chart.js
        import { Chart } from "https://esm.sh/chart.js/auto";
        // Import a dummy data parsing library (replace with real one like PapaParse or SheetJS if needed)
        // import Papa from 'https://esm.sh/papaparse';

        // --- DOM Elements ---
        const fileUploadArea = document.getElementById('fileUploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileList = document.getElementById('fileList');
        const dataTable = document.getElementById('dataTable');
        const dependentVariableSelect = document.getElementById('dependentVariable');
        const independentVariableSelect = document.getElementById('independentVariable');
        const timeVariableSelect = document.getElementById('timeVariable');
        const confoundingVariablesSelect = document.getElementById('confoundingVariables');
        const subgroupVariableSelect = document.getElementById('subgroupVariable');
        const analysisTypeSelect = document.getElementById('analysisType');
        const runAnalysisButton = document.getElementById('runAnalysisButton');
        const analysisResultsSection = document.getElementById('analysisResultsSection');
        const analysisLoading = document.getElementById('analysisLoading');
        const summaryStatsTableBody = document.querySelector('#summaryStatsTable tbody');
        const modelResultsTableBody = document.querySelector('#modelResultsTable tbody');
        const visualizationSection = document.getElementById('visualizationSection');
        const chartLoading = document.getElementById('chartLoading');
        const chartTypeSelect = document.getElementById('chartType');
        const chartXVariableSelect = document.getElementById('chartXVariable');
        const chartYVariableSelect = document.getElementById('chartYVariable');
        const chartColorVariableSelect = document.getElementById('chartColorVariable');
        const generateChartButton = document.getElementById('generateChartButton');
        const chartArea = document.getElementById('chartArea');
        const exportSection = document.getElementById('exportSection');
        const exportFormatSelect = document.getElementById('exportFormat');
        const exportButton = document.getElementById('exportButton');

        // --- State Variables ---
        let uploadedFiles = [];
        let parsedData = null; // Store parsed data here
        let dataHeaders = []; // Store column headers
        let currentChart = null; // Store active Chart.js instance

        // --- Event Listeners ---

        // File Upload Area (Drag & Drop)
        fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            fileUploadArea.style.borderColor = var('--primary-color');
            fileUploadArea.style.backgroundColor = '#e9ecef';
        });

        fileUploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            fileUploadArea.style.borderColor = var('--border-color');
            fileUploadArea.style.backgroundColor = var('--surface-color');
        });

        fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            fileUploadArea.style.borderColor = var('--border-color');
            fileUploadArea.style.backgroundColor = var('--surface-color');
            handleFiles(e.dataTransfer.files);
        });

        // File Input (Click)
        fileUploadArea.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            handleFiles(e.target.files);
        });

        // Run Analysis Button
        runAnalysisButton.addEventListener('click', () => {
            runAnalysis();
        });

        // Generate Chart Button
        generateChartButton.addEventListener('click', () => {
             generateChart();
        });

        // Export Button
        exportButton.addEventListener('click', () => {
            exportContent();
        });

        // --- Functions ---

        function handleFiles(files) {
            uploadedFiles = [...uploadedFiles, ...files];
            renderFileList();
            // For simplicity, let's assume the first file is the data file
            if (files.length > 0) {
                 parseDataFile(files[0]);
            }
        }

        function renderFileList() {
            fileList.innerHTML = '';
            uploadedFiles.forEach(file => {
                const li = document.createElement('li');
                li.textContent = `${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
                // Add a remove button if needed later
                fileList.appendChild(li);
            });
        }

        function parseDataFile(file) {
             // Simulate parsing delay and success
             console.log(`Parsing file: ${file.name}`);
             // In a real app, use PapaParse for CSV or SheetJS for Excel
             // For this example, we'll use dummy data
             showLoading('analysisLoading', 'Parsing data...');
             setTimeout(() => {
                 hideLoading('analysisLoading');
                 simulateParsedData(); // Generate dummy data
                 renderDataTable();
                 populateVariableSelects();
                 // Show relevant sections
                 document.getElementById('dataPreviewSection').style.display = 'block';
                 analysisResultsSection.style.display = 'block'; // Show analysis section placeholder
                 visualizationSection.style.display = 'block'; // Show visualization section placeholder
                 exportSection.style.display = 'block'; // Show export section placeholder

             }, 1500); // Simulate network/processing time
        }

        function simulateParsedData() {
            // Dummy data structure simulating longitudinal data
            // Columns: StudentID, TimePoint, InterventionGroup, GPA, Belonging, StudyHours, IncomeLevel, Gender
            dataHeaders = ['StudentID', 'TimePoint', 'InterventionGroup', 'GPA', 'Belonging', 'StudyHours', 'IncomeLevel', 'Gender'];
            parsedData = [];
            const groups = ['A', 'B', 'C']; // Control, Intervention 1, Intervention 2
            const incomeLevels = ['Low', 'Medium', 'High'];
            const genders = ['Male', 'Female', 'Non-binary'];

            for (let i = 1; i <= 50; i++) { // 50 students
                const studentID = `S${i}`;
                const interventionGroup = groups[Math.floor(Math.random() * groups.length)];
                const incomeLevel = incomeLevels[Math.floor(Math.random() * incomeLevels.length)];
                const gender = genders[Math.floor(Math.random() * genders.length)];

                for (let t = 1; t <= 4; t++) { // 4 time points
                    const timePoint = `T${t}`;
                    // Simulate some trends/differences
                    let gpa = 2.5 + (t - 1) * 0.1 + (interventionGroup === 'B' ? 0.2 : 0) + (interventionGroup === 'C' ? 0.3 : 0) + Math.random() * 0.5 - 0.25;
                    gpa = Math.max(1.0, Math.min(4.0, gpa)); // Clamp GPA
                    let belonging = 5 + (t - 1) * 0.5 + (interventionGroup === 'C' ? 1 : 0) + Math.random() * 2 - 1;
                     belonging = Math.max(1, Math.min(10, belonging)); // Clamp belonging
                    let studyHours = 10 + (t - 1) * 2 + Math.random() * 5 - 2.5;
                    studyHours = Math.max(0, studyHours); // Clamp study hours

                    parsedData.push({
                        StudentID: studentID,
                        TimePoint: timePoint,
                        InterventionGroup: interventionGroup,
                        GPA: parseFloat(gpa.toFixed(2)),
                        Belonging: parseFloat(belonging.toFixed(1)),
                        StudyHours: parseFloat(studyHours.toFixed(1)),
                        IncomeLevel: incomeLevel,
                        Gender: gender
                    });
                }
            }
             console.log("Dummy data generated:", parsedData);
        }


        function renderDataTable() {
            const thead = dataTable.querySelector('thead tr');
            const tbody = dataTable.querySelector('tbody');
            thead.innerHTML = '';
            tbody.innerHTML = '';

            // Add headers
            dataHeaders.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                thead.appendChild(th);
            });

            // Add first 20 rows as preview
            const previewData = parsedData.slice(0, 20);
            previewData.forEach(rowData => {
                const tr = document.createElement('tr');
                dataHeaders.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = rowData[header];
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        function populateVariableSelects() {
             const variableSelects = [
                dependentVariableSelect,
                independentVariableSelect,
                timeVariableSelect,
                confoundingVariablesSelect,
                subgroupVariableSelect,
                chartXVariableSelect,
                chartYVariableSelect,
                chartColorVariableSelect
            ];

            variableSelects.forEach(select => {
                // Keep the first option (placeholder)
                const firstOption = select.querySelector('option:first-child');
                select.innerHTML = '';
                select.appendChild(firstOption);

                dataHeaders.forEach(header => {
                    // Exclude unique identifiers like StudentID from analysis/chart options
                    if (header !== 'StudentID') {
                         const option = document.createElement('option');
                         option.value = header;
                         option.textContent = header;
                         select.appendChild(option);
                    }
                });
            });

             // Pre-select some common variables for demo
             dependentVariableSelect.value = 'GPA';
             independentVariableSelect.value = 'InterventionGroup';
             timeVariableSelect.value = 'TimePoint';
             subgroupVariableSelect.value = 'Gender';
             chartXVariableSelect.value = 'TimePoint';
             chartYVariableSelect.value = 'GPA';
             chartColorVariableSelect.value = 'InterventionGroup';
        }


        function runAnalysis() {
            const dependentVar = dependentVariableSelect.value;
            const independentVar = independentVariableSelect.value;
            const timeVar = timeVariableSelect.value;
            const confoundingVars = Array.from(confoundingVariablesSelect.selectedOptions).map(option => option.value);
            const subgroupVar = subgroupVariableSelect.value;
            const analysisType = analysisTypeSelect.value;

            if (!dependentVar || !independentVar || !timeVar || !analysisType || !parsedData) {
                alert('Please select Dependent, Independent, and Time variables, and ensure data is loaded.');
                return;
            }

            console.log(`Running ${analysisType} analysis:`);
            console.log(`  Dependent: ${dependentVar}`);
            console.log(`  Independent: ${independentVar}`);
            console.log(`  Time: ${timeVar}`);
            console.log(`  Confounding: ${confoundingVars.join(', ')}`);
            console.log(`  Subgroup: ${subgroupVar}`);

            // Simulate analysis process
            showLoading('analysisLoading', 'Running analysis...');
            analysisResultsSection.style.display = 'block'; // Ensure section is visible

            setTimeout(() => {
                hideLoading('analysisLoading');
                simulateAnalysisResults(dependentVar, independentVar, timeVar, subgroupVar); // Generate dummy results
            }, 2000); // Simulate analysis time
        }

        function simulateAnalysisResults(dependentVar, independentVar, timeVar, subgroupVar) {
            // Clear previous results
            summaryStatsTableBody.innerHTML = '';
            modelResultsTableBody.innerHTML = '';

            // Simulate Summary Statistics (simple example)
            const numericVars = dataHeaders.filter(h => typeof parsedData[0][h] === 'number');
            numericVars.forEach(v => {
                const values = parsedData.map(d => d[v]);
                const mean = values.reduce((sum, val) => sum + val, 0) / values.length;
                const median = values.sort((a, b) => a - b)[Math.floor(values.length / 2)];
                const sd = Math.sqrt(values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length);
                const min = Math.min(...values);
                const max = Math.max(...values);

                const tr = document.createElement('tr');
                tr.innerHTML = `<td>${v}</td><td>${mean.toFixed(2)}</td><td>${median.toFixed(2)}</td><td>${sd.toFixed(2)}</td><td>${min.toFixed(2)}</td><td>${max.toFixed(2)}</td>`;
                summaryStatsTableBody.appendChild(tr);
            });


            // Simulate Model Results (dummy regression output)
            const dummyResults = [
                { term: '(Intercept)', estimate: 2.8, stdError: 0.15, tValue: 18.67, pValue: 0.000 },
                { term: `${independentVar}B`, estimate: 0.25, stdError: 0.08, tValue: 3.13, pValue: 0.002 },
                { term: `${independentVar}C`, estimate: 0.35, stdError: 0.09, tValue: 3.89, pValue: 0.000 },
                { term: `${timeVar}T2`, estimate: 0.1, stdError: 0.04, tValue: 2.5, pValue: 0.013 },
                { term: `${timeVar}T3`, estimate: 0.2, stdError: 0.05, tValue: 4.0, pValue: 0.000 },
                { term: `${timeVar}T4`, estimate: 0.3, stdError: 0.06, tValue: 5.0, pValue: 0.000 },
                // Add interaction terms if subgroup is selected
                ...(subgroupVar ? [
                    { term: `${independentVar}B:${subgroupVar}Male`, estimate: 0.1, stdError: 0.1, tValue: 1.0, pValue: 0.317 },
                     { term: `${independentVar}C:${subgroupVar}Male`, estimate: 0.2, stdError: 0.12, tValue: 1.67, pValue: 0.096 },
                     // Add results for other subgroups/interactions
                ] : [])
            ];

            dummyResults.forEach(row => {
                const tr = document.createElement('tr');
                 // Highlight significant p-values
                 const pValueClass = row.pValue < 0.05 ? 'success-text' : ''; // Need CSS class for this
                tr.innerHTML = `
                    <td>${row.term}</td>
                    <td>${row.estimate.toFixed(3)}</td>
                    <td>${row.stdError.toFixed(3)}</td>
                    <td>${row.tValue.toFixed(2)}</td>
                    <td class="${pValueClass}">${row.pValue.toFixed(3)}</td>
                `;
                modelResultsTableBody.appendChild(tr);
            });
             console.log("Dummy analysis results generated.");
        }

        function generateChart() {
            const chartType = chartTypeSelect.value;
            const xVar = chartXVariableSelect.value;
            const yVar = chartYVariableSelect.value;
            const colorVar = chartColorVariableSelect.value; // Variable to color by (e.g., InterventionGroup, Gender)

             if (!xVar || !yVar || !parsedData) {
                 alert('Please select X-Axis and Y-Axis variables.');
                 return;
             }

            showLoading('chartLoading', `Generating ${chartType} chart...`);
            visualizationSection.style.display = 'block'; // Ensure section is visible

            // Clear previous chart area content
            chartArea.innerHTML = '';
            const canvas = document.createElement('canvas');
            canvas.id = 'myChart';
            chartArea.appendChild(canvas);

            setTimeout(() => {
                 hideLoading('chartLoading');
                 renderChart(canvas, chartType, xVar, yVar, colorVar);
            }, 1500); // Simulate chart generation time
        }

        function renderChart(canvas, type, xVar, yVar, colorVar) {
            const ctx = canvas.getContext('2d');

            // Destroy previous chart instance if exists
            if (currentChart) {
                currentChart.destroy();
            }

            // --- Prepare Chart Data ---
            let chartData = {
                labels: [], // e.g., TimePoints
                datasets: []
            };

            // Get unique values for X and Color variables
            const xValues = [...new Set(parsedData.map(d => d[xVar]))].sort(); // Assuming X is sortable (like TimePoint)
            const colorGroups = colorVar ? [...new Set(parsedData.map(d => d[colorVar]))].sort() : ['All'];

            chartData.labels = xValues; // X-axis labels

            // Generate datasets based on color groups
            colorGroups.forEach((group, index) => {
                const groupData = parsedData.filter(d => colorVar ? d[colorVar] === group : true);

                // Aggregate data for the chart type (e.g., average Y per X per group)
                const aggregatedData = xValues.map(xVal => {
                    const dataPoints = groupData.filter(d => d[xVar] === xVal);
                    const sumY = dataPoints.reduce((sum, d) => sum + (d[yVar] || 0), 0);
                    return dataPoints.length > 0 ? sumY / dataPoints.length : null; // Calculate average Y
                });

                // Simple color palette (replace with a more robust one)
                const colors = [
                    'rgba(0, 123, 255, 0.8)', // primary
                    'rgba(40, 167, 69, 0.8)', // success
                    'rgba(220, 53, 69, 0.8)', // danger
                    'rgba(255, 193, 7, 0.8)',  // warning
                    'rgba(23, 162, 184, 0.8)', // info
                    'rgba(108, 117, 125, 0.8)' // secondary
                 ];
                 const borderColor = [
                     'rgba(0, 123, 255, 1)',
                     'rgba(40, 167, 69, 1)',
                     'rgba(220, 53, 69, 1)',
                     'rgba(255, 193, 7, 1)',
                     'rgba(23, 162, 184, 1)',
                     'rgba(108, 117, 125, 1)'
                 ];

                 const datasetColor = colors[index % colors.length];
                 const datasetBorderColor = borderColor[index % borderColor.length];


                chartData.datasets.push({
                    label: colorVar ? `${colorVar}: ${group}` : yVar,
                    data: aggregatedData,
                    backgroundColor: type === 'bar' ? datasetColor : 'transparent', // Use background for bars
                    borderColor: datasetBorderColor, // Use border for lines/points
                    borderWidth: type === 'line' ? 2 : 1,
                    fill: false, // Don't fill area under line by default
                    tension: type === 'line' ? 0.3 : 0, // Add some curve to lines
                    pointBackgroundColor: datasetBorderColor,
                    pointBorderColor: '#fff',
                    pointHoverRadius: 6,
                    pointHoverBackgroundColor: '#fff',
                    pointHoverBorderColor: datasetBorderColor,
                    showLine: type === 'line', // Show line for line charts
                    type: (type === 'line' || type === 'bar') ? type : 'scatter' // Use scatter type for scatter/box
                });
            });


            // --- Chart Configuration ---
            const config = {
                type: type === 'boxplot' ? 'bar' : type, // Chart.js doesn't have native boxplot, simulate or use a plugin
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: `${yVar} over ${xVar}${colorVar ? ` by ${colorVar}` : ''}`,
                            font: { size: 16, weight: 'bold' }
                        },
                        tooltip: {
                             callbacks: {
                                 label: function(context) {
                                     let label = context.dataset.label || '';
                                     if (label) {
                                         label += ': ';
                                     }
                                     if (context.parsed.y !== null) {
                                         label += context.parsed.y.toFixed(2); // Show value with 2 decimal places
                                     }
                                     // Add more detailed info if needed, e.g., count of data points
                                     return label;
                                 }
                             }
                         },
                         legend: {
                             display: colorVar !== null // Hide legend if no color variable is used
                         }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: xVar
                            },
                            type: 'category' // Assuming time points or categories on X
                        },
                        y: {
                            title: {
                                display: true,
                                text: yVar
                            },
                            beginAtZero: type !== 'scatter' // Start Y at zero for bar/line, not always for scatter
                        }
                    }
                }
            };

             // --- Specific Chart Type Adjustments ---
             if (type === 'scatter') {
                 // For scatter plot, we need individual data points, not aggregated averages
                 // Re-structure data for scatter plot
                 const scatterDatasets = colorGroups.map((group, index) => {
                      const groupData = parsedData.filter(d => colorVar ? d[colorVar] === group : true);
                      const dataPoints = groupData.map(d => ({
                          x: d[xVar], // X variable value
                          y: d[yVar] // Y variable value
                          // Add more info here for tooltips if needed
                      }));

                      const datasetColor = colors[index % colors.length];

                      return {
                          label: colorVar ? `${colorVar}: ${group}` : 'Data Points',
                          data: dataPoints,
                          backgroundColor: datasetColor,
                          borderColor: datasetColor,
                          pointRadius: 5,
                          showLine: false, // No line for scatter
                          type: 'scatter'
                      };
                 });

                 config.data.datasets = scatterDatasets;
                 config.options.scales.x.type = 'linear'; // Use linear scale for numeric X variable in scatter plot
                 // Need to handle non-numeric X for scatter plot if necessary
             } else if (type === 'boxplot') {
                 // Boxplot simulation or plugin integration would go here
                 // This is complex and requires a plugin or manual drawing.
                 // For this example, we'll just show a message or fallback to bar chart.
                 chartArea.innerHTML = `<p>Box plot visualization requires a Chart.js plugin or custom implementation. Showing aggregated bar chart instead.</p><canvas id="myChart"></canvas>`;
                 const newCanvas = document.getElementById('myChart');
                 const newCtx = newCanvas.getContext('2d');
                 config.type = 'bar'; // Fallback to bar chart
                 // Re-run renderChart with fallback type if needed, or just use the modified config
             }


            // Create the chart
            currentChart = new Chart(ctx, config);
            console.log("Chart generated:", type, xVar, yVar, colorVar);

            // Add placeholder floating controls (if needed per example, though global controls are used here)
            // This example uses global controls above the chart area.
        }


        function exportContent() {
            const format = exportFormatSelect.value;
            console.log(`Attempting to export in ${format} format.`);

            if (format === 'csv') {
                if (parsedData) {
                    // Simulate CSV export of raw data
                    alert('Simulating CSV export of data.');
                    // In a real app, format parsedData into CSV string and trigger download
                } else {
                    alert('No data available to export.');
                }
            } else if (format === 'png') {
                 if (currentChart) {
                     // Export chart as PNG
                     const link = document.createElement('a');
                     link.href = currentChart.toBase64Image();
                     link.download = 'analysis_chart.png';
                     link.click();
                     console.log('Chart exported as PNG.');
                 } else {
                     alert('No chart available to export.');
                 }
            } else if (format === 'pdf') {
                // Simulate PDF report export (more complex, requires PDF library)
                 alert('Simulating PDF report export (requires a PDF generation library).');
            }
        }


        function showLoading(elementId, message = 'Loading...') {
            const loadingElement = document.getElementById(elementId);
            if (loadingElement) {
                loadingElement.querySelector('p').textContent = message;
                loadingElement.classList.add('active');
            }
        }

        function hideLoading(elementId) {
             const loadingElement = document.getElementById(elementId);
             if (loadingElement) {
                 loadingElement.classList.remove('active');
             }
        }

        // --- Initial Setup ---
        // Hide results, visualization, and export sections initially
        analysisResultsSection.style.display = 'none';
        visualizationSection.style.display = 'none';
        exportSection.style.display = 'none';
        document.getElementById('dataPreviewSection').style.display = 'none';


        // Basic keyboard navigation (tabbing works natively)
        // Add specific shortcuts if needed later


    </script>
</body>
</html>
