<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleep & Academic Performance Analyzer</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #007bff;
            --primary-dark: #0056b3;
            --secondary-color: #6c757d;
            --background-color: #f8f9fa;
            --surface-color: #ffffff;
            --text-color: #343a40;
            --border-color: #dee2e6;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --spacing-unit: 1rem;
            --border-radius: 0.5rem;
            --box-shadow-subtle: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--background-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            background-color: var(--surface-color);
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 2);
            box-shadow: var(--box-shadow-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        header h1 {
            margin: 0;
            font-size: 1.8rem;
            color: var(--primary-color);
        }

        .container {
            flex: 1;
            display: grid;
            grid-template-columns: 300px 1fr; /* Sidebar + Main Content */
            gap: calc(var(--spacing-unit) * 2);
            padding: calc(var(--spacing-unit) * 2);
        }

        .sidebar {
            background-color: var(--surface-color);
            padding: var(--spacing-unit);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow-subtle);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-unit);
            overflow-y: auto; /* Allow scrolling if controls overflow */
        }

        .main-content {
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing-unit) * 2);
        }

        .panel {
            background-color: var(--surface-color);
            padding: var(--spacing-unit);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow-subtle);
        }

        .panel-title {
            font-size: 1.2rem;
            margin-top: 0;
            margin-bottom: var(--spacing-unit);
            color: var(--text-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: calc(var(--spacing-unit) / 2);
        }

        /* Data Input Area */
        #data-input-area {
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing-unit) / 2);
        }

        #data-input-area label {
            display: block;
            margin-bottom: calc(var(--spacing-unit) / 4);
            font-weight: 600;
        }

        #file-upload {
            padding: calc(var(--spacing-unit) / 2);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--background-color);
            cursor: pointer;
        }

        #file-upload:hover {
            border-color: var(--primary-color);
        }

        #load-data-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: calc(var(--spacing-unit) * 0.75) var(--spacing-unit);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1rem;
            transition: background-color 0.2s ease;
        }

        #load-data-btn:hover {
            background-color: var(--primary-dark);
        }

        #loading-indicator {
            display: none; /* Hidden by default */
            margin-top: var(--spacing-unit);
            text-align: center;
            font-size: 0.9rem;
            color: var(--secondary-color);
        }

        /* Data Table */
        #data-table-container {
            overflow-x: auto; /* Allow horizontal scrolling for wide tables */
            max-height: 400px; /* Limit table height */
        }

        #data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: var(--spacing-unit);
            font-size: 0.9rem;
        }

        #data-table th,
        #data-table td {
            border: 1px solid var(--border-color);
            padding: calc(var(--spacing-unit) / 2) calc(var(--spacing-unit) * 0.75);
            text-align: left;
        }

        #data-table th {
            background-color: var(--background-color);
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        #data-table th:hover {
            background-color: #e9ecef;
        }

        #data-table tbody tr:nth-child(even) {
            background-color: #f2f2f2; /* Alternating row color */
        }

        /* Control Panel */
        .control-group {
            margin-bottom: var(--spacing-unit);
        }

        .control-group label {
            display: block;
            margin-bottom: calc(var(--spacing-unit) / 4);
            font-weight: 600;
        }

        .control-group select,
        .control-group button {
            width: 100%;
            padding: calc(var(--spacing-unit) * 0.5) var(--spacing-unit);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            background-color: var(--surface-color);
            cursor: pointer;
        }

        .control-group select {
            appearance: none; /* Remove default arrow */
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23343a40%22%20d%3D%22M287%2C114.7L159.2%2C28.9c-9.2-9.2-22.9-11.9-34.2-6.5c-11.3%2C5.4-18.3%2C16.6-18.3%2C28.9v227.7c0%2C12.3%2C7%2C23.5%2C18.3%2C28.9c11.3%2C5.4%2C25%2C2.7%2C34.2-6.5L287%2C177.6c9.2-9.2%2C9.2-24.1%2C0-33.3L287%2C114.7z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right var(--spacing-unit) center;
            background-size: 0.6em auto;
            padding-right: calc(var(--spacing-unit) * 2.5);
        }

        .control-group button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            transition: background-color 0.2s ease;
        }

        .control-group button:hover {
            background-color: var(--primary-dark);
        }

        /* Visualization Area */
        #visualization-area {
            position: relative;
            min-height: 400px; /* Ensure chart area has some height */
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #visualization-area canvas {
            max-width: 100%;
            max-height: 600px; /* Limit chart height */
        }

        /* Statistical Summary */
        #statistical-summary-area {
            margin-top: var(--spacing-unit);
        }

        #statistical-summary-area p {
            margin-bottom: calc(var(--spacing-unit) / 2);
            font-size: 0.95rem;
        }

        #statistical-summary-area strong {
            color: var(--primary-dark);
        }

        /* Error Messages */
        #error-message {
            color: var(--danger-color);
            margin-top: var(--spacing-unit);
            padding: calc(var(--spacing-unit) / 2);
            border: 1px solid var(--danger-color);
            background-color: rgba(220, 53, 69, 0.1);
            border-radius: var(--border-radius);
            display: none; /* Hidden by default */
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr; /* Stack panels on smaller screens */
                gap: var(--spacing-unit);
                padding: var(--spacing-unit);
            }

            .sidebar {
                order: 2; /* Move sidebar below main content on mobile */
            }

            .main-content {
                order: 1;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>ðŸ“Š Sleep & Academic Performance Analyzer</h1>
    </header>

    <main class="container">
        <aside class="sidebar">
            <div id="data-input-area" class="panel">
                <h2 class="panel-title">Data Input</h2>
                <p>Upload your study data (.csv format).</p>
                <input type="file" id="file-upload" accept=".csv">
                <button id="load-data-btn">Load Data</button>
                <div id="loading-indicator">Loading...</div>
                <div id="error-message"></div>
            </div>

            <div id="control-panel" class="panel">
                <h2 class="panel-title">Analysis Controls</h2>
                <div class="control-group">
                    <label for="x-variable">X-axis Variable:</label>
                    <select id="x-variable">
                        <option value="">Select Variable</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="y-variable">Y-axis Variable:</label>
                    <select id="y-variable">
                        <option value="">Select Variable</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="chart-type">Chart Type:</label>
                    <select id="chart-type">
                        <option value="">Select Chart Type</option>
                        <option value="scatter">Scatter Plot</option>
                        <option value="bar">Bar Chart</option>
                        <option value="boxplot">Box Plot (Requires Plugin)</option>
                        <option value="histogram">Histogram (Requires Data Processing)</option>
                    </select>
                </div>
                <div class="control-group">
                    <button id="visualize-btn">Visualize Data</button>
                </div>
                 <div class="control-group">
                    <button id="calculate-stats-btn">Calculate Statistics</button>
                </div>
                 <div class="control-group">
                    <button id="clear-data-btn">Clear Data</button>
                </div>
            </div>
        </aside>

        <section class="main-content">
            <div id="data-table-panel" class="panel">
                <h2 class="panel-title">Raw Data</h2>
                <div id="data-table-container">
                    <table id="data-table">
                        <thead>
                            <tr>
                                <!-- Table headers will be populated by JS -->
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table rows will be populated by JS -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="visualization-panel" class="panel">
                <h2 class="panel-title">Data Visualization</h2>
                <div id="visualization-area">
                    <canvas id="myChart"></canvas>
                    <!-- Floating controls could be added here later if needed -->
                </div>
            </div>

             <div id="statistical-summary-panel" class="panel">
                <h2 class="panel-title">Statistical Summary</h2>
                <div id="statistical-summary-area">
                    <p>Select variables and click "Calculate Statistics".</p>
                </div>
            </div>
        </section>
    </main>

    <script type="module">
        // Import Chart.js
        import { Chart } from "https://esm.sh/chart.js/auto";
        // Import a simple CSV parser (can replace with PapaParse if needed)
        // Basic CSV parsing function
        function parseCSV(csvString) {
            const lines = csvString.trim().split('\n');
            if (lines.length === 0) return null;

            const headers = lines[0].split(',').map(header => header.trim());
            const data = [];

            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(value => value.trim());
                if (values.length !== headers.length) {
                    console.warn(`Skipping row ${i + 1} due to inconsistent column count.`);
                    continue; // Skip rows with incorrect column count
                }
                const row = {};
                headers.forEach((header, index) => {
                    let value = values[index];
                    // Attempt to convert to number if it looks like one
                    if (!isNaN(value) && value !== '') {
                         value = parseFloat(value);
                    }
                    row[header] = value;
                });
                data.push(row);
            }
            return { headers, data };
        }

        let rawData = [];
        let dataHeaders = [];
        let myChart = null; // To hold the Chart.js instance

        const fileUpload = document.getElementById('file-upload');
        const loadDataBtn = document.getElementById('load-data-btn');
        const dataTable = document.getElementById('data-table');
        const xVariableSelect = document.getElementById('x-variable');
        const yVariableSelect = document.getElementById('y-variable');
        const chartTypeSelect = document.getElementById('chart-type');
        const visualizeBtn = document.getElementById('visualize-btn');
        const calculateStatsBtn = document.getElementById('calculate-stats-btn');
        const clearDataBtn = document.getElementById('clear-data-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const errorMessage = document.getElementById('error-message');
        const statisticalSummaryArea = document.getElementById('statistical-summary-area');
        const chartCanvas = document.getElementById('myChart');
        const chartCtx = chartCanvas.getContext('2d');


        // Event Listeners
        loadDataBtn.addEventListener('click', handleLoadData);
        visualizeBtn.addEventListener('click', handleVisualizeData);
        calculateStatsBtn.addEventListener('click', handleCalculateStats);
        clearDataBtn.addEventListener('click', handleClearData);
        dataTable.addEventListener('click', handleTableSort);


        // Handlers
        function handleLoadData() {
            const file = fileUpload.files[0];
            if (!file) {
                showError("Please select a CSV file.");
                return;
            }

            if (file.type !== 'text/csv') {
                 showError("Please select a valid CSV file.");
                 return;
            }

            loadingIndicator.style.display = 'block';
            errorMessage.style.display = 'none';
            hideError(); // Clear previous errors

            const reader = new FileReader();
            reader.onload = function(e) {
                const csvString = e.target.result;
                const parsed = parseCSV(csvString);

                if (parsed && parsed.data.length > 0) {
                    rawData = parsed.data;
                    dataHeaders = parsed.headers;
                    displayDataTable(rawData, dataHeaders);
                    populateVariableSelects(dataHeaders);
                    loadingIndicator.style.display = 'none';
                    console.log("Data loaded successfully:", rawData);
                } else {
                    showError("Failed to parse CSV or the file is empty.");
                    loadingIndicator.style.display = 'none';
                }
            };
            reader.onerror = function() {
                 showError("Error reading file.");
                 loadingIndicator.style.display = 'none';
            };
            reader.readAsText(file);
        }

        function displayDataTable(data, headers) {
            const thead = dataTable.querySelector('thead tr');
            const tbody = dataTable.querySelector('tbody');

            // Clear existing table content
            thead.innerHTML = '';
            tbody.innerHTML = '';

            // Populate headers
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                th.dataset.column = header; // Add data attribute for sorting
                thead.appendChild(th);
            });

            // Populate rows
            data.forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = row[header];
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
        }

        function populateVariableSelects(headers) {
            const numericHeaders = headers.filter(header =>
                rawData.some(row => typeof row[header] === 'number' && !isNaN(row[header]))
            );

            // Clear existing options except the default
            xVariableSelect.innerHTML = '<option value="">Select Variable</option>';
            yVariableSelect.innerHTML = '<option value="">Select Variable</option>';

            numericHeaders.forEach(header => {
                const optionX = document.createElement('option');
                optionX.value = header;
                optionX.textContent = header;
                xVariableSelect.appendChild(optionX);

                const optionY = document.createElement('option');
                optionY.value = header;
                optionY.textContent = header;
                yVariableSelect.appendChild(optionY);
            });
        }

        function handleVisualizeData() {
             hideError();
             if (rawData.length === 0) {
                showError("Please load data first.");
                return;
            }

            const xVar = xVariableSelect.value;
            const yVar = yVariableSelect.value;
            const chartType = chartTypeSelect.value;

            if (!chartType) {
                showError("Please select a chart type.");
                return;
            }

            // Destroy previous chart instance if it exists
            if (myChart) {
                myChart.destroy();
            }

            let chartConfig = {};
            const labels = rawData.map((_, index) => index + 1); // Default labels

            try {
                switch (chartType) {
                    case 'scatter':
                        if (!xVar || !yVar) {
                            showError("Please select both X and Y variables for Scatter Plot.");
                            return;
                        }
                        const scatterData = rawData.map(row => ({
                            x: row[xVar],
                            y: row[yVar]
                        }));
                        chartConfig = {
                            type: 'scatter',
                            data: {
                                datasets: [{
                                    label: `${yVar} vs ${xVar}`,
                                    data: scatterData,
                                    backgroundColor: 'rgba(0, 123, 255, 0.5)',
                                    borderColor: 'rgba(0, 123, 255, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    x: {
                                        type: 'linear',
                                        position: 'bottom',
                                        title: {
                                            display: true,
                                            text: xVar
                                        }
                                    },
                                    y: {
                                        type: 'linear',
                                        title: {
                                            display: true,
                                            text: yVar
                                        }
                                    }
                                },
                                plugins: {
                                    tooltip: {
                                        callbacks: {
                                            label: function(context) {
                                                const label = context.dataset.label || '';
                                                if (label) {
                                                    return label + ': (' + context.parsed.x + ', ' + context.parsed.y + ')';
                                                }
                                                return '(' + context.parsed.x + ', ' + context.parsed.y + ')';
                                            }
                                        }
                                    }
                                }
                            }
                        };
                        break;

                    case 'bar':
                        if (!xVar || !yVar) {
                            showError("Please select X (Category) and Y (Value) variables for Bar Chart.");
                            return;
                        }
                         // For simplicity, let's assume X is categorical and Y is numerical
                         // We'll group data by X and calculate the average of Y
                        const groupedData = rawData.reduce((acc, row) => {
                            const category = row[xVar];
                            const value = row[yVar];
                            if (category !== undefined && value !== undefined && typeof value === 'number') {
                                if (!acc[category]) {
                                    acc[category] = { sum: 0, count: 0 };
                                }
                                acc[category].sum += value;
                                acc[category].count++;
                            }
                            return acc;
                        }, {});

                        const barLabels = Object.keys(groupedData);
                        const barDataValues = barLabels.map(label => groupedData[label].sum / groupedData[label].count);

                        chartConfig = {
                            type: 'bar',
                            data: {
                                labels: barLabels,
                                datasets: [{
                                    label: `Average ${yVar} by ${xVar}`,
                                    data: barDataValues,
                                    backgroundColor: 'rgba(75, 192, 192, 0.6)',
                                    borderColor: 'rgba(75, 192, 192, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: `Average ${yVar}`
                                        }
                                    },
                                    x: {
                                        title: {
                                            display: true,
                                            text: xVar
                                        }
                                    }
                                }
                            }
                        };
                        break;

                    case 'boxplot':
                         showError("Box Plot requires a Chart.js plugin and specific data formatting, not fully implemented in this example.");
                         return; // Exit if not implemented

                    case 'histogram':
                         if (!xVar) {
                            showError("Please select a variable for Histogram.");
                            return;
                        }
                        // Basic histogram logic: count frequency within bins
                        const histogramData = rawData.map(row => row[xVar]).filter(val => typeof val === 'number' && !isNaN(val));
                        if (histogramData.length === 0) {
                             showError(`No numeric data found for variable "${xVar}" to create histogram.`);
                             return;
                        }

                        const numBins = 10; // Example number of bins
                        const minVal = Math.min(...histogramData);
                        const maxVal = Math.max(...histogramData);
                        const binSize = (maxVal - minVal) / numBins;

                        const bins = Array(numBins).fill(0);
                        const binLabels = [];

                        for (let i = 0; i < numBins; i++) {
                            const lowerBound = minVal + i * binSize;
                            const upperBound = minVal + (i + 1) * binSize;
                            binLabels.push(`${lowerBound.toFixed(2)}-${upperBound.toFixed(2)}`);
                        }

                        histogramData.forEach(value => {
                            let binIndex = Math.floor((value - minVal) / binSize);
                            if (binIndex === numBins) binIndex--; // Handle max value edge case
                            if (binIndex >= 0 && binIndex < numBins) {
                                bins[binIndex]++;
                            }
                        });

                        chartConfig = {
                            type: 'bar', // Histograms are often represented as bar charts
                            data: {
                                labels: binLabels,
                                datasets: [{
                                    label: `Frequency of ${xVar}`,
                                    data: bins,
                                    backgroundColor: 'rgba(153, 102, 255, 0.6)',
                                    borderColor: 'rgba(153, 102, 255, 1)',
                                    borderWidth: 1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                scales: {
                                    y: {
                                        beginAtZero: true,
                                        title: {
                                            display: true,
                                            text: 'Frequency'
                                        }
                                    },
                                    x: {
                                        title: {
                                            display: true,
                                            text: xVar + ' Bins'
                                        }
                                    }
                                },
                                plugins: {
                                     tooltip: {
                                         callbacks: {
                                             title: function(context) {
                                                 return `Bin: ${context[0].label}`;
                                             },
                                              label: function(context) {
                                                return `Frequency: ${context.parsed.y}`;
                                            }
                                         }
                                     }
                                }
                            }
                        };
                        break;

                    default:
                        showError("Selected chart type is not supported yet.");
                        return;
                }

                // Create the new chart
                myChart = new Chart(chartCtx, chartConfig);

            } catch (error) {
                console.error("Error generating chart:", error);
                showError("Error generating chart. Please check variable selections and data format.");
            }
        }

        function handleCalculateStats() {
            hideError();
             if (rawData.length === 0) {
                showError("Please load data first.");
                return;
            }

            const xVar = xVariableSelect.value;
            const yVar = yVariableSelect.value;

            if (!xVar || !yVar) {
                statisticalSummaryArea.innerHTML = "<p>Please select both X and Y variables to calculate statistics.</p>";
                return;
            }

            // Filter for numeric data pairs
            const dataPairs = rawData
                .map(row => ({ x: row[xVar], y: row[yVar] }))
                .filter(pair => typeof pair.x === 'number' && !isNaN(pair.x) && typeof pair.y === 'number' && !isNaN(pair.y));

            if (dataPairs.length < 2) {
                 statisticalSummaryArea.innerHTML = `<p>Not enough valid numeric data points for "${xVar}" and "${yVar}" to calculate statistics.</p>`;
                 return;
            }

            // Calculate Pearson Correlation Coefficient
            // Formula: r = Sum((xi - mean_x) * (yi - mean_y)) / (sqrt(Sum((xi - mean_x)^2)) * sqrt(Sum((yi - mean_y)^2)))
            const n = dataPairs.length;
            const sumX = dataPairs.reduce((sum, pair) => sum + pair.x, 0);
            const sumY = dataPairs.reduce((sum, pair) => sum + pair.y, 0);
            const meanX = sumX / n;
            const meanY = sumY / n;

            let sumNumerator = 0;
            let sumDenominatorX = 0;
            let sumDenominatorY = 0;

            dataPairs.forEach(pair => {
                const diffX = pair.x - meanX;
                const diffY = pair.y - meanY;
                sumNumerator += diffX * diffY;
                sumDenominatorX += diffX * diffX;
                sumDenominatorY += diffY * diffY;
            });

            const denominator = Math.sqrt(sumDenominatorX) * Math.sqrt(sumDenominatorY);

            let correlation = 0;
            if (denominator !== 0) {
                correlation = sumNumerator / denominator;
            } else {
                 statisticalSummaryArea.innerHTML = `<p>Cannot calculate correlation for "${xVar}" and "${yVar}" (division by zero).</p>`;
                 return;
            }

            // Display summary
            statisticalSummaryArea.innerHTML = `
                <p><strong>Variables:</strong> ${xVar} and ${yVar}</p>
                <p><strong>Number of data points:</strong> ${n}</p>
                <p><strong>Pearson Correlation Coefficient (r):</strong> ${correlation.toFixed(4)}</p>
                <p><em>Interpretation:</em></p>
                <ul>
                    <li>r close to 1: Strong positive linear correlation</li>
                    <li>r close to -1: Strong negative linear correlation</li>
                    <li>r close to 0: Weak or no linear correlation</li>
                </ul>
            `;
        }

        function handleClearData() {
            rawData = [];
            dataHeaders = [];
            displayDataTable([], []); // Clear table
            populateVariableSelects([]); // Clear selects
            if (myChart) {
                myChart.destroy(); // Destroy chart
                myChart = null;
                 chartCtx.clearRect(0, 0, chartCanvas.width, chartCanvas.height); // Clear canvas explicitly
            }
            statisticalSummaryArea.innerHTML = "<p>Select variables and click \"Calculate Statistics\".</p>"; // Reset stats area
            fileUpload.value = ''; // Clear file input
            hideError();
            console.log("Data cleared.");
        }

        function handleTableSort(event) {
            const target = event.target;
            if (target.tagName === 'TH') {
                const column = target.dataset.column;
                if (!column) return;

                const currentSortOrder = target.dataset.sortOrder || 'asc';
                const newSortOrder = currentSortOrder === 'asc' ? 'desc' : 'asc';

                // Determine data type for sorting
                const isNumeric = rawData.some(row => typeof row[column] === 'number' && !isNaN(row[column]));

                rawData.sort((a, b) => {
                    const valA = a[column];
                    const valB = b[column];

                    if (isNumeric) {
                        // Handle potential non-numeric values gracefully
                        const numA = typeof valA === 'number' ? valA : (parseFloat(valA) || 0);
                        const numB = typeof valB === 'number' ? valB : (parseFloat(valB) || 0);
                        if (newSortOrder === 'asc') {
                            return numA - numB;
                        } else {
                            return numB - numA;
                        }
                    } else {
                         // String comparison
                        const stringA = String(valA).toLowerCase();
                        const stringB = String(valB).toLowerCase();
                        if (stringA < stringB) return newSortOrder === 'asc' ? -1 : 1;
                        if (stringA > stringB) return newSortOrder === 'asc' ? 1 : -1;
                        return 0;
                    }
                });

                // Update table display
                displayDataTable(rawData, dataHeaders);

                // Update sort order attribute on header
                dataTable.querySelectorAll('th').forEach(th => th.removeAttribute('data-sort-order'));
                target.dataset.sortOrder = newSortOrder;
            }
        }


        function showError(message) {
            errorMessage.textContent = message;
            errorMessage.style.display = 'block';
        }

        function hideError() {
            errorMessage.style.display = 'none';
            errorMessage.textContent = '';
        }

         // Initial state setup
        statisticalSummaryArea.innerHTML = "<p>Select variables and click \"Calculate Statistics\".</p>";


    </script>
</body>
</html>
