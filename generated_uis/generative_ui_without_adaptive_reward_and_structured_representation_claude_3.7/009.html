<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Public Speaking Practice Platform</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        :root {
            --primary-color: #007bff;
            --primary-dark: #0056b3;
            --secondary-color: #28a745;
            --secondary-dark: #218838;
            --danger-color: #dc3545;
            --danger-dark: #c82333;
            --warning-color: #ffc107;
            --warning-dark: #d39e00;
            --background-color: #f8f9fa;
            --surface-color: #ffffff;
            --text-color: #343a40;
            --text-light: #6c757d;
            --border-color: #dee2e6;
            --shadow-color: rgba(0, 0, 0, 0.08);
            --spacing-unit: 1rem;
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--background-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        header {
            background-color: var(--surface-color);
            border-bottom: 1px solid var(--border-color);
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 2);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px var(--shadow-color);
        }

        .site-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            text-decoration: none;
        }

        nav a {
            color: var(--text-color);
            text-decoration: none;
            margin-left: var(--spacing-unit);
            font-weight: 500;
            padding: 0.5rem 0;
            position: relative;
            transition: color 0.2s ease-in-out;
        }

        nav a:hover {
            color: var(--primary-color);
        }

        nav a::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 0;
            height: 2px;
            background-color: var(--primary-color);
            transition: width 0.3s ease-in-out;
        }

        nav a:hover::after,
        nav a.active::after {
            width: 100%;
        }

        main {
            flex-grow: 1;
            padding: calc(var(--spacing-unit) * 2);
            display: flex;
            flex-direction: column; /* Default to column for mobile/tablet first */
            gap: calc(var(--spacing-unit) * 2);
        }

        .section {
            background-color: var(--surface-color);
            padding: calc(var(--spacing-unit) * 1.5);
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--shadow-color);
            display: none; /* Initially hidden */
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        .section.active {
            display: flex; /* Use flex to manage inner layout */
            flex-direction: column;
            opacity: 1;
            transform: translateY(0);
        }

        .section h2 {
            margin-top: 0;
            color: var(--primary-dark);
            font-size: 1.3rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: var(--spacing-unit);
            margin-bottom: var(--spacing-unit);
        }

        /* Practice Area Specific Styles */
        .practice-area.active {
            display: grid; /* Use grid for desktop layout */
            grid-template-columns: 1fr; /* Default to single column */
            gap: calc(var(--spacing-unit) * 2);
        }


        .script-container {
            margin-bottom: var(--spacing-unit);
        }

        .script-container label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        #speech-script {
            width: 100%;
            min-height: 300px;
            padding: var(--spacing-unit);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: 'Inter', sans-serif;
            font-size: 1rem;
            resize: vertical;
            outline: none;
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }

        #speech-script:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .controls {
            display: flex;
            gap: var(--spacing-unit);
            align-items: center;
            margin-bottom: var(--spacing-unit);
            flex-wrap: wrap; /* Allow controls to wrap on smaller screens */
        }

        button {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, opacity 0.2s ease-in-out, transform 0.1s ease-in-out;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        button:not(:disabled):active {
            transform: scale(0.98);
        }


        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:not(:disabled):hover {
            background-color: var(--primary-dark);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        .btn-secondary:not(:disabled):hover {
            background-color: var(--secondary-dark);
        }

        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }

        .btn-danger:not(:disabled):hover {
            background-color: var(--danger-dark);
        }

        .btn-warning {
            background-color: var(--warning-color);
            color: var(--text-color);
        }

        .btn-warning:not(:disabled):hover {
            background-color: var(--warning-dark);
        }

        .timer {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-color);
            margin-left: auto; /* Pushes timer to the right */
        }

        .analysis-results {
             /* Initially hidden via .section */
        }

        .analysis-panel {
            margin-bottom: var(--spacing-unit);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            overflow: hidden;
        }

        .panel-header {
            background-color: var(--background-color);
            padding: var(--spacing-unit);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: var(--text-color);
            transition: background-color 0.2s ease-in-out;
            outline: none; /* Remove default outline */
        }

        .panel-header:hover {
            background-color: #e9ecef;
        }

         .panel-header:focus {
             box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
         }


        .panel-header .material-symbols-rounded {
            transition: transform 0.3s ease-in-out;
        }

        .panel-content {
            padding: var(--spacing-unit);
            border-top: 1px solid var(--border-color);
            display: grid; /* Use grid for content layout */
            grid-template-columns: 1fr; /* Default to single column */
            gap: var(--spacing-unit);
            opacity: 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, opacity 0.5s ease-in-out;
        }

        .analysis-panel.expanded .panel-content {
            opacity: 1;
            max-height: 1000px; /* Adjust as needed */
        }

        .analysis-panel.expanded .panel-header .material-symbols-rounded {
            transform: rotate(180deg);
        }

        .chart-container {
            height: 300px; /* Fixed height for charts */
            position: relative;
        }

        .filler-word-list ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .filler-word-list li {
            background-color: #f1f1f1;
            padding: 0.5rem var(--spacing-unit);
            margin-bottom: 0.5rem;
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9rem;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            outline: none; /* Remove default outline */
        }

        .filler-word-list li:hover {
            background-color: #e0e0e0;
        }

         .filler-word-list li:focus {
             box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
         }

        .filler-word-list li .count {
            font-weight: 600;
            color: var(--primary-dark);
        }

        /* Chart Floating Controls */
        .floating-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px; /* Increased padding */
            border-radius: 10px; /* Increased border-radius */
            box-shadow: 0 2px 8px var(--shadow-color);
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 10;
        }
        .floating-controls.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }
        .control-group {
            margin: 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .control-group label {
            font-size: 0.9rem;
            color: var(--text-light);
            flex-shrink: 0;
        }
        .floating-controls input[type="color"],
        .floating-controls select {
            padding: 4px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
        }
         .floating-controls input[type="color"] {
             padding: 2px; /* Adjust padding for color input */
             height: 30px;
         }


        /* Learn Area Specific Styles */
        .learn-area .learning-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--spacing-unit);
        }

        .learning-card {
            background-color: var(--background-color);
            padding: var(--spacing-unit);
            border-radius: 8px;
            box-shadow: 0 2px 4px var(--shadow-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
            outline: none; /* Remove default outline */
        }

        .learning-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px var(--shadow-color);
        }

         .learning-card:focus {
             box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
         }

        .learning-card .icon {
            font-size: 3rem;
            color: var(--primary-color);
            margin-bottom: 0.5rem;
        }

        .learning-card h3 {
            margin-top: 0;
            margin-bottom: 0.5rem;
            color: var(--primary-dark);
            font-size: 1.1rem;
        }

        .learning-card p {
            font-size: 0.9rem;
            color: var(--text-light);
            margin-bottom: 0;
        }

        .learning-detail {
            margin-top: calc(var(--spacing-unit) * 1.5); /* Increased margin */
            padding-top: calc(var(--spacing-unit) * 1.5); /* Increased padding */
            border-top: 1px solid var(--border-color);
            display: none; /* Hidden by default */
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
        }

        .learning-detail.active {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }

        .learning-detail h3 {
             color: var(--primary-dark);
             font-size: 1.2rem;
             margin-bottom: var(--spacing-unit);
        }

         .learning-detail p,
         .learning-detail ul {
             font-size: 1rem;
             color: var(--text-color);
             margin-bottom: var(--spacing-unit);
         }

         .learning-detail ul {
             padding-left: var(--spacing-unit) * 1.5;
         }

         .learning-detail li {
             margin-bottom: 0.5rem;
         }


        footer {
            background-color: var(--text-color);
            color: white;
            text-align: center;
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 2);
            margin-top: calc(var(--spacing-unit) * 2);
        }

        footer a {
            color: white;
            text-decoration: none;
            margin: 0 0.5rem;
        }

        footer a:hover {
            text-decoration: underline;
        }

        /* Responsive */
        @media (min-width: 992px) {
            .practice-area.active {
                grid-template-columns: 1fr 1fr; /* Side-by-side on desktop */
            }

            .analysis-panel .panel-content {
                grid-template-columns: 1fr 1fr; /* Charts/lists side-by-side */
            }

            .filler-word-list {
                 grid-column: span 2; /* Filler list spans both columns */
            }

            .controls button {
                width: auto; /* Auto width on desktop */
            }

            .timer {
                 margin-left: auto; /* Push timer right on desktop */
            }
        }

         @media (max-width: 991px) {
             .controls {
                 flex-direction: column;
                 align-items: stretch;
             }

             .controls button {
                 width: 100%;
             }

             .timer {
                 margin-left: 0;
                 text-align: center;
             }
         }
    </style>
</head>
<body>
    <header>
        <a href="#" class="site-title">SpeakWell</a>
        <nav>
            <a href="#practice" class="nav-link active" data-section="practice">Practice</a>
            <a href="#learn" class="nav-link" data-section="learn">Learn</a>
            <a href="#progress" class="nav-link" data-section="progress">Progress</a>
            <a href="#account" class="nav-link" data-section="account">Account</a>
        </nav>
    </header>

    <main>
        <section id="practice" class="section practice-area active">
            <div> <!-- Container for Script and Controls -->
                <h2>Speech Practice</h2>
                <div class="script-container">
                    <label for="speech-script">Enter your speech script:</label>
                    <textarea id="speech-script" placeholder="Type or paste your speech here..."></textarea>
                </div>
                <div class="controls">
                    <button id="record-btn" class="btn-primary"><span class="material-symbols-rounded">mic</span> Record</button>
                    <button id="stop-btn" class="btn-danger" disabled><span class="material-symbols-rounded">stop</span> Stop</button>
                    <button id="play-btn" class="btn-secondary" disabled><span class="material-symbols-rounded">play_arrow</span> Play</button>
                    <button id="analyze-btn" class="btn-warning" disabled><span class="material-symbols-rounded">insights</span> Analyze</button>
                    <div class="timer" id="timer">00:00</div>
                </div>
            </div>
             <div class="analysis-results" id="analysis-results">
                <h2>Analysis Results</h2>
                 <div id="analysis-message">Run an analysis to see results here.</div>

                <div class="analysis-panel" id="pace-panel">
                    <div class="panel-header" role="button" aria-expanded="false" aria-controls="pace-content" tabindex="0">
                        Pace (Words Per Minute)
                        <span class="material-symbols-rounded">expand_more</span>
                    </div>
                    <div class="panel-content" id="pace-content" aria-hidden="true">
                        <p>Overall Pace: <strong id="overall-pace">- WPM</strong></p>
                        <div class="chart-container">
                            <canvas id="pace-chart"></canvas>
                             <div class="floating-controls" id="pace-chart-controls">
                                <div class="control-group">
                                    <label for="pace-chart-type">Type:</label>
                                    <select id="pace-chart-type" aria-label="Pace chart type">
                                        <option value="line">Line</option>
                                        <option value="bar">Bar</option>
                                    </select>
                                </div>
                                <div class="control-group">
                                    <label for="pace-line-color">Color:</label>
                                    <input type="color" id="pace-line-color" value="#007bff" aria-label="Pace chart color">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="analysis-panel" id="pauses-panel">
                    <div class="panel-header" role="button" aria-expanded="false" aria-controls="pauses-content" tabindex="0">
                        Pauses
                        <span class="material-symbols-rounded">expand_more</span>
                    </div>
                    <div class="panel-content" id="pauses-content" aria-hidden="true">
                         <p>Total Pauses: <strong id="total-pauses">-</strong></p>
                         <p>Average Pause Duration: <strong id="avg-pause-duration">- s</strong></p>
                        <div class="chart-container">
                            <canvas id="pauses-chart"></canvas>
                             <div class="floating-controls" id="pauses-chart-controls">
                                <div class="control-group">
                                    <label for="pauses-chart-type">Type:</label>
                                    <select id="pauses-chart-type" aria-label="Pauses chart type">
                                        <option value="bar">Bar</option>
                                        <option value="line">Line</option>
                                    </select>
                                </div>
                                <div class="control-group">
                                    <label for="pauses-bar-color">Color:</label>
                                    <input type="color" id="pauses-bar-color" value="#28a745" aria-label="Pauses chart color">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="analysis-panel" id="fillers-panel">
                    <div class="panel-header" role="button" aria-expanded="false" aria-controls="fillers-content" tabindex="0">
                        Filler Words
                        <span class="material-symbols-rounded">expand_more</span>
                    </div>
                    <div class="panel-content" id="fillers-content" aria-hidden="true">
                        <p>Total Filler Words: <strong id="total-fillers">-</strong></p>
                        <div class="filler-word-list">
                            <p>Detected words (click to highlight in script):</p>
                            <ul id="filler-word-list" role="list">
                                <!-- Filler words will be listed here -->
                            </ul>
                        </div>
                    </div>
                </div>

            </div>
        </section>

        <section id="learn" class="section learn-area">
            <h2>Learn Public Speaking</h2>
            <div class="learning-cards">
                <div class="learning-card" data-topic="pace">
                    <span class="material-symbols-rounded icon">speed</span>
                    <h3>Mastering Pace</h3>
                    <p>Learn how to control your speaking speed for impact.</p>
                </div>
                 <div class="learning-card" data-topic="pauses">
                    <span class="material-symbols-rounded icon">pause</span>
                    <h3>Effective Pauses</h3>
                    <p>Discover the power of silence in your speech.</p>
                </div>
                 <div class="learning-card" data-topic="fillers">
                    <span class="material-symbols-rounded icon">volume_off</span>
                    <h3>Eliminating Fillers</h3>
                    <p>Tips and tricks to reduce "um," "uh," and "like."</p>
                </div>
                 <div class="learning-card" data-topic="structure">
                    <span class="material-symbols-rounded icon">structure</span>
                    <h3>Speech Structure</h3>
                    <p>Build a compelling narrative with a clear structure.</p>
                </div>
                 <div class="learning-card" data-topic="body-language">
                    <span class="material-symbols-rounded icon">accessibility_new</span>
                    <h3>Body Language</h3>
                    <p>Use non-verbal cues to enhance your message.</p>
                </div>
                 <div class="learning-card" data-topic="voice">
                    <span class="material-symbols-rounded icon">record_voice_over</span>
                    <h3>Voice Modulation</h3>
                    <p>Vary your tone, pitch, and volume effectively.</p>
                </div>
            </div>

             <div class="learning-detail" id="learning-detail">
                 <!-- Content for selected topic will load here -->
                 <h3>Select a topic above to learn more.</h3>
             </div>
        </section>

         <section id="progress" class="section progress-area">
             <h2>Your Progress</h2>
             <p>Progress tracking features coming soon!</p>
         </section>

         <section id="account" class="section account-area">
             <h2>Account Settings</h2>
             <p>Account management features coming soon!</p>
         </section>

    </main>

    <footer>
        <p>&copy; 2023 SpeakWell. All rights reserved.</p>
        <p>
            <a href="#">About</a> |
            <a href="#">Contact</a> |
            <a href="#">Privacy Policy</a>
        </p>
    </footer>

    <script type="module">
        import { Chart } from "https://esm.sh/chart.js/auto";

        const scriptTextarea = document.getElementById('speech-script');
        const recordBtn = document.getElementById('record-btn');
        const stopBtn = document.getElementById('stop-btn');
        const playBtn = document.getElementById('play-btn');
        const analyzeBtn = document.getElementById('analyze-btn');
        const timerDisplay = document.getElementById('timer');
        const analysisResultsSection = document.getElementById('analysis-results');
        const analysisMessageDiv = document.getElementById('analysis-message');
        const analysisPanels = document.querySelectorAll('.analysis-panel');
        const fillerWordListUl = document.getElementById('filler-word-list');
        const overallPaceStrong = document.getElementById('overall-pace');
        const totalPausesStrong = document.getElementById('total-pauses');
        const avgPauseDurationStrong = document.getElementById('avg-pause-duration');

        const navLinks = document.querySelectorAll('.nav-link');
        const sections = document.querySelectorAll('.section');

        const learningCards = document.querySelectorAll('.learning-card');
        const learningDetail = document.getElementById('learning-detail');

        let mediaRecorder;
        let audioChunks = [];
        let timerInterval;
        let startTime;
        let audioBlob = null;

        // --- Navigation ---
        function showSection(sectionId) {
            sections.forEach(section => {
                section.classList.remove('active');
            });
            navLinks.forEach(link => {
                link.classList.remove('active');
            });

            const targetSection = document.getElementById(sectionId);
            const targetLink = document.querySelector(`.nav-link[data-section="${sectionId}"]`);

            if (targetSection) {
                targetSection.classList.add('active');
            }
            if (targetLink) {
                targetLink.classList.add('active');
            }

            // Hide floating controls when changing sections
             document.querySelectorAll('.floating-controls').forEach(controls => {
                 controls.classList.remove('active');
             });
        }

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const sectionId = e.target.dataset.section;
                showSection(sectionId);
            });
        });

        // Show the default section on load (e.g., 'practice')
        document.addEventListener('DOMContentLoaded', () => {
             const initialSection = window.location.hash ? window.location.hash.substring(1) : 'practice';
             showSection(initialSection);
             updateAnalysisResultsDisplay(); // Set initial state for analysis results
        });


        // --- Timer Functionality ---
        function startTimer() {
            startTime = Date.now();
            timerDisplay.textContent = '00:00';
            timerInterval = setInterval(() => {
                const elapsed = Date.now() - startTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                timerDisplay.textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            }, 1000);
        }

        function stopTimer() {
            clearInterval(timerInterval);
        }

        function resetTimer() {
            stopTimer();
            timerDisplay.textContent = '00:00';
        }

        // --- Recording Functionality ---
        recordBtn.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                mediaRecorder = new MediaRecorder(stream);
                audioChunks = [];

                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.onstop = () => {
                    audioBlob = new Blob(audioChunks, { type: 'audio/wav' }); // Use wav for broader compatibility simulation
                    stream.getTracks().forEach(track => track.stop()); // Stop the microphone stream
                    playBtn.disabled = false;
                    analyzeBtn.disabled = false;
                    updateAnalysisResultsDisplay(false); // Hide previous results indicator
                };

                mediaRecorder.start();
                startTimer();

                recordBtn.disabled = true;
                stopBtn.disabled = false;
                playBtn.disabled = true;
                analyzeBtn.disabled = true;

                 // Hide floating controls
                 document.querySelectorAll('.floating-controls').forEach(controls => {
                     controls.classList.remove('active');
                 });

            } catch (err) {
                console.error('Error accessing microphone:', err);
                alert('Could not access microphone. Please ensure permissions are granted.');
            }
        });

        stopBtn.addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                stopTimer();
                recordBtn.disabled = false;
                stopBtn.disabled = true;
            }
        });

        playBtn.addEventListener('click', () => {
            if (audioBlob) {
                const audioUrl = URL.createObjectURL(audioBlob);
                const audio = new Audio(audioUrl);
                audio.play();
                // Clean up the URL after playback
                audio.onended = () => URL.revokeObjectURL(audioUrl);
            }
        });

        // --- Analysis Functionality (Simulated) ---
        analyzeBtn.addEventListener('click', async () => {
            if (!audioBlob && scriptTextarea.value.trim().length === 0) {
                alert('Please record a speech or enter a script first.');
                return;
            }

            // Simulate analysis process
            analyzeBtn.textContent = 'Analyzing...';
            analyzeBtn.disabled = true;
            recordBtn.disabled = true;
            stopBtn.disabled = true;
            playBtn.disabled = true;

            // In a real application, you would send the audioBlob and scriptTextarea.value to a backend for processing
            // For this simulation, we'll use dummy data and a delay
            await new Promise(resolve => setTimeout(resolve, 2000)); // Simulate processing time

            const scriptContent = scriptTextarea.value.trim();
            const wordCount = scriptContent.split(/\s+/).filter(word => word.length > 0).length;
            // Use timer duration if recorded, otherwise estimate from script length (rough)
            const durationInSeconds = audioBlob ? (Date.now() - startTime) / 1000 : Math.max(wordCount / 150 * 60, 1); // Estimate 150 WPM if no recording
            const overallPace = durationInSeconds > 0 ? Math.round((wordCount / durationInSeconds) * 60) : 0;

            // Dummy Data for charts and fillers
            const paceData = Array.from({ length: Math.min(Math.ceil(durationInSeconds / 5), 20) }, (_, i) => Math.max(0, overallPace + (Math.random() - 0.5) * 30)); // Pace every 5 seconds
            const paceLabels = paceData.map((_, i) => `${i * 5}s`);

            const pauseDurations = Array.from({ length: Math.floor(durationInSeconds / 10) + Math.floor(Math.random() * 3) }, () => parseFloat((Math.random() * 2 + 0.3).toFixed(1))); // Dummy pause data
            const totalPauses = pauseDurations.length;
            const avgPauseDuration = totalPauses > 0 ? (pauseDurations.reduce((sum, d) => sum + d, 0) / totalPauses).toFixed(1) : 0;

            const commonFillers = ["um", "uh", "like", "you know", "so", "basically", "right"];
            const detectedFillers = {};
             if (scriptContent) {
                 // Simulate detecting fillers in script
                 const words = scriptContent.toLowerCase().match(/\b\w+\b/g) || [];
                 words.forEach(word => {
                     if (commonFillers.includes(word)) {
                         detectedFillers[word] = (detectedFillers[word] || 0) + 1;
                     }
                 });
             }
            const totalFillers = Object.values(detectedFillers).reduce((sum, count) => sum + count, 0);


            // Update UI with simulated results
            overallPaceStrong.textContent = `${overallPace} WPM`;
            totalPausesStrong.textContent = totalPauses;
            avgPauseDurationStrong.textContent = `${avgPauseDuration} s`;
            displayFillerWords(detectedFillers);

            // Show analysis results section and hide message
            updateAnalysisResultsDisplay(true);

            // Render Charts
            renderPaceChart(paceLabels, paceData);
            renderPausesChart(pauseDurations);

            // Reset button states
            analyzeBtn.textContent = 'Analyze';
            analyzeBtn.disabled = false;
            recordBtn.disabled = false;
            stopBtn.disabled = true;
            playBtn.disabled = audioBlob === null; // Enable play only if audio exists
        });

        function updateAnalysisResultsDisplay(hasAnalyzed = false) {
             if (hasAnalyzed) {
                 analysisMessageDiv.style.display = 'none';
                 analysisPanels.forEach(panel => panel.style.display = 'block');
                 analysisResultsSection.dataset.analyzed = 'true';
             } else {
                 analysisMessageDiv.style.display = 'block';
                 analysisPanels.forEach(panel => {
                     panel.style.display = 'none';
                     panel.classList.remove('expanded'); // Collapse panels
                     panel.querySelector('.panel-content').setAttribute('aria-hidden', 'true');
                     panel.querySelector('.panel-header').setAttribute('aria-expanded', 'false');
                 });
                 analysisResultsSection.dataset.analyzed = 'false';
             }
        }


        // --- Analysis Results Panel Toggle ---
        analysisPanels.forEach(panel => {
            const header = panel.querySelector('.panel-header');
            const content = panel.querySelector('.panel-content');

            // Set initial ARIA attributes
            header.setAttribute('aria-expanded', 'false');
            content.setAttribute('aria-hidden', 'true');

            header.addEventListener('click', () => {
                const isExpanded = panel.classList.contains('expanded');

                // Collapse all other panels
                analysisPanels.forEach(p => {
                     if (p !== panel) {
                        p.classList.remove('expanded');
                        p.querySelector('.panel-content').setAttribute('aria-hidden', 'true');
                        p.querySelector('.panel-header').setAttribute('aria-expanded', 'false');
                     }
                });

                // Toggle current panel
                if (!isExpanded) {
                    panel.classList.add('expanded');
                    content.setAttribute('aria-hidden', 'false');
                    header.setAttribute('aria-expanded', 'true');
                } else {
                     panel.classList.remove('expanded');
                     content.setAttribute('aria-hidden', 'true');
                     header.setAttribute('aria-expanded', 'false');
                }
                 // Hide floating controls when collapsing panels
                 if (isExpanded) {
                     document.querySelectorAll('.floating-controls').forEach(controls => {
                         controls.classList.remove('active');
                     });
                 }
            });

             // Add keyboard support for panel headers
             header.addEventListener('keydown', (event) => {
                 if (event.key === 'Enter' || event.key === ' ') {
                     event.preventDefault();
                     header.click(); // Trigger the click handler
                 }
             });
        });


        // --- Filler Word List & Highlighting ---
        function displayFillerWords(fillerWords) {
            fillerWordListUl.innerHTML = ''; // Clear previous list
            const sortedWords = Object.entries(fillerWords).sort(([, a], [, b]) => b - a);

            if (sortedWords.length === 0) {
                 fillerWordListUl.innerHTML = '<li>No filler words detected. Great job!</li>';
                 totalFillersStrong.textContent = 0;
                 return;
            }

             totalFillersStrong.textContent = Object.values(fillerWords).reduce((sum, count) => sum + count, 0);

            sortedWords.forEach(([word, count]) => {
                const li = document.createElement('li');
                li.textContent = word;
                const span = document.createElement('span');
                span.classList.add('count');
                span.textContent = count;
                li.appendChild(span);
                li.dataset.word = word; // Store the word for highlighting
                li.setAttribute('role', 'button'); // Indicate it's clickable
                li.setAttribute('tabindex', '0'); // Make it focusable
                li.setAttribute('aria-label', `Highlight "${word}" in script`);
                fillerWordListUl.appendChild(li);
            });
        }

        fillerWordListUl.addEventListener('click', (event) => {
            const targetLi = event.target.closest('li');
            if (targetLi && targetLi.dataset.word) {
                const wordToHighlight = targetLi.dataset.word;
                highlightWordInScript(wordToHighlight);
            }
        });

         fillerWordListUl.addEventListener('keydown', (event) => {
             const targetLi = event.target.closest('li');
             if (targetLi && targetLi.dataset.word && (event.key === 'Enter' || event.key === ' ')) {
                 event.preventDefault();
                 const wordToHighlight = targetLi.dataset.word;
                 highlightWordInScript(wordToHighlight);
             }
         });


        function highlightWordInScript(word) {
            const scriptContent = scriptTextarea.value;
            // Simple highlighting simulation: select the first occurrence
            const regex = new RegExp(`\\b${word}\\b`, 'gi');
            const match = regex.exec(scriptContent);

            if (match) {
                scriptTextarea.focus();
                scriptTextarea.setSelectionRange(match.index, match.index + match[0].length);
            }
             // In a real app, you might replace text with styled spans in a contenteditable div
             // for visual highlighting without losing textarea functionality.
        }

        // --- Chart Rendering ---
        let paceChart = null;
        let pausesChart = null;

        function renderPaceChart(labels, data) {
            if (paceChart) {
                paceChart.destroy(); // Destroy previous chart instance
            }
            const ctx = document.getElementById('pace-chart').getContext('2d');
            const chartConfig = {
                type: document.getElementById('pace-chart-type').value, // Use selected type
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'WPM over time',
                        data: data,
                        borderColor: document.getElementById('pace-line-color').value,
                        backgroundColor: document.getElementById('pace-line-color').value.replace('rgb(', 'rgba(').replace(')', ', 0.2)'),
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: { display: true, text: 'WPM' }
                        },
                        x: {
                             title: { display: true, text: 'Time (s)' }
                        }
                    },
                     onClick: (e, elements) => {
                         const controls = document.getElementById('pace-chart-controls');
                         // Hide all other floating controls first
                         document.querySelectorAll('.floating-controls').forEach(c => {
                             if (c !== controls) c.classList.remove('active');
                         });
                         controls.classList.toggle('active');
                     }
                }
            };
            paceChart = new Chart(ctx, chartConfig);

             // Add event listeners for floating controls
            document.getElementById('pace-chart-type').onchange = (e) => updateChartType(paceChart, e.target.value);
            document.getElementById('pace-line-color').onchange = (e) => updateChartColor(paceChart, e.target.value);
        }

        function renderPausesChart(durations) {
             if (pausesChart) {
                pausesChart.destroy(); // Destroy previous chart instance
            }
            const ctx = document.getElementById('pauses-chart').getContext('2d');
            const chartConfig = {
                type: document.getElementById('pauses-chart-type').value, // Use selected type
                data: {
                    labels: durations.map((_, i) => `Pause ${i + 1}`),
                    datasets: [{
                        label: 'Duration (s)',
                        data: durations,
                        backgroundColor: document.getElementById('pauses-bar-color').value,
                        borderColor: "var(--secondary-dark)", // Use CSS variable correctly
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        title: { display: false },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: 'Duration (s)' }
                        },
                        x: {
                             title: { display: true, text: 'Pause Instance' }
                        }
                    },
                     onClick: (e, elements) => {
                         const controls = document.getElementById('pauses-chart-controls');
                         // Hide all other floating controls first
                         document.querySelectorAll('.floating-controls').forEach(c => {
                             if (c !== controls) c.classList.remove('active');
                         });
                         controls.classList.toggle('active');
                     }
                }
            };
            pausesChart = new Chart(ctx, chartConfig);

             // Add event listeners for floating controls
            document.getElementById('pauses-chart-type').onchange = (e) => updateChartType(pausesChart, e.target.value);
            document.getElementById('pauses-bar-color').onchange = (e) => updateChartColor(pausesChart, e.target.value);
        }

        // --- Chart Control Functions ---
        function updateChartType(chart, type) {
            chart.config.type = type;
             if (type === 'line') {
                 // Ensure line-specific properties are set if switching to line
                 chart.config.data.datasets[0].tension = 0.1;
                 chart.config.data.datasets[0].fill = true;
             } else {
                 // Ensure bar-specific properties are set if switching to bar
                  chart.config.data.datasets[0].tension = undefined;
                  chart.config.data.datasets[0].fill = false;
             }
            chart.update();
        }

        function updateChartColor(chart, color) {
             if (chart.config.type === 'line') {
                 chart.config.data.datasets[0].borderColor = color;
                 chart.config.data.datasets[0].backgroundColor = color.replace('rgb(', 'rgba(').replace(')', ', 0.2)'); // Simple alpha change
             } else if (chart.config.type === 'bar') {
                 chart.config.data.datasets[0].backgroundColor = color;
             }
             chart.update();
        }

        // Close floating controls when clicking outside charts or controls
        document.addEventListener('click', (e) => {
            document.querySelectorAll('.floating-controls').forEach(controls => {
                const chartContainer = controls.closest('.chart-container');
                 if (!e.target.closest('.floating-controls') && !e.target.closest('.chart-container')) {
                     controls.classList.remove('active');
                 }
            });
        });


        // --- Learn Area Card Interaction (Simulated Detail View) ---
        const learningContent = {
            pace: {
                title: "Mastering Pace",
                content: "<p>Your speaking pace significantly impacts how your audience receives your message. Too fast, and you might sound nervous or hard to follow. Too slow, and you risk losing their attention.</p><h3>Finding Your Ideal Pace</h3><p>The average speaking rate is around 120-150 words per minute (WPM). However, the ideal pace depends on your audience, topic, and purpose. A complex technical talk might require a slower pace than a motivational speech.</p><h3>Varying Your Pace</h3><p>Don't maintain a single speed throughout your speech. Varying your pace can add emphasis, build suspense, and keep the audience engaged. Speed up for exciting parts and slow down for important points.</p><h3>Practice Tips:</h3><ul><li>Record yourself and analyze your WPM using the Practice tool.</li><li>Read your script aloud, focusing on varying your speed.</li><li>Practice with a metronome initially if needed, then transition to natural variation.</li></ul>"
            },
            pauses: {
                title: "Effective Pauses",
                content: "<p>Pauses are not empty spaces; they are powerful tools in public speaking. They allow your audience to process information, add drama, and give you a moment to breathe and collect your thoughts.</p><h3>Types of Pauses:</h3><ul><li><strong>Dramatic Pause:</strong> Used before or after a key statement to build anticipation or emphasize a point.</li><li><strong>Processing Pause:</strong> Gives the audience time to absorb complex information.</li><li><strong>Transitional Pause:</strong> Signals a shift to a new topic or section.</li><li><strong>Breath Pause:</strong> A natural pause to inhale, essential for voice control.</li></ul><h3>Using Pauses Effectively:</h3><p>Avoid filling pauses with 'um' or 'uh'. Embrace the silence. Practice holding pauses for different durations to see their effect. A well-timed pause can be more impactful than any word.</p><h3>Practice Tips:</h3><ul><li>Identify points in your script where pauses would be effective.</li><li>Practice holding pauses for intentional counts (e.g., 'one-thousand-one').</li><li>Listen to experienced speakers and notice how they use pauses.</li></ul>"
            },
            fillers: {
                title: "Eliminating Filler Words",
                content: "<p>Filler words like 'um', 'uh', 'like', 'you know', 'so', and 'basically' can undermine your credibility and distract your audience. They often appear when you're thinking or transitioning between ideas.</p><h3>Why We Use Fillers:</h3><p>Fillers are often a habit or a way to signal that you haven't finished speaking yet. Nervousness can also increase their frequency.</p><h3>Strategies to Reduce Fillers:</h3><ul><li><strong>Awareness:</strong> The first step is identifying your common fillers. Use the Analysis tool!</li><li><strong>Pause Instead:</strong> Replace fillers with intentional pauses. It feels awkward at first, but sounds much better.</li><li><strong>Slow Down:</strong> Speaking slower gives you more time to think and formulate your next sentence without needing a filler.</li><li><strong>Structure Your Speech:</strong> A clear structure helps you move smoothly from one point to the next, reducing the need for transition fillers.</li><li><strong>Practice:</strong> Rehearse your speech focusing specifically on eliminating fillers.</li></ul><h3>Practice Tips:</h3><ul><li>Record yourself and count your fillers. Challenge yourself to reduce the count each time.</li><li>Ask a friend to signal you when you use a filler word.</li><li>Practice speaking extemporaneously on simple topics, focusing on smooth transitions without fillers.</li></ul>"
            },
            structure: {
                title: "Structuring Your Speech",
                content: "<p>A well-structured speech is easy for the audience to follow and remember. A common and effective structure is the 'Tell 'em what you're gonna tell 'em, tell 'em, then tell 'em what you told 'em' model.</p><h3>Key Components:</h3><ul><li><strong>Introduction:</strong> Grab attention, state your purpose, and preview your main points.</li><li><strong>Body:</strong> Develop your main points with supporting evidence, stories, or examples. Each point should ideally have its own section or paragraph.</li><li><strong>Conclusion:</strong> Summarize your main points, restate your purpose, and end with a memorable closing statement or call to action.</li></ul><h3>Tips for Structure:</h3><ul><li>Use transitions between points to guide your audience.</li><li>Limit the number of main points (usually 2-4 is ideal for shorter speeches).</li><li>Ensure a logical flow between ideas.</li></ul><h3>Practice Tips:</h3><ul><li>Outline your speech before writing the full script.</li><li>Practice delivering just the introduction and conclusion.</li><li>Time each section of your speech during practice.</li></ul>"
            },
            body_language: {
                title: "Effective Body Language",
                content: "<p>Your body language communicates as much, if not more, than your words. Posture, gestures, eye contact, and facial expressions can enhance your message and connect with your audience.</p><h3>Key Elements:</h3><ul><li><strong>Posture:</strong> Stand tall and confident. Avoid slouching or fidgeting.</li><li><strong>Gestures:</strong> Use natural, purposeful gestures to emphasize points. Avoid distracting or repetitive movements.</li><li><strong>Eye Contact:</strong> Connect with individuals in your audience. Scan the room to engage everyone.</li><li><strong>Facial Expressions:</strong> Let your expressions match your message. Smile when appropriate, show sincerity when serious.</li><li><strong>Movement:</strong> Use movement intentionally to transition or engage different parts of the audience. Avoid pacing aimlessly.</li></ul><h3>Practice Tips:</h3><ul><li>Record yourself on video to see your body language.</li><li>Practice in front of a mirror.</li><li>Ask for feedback from others on your non-verbal communication.</li></ul>"
            },
            voice: {
                title: "Voice Modulation",
                content: "<p>The way you use your voice—your pitch, volume, tone, and rhythm—can dramatically affect audience engagement and understanding.</p><h3>Elements of Voice:</h3><ul><li><strong>Volume:</strong> Speak loudly enough to be heard, but vary volume for emphasis.</li><li><strong>Pitch:</strong> Avoid a monotone voice. Vary your pitch to convey emotion and highlight key words.</li><li><strong>Tone:</strong> Ensure your tone matches your message (e.g., enthusiastic, serious, calm).</li><li><strong>Rhythm/Cadence:</strong> The flow and timing of your speech. Varying rhythm keeps it interesting.</li><li><strong>Articulation:</strong> Speak clearly and pronounce your words distinctly.</li></ul><h3>Practice Tips:</h3><ul><li>Read aloud, focusing on exaggerating volume and pitch changes.</li><li>Practice tongue twisters to improve articulation.</li><li>Record your voice and listen back to identify areas for improvement.</li></ul>"
            }
        };


        function displayLearningDetail(topic) {
             const content = learningContent[topic];
             learningDetail.classList.remove('active'); // Hide current detail before showing new one
             // Use a small timeout to allow transition before changing content
             setTimeout(() => {
                 if (content) {
                     learningDetail.innerHTML = `<h3>${content.title}</h3>${content.content}`;
                 } else {
                     learningDetail.innerHTML = `<h3>Content for "${topic}" not found.</h3>`;
                 }
                 learningDetail.classList.add('active');
             }, 200); // Match this with the CSS transition duration if needed
        }

        learningCards.forEach(card => {
            card.addEventListener('click', () => {
                const topic = card.dataset.topic;
                displayLearningDetail(topic);
            });

             // Add keyboard support for learning cards
             card.setAttribute('tabindex', '0');
             card.addEventListener('keydown', (event) => {
                 if (event.key === 'Enter' || event.key === ' ') {
                     event.preventDefault();
                     card.click(); // Trigger the click handler
                 }
             });
        });


        // --- Initial State ---
        stopBtn.disabled = true;
        playBtn.disabled = true;
        analyzeBtn.disabled = true;
        updateAnalysisResultsDisplay(false); // Hide analysis results initially

        // Enable analyze button if script is not empty OR audio has been recorded
        function updateAnalyzeButtonState() {
             analyzeBtn.disabled = scriptTextarea.value.trim().length === 0 && audioBlob === null;
        }

        scriptTextarea.addEventListener('input', updateAnalyzeButtonState);
        // Call on stop recording as well
        stopBtn.addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                stopTimer();
                recordBtn.disabled = false;
                stopBtn.disabled = true;
                updateAnalyzeButtonState(); // Re-evaluate analyze button state
            }
        });

        // Initial check
        updateAnalyzeButtonState();


    </script>
</body>
</html>
