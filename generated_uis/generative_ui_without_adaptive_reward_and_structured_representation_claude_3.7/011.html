<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Market Research Guide</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        :root {
            --primary-color: #007bff;
            --primary-dark: #0056b3;
            --secondary-color: #6c757d;
            --secondary-dark: #5a6268;
            --background-color: #f8f9fa;
            --card-background: #ffffff;
            --text-color: #343a40;
            --border-color: #dee2e6;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --spacing-unit: 1rem; /* 16px */
            --border-radius: 8px;
            --box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            --transition-speed: 0.3s;
             /* CSS variable for progress bar width/height */
            --progress-percentage: 0%;
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--background-color);
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: calc(var(--spacing-unit) * 2) 0;
            overflow-x: hidden; /* Prevent horizontal scroll during transitions */
        }

        .container {
            width: 95%;
            max-width: 1200px;
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.1);
            padding: calc(var(--spacing-unit) * 3);
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing-unit) * 2);
            position: relative; /* Needed for transitions */
        }

        h1, h2, h3 {
            color: var(--primary-dark);
            margin-bottom: var(--spacing-unit);
            font-weight: 600;
        }

        h1 {
            font-size: 2.8rem;
            text-align: center;
            margin-bottom: calc(var(--spacing-unit) * 2);
        }

        h2 {
            font-size: 2rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: calc(var(--spacing-unit) * 0.75);
            margin-top: var(--spacing-unit);
        }

        h3 {
            font-size: 1.6rem;
            margin-top: var(--spacing-unit);
            margin-bottom: calc(var(--spacing-unit) * 0.75);
            color: var(--text-color);
        }

        p {
            margin-bottom: var(--spacing-unit);
        }

        .step-indicator {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: calc(var(--spacing-unit) * 3);
            position: relative;
            padding: 0 var(--spacing-unit); /* Add padding for circles at ends */
        }

        .step-indicator::before {
            content: '';
            position: absolute;
            top: 50%;
            left: var(--spacing-unit);
            right: var(--spacing-unit);
            height: 6px; /* Thicker line */
            background-color: var(--border-color);
            transform: translateY(-50%);
            z-index: 1;
            border-radius: 3px;
        }

        .step-indicator::after {
             content: '';
             position: absolute;
             top: 50%;
             left: var(--spacing-unit);
             width: var(--progress-percentage); /* Use CSS variable for progress */
             height: 6px;
             background-color: var(--primary-color);
             transform: translateY(-50%);
             z-index: 1;
             border-radius: 3px;
             transition: width var(--transition-speed) ease-in-out;
        }


        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
            z-index: 2;
            cursor: pointer;
            transition: color var(--transition-speed) ease;
            user-select: none;
            outline: none; /* Handled by focus-visible */
        }

         .step:focus-visible {
             outline: 2px solid var(--primary-color);
             outline-offset: 3px;
             border-radius: var(--border-radius);
         }

        .step-circle {
            width: 40px; /* Larger circle */
            height: 40px; /* Larger circle */
            border-radius: 50%;
            background-color: var(--secondary-color);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: calc(var(--spacing-unit) * 0.75);
            transition: background-color var(--transition-speed) ease, border-color var(--transition-speed) ease, transform 0.1s ease;
            border: 4px solid var(--border-color); /* Thicker border */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

         .step:hover .step-circle {
             transform: scale(1.05);
         }

        .step-name {
            font-size: 1rem; /* Slightly larger font */
            text-align: center;
            color: var(--secondary-color);
            transition: color var(--transition-speed) ease;
            font-weight: 400;
        }

        .step.active .step-circle {
            background-color: var(--primary-color);
            border-color: var(--primary-dark);
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
        }

        .step.active .step-name {
            color: var(--primary-dark);
            font-weight: 600;
        }

        .step.completed .step-circle {
            background-color: var(--success-color);
            border-color: var(--success-color);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }

        .step.completed .step-name {
            color: var(--success-color);
            font-weight: 600;
        }

        /* Step Content Transitions */
        #stepContent {
            position: relative; /* Parent for absolute positioning */
            min-height: 500px; /* Prevent container collapse */
            /* Add transition for height if content size changes significantly */
            transition: min-height var(--transition-speed) ease;
        }

        .step-content {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-speed) ease, transform var(--transition-speed) ease;
            transform: translateX(20px); /* Slide in from right */
            z-index: 0; /* Ensure inactive steps are behind */
            padding-top: 10px; /* Add some padding */
        }

        .step-content.active {
            position: static; /* Take up space when active */
            opacity: 1;
            visibility: visible;
            transform: translateX(0);
            z-index: 1; /* Bring active step to front */
        }

         /* Transition direction handling */
         #stepContent.backward .step-content.active {
             transform: translateX(0); /* Slide in from left */
         }
          #stepContent.backward .step-content:not(.active) {
             transform: translateX(20px); /* Slide out to right */
         }
         #stepContent.forward .step-content.active {
             transform: translateX(0); /* Slide in from right */
         }
          #stepContent.forward .step-content:not(.active) {
             transform: translateX(-20px); /* Slide out to left */
         }


        .form-group {
            margin-bottom: calc(var(--spacing-unit) * 1.5); /* Increased spacing */
        }

        label {
            display: block;
            margin-bottom: calc(var(--spacing-unit) * 0.5); /* Increased spacing */
            font-weight: 600;
            font-size: 1.1rem;
            color: var(--text-color);
        }

        input[type="text"],
        input[type="number"],
        textarea,
        select {
            width: 100%;
            padding: calc(var(--spacing-unit) * 0.75); /* Increased padding */
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
            background-color: var(--background-color); /* Subtle background */
        }

        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus,
        select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            outline: none;
            background-color: var(--card-background); /* White background on focus */
        }

        textarea {
            min-height: 150px; /* Increased height */
            resize: vertical;
        }

        .validation-error {
            border-color: var(--danger-color) !important;
             box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
        }

        .error-message {
            color: var(--danger-color);
            font-size: 0.9rem;
            margin-top: calc(var(--spacing-unit) * 0.25);
            display: none; /* Hidden by default */
        }

        .method-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); /* Larger min width */
            gap: var(--spacing-unit);
            margin-top: var(--spacing-unit);
        }

        .method-card {
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: calc(var(--spacing-unit) * 1.5); /* Increased padding */
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.2s ease, background-color 0.2s ease;
            user-select: none;
            outline: none;
        }

        .method-card:hover {
            transform: translateY(-5px); /* More pronounced hover */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

         .method-card:focus-visible {
             outline: 2px solid var(--primary-color);
             outline-offset: 3px;
         }


        .method-card.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
            background-color: rgba(0, 123, 255, 0.08); /* More visible selection */
        }

        .method-card h4 {
            margin-top: 0;
            margin-bottom: calc(var(--spacing-unit) * 0.75); /* Increased spacing */
            font-size: 1.3rem; /* Larger font */
            color: var(--primary-dark);
        }

        .method-card p {
            font-size: 1rem; /* Larger font */
            color: var(--secondary-dark);
            margin-bottom: 0;
        }

        .placeholder-area {
            border: 2px dashed var(--border-color); /* Dashed border for placeholders */
            border-radius: var(--border-radius);
            padding: calc(var(--spacing-unit) * 2);
            margin-top: var(--spacing-unit);
            background-color: var(--background-color);
            text-align: center;
            color: var(--secondary-dark);
            font-style: italic;
            min-height: 200px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: var(--spacing-unit);
            position: relative; /* For disabled overlay */
        }

         .placeholder-area::after {
             content: 'Coming Soon';
             position: absolute;
             top: 0;
             left: 0;
             right: 0;
             bottom: 0;
             background: rgba(255, 255, 255, 0.7);
             display: flex;
             justify-content: center;
             align-items: center;
             font-size: 1.5rem;
             font-weight: bold;
             color: var(--primary-dark);
             border-radius: var(--border-radius);
             pointer-events: none; /* Allow clicks on elements underneath */
             z-index: 5;
         }

         .placeholder-area button:disabled {
             /* Override default disabled styling for buttons inside placeholder */
             opacity: 1;
             cursor: default;
             box-shadow: none;
         }

         .data-table-controls {
             display: flex;
             gap: var(--spacing-unit);
             margin-bottom: var(--spacing-unit);
             flex-wrap: wrap;
         }

         .data-table-controls .form-group {
             flex: 1 1 200px; /* Allow wrapping */
             margin-bottom: 0; /* Remove bottom margin */
             text-align: left;
         }

         .data-table-controls label {
             font-size: 0.9rem;
             margin-bottom: calc(var(--spacing-unit) * 0.25);
             font-weight: 400;
         }


         .data-upload-area {
             cursor: pointer;
             transition: background-color 0.2s ease, border-color 0.2s ease;
             position: relative; /* Needed for ::after overlay */
         }

         .data-upload-area:hover {
             background-color: #e9ecef;
             border-color: var(--primary-color);
         }

         .data-upload-area input[type="file"] {
             display: none;
         }

         .data-upload-area .upload-icon {
             font-size: 3rem;
             color: var(--primary-color);
         }

         .data-upload-area strong {
             color: var(--text-color);
         }


        .chart-container {
            position: relative;
            height: 400px; /* Increased height for chart */
            margin-top: var(--spacing-unit);
            background-color: var(--background-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-unit);
            box-shadow: var(--box-shadow);
            cursor: pointer;
            transition: box-shadow 0.2s ease;
            display: block; /* Ensure it's block for layout */
        }

         .chart-container:hover {
             box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
         }

        .floating-controls {
            position: absolute;
            top: calc(var(--spacing-unit) * 1.5);
            right: calc(var(--spacing-unit) * 1.5);
            background: rgba(255, 255, 255, 0.98); /* More opaque background */
            padding: var(--spacing-unit);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            opacity: 0;
            transform: translateY(-10px);
            transition: all var(--transition-speed) ease;
            pointer-events: none;
            z-index: 10;
            min-width: 250px; /* Wider panel */
            border: 1px solid var(--border-color);
        }

        .floating-controls.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        .control-group {
            margin-bottom: calc(var(--spacing-unit) * 1); /* Increased spacing */
        }

        .control-group label {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: calc(var(--spacing-unit) * 0.25);
        }

        .control-group input[type="color"],
        .control-group input[type="number"],
        .control-group select,
        .control-group input[type="text"] {
             padding: calc(var(--spacing-unit) * 0.4); /* Adjusted padding */
             font-size: 0.9rem;
             background-color: var(--card-background);
             border-radius: 4px;
             border: 1px solid var(--border-color);
        }
         .control-group input[type="text"] {
             width: calc(100% - 10px); /* Adjust for padding */
         }

        .control-group input[type="color"] {
             height: 35px; /* Ensure consistent height */
             padding: 4px;
        }

        .control-group button {
             width: 100%;
             font-size: 1rem;
             padding: calc(var(--spacing-unit) * 0.5);
        }


        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: calc(var(--spacing-unit) * 3); /* Increased spacing */
            padding-top: var(--spacing-unit);
            border-top: 1px solid var(--border-color);
            align-items: center;
        }

        .navigation-buttons .save-button {
             margin-left: var(--spacing-unit);
             margin-right: auto; /* Push save button to the left */
        }


        button {
            padding: calc(var(--spacing-unit) * 0.8) calc(var(--spacing-unit) * 2); /* Increased padding */
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1.1rem; /* Larger font */
            font-weight: 600;
            transition: background-color 0.2s ease, opacity 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            user-select: none;
            outline: none;
        }

         button:focus-visible {
             outline: 2px solid var(--primary-color);
             outline-offset: 3px;
         }

        button.primary {
            background-color: var(--primary-color);
            color: white;
        }

        button.primary:hover:not(:disabled) {
            background-color: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
        }

        button.secondary {
            background-color: var(--secondary-color);
            color: white;
        }

        button.secondary:hover:not(:disabled) {
            background-color: var(--secondary-dark);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3);
        }

        button:active:not(:disabled) {
             transform: translateY(0);
             box-shadow: none;
        }

        button:disabled {
            opacity: 0.5; /* Reduced opacity */
            cursor: not-allowed;
            box-shadow: none;
        }

        .help-text {
            background-color: #e9f7fe; /* Light blue */
            border-left: 5px solid #007bff; /* Primary blue border */
            padding: var(--spacing-unit);
            margin-top: calc(var(--spacing-unit) * 1.5); /* Increased spacing */
            border-radius: var(--border-radius);
            color: #004085; /* Dark blue text */
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .help-text h4 {
            margin-top: 0;
            color: #004085;
            margin-bottom: calc(var(--spacing-unit) * 0.5);
            font-size: 1.1rem;
        }

         /* Loading Indicator Placeholder */
         .loading-indicator {
             display: none; /* Hidden by default */
             text-align: center;
             margin-top: var(--spacing-unit);
             font-size: 1.2rem;
             color: var(--primary-color);
         }

         .loading-indicator.active {
             display: block;
         }

         .spinner {
             border: 4px solid rgba(0, 123, 255, 0.1);
             border-top: 4px solid var(--primary-color);
             border-radius: 50%;
             width: 24px;
             height: 24px;
             animation: spin 1s linear infinite;
             display: inline-block;
             margin-right: var(--spacing-unit);
             vertical-align: middle;
         }

         @keyframes spin {
             0% { transform: rotate(0deg); }
             100% { transform: rotate(360deg); }
         }


        @media (max-width: 992px) {
            .container {
                padding: calc(var(--spacing-unit) * 2);
            }
            h1 {
                font-size: 2.2rem;
            }
             h2 {
                 font-size: 1.8rem;
             }
             h3 {
                 font-size: 1.4rem;
             }
             .floating-controls {
                 min-width: 200px;
             }
        }

        @media (max-width: 768px) {
            .step-indicator {
                flex-direction: column;
                align-items: flex-start;
                padding: var(--spacing-unit) 0;
            }
            .step-indicator::before {
                width: 6px; /* Thicker vertical line */
                height: calc(100% - 40px); /* Adjust height */
                top: 20px; /* Start below circle center */
                bottom: 20px; /* End above circle center */
                left: 19px; /* Align with circle center */
                right: auto;
                transform: none;
            }
             .step-indicator::after {
                 width: 6px; /* Thicker vertical line */
                 height: var(--progress-percentage); /* Progress fill */
                 top: 20px; /* Start below circle center */
                 bottom: auto;
                 left: 19px; /* Align with circle center */
                 right: auto;
                 transform: none;
                 transition: height var(--transition-speed) ease-in-out;
             }
            .step {
                flex-direction: row;
                align-items: center;
                justify-content: flex-start;
                margin-bottom: calc(var(--spacing-unit) * 1.5); /* Increased spacing */
                padding-left: calc(var(--spacing-unit) * 3); /* Space for vertical line */
                flex: none; /* Don't grow */
                width: 100%;
            }
            .step-circle {
                margin-bottom: 0;
                margin-right: var(--spacing-unit);
            }
            .step-name {
                text-align: left;
                font-size: 1rem;
            }
             .step.active .step-circle {
                 border-color: var(--primary-dark); /* Keep border color */
             }
             .step.completed .step-circle {
                 border-color: var(--success-color); /* Keep border color */
             }

            .container {
                padding: var(--spacing-unit);
            }
            h1 {
                font-size: 1.8rem;
            }
            h2 {
                font-size: 1.4rem;
            }
            h3 {
                font-size: 1.2rem;
            }
            .method-cards {
                 grid-template-columns: 1fr;
            }
             #stepContent {
                 min-height: 600px; /* Adjust min-height for smaller screens */
             }
             .step-content {
                 padding-top: 0; /* Remove extra padding */
             }
             .navigation-buttons {
                 flex-direction: column-reverse;
                 gap: var(--spacing-unit);
             }
             .navigation-buttons button {
                 width: 100%;
                 text-align: center;
             }
             .navigation-buttons .save-button {
                 margin-left: 0;
                 margin-right: 0;
                 order: 1; /* Place save button below nav buttons on mobile */
             }
             .navigation-buttons #prevBtn {
                 order: 3; /* Place prev button below next */
             }
             .navigation-buttons #nextBtn {
                 order: 2; /* Place next button second */
             }

             .floating-controls {
                 min-width: auto;
                 width: 90%;
                 left: 5%;
                 right: 5%;
                 top: var(--spacing-unit);
             }

             .data-table-controls {
                 flex-direction: column;
             }
             .data-table-controls .form-group {
                 flex: none;
                 width: 100%;
             }
        }
    </style>
</head>
<body>

    <div class="container">
        <h1>Market Research Guide</h1>

        <div class="step-indicator" id="stepIndicator">
            <div class="step" data-step="0" aria-current="step" tabindex="0" role="button">
                <div class="step-circle">1</div>
                <div class="step-name">Objectives</div>
            </div>
            <div class="step" data-step="1" tabindex="0" role="button">
                <div class="step-circle">2</div>
                <div class="step-name">Audience</div>
            </div>
            <div class="step" data-step="2" tabindex="0" role="button">
                <div class="step-circle">3</div>
                <div class="step-name">Methods</div>
            </div>
            <div class="step" data-step="3" tabindex="0" role="button">
                <div class="step-circle">4</div>
                <div class="step-name">Tools</div>
            </div>
            <div class="step" data-step="4" tabindex="0" role="button">
                <div class="step-circle">5</div>
                <div class="step-name">Collect Data</div>
            </div>
            <div class="step" data-step="5" tabindex="0" role="button">
                <div class="step-circle">6</div>
                <div class="step-name">Analyze Data</div>
            </div>
            <div class="step" data-step="6" tabindex="0" role="button">
                <div class="step-circle">7</div>
                <div class="step-name">Report</div>
            </div>
        </div>

        <div id="stepContent" role="region" aria-live="polite">
            <!-- Step 1: Define Objectives -->
            <section class="step-content" data-step="0" aria-hidden="false">
                <h2>Step 1: Define Your Objectives</h2>
                <p>Clearly define what you want to achieve with your market research. What questions do you need answered? What decisions will the research inform?</p>
                <div class="form-group">
                    <label for="researchObjective">What is your primary research objective? <span class="error-message" id="researchObjectiveError">This field is required.</span></label>
                    <textarea id="researchObjective" name="researchObjective" placeholder="e.g., Understand customer satisfaction levels, Identify market demand for a new product, Evaluate brand perception" required aria-required="true" aria-invalid="false"></textarea>
                </div>
                 <div class="form-group">
                    <label for="keyQuestions">List the key questions your research should answer: <span class="error-message" id="keyQuestionsError">This field is required.</span></label>
                    <textarea id="keyQuestions" name="keyQuestions" placeholder="e.g., How satisfied are customers with feature X? What price are potential customers willing to pay? How does our brand compare to competitors?" required aria-required="true" aria-invalid="false"></textarea>
                </div>
                 <div class="form-group">
                    <label for="researchGoal">How will the research findings be used? <span class="error-message" id="researchGoalError">This field is required.</span></label>
                    <textarea id="researchGoal" name="researchGoal" placeholder="e.g., Inform product development decisions, Guide marketing campaign strategy, Justify investment in a new market" required aria-required="true" aria-invalid="false"></textarea>
                </div>
                 <div class="help-text">
                    <h4>Tip: Make Objectives SMART</h4>
                    <p>Ensure your objectives are Specific, Measurable, Achievable, Relevant, and Time-bound.</p>
                 </div>
            </section>

            <!-- Step 2: Identify Your Target Audience -->
            <section class="step-content" data-step="1" aria-hidden="true">
                <h2>Step 2: Identify Your Target Audience</h2>
                <p>Who are you trying to learn about? Define their demographics, psychographics, behavior, and needs. This will determine who you need to collect data from.</p>
                <div class="form-group">
                    <label for="audienceDemographics">Describe the key demographics of your target audience: <span class="error-message" id="audienceDemographicsError">This field is required.</span></label>
                    <textarea id="audienceDemographics" name="audienceDemographics" placeholder="e.g., Age range, Gender, Location, Income level, Occupation" required aria-required="true" aria-invalid="false"></textarea>
                </div>
                <div class="form-group">
                    <label for="audiencePsychographics">Describe the key psychographics (interests, values, lifestyle) of your target audience:</label>
                    <textarea id="audiencePsychographics" name="audiencePsychographics" placeholder="e.g., Hobbies, Attitudes towards technology, Environmental concerns, Purchasing motivations"></textarea>
                </div>
                 <div class="form-group">
                    <label for="audienceBehavior">Describe the relevant behaviors of your target audience:</label>
                    <textarea id="audienceBehavior" name="audienceBehavior" placeholder="e.g., Online shopping habits, Usage of specific products/services, Media consumption"></textarea>
                </div>
                 <div class="help-text">
                    <h4>Tip: Create Personas</h4>
                    <p>Developing detailed buyer personas can help you visualize and understand your target audience better.</p>
                 </div>
            </section>

            <!-- Step 3: Choose Your Research Methods -->
            <section class="step-content" data-step="2" aria-hidden="true">
                <h2>Step 3: Choose Your Research Methods</h2>
                <p>Select the best approach to gather the information you need. Common methods include surveys, interviews, focus groups, observation, and secondary research.</p>
                 <p>Select one or more methods:</p>
                <div class="method-cards">
                    <div class="method-card" data-method="survey" tabindex="0" role="checkbox" aria-checked="false">
                        <h4>Surveys</h4>
                        <p>Gather quantitative and qualitative data from a large sample.</p>
                    </div>
                     <div class="method-card" data-method="interview" tabindex="0" role="checkbox" aria-checked="false">
                        <h4>Interviews</h4>
                        <p>In-depth qualitative insights from individuals.</p>
                    </div>
                     <div class="method-card" data-method="focus-group" tabindex="0" role="checkbox" aria-checked="false">
                        <h4>Focus Groups</h4>
                        <p>Qualitative insights from group discussions.</p>
                    </div>
                     <div class="method-card" data-method="observation" tabindex="0" role="checkbox" aria-checked="false">
                        <h4>Observation</h4>
                        <p>Study behavior in natural settings.</p>
                    </div>
                     <div class="method-card" data-method="secondary-research" tabindex="0" role="checkbox" aria-checked="false">
                        <h4>Secondary Research</h4>
                        <p>Analyze existing data (reports, statistics).</p>
                    </div>
                </div>
                 <div class="help-text">
                    <h4>Tip: Mix Methods</h4>
                    <p>Combining quantitative (numbers) and qualitative (insights) methods often provides a more complete picture.</p>
                 </div>
            </section>

            <!-- Step 4: Develop Your Research Tools -->
            <section class="step-content" data-step="3" aria-hidden="true">
                <h2>Step 4: Develop Your Research Tools</h2>
                <p>Create the instruments needed to collect data based on your chosen methods, such as survey questionnaires, interview guides, or observation checklists.</p>
                 <h3>Survey Builder</h3>
                <div class="placeholder-area survey-builder-placeholder">
                    <span class="material-symbols-rounded" style="font-size: 3rem; color: var(--info-color);">edit_note</span>
                    <p>Interactive Survey/Questionnaire Builder Placeholder.</p>
                    <p>This section would allow you to add, edit, and arrange different question types (e.g., Multiple Choice, Open Text, Rating Scale).</p>
                    <button class="primary" disabled>Add Question</button>
                </div>
                 <h3>Interview Guide Outline</h3>
                 <div class="form-group">
                    <label for="interviewGuide">Outline key topics or questions for interviews:</label>
                    <textarea id="interviewGuide" name="interviewGuide" placeholder="e.g., Introduction, Background questions, Core topic questions, Wrap-up"></textarea>
                 </div>
                 <div class="help-text">
                    <h4>Tip: Pilot Test</h4>
                    <p>Always test your research tools with a small group before the main data collection to identify any issues.</p>
                 </div>
            </section>

            <!-- Step 5: Collect Data -->
            <section class="step-content" data-step="4" aria-hidden="true">
                <h2>Step 5: Collect Data</h2>
                <p>Execute your plan and gather data from your target audience using the tools you developed. Ensure ethical considerations and data privacy are maintained.</p>
                 <h3>Upload Your Data</h3>
                <div class="data-upload-area" id="dataUploadArea" tabindex="0" role="button" aria-label="Click or drag to upload data file">
                    <span class="material-symbols-rounded upload-icon">upload_file</span>
                    <p id="uploadText">Drag and drop your data file here or click to select.</p>
                    <p>(Supported formats: CSV, Excel, TXT)</p>
                    <input type="file" id="dataFileInput" accept=".csv, .xlsx, .xls, .txt">
                </div>
                 <div class="loading-indicator" id="uploadLoading" aria-hidden="true">
                     <span class="spinner"></span> Uploading...
                 </div>
                 <h3>Data Table Preview</h3>
                 <div class="placeholder-area data-table-placeholder">
                     <span class="material-symbols-rounded" style="font-size: 3rem; color: var(--secondary-color);">table_chart</span>
                     <h4>Uploaded Data Preview Placeholder</h4>
                     <p>This section would display a sortable and filterable table of your uploaded data.</p>
                     <div class="data-table-controls">
                         <div class="form-group">
                             <label for="filterTable">Filter:</label>
                             <input type="text" id="filterTable" placeholder="Type to filter..." disabled>
                         </div>
                          <div class="form-group">
                             <label for="sortColumn">Sort by:</label>
                             <select id="sortColumn" disabled>
                                 <option value="">-- Select Column --</option>
                                 <option value="header1">Header 1</option>
                                 <option value="header2">Header 2</option>
                             </select>
                         </div>
                     </div>
                     <table style="width:100%; border-collapse: collapse; margin-top: 1rem; opacity: 0.6; pointer-events: none;">
                         <thead>
                             <tr>
                                 <th style="border: 1px solid var(--border-color); padding: 10px; text-align: left; background-color: #e9ecef;">Header 1</th>
                                 <th style="border: 1px solid var(--border-color); padding: 10px; text-align: left; background-color: #e9ecef;">Header 2</th>
                                 <th style="border: 1px solid var(--border-color); padding: 10px; text-align: left; background-color: #e9ecef;">Header 3</th>
                             </tr>
                         </thead>
                         <tbody>
                             <tr>
                                 <td style="border: 1px solid var(--border-color); padding: 10px;">Sample Data A1</td>
                                 <td style="border: 1px solid var(--border-color); padding: 10px;">Sample Data A2</td>
                                 <td style="border: 1px solid var(--border-color); padding: 10px;">Sample Data A3</td>
                             </tr>
                              <tr>
                                 <td style="border: 1px solid var(--border-color); padding: 10px;">Sample Data B1</td>
                                 <td style="border: 1px solid var(--border-color); padding: 10px;">Sample Data B2</td>
                                 <td style="border: 1px solid var(--border-color); padding: 10px;">Sample Data B3</td>
                             </tr>
                         </tbody>
                     </table>
                 </div>
                 <div class="help-text">
                    <h4>Tip: Data Cleaning</h4>
                    <p>Before analysis, ensure your data is clean and free from errors or inconsistencies. This might involve handling missing values or standardizing formats.</p>
                 </div>
            </section>

            <!-- Step 6: Analyze Data -->
            <section class="step-content" data-step="5" aria-hidden="true">
                <h2>Step 6: Analyze Data</h2>
                <p>Process and analyze the collected data to find patterns, insights, and answers to your research questions. Use statistical analysis for quantitative data and thematic analysis for qualitative data.</p>
                 <h3>Data Visualization</h3>
                 <div class="chart-container" id="analysisChartContainer" tabindex="0" role="img" aria-label="Interactive chart displaying market research data. Click to access chart controls.">
                     <canvas id="analysisChart"></canvas>
                     <!-- Floating control panel -->
                    <div class="floating-controls" id="chartControls">
                        <h4>Chart Options</h4>
                         <div class="control-group">
                            <label for="chartDataColumnX">X-axis Data:</label>
                            <select id="chartDataColumnX" aria-controls="analysisChart" disabled>
                                <option value="">-- Select Column --</option>
                                 <option value="label">Sample Labels</option>
                            </select>
                         </div>
                          <div class="control-group">
                            <label for="chartDataColumnY">Y-axis Data:</label>
                            <select id="chartDataColumnY" aria-controls="analysisChart" disabled>
                                <option value="">-- Select Column --</option>
                                <option value="data">Sample Data</option>
                            </select>
                         </div>
                        <div class="control-group">
                            <label for="chartType">Chart Type:</label>
                            <select id="chartType" aria-controls="analysisChart">
                                <option value="bar">Bar</option>
                                <option value="line">Line</option>
                                <option value="pie">Pie</option>
                                <option value="doughnut">Doughnut</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label for="chartColor">Color:</label>
                            <input type="color" id="chartColor" value="#007bff" aria-controls="analysisChart">
                        </div>
                         <div class="control-group">
                            <label for="chartBorderColor">Border Color:</label>
                            <input type="color" id="chartBorderColor" value="#0056b3" aria-controls="analysisChart">
                        </div>
                         <div class="control-group">
                            <label for="chartFontSize">Font Size:</label>
                            <input type="number" id="chartFontSize" value="12" min="8" max="24" aria-controls="analysisChart">
                         </div>
                         <div class="control-group">
                             <label for="chartTitle">Chart Title:</label>
                             <input type="text" id="chartTitle" placeholder="e.g., Customer Satisfaction" aria-controls="analysisChart">
                         </div>
                          <div class="control-group">
                             <label for="chartFilter">Filter Data:</label>
                             <input type="text" id="chartFilter" placeholder="e.g., >10" aria-controls="analysisChart" disabled>
                         </div>
                         <div class="control-group">
                            <button class="secondary" id="exportChartBtn" disabled>Export Chart</button>
                         </div>
                    </div>
                 </div>
                 <div class="help-text">
                    <h4>Tip: Look for Trends</h4>
                    <p>Focus on identifying key trends, correlations, and significant findings that directly address your research objectives. Visualizations can help make complex data understandable.</p>
                 </div>
            </section>

            <!-- Step 7: Report Findings -->
            <section class="step-content" data-step="6" aria-hidden="true">
                <h2>Step 7: Report Findings</h2>
                <p>Compile your findings into a clear and concise report. Present the insights, conclusions, and recommendations based on your analysis. Share the report with stakeholders.</p>
                 <h3>Research Report Summary</h3>
                 <div class="placeholder-area report-area-placeholder">
                     <span class="material-symbols-rounded" style="font-size: 3rem; color: var(--success-color);">article</span>
                    <p>Structured Input Area for Report Summary Placeholder.</p>
                    <p>Use the sections below to draft your key findings and recommendations.</p>
                    <div class="form-group">
                        <label for="executiveSummary">Executive Summary:</label>
                        <textarea id="executiveSummary" name="executiveSummary" placeholder="Provide a brief overview of the research and key findings."></textarea>
                    </div>
                     <div class="form-group">
                        <label for="keyFindings">Key Findings:</label>
                        <textarea id="keyFindings" name="keyFindings" placeholder="Detail the most important insights from your analysis."></textarea>
                    </div>
                     <div class="form-group">
                        <label for="recommendations">Recommendations:</label>
                        <textarea id="recommendations" name="recommendations" placeholder="Based on the findings, what actions do you recommend?"></textarea>
                    </div>
                     <button class="primary" disabled>Generate Report</button>
                 </div>
                 <div class="help-text">
                    <h4>Tip: Visuals Help</h4>
                    <p>Include charts, graphs, and tables from your analysis to make the report more digestible and impactful. Tailor the report to your audience.</p>
                 </div>
            </section>
        </div>

        <div class="navigation-buttons">
            <button id="prevBtn" class="secondary" disabled aria-label="Go to previous step">Previous Step</button>
             <button id="saveBtn" class="secondary save-button" disabled aria-label="Save progress">Save Progress</button>
            <button id="nextBtn" class="primary" aria-label="Go to next step">Next Step</button>
        </div>
    </div>

    <script type="module">
        import { Chart } from "https://esm.sh/chart.js/auto";

        const steps = document.querySelectorAll('.step-content');
        const stepIndicator = document.querySelectorAll('.step-indicator .step');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const saveBtn = document.getElementById('saveBtn'); // Added save button
        const stepContentContainer = document.getElementById('stepContent'); // Container for positioning

        let currentStepIndex = 0;

        // Required fields for validation (Step 1)
        const requiredFieldsStep1 = [
            document.getElementById('researchObjective'),
            document.getElementById('keyQuestions'),
            document.getElementById('researchGoal')
        ].filter(el => el !== null); // Filter out null if element not found

         // Required fields for validation (Step 2)
        const requiredFieldsStep2 = [
            document.getElementById('audienceDemographics')
        ].filter(el => el !== null); // Filter out null if element not found

         // Required fields for validation (Step 5) - Placeholder for data upload
         // In a real app, you'd check if data was successfully uploaded/processed
         // const requiredFieldsStep5 = [ /* e.g., check if data is loaded */ ];


        // Chart setup (placeholder data)
        let analysisChart = null;
        const chartCanvas = document.getElementById('analysisChart');
        const chartCtx = chartCanvas?.getContext('2d'); // Use optional chaining
        const chartControls = document.getElementById('chartControls');
        const chartTypeSelect = document.getElementById('chartType');
        const chartColorInput = document.getElementById('chartColor');
        const chartBorderColorInput = document.getElementById('chartBorderColor');
        const chartFontSizeInput = document.getElementById('chartFontSize');
        const chartTitleInput = document.getElementById('chartTitle');
        const chartDataColumnXSelect = document.getElementById('chartDataColumnX'); // Added data column select
        const chartDataColumnYSelect = document.getElementById('chartDataColumnY'); // Added data column select
        const chartFilterInput = document.getElementById('chartFilter'); // Added filter input
        const chartContainer = document.getElementById('analysisChartContainer');

        const initialChartConfig = {
            type: 'bar',
            data: {
                labels: ['Very Satisfied', 'Satisfied', 'Neutral', 'Dissatisfied', 'Very Dissatisfied'],
                datasets: [{
                    label: 'Customer Satisfaction Levels',
                    data: [45, 30, 15, 7, 3], // Example data
                    backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
                    borderColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-dark').trim(),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            font: {
                                size: parseInt(chartFontSizeInput?.value || '12'),
                                family: '"Inter", sans-serif'
                            },
                            color: getComputedStyle(document.documentElement).getPropertyValue('--text-color').trim()
                        }
                    },
                    title: {
                        display: true,
                        text: 'Customer Satisfaction Levels',
                        font: {
                            size: parseInt(chartFontSizeInput?.value || '12') + 2,
                            family: '"Inter", sans-serif',
                            weight: '600'
                        },
                        color: getComputedStyle(document.documentElement).getPropertyValue('--primary-dark').trim()
                    },
                    tooltip: {
                        bodyFont: { family: '"Inter", sans-serif' },
                        titleFont: { family: '"Inter", sans-serif', weight: '600' }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            font: {
                                size: parseInt(chartFontSizeInput?.value || '12'),
                                family: '"Inter", sans-serif'
                            },
                            color: getComputedStyle(document.documentElement).getPropertyValue('--secondary-dark').trim()
                        },
                        grid: {
                            color: getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim()
                        }
                    },
                    x: {
                         ticks: {
                            font: {
                                size: parseInt(chartFontSizeInput?.value || '12'),
                                family: '"Inter", sans-serif'
                            },
                            color: getComputedStyle(document.documentElement).getPropertyValue('--secondary-dark').trim()
                        },
                        grid: {
                             color: getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim()
                         }
                    }
                },
                 onClick: (e) => toggleChartControls(e),
            }
        };

        function updateStepIndicator() {
            stepIndicator.forEach((step, i) => {
                step.classList.remove('active', 'completed');
                step.setAttribute('aria-current', 'false');
                 step.setAttribute('aria-disabled', 'false'); // Enable clicks by default
                if (i < currentStepIndex) {
                     step.classList.add('completed');
                } else if (i === currentStepIndex) {
                     step.classList.add('active');
                     step.setAttribute('aria-current', 'step');
                }
            });

             // Update progress bar width/height using CSS variable
             const totalSteps = steps.length;
             // Calculate progress based on completed steps + current step percentage
             // For a 7-step process (0-6), progress at step i is i / (totalSteps - 1)
             const progress = (currentStepIndex / (totalSteps - 1)) * 100;
             document.documentElement.style.setProperty('--progress-percentage', progress + '%');
        }

        function showStep(index, direction = 'forward') {
            if (index < 0 || index >= steps.length) return;

            // Optional: Validate current step before moving next
            if (index > currentStepIndex && !validateStep(currentStepIndex)) {
                 console.warn(`Validation failed for step ${currentStepIndex}`);
                 // Find the first invalid field and focus it
                 let firstInvalidField = null;
                 if (currentStepIndex === 0) {
                     firstInvalidField = requiredFieldsStep1.find(field => !field.value.trim());
                 } else if (currentStepIndex === 1) {
                     firstInvalidField = requiredFieldsStep2.find(field => !field.value.trim());
                 }
                 // Add checks for other steps if they have required fields
                 // else if (currentStepIndex === 4) { ... }

                 if (firstInvalidField) {
                     firstInvalidField.focus();
                 }
                 return; // Prevent moving forward if validation fails
            }

            // Add class for transition direction
             stepContentContainer.classList.remove('forward', 'backward');
             stepContentContainer.classList.add(direction);


            steps.forEach((step, i) => {
                 step.classList.remove('active');
                 if (i === index) {
                     step.classList.add('active');
                     // Ensure the step takes up space before transition starts
                     step.style.position = 'static';
                     step.style.opacity = 1;
                     step.style.visibility = 'visible';
                     step.style.transform = 'translateX(0)'; // Slide in to final position
                     step.setAttribute('aria-hidden', 'false');
                 } else {
                      // Ensure other steps are correctly hidden and positioned off-screen
                     step.style.position = 'absolute'; // Use absolute positioning when inactive
                     step.style.transform = direction === 'forward' ? 'translateX(-20px)' : 'translateX(20px)';
                     step.style.opacity = 0;
                     step.style.visibility = 'hidden';
                     step.setAttribute('aria-hidden', 'true');
                 }
            });

            currentStepIndex = index;
            updateStepIndicator();

            prevBtn.disabled = currentStepIndex === 0;
            nextBtn.disabled = currentStepIndex === steps.length - 1;
            saveBtn.disabled = false; // Enable save button once past the first step

            // Special handling for the analysis step to render chart
            if (index === 5) {
                 if (chartCanvas && chartCtx) {
                    if (!analysisChart) {
                        analysisChart = new Chart(chartCtx, initialChartConfig);
                         // Set initial control values based on chart config
                         if (chartTypeSelect) chartTypeSelect.value = analysisChart.config.type;
                         if (chartColorInput) chartColorInput.value = analysisChart.config.data.datasets[0].backgroundColor;
                         if (chartBorderColorInput) chartBorderColorInput.value = analysisChart.config.data.datasets[0].borderColor;
                         if (chartFontSizeInput) chartFontSizeInput.value = analysisChart.options.plugins.legend.labels.font.size;
                         if (chartTitleInput) chartTitleInput.value = analysisChart.options.plugins.title.text;

                    } else {
                        analysisChart.update(); // Ensure chart is redrawn if container was hidden
                    }
                 }
            } else {
                 // Hide chart controls when not on chart step
                if (chartControls) chartControls.classList.remove('active');
            }

             // Focus the first interactive element in the new step for accessibility
             // Delay focus slightly to allow transition
             setTimeout(() => {
                 const firstInteractiveElement = steps[index].querySelector('input:not([type="hidden"]):not(:disabled), textarea:not(:disabled), select:not(:disabled), button:not(:disabled), [tabindex="0"]:not(.step):not(:disabled)');
                 if (firstInteractiveElement) {
                     firstInteractiveElement.focus();
                 } else {
                     // If no interactive element, focus the section heading
                     const heading = steps[index].querySelector('h2');
                     if (heading) {
                         heading.setAttribute('tabindex', '-1'); // Make heading focusable
                         heading.focus();
                     }
                 }
             }, parseFloat(getComputedStyle(stepContentContainer).transitionDuration) * 1000 + 50); // Delay based on transition speed
        }

        function validateStep(index) {
            let isValid = true;
            let requiredFields = [];

            if (index === 0) {
                requiredFields = requiredFieldsStep1;
            } else if (index === 1) {
                 requiredFields = requiredFieldsStep2;
            }
             // Add validation for other steps if needed (e.g., Step 5 for data upload)
             // else if (index === 4) {
             //     // Example: Check if a file has been selected/processed
             //     const dataFileSelected = dataFileInput && dataFileInput.files.length > 0;
             //     if (!dataFileSelected) {
             //          // Add visual feedback for the upload area if needed
             //          console.warn("Step 5 requires data upload.");
             //          isValid = false;
             //     }
             // }

            requiredFields.forEach(field => {
                if (!field) return; // Skip if element wasn't found
                const errorElement = document.getElementById(field.id + 'Error');
                if (!field.value.trim()) {
                    field.classList.add('validation-error');
                    if (errorElement) errorElement.style.display = 'inline';
                    field.setAttribute('aria-invalid', 'true');
                    isValid = false;
                } else {
                    field.classList.remove('validation-error');
                    if (errorElement) errorElement.style.display = 'none';
                     field.setAttribute('aria-invalid', 'false');
                }
            });

            return isValid;
        }


        function nextStep() {
            if (currentStepIndex < steps.length - 1) {
                showStep(currentStepIndex + 1, 'forward');
            }
        }

        function prevStep() {
            if (currentStepIndex > 0) {
                showStep(currentStepIndex - 1, 'backward');
            }
        }

        function toggleChartControls(event) {
             if (!chartControls) return;
             // Prevent closing if clicking inside controls
            if (event && event.target.closest('.floating-controls')) {
                return;
            }
            chartControls.classList.toggle('active');
             if (chartControls.classList.contains('active')) {
                 // Focus the first control when panel opens
                 const firstControl = chartControls.querySelector('input:not(:disabled), select:not(:disabled), button:not(:disabled)');
                 if (firstControl) {
                     firstControl.focus();
                 }
             }
        }

         // Close chart controls when clicking outside the chart and controls
        document.addEventListener('click', (e) => {
            if (currentStepIndex === 5 && chartContainer && chartControls) { // Only relevant on analysis step
                const clickedInsideChart = chartContainer.contains(e.target);
                const clickedInsideControls = chartControls.contains(e.target);
                if (!clickedInsideChart && !clickedInsideControls) {
                    chartControls.classList.remove('active');
                }
            }
        });

         // Close controls on Escape key
         document.addEventListener('keydown', (e) => {
              if (e.key === 'Escape' && chartControls && chartControls.classList.contains('active')) {
                  chartControls.classList.remove('active');
                   // Return focus to the chart container after closing controls
                  if (chartContainer) chartContainer.focus();
              }
         });


        function updateChart() {
            if (!analysisChart) return;

            const newChartType = chartTypeSelect.value;
            const newBgColor = chartColorInput.value;
            const newBorderColor = chartBorderColorInput.value;
            const newFontSize = parseInt(chartFontSizeInput.value);
            const newTitle = chartTitleInput.value;

            analysisChart.config.type = newChartType;

            // Handle different dataset structures for different chart types
            if (newChartType === 'pie' || newChartType === 'doughnut') {
                 // For pie/doughnut, backgroundColor and borderColor are arrays
                 const colors = analysisChart.data.labels.map((_, i) => {
                    // Simple color variation for slices based on the chosen color
                    const baseColor = newBgColor;
                    // Basic HSL manipulation for variation
                    let [h, s, l] = hexToHsl(baseColor);
                    const variation = (i * 45) % 360; // Vary hue
                    h = (h + variation) % 360;
                    l = Math.max(20, Math.min(80, l + (i % 2 === 0 ? 10 : -10))); // Vary lightness
                    return `hsl(${h}, ${s}%, ${l}%)`;
                 });
                 analysisChart.config.data.datasets[0].backgroundColor = colors;
                 analysisChart.config.data.datasets[0].borderColor = newBorderColor; // Border applies to the whole pie/doughnut
                 analysisChart.options.scales.y.display = false; // Hide y-axis for pie/doughnut
                 analysisChart.options.scales.x.display = false; // Hide x-axis for pie/doughnut
                 // Ensure legend is displayed for pie/doughnut
                 if (analysisChart.options.plugins.legend) analysisChart.options.plugins.legend.display = true;

            } else {
                 // For bar/line, backgroundColor and borderColor are single values
                 analysisChart.config.data.datasets[0].backgroundColor = newBgColor;
                 analysisChart.config.data.datasets[0].borderColor = newBorderColor;
                 analysisChart.options.scales.y.display = true; // Show axes for bar/line
                 analysisChart.options.scales.x.display = true;
                 // Ensure legend is displayed for bar/line if needed, or hide if redundant
                 if (analysisChart.options.plugins.legend) analysisChart.options.plugins.legend.display = true; // Or false if only one dataset
            }

            // Update fonts
            const updateFont = (obj) => {
                if (obj?.font) {
                    obj.font.size = newFontSize;
                    obj.font.family = '"Inter", sans-serif';
                }
            };
            if (analysisChart.options.plugins.legend) updateFont(analysisChart.options.plugins.legend.labels);
            if (analysisChart.options.scales?.y?.ticks) updateFont(analysisChart.options.scales.y.ticks);
            if (analysisChart.options.scales?.x?.ticks) updateFont(analysisChart.options.scales.x.ticks);
             if (analysisChart.options.plugins.tooltip) { // Update tooltip font
                 updateFont(analysisChart.options.plugins.tooltip.bodyFont);
                 updateFont(analysisChart.options.plugins.tooltip.titleFont);
             }


            // Update title
            if (analysisChart.options.plugins.title) {
                 analysisChart.options.plugins.title.text = newTitle || 'Chart Title';
                 analysisChart.options.plugins.title.font.size = newFontSize + 2; // Slightly larger for title
                 analysisChart.options.plugins.title.font.family = '"Inter", sans-serif';
                 analysisChart.options.plugins.title.font.weight = '600';
                 analysisChart.options.plugins.title.color = getComputedStyle(document.documentElement).getPropertyValue('--primary-dark').trim();
            }


            analysisChart.update();
        }

         // Helper function to convert hex to HSL for color variation
         function hexToHsl(hex) {
            // Remove # if it exists
            hex = hex.replace(/^#/, '');

            // Parse r, g, b values
            let r = parseInt(hex.substring(0, 2), 16);
            let g = parseInt(hex.substring(2, 4), 16);
            let b = parseInt(hex.substring(4, 6), 16);

            // Normalize r, g, b values
            r /= 255;
            g /= 255;
            b /= 255;

            // Find the maximum and minimum values
            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);

            let h, s, l = (max + min) / 2;

            if (max === min) {
                // achromatic
                h = s = 0;
            } else {
                const d = max - min;
                s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                switch (max) {
                    case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                    case g: h = (b - r) / d + 2; break;
                    case b: h = (r - g) / d + 4; break;
                }
                h /= 6;
            }

            // Return HSL values (H in degrees, S and L in percentages)
            return [h * 360, s * 100, l * 100];
        }


        // Event listeners for chart controls
        if (chartTypeSelect) chartTypeSelect.addEventListener('change', updateChart);
        if (chartColorInput) chartColorInput.addEventListener('input', updateChart); // Use input for live update
        if (chartBorderColorInput) chartBorderColorInput.addEventListener('input', updateChart); // Use input for live update
        if (chartFontSizeInput) chartFontSizeInput.addEventListener('input', updateChart); // Use input for live update
        if (chartTitleInput) chartTitleInput.addEventListener('input', updateChart); // Use input for live update
        // Add listeners for new placeholder controls (they are disabled in HTML, but add listeners for completeness)
        if (chartDataColumnXSelect) chartDataColumnXSelect.addEventListener('change', updateChart);
        if (chartDataColumnYSelect) chartDataColumnYSelect.addEventListener('change', updateChart);
        if (chartFilterInput) chartFilterInput.addEventListener('input', updateChart);


        // Event listeners for navigation buttons
        nextBtn.addEventListener('click', nextStep);
        prevBtn.addEventListener('click', prevStep);
        saveBtn.addEventListener('click', () => {
            alert('Save functionality is a placeholder.'); // Placeholder action
        });


        // Event listeners for step indicator clicks
        stepIndicator.forEach((step, index) => {
            step.addEventListener('click', () => {
                 if (index !== currentStepIndex) { // Prevent unnecessary transition if clicking current step
                    const direction = index > currentStepIndex ? 'forward' : 'backward';
                    showStep(index, direction);
                 }
            });
             step.addEventListener('keydown', (e) => {
                 if (e.key === 'Enter' || e.key === ' ') {
                     e.preventDefault();
                      if (index !== currentStepIndex) {
                         const direction = index > currentStepIndex ? 'forward' : 'backward';
                         showStep(index, direction);
                     }
                 }
             });
        });

         // Event listener for method card selection
         document.querySelectorAll('.method-card').forEach(card => {
             card.addEventListener('click', () => {
                 // Toggle 'selected' class and update ARIA attribute
                 const isSelected = card.classList.toggle('selected');
                 card.setAttribute('aria-checked', isSelected);
                 // In a real app, you might store selected methods or update UI based on selection
             });
              card.addEventListener('keydown', (e) => {
                 if (e.key === 'Enter' || e.key === ' ') {
                     e.preventDefault();
                     card.click(); // Simulate click
                 }
             });
         });

         // Event listener for data upload area click
         const dataUploadArea = document.getElementById('dataUploadArea');
         const dataFileInput = document.getElementById('dataFileInput');
         const uploadText = document.getElementById('uploadText');
         const uploadLoading = document.getElementById('uploadLoading');

         if (dataUploadArea && dataFileInput && uploadText && uploadLoading) {
             dataUploadArea.addEventListener('click', function() {
                 // Only trigger file input if not in a placeholder state (which it isn't, but good practice)
                 dataFileInput.click();
             });

             // Handle drag and drop
             dataUploadArea.addEventListener('dragover', (e) => {
                 e.preventDefault();
                 dataUploadArea.style.borderColor = "var(--primary-color)";
                 dataUploadArea.style.backgroundColor = "#e9ecef";
             });

              dataUploadArea.addEventListener('dragleave', (e) => {
                 e.preventDefault();
                 dataUploadArea.style.borderColor = "var(--border-color)";
                 dataUploadArea.style.backgroundColor = "var(--background-color)";
             });

             dataUploadArea.addEventListener('drop', (e) => {
                 e.preventDefault();
                 dataUploadArea.style.borderColor = "var(--border-color)";
                 dataUploadArea.style.backgroundColor = "var(--background-color)";
                 if (e.dataTransfer.files.length > 0) {
                     dataFileInput.files = e.dataTransfer.files;
                     handleFileSelect();
                 }
             });


             dataFileInput.addEventListener('change', handleFileSelect);

             function handleFileSelect() {
                 const files = dataFileInput.files;
                 if (files.length > 0) {
                     const fileName = files[0].name;
                     uploadText.innerHTML = `Selected file: <strong>${fileName}</strong>`;
                     uploadLoading.classList.add('active'); // Show loading indicator
                     uploadLoading.setAttribute('aria-hidden', 'false');
                     dataUploadArea.setAttribute('aria-busy', 'true'); // Indicate busy state

                     // Simulate file processing delay
                     setTimeout(() => {
                         uploadLoading.classList.remove('active');
                         uploadLoading.setAttribute('aria-hidden', 'true');
                         dataUploadArea.setAttribute('aria-busy', 'false');
                         uploadText.innerHTML = `File <strong>${fileName}</strong> uploaded successfully.`;
                         // In a real app, you would parse and display the data here
                         // Mark step 5 as potentially valid if file is selected
                         // validateStep(4); // You'd need a check for file presence in validateStep
                     }, 1500); // Simulate 1.5 seconds processing
                 } else {
                      uploadText.innerHTML = `<span class="material-symbols-rounded upload-icon">upload_file</span> Drag and drop your data file here or click to select.<p>(Supported formats: CSV, Excel, TXT)</p>`;
                      dataUploadArea.setAttribute('aria-busy', 'false');
                      uploadLoading.classList.remove('active');
                      uploadLoading.setAttribute('aria-hidden', 'true');
                 }
             }
         }

        // Add keyboard navigation for steps (Left/Right arrows)
        document.addEventListener('keydown', (e) => {
            // Check if focus is inside a form element
            const isFormElement = e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT';
             // Check if focus is inside the chart controls
            const isInsideChartControls = chartControls && chartControls.contains(e.target);

            if (isFormElement || isInsideChartControls) {
                // Don't navigate steps if typing in a form field or interacting with chart controls
                return;
            }

            if (e.key === 'ArrowRight') {
                nextStep();
            } else if (e.key === 'ArrowLeft') {
                prevStep();
            }
        });

        // Initial display
        showStep(0);
    </script>
</body>
</html>
