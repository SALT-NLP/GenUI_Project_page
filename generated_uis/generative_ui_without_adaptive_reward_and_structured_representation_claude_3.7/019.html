<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Community Program Analyzer</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        :root {
            --primary-color: #3498db;
            --primary-color-dark: #2980b9;
            --secondary-color: #2ecc71;
            --secondary-color-dark: #27ae60;
            --background-color: #f4f7f6;
            --surface-color: #ffffff;
            --text-color: #333;
            --text-light-color: #666;
            --border-color: #e0e0e0;
            --shadow-color: rgba(0, 0, 0, 0.08);
            --spacing-unit: 8px;
            --border-radius: 8px;
            --transition-speed: 0.3s;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        header {
            background-color: var(--surface-color);
            color: var(--text-color);
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 3);
            box-shadow: 0 2px 4px var(--shadow-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
            z-index: 1000;
            height: 60px;
            box-sizing: border-box;
        }

        .logo {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--primary-color);
        }

        nav ul {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            gap: calc(var(--spacing-unit) * 3);
        }

        nav a {
            text-decoration: none;
            color: var(--text-light-color);
            font-weight: 500;
            padding: var(--spacing-unit);
            transition: color var(--transition-speed) ease;
            position: relative;
            outline: none; /* Remove default outline */
        }

        nav a:hover,
        nav a:focus {
             color: var(--primary-color);
        }

        nav a.active {
            color: var(--primary-color);
        }

        nav a.active::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: var(--spacing-unit);
            right: var(--spacing-unit);
            height: 2px;
            background-color: var(--primary-color);
            border-radius: 1px;
        }

         nav a:focus-visible {
             outline: 2px solid var(--primary-color-dark);
             outline-offset: 2px;
             border-radius: var(--border-radius);
         }


        .sidebar {
            width: 280px;
            background-color: var(--surface-color);
            box-shadow: 2px 0 5px var(--shadow-color);
            padding: calc(var(--spacing-unit) * 3);
            padding-top: calc(60px + var(--spacing-unit) * 3); /* Offset by header height */
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            overflow-y: auto;
            z-index: 900;
            transition: transform var(--transition-speed) ease-in-out;
        }

        .sidebar.hidden {
            transform: translateX(-280px);
        }

        .sidebar h3 {
            margin-top: 0;
            margin-bottom: calc(var(--spacing-unit) * 2);
            color: var(--primary-color-dark);
            font-size: 1.2em;
        }

        .filter-group {
            margin-bottom: calc(var(--spacing-unit) * 3);
        }

        .filter-group label {
            display: block;
            margin-bottom: var(--spacing-unit);
            font-weight: 500;
            color: var(--text-color);
        }

        .filter-group select,
        .filter-group input[type="text"],
        .filter-group input[type="date"] {
            width: 100%;
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 1.5);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1em;
            box-sizing: border-box;
            transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
            background-color: var(--background-color);
            color: var(--text-color);
            -webkit-appearance: none; /* Remove default appearance */
            -moz-appearance: none;
            appearance: none;
             background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23666%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13.2-6.4H18.6c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%204.6%201.6%208.8%204.8%2012.4l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2094c3.2-3.5%205-7.8%205-12.8%200-4.8-1.8-9-5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right calc(var(--spacing-unit) * 1.5) center;
            background-size: 1em;
            padding-right: calc(var(--spacing-unit) * 4); /* Make space for arrow */
        }

        .filter-group select:focus,
        .filter-group input[type="text"]:focus,
        .filter-group input[type="date"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }

        .main-content {
            margin-left: 280px; /* Offset by sidebar width */
            padding: calc(60px + var(--spacing-unit) * 4) calc(var(--spacing-unit) * 4) calc(var(--spacing-unit) * 4) calc(var(--spacing-unit) * 4); /* Offset by header and sidebar */
            flex-grow: 1;
            transition: margin-left var(--transition-speed) ease-in-out;
        }

        .main-content.sidebar-hidden {
            margin-left: 0;
        }

        .view-section {
            display: none;
        }

        .view-section.active {
            display: block;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: calc(var(--spacing-unit) * 3);
            margin-bottom: calc(var(--spacing-unit) * 4);
        }

        .card {
            background-color: var(--surface-color);
            padding: calc(var(--spacing-unit) * 3);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 8px var(--shadow-color);
            display: flex;
            flex-direction: column;
            transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
        }

        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 12px var(--shadow-color);
        }

        .card h4 {
            margin-top: 0;
            margin-bottom: var(--spacing-unit);
            color: var(--text-light-color);
            font-size: 1em;
            font-weight: 500;
        }

        .card .value {
            font-size: 2em;
            font-weight: 700;
            color: var(--primary-color-dark);
            margin-bottom: var(--spacing-unit);
        }

        .card .description {
            font-size: 0.9em;
            color: var(--text-light-color);
        }

        h2 {
            margin-top: 0;
            margin-bottom: calc(var(--spacing-unit) * 4);
            color: var(--text-color);
            font-size: 1.8em;
            font-weight: 600;
        }

        .chart-container {
            background-color: var(--surface-color);
            padding: calc(var(--spacing-unit) * 3);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 8px var(--shadow-color);
            margin-bottom: calc(var(--spacing-unit) * 4);
            position: relative; /* Needed for floating controls */
            cursor: pointer; /* Indicate interactivity */
        }

        .floating-controls {
            position: absolute;
            top: calc(var(--spacing-unit) * 2);
            right: calc(var(--spacing-unit) * 2);
            background: rgba(255, 255, 255, 0.95);
            padding: calc(var(--spacing-unit) * 1.5);
            border-radius: var(--border-radius);
            box-shadow: 0 2px 8px var(--shadow-color);
            opacity: 0;
            transform: translateY(-10px);
            transition: all var(--transition-speed) ease;
            pointer-events: none;
            z-index: 500;
            min-width: 200px;
        }
        .floating-controls.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }
        .control-group {
            margin-bottom: var(--spacing-unit) * 2;
            display: flex;
            flex-direction: column;
        }
        .control-group label {
            font-size: 0.9em;
            color: var(--text-light-color);
            margin-bottom: var(--spacing-unit);
            font-weight: 500;
        }
        .control-group input[type="color"],
        .control-group select,
        .control-group input[type="number"] {
             width: 100%;
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 1.5);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1em;
            box-sizing: border-box;
            transition: border-color var(--transition-speed) ease;
            background-color: var(--background-color);
            color: var(--text-color);
        }
         .control-group input[type="color"] {
             padding: var(--spacing-unit);
             height: 40px; /* Adjust height for color picker */
         }
         .control-group select {
             background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23666%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13.2-6.4H18.6c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%204.6%201.6%208.8%204.8%2012.4l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2094c3.2-3.5%205-7.8%205-12.8%200-4.8-1.8-9-5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right calc(var(--spacing-unit) * 1.5) center;
            background-size: 1em;
            padding-right: calc(var(--spacing-unit) * 4); /* Make space for arrow */
            -webkit-appearance: none; /* Remove default appearance */
            -moz-appearance: none;
            appearance: none;
         }


        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: calc(var(--spacing-unit) * 4);
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            overflow: hidden; /* Ensures rounded corners work with borders */
            box-shadow: 0 4px 8px var(--shadow-color);
        }

        .data-table th,
        .data-table td {
            padding: calc(var(--spacing-unit) * 2) calc(var(--spacing-unit) * 3);
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .data-table th {
            background-color: var(--background-color);
            font-weight: 600;
            color: var(--text-color);
            cursor: pointer; /* Indicate sortable */
            transition: background-color var(--transition-speed) ease;
            position: relative; /* For sort icon */
        }

        .data-table th:hover {
             background-color: #e9ecef;
        }

         .data-table th .sort-icon {
             position: absolute;
             right: var(--spacing-unit);
             top: 50%;
             transform: translateY(-50%);
             font-size: 0.8em;
             color: var(--text-light-color);
         }

        .data-table tbody tr:hover {
            background-color: var(--background-color);
            cursor: pointer;
        }

        .data-table td {
            color: var(--text-light-color);
        }

        .button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 2.5);
            border-radius: var(--border-radius);
            font-size: 1em;
            font-weight: 500;
            cursor: pointer;
            transition: background-color var(--transition-speed) ease, opacity var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
            border: none;
            text-decoration: none;
            outline: none; /* Remove default outline */
        }

        .button:focus-visible {
             outline: 2px solid var(--primary-color-dark);
             outline-offset: 2px;
             border-radius: var(--border-radius);
        }


        .button-primary {
            background-color: var(--primary-color);
            color: var(--surface-color);
        }

        .button-primary:hover {
            background-color: var(--primary-color-dark);
        }

        .button-secondary {
            background-color: var(--background-color);
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

         .button-secondary:hover {
            background-color: #e9ecef;
            border-color: var(--primary-color-dark);
            color: var(--primary-color-dark);
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }
        .button:disabled:hover {
             background-color: var(--primary-color); /* Keep primary color on disabled hover */
             border-color: var(--primary-color); /* Keep border color on disabled hover */
             color: var(--surface-color); /* Keep text color on disabled hover */
        }
         .button-secondary:disabled:hover {
             background-color: var(--background-color);
             border-color: var(--primary-color);
             color: var(--primary-color);
        }


        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            align-items: center;
            justify-content: center;
            animation: fadeIn var(--transition-speed) ease;
        }

        .modal-content {
            background-color: var(--surface-color);
            padding: calc(var(--spacing-unit) * 4);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 16px var(--shadow-color);
            max-width: 500px;
            width: 90%;
            position: relative;
            animation: slideIn var(--transition-speed) ease-out;
        }

        .close-button {
            position: absolute;
            top: var(--spacing-unit) * 2;
            right: var(--spacing-unit) * 2;
            font-size: 1.5em;
            font-weight: bold;
            color: var(--text-light-color);
            cursor: pointer;
            transition: color var(--transition-speed) ease;
            background: none;
            border: none;
            padding: var(--spacing-unit);
            border-radius: var(--border-radius);
            outline: none;
        }

        .close-button:hover,
        .close-button:focus-visible {
            color: var(--text-color);
            outline: 2px solid var(--primary-color-dark);
            outline-offset: 2px;
        }

        .modal h3 {
            margin-top: 0;
            margin-bottom: calc(var(--spacing-unit) * 3);
            color: var(--primary-color-dark);
        }

        .form-group {
            margin-bottom: calc(var(--spacing-unit) * 2);
        }

        .form-group label {
            display: block;
            margin-bottom: var(--spacing-unit);
            font-weight: 500;
            color: var(--text-color);
        }

        .form-group input[type="file"] {
            display: block;
            width: 100%;
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 1.5);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1em;
            box-sizing: border-box;
            transition: border-color var(--transition-speed) ease;
            background-color: var(--background-color);
            color: var(--text-color);
            outline: none;
        }
         .form-group input[type="file"]:focus-visible {
             border-color: var(--primary-color);
             box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
         }


        .form-group input[type="file"]::file-selector-button {
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 2);
            margin-right: var(--spacing-unit) * 2;
            border: none;
            background-color: var(--primary-color);
            color: var(--surface-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color var(--transition-speed) ease;
            outline: none;
        }

        .form-group input[type="file"]::file-selector-button:hover {
            background-color: var(--primary-color-dark);
        }
         .form-group input[type="file"]::file-selector-button:focus-visible {
             outline: 2px solid var(--primary-color-dark);
             outline-offset: 2px;
         }


        .progress-bar-container {
            width: 100%;
            background-color: var(--background-color);
            border-radius: var(--border-radius);
            margin-top: calc(var(--spacing-unit) * 2);
            overflow: hidden;
        }

        .progress-bar {
            height: var(--spacing-unit) * 2;
            background-color: var(--secondary-color);
            width: 0%;
            transition: width 0.4s ease;
            border-radius: var(--border-radius);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-unit) * 2;
            margin-top: calc(var(--spacing-unit) * 3);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Responsive adjustments */
        @media (max-width: 1024px) {
             .sidebar {
                width: 240px;
             }
             .main-content {
                margin-left: 240px;
             }
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-280px); /* Hide by default on smaller screens */
                width: 280px;
                box-shadow: 5px 0 10px var(--shadow-color);
            }
            .sidebar.hidden {
                 transform: translateX(-280px);
            }
            .sidebar.visible {
                 transform: translateX(0);
            }
            .main-content {
                margin-left: 0; /* No sidebar offset */
                 padding-left: calc(var(--spacing-unit) * 2);
                 padding-right: calc(var(--spacing-unit) * 2);
            }
            header {
                padding: var(--spacing-unit) calc(var(--spacing-unit) * 2);
            }
            nav ul {
                 gap: calc(var(--spacing-unit) * 2);
            }
             .dashboard-grid {
                 grid-template-columns: 1fr; /* Stack cards */
             }
             .chart-container {
                 padding: calc(var(--spacing-unit) * 2);
             }
             .data-table th,
             .data-table td {
                padding: calc(var(--spacing-unit) * 1.5) calc(var(--spacing-unit) * 2);
             }
             .floating-controls {
                 top: var(--spacing-unit);
                 right: var(--spacing-unit);
                 min-width: 150px;
                 padding: var(--spacing-unit);
             }
        }

        .sidebar-toggle {
            display: none; /* Hide by default on desktop */
            background: none;
            border: none;
            font-size: 1.8em;
            color: var(--text-color);
            cursor: pointer;
            padding: var(--spacing-unit);
            margin-right: var(--spacing-unit) * 2;
            outline: none;
        }

         .sidebar-toggle:focus-visible {
             outline: 2px solid var(--primary-color-dark);
             outline-offset: 2px;
             border-radius: var(--border-radius);
         }

         @media (max-width: 768px) {
             .sidebar-toggle {
                 display: block; /* Show on smaller screens */
             }
             .main-content.sidebar-hidden {
                 margin-left: 0;
             }
             .main-content.sidebar-visible {
                 margin-left: 280px; /* Push content when sidebar is open */
             }
        }

        /* Data View Specific Styles */
        .data-upload-section .file-list {
            list-style: none;
            padding: 0;
            margin-top: calc(var(--spacing-unit) * 2);
        }
        .data-upload-section .file-item {
            background-color: var(--background-color);
            padding: var(--spacing-unit) * 1.5;
            border-radius: var(--border-radius);
            margin-bottom: var(--spacing-unit);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.9em;
            color: var(--text-color);
        }
        .data-upload-section .file-item .status {
             font-weight: 500;
             color: var(--secondary-color-dark);
        }
         .data-upload-section .file-item .status.error {
             color: #e74c3c;
         }

        .data-mapping-section .mapping-table {
             width: 100%;
             border-collapse: collapse;
             margin-top: calc(var(--spacing-unit) * 2);
        }
         .data-mapping-section .mapping-table th,
         .data-mapping-section .mapping-table td {
             padding: var(--spacing-unit) * 1.5;
             border: 1px solid var(--border-color);
             text-align: left;
         }
         .data-mapping-section .mapping-table th {
             background-color: var(--background-color);
             font-weight: 600;
             color: var(--text-color);
         }
         .data-mapping-section .mapping-table td select {
             width: 100%;
             padding: var(--spacing-unit);
             border-radius: var(--border-radius);
             border: 1px solid var(--border-color);
             background-color: var(--background-color);
             color: var(--text-color);
             -webkit-appearance: none; /* Remove default appearance */
            -moz-appearance: none;
            appearance: none;
             background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23666%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13.2-6.4H18.6c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%204.6%201.6%208.8%204.8%2012.4l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2094c3.2-3.5%205-7.8%205-12.8%200-4.8-1.8-9-5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right var(--spacing-unit) center;
            background-size: 0.8em;
            padding-right: calc(var(--spacing-unit) * 3);
            outline: none;
         }
          .data-mapping-section .mapping-table td select:focus-visible {
             border-color: var(--primary-color);
             box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
         }

        /* Demographic Analysis Section Styles */
        .demographic-analysis-grid {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
             gap: calc(var(--spacing-unit) * 3);
             margin-bottom: calc(var(--spacing-unit) * 4);
        }
         .demographic-analysis-grid .chart-container {
             margin-bottom: 0; /* Remove extra margin from grid items */
         }

    </style>
</head>
<body>

    <header>
        <div style="display: flex; align-items: center;">
            <button class="sidebar-toggle" id="sidebarToggle" aria-label="Toggle Sidebar">&#9776;</button>
            <div class="logo">Community Impact</div>
        </div>
        <nav aria-label="Main Navigation">
            <ul>
                <li><a href="#" data-view="dashboard" class="active" aria-current="page">Dashboard</a></li>
                <li><a href="#" data-view="data">Data</a></li>
                <li><a href="#" data-view="reports">Reports</a></li>
                <li><a href="#" data-view="settings">Settings</a></li>
            </ul>
        </nav>
    </header>

    <aside class="sidebar" id="sidebar" aria-label="Filters">
        <h3>Filters</h3>
        <div class="filter-group">
            <label for="program-filter">Program</label>
            <select id="program-filter" aria-label="Filter by Program">
                <option value="">All Programs</option>
                <option value="after-school">After-School Activities</option>
                <option value="adult-education">Adult Education</option>
                <option value="senior-services">Senior Services</option>
                <option value="community-events">Community Events</option>
            </select>
        </div>
        <div class="filter-group">
            <label for="time-filter-start">Time Period (Start)</label>
            <input type="date" id="time-filter-start" aria-label="Filter by Start Date">
        </div>
         <div class="filter-group">
            <label for="time-filter-end">Time Period (End)</label>
            <input type="date" id="time-filter-end" aria-label="Filter by End Date">
        </div>
        <div class="filter-group">
            <label for="demographic-filter">Demographic Segment</label>
            <select id="demographic-filter" aria-label="Filter by Demographic Segment">
                <option value="">All Segments</option>
                <option value="youth">Youth (0-18)</option>
                <option value="adult">Adult (19-64)</option>
                <option value="senior">Senior (65+)</option>
                <option value="low-income">Low Income</option>
                <option value="minority">Racial/Ethnic Minority</option>
            </select>
        </div>
    </aside>

    <main class="main-content" id="mainContent">
        <section id="dashboard-view" class="view-section active" role="region" aria-label="Dashboard Overview">
            <h2>Dashboard Overview</h2>
            <div class="dashboard-grid">
                <div class="card" role="status" aria-label="Total Participants">
                    <h4>Total Participants</h4>
                    <div class="value" id="total-participants">1,250</div>
                    <div class="description">Across all programs this period</div>
                </div>
                <div class="card" role="status" aria-label="Average Impact Score">
                    <h4>Average Impact Score</h4>
                    <div class="value" id="average-impact">4.2 / 5</div>
                    <div class="description">Based on participant feedback</div>
                </div>
                <div class="card" role="status" aria-label="Total Program Cost">
                    <h4>Total Program Cost</h4>
                    <div class="value" id="total-cost">$85,000</div>
                    <div class="description">Total expenditure this period</div>
                </div>
                 <div class="card" role="status" aria-label="Cost per Participant">
                    <h4>Cost per Participant</h4>
                    <div class="value" id="cost-per-participant">$68.00</div>
                    <div class="description">Average cost per person served</div>
                </div>
            </div>

             <div class="chart-container" role="img" aria-label="Cost vs Impact per Program Chart">
                <h3 style="margin-top: 0; margin-bottom: var(--spacing-unit) * 2; color: var(--text-color);">Cost vs. Impact per Program</h3>
                <canvas id="costImpactChart" aria-label="Cost vs Impact per Program Chart"></canvas>
                 <div class="floating-controls" id="costImpactChartControls">
                     <button class="close-button" aria-label="Close chart controls" onclick="toggleFloatingControls('costImpactChartControls')">&times;</button>
                    <div class="control-group">
                        <label for="costImpactChartType">Chart Type</label>
                        <select id="costImpactChartType" aria-controls="costImpactChart">
                            <option value="bar">Bar</option>
                            <option value="scatter">Scatter</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="costColor">Cost Color</label>
                        <input type="color" id="costColor" value="#3498db" aria-controls="costImpactChart">
                    </div>
                     <div class="control-group">
                        <label for="impactColor">Impact Color</label>
                        <input type="color" id="impactColor" value="#2ecc71" aria-controls="costImpactChart">
                    </div>
                </div>
            </div>

             <div class="chart-container" role="img" aria-label="Participants Over Time Chart">
                <h3 style="margin-top: 0; margin-bottom: var(--spacing-unit) * 2; color: var(--text-color);">Participants Over Time</h3>
                <canvas id="participantsOverTimeChart" aria-label="Participants Over Time Chart"></canvas>
                 <div class="floating-controls" id="participantsOverTimeChartControls">
                     <button class="close-button" aria-label="Close chart controls" onclick="toggleFloatingControls('participantsOverTimeChartControls')">&times;</button>
                    <div class="control-group">
                        <label for="participantsOverTimeChartType">Chart Type</label>
                        <select id="participantsOverTimeChartType" aria-controls="participantsOverTimeChart">
                            <option value="line">Line</option>
                            <option value="bar">Bar</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="participantsColor">Line/Bar Color</label>
                        <input type="color" id="participantsColor" value="#f39c12" aria-controls="participantsOverTimeChart">
                    </div>
                </div>
            </div>

            <h3>Program Performance Table</h3>
            <table class="data-table" id="programPerformanceTable" aria-label="Program Performance Data">
                <thead>
                    <tr>
                        <th data-sort="program" scope="col" aria-sort="none">Program <span class="sort-icon material-symbols-rounded"></span></th>
                        <th data-sort="participants" scope="col" aria-sort="none">Participants <span class="sort-icon material-symbols-rounded"></span></th>
                        <th data-sort="cost" scope="col" aria-sort="none">Cost <span class="sort-icon material-symbols-rounded"></span></th>
                        <th data-sort="impact" scope="col" aria-sort="none">Impact Score <span class="sort-icon material-symbols-rounded"></span></th>
                        <th data-sort="costPerParticipant" scope="col" aria-sort="none">Cost/Participant <span class="sort-icon material-symbols-rounded"></span></th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Table body will be populated by JS -->
                </tbody>
            </table>

             <div class="chart-container" role="img" aria-label="Demographic Breakdown Chart">
                <h3 style="margin-top: 0; margin-bottom: var(--spacing-unit) * 2; color: var(--text-color);">Demographic Breakdown</h3>
                <canvas id="demographicChart" aria-label="Demographic Breakdown Chart"></canvas>
                 <div class="floating-controls" id="demographicChartControls">
                     <button class="close-button" aria-label="Close chart controls" onclick="toggleFloatingControls('demographicChartControls')">&times;</button>
                    <div class="control-group">
                        <label for="demographicChartType">Chart Type</label>
                        <select id="demographicChartType" aria-controls="demographicChart">
                            <option value="pie">Pie</option>
                            <option value="doughnut">Doughnut</option>
                            <option value="bar">Bar</option>
                        </select>
                    </div>
                     <!-- Add color pickers for segments dynamically if needed -->
                </div>
            </div>

        </section>

        <section id="data-view" class="view-section" role="region" aria-label="Data Management">
            <h2>Data Management</h2>
            <div class="card data-upload-section">
                <h3>Upload Data</h3>
                <p>Upload your program data files (CSV, Excel) here. You will map columns in the next step.</p>
                <button class="button button-primary" id="uploadDataButton" aria-haspopup="dialog" aria-controls="uploadModal">Upload Files</button>

                 <ul class="file-list" id="uploadedFileList">
                     <!-- Uploaded files will be listed here -->
                 </ul>
            </div>

             <div class="card data-mapping-section" style="margin-top: calc(var(--spacing-unit) * 4);">
                <h3>Data Cleaning & Mapping</h3>
                <p>Review uploaded data, clean inconsistencies, and map columns to the standard schema.</p>
                 <div id="mappingPreview" style="display: none;">
                     <h4>Mapping Preview (First 5 rows)</h4>
                     <table class="mapping-table">
                         <thead>
                             <tr>
                                 <th>Your Column</th>
                                 <th>Map To</th>
                             </tr>
                         </thead>
                         <tbody id="mappingTableBody">
                             <!-- Mapping rows populated by JS -->
                         </tbody>
                     </table>
                     <div class="modal-actions" style="justify-content: flex-start; margin-top: calc(var(--spacing-unit) * 2);">
                         <button class="button button-primary" id="processMappedDataButton">Process Mapped Data</button>
                     </div>
                 </div>
                 <p id="mappingStatusMessage" style="font-size: 0.9em; color: var(--text-light-color); margin-top: var(--spacing-unit);"></p>
            </div>
        </section>

        <section id="reports-view" class="view-section" role="region" aria-label="Reports">
            <h2>Reports</h2>
             <div class="card">
                <h3>Generate Reports</h3>
                <p>Select report type and format to generate analysis reports.</p>
                <div class="form-group">
                    <label for="report-type">Report Type</label>
                    <select id="report-type" aria-label="Select Report Type">
                        <option value="summary">Summary Report</option>
                        <option value="program-detail">Program Detail Report</option>
                        <option value="demographic-analysis">Demographic Analysis Report</option>
                        <option value="cost-analysis">Cost Analysis Report</option>
                    </select>
                </div>
                 <div class="form-group">
                    <label for="report-format">Format</label>
                    <select id="report-format" aria-label="Select Report Format">
                        <option value="pdf">PDF</option>
                        <option value="csv">CSV</option>
                        <option value="xlsx">Excel (XLSX)</option>
                    </select>
                </div>
                <button class="button button-primary" id="generateReportButton">Generate Report</button>
                 <p id="reportStatusMessage" style="font-size: 0.9em; color: var(--text-light-color); margin-top: var(--spacing-unit);"></p>
            </div>
        </section>

        <section id="settings-view" class="view-section" role="region" aria-label="Application Settings">
            <h2>Settings</h2>
             <div class="card">
                <h3>Application Settings (Placeholder)</h3>
                <p>Configure application settings, data connections, etc.</p>
                <button class="button button-secondary" disabled>Open Settings</button>
            </div>
        </section>

    </main>

    <!-- Data Upload Modal -->
    <div id="uploadModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="uploadModalTitle">
        <div class="modal-content">
            <button class="close-button" id="closeUploadModal" aria-label="Close upload modal">&times;</button>
            <h3 id="uploadModalTitle">Upload Data Files</h3>
            <div class="form-group">
                <label for="dataFiles">Select files to upload:</label>
                <input type="file" id="dataFiles" multiple accept=".csv, .xls, .xlsx" aria-describedby="uploadStatusMessage">
            </div>
            <div class="progress-bar-container" id="uploadProgressBarContainer" style="display: none;">
                <div class="progress-bar" id="uploadProgressBar" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
             <p id="uploadStatusMessage" style="font-size: 0.9em; color: var(--text-light-color); margin-top: var(--spacing-unit); min-height: 1.2em;"></p>
            <div class="modal-actions">
                <button class="button button-secondary" id="cancelUploadButton">Cancel</button>
                <button class="button button-primary" id="startUploadButton" disabled>Upload</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { Chart } from "https://esm.sh/chart.js/auto";
        import Papa from "https://esm.sh/papaparse";
        // Note: Handling .xls/.xlsx requires a separate library like SheetJS (not included here for simplicity)

        // --- Data Store (Simple In-Memory) ---
        let programData = [
             { program: 'After-School Activities', participants: 450, cost: 25000, impact: 4.5, demographic: { youth: 400, adult: 50, senior: 0, lowIncome: 200, minority: 150 }, date: new Date('2023-06-01') },
             { program: 'Adult Education', participants: 300, cost: 30000, impact: 4.0, demographic: { youth: 0, adult: 280, senior: 20, lowIncome: 250, minority: 200 }, date: new Date('2023-06-01') },
             { program: 'Senior Services', participants: 350, cost: 20000, impact: 4.3, demographic: { youth: 0, adult: 30, senior: 320, lowIncome: 180, minority: 100 }, date: new Date('2023-06-01') },
             { program: 'Community Events', participants: 150, cost: 10000, impact: 3.8, demographic: { youth: 50, adult: 80, senior: 20, lowIncome: 70, minority: 60 }, date: new Date('2023-06-01') },
             // Add some data for different dates/periods for time series chart
             { program: 'After-School Activities', participants: 480, cost: 26000, impact: 4.6, demographic: { youth: 430, adult: 50, senior: 0, lowIncome: 210, minority: 160 }, date: new Date('2023-07-01') },
             { program: 'Adult Education', participants: 310, cost: 31000, impact: 4.1, demographic: { youth: 0, adult: 290, senior: 20, lowIncome: 260, minority: 210 }, date: new Date('2023-07-01') },
             { program: 'Senior Services', participants: 360, cost: 20500, impact: 4.4, demographic: { youth: 0, adult: 30, senior: 330, lowIncome: 190, minority: 105 }, date: new Date('2023-07-01') },
             { program: 'Community Events', participants: 160, cost: 10500, impact: 3.9, demographic: { youth: 55, adult: 85, senior: 20, lowIncome: 75, minority: 65 }, date: new Date('2023-07-01') },
             { program: 'After-School Activities', participants: 470, cost: 25500, impact: 4.5, demographic: { youth: 420, adult: 50, senior: 0, lowIncome: 205, minority: 155 }, date: new Date('2023-08-01') },
             { program: 'Adult Education', participants: 320, cost: 31500, impact: 4.2, demographic: { youth: 0, adult: 300, senior: 20, lowIncome: 270, minority: 220 }, date: new Date('2023-08-01') },
             { program: 'Senior Services', participants: 370, cost: 21000, impact: 4.5, demographic: { youth: 0, adult: 30, senior: 340, lowIncome: 200, minority: 110 }, date: new Date('2023-08-01') },
             { program: 'Community Events', participants: 170, cost: 11000, impact: 4.0, demographic: { youth: 60, adult: 90, senior: 20, lowIncome: 80, minority: 70 }, date: new Date('2023-08-01') },
        ];

        // Standard schema for mapping
        const standardSchema = {
             program: 'Program Name',
             participants: 'Number of Participants',
             cost: 'Program Cost',
             impact: 'Impact Score',
             demographic_youth: 'Youth Participants (0-18)',
             demographic_adult: 'Adult Participants (19-64)',
             demographic_senior: 'Senior Participants (65+)',
             demographic_lowIncome: 'Low Income Participants',
             demographic_minority: 'Minority Participants',
             date: 'Program Date/Period'
        };

        let uploadedRawData = []; // Store raw data from uploaded files before mapping

        // --- UI State Management ---
        const views = document.querySelectorAll('.view-section');
        const navLinks = document.querySelectorAll('nav a');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const dashboardCards = {
            totalParticipants: document.getElementById('total-participants'),
            averageImpact: document.getElementById('average-impact'),
            totalCost: document.getElementById('total-cost'),
            costPerParticipant: document.getElementById('cost-per-participant')
        };
        const programPerformanceTableBody = document.querySelector('#programPerformanceTable tbody');
        const tableHeaders = document.querySelectorAll('#programPerformanceTable th[data-sort]');


        function showView(viewId) {
            views.forEach(view => {
                view.classList.remove('active');
            });
            document.getElementById(viewId).classList.add('active');

            navLinks.forEach(link => {
                const linkViewId = link.getAttribute('data-view') + '-view';
                if (linkViewId === viewId) {
                    link.classList.add('active');
                    link.setAttribute('aria-current', 'page');
                } else {
                    link.classList.remove('active');
                    link.removeAttribute('aria-current');
                }
            });

            // Trigger updates/rendering for the active view
            if (viewId === 'dashboard-view') {
                 // Re-render charts or ensure they are updated with current filters
                 if (chartConfigs['costImpactChart']) chartConfigs['costImpactChart'].update();
                 if (chartConfigs['participantsOverTimeChart']) chartConfigs['participantsOverTimeChart'].update();
                 if (chartConfigs['demographicChart']) chartConfigs['demographicChart'].update();
                 applyFilters(); // Apply current filters to dashboard
            } else if (viewId === 'data-view') {
                 // Maybe show last uploaded data preview
            }
            // Hide sidebar on mobile after navigation
             if (window.innerWidth <= 768) {
                 hideSidebar();
             }
        }

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const viewId = e.target.getAttribute('data-view') + '-view';
                showView(viewId);
            });
        });

        // Initial view
        showView('dashboard-view');

        // Sidebar toggle
        function toggleSidebar() {
            const isHidden = sidebar.classList.toggle('hidden');
            mainContent.classList.toggle('sidebar-hidden');
             sidebar.classList.toggle('visible', !isHidden);
             mainContent.classList.toggle('sidebar-visible', !isHidden);
             sidebarToggle.setAttribute('aria-expanded', !isHidden);
        }

        function hideSidebar() {
             sidebar.classList.add('hidden');
             mainContent.classList.add('sidebar-hidden');
             sidebar.classList.remove('visible');
             mainContent.classList.remove('sidebar-visible');
             sidebarToggle.setAttribute('aria-expanded', 'false');
        }

         function showSidebar() {
             sidebar.classList.remove('hidden');
             mainContent.classList.remove('sidebar-hidden');
             sidebar.classList.add('visible');
             mainContent.classList.add('sidebar-visible');
             sidebarToggle.setAttribute('aria-expanded', 'true');
        }


        sidebarToggle.addEventListener('click', toggleSidebar);

        // Hide sidebar on wider screens if it was toggled off on mobile
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                sidebar.classList.remove('hidden', 'visible');
                mainContent.classList.remove('sidebar-hidden', 'sidebar-visible');
                 sidebarToggle.setAttribute('aria-expanded', 'true'); // Assume visible on desktop
            } else {
                 // Re-apply hidden state if it was hidden before resize
                 if (!sidebar.classList.contains('visible')) {
                     sidebar.classList.add('hidden');
                     mainContent.classList.add('sidebar-hidden');
                     sidebarToggle.setAttribute('aria-expanded', 'false');
                 }
            }
             // Update charts on resize to ensure responsiveness
             Object.values(chartConfigs).forEach(chart => chart?.update());
        });

         // Initial state for sidebar toggle aria-expanded
         if (window.innerWidth > 768) {
             sidebarToggle.setAttribute('aria-expanded', 'true');
         } else {
              sidebarToggle.setAttribute('aria-expanded', 'false');
         }


        // --- Charting ---
        const chartConfigs = {}; // Store chart instances

        function renderCostImpactChart(data) {
            const ctx = document.getElementById('costImpactChart').getContext('2d');
             if (chartConfigs['costImpactChart']) {
                 chartConfigs['costImpactChart'].destroy(); // Destroy existing chart before re-rendering
             }

             const labels = data.map(d => d.program);
             const costData = data.map(d => d.cost);
             const impactData = data.map(d => d.impact);

            const config = {
                type: 'bar', // Default type
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Cost ($)',
                            data: costData,
                            backgroundColor: "var(--primary-color)",
                            borderColor: "var(--primary-color-dark)",
                            borderWidth: 1
                        },
                        {
                            label: 'Impact Score (1-5)',
                            data: impactData,
                            backgroundColor: "var(--secondary-color)",
                            borderColor: "var(--secondary-color-dark)",
                            borderWidth: 1,
                            yAxisID: 'y1' // Use a different Y-axis for impact
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                color: "var(--text-color)"
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.dataset.label.includes('Cost') ?
                                                 `$${context.parsed.y.toLocaleString()}` :
                                                 context.parsed.y.toFixed(1);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Cost ($)',
                                color: "var(--primary-color-dark)"
                            },
                             ticks: {
                                 color: "var(--text-light-color)"
                             },
                             grid: {
                                 color: "var(--border-color)"
                             }
                        },
                         y1: { // Second Y-axis for Impact
                            position: 'right',
                            beginAtZero: true,
                            max: 5,
                            title: {
                                display: true,
                                text: 'Impact Score (1-5)',
                                color: "var(--secondary-color-dark)"
                            },
                             ticks: {
                                 color: "var(--text-light-color)"
                             },
                             grid: {
                                 drawOnChartArea: false // Only draw grid lines for the first Y-axis
                             }
                        },
                         x: {
                             ticks: {
                                 color: "var(--text-light-color)"
                             },
                             grid: {
                                 color: "var(--border-color)"
                             }
                         }
                    },
                     onClick: (e) => toggleFloatingControls('costImpactChartControls')
                }
            };
            chartConfigs['costImpactChart'] = new Chart(ctx, config);
            setupChartControls('costImpactChart', 'costImpactChartControls');
        }

         function renderParticipantsOverTimeChart(data) {
             const ctx = document.getElementById('participantsOverTimeChart').getContext('2d');
             if (chartConfigs['participantsOverTimeChart']) {
                 chartConfigs['participantsOverTimeChart'].destroy(); // Destroy existing chart
             }

             // Aggregate participants by date
             const participantsByDate = data.reduce((acc, item) => {
                 const dateKey = item.date.toISOString().split('T')[0]; // Use YYYY-MM-DD as key
                 if (!acc[dateKey]) {
                     acc[dateKey] = 0;
                 }
                 acc[dateKey] += item.participants;
                 return acc;
             }, {});

             const sortedDates = Object.keys(participantsByDate).sort();
             const labels = sortedDates; // Use dates as labels
             const participantData = sortedDates.map(date => participantsByDate[date]);


            const config = {
                type: 'line', // Default type
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Total Participants',
                            data: participantData,
                            borderColor: "var(--primary-color)",
                            backgroundColor: "rgba(52, 152, 219, 0.2)",
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                             labels: {
                                color: "var(--text-color)"
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += context.parsed.y.toLocaleString();
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Number of Participants',
                                color: "var(--primary-color-dark)"
                            },
                             ticks: {
                                 color: "var(--text-light-color)"
                             },
                             grid: {
                                 color: "var(--border-color)"
                             }
                        },
                         x: {
                             ticks: {
                                 color: "var(--text-light-color)"
                             },
                             grid: {
                                 color: "var(--border-color)"
                             }
                         }
                    },
                     onClick: (e) => toggleFloatingControls('participantsOverTimeChartControls')
                }
            };
            chartConfigs['participantsOverTimeChart'] = new Chart(ctx, config);
             setupChartControls('participantsOverTimeChart', 'participantsOverTimeChartControls');
        }

        function renderDemographicChart(data) {
             const ctx = document.getElementById('demographicChart').getContext('2d');
             if (chartConfigs['demographicChart']) {
                 chartConfigs['demographicChart'].destroy(); // Destroy existing chart
             }

             // Aggregate demographics across filtered data
             const totalDemographics = data.reduce((acc, item) => {
                 if (item.demographic) {
                     acc.youth += item.demographic.youth || 0;
                     acc.adult += item.demographic.adult || 0;
                     acc.senior += item.demographic.senior || 0;
                     acc.lowIncome += item.demographic.lowIncome || 0;
                     acc.minority += item.demographic.minority || 0;
                 }
                 return acc;
             }, { youth: 0, adult: 0, senior: 0, lowIncome: 0, minority: 0 });

             const labels = ['Youth (0-18)', 'Adult (19-64)', 'Senior (65+)', 'Low Income', 'Minority'];
             const demographicData = [
                 totalDemographics.youth,
                 totalDemographics.adult,
                 totalDemographics.senior,
                 totalDemographics.lowIncome,
                 totalDemographics.minority
             ];

             const backgroundColors = [
                 '#ff6384', '#36a2eb', '#cc65fe', '#ffce56', '#4bc0c0'
             ];


             const config = {
                type: 'pie', // Default type
                data: {
                    labels: labels,
                    datasets: [
                        {
                            data: demographicData,
                            backgroundColor: backgroundColors,
                            hoverOffset: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                             labels: {
                                color: "var(--text-color)"
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                     if (context.parsed !== null) {
                                        const total = context.dataset.data.reduce((sum, val) => sum + val, 0);
                                        const percentage = total > 0 ? ((context.parsed / total) * 100).toFixed(1) : 0;
                                        label += `${context.parsed.toLocaleString()} (${percentage}%)`;
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                     onClick: (e) => toggleFloatingControls('demographicChartControls')
                }
            };
            chartConfigs['demographicChart'] = new Chart(ctx, config);
             setupChartControls('demographicChart', 'demographicChartControls');
        }


        // Render charts when dashboard is active
        document.getElementById('dashboard-view').addEventListener('transitionend', (event) => {
             if (event.propertyName === 'display' && event.target.classList.contains('active')) {
                 // Charts will be rendered/updated by applyFilters which is called on view change
             }
         });

         // Initial render if dashboard is the default active view
         if (document.getElementById('dashboard-view').classList.contains('active')) {
             // Charts are rendered via the initial applyFilters call below
         }


        // --- Floating Chart Controls ---
        function setupChartControls(chartId, controlsId) {
            const chart = chartConfigs[chartId];
            const controls = document.getElementById(controlsId);

            // Close controls when clicking outside
            document.addEventListener('click', (e) => {
                const chartCanvas = document.getElementById(chartId);
                // Check if click is outside controls AND outside the chart canvas
                if (!controls.contains(e.target) && !chartCanvas.contains(e.target)) {
                    controls.classList.remove('active');
                }
            });

            // Dynamic chart updates based on controls
            controls.querySelectorAll('input, select').forEach(element => {
                element.addEventListener('change', () => updateChartFromControls(chartId, controlsId));
            });
        }

        function toggleFloatingControls(controlsId) {
             const controls = document.getElementById(controlsId);
             // Close any other active controls first
             document.querySelectorAll('.floating-controls.active').forEach(activeControls => {
                 if (activeControls.id !== controlsId) {
                     activeControls.classList.remove('active');
                 }
             });
             controls.classList.toggle('active');
             // Ensure controls are within viewport if possible (basic)
             if(controls.classList.contains('active')) {
                 const rect = controls.getBoundingClientRect();
                 if (rect.right > window.innerWidth) {
                     controls.style.left = (window.innerWidth - rect.width - 20) + 'px'; // 20px padding
                     controls.style.right = 'auto';
                 } else if (rect.left < 0) {
                     controls.style.left = '20px';
                     controls.style.right = 'auto';
                 }
                 if (rect.bottom > window.innerHeight) {
                      controls.style.top = (window.innerHeight - rect.height - 20) + 'px';
                      controls.style.bottom = 'auto';
                 } else if (rect.top < 60) { // Below header
                     controls.style.top = 'calc(60px + var(--spacing-unit) * 2)';
                     controls.style.bottom = 'auto';
                 }
             } else {
                 // Reset position when closing
                 controls.style.left = 'auto';
                 controls.style.right = 'calc(var(--spacing-unit) * 2)';
                 controls.style.top = 'calc(var(--spacing-unit) * 2)';
                 controls.style.bottom = 'auto';
             }
        }

        function updateChartFromControls(chartId, controlsId) {
            const chart = chartConfigs[chartId];
            const controls = document.getElementById(controlsId);

            if (!chart) return; // Ensure chart exists

            // Example logic for Cost/Impact chart controls
            if (chartId === 'costImpactChart') {
                const newChartType = controls.querySelector('#costImpactChartType')?.value;
                const newCostColor = controls.querySelector('#costColor')?.value;
                const newImpactColor = controls.querySelector('#impactColor')?.value;

                // Get current filtered data to apply updates
                const filteredData = getFilteredData();
                const labels = filteredData.map(d => d.program);
                const costData = filteredData.map(d => d.cost);
                const impactData = filteredData.map(d => d.impact);


                if (newChartType && newChartType !== chart.config.type) {
                     chart.config.type = newChartType;
                     // Adjust scales and data structure based on type
                     if (newChartType === 'scatter') {
                         // Scatter requires data in {x, y} format. Use Cost vs Impact.
                          chart.data.datasets[0].data = filteredData.map(d => ({ x: d.cost, y: d.impact }));
                          chart.data.datasets[0].label = 'Cost vs Impact';
                          chart.data.datasets[0].backgroundColor = newCostColor || chart.data.datasets[0].backgroundColor;
                          chart.data.datasets[0].borderColor = newCostColor || chart.data.datasets[0].borderColor;
                          chart.data.datasets[0].yAxisID = 'y'; // Scatter typically uses one Y axis

                          // Remove the second dataset or change its purpose for scatter if needed
                          // For simplicity, let's just use the first dataset for scatter
                          if (chart.data.datasets.length > 1) {
                               chart.data.datasets.pop(); // Remove impact dataset for scatter
                          }

                           chart.options.scales = { // Reconfigure scales for scatter
                                x: {
                                    type: 'linear',
                                    position: 'bottom',
                                    title: { display: true, text: 'Cost ($)', color: "var(--primary-color-dark)" },
                                    ticks: { color: "var(--text-light-color)" },
                                    grid: { color: "var(--border-color)" }
                                },
                                y: {
                                     type: 'linear',
                                     title: { display: true, text: 'Impact Score (1-5)', color: "var(--secondary-color-dark)" },
                                     ticks: { color: "var(--text-light-color)" },
                                     grid: { color: "var(--border-color)" }
                                }
                           };


                     } else { // Back to bar (or other non-scatter)
                          // Restore original data structure (Cost and Impact as separate bars)
                          chart.data.datasets = [
                               {
                                   label: 'Cost ($)',
                                   data: costData,
                                   backgroundColor: newCostColor || "var(--primary-color)",
                                   borderColor: newCostColor || "var(--primary-color-dark)",
                                   borderWidth: 1
                               },
                               {
                                   label: 'Impact Score (1-5)',
                                   data: impactData,
                                   backgroundColor: newImpactColor || "var(--secondary-color)",
                                   borderColor: newImpactColor || "var(--secondary-color-dark)",
                                   borderWidth: 1,
                                   yAxisID: 'y1'
                               }
                          ];
                          chart.data.labels = labels;

                          chart.options.scales = { // Restore bar chart scales
                                y: {
                                    beginAtZero: true,
                                    title: { display: true, text: 'Cost ($)', color: "var(--primary-color-dark)" },
                                    ticks: { color: "var(--text-light-color)" },
                                    grid: { color: "var(--border-color)" }
                                },
                                y1: {
                                    position: 'right',
                                    beginAtZero: true,
                                    max: 5,
                                    title: { display: true, text: 'Impact Score (1-5)', color: "var(--secondary-color-dark)" },
                                    ticks: { color: "var(--text-light-color)" },
                                    grid: { drawOnChartArea: false }
                                },
                                x: {
                                    ticks: { color: "var(--text-light-color)" },
                                    grid: { color: "var(--border-color)" }
                                }
                          };
                     }
                }

                 // Update colors regardless of type
                 if (newCostColor) {
                     if (chart.config.type === 'scatter') {
                          chart.data.datasets[0].backgroundColor = newCostColor;
                          chart.data.datasets[0].borderColor = newCostColor;
                     } else { // Bar
                         chart.data.datasets[0].backgroundColor = newCostColor;
                         chart.data.datasets[0].borderColor = newCostColor;
                     }
                 }
                 if (newImpactColor && chart.config.type !== 'scatter') { // Only update impact color if it's a separate dataset (e.g., bar)
                     chart.data.datasets[1].backgroundColor = newImpactColor;
                     chart.data.datasets[1].borderColor = newImpactColor;
                 }


            } else if (chartId === 'participantsOverTimeChart') {
                const newChartType = controls.querySelector('#participantsOverTimeChartType')?.value;
                const newLineColor = controls.querySelector('#participantsColor')?.value;

                // Get current filtered data and aggregate by date
                 const filteredData = getFilteredData();
                 const participantsByDate = filteredData.reduce((acc, item) => {
                     const dateKey = item.date.toISOString().split('T')[0];
                     if (!acc[dateKey]) {
                         acc[dateKey] = 0;
                     }
                     acc[dateKey] += item.participants;
                     return acc;
                 }, {});
                 const sortedDates = Object.keys(participantsByDate).sort();
                 const labels = sortedDates;
                 const participantData = sortedDates.map(date => participantsByDate[date]);

                 chart.data.labels = labels;
                 chart.data.datasets[0].data = participantData;


                 if (newChartType && newChartType !== chart.config.type) {
                     chart.config.type = newChartType;
                     // Line chart fill color needs adjustment if changing to bar
                     if (newChartType === 'bar') {
                         chart.data.datasets[0].backgroundColor = newLineColor || "var(--primary-color)"; // Use solid color for bars
                         chart.data.datasets[0].fill = false;
                         chart.data.datasets[0].tension = 0;
                     } else { // Back to line
                         chart.data.datasets[0].backgroundColor = (newLineColor || "var(--primary-color)").replace(')', ', 0.2)').replace('rgb(', 'rgba('); // Add transparency back
                         chart.data.datasets[0].fill = true;
                         chart.data.datasets[0].tension = 0.3;
                     }
                 }
                 if (newLineColor) {
                      chart.data.datasets[0].borderColor = newLineColor;
                      if (chart.config.type === 'line') {
                          chart.data.datasets[0].backgroundColor = newLineColor.replace(')', ', 0.2)').replace('rgb(', 'rgba(');
                      } else {
                          chart.data.datasets[0].backgroundColor = newLineColor;
                      }
                 }
            } else if (chartId === 'demographicChart') {
                 const newChartType = controls.querySelector('#demographicChartType')?.value;

                 if (newChartType && newChartType !== chart.config.type) {
                     chart.config.type = newChartType;
                     // No major data structure changes needed for pie/doughnut/bar
                     // Bar chart might need different colors or a single dataset if previously multi-dataset
                     if (newChartType === 'bar') {
                          // If changing to bar, might need to re-assign background colors to bars
                          // For simplicity, keep the same colors for segments/bars
                          chart.data.datasets[0].backgroundColor = chart.data.datasets[0].backgroundColor; // Keep existing colors
                          chart.options.scales = { // Add scales for bar chart
                               y: {
                                   beginAtZero: true,
                                   title: { display: true, text: 'Number of Participants', color: "var(--primary-color-dark)" },
                                   ticks: { color: "var(--text-light-color)" },
                                   grid: { color: "var(--border-color)" }
                               },
                               x: {
                                   ticks: { color: "var(--text-light-color)" },
                                   grid: { color: "var(--border-color)" }
                               }
                          };
                     } else { // Back to pie/doughnut
                          delete chart.options.scales; // Remove scales for pie/doughnut
                     }
                 }
            }


            chart.update();
        }


        // --- Data Filtering ---
        const programFilter = document.getElementById('program-filter');
        const timeFilterStart = document.getElementById('time-filter-start');
        const timeFilterEnd = document.getElementById('time-filter-end');
        const demographicFilter = document.getElementById('demographic-filter');

        function getFilteredData() {
            const selectedProgram = programFilter.value;
            const startDate = timeFilterStart.value ? new Date(timeFilterStart.value) : null;
            const endDate = timeFilterEnd.value ? new Date(timeFilterEnd.value) : null;
            const selectedDemographic = demographicFilter.value;

            let filteredData = programData; // Start with all data

            // Filter by Program
            if (selectedProgram) {
                filteredData = filteredData.filter(item => item.program.toLowerCase().replace(/\s+/g, '-') === selectedProgram);
            }

            // Filter by Time Period
            if (startDate) {
                 filteredData = filteredData.filter(item => item.date >= startDate);
            }
             if (endDate) {
                 // Add one day to include the end date itself
                 const adjustedEndDate = new Date(endDate);
                 adjustedEndDate.setDate(adjustedEndDate.getDate() + 1);
                 filteredData = filteredData.filter(item => item.date < adjustedEndDate);
             }

            // Filter by Demographic (This is more complex - need to filter the *data points* that relate to the demographic)
            // For simplicity here, let's assume the demographic filter applies to the *program* data shown,
            // meaning we only show programs relevant to that demographic or adjust metrics.
            // A more robust approach would filter individual participant records if available.
             if (selectedDemographic) {
                 // Placeholder: In a real app, you'd filter data based on participant demographics linked to programs.
                 // For this example, we'll just log the filter intent.
                 console.log(`Filtering data for demographic: ${selectedDemographic}`);
                 // Actual filtering based on demographic counts within program data:
                 filteredData = filteredData.filter(item => {
                     if (!item.demographic) return false;
                     switch(selectedDemographic) {
                         case 'youth': return item.demographic.youth > 0;
                         case 'adult': return item.demographic.adult > 0;
                         case 'senior': return item.demographic.senior > 0;
                         case 'low-income': return item.demographic.lowIncome > 0;
                         case 'minority': return item.demographic.minority > 0;
                         default: return true; // Should not happen with the select options
                     }
                 });
             }


            console.log("Applied Filters:", {
                program: selectedProgram,
                startDate: startDate,
                endDate: endDate,
                demographic: selectedDemographic,
                resultCount: filteredData.length
            });

            return filteredData;
        }

        const applyFilters = () => {
            const filteredData = getFilteredData();

            // Update Dashboard Cards
            const totalParticipants = filteredData.reduce((sum, item) => sum + item.participants, 0);
            const totalCost = filteredData.reduce((sum, item) => sum + item.cost, 0);
            const averageImpact = filteredData.length > 0 ? (filteredData.reduce((sum, item) => sum + item.impact, 0) / filteredData.length).toFixed(1) : 'N/A';
            const costPerParticipant = totalParticipants > 0 ? (totalCost / totalParticipants).toFixed(2) : 'N/A';

            dashboardCards.totalParticipants.textContent = totalParticipants.toLocaleString();
            dashboardCards.averageImpact.textContent = `${averageImpact} / 5`;
            dashboardCards.totalCost.textContent = `$${totalCost.toLocaleString()}`;
            dashboardCards.costPerParticipant.textContent = `$${costPerParticipant}`;

            // Update Program Performance Table
            renderProgramTable(filteredData);

            // Update Charts
            // For charts like Cost vs Impact, we might want to show aggregated data per program *within* the filtered period
             const aggregatedByProgram = filteredData.reduce((acc, item) => {
                 if (!acc[item.program]) {
                     acc[item.program] = { participants: 0, cost: 0, impact: 0, count: 0, program: item.program };
                 }
                 acc[item.program].participants += item.participants;
                 acc[item.program].cost += item.cost;
                 acc[item.program].impact += item.impact; // Sum impact, will average later
                 acc[item.program].count += 1; // Count occurrences to average impact
                 return acc;
             }, {});
             const aggregatedProgramArray = Object.values(aggregatedByProgram).map(item => ({
                 ...item,
                 impact: item.count > 0 ? (item.impact / item.count) : 0, // Calculate average impact
                 costPerParticipant: item.participants > 0 ? (item.cost / item.participants) : 0
             }));


            renderCostImpactChart(aggregatedProgramArray);
            renderParticipantsOverTimeChart(filteredData); // Time series uses raw filtered data
            renderDemographicChart(filteredData); // Demographic uses raw filtered data aggregated

        };

        // Add event listeners to filters
        programFilter.addEventListener('change', applyFilters);
        timeFilterStart.addEventListener('change', applyFilters);
        timeFilterEnd.addEventListener('change', applyFilters);
        demographicFilter.addEventListener('change', applyFilters);

        // --- Data Table Sorting ---

        function renderProgramTable(data) {
             programPerformanceTableBody.innerHTML = ''; // Clear existing rows
             const sortedData = [...data]; // Create a copy to sort without modifying original

             // Apply current sort if any
             const currentSortHeader = document.querySelector('#programPerformanceTable th[data-order]');
             if (currentSortHeader) {
                 const sortKey = currentSortHeader.getAttribute('data-sort');
                 const sortOrder = currentSortHeader.getAttribute('data-order');
                 sortTable(sortedData, sortKey, sortOrder);
             }


             sortedData.forEach(item => {
                 const row = document.createElement('tr');
                 row.innerHTML = `
                    <td>${item.program}</td>
                    <td>${item.participants.toLocaleString()}</td>
                    <td>$${item.cost.toLocaleString()}</td>
                    <td>${item.impact.toFixed(1)}</td>
                    <td>$${(item.participants > 0 ? item.cost / item.participants : 0).toFixed(2)}</td>
                 `;
                 // Add click listener for potential future detail view
                 row.addEventListener('click', () => {
                     console.log('Clicked row:', item);
                     // TODO: Implement detailed view for program
                 });
                 programPerformanceTableBody.appendChild(row);
             });
        }


        tableHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const sortKey = header.getAttribute('data-sort');
                const currentOrder = header.getAttribute('data-order') || 'asc';
                const newOrder = currentOrder === 'asc' ? 'desc' : 'asc';

                // Remove order attributes and icons from other headers
                headers.forEach(h => {
                    if (h !== header) {
                        h.removeAttribute('data-order');
                         const icon = h.querySelector('.sort-icon');
                         if (icon) icon.textContent = ''; // Clear icon
                         h.setAttribute('aria-sort', 'none');
                    }
                });

                header.setAttribute('data-order', newOrder);
                 const icon = header.querySelector('.sort-icon');
                 if (icon) {
                     icon.textContent = newOrder === 'asc' ? 'arrow_upward' : 'arrow_downward';
                 }
                 header.setAttribute('aria-sort', newOrder === 'asc' ? 'ascending' : 'descending');


                // Sort the currently filtered data
                const filteredData = getFilteredData();
                sortTable(filteredData, sortKey, newOrder);

                // Re-render table with sorted data
                renderProgramTable(filteredData);
            });
        });

        function sortTable(data, key, order) {
             data.sort((a, b) => {
                 let aValue = a[key];
                 let bValue = b[key];

                 // Handle specific keys for sorting
                 if (key === 'costPerParticipant') {
                     aValue = a.participants > 0 ? a.cost / a.participants : 0;
                     bValue = b.participants > 0 ? b.cost / b.participants : 0;
                 }

                 // Type checking for comparison
                 if (typeof aValue === 'string' && typeof bValue === 'string') {
                     return order === 'asc' ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
                 } else if (typeof aValue === 'number' && typeof bValue === 'number') {
                     return order === 'asc' ? aValue - bValue : bValue - aValue;
                 } else {
                     // Fallback for mixed types or other keys
                     const aStr = String(aValue).toLowerCase();
                     const bStr = String(bValue).toLowerCase();
                     return order === 'asc' ? aStr.localeCompare(bStr) : bStr.localeCompare(aStr);
                 }
             });
        }


        // --- Data Upload Modal ---
        const uploadModal = document.getElementById('uploadModal');
        const uploadDataButton = document.getElementById('uploadDataButton');
        const closeUploadModalButton = document.getElementById('closeUploadModal');
        const cancelUploadButton = document.getElementById('cancelUploadButton');
        const startUploadButton = document.getElementById('startUploadButton');
        const dataFilesInput = document.getElementById('dataFiles');
        const uploadProgressBarContainer = document.getElementById('uploadProgressBarContainer');
        const uploadProgressBar = document.getElementById('uploadProgressBar');
        const uploadStatusMessage = document.getElementById('uploadStatusMessage');
        const uploadedFileList = document.getElementById('uploadedFileList');
        const mappingPreview = document.getElementById('mappingPreview');
        const mappingTableBody = document.getElementById('mappingTableBody');
        const mappingStatusMessage = document.getElementById('mappingStatusMessage');
        const processMappedDataButton = document.getElementById('processMappedDataButton');


        uploadDataButton.addEventListener('click', () => {
            uploadModal.style.display = 'flex';
            uploadProgressBarContainer.style.display = 'none';
            uploadProgressBar.style.width = '0%';
            uploadProgressBar.setAttribute('aria-valuenow', '0');
            uploadStatusMessage.textContent = '';
            startUploadButton.disabled = true; // Disable until files are selected
            dataFilesInput.value = null; // Clear selected files
             uploadedRawData = []; // Clear previous upload data
             uploadedFileList.innerHTML = ''; // Clear file list
             mappingPreview.style.display = 'none'; // Hide mapping section
             mappingTableBody.innerHTML = '';
             mappingStatusMessage.textContent = '';
        });

        closeUploadModalButton.addEventListener('click', () => {
            uploadModal.style.display = 'none';
        });

        cancelUploadButton.addEventListener('click', () => {
            uploadModal.style.display = 'none';
        });

        dataFilesInput.addEventListener('change', () => {
            if (dataFilesInput.files.length > 0) {
                startUploadButton.disabled = false;
                 uploadStatusMessage.textContent = `${dataFilesInput.files.length} file(s) selected.`;
            } else {
                startUploadButton.disabled = true;
                 uploadStatusMessage.textContent = '';
            }
        });

        startUploadButton.addEventListener('click', () => {
            const files = dataFilesInput.files;
            if (files.length === 0) {
                uploadStatusMessage.textContent = 'Please select files to upload.';
                return;
            }

            uploadProgressBarContainer.style.display = 'block';
            uploadProgressBar.style.width = '0%';
            uploadProgressBar.setAttribute('aria-valuenow', '0');
            uploadStatusMessage.textContent = 'Uploading...';
            startUploadButton.disabled = true;
            cancelUploadButton.disabled = true; // Disable cancel during upload
            uploadedFileList.innerHTML = ''; // Clear previous list
             uploadedRawData = []; // Reset raw data storage

            // Simulate file upload and processing
            let processedCount = 0;
            const totalFiles = files.length;

            function processFile(file, index) {
                const fileItem = document.createElement('li');
                fileItem.classList.add('file-item');
                fileItem.textContent = file.name;
                const statusSpan = document.createElement('span');
                statusSpan.classList.add('status');
                fileItem.appendChild(statusSpan);
                uploadedFileList.appendChild(fileItem);


                uploadStatusMessage.textContent = `Processing file ${index + 1} of ${totalFiles}: ${file.name}...`;
                statusSpan.textContent = 'Processing...';
                statusSpan.classList.remove('error');


                if (file.name.toLowerCase().endsWith('.csv')) {
                     Papa.parse(file, {
                        header: true,
                        dynamicTyping: true,
                         skipEmptyLines: true,
                        complete: function(results) {
                            console.log(`Parsed ${file.name}:`, results.data);
                            uploadedRawData.push({ fileName: file.name, data: results.data, type: 'csv' });
                            statusSpan.textContent = 'Processed';
                            processedCount++;
                            updateUploadProgress();
                            if (processedCount === totalFiles) {
                                finishUploadProcess();
                            } else {
                                processFile(files[processedCount], processedCount); // Process next file
                            }
                        },
                        error: function(err) {
                            console.error(`Error parsing ${file.name}:`, err);
                            uploadStatusMessage.textContent = `Error processing ${file.name}.`;
                            statusSpan.textContent = 'Error';
                            statusSpan.classList.add('error');
                             processedCount++; // Still count as processed to continue
                             updateUploadProgress();
                             if (processedCount === totalFiles) {
                                finishUploadProcess();
                            } else {
                                processFile(files[processedCount], processedCount); // Process next file
                            }
                        }
                    });
                } else if (file.name.toLowerCase().endsWith('.xls') || file.name.toLowerCase().endsWith('.xlsx')) {
                    // Placeholder for Excel handling - requires a library like SheetJS
                    statusSpan.textContent = 'Processing (Excel placeholder)...';
                     uploadStatusMessage.textContent = `Excel file ${file.name} upload started (processing placeholder)...`;
                    setTimeout(() => {
                        console.log(`Simulated processing for Excel file: ${file.name}`);
                         // Simulate some placeholder data structure
                         uploadedRawData.push({ fileName: file.name, data: [{ ColA: 'Sample', ColB: 123 }], type: 'excel' });
                        statusSpan.textContent = 'Processed (Simulated)';
                        processedCount++;
                        updateUploadProgress();
                        if (processedCount === totalFiles) {
                            finishUploadProcess();
                        } else {
                             processFile(files[processedCount], processedCount); // Process next file
                        }
                    }, 1500); // Simulate delay for Excel processing
                } else {
                     statusSpan.textContent = 'Skipped (Unsupported type)';
                     uploadStatusMessage.textContent = `Skipping unsupported file type: ${file.name}`;
                     processedCount++;
                     updateUploadProgress();
                      if (processedCount === totalFiles) {
                            finishUploadProcess();
                        } else {
                             processFile(files[processedCount], processedCount); // Process next file
                        }
                }
            }

            function updateUploadProgress() {
                const progress = (processedCount / totalFiles) * 100;
                uploadProgressBar.style.width = progress + '%';
                uploadProgressBar.setAttribute('aria-valuenow', progress.toFixed(0));
            }

            function finishUploadProcess() {
                 uploadStatusMessage.textContent = `Upload and processing complete for ${totalFiles} file(s).`;
                 cancelUploadButton.disabled = false; // Re-enable cancel (now effectively a close)
                 startUploadButton.style.display = 'none'; // Hide upload button
                 // Proceed to mapping step if data was processed
                 if (uploadedRawData.length > 0) {
                     showMappingInterface(uploadedRawData);
                 } else {
                      mappingStatusMessage.textContent = 'No data processed successfully for mapping.';
                 }
            }

            // Start processing the first file
            if (totalFiles > 0) {
                processFile(files[0], 0);
            }
        });

        // Close modal if clicking outside
        window.addEventListener('click', (event) => {
            if (event.target === uploadModal) {
                uploadModal.style.display = 'none';
            }
        });


        // --- Data Mapping Interface ---
        function showMappingInterface(data) {
             // For simplicity, let's just show mapping for the first processed file
             if (data.length === 0 || data[0].data.length === 0) {
                 mappingStatusMessage.textContent = 'No data available to map.';
                 mappingPreview.style.display = 'none';
                 return;
             }

             const firstFileData = data[0].data;
             const sampleRow = firstFileData[0]; // Use the first data row to get columns
             const uploadedColumns = Object.keys(sampleRow);
             const standardKeys = Object.keys(standardSchema);

             mappingTableBody.innerHTML = ''; // Clear previous mapping rows

             uploadedColumns.forEach(col => {
                 const row = document.createElement('tr');
                 const colNameTd = document.createElement('td');
                 colNameTd.textContent = col;
                 row.appendChild(colNameTd);

                 const mapToTd = document.createElement('td');
                 const select = document.createElement('select');
                 select.setAttribute('aria-label', `Map column "${col}" to`);
                 select.innerHTML += '<option value="">-- Select Standard Field --</option>'; // Default option

                 standardKeys.forEach(key => {
                     const option = document.createElement('option');
                     option.value = key;
                     option.textContent = standardSchema[key];
                     // Attempt basic auto-mapping (case-insensitive, remove spaces)
                     if (col.toLowerCase().replace(/\s+/g, '') === key.toLowerCase().replace(/\s+/g, '')) {
                          option.selected = true;
                     }
                     select.appendChild(option);
                 });
                 mapToTd.appendChild(select);
                 row.appendChild(mapToTd);
                 mappingTableBody.appendChild(row);
             });

             mappingPreview.style.display = 'block';
             mappingStatusMessage.textContent = 'Review columns and map them to standard fields.';

             // Close upload modal automatically after showing mapping? Or let user close?
             // Let user close for now.
        }

        processMappedDataButton.addEventListener('click', () => {
             // Collect mapping from the table
             const mappingRows = mappingTableBody.querySelectorAll('tr');
             const currentMapping = {};
             mappingRows.forEach(row => {
                 const uploadedCol = row.cells[0].textContent.trim();
                 const mappedKey = row.cells[1].querySelector('select').value;
                 if (mappedKey) {
                     currentMapping[uploadedCol] = mappedKey;
                 }
             });

             console.log("Collected Mapping:", currentMapping);

             // Process the uploaded data using the mapping
             // For simplicity, process only the first uploaded file here
             if (uploadedRawData.length === 0 || uploadedRawData[0].data.length === 0) {
                  mappingStatusMessage.textContent = 'No data available to process.';
                  return;
             }

             const rawData = uploadedRawData[0].data;
             const processedData = rawData.map(row => {
                 const newRow = {};
                 for (const uploadedCol in currentMapping) {
                     const standardKey = currentMapping[uploadedCol];
                     let value = row[uploadedCol];

                     // Basic type conversion based on expected schema
                     if (['participants', 'cost'].includes(standardKey)) {
                         value = parseFloat(String(value).replace(/[^0-9.-]+/g,"")) || 0;
                     } else if (standardKey === 'impact') {
                         value = parseFloat(value) || 0;
                     } else if (standardKey.startsWith('demographic_')) {
                          value = parseInt(value) || 0;
                     } else if (standardKey === 'date') {
                         // Attempt to parse date
                         try {
                              value = new Date(value);
                              if (isNaN(value.getTime())) {
                                  value = null; // Invalid date
                              }
                         } catch (e) {
                             value = null; // Invalid date
                         }
                     }
                      // Handle demographic object structure
                      if (standardKey.startsWith('demographic_')) {
                          const demoKey = standardKey.replace('demographic_', '');
                          if (!newRow.demographic) newRow.demographic = {};
                          newRow.demographic[demoKey] = value;
                      } else {
                         newRow[standardKey] = value;
                      }
                 }
                 // Ensure required fields exist, maybe add defaults
                 if (!newRow.program) newRow.program = 'Unknown Program';
                 if (newRow.participants === undefined) newRow.participants = 0;
                 if (newRow.cost === undefined) newRow.cost = 0;
                 if (newRow.impact === undefined) newRow.impact = 0;
                 if (newRow.date === undefined || newRow.date === null) newRow.date = new Date(); // Default to today if no date mapped


                 return newRow;
             }).filter(item => item.program); // Filter out rows without a program name

             console.log("Processed Data:", processedData);

             // Add processed data to our main data store
             // In a real app, you'd merge or replace data based on context
             programData = [...programData, ...processedData]; // Append for demo

             mappingStatusMessage.textContent = `Successfully processed ${processedData.length} rows. Data added to analysis.`;
             processMappedDataButton.disabled = true; // Prevent reprocessing the same data

             // Update dashboard and charts with new data
             applyFilters();

             // Optionally, close the modal or show a success message
             // setTimeout(() => { uploadModal.style.display = 'none'; }, 2000);
        });


        // --- Reports Section (Placeholder) ---
        const generateReportButton = document.getElementById('generateReportButton');
        const reportStatusMessage = document.getElementById('reportStatusMessage');

        generateReportButton.addEventListener('click', () => {
            const reportType = document.getElementById('report-type').value;
            const reportFormat = document.getElementById('report-format').value;

            reportStatusMessage.textContent = `Generating "${reportType}" report in "${reportFormat}" format...`;
            generateReportButton.disabled = true;

            // Simulate report generation
            setTimeout(() => {
                console.log(`Simulated report generation: Type=${reportType}, Format=${reportFormat}`);
                 // In a real app, you'd use libraries (like jsPDF, SheetJS, etc.)
                 // to generate the report based on the *filtered* data.
                 const filteredData = getFilteredData();
                 console.log("Data for report:", filteredData);

                reportStatusMessage.textContent = `Report generated successfully! (Simulated)`;
                generateReportButton.disabled = false;
            }, 2000); // Simulate delay
        });


        // Initial filter application on load (with default values)
        applyFilters();


    </script>

</body>
</html>
