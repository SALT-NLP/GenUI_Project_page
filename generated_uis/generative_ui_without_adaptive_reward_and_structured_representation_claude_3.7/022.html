<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Marketing Analytics & Campaign Platform</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        :root {
            --primary-color: #007bff;
            --primary-color-dark: #0056b3;
            --secondary-color: #6c757d;
            --background-color: #f8f9fa;
            --surface-color: #ffffff;
            --text-color: #212529;
            --text-light-color: #6c757d;
            --border-color: #dee2e6;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --spacing-unit: 8px;
            --border-radius: 8px;
            --box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
             --focus-outline-color: rgba(0, 123, 255, 0.25);
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            min-height: 100vh;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        .material-symbols-rounded {
            font-variation-settings:
                'FILL' 0,
                'wght' 400,
                'GRAD' 0,
                'opsz' 24;
        }

        /* Layout */
        .app-container {
            display: grid;
            grid-template-areas:
                "sidebar header"
                "sidebar main";
            grid-template-columns: 250px 1fr;
            grid-template-rows: auto 1fr;
            width: 100%;
        }

        /* Sidebar Navigation */
        .sidebar {
            grid-area: sidebar;
            background-color: var(--surface-color);
            border-right: 1px solid var(--border-color);
            padding: calc(var(--spacing-unit) * 3) calc(var(--spacing-unit) * 2);
            display: flex;
            flex-direction: column;
            box-shadow: var(--box-shadow);
        }

        .sidebar-logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: calc(var(--spacing-unit) * 4);
            text-align: center;
        }

        .sidebar-nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-nav li {
            margin-bottom: var(--spacing-unit);
        }

        .sidebar-nav a {
            display: flex;
            align-items: center;
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 1.5);
            color: var(--text-color);
            text-decoration: none;
            border-radius: var(--border-radius);
            transition: background-color 0.2s ease, color 0.2s ease;
            outline: none; /* Remove default outline */
        }

        .sidebar-nav a .material-symbols-rounded {
            margin-right: var(--spacing-unit);
        }

        .sidebar-nav a:hover {
            background-color: var(--background-color);
        }

         .sidebar-nav a:focus {
            box-shadow: 0 0 0 0.2rem var(--focus-outline-color);
         }

        .sidebar-nav a.active {
            background-color: var(--primary-color);
            color: var(--surface-color);
            font-weight: 500;
        }

        .sidebar-nav a.active .material-symbols-rounded {
             font-variation-settings:
                'FILL' 1,
                'wght' 500,
                'GRAD' 0,
                'opsz' 24;
        }

        /* Header */
        .header {
            grid-area: header;
            background-color: var(--surface-color);
            padding: calc(var(--spacing-unit) * 2) calc(var(--spacing-unit) * 3);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--box-shadow);
            z-index: 100; /* Ensure header is above main content */
        }

        .header-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-color);
        }

        /* Main Content Area */
        .main-content {
            grid-area: main;
            padding: calc(var(--spacing-unit) * 3);
            overflow-y: auto; /* Enable scrolling for main content */
        }

        /* Card Component */
        .card {
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            padding: calc(var(--spacing-unit) * 3);
            margin-bottom: calc(var(--spacing-unit) * 3);
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
            position: relative; /* Needed for floating controls */
        }

        .card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: calc(var(--spacing-unit) * 2);
            padding-bottom: var(--spacing-unit);
            border-bottom: 1px solid var(--border-color);
        }

        .metric-card {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: var(--spacing-unit);
        }

        .metric-trend {
            font-size: 0.9rem;
            color: var(--text-light-color);
            display: flex;
            align-items: center;
        }

        .metric-trend .material-symbols-rounded {
            font-size: 1rem;
            margin-right: 4px;
        }

        .metric-trend.positive {
            color: var(--success-color);
        }

        .metric-trend.negative {
            color: var(--danger-color);
        }

        /* Dashboard Grid */
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: calc(var(--spacing-unit) * 3);
            margin-bottom: calc(var(--spacing-unit) * 3);
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 400px; /* Fixed height for charts */
        }

        /* Floating Controls for Charts */
        .floating-controls {
            position: absolute;
            top: calc(var(--spacing-unit) * 2);
            right: calc(var(--spacing-unit) * 2);
            background: rgba(255, 255, 255, 0.95);
            padding: calc(var(--spacing-unit) * 2);
            border-radius: var(--border-radius);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 50; /* Ensure controls are above chart canvas */
            min-width: 200px;
            border: 1px solid var(--border-color);
        }

        .floating-controls.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        .control-group {
            margin-bottom: calc(var(--spacing-unit) * 1.5);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-unit);
        }

        .control-group:last-child {
            margin-bottom: 0;
        }

        .control-group label {
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-light-color);
        }

        .control-group input[type="color"],
        .control-group input[type="number"],
        .control-group select {
            padding: var(--spacing-unit) 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            color: var(--text-color);
            background-color: var(--background-color);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            width: 100%;
            box-sizing: border-box; /* Include padding and border in element's total width and height */
        }

        .control-group input[type="color"] {
            padding: 6px; /* Adjust padding for color input */
            height: 40px;
        }

        .control-group input:focus,
        .control-group select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem var(--focus-outline-color);
        }

        /* Floating Control Toggle Button */
        .chart-controls-toggle {
            position: absolute;
            top: var(--spacing-unit);
            right: var(--spacing-unit);
            background: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-unit);
            cursor: pointer;
            z-index: 60; /* Above controls */
            box-shadow: var(--box-shadow);
            transition: background-color 0.2s ease, box-shadow 0.2s ease;
            outline: none;
        }

        .chart-controls-toggle:hover {
            background-color: var(--background-color);
        }
         .chart-controls-toggle:focus {
             box-shadow: 0 0 0 0.2rem var(--focus-outline-color);
         }

        /* Form Elements (for Segmentation/Campaigns) */
        .form-group {
            margin-bottom: calc(var(--spacing-unit) * 2);
        }

        .form-group label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-color);
            margin-bottom: var(--spacing-unit);
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="date"],
        .form-group select,
        .form-group textarea {
            display: block;
            width: 100%;
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 1.5);
            font-size: 1rem;
            line-height: 1.5;
            color: var(--text-color);
            background-color: var(--surface-color);
            background-clip: padding-box;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            box-sizing: border-box;
            outline: none;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem var(--focus-outline-color);
        }

        .form-group input.invalid,
        .form-group select.invalid,
        .form-group textarea.invalid {
            border-color: var(--danger-color);
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
        }


        /* Buttons */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 2);
            font-size: 1rem;
            font-weight: 500;
            text-align: center;
            text-decoration: none;
            vertical-align: middle;
            cursor: pointer;
            user-select: none;
            border: 1px solid transparent;
            border-radius: var(--border-radius);
            transition: color 0.15s ease-in-out, background-color 0.15s ease-in-out, border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
            outline: none;
        }

        .btn-primary {
            color: var(--surface-color);
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--primary-color-dark);
            border-color: var(--primary-color-dark);
        }
         .btn-primary:focus {
             box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.5);
         }

        .btn-secondary {
            color: var(--text-color);
            background-color: var(--background-color);
            border-color: var(--border-color);
        }

        .btn-secondary:hover {
            background-color: #e9ecef;
            border-color: #ced4da;
        }
         .btn-secondary:focus {
             box-shadow: 0 0 0 0.2rem rgba(108, 117, 125, 0.25);
         }


        .btn-ghost {
            color: var(--primary-color);
            background-color: transparent;
            border-color: transparent;
        }

        .btn-ghost:hover {
            background-color: rgba(0, 123, 255, 0.05);
        }
         .btn-ghost:focus {
             box-shadow: 0 0 0 0.2rem var(--focus-outline-color);
         }

        .btn-small {
            padding: calc(var(--spacing-unit) * 0.75) calc(var(--spacing-unit) * 1.5);
            font-size: 0.875rem;
        }


        .btn .material-symbols-rounded {
            margin-right: var(--spacing-unit);
        }

        /* Content Sections */
        .content-section {
            display: none; /* Hide by default */
             /* Add transition for smoother display if needed */
             /* transition: opacity 0.3s ease; */
             /* opacity: 0; */
        }

        .content-section.active {
            display: block; /* Show active section */
             /* opacity: 1; */
        }

        /* Segmentation Panel */
        .segmentation-layout {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: calc(var(--spacing-unit) * 3);
        }

        .filter-panel {
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            padding: calc(var(--spacing-unit) * 3);
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
        }

        .filter-panel .card-title {
            margin-top: 0;
        }

        .filter-group {
            margin-bottom: calc(var(--spacing-unit) * 3);
        }

        .filter-group-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: calc(var(--spacing-unit) * 1.5);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
             outline: none;
             padding: 2px; /* Add padding for focus outline */
             margin: -2px; /* Adjust margin to compensate padding */
        }

        .filter-group-title:focus {
             box-shadow: 0 0 0 0.2rem var(--focus-outline-color);
             border-radius: var(--border-radius); /* Add focus style */
        }

        .filter-group-title .material-symbols-rounded {
             transition: transform 0.2s ease;
        }

        .filter-group-title.collapsed .material-symbols-rounded {
             transform: rotate(-90deg);
        }

        .filter-group-content {
            display: block; /* Managed by max-height */
            overflow: hidden;
             transition: max-height 0.3s ease-in-out, margin-bottom 0.3s ease-in-out;
             max-height: 500px; /* Arbitrary large value */
             margin-bottom: 0; /* Default, will be set by JS on expand */
        }

        .filter-group-content.collapsed {
            max-height: 0;
             margin-bottom: 0 !important; /* Ensure margin is zero when collapsed */
        }

        /* Data Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: calc(var(--spacing-unit) * 2);
            overflow-x: auto; /* Enable horizontal scroll on small screens */
            display: block; /* Needed for overflow-x */
        }

        .data-table th,
        .data-table td {
            padding: calc(var(--spacing-unit) * 1.5);
            border-bottom: 1px solid var(--border-color);
            text-align: left;
             white-space: nowrap; /* Prevent text wrapping in cells */
        }

        .data-table th {
            background-color: var(--background-color);
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-color);
            cursor: pointer; /* Indicate sortable */
            transition: background-color 0.2s ease;
             position: sticky; /* Keep header visible on horizontal scroll */
             top: 0;
             z-index: 1;
        }

         .data-table th:hover {
            background-color: #e9ecef;
         }
         .data-table th:focus {
             outline: none;
             box-shadow: inset 0 0 0 0.2rem var(--focus-outline-color);
         }


         .data-table th .sort-indicator {
             font-size: 0.8em;
             margin-left: 4px;
             vertical-align: middle;
             display: inline-block; /* Prevent layout shift */
             width: 0.8em; /* Reserve space */
         }


        .data-table td {
            font-size: 0.9rem;
            color: var(--text-color);
        }

        .data-table tbody tr:hover {
            background-color: #f1f1f1;
        }

        /* Modal */
        .modal-overlay {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal-overlay.active {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background-color: var(--surface-color);
            padding: calc(var(--spacing-unit) * 4);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            max-width: 600px;
            width: 90%;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: calc(var(--spacing-unit) * 3);
            padding-bottom: var(--spacing-unit);
            border-bottom: 1px solid var(--border-color);
        }

        .modal-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-light-color);
            transition: color 0.2s ease;
             outline: none;
        }

        .modal-close:hover {
            color: var(--text-color);
        }
         .modal-close:focus {
             box-shadow: 0 0 0 0.2rem var(--focus-outline-color);
         }


        .modal-body {
            margin-bottom: calc(var(--spacing-unit) * 3);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-unit);
        }

        /* Loading Indicator */
        .loading-indicator {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            z-index: 10;
            justify-content: center;
            align-items: center;
            font-size: 1.2rem;
            color: var(--primary-color);
            border-radius: var(--border-radius);
            transition: opacity 0.3s ease;
             opacity: 0;
             pointer-events: none;
        }

        .loading-indicator.active {
            display: flex;
             opacity: 1;
             pointer-events: all;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .app-container {
                grid-template-areas:
                    "header"
                    "main";
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }

            .sidebar {
                display: none; /* Hide sidebar on smaller screens */
            }

            .segmentation-layout {
                 grid-template-columns: 1fr; /* Stack filter panel and results */
            }

            .filter-panel {
                 padding: calc(var(--spacing-unit) * 2); /* Reduce padding */
            }

            .main-content {
                 padding: calc(var(--spacing-unit) * 2); /* Reduce padding */
            }

             .card {
                 padding: calc(var(--spacing-unit) * 2); /* Reduce padding */
             }

             .dashboard-grid {
                 gap: calc(var(--spacing-unit) * 2); /* Reduce gap */
             }

             .modal-content {
                 padding: calc(var(--spacing-unit) * 3);
             }
        }

    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                MealKit Insights
            </div>
            <nav class="sidebar-nav">
                <ul>
                    <li><a href="#" data-section="dashboard" class="active" role="link" aria-label="Go to Dashboard"><span class="material-symbols-rounded" aria-hidden="true">dashboard</span> Dashboard</a></li>
                    <li><a href="#" data-section="segmentation" role="link" aria-label="Go to Segmentation"><span class="material-symbols-rounded" aria-hidden="true">group</span> Segmentation</a></li>
                    <li><a href="#" data-section="campaigns" role="link" aria-label="Go to Campaigns"><span class="material-symbols-rounded" aria-hidden="true">campaign</span> Campaigns</a></li>
                    <li><a href="#" data-section="analytics" role="link" aria-label="Go to Analytics"><span class="material-symbols-rounded" aria-hidden="true">analytics</span> Analytics</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Header -->
        <header class="header">
            <h1 class="header-title" id="current-page-title">Dashboard</h1>
            <!-- User/Account info could go here -->
        </header>

        <!-- Main Content Area -->
        <main class="main-content" role="main">

            <!-- Dashboard Section -->
            <section id="dashboard" class="content-section active" aria-labelledby="current-page-title">
                <h2>Executive Dashboard</h2>

                <div class="dashboard-grid">
                    <div class="card metric-card">
                        <h3 class="card-title">Customer Acquisition Cost (CAC)</h3>
                        <div class="metric-value">$55.30</div>
                        <div class="metric-trend negative" aria-label="5 percent decrease versus last month"><span class="material-symbols-rounded" aria-hidden="true">south_east</span> 5% vs last month</div>
                        <!-- Sparkline chart could go here -->
                    </div>
                    <div class="card metric-card">
                        <h3 class="card-title">Customer Lifetime Value (LTV)</h3>
                        <div class="metric-value">$320.50</div>
                        <div class="metric-trend positive" aria-label="3 percent increase versus last month"><span class="material-symbols-rounded" aria-hidden="true">north_east</span> 3% vs last month</div>
                         <!-- Sparkline chart could go here -->
                    </div>
                     <div class="card metric-card">
                        <h3 class="card-title">Conversion Rate</h3>
                        <div class="metric-value">4.2%</div>
                        <div class="metric-trend positive" aria-label="0.5 percent increase versus last month"><span class="material-symbols-rounded" aria-hidden="true">north_east</span> 0.5% vs last month</div>
                         <!-- Sparkline chart could go here -->
                    </div>
                     <div class="card metric-card">
                        <h3 class="card-title">Retention Rate (3-Month)</h3>
                        <div class="metric-value">68%</div>
                        <div class="metric-trend positive" aria-label="1 percent increase versus last month"><span class="material-symbols-rounded" aria-hidden="true">north_east</span> 1% vs last month</div>
                         <!-- Sparkline chart could go here -->
                    </div>
                </div>

                <div class="card">
                    <h3 class="card-title">CAC & LTV Trend Over Time</h3>
                     <div class="chart-container" id="cac-ltv-chart-container">
                         <button class="chart-controls-toggle" aria-label="Toggle chart controls"><span class="material-symbols-rounded">settings</span></button>
                        <canvas id="cacLtvChart" role="img" aria-label="Line chart showing CAC and LTV trend over time"></canvas>
                         <!-- Floating control panel -->
                        <div class="floating-controls" id="cac-ltv-chart-controls" aria-hidden="true">
                            <div class="control-group">
                                <label for="cac-ltv-chart-type">Chart Type</label>
                                <select id="cac-ltv-chart-type" aria-controls="cacLtvChart">
                                    <option value="line">Line</option>
                                    <option value="bar">Bar</option>
                                </select>
                            </div>
                             <div class="control-group">
                                <label for="cac-ltv-chart-cac-color">CAC Color</label>
                                <input type="color" id="cac-ltv-chart-cac-color" value="#dc3545" aria-controls="cacLtvChart">
                            </div>
                             <div class="control-group">
                                <label for="cac-ltv-chart-ltv-color">LTV Color</label>
                                <input type="color" id="cac-ltv-chart-ltv-color" value="#28a745" aria-controls="cacLtvChart">
                            </div>
                             <div class="control-group">
                                <label for="cac-ltv-chart-font-size">Font Size</label>
                                <input type="number" id="cac-ltv-chart-font-size" value="12" min="10" max="20" aria-controls="cacLtvChart">
                            </div>
                        </div>
                    </div>
                </div>

                 <div class="card">
                    <h3 class="card-title">Regional Performance (LTV vs CAC)</h3>
                     <div class="chart-container" id="regional-performance-chart-container">
                         <button class="chart-controls-toggle" aria-label="Toggle chart controls"><span class="material-symbols-rounded">settings</span></button>
                        <canvas id="regionalPerformanceChart" role="img" aria-label="Bar chart comparing LTV and CAC across different regions"></canvas>
                         <!-- Floating control panel -->
                        <div class="floating-controls" id="regional-performance-chart-controls" aria-hidden="true">
                            <div class="control-group">
                                <label for="regional-performance-chart-type">Chart Type</label>
                                <select id="regional-performance-chart-type" aria-controls="regionalPerformanceChart">
                                    <option value="bar">Bar</option>
                                    <option value="line">Line</option>
                                </select>
                            </div>
                             <div class="control-group">
                                <label for="regional-performance-chart-cac-color">CAC Color</label>
                                <input type="color" id="regional-performance-chart-cac-color" value="#dc3545" aria-controls="regionalPerformanceChart">
                            </div>
                             <div class="control-group">
                                <label for="regional-performance-chart-ltv-color">LTV Color</label>
                                <input type="color" id="regional-performance-chart-ltv-color" value="#28a745" aria-controls="regionalPerformanceChart">
                            </div>
                             <div class="control-group">
                                <label for="regional-performance-chart-font-size">Font Size</label>
                                <input type="number" id="regional-performance-chart-font-size" value="12" min="10" max="20" aria-controls="regionalPerformanceChart">
                            </div>
                        </div>
                    </div>
                </div>

                 <div class="card">
                    <h3 class="card-title">Conversion Funnel (Placeholder)</h3>
                     <div class="chart-container" id="conversion-funnel-chart-container">
                          <button class="chart-controls-toggle" aria-label="Toggle chart controls"><span class="material-symbols-rounded">settings</span></button>
                         <canvas id="conversionFunnelChart" role="img" aria-label="Placeholder for conversion funnel visualization"></canvas>
                         <div class="floating-controls" id="conversion-funnel-chart-controls" aria-hidden="true">
                             <p>Controls for Funnel Chart (Placeholder)</p>
                             <!-- Add relevant controls here -->
                         </div>
                     </div>
                 </div>

                 <div class="card">
                    <h3 class="card-title">Geographic Performance Heatmap (Placeholder)</h3>
                     <div class="chart-container" id="heatmap-chart-container">
                          <button class="chart-controls-toggle" aria-label="Toggle chart controls"><span class="material-symbols-rounded">settings</span></button>
                         <canvas id="heatmapChart" role="img" aria-label="Placeholder for geographic heatmap visualization"></canvas>
                          <div class="floating-controls" id="heatmap-chart-controls" aria-hidden="true">
                             <p>Controls for Heatmap Chart (Placeholder)</p>
                              <!-- Add relevant controls here -->
                         </div>
                     </div>
                 </div>


            </section>

            <!-- Segmentation Section -->
            <section id="segmentation" class="content-section" aria-labelledby="current-page-title">
                <h2>Customer Segmentation</h2>
                 <div class="segmentation-layout">
                     <div class="filter-panel">
                         <h3 class="card-title">Define Segment Criteria</h3>

                         <div class="filter-group">
                             <div class="filter-group-title" tabindex="0" role="button" aria-expanded="true" aria-controls="demographics-filter-content">Demographics <span class="material-symbols-rounded">expand_more</span></div>
                             <div id="demographics-filter-content" class="filter-group-content">
                                 <div class="form-group">
                                     <label for="segment-age">Age Range</label>
                                     <input type="text" id="segment-age" placeholder="e.g., 25-45" aria-label="Age Range">
                                 </div>
                                  <div class="form-group">
                                     <label for="segment-gender">Gender</label>
                                     <select id="segment-gender" aria-label="Gender filter">
                                         <option value="">Any</option>
                                         <option value="Male">Male</option>
                                         <option value="Female">Female</option>
                                         <option value="Other">Other</option>
                                     </select>
                                 </div>
                                  <div class="form-group">
                                     <label for="segment-location">Location (Metro Area)</label>
                                     <input type="text" id="segment-location" placeholder="e.g., New York, Los Angeles" aria-label="Location filter">
                                 </div>
                             </div>
                         </div>

                          <div class="filter-group">
                             <div class="filter-group-title collapsed" tabindex="0" role="button" aria-expanded="false" aria-controls="behavioral-filter-content">Behavioral <span class="material-symbols-rounded">expand_more</span></div>
                             <div id="behavioral-filter-content" class="filter-group-content collapsed">
                                 <div class="form-group">
                                     <label for="segment-frequency">Min Purchase Frequency (per month)</label>
                                     <input type="number" id="segment-frequency" min="0" placeholder="e.g., > 2" aria-label="Minimum Purchase Frequency filter">
                                 </div>
                                  <div class="form-group">
                                     <label for="segment-ltv">Min Lifetime Value ($)</label>
                                     <input type="number" id="segment-ltv" min="0" placeholder="e.g., > 100" aria-label="Minimum Lifetime Value filter">
                                 </div>
                                  <div class="form-group">
                                     <label for="segment-churn">Churn Risk</label>
                                     <select id="segment-churn" aria-label="Churn Risk filter">
                                         <option value="">Any</option>
                                         <option value="Low">Low</option>
                                         <option value="Medium">Medium</option>
                                         <option value="High">High</option>
                                     </select>
                                 </div>
                             </div>
                         </div>

                         <button class="btn btn-primary" id="find-customers-btn" aria-label="Find customers based on criteria"><span class="material-symbols-rounded" aria-hidden="true">search</span> Find Customers</button>
                          <div class="loading-indicator" id="segmentation-loading" aria-label="Loading segmentation results">Loading...</div>
                     </div>

                     <div class="segmentation-results">
                         <div class="card">
                             <h3 class="card-title">Segment Results (<span id="segment-count">0</span> Customers)</h3>
                             <table class="data-table" role="table" aria-label="Customer segmentation results">
                                 <thead>
                                     <tr>
                                         <th data-sort="id" scope="col" aria-sort="none" tabindex="0">Customer ID <span class="sort-indicator"></span></th>
                                         <th data-sort="age" scope="col" aria-sort="none" tabindex="0">Age <span class="sort-indicator"></span></th>
                                         <th data-sort="gender" scope="col" aria-sort="none" tabindex="0">Gender <span class="sort-indicator"></span></th>
                                         <th data-sort="location" scope="col" aria-sort="none" tabindex="0">Location <span class="sort-indicator"></span></th>
                                         <th data-sort="ltv" scope="col" aria-sort="none" tabindex="0">LTV <span class="sort-indicator"></span></th>
                                         <th data-sort="frequency" scope="col" aria-sort="none" tabindex="0">Frequency <span class="sort-indicator"></span></th>
                                     </tr>
                                 </thead>
                                 <tbody>
                                     <!-- Segment results will be loaded here -->
                                     <tr><td colspan="6" style="text-align: center;">Apply filters to see results</td></tr>
                                 </tbody>
                             </table>
                         </div>
                          <button class="btn btn-secondary" id="create-campaign-from-segment-btn" style="margin-top: calc(var(--spacing-unit) * 2); display: none;" aria-label="Create a new campaign targeting this segment"><span class="material-symbols-rounded" aria-hidden="true">campaign</span> Create Campaign from Segment</button>
                     </div>
                 </div>
            </section>

            <!-- Campaigns Section -->
            <section id="campaigns" class="content-section" aria-labelledby="current-page-title">
                <h2>Campaign Management</h2>
                 <div class="card">
                     <h3 class="card-title">Campaigns</h3>
                     <button class="btn btn-primary" id="create-campaign-btn" style="margin-bottom: calc(var(--spacing-unit) * 2);" aria-label="Create a new marketing campaign"><span class="material-symbols-rounded" aria-hidden="true">add</span> Create New Campaign</button>
                     <div class="loading-indicator" id="campaigns-loading" aria-label="Loading campaigns">Loading...</div>

                     <table class="data-table" role="table" aria-label="List of marketing campaigns">
                         <thead>
                             <tr>
                                 <th data-sort="name" scope="col" aria-sort="none" tabindex="0">Campaign Name <span class="sort-indicator"></span></th>
                                 <th data-sort="segment" scope="col" aria-sort="none" tabindex="0">Segment <span class="sort-indicator"></span></th>
                                 <th data-sort="status" scope="col" aria-sort="none" tabindex="0">Status <span class="sort-indicator"></span></th>
                                 <th data-sort="startDate" scope="col" aria-sort="none" tabindex="0">Start Date <span class="sort-indicator"></span></th>
                                 <th data-sort="endDate" scope="col" aria-sort="none" tabindex="0">End Date <span class="sort-indicator"></span></th>
                                 <th scope="col">Actions</th>
                             </tr>
                         </thead>
                         <tbody>
                             <!-- Campaign list will be loaded here -->
                             <tr>
                                 <td>Welcome Series - New York</td>
                                 <td>New York Signups</td>
                                 <td>Active</td>
                                 <td>2023-10-01</td>
                                 <td>2023-12-31</td>
                                 <td>
                                     <button class="btn btn-ghost btn-small" aria-label="Edit campaign"><span class="material-symbols-rounded" aria-hidden="true">edit</span></button>
                                     <button class="btn btn-ghost btn-small" aria-label="View campaign details"><span class="material-symbols-rounded" aria-hidden="true">visibility</span></button>
                                 </td>
                             </tr>
                             <tr>
                                 <td>High LTV Retention - LA</td>
                                 <td>LA High LTV</td>
                                 <td>Draft</td>
                                 <td>-</td>
                                 <td>-</td>
                                 <td>
                                     <button class="btn btn-ghost btn-small" aria-label="Edit campaign"><span class="material-symbols-rounded" aria-hidden="true">edit</span></button>
                                     <button class="btn btn-ghost btn-small" aria-label="View campaign details"><span class="material-symbols-rounded" aria-hidden="true">visibility</span></button>
                                 </td>
                             </tr>
                         </tbody>
                     </table>
                 </div>
            </section>

            <!-- Analytics Section -->
            <section id="analytics" class="content-section" aria-labelledby="current-page-title">
                <h2>Performance Analytics & Reporting</h2>
                 <div class="card">
                     <h3 class="card-title">Campaign Performance Overview</h3>
                      <div class="loading-indicator" id="analytics-loading" aria-label="Loading analytics data">Loading...</div>
                      <table class="data-table" role="table" aria-label="Campaign performance overview data">
                         <thead>
                             <tr>
                                 <th data-sort="name" scope="col" aria-sort="none" tabindex="0">Campaign Name <span class="sort-indicator"></span></th>
                                 <th data-sort="sent" scope="col" aria-sort="none" tabindex="0">Sent <span class="sort-indicator"></span></th>
                                 <th data-sort="opened" scope="col" aria-sort="none" tabindex="0">Opened <span class="sort-indicator"></span></th>
                                 <th data-sort="clicked" scope="col" aria-sort="none" tabindex="0">Clicked <span class="sort-indicator"></span></th>
                                 <th data-sort="converted" scope="col" aria-sort="none" tabindex="0">Converted <span class="sort-indicator"></span></th>
                                 <th data-sort="conversionRate" scope="col" aria-sort="none" tabindex="0">Conversion Rate <span class="sort-indicator"></span></th>
                                 <th data-sort="revenue" scope="col" aria-sort="none" tabindex="0">Revenue <span class="sort-indicator"></span></th>
                                 <th data-sort="roi" scope="col" aria-sort="none" tabindex="0">ROI <span class="sort-indicator"></span></th>
                             </tr>
                         </thead>
                         <tbody>
                             <!-- Campaign performance data will be loaded here -->
                             <tr>
                                 <td>Welcome Series - New York</td>
                                 <td>10,500</td>
                                 <td>7,800</td>
                                 <td>1,200</td>
                                 <td>450</td>
                                 <td>4.3%</td>
                                 <td>$25,000</td>
                                 <td>+150%</td>
                             </tr>
                             <tr>
                                 <td>High LTV Retention - LA</td>
                                 <td>5,200</td>
                                 <td>4,000</td>
                                 <td>800</td>
                                 <td>300</td>
                                 <td>5.8%</td>
                                 <td>$35,000</td>
                                 <td>+200%</td>
                             </tr>
                         </tbody>
                     </table>
                 </div>
                  <div class="card">
                    <h3 class="card-title">Cohort Analysis (Retention)</h3>
                     <div class="chart-container" id="cohort-chart-container">
                          <button class="chart-controls-toggle" aria-label="Toggle chart controls"><span class="material-symbols-rounded">settings</span></button>
                        <canvas id="cohortChart" role="img" aria-label="Line chart showing customer retention rates by acquisition cohort"></canvas>
                         <div class="floating-controls" id="cohort-chart-controls" aria-hidden="true">
                            <div class="control-group">
                                <label for="cohort-chart-type">Chart Type</label>
                                <select id="cohort-chart-type" aria-controls="cohortChart">
                                    <option value="line">Line</option>
                                    <option value="bar">Bar</option>
                                </select>
                            </div>
                             <div class="control-group">
                                <label for="cohort-chart-font-size">Font Size</label>
                                <input type="number" id="cohort-chart-font-size" value="12" min="10" max="20" aria-controls="cohortChart">
                            </div>
                             <!-- Add color pickers for cohorts if needed -->
                        </div>
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- Modal for Creating/Editing Campaign -->
    <div id="campaignModal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title" aria-hidden="true" tabindex="-1">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="modal-title">Create New Campaign</h3>
                <button class="modal-close" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-body">
                <form id="campaign-form">
                    <div class="form-group">
                        <label for="campaign-name">Campaign Name</label>
                        <input type="text" id="campaign-name" required aria-required="true">
                    </div>
                     <div class="form-group">
                        <label for="campaign-segment">Target Segment</label>
                        <select id="campaign-segment" required aria-required="true">
                            <option value="">Select a segment</option>
                            <!-- Options populated from Segmentation -->
                            <option value="segment-1">New York Signups</option>
                            <option value="segment-2">LA High LTV</option>
                             <option value="segment-3">Recent Segment (5 Customers)</option> <!-- Example of segment from results -->
                        </select>
                    </div>
                     <div class="form-group">
                        <label for="campaign-type">Campaign Type</label>
                        <select id="campaign-type" required aria-required="true">
                            <option value="">Select type</option>
                            <option value="email">Email</option>
                            <option value="sms">SMS</option>
                            <option value="push">Push Notification</option>
                        </select>
                    </div>
                     <div class="form-group">
                        <label for="campaign-start-date">Start Date</label>
                        <input type="date" id="campaign-start-date">
                    </div>
                     <div class="form-group">
                        <label for="campaign-end-date">End Date (Optional)</label>
                        <input type="date" id="campaign-end-date">
                    </div>
                     <div class="form-group">
                        <label for="campaign-message">Message Content</label>
                        <textarea id="campaign-message" rows="5" required aria-required="true"></textarea>
                    </div>
                </form>
                 <div class="loading-indicator" id="modal-loading" aria-label="Saving campaign">Saving...</div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary modal-close" aria-label="Cancel campaign creation">Cancel</button>
                <button class="btn btn-primary" id="save-campaign-btn" aria-label="Save campaign">Save Campaign</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { Chart } from "https://esm.sh/chart.js/auto";

        // --- Navigation Logic ---
        const navLinks = document.querySelectorAll('.sidebar-nav a');
        const contentSections = document.querySelectorAll('.content-section');
        const pageTitle = document.getElementById('current-page-title');

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetSectionId = link.dataset.section;

                // Update active link
                navLinks.forEach(nav => nav.classList.remove('active'));
                link.classList.add('active');

                // Show target section, hide others
                contentSections.forEach(section => {
                    if (section.id === targetSectionId) {
                        section.classList.add('active');
                        section.setAttribute('aria-hidden', 'false');
                    } else {
                        section.classList.remove('active');
                         section.setAttribute('aria-hidden', 'true');
                    }
                });

                // Update header title
                pageTitle.textContent = link.textContent.trim();

                // Trigger chart redraw if needed (e.g., when switching back to dashboard)
                 // Use a small delay to ensure canvas is visible before drawing
                 setTimeout(() => {
                     if (targetSectionId === 'dashboard') {
                         if (cacLtvChart) cacLtvChart.resize(); // Use resize instead of update for layout changes
                         if (regionalPerformanceChart) regionalPerformanceChart.resize();
                         // if (conversionFunnelChart) conversionFunnelChart.resize(); // Uncomment if implemented
                         // if (heatmapChart) heatmapChart.resize(); // Uncomment if implemented
                     } else if (targetSectionId === 'analytics') {
                         if (cohortChart) cohortChart.resize();
                     }
                 }, 100); // Small delay to allow section to become visible and layout to settle
            });
        });

        // --- Chart Initialization and Interaction ---

        let cacLtvChart = null;
        let regionalPerformanceChart = null;
        let cohortChart = null;
        // let conversionFunnelChart = null; // Placeholder
        // let heatmapChart = null; // Placeholder

        // Helper to get CSS variable value
        function getCssVariable(name) {
            return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
        }

        // Function to initialize a chart with floating controls
        function initializeChart(canvasId, controlsId, config) {
            const ctx = document.getElementById(canvasId)?.getContext('2d');
            if (!ctx) return null; // Return null if canvas element doesn't exist

            const chart = new Chart(ctx, config);
            const controls = document.getElementById(controlsId);
            const chartContainer = document.getElementById(canvasId).closest('.card');
             const controlsToggle = chartContainer.querySelector('.chart-controls-toggle');

             if (controlsToggle && controls) {
                 controlsToggle.addEventListener('click', () => {
                     const isHidden = controls.classList.contains('active'); // Check active class
                     controls.classList.toggle('active');
                     controls.setAttribute('aria-hidden', isHidden); // Set aria-hidden based on *new* state
                 });

                 // Close controls when clicking outside the container or controls
                 document.addEventListener('click', (e) => {
                     // Check if the click is outside the card containing the chart and controls
                     if (controls.classList.contains('active') && !chartContainer.contains(e.target)) {
                         controls.classList.remove('active');
                         controls.setAttribute('aria-hidden', 'true');
                     }
                 });

                  // Prevent click inside controls from closing the panel
                 controls.addEventListener('click', (e) => {
                     e.stopPropagation();
                 });
             }


            // Add event listeners for controls
            controls?.querySelectorAll('input, select').forEach(element => {
                element.addEventListener('change', () => updateChartFromControls(chart, controlsId));
            });

            return chart;
        }

        // Function to update chart based on controls
        function updateChartFromControls(chart, controlsId) {
            const controls = document.getElementById(controlsId);
            if (!chart || !controls) return;

            const chartTypeSelect = controls.querySelector('select[id$="-chart-type"]');
            const fontSizeInput = controls.querySelector('input[id$="-chart-font-size"]');

            if (chartTypeSelect) {
                chart.config.type = chartTypeSelect.value;
            }

            // Handle dataset specific colors
            const colorInputs = controls.querySelectorAll('input[type="color"]');
            colorInputs.forEach(input => {
                 // Extract dataset label from input ID (e.g., cac-ltv-chart-cac-color -> 'cac')
                 const idParts = input.id.split('-');
                 const datasetLabel = idParts[idParts.length - 2]; // Assumes ID format chartName-chart-datasetLabel-color

                 const dataset = chart.data.datasets.find(ds => ds.label.toLowerCase().includes(datasetLabel));

                 if (dataset) {
                     dataset.backgroundColor = input.value;
                     dataset.borderColor = input.value; // Often border matches fill in flat design
                 }
            });


            if (fontSizeInput) {
                const newFontSize = parseInt(fontSizeInput.value);
                 if (!isNaN(newFontSize)) {
                     const updateFont = (obj) => {
                         if (obj?.font) {
                             obj.font.size = newFontSize;
                         } else { // Handle cases where font object might not exist but we can add it
                              obj.font = { size: newFontSize, family: 'Inter, sans-serif' };
                         }
                     };

                     // Update font sizes in various chart elements
                     if (chart.options.plugins && chart.options.plugins.legend && chart.options.plugins.legend.labels) {
                         updateFont(chart.options.plugins.legend.labels);
                     }
                      if (chart.options.plugins && chart.options.plugins.tooltip) {
                           if (chart.options.plugins.tooltip.bodyFont) updateFont(chart.options.plugins.tooltip.bodyFont);
                           if (chart.options.plugins.tooltip.titleFont) updateFont(chart.options.plugins.tooltip.titleFont);
                       }
                     if (chart.options.scales) {
                         Object.values(chart.options.scales).forEach(scale => {
                             if (scale.ticks) updateFont(scale.ticks);
                             if (scale.title && scale.title.font) updateFont(scale.title);
                         });
                     }
                 }
            }

            chart.update(); // Update the chart to reflect changes
        }


        // CAC & LTV Trend Chart
        const cacLtvConfig = {
            type: 'line',
            data: {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct'],
                datasets: [
                    {
                        label: 'CAC',
                        data: [60, 58, 59, 57, 56, 55, 57, 58, 56, 55.30],
                        borderColor: getCssVariable('--danger-color'), // Use CSS variable value
                        backgroundColor: 'rgba(220, 53, 69, 0.2)', // Use rgba for fill
                        fill: true,
                        tension: 0.1,
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: getCssVariable('--danger-color')
                    },
                    {
                        label: 'LTV',
                        data: [280, 290, 295, 300, 305, 310, 308, 315, 318, 320.50],
                        borderColor: getCssVariable('--success-color'), // Use CSS variable value
                        backgroundColor: 'rgba(40, 167, 69, 0.2)', // Use rgba for fill
                        fill: true,
                        tension: 0.1,
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: getCssVariable('--success-color')
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                             font: { size: 12, family: 'Inter, sans-serif' },
                             usePointStyle: true,
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        bodyFont: { family: 'Inter, sans-serif' },
                        titleFont: { family: 'Inter, sans-serif', weight: 'bold' },
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (context.parsed.y !== null) label += '$' + context.parsed.y.toFixed(2);
                                return label;
                            }
                        }
                    },
                },
                scales: {
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Value ($)',
                             font: { size: 12, family: 'Inter, sans-serif' }
                        },
                         ticks: {
                             font: { size: 12, family: 'Inter, sans-serif' },
                             callback: function(value) { return '$' + value; }
                         }
                    },
                     x: {
                        title: {
                            display: true,
                            text: 'Month',
                            font: { size: 12, family: 'Inter, sans-serif' }
                        },
                         ticks: { font: { size: 12, family: 'Inter, sans-serif' } }
                    }
                }
            }
        };

        // Regional Performance Chart
        const regionalPerformanceConfig = {
            type: 'bar',
            data: {
                labels: ['New York', 'Los Angeles', 'Chicago', 'Dallas', 'Miami'],
                datasets: [
                    {
                        label: 'CAC',
                        data: [65, 58, 55, 62, 70],
                        backgroundColor: getCssVariable('--danger-color'), // Use CSS variable value
                        borderColor: getCssVariable('--danger-color'), // Use CSS variable value
                        borderWidth: 1
                    },
                     {
                        label: 'LTV',
                        data: [350, 380, 320, 300, 280],
                        backgroundColor: getCssVariable('--success-color'), // Use CSS variable value
                        borderColor: getCssVariable('--success-color'), // Use CSS variable value
                        borderWidth: 1
                    }
                ]
            },
             options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                         labels: {
                             font: { size: 12, family: 'Inter, sans-serif' },
                             usePointStyle: true,
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        bodyFont: { family: 'Inter, sans-serif' },
                        titleFont: { family: 'Inter, sans-serif', weight: 'bold' },
                         callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) label += ': ';
                                if (context.parsed.y !== null) label += '$' + context.parsed.y.toFixed(2);
                                return label;
                            }
                        }
                    },
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'Value ($)',
                             font: { size: 12, family: 'Inter, sans-serif' }
                        },
                         ticks: {
                             font: { size: 12, family: 'Inter, sans-serif' },
                             callback: function(value) { return '$' + value; }
                         }
                    },
                     x: {
                        title: {
                            display: true,
                            text: 'Region',
                            font: { size: 12, family: 'Inter, sans-serif' }
                        },
                         ticks: { font: { size: 12, family: 'Inter, sans-serif' } }
                    }
                }
            }
        };

        // Cohort Analysis Chart (Placeholder)
        const cohortConfig = {
             type: 'line',
             data: {
                 labels: ['Month 0', 'Month 1', 'Month 2', 'Month 3', 'Month 4', 'Month 5'],
                 datasets: [
                     {
                         label: 'Cohort 2023-01',
                         data: [100, 85, 78, 72, 68, 65],
                         borderColor: '#4e79a7',
                         backgroundColor: 'rgba(78, 121, 167, 0.2)',
                         fill: false,
                         tension: 0.1,
                          pointRadius: 4,
                          pointBackgroundColor: '#4e79a7'
                     },
                      {
                         label: 'Cohort 2023-02',
                         data: [100, 88, 80, 75, 70, 68],
                         borderColor: '#f28e2c',
                         backgroundColor: 'rgba(242, 142, 44, 0.2)',
                         fill: false,
                         tension: 0.1,
                          pointRadius: 4,
                          pointBackgroundColor: '#f28e2c'
                     },
                      {
                         label: 'Cohort 2023-03',
                         data: [100, 82, 75, 68, 65, 60],
                         borderColor: '#e15759',
                         backgroundColor: 'rgba(225, 87, 89, 0.2)',
                         fill: false,
                         tension: 0.1,
                          pointRadius: 4,
                          pointBackgroundColor: '#e15759'
                     }
                 ]
             },
             options: {
                 responsive: true,
                 maintainAspectRatio: false,
                 plugins: {
                     legend: {
                         position: 'top',
                          labels: {
                             font: { size: 12, family: 'Inter, sans-serif' },
                             usePointStyle: true,
                        }
                     },
                     tooltip: {
                         mode: 'index',
                         intersect: false,
                         bodyFont: { family: 'Inter, sans-serif' },
                         titleFont: { family: 'Inter, sans-serif', weight: 'bold' },
                         callbacks: {
                             label: function(context) {
                                 let label = context.dataset.label || '';
                                 if (label) label += ': ';
                                 if (context.parsed.y !== null) label += context.parsed.y.toFixed(1) + '%';
                                 return label;
                             }
                         }
                     },
                 },
                 scales: {
                     y: {
                         beginAtZero: true,
                         title: {
                             display: true,
                             text: 'Retention Rate (%)',
                             font: { size: 12, family: 'Inter, sans-serif' }
                         },
                          ticks: {
                              font: { size: 12, family: 'Inter, sans-serif' },
                              callback: function(value) { return value + '%'; }
                          },
                         max: 100
                     },
                      x: {
                         title: {
                             display: true,
                             text: 'Months Since Acquisition',
                             font: { size: 12, family: 'Inter, sans-serif' }
                         },
                          ticks: { font: { size: 12, family: 'Inter, sans-serif' } }
                     }
                 }
             }
        };

        // Placeholder config for other charts
         const placeholderChartConfig = {
             type: 'bar', // Default placeholder type
             data: { labels: [], datasets: [] },
             options: { responsive: true, maintainAspectRatio: false }
         };


        // Initialize charts when the dashboard section is active (or on page load)
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Dashboard charts
            cacLtvChart = initializeChart('cacLtvChart', 'cac-ltv-chart-controls', cacLtvConfig);
            regionalPerformanceChart = initializeChart('regionalPerformanceChart', 'regional-performance-chart-controls', regionalPerformanceConfig);
             // conversionFunnelChart = initializeChart('conversionFunnelChart', 'conversion-funnel-chart-controls', placeholderChartConfig); // Placeholder init
             // heatmapChart = initializeChart('heatmapChart', 'heatmap-chart-controls', placeholderChartConfig); // Placeholder init


             // Initialize Analytics charts (will be hidden initially)
             cohortChart = initializeChart('cohortChart', 'cohort-chart-controls', cohortConfig);

        });

        // --- Segmentation Logic ---
        const filterGroupTitles = document.querySelectorAll('.filter-group-title');
        filterGroupTitles.forEach(title => {
             title.addEventListener('click', () => toggleFilterGroup(title));
             title.addEventListener('keypress', (e) => {
                 if (e.key === 'Enter' || e.key === ' ') {
                     e.preventDefault();
                     toggleFilterGroup(title);
                 }
             });
        });

        function toggleFilterGroup(title) {
             const content = title.nextElementSibling;
             const isCollapsed = title.classList.toggle('collapsed');
             content.classList.toggle('collapsed');
             title.setAttribute('aria-expanded', !isCollapsed);
             content.setAttribute('aria-hidden', isCollapsed);

             // Set max-height for transition
             if (!isCollapsed) {
                 content.style.maxHeight = content.scrollHeight + 'px';
                 // Add a small delay before removing max-height to allow transition to complete
                 content.addEventListener('transitionend', function handler() {
                      content.style.maxHeight = 'none'; // Allow content to take natural height
                      content.removeEventListener('transitionend', handler);
                 });
             } else {
                  // When collapsing, set max-height to current height before setting to 0
                  content.style.maxHeight = content.scrollHeight + 'px';
                  // Use a timeout to allow the browser to register the height before transitioning
                  requestAnimationFrame(() => {
                       content.style.maxHeight = '0';
                  });
             }
        }


        const findCustomersBtn = document.getElementById('find-customers-btn');
        const segmentResultsTableBody = document.querySelector('#segmentation .data-table tbody');
        const segmentCountSpan = document.getElementById('segment-count');
        const createCampaignFromSegmentBtn = document.getElementById('create-campaign-from-segment-btn');
        const segmentationLoadingIndicator = document.getElementById('segmentation-loading');
        const segmentTableHeaders = document.querySelectorAll('#segmentation .data-table th[data-sort]');

        let currentSegmentResults = []; // Store current results for sorting

        findCustomersBtn.addEventListener('click', () => {
            segmentationLoadingIndicator.classList.add('active');
            // Simulate fetching data based on filters with a delay
            setTimeout(() => {
                const age = document.getElementById('segment-age').value;
                const gender = document.getElementById('segment-gender').value;
                const location = document.getElementById('segment-location').value;
                const frequency = document.getElementById('segment-frequency').value;
                const ltv = document.getElementById('segment-ltv').value;
                const churn = document.getElementById('segment-churn').value;

                // Dummy data based on filters (replace with actual data fetching)
                const dummyResults = [
                    { id: 101, age: 32, gender: 'Female', location: 'New York', ltv: 450, frequency: 3 },
                    { id: 105, age: 28, gender: 'Male', location: 'New York', ltv: 380, frequency: 2 },
                    { id: 112, age: 40, gender: 'Female', location: 'New York', ltv: 510, frequency: 4 },
                     { id: 205, age: 35, gender: 'Male', location: 'Los Angeles', ltv: 600, frequency: 5 },
                    { id: 210, age: 29, gender: 'Female', location: 'Los Angeles', ltv: 490, frequency: 3 },
                     { id: 301, age: 45, gender: 'Other', location: 'Chicago', ltv: 310, frequency: 1 },
                     { id: 405, age: 22, gender: 'Female', location: 'Dallas', ltv: 250, frequency: 2 },
                ].filter(customer => {
                    let match = true;
                    if (age) {
                        const [min, max] = age.split('-').map(Number);
                        if (!isNaN(min) && customer.age < min) match = false;
                        if (!isNaN(max) && customer.age > max) match = false;
                         if (isNaN(min) && isNaN(max)) match = false; // If input is not a valid range
                    }
                    if (gender && gender !== '' && customer.gender !== gender) match = false;
                    if (location && !customer.location.toLowerCase().includes(location.toLowerCase())) match = false;
                    if (frequency && customer.frequency < Number(frequency)) match = false;
                    if (ltv && customer.ltv < Number(ltv)) match = false;
                    if (churn && churn !== '' && customer.churn !== churn) match = false; // Churn filter is dummy for now, assuming data has a 'churn' property
                    return match;
                });

                currentSegmentResults = dummyResults; // Store results
                renderSegmentTable(currentSegmentResults); // Render initial results

                segmentationLoadingIndicator.classList.remove('active');
            }, 1000); // Simulate network delay
        });

        function renderSegmentTable(results) {
             segmentResultsTableBody.innerHTML = ''; // Clear existing rows
            if (results.length > 0) {
                results.forEach(customer => {
                    const row = `
                        <tr>
                            <td>${customer.id}</td>
                            <td>${customer.age}</td>
                            <td>${customer.gender}</td>
                            <td>${customer.location}</td>
                            <td>$${customer.ltv.toFixed(2)}</td>
                            <td>${customer.frequency}</td>
                        </tr>
                    `;
                    segmentResultsTableBody.innerHTML += row;
                });
                 createCampaignFromSegmentBtn.style.display = 'inline-flex'; // Show button
            } else {
                segmentResultsTableBody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No customers found matching criteria.</td></tr>';
                 createCampaignFromSegmentBtn.style.display = 'none'; // Hide button
            }
            segmentCountSpan.textContent = results.length;
        }

        // Table Sorting
        function getCellValue(row, key) {
             const cellIndex = Array.from(row.parentElement.querySelector('tr').children).findIndex(th => th.dataset.sort === key);
             if (cellIndex === -1) return null; // Key not found
             const cell = row.children[cellIndex];
             if (!cell) return null;

             const text = cell.textContent.trim();

             // Handle specific data types for sorting
             if (key === 'id' || key === 'age' || key === 'frequency') {
                 return parseInt(text);
             }
             if (key === 'ltv' || key === 'revenue') {
                 return parseFloat(text.replace('$', '').replace(',', ''));
             }
              if (key === 'conversionRate' || key === 'roi') {
                  return parseFloat(text.replace('%', '').replace('+', ''));
              }
              if (key === 'sent' || key === 'opened' || key === 'clicked' || key === 'converted') {
                  return parseInt(text.replace(',', ''));
              }
             // For dates, convert to Date objects
             if (key.includes('Date')) {
                 return text === '-' ? new Date(0) : new Date(text); // Treat '-' as epoch start for sorting
             }
             return text; // Default to string sort
         }


        function sortTable(tableBody, headers, dataKey) {
             const header = headers.find(h => h.dataset.sort === dataKey);
             if (!header) return;

             const currentSort = header.getAttribute('aria-sort');
             let direction = 'ascending';

             if (currentSort === 'ascending') {
                 direction = 'descending';
             } else if (currentSort === 'descending') {
                 direction = 'none'; // Reset sort
             }

             // Reset all headers in this table
             headers.forEach(h => {
                 h.setAttribute('aria-sort', 'none');
                 h.querySelector('.sort-indicator').textContent = '';
             });

             // Update current header
             header.setAttribute('aria-sort', direction);
              if (direction !== 'none') {
                  header.querySelector('.sort-indicator').textContent = direction === 'ascending' ? ' ▲' : ' ▼';
              }

             const rows = Array.from(tableBody.querySelectorAll('tr'));

             if (direction !== 'none') {
                 rows.sort((rowA, rowB) => {
                     const valueA = getCellValue(rowA, dataKey);
                     const valueB = getCellValue(rowB, dataKey);

                     if (valueA === null || valueB === null) return 0; // Handle missing cells

                     // Compare based on type (simple numeric/date vs string)
                     if (typeof valueA === 'number' && typeof valueB === 'number') {
                         return direction === 'ascending' ? valueA - valueB : valueB - valueA;
                     }
                      if (valueA instanceof Date && valueB instanceof Date) {
                           return direction === 'ascending' ? valueA.getTime() - valueB.getTime() : valueB.getTime() - valueA.getTime();
                      }
                     // Default to localeCompare for strings
                     return direction === 'ascending' ? String(valueA).localeCompare(String(valueB)) : String(valueB).localeCompare(String(valueA));
                 });
             } else {
                  // If resetting sort, ideally return to original order
                  // This simple implementation doesn't store original order, so it just stays as last sorted
             }

             // Re-append sorted rows
             rows.forEach(row => tableBody.appendChild(row));
        }

        segmentTableHeaders.forEach(header => {
            header.addEventListener('click', () => {
                sortTable(header.closest('table').querySelector('tbody'), segmentTableHeaders, header.dataset.sort);
            });
             header.addEventListener('keypress', (e) => {
                 if (e.key === 'Enter' || e.key === ' ') {
                     e.preventDefault();
                     sortTable(header.closest('table').querySelector('tbody'), segmentTableHeaders, header.dataset.sort);
                 }
             });
        });

         const campaignTableHeaders = document.querySelectorAll('#campaigns .data-table th[data-sort]');
         const analyticsTableHeaders = document.querySelectorAll('#analytics .data-table th[data-sort]');


         campaignTableHeaders.forEach(header => {
            header.addEventListener('click', () => {
                sortTable(header.closest('table').querySelector('tbody'), campaignTableHeaders, header.dataset.sort);
            });
             header.addEventListener('keypress', (e) => {
                 if (e.key === 'Enter' || e.key === ' ') {
                     e.preventDefault();
                     sortTable(header.closest('table').querySelector('tbody'), campaignTableHeaders, header.dataset.sort);
                 }
             });
        });

         analyticsTableHeaders.forEach(header => {
            header.addEventListener('click', () => {
                sortTable(header.closest('table').querySelector('tbody'), analyticsTableHeaders, header.dataset.sort);
            });
             header.addEventListener('keypress', (e) => {
                 if (e.key === 'Enter' || e.key === ' ') {
                     e.preventDefault();
                     sortTable(header.closest('table').querySelector('tbody'), analyticsTableHeaders, header.dataset.sort);
                 }
             });
        });


        // --- Campaign Modal Logic ---
        const campaignModal = document.getElementById('campaignModal');
        const createCampaignBtn = document.getElementById('create-campaign-btn');
        const modalCloseBtns = campaignModal.querySelectorAll('.modal-close');
        const campaignForm = document.getElementById('campaign-form');
        const saveCampaignBtn = document.getElementById('save-campaign-btn');
        const modalLoadingIndicator = document.getElementById('modal-loading');
        const campaignSegmentSelect = document.getElementById('campaign-segment');


        function openModal() {
            campaignModal.classList.add('active');
             campaignModal.setAttribute('aria-hidden', 'false');
             // Set focus to the first interactive element in the modal
             campaignModal.querySelector('input, select, textarea, button:not(.modal-close)')?.focus();
             populateSegmentDropdown(); // Populate segments when opening modal
        }

        function closeModal() {
            campaignModal.classList.remove('active');
             campaignModal.setAttribute('aria-hidden', 'true');
             // Reset form and remove validation messages
            campaignForm.reset();
             campaignForm.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(input => {
                 input.classList.remove('invalid');
             });
        }

        function populateSegmentDropdown() {
            // Clear existing options except the default
            campaignSegmentSelect.innerHTML = '<option value="">Select a segment</option>';

            // Add segments from the last segmentation search results (if any)
            if (currentSegmentResults.length > 0) {
                 const segmentName = `Recent Segment (${currentSegmentResults.length} Customers)`;
                 const option = document.createElement('option');
                 option.value = 'recent-segment'; // Use a unique value
                 option.textContent = segmentName;
                 campaignSegmentSelect.appendChild(option);
            }

             // Add other predefined segments (example)
             const predefinedSegments = [
                 { value: 'segment-1', name: 'New York Signups' },
                 { value: 'segment-2', name: 'LA High LTV' },
             ];

             predefinedSegments.forEach(seg => {
                 // Avoid adding duplicates if the recent segment matches a predefined one
                 if (campaignSegmentSelect.querySelector(`option[value="${seg.value}"]`)) return;
                 const option = document.createElement('option');
                 option.value = seg.value;
                 option.textContent = seg.name;
                 campaignSegmentSelect.appendChild(option);
             });
        }


        createCampaignBtn.addEventListener('click', openModal);
        createCampaignFromSegmentBtn.addEventListener('click', openModal); // Also opens modal from segmentation results

        modalCloseBtns.forEach(btn => btn.addEventListener('click', closeModal));

        // Close modal when clicking outside the modal content
        campaignModal.addEventListener('click', (e) => {
            if (e.target === campaignModal) {
                closeModal();
            }
        });

        // Trap focus within the modal
        campaignModal.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeModal();
                return; // Exit to prevent further handling
            }
            // Basic focus trap (needs more robust implementation for full accessibility)
            const focusableElements = campaignModal.querySelectorAll('button:not([disabled]), [href]:not([disabled]), input:not([disabled]), select:not([disabled]), textarea:not([disabled]), [tabindex]:not([tabindex="-1"])');
            const firstFocusable = focusableElements[0];
            const lastFocusable = focusableElements[focusableElements.length - 1];

            if (e.key === 'Tab') {
                if (e.shiftKey) { // Shift + Tab
                    if (document.activeElement === firstFocusable) {
                        lastFocusable.focus();
                        e.preventDefault();
                    }
                } else { // Tab
                    if (document.activeElement === lastFocusable) {
                        firstFocusable.focus();
                        e.preventDefault();
                    }
                }
            }
        });


        // Save Campaign (Placeholder)
        saveCampaignBtn.addEventListener('click', (e) => {
            e.preventDefault();
            // Remove previous invalid states
             campaignForm.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(input => {
                 input.classList.remove('invalid');
             });

            if (campaignForm.checkValidity()) {
                modalLoadingIndicator.classList.add('active');
                console.log('Saving campaign...');
                // Simulate saving data with a delay
                setTimeout(() => {
                    const campaignData = {
                        name: document.getElementById('campaign-name').value,
                        segment: document.getElementById('campaign-segment').value,
                        type: document.getElementById('campaign-type').value,
                        startDate: document.getElementById('campaign-start-date').value,
                        endDate: document.getElementById('campaign-end-date').value,
                        message: document.getElementById('campaign-message').value,
                    };
                    console.log('Campaign Data:', campaignData);
                    // In a real app, you'd send this data to the backend
                    alert('Campaign saved! (Simulated)'); // Replace with actual success feedback
                    modalLoadingIndicator.classList.remove('active');
                    closeModal();
                }, 1500); // Simulate network delay
            } else {
                // Add invalid state to elements that failed validation
                 campaignForm.querySelectorAll(':invalid').forEach(input => {
                     input.classList.add('invalid');
                 });
                campaignForm.reportValidity(); // Show browser validation errors (tooltips)
            }
        });


    </script>
</body>
</html>
