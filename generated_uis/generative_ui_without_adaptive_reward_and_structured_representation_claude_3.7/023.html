<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recommendation System Dashboard</title>
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        :root {
            --primary-color: #007bff;
            --primary-dark: #0056b3;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --background-color: #f8f9fa;
            --surface-color: #ffffff;
            --text-color: #343a40;
            --text-light: #6c757d;
            --border-color: #dee2e6;
            --shadow-color: rgba(0, 0, 0, 0.08);
            --spacing-unit: 8px;
            --border-radius: 8px;
            --transition-duration: 0.2s;
            --focus-outline-color: rgba(0, 123, 255, 0.5);
            /* Primary color with transparency */
            --focus-outline-width: 2px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            min-height: 100vh;
            overflow-y: auto;
            font-size: 16px;
            /* Base font size for desktop */
        }

        /* Skip to main content link for accessibility */
        .skip-to-main {
            position: absolute;
            top: -40px;
            left: 0;
            background-color: var(--primary-color);
            color: var(--surface-color);
            padding: var(--spacing-unit);
            z-index: 1000;
            text-decoration: none;
            transition: top var(--transition-duration) ease-in-out;
            outline-offset: 2px;
        }

        .skip-to-main:focus {
            top: 0;
            outline: var(--focus-outline-width) solid var(--focus-outline-color);
        }


        .sidebar {
            width: 250px;
            background-color: var(--surface-color);
            padding: var(--spacing-unit) 0;
            box-shadow: 2px 0 5px var(--shadow-color);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            transition: width var(--transition-duration) ease-in-out;
        }

        .sidebar-header {
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 2);
            font-size: 1.2em;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: calc(var(--spacing-unit) * 2);
            white-space: nowrap;
            /* Prevent wrapping when sidebar collapses */
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .sidebar-nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar-nav li {
            margin-bottom: var(--spacing-unit);
        }

        .sidebar-nav a {
            display: flex;
            align-items: center;
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 2);
            color: var(--text-color);
            text-decoration: none;
            transition: background-color var(--transition-duration) ease, color var(--transition-duration) ease, border-left-color var(--transition-duration) ease;
            border-left: 4px solid transparent;
            outline-offset: -2px;
            /* Keep outline inside element */
        }

        .sidebar-nav a:hover {
            background-color: #e9ecef;
            color: var(--primary-dark);
        }

        .sidebar-nav a:focus {
            outline: var(--focus-outline-width) solid var(--focus-outline-color);
            background-color: #e9ecef;
            /* Match hover for consistency */
        }

        .sidebar-nav a.active {
            background-color: var(--primary-color);
            color: var(--surface-color);
            border-left-color: var(--primary-dark);
        }

        .sidebar-nav a.active:focus {
            outline: var(--focus-outline-width) solid var(--focus-outline-color);
            background-color: var(--primary-dark);
            /* Darker primary on focus */
        }


        .sidebar-nav a .material-symbols-rounded {
            margin-right: var(--spacing-unit);
            font-size: 20px;
            flex-shrink: 0;
            /* Prevent icon from shrinking */
        }

        .sidebar-nav a span:not(.material-symbols-rounded) {
            white-space: nowrap;
            /* Prevent text wrapping */
            overflow: hidden;
            text-overflow: ellipsis;
            transition: opacity var(--transition-duration) ease;
        }

        .main-content {
            flex-grow: 1;
            padding: calc(var(--spacing-unit) * 3);
            overflow-y: auto;
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h1,
        h2,
        h3 {
            color: var(--text-color);
            margin-bottom: calc(var(--spacing-unit) * 2);
        }

        h1 {
            font-size: 2em;
        }

        h2 {
            font-size: 1.5em;
        }

        h3 {
            font-size: 1.2em;
        }

        .card {
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            padding: calc(var(--spacing-unit) * 2);
            box-shadow: 0 2px 5px var(--shadow-color);
            margin-bottom: calc(var(--spacing-unit) * 3);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: calc(var(--spacing-unit) * 3);
            margin-bottom: calc(var(--spacing-unit) * 3);
        }

        .metric-card {
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            padding: calc(var(--spacing-unit) * 2);
            box-shadow: 0 2px 5px var(--shadow-color);
            text-align: center;
            transition: transform var(--transition-duration) ease, box-shadow var(--transition-duration) ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
            outline-offset: 4px;
            /* Outline outside shadow */
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 10px var(--shadow-color);
        }

        .metric-card:focus {
            outline: var(--focus-outline-width) solid var(--focus-outline-color);
        }


        .metric-card .label {
            font-size: 0.9em;
            color: var(--text-light);
            margin-bottom: var(--spacing-unit);
        }

        .metric-card .value {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-color);
        }

        .metric-card .trend {
            font-size: 0.8em;
            margin-top: var(--spacing-unit);
        }

        .metric-card .trend.positive {
            color: var(--success-color);
        }

        .metric-card .trend.negative {
            color: var(--danger-color);
        }

        .metric-card .trend.neutral {
            color: var(--text-light);
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-bottom: calc(var(--spacing-unit) * 3);
            cursor: pointer;
            /* Indicate clickable area for controls */
        }

        .floating-controls {
            position: absolute;
            top: var(--spacing-unit);
            right: var(--spacing-unit);
            background: rgba(255, 255, 255, 0.95);
            padding: calc(var(--spacing-unit) * 1.5);
            border-radius: var(--border-radius);
            box-shadow: 0 2px 8px var(--shadow-color);
            opacity: 0;
            transform: translateY(-10px);
            transition: all var(--transition-duration) ease;
            pointer-events: none;
            z-index: 10;
            min-width: 200px;
            /* Give controls some minimum width */
            max-height: calc(100% - var(--spacing-unit) * 2);
            /* Prevent overflow */
            overflow-y: auto;
            /* Add scroll if controls are too tall */
        }

        .floating-controls.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        .control-group {
            margin: var(--spacing-unit) 0;
            display: flex;
            align-items: flex-start;
            gap: var(--spacing-unit);
            flex-direction: column;
        }

        .control-group label {
            font-size: 0.9em;
            color: var(--text-color);
            font-weight: bold;
        }

        .control-group input[type="color"],
        .control-group input[type="date"],
        .control-group input[type="number"],
        .control-group select,
        .control-group input[type="text"],
        .control-group textarea {
            padding: var(--spacing-unit);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            width: 100%;
            box-sizing: border-box;
            font-size: 0.9em;
            transition: border-color var(--transition-duration) ease;
            outline-offset: 2px;
        }

        .control-group input:focus,
        .control-group select:focus,
        .control-group textarea:focus {
            border-color: var(--primary-color);
            outline: var(--focus-outline-width) solid var(--focus-outline-color);
        }

        button {
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 2);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1em;
            transition: background-color var(--transition-duration) ease, opacity var(--transition-duration) ease, transform var(--transition-duration) ease, box-shadow var(--transition-duration) ease;
            outline-offset: 2px;
        }

        button.primary {
            background-color: var(--primary-color);
            color: var(--surface-color);
        }

        button.secondary {
            background-color: var(--secondary-color);
            color: var(--surface-color);
        }

        button.danger {
            background-color: var(--danger-color);
            color: var(--surface-color);
        }

        button:hover:not(:disabled) {
            opacity: 0.9;
            transform: translateY(-1px);
            box-shadow: 0 1px 3px var(--shadow-color);
        }

        button:focus:not(:disabled) {
            outline: var(--focus-outline-width) solid var(--focus-outline-color);
        }


        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            opacity: 0.7;
            transform: none;
            box-shadow: none;
        }

        .btn-group {
            display: flex;
            gap: var(--spacing-unit);
            margin-top: calc(var(--spacing-unit) * 2);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: calc(var(--spacing-unit) * 2);
        }

        th,
        td {
            padding: calc(var(--spacing-unit) * 1.5);
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: #e9ecef;
            font-weight: bold;
            color: var(--text-color);
        }

        tbody tr:hover {
            background-color: #f1f3f5;
        }

        tbody tr:focus-within {
            /* Highlight row if interactive element inside is focused */
            background-color: #f1f3f5;
            outline: var(--focus-outline-width) solid var(--focus-outline-color);
            outline-offset: -1px;
        }


        .table-actions button {
            padding: var(--spacing-unit);
            font-size: 0.9em;
            margin-right: var(--spacing-unit);
            /* Space between buttons */
        }

        .table-actions button:last-child {
            margin-right: 0;
        }


        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.4);
            align-items: center;
            justify-content: center;
            animation: fadeInModal var(--transition-duration) ease-out;
            padding: var(--spacing-unit);
            /* Add padding for small screens */
            box-sizing: border-box;
        }

        .modal.active {
            display: flex;
        }

        @keyframes fadeInModal {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .modal-content {
            background-color: var(--surface-color);
            margin: auto;
            padding: calc(var(--spacing-unit) * 3);
            border-radius: var(--border-radius);
            box-shadow: 0 4px 8px var(--shadow-color);
            width: 90%;
            max-width: 700px;
            position: relative;
            animation: slideInModal var(--transition-duration) ease-out;
            box-sizing: border-box;
            outline: none;
            /* Remove default outline, manage focus manually */
        }

        @keyframes slideInModal {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .close-button {
            position: absolute;
            top: var(--spacing-unit);
            right: var(--spacing-unit);
            font-size: 24px;
            font-weight: bold;
            color: var(--text-light);
            cursor: pointer;
            transition: color var(--transition-duration) ease;
            background: none;
            /* Make it a button */
            border: none;
            padding: var(--spacing-unit);
            line-height: 1;
            border-radius: var(--border-radius);
            /* Make it a larger click target */
            outline-offset: 2px;
        }

        .close-button:hover {
            color: var(--text-color);
        }

        .close-button:focus {
            outline: var(--focus-outline-width) solid var(--focus-outline-color);
            background-color: #e9ecef;
            /* Subtle background on focus */
        }


        .form-group {
            margin-bottom: calc(var(--spacing-unit) * 2);
        }

        .form-group label {
            display: block;
            margin-bottom: var(--spacing-unit);
            font-weight: bold;
            color: var(--text-color);
        }

        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group input[type="password"],
        .form-group input[type="date"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: var(--spacing-unit);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color var(--transition-duration) ease;
            outline-offset: 2px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary-color);
            outline: var(--focus-outline-width) solid var(--focus-outline-color);
        }


        .form-group textarea {
            min-height: 150px;
            resize: vertical;
        }

        .form-group .form-text {
            font-size: 0.8em;
            color: var(--text-light);
            margin-top: var(--spacing-unit);
            display: block;
            /* Ensure it's on its own line */
        }

        .form-group.invalid input,
        .form-group.invalid select,
        .form-group.invalid textarea {
            border-color: var(--danger-color);
        }

        .form-group .error-message {
            color: var(--danger-color);
            font-size: 0.8em;
            margin-top: var(--spacing-unit);
            display: none;
            /* Hidden by default */
        }

        .form-group.invalid .error-message {
            display: block;
        }

        .form-group input[type="checkbox"]+label {
            display: inline-block;
            /* Allow label to sit next to checkbox */
            margin-bottom: 0;
            font-weight: normal;
            cursor: pointer;
            margin-left: var(--spacing-unit);
        }

        .form-group input[type="checkbox"] {
            margin-right: 0;
            /* Reset default margin */
            vertical-align: middle;
            /* Align checkbox with text */
            cursor: pointer;
            outline-offset: 2px;
        }

        .form-group input[type="checkbox"]:focus {
            outline: var(--focus-outline-width) solid var(--focus-outline-color);
        }

        .form-group .checkbox-group-error {
            color: var(--danger-color);
            font-size: 0.8em;
            margin-top: var(--spacing-unit);
            display: none;
            /* Hidden by default */
        }

        .form-group.invalid .checkbox-group-error {
            display: block;
        }


        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-unit);
            margin-top: calc(var(--spacing-unit) * 3);
        }

        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: calc(var(--spacing-unit) * 3);
            gap: calc(var(--spacing-unit) * 2);
        }

        .step-indicator .step {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--text-light);
            transition: background-color var(--transition-duration) ease, color var(--transition-duration) ease;
        }

        .step-indicator .step.active {
            background-color: var(--primary-color);
            color: var(--surface-color);
        }

        .step-content {
            display: none;
        }

        .step-content.active {
            display: block;
        }

        .loading-indicator {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 101;
            width: 40px;
            height: 40px;
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-indicator.active {
            display: block;
        }

        @keyframes spin {
            0% {
                transform: translate(-50%, -50%) rotate(0deg);
            }

            100% {
                transform: translate(-50%, -50%) rotate(360deg);
            }
        }

        .toast-notification {
            display: none;
            position: fixed;
            bottom: calc(var(--spacing-unit) * 3);
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--text-color);
            color: var(--surface-color);
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 2);
            border-radius: var(--border-radius);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            z-index: 102;
            opacity: 0;
            transition: opacity var(--transition-duration) ease-in-out;
            min-width: 200px;
            text-align: center;
        }

        .toast-notification.active {
            display: block;
            opacity: 1;
        }

        .toast-notification.success {
            background-color: var(--success-color);
        }

        .toast-notification.danger {
            background-color: var(--danger-color);
        }

        .toast-notification.warning {
            background-color: var(--warning-color);
            color: var(--text-color);
        }

        .toast-notification.info {
            background-color: var(--info-color);
        }


        .tooltip {
            position: absolute;
            background-color: var(--text-color);
            color: var(--surface-color);
            padding: var(--spacing-unit);
            border-radius: var(--border-radius);
            font-size: 0.8em;
            z-index: 50;
            pointer-events: none;
            opacity: 0;
            transition: opacity var(--transition-duration) ease-in-out;
            bottom: 100%;
            /* Position above element */
            left: 50%;
            transform: translateX(-50%);
            white-space: nowrap;
            /* Prevent text wrapping */
            margin-bottom: var(--spacing-unit);
            /* Space between element and tooltip */
        }

        /* Example for tooltip on metric card */
        .metric-card:hover .tooltip,
        .metric-card:focus .tooltip {
            /* Add focus state */
            opacity: 1;
        }

        /* Placeholder for drag-and-drop list */
        .drag-list {
            list-style: none;
            padding: 0;
            margin: 0;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden;
            /* Contains rounded corners */
        }

        .drag-list-item {
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 2);
            border-bottom: 1px solid var(--border-color);
            background-color: var(--surface-color);
            cursor: grab;
            transition: background-color var(--transition-duration) ease, transform var(--transition-duration) ease;
            display: flex;
            /* Use flex for content alignment */
            align-items: center;
            justify-content: space-between;
            outline-offset: -1px;
            /* Keep outline inside border */
        }

        .drag-list-item:last-child {
            border-bottom: none;
        }

        .drag-list-item:hover {
            background-color: #f1f3f5;
        }

        .drag-list-item:focus {
            /* Add focus state */
            outline: var(--focus-outline-width) solid var(--focus-outline-color);
        }


        .drag-list-item.dragging {
            opacity: 0.5;
            background-color: #e9ecef;
            transform: scale(1.02);
            /* Subtle visual lift */
        }

        .strategy-type-card {
            background-color: var(--surface-color);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: calc(var(--spacing-unit)*2);
            text-align: center;
            cursor: pointer;
            transition: background-color var(--transition-duration) ease, border-color var(--transition-duration) ease, box-shadow var(--transition-duration) ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 120px;
            /* Ensure consistent height */
            outline-offset: 4px;
        }

        .strategy-type-card:hover {
            background-color: #f1f3f5;
            border-color: var(--primary-color);
            box-shadow: 0 1px 4px var(--shadow-color);
        }

        .strategy-type-card:focus {
            outline: var(--focus-outline-width) solid var(--focus-outline-color);
        }

        .strategy-type-card.active {
            background-color: var(--primary-color);
            color: var(--surface-color);
            border-color: var(--primary-dark);
            box-shadow: 0 2px 6px rgba(0, 123, 255, 0.3);
            /* Primary colored shadow */
        }

        .strategy-type-card.active .material-symbols-rounded {
            color: var(--surface-color);
            /* Icon color matches card text */
        }

        .strategy-type-card.active div,
        .strategy-type-card.active small {
            color: var(--surface-color);
            /* Text color matches card text */
        }

        .strategy-type-card .material-symbols-rounded {
            font-size: 40px;
            color: var(--primary-color);
            transition: color var(--transition-duration) ease;
        }

        .strategy-type-card small {
            color: var(--text-light);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .sidebar {
                width: 60px;
                align-items: center;
            }

            .sidebar-header {
                display: none;
            }

            .sidebar-nav a {
                justify-content: center;
                padding: var(--spacing-unit);
                border-left: none;
                border-bottom: 4px solid transparent;
            }

            .sidebar-nav a.active {
                border-left-color: transparent;
                border-bottom-color: var(--primary-dark);
            }

            .sidebar-nav a .material-symbols-rounded {
                margin-right: 0;
            }

            .sidebar-nav a span:not(.material-symbols-rounded) {
                display: none;
            }

            .main-content {
                padding: calc(var(--spacing-unit) * 2);
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                padding: calc(var(--spacing-unit) * 2);
            }

            h1 {
                font-size: 1.8em;
            }

            h2 {
                font-size: 1.3em;
            }

            h3 {
                font-size: 1.1em;
            }

            .floating-controls {
                max-height: unset;
                /* Allow full height on small screens */
                position: static;
                /* Position static on small screens */
                transform: none;
                opacity: 1;
                pointer-events: all;
                box-shadow: none;
                background: none;
                padding: 0;
                margin-top: calc(var(--spacing-unit) * 2);
            }

            .floating-controls .control-group {
                flex-direction: row;
                align-items: center;
                justify-content: space-between;
                gap: var(--spacing-unit);
            }

            .floating-controls .control-group label {
                flex-shrink: 0;
                width: auto;
            }

            .floating-controls .control-group input,
            .floating-controls .control-group select,
            .floating-controls .control-group textarea {
                width: auto;
                flex-grow: 1;
            }

        }

        /* Add this to the stylesheet section around line 577, before the responsive adjustments */
        /* Material Symbols icons styling */
        .material-symbols-rounded {
            color: var(--primary-color);
        }

        /* Special color handling for already styled components */
        .sidebar-nav a.active .material-symbols-rounded {
            color: var(--surface-color);
            /* White icon for active nav items */
        }

        /* For already colored strategy cards, ensure the color changes when active */
        .strategy-type-card.active .material-symbols-rounded {
            color: var(--surface-color);
            /* White icon for active strategy card */
        }

        /* For sidebar hover state, ensure icon color changes too */
        .sidebar-nav a:hover .material-symbols-rounded {
            color: var(--primary-dark);
        }

        /* Set metric card icon size */
        .metric-card .material-symbols-rounded {
            font-size: 36px;
            margin-bottom: var(--spacing-unit);
        }
    </style>
</head>

<body>

    <a href="#main-content" class="skip-to-main">Skip to main content</a>

    <aside class="sidebar">
        <div class="sidebar-header">RecSystem Admin</div>
        <nav class="sidebar-nav">
            <ul>
                <li><a href="#dashboard" class="nav-link active" data-section="dashboard" aria-current="page"><span
                            class="material-symbols-rounded" aria-hidden="true">dashboard</span>
                        <span>Dashboard</span></a></li>
                <li><a href="#strategies" class="nav-link" data-section="strategies"><span
                            class="material-symbols-rounded" aria-hidden="true">settings</span>
                        <span>Strategies</span></a></li>
                <li><a href="#datasources" class="nav-link" data-section="datasources"><span
                            class="material-symbols-rounded" aria-hidden="true">database</span> <span>Data
                            Sources</span></a></li>
                <li><a href="#abtesting" class="nav-link" data-section="abtesting"><span
                            class="material-symbols-rounded" aria-hidden="true">science</span> <span>A/B
                            Testing</span></a></li>
                <li><a href="#reports" class="nav-link" data-section="reports"><span class="material-symbols-rounded"
                            aria-hidden="true">bar_chart</span> <span>Reports</span></a></li>
            </ul>
        </nav>
    </aside>

    <main class="main-content" id="main-content">
        <section id="dashboard" class="section active">
            <h1>Dashboard</h1>
            <div class="dashboard-grid">
                <div class="metric-card" tabindex="0" role="region" aria-label="Recommendation Conversion Rate Metric">
                    <div class="label">Recommendation Conversion Rate</div>
                    <div class="value">3.45%</div>
                    <div class="trend positive">↑ 0.2% vs last week</div>
                    <div class="tooltip" role="tooltip">Conversion rate for users who interacted with recommendations.
                    </div>
                </div>
                <div class="metric-card" tabindex="0" role="region" aria-label="Average Order Value Lift Metric">
                    <div class="label">Average Order Value (AOV) Lift</div>
                    <div class="value">$15.20</div>
                    <div class="trend positive">↑ $1.50 vs last week</div>
                    <div class="tooltip" role="tooltip">Increase in AOV for orders including recommended items.</div>
                </div>
                <div class="metric-card" tabindex="0" role="region" aria-label="Click-Through Rate Metric">
                    <div class="label">Click-Through Rate (CTR)</div>
                    <div class="value">8.1%</div>
                    <div class="trend neutral">→ 0% vs last week</div>
                    <div class="tooltip" role="tooltip">Percentage of users who clicked on a recommendation.</div>
                </div>
                <div class="metric-card" tabindex="0" role="region"
                    aria-label="Items Added from Recommendations Metric">
                    <span class="material-symbols-rounded" aria-hidden="true">shopping_cart</span>
                    <div class="label">Items Added from Recs</div>
                    <div class="value">1,245</div>
                    <div class="trend positive">↑ 15% vs last week</div>
                    <div class="tooltip" role="tooltip">Number of items added to cart directly from recommendations.
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Performance Over Time</h2>
                <div class="chart-container" role="img" aria-label="Performance over time chart">
                    <canvas id="performanceChart"></canvas>
                    <div class="floating-controls" id="performanceChartControls"
                        aria-label="Performance Chart Controls">
                        <div class="control-group">
                            <label for="performanceChartType">Chart Type</label>
                            <select id="performanceChartType" aria-controls="performanceChart">
                                <option value="line">Line</option>
                                <option value="bar">Bar</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label for="performanceMetricSelect">Metric</label>
                            <select id="performanceMetricSelect" aria-controls="performanceChart">
                                <option value="conversion">Conversion Rate</option>
                                <option value="aov">AOV Lift</option>
                                <option value="ctr">CTR</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label for="performanceTimeframe">Timeframe</label>
                            <select id="performanceTimeframe" aria-controls="performanceChart">
                                <option value="week">Last 7 Days</option>
                                <option value="month">Last 30 Days</option>
                                <option value="quarter">Last 90 Days</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2>Strategy Distribution</h2>
                <div class="chart-container" style="height: 300px;" role="img" aria-label="Strategy distribution chart">
                    <canvas id="distributionChart"></canvas>
                    <div class="floating-controls" id="distributionChartControls"
                        aria-label="Strategy Distribution Chart Controls">
                        <div class="control-group">
                            <label for="distributionChartType">Chart Type</label>
                            <select id="distributionChartType" aria-controls="distributionChart">
                                <option value="pie">Pie</option>
                                <option value="doughnut">Doughnut</option>
                                <option value="bar">Bar</option>
                            </select>
                        </div>
                        <div class="control-group">
                            <label for="distributionMetricSelect">Metric</label>
                            <select id="distributionMetricSelect" aria-controls="distributionChart">
                                <option value="served">Recommendations Served</option>
                                <option value="clicks">Clicks</option>
                                <option value="conversions">Conversions</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

        </section>

        <section id="strategies" class="section">
            <h1>Recommendation Strategies</h1>
            <div class="card">
                <button class="primary" id="addStrategyBtn">Add New Strategy</button>
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Status</th>
                            <th>Performance Metric</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="strategiesTableBody">
                        <!-- Rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>

            <div class="card">
                <h2>Strategy Prioritization</h2>
                <p>Drag and drop or use Space/Enter and arrow keys to reorder the priority of strategies when multiple
                    apply.</p>
                <ul class="drag-list" id="strategyPriorityList" role="listbox" aria-label="Strategy Priority List">
                    <!-- List items will be populated by JavaScript -->
                </ul>
            </div>
        </section>

        <section id="datasources" class="section">
            <h1>Data Sources</h1>
            <div class="card">
                <button class="primary" id="addDataSourceBtn">Add New Data Source</button>
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Connection Status</th>
                            <th>Last Updated</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="dataSourcesTableBody">
                        <!-- Rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="modal" id="dataSourceModal" role="dialog" aria-modal="true"
                aria-labelledby="dataSourceModalTitle" tabindex="-1">
                <div class="modal-content" tabindex="0">
                    <button class="close-button" aria-label="Close Data Source Modal">&times;</button>
                    <h2 id="dataSourceModalTitle">Add Data Source</h2>
                    <div class="form-group">
                        <label for="dsName">Data Source Name</label>
                        <input type="text" id="dsName" placeholder="e.g., Product Database" required
                            aria-describedby="dsNameError">
                        <span class="error-message" id="dsNameError" aria-live="polite">Data Source Name is
                            required.</span>
                    </div>
                    <div class="form-group">
                        <label for="dsType">Database Type</label>
                        <select id="dsType" required aria-describedby="dsTypeError">
                            <option value="">Select Type</option>
                            <option value="mysql">MySQL</option>
                            <option value="postgres">PostgreSQL</option>
                            <option value="sqlserver">SQL Server</option>
                            <option value="other">Other</option>
                        </select>
                        <span class="error-message" id="dsTypeError" aria-live="polite">Database Type is
                            required.</span>
                    </div>
                    <div class="form-group">
                        <label for="dsHost">Host</label>
                        <input type="text" id="dsHost" placeholder="e.g., your.database.server.com" required
                            aria-describedby="dsHostError">
                        <span class="error-message" id="dsHostError" aria-live="polite">Host is required.</span>
                    </div>
                    <div class="form-group">
                        <label for="dsPort">Port</label>
                        <input type="number" id="dsPort" placeholder="e.g., 3306" aria-describedby="dsPortError">
                        <span class="error-message" id="dsPortError" aria-live="polite">Invalid port number.</span>
                    </div>
                    <div class="form-group">
                        <label for="dsDatabase">Database Name</label>
                        <input type="text" id="dsDatabase" placeholder="e.g., production_db" required
                            aria-describedby="dsDatabaseError">
                        <span class="error-message" id="dsDatabaseError" aria-live="polite">Database Name is
                            required.</span>
                    </div>
                    <div class="form-group">
                        <label for="dsUser">Username</label>
                        <input type="text" id="dsUser" placeholder="e.g., admin_user" required
                            aria-describedby="dsUserError">
                        <span class="error-message" id="dsUserError" aria-live="polite">Username is required.</span>
                    </div>
                    <div class="form-group">
                        <label for="dsPassword">Password</label>
                        <input type="password" id="dsPassword" placeholder="Database password" required
                            aria-describedby="dsPasswordError">
                        <span class="error-message" id="dsPasswordError" aria-live="polite">Password is required.</span>
                    </div>
                    <div class="form-group">
                        <label for="dsConnectionString">Connection String (Optional)</label>
                        <input type="text" id="dsConnectionString" placeholder="jdbc:mysql://..."
                            aria-describedby="dsConnectionStringHelp">
                        <small id="dsConnectionStringHelp" class="form-text text-muted">Use connection string for
                            advanced configuration.</small>
                        <span class="error-message" id="dsConnectionStringError" aria-live="polite">Invalid connection
                            string format.</span>
                    </div>
                    <div class="btn-group form-actions">
                        <button class="secondary" id="testConnectionBtn">Test Connection</button>
                        <button class="primary" id="saveDataSourceBtn">Save Data Source</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="abtesting" class="section">
            <h1>A/B Testing</h1>
            <div class="card">
                <button class="primary" id="createABTestBtn">Create New A/B Test</button>
                <table>
                    <thead>
                        <tr>
                            <th>Test Name</th>
                            <th>Strategies</th>
                            <th>Traffic Split</th>
                            <th>Status</th>
                            <th>Start Date</th>
                            <th>End Date</th>
                            <th>Result Metric</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="abTestsTableBody">
                        <!-- Rows will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
            <div class="modal" id="abTestModal" role="dialog" aria-modal="true" aria-labelledby="abTestModalTitle"
                tabindex="-1">
                <div class="modal-content" tabindex="0">
                    <button class="close-button" aria-label="Close A/B Test Modal">&times;</button>
                    <h2 id="abTestModalTitle">Create A/B Test</h2>
                    <div class="form-group">
                        <label for="abTestName">Test Name</label>
                        <input type="text" id="abTestName" placeholder="e.g., Homepage Strategy Test" required
                            aria-describedby="abTestNameError">
                        <span class="error-message" id="abTestNameError" aria-live="polite">Test Name is
                            required.</span>
                    </div>
                    <div class="form-group">
                        <label for="abTestStrategies">Select Strategies (Min 2)</label>
                        <select id="abTestStrategies" multiple required
                            aria-describedby="abTestStrategiesHelp abTestStrategiesError">
                            <!-- Options will be populated by JavaScript -->
                        </select>
                        <small id="abTestStrategiesHelp" class="form-text text-muted">Hold Ctrl/Cmd to select
                            multiple.</small>
                        <span class="error-message" id="abTestStrategiesError" aria-live="polite">Select at least 2
                            strategies.</span>
                    </div>
                    <div class="form-group">
                        <label for="abTestTrafficSplit">Traffic Split (%) - e.g., 50/50, 60/40</label>
                        <input type="text" id="abTestTrafficSplit" placeholder="e.g., 50/50" required
                            aria-describedby="abTestTrafficSplitHelp abTestTrafficSplitError">
                        <small id="abTestTrafficSplitHelp" class="form-text text-muted">Enter percentages separated by a
                            slash (/). Must sum to 100.</small>
                        <span class="error-message" id="abTestTrafficSplitError" aria-live="polite">Invalid traffic
                            split format or sum.</span>
                    </div>
                    <div class="form-group">
                        <label for="abTestDuration">Duration (Days)</label>
                        <input type="number" id="abTestDuration" value="7" min="1" required
                            aria-describedby="abTestDurationError">
                        <span class="error-message" id="abTestDurationError" aria-live="polite">Duration must be at
                            least 1 day.</span>
                    </div>
                    <div class="form-group">
                        <label for="abTestMetric">Primary Metric for Success</label>
                        <select id="abTestMetric" required aria-describedby="abTestMetricError">
                            <option value="">Select Metric</option>
                            <option value="conversion">Conversion Rate</option>
                            <option value="aov">AOV Lift</option>
                            <option value="ctr">CTR</option>
                        </select>
                        <span class="error-message" id="abTestMetricError" aria-live="polite">Primary Metric is
                            required.</span>
                    </div>
                    <div class="btn-group form-actions">
                        <button class="secondary" id="cancelABTestBtn">Cancel</button>
                        <button class="primary" id="saveABTestBtn">Create Test</button>
                    </div>
                </div>
            </div>
        </section>

        <section id="reports" class="section">
            <h1>Reports & Analytics</h1>
            <div class="card">
                <div class="form-group">
                    <label for="reportTypeSelect">Select Report Type</label>
                    <select id="reportTypeSelect">
                        <option value="overall">Overall Performance Report</option>
                        <option value="strategy">Strategy Performance Breakdown</option>
                        <option value="placement">Placement Performance</option>
                        <option value="abtest">A/B Test Comparison</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="reportTimeframeSelect">Select Timeframe</label>
                    <select id="reportTimeframeSelect">
                        <option value="today">Today</option>
                        <option value="yesterday">Yesterday</option>
                        <option value="7days">Last 7 Days</option>
                        <option value="30days">Last 30 Days</option>
                        <option value="custom">Custom Range</option>
                    </select>
                </div>
                <div id="customTimeframe" class="form-group" style="display: none;">
                    <label>Custom Date Range</label>
                    <div style="display: flex; gap: var(--spacing-unit);">
                        <input type="date" id="reportStartDate" aria-label="Report Start Date">
                        <span>-</span>
                        <input type="date" id="reportEndDate" aria-label="Report End Date">
                    </div>
                </div>
                <div class="btn-group">
                    <button class="primary" id="generateReportBtn">Generate Report</button>
                    <button class="secondary" id="downloadReportBtn">Download Report (CSV)</button>
                </div>

                <div id="reportViewer" style="margin-top: calc(var(--spacing-unit) * 3);">
                    <h3>Generated Report (Placeholder)</h3>
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Metric</th>
                                <th>Value</th>
                                <th>Strategy/Placement</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>2023-10-26</td>
                                <td>Conversion Rate</td>
                                <td>3.5%</td>
                                <td>All</td>
                            </tr>
                            <tr>
                                <td>2023-10-26</td>
                                <td>AOV Lift</td>
                                <td>$14.80</td>
                                <td>All</td>
                            </tr>
                            <tr>
                                <td>2023-10-26</td>
                                <td>Conversion Rate</td>
                                <td>4.1%</td>
                                <td>Homepage Popular Items</td>
                            </tr>
                            <tr>
                                <td>2023-10-26</td>
                                <td>Conversion Rate</td>
                                <td>3.8%</td>
                                <td>Product Page Related</td>
                            </tr>
                            <!-- More rows -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>
    </main>

    <!-- Strategy Configuration Modal -->
    <div class="modal" id="strategyModal" role="dialog" aria-modal="true" aria-labelledby="strategyModalTitle"
        tabindex="-1">
        <div class="modal-content" tabindex="0">
            <button class="close-button" aria-label="Close Strategy Modal">&times;</button>
            <div class="step-indicator">
                <div class="step active" data-step="1">1</div>
                <div class="step" data-step="2">2</div>
                <div class="step" data-step="3">3</div>
            </div>

            <div id="step1" class="step-content active">
                <h2 id="strategyModalTitle">Step 1: Choose Strategy Type</h2>
                <div class="form-group">
                    <label>Select the type of recommendation strategy:</label>
                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--spacing-unit);">
                        <button type="button" class="strategy-type-card" data-type="popular" aria-pressed="false">
                            <span class="material-symbols-rounded" aria-hidden="true">trending_up</span>
                            <div style="font-weight: bold; margin-top: var(--spacing-unit);">Most Popular</div>
                            <small>Show items currently trending.</small>
                        </button>
                        <button type="button" class="strategy-type-card" data-type="sql" aria-pressed="false">
                            <span class="material-symbols-rounded" aria-hidden="true">code</span>
                            <div style="font-weight: bold; margin-top: var(--spacing-unit);">Based on SQL Query</div>
                            <small>Define logic with a custom SQL query.</small>
                        </button>
                        <button type="button" class="strategy-type-card" data-type="algorithm" aria-pressed="false">
                            <span class="material-symbols-rounded" aria-hidden="true">auto_awesome</span>
                            <div style="font-weight: bold; margin-top: var(--spacing-unit);">Simple Algorithm</div>
                            <small>Use built-in algorithms (e.g., collaborative filtering).</small>
                        </button>
                        <button type="button" class="strategy-type-card" data-type="rules" aria-pressed="false">
                            <span class="material-symbols-rounded" aria-hidden="true">rule</span>
                            <div style="font-weight: bold; margin-top: var(--spacing-unit);">Rules-Based</div>
                            <small>Define rules (e.g., category, price, brand).</small>
                        </button>
                    </div>
                    <span class="error-message" aria-live="polite" id="strategyTypeErrorMessage">Please select a
                        strategy type.</span>
                </div>
                <div class="btn-group form-actions">
                    <button type="button" class="secondary" onclick="closeModal('strategyModal')">Cancel</button>
                    <button type="button" class="primary" id="step1NextBtn">Next</button>
                </div>
            </div>

            <div id="step2" class="step-content">
                <h2>Step 2: Configure Strategy Details</h2>
                <div class="form-group">
                    <label for="strategyName">Strategy Name</label>
                    <input type="text" id="strategyName" placeholder="e.g., Homepage Popular Items" required
                        aria-describedby="strategyNameError">
                    <span class="error-message" id="strategyNameError" aria-live="polite">Strategy Name is
                        required.</span>
                </div>
                <div class="form-group">
                    <label for="strategyDataSource">Data Source</label>
                    <select id="strategyDataSource" required aria-describedby="strategyDataSourceError">
                        <option value="">Select a Data Source</option>
                        <!-- Options populated by JavaScript -->
                    </select>
                    <small class="form-text text-muted">Select the primary data source for this strategy.</small>
                    <span class="error-message" id="strategyDataSourceError" aria-live="polite">Data Source is
                        required.</span>
                </div>

                <!-- Dynamic content based on strategy type -->
                <div id="strategyConfigDetails">
                    <!-- Content loaded based on selected type -->
                    <div id="config-popular" class="config-type-content">
                        <h3>Popular Items Configuration</h3>
                        <div class="form-group">
                            <label for="popularTimeframe">Timeframe for Popularity</label>
                            <select id="popularTimeframe" aria-describedby="popularTimeframeError">
                                <option value="day">Last 24 Hours</option>
                                <option value="week">Last 7 Days</option>
                                <option value="month">Last 30 Days</option>
                            </select>
                            <span class="error-message" id="popularTimeframeError" aria-live="polite">Invalid
                                selection.</span>
                        </div>
                        <div class="form-group">
                            <label for="popularLimit">Number of Items to Recommend</label>
                            <input type="number" id="popularLimit" value="10" min="1" required
                                aria-describedby="popularLimitError">
                            <span class="error-message" id="popularLimitError" aria-live="polite">Limit must be at least
                                1.</span>
                        </div>
                    </div>
                    <div id="config-sql" class="config-type-content">
                        <h3>SQL Query Configuration</h3>
                        <div class="form-group">
                            <label for="sqlQuery">SQL Query</label>
                            <textarea id="sqlQuery"
                                placeholder="SELECT product_id FROM products WHERE category = 'Electronics' ORDER BY sales DESC LIMIT 10;"
                                required aria-describedby="sqlQueryHelp sqlQueryError"></textarea>
                            <small id="sqlQueryHelp" class="form-text text-muted">Enter your SQL query. It should return
                                a list of product IDs.</small>
                            <span class="error-message" id="sqlQueryError" aria-live="polite">SQL Query is required for
                                this type.</span>
                        </div>
                        <div class="form-group">
                            <button type="button" class="secondary">Test Query (Placeholder)</button>
                        </div>
                    </div>
                    <div id="config-algorithm" class="config-type-content">
                        <h3>Simple Algorithm Configuration</h3>
                        <div class="form-group">
                            <label for="algorithmType">Algorithm Type</label>
                            <select id="algorithmType" aria-describedby="algorithmTypeError">
                                <option value="collaborative">Collaborative Filtering (User-based)</option>
                                <option value="item-based">Item-based Filtering</option>
                                <option value="content-based">Content-based Filtering</option>
                            </select>
                            <span class="error-message" id="algorithmTypeError" aria-live="polite">Invalid
                                selection.</span>
                        </div>
                        <div class="form-group">
                            <label for="algorithmParameters">Parameters (JSON)</label>
                            <textarea id="algorithmParameters" placeholder='{"similarity_metric": "cosine", "k": 5}'
                                aria-describedby="algorithmParametersHelp algorithmParametersError"></textarea>
                            <small id="algorithmParametersHelp" class="form-text text-muted">Enter algorithm-specific
                                parameters in JSON format.</small>
                            <span class="error-message" id="algorithmParametersError" aria-live="polite">Invalid JSON
                                format.</span>
                        </div>
                    </div>
                    <div id="config-rules" class="config-type-content">
                        <h3>Rules-Based Configuration (Placeholder)</h3>
                        <p>Define rules using conditions (e.g., Category IS 'Electronics', Price > 100). A guided
                            builder is recommended for easier use.</p>
                        <div id="rulesEditor">
                            <!-- Placeholder for a more complex rule builder -->
                            <div class="form-group">
                                <label>Rule 1:</label>
                                <input type="text" placeholder="e.g., Category IS 'Electronics'">
                            </div>
                            <div class="form-group">
                                <label>Rule 2:</label>
                                <input type="text" placeholder="e.g., Brand IS NOT 'Acme'">
                            </div>
                            <button type="button" class="secondary">Add Rule (Placeholder)</button>
                        </div>
                    </div>
                </div>

                <div class="btn-group form-actions">
                    <button type="button" class="secondary" onclick="prevStep()">Previous</button>
                    <button type="button" class="primary" id="step2NextBtn">Next</button>
                </div>
            </div>

            <div id="step3" class="step-content">
                <h2>Step 3: Placement & Activation</h2>
                <div class="form-group" role="group" aria-labelledby="placementLabel">
                    <label id="placementLabel">Select Recommendation Placements:</label>
                    <div>
                        <input type="checkbox" id="placementHomepage" value="homepage"
                            aria-describedby="placementErrorMessage">
                        <label for="placementHomepage">Homepage</label>
                    </div>
                    <div>
                        <input type="checkbox" id="placementProductPage" value="productpage"
                            aria-describedby="placementErrorMessage">
                        <label for="placementProductPage">Product Page</label>
                    </div>
                    <div>
                        <input type="checkbox" id="placementCart" value="cart" aria-describedby="placementErrorMessage">
                        <label for="placementCart">Cart Page</label>
                    </div>
                    <div>
                        <input type="checkbox" id="placementCheckout" value="checkout"
                            aria-describedby="placementErrorMessage">
                        <label for="placementCheckout">Checkout Page</label>
                    </div>
                    <div>
                        <input type="checkbox" id="placementEmail" value="email"
                            aria-describedby="placementErrorMessage">
                        <label for="placementEmail">Email Communications</label>
                    </div>
                    <span class="checkbox-group-error" id="placementErrorMessage" aria-live="polite">Select at least one
                        placement.</span>
                </div>
                <div class="form-group">
                    <label for="strategyStatus">Initial Status</label>
                    <select id="strategyStatus" aria-describedby="strategyStatusError">
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                    </select>
                    <span class="error-message" id="strategyStatusError" aria-live="polite">Invalid status
                        selection.</span>
                </div>
                <div class="form-group">
                    <label for="strategyDescription">Description (Optional)</label>
                    <textarea id="strategyDescription" placeholder="Brief description of the strategy"
                        aria-describedby="strategyDescriptionHelp"></textarea>
                    <small id="strategyDescriptionHelp" class="form-text text-muted">Provide a brief description for
                        this strategy.</small>
                </div>
                <div class="btn-group form-actions">
                    <button type="button" class="secondary" onclick="prevStep()">Previous</button>
                    <button type="button" class="primary" id="saveStrategyBtn">Save Strategy</button>
                </div>
            </div>

        </div>
    </div>

    <!-- Loading Indicator -->
    <div class="loading-indicator" id="loadingIndicator" role="status" aria-label="Loading"></div>

    <!-- Toast Notification -->
    <div class="toast-notification" id="toastNotification" aria-live="polite"></div>


    <script type="module">
        import { Chart } from "https://esm.sh/chart.js/auto";

        // --- State Management (Simple In-Memory) ---
        let strategies = [
            { id: 's1', name: 'Homepage Popular Items', type: 'popular', status: 'Active', performance: '2.1% Conversion Lift', dataSourceId: 'ds1', config: { timeframe: 'week', limit: 10 }, placements: ['homepage'] },
            { id: 's2', name: 'Product Page Related', type: 'sql', status: 'Active', performance: '$10.50 AOV Lift', dataSourceId: 'ds2', config: { query: 'SELECT product_id FROM related_products WHERE current_product_id = {product_id} LIMIT 5;' }, placements: ['productpage'] },
            { id: 's3', name: 'Cart Cross-sell', type: 'algorithm', status: 'Active', performance: '5.8% CTR', dataSourceId: 'ds3', config: { algorithmType: 'item-based', parameters: '{"similarity_metric": "cosine"}' }, placements: ['cart'] },
            { id: 's4', name: 'Seasonal Bestsellers', type: 'rules', status: 'Inactive', performance: 'N/A', dataSourceId: 'ds1', config: { rules: ["Season IS 'Holiday'", "Category IS 'Gifts'"] }, placements: ['homepage', 'email'] },
        ];

        let dataSources = [
            { id: 'ds1', name: 'Product Catalog DB', type: 'MySQL', status: 'Connected', lastUpdated: 'Just now', connection: { host: '...', database: '...', user: '...' } },
            { id: 'ds2', name: 'Customer Behavior Log', type: 'PostgreSQL', status: 'Connected', lastUpdated: '5 mins ago', connection: { host: '...', database: '...', user: '...' } },
            { id: 'ds3', name: 'Order History Archive', type: 'SQL Server', status: 'Connected', lastUpdated: '1 hour ago', connection: { host: '...', database: '...', user: '...' } },
        ];

        let abTests = [
            { id: 'ab1', name: 'Homepage Test 1', strategies: ['s1', 's2'], split: '50/50', status: 'Running', startDate: '2023-10-26', endDate: '2023-11-02', metric: 'Conversion Rate' },
            { id: 'ab2', name: 'Cart Test 1', strategies: ['s3', 's4'], split: '60/40', status: 'Completed', startDate: '2023-10-19', endDate: '2023-10-26', metric: 'AOV Lift' },
        ];

        // Load state from localStorage on page load
        function loadState() {
            const savedStrategies = localStorage.getItem('strategies');
            const savedDataSources = localStorage.getItem('dataSources');
            const savedAbTests = localStorage.getItem('abTests');

            if (savedStrategies) strategies = JSON.parse(savedStrategies);
            if (savedDataSources) dataSources = JSON.parse(savedDataSources);
            if (savedAbTests) abTests = JSON.parse(savedAbTests);

            // Ensure strategy priority list is based on current strategies
            const savedPriority = localStorage.getItem('strategyPriority');
            if (savedPriority) {
                const priorityNames = JSON.parse(savedPriority);
                // Reorder strategies array based on saved priority, keeping strategies that still exist
                strategies.sort((a, b) => {
                    const indexA = priorityNames.indexOf(a.name);
                    const indexB = priorityNames.indexOf(b.name);
                    if (indexA === -1 && indexB === -1) return 0; // Both not in saved list
                    if (indexA === -1) return 1; // A is not in saved list, put it later
                    if (indexB === -1) return -1; // B is not in saved list, put it later
                    return indexA - indexB;
                });
            }
        }

        // Save state to localStorage
        function saveState() {
            localStorage.setItem('strategies', JSON.stringify(strategies));
            localStorage.setItem('dataSources', JSON.stringify(dataSources));
            localStorage.setItem('abTests', JSON.stringify(abTests));
            // Save current strategy priority order by name
            const currentPriority = Array.from(strategyPriorityList.children).map(item => item.textContent.trim());
            localStorage.setItem('strategyPriority', JSON.stringify(currentPriority));
        }


        // --- Render Functions ---
        function renderStrategiesTable() {
            const tbody = document.getElementById('strategiesTableBody');
            tbody.innerHTML = ''; // Clear existing rows
            strategies.forEach(strategy => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${strategy.name}</td>
                    <td>${strategy.type}</td>
                    <td>${strategy.status}</td>
                    <td>${strategy.performance}</td>
                    <td class="table-actions">
                        <button class="secondary" aria-label="Edit ${strategy.name} Strategy" data-id="${strategy.id}" data-action="edit">Edit</button>
                        <button class="secondary" aria-label="Duplicate ${strategy.name} Strategy" data-id="${strategy.id}" data-action="duplicate">Duplicate</button>
                        <button class="secondary" aria-label="${strategy.status === 'Active' ? 'Deactivate' : 'Activate'} ${strategy.name} Strategy" data-id="${strategy.id}" data-action="${strategy.status === 'Active' ? 'deactivate' : 'activate'}">${strategy.status === 'Active' ? 'Deactivate' : 'Activate'}</button>
                        <button class="danger" aria-label="Delete ${strategy.name} Strategy" data-id="${strategy.id}" data-action="delete">Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            addTableActionListeners('strategiesTableBody');
        }

        function renderDataSourcesTable() {
            const tbody = document.getElementById('dataSourcesTableBody');
            tbody.innerHTML = ''; // Clear existing rows
            dataSources.forEach(dataSource => {
                const row = document.createElement('tr');
                row.innerHTML = `
                     <td>${dataSource.name}</td>
                     <td>${dataSource.type}</td>
                     <td>${dataSource.status}</td>
                     <td>${dataSource.lastUpdated}</td>
                     <td class="table-actions">
                         <button class="secondary" aria-label="Edit ${dataSource.name} Data Source" data-id="${dataSource.id}" data-action="edit">Edit</button>
                         <button class="secondary" aria-label="Test Connection for ${dataSource.name}" data-id="${dataSource.id}" data-action="test">Test</button>
                         <button class="danger" aria-label="Delete ${dataSource.name} Data Source" data-id="${dataSource.id}" data-action="delete">Delete</button>
                     </td>
                 `;
                tbody.appendChild(row);
            });
            addTableActionListeners('dataSourcesTableBody');
        }

        function renderABTestsTable() {
            const tbody = document.getElementById('abTestsTableBody');
            tbody.innerHTML = ''; // Clear existing rows
            abTests.forEach(test => {
                const strategyNames = test.strategies.map(id => strategies.find(s => s.id === id)?.name || 'Unknown').join(' vs ');
                const row = document.createElement('tr');
                row.innerHTML = `
                     <td>${test.name}</td>
                     <td>${strategyNames}</td>
                     <td>${test.split}</td>
                     <td>${test.status}</td>
                     <td>${test.startDate}</td>
                     <td>${test.endDate || 'N/A'}</td>
                     <td>${test.metric}</td>
                     <td class="table-actions">
                         ${test.status === 'Running' ? `<button class="danger" aria-label="End ${test.name}" data-id="${test.id}" data-action="end">End Test</button>` : `<button class="secondary" aria-label="View Results for ${test.name}" data-id="${test.id}" data-action="view">View Results</button>`}
                         ${test.status === 'Completed' ? `<button class="secondary" aria-label="Archive ${test.name}" data-id="${test.id}" data-action="archive">Archive</button>` : ''}
                         ${test.status !== 'Running' ? `<button class="danger" aria-label="Delete ${test.name}" data-id="${test.id}" data-action="delete">Delete</button>` : ''}
                     </td>
                 `;
                tbody.appendChild(row);
            });
            addTableActionListeners('abTestsTableBody');
        }

        function renderStrategyPriorityList() {
            const list = document.getElementById('strategyPriorityList');
            list.innerHTML = ''; // Clear existing items
            strategies.forEach(strategy => {
                const listItem = document.createElement('li');
                listItem.classList.add('drag-list-item');
                listItem.setAttribute('draggable', 'true');
                listItem.setAttribute('role', 'option');
                listItem.setAttribute('aria-grabbed', 'false');
                listItem.setAttribute('tabindex', '0'); // Make list item focusable
                listItem.dataset.id = strategy.id; // Store strategy ID
                listItem.textContent = strategy.name;
                list.appendChild(listItem);
            });
        }

        function populateDataSourceSelects() {
            const selects = document.querySelectorAll('#strategyDataSource');
            selects.forEach(select => {
                const currentValue = select.value; // Save current value if editing
                select.innerHTML = '<option value="">Select a Data Source</option>';
                dataSources.forEach(ds => {
                    const option = document.createElement('option');
                    option.value = ds.id;
                    option.textContent = ds.name;
                    select.appendChild(option);
                });
                if (currentValue) select.value = currentValue; // Restore value
            });
        }

        function populateABTestStrategiesSelect() {
            const select = document.getElementById('abTestStrategies');
            const selectedValues = Array.from(select.selectedOptions).map(opt => opt.value); // Save selected values
            select.innerHTML = ''; // Clear existing options
            strategies.forEach(strategy => {
                const option = document.createElement('option');
                option.value = strategy.id;
                option.textContent = strategy.name;
                select.appendChild(option);
            });
            // Restore selected values
            Array.from(select.options).forEach(option => {
                if (selectedValues.includes(option.value)) {
                    option.selected = true;
                }
            });
        }


        // --- Navigation ---
        const navLinks = document.querySelectorAll('.nav-link');
        const sections = document.querySelectorAll('.section');
        const mainContent = document.getElementById('main-content');

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetSectionId = link.dataset.section;
                const targetSection = document.getElementById(targetSectionId);

                if (!targetSection) return; // Exit if target section doesn't exist

                // Update aria-current for accessibility
                navLinks.forEach(nav => nav.removeAttribute('aria-current'));
                link.setAttribute('aria-current', 'page');

                // Remove active class from all links and sections
                navLinks.forEach(nav => nav.classList.remove('active'));
                sections.forEach(sec => sec.classList.remove('active'));

                // Add active class to the clicked link and target section
                link.classList.add('active');
                targetSection.classList.add('active');

                // Scroll main content to top
                mainContent.scrollTop = 0;

                // Close any active floating chart controls
                document.querySelectorAll('.floating-controls.active').forEach(controls => {
                    controls.classList.remove('active');
                });

                // Render tables/lists for the newly active section
                if (targetSectionId === 'strategies') {
                    renderStrategiesTable();
                    renderStrategyPriorityList();
                    populateDataSourceSelects(); // Ensure data sources are available for strategy creation/edit
                } else if (targetSectionId === 'datasources') {
                    renderDataSourcesTable();
                } else if (targetSectionId === 'abtesting') {
                    renderABTestsTable();
                    populateABTestStrategiesSelect(); // Ensure strategies are available for A/B test creation/edit
                }
                // Dashboard charts are rendered on page load

            });
        });

        // --- Modals ---
        let lastFocusedElement = null;

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            lastFocusedElement = document.activeElement; // Store the element that was focused before opening modal
            modal.classList.add('active');
            // Find the first focusable element in the modal and focus it
            modal.addEventListener('transitionend', () => {
                const firstFocusable = modal.querySelector('input, button, select, textarea, [tabindex]:not([tabindex="-1"])');
                if (firstFocusable) {
                    firstFocusable.focus();
                } else {
                    // If no focusable elements, focus the modal content itself
                    modal.querySelector('.modal-content').focus();
                }
            }, { once: true }); // Run this listener only once
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            modal.classList.remove('active');
            // Return focus to the element that was focused before opening the modal
            if (lastFocusedElement) {
                lastFocusedElement.focus();
                lastFocusedElement = null; // Clear stored element
            }
            // Reset modal content if needed (e.g., form steps)
            if (modalId === 'strategyModal') {
                resetStrategyModal();
            } else if (modalId === 'dataSourceModal') {
                resetDataSourceModal();
            } else if (modalId === 'abTestModal') {
                resetABTestModal();
            }
            // Reset validation states on close
            resetFormValidation(modal);
        }

        document.querySelectorAll('.modal .close-button').forEach(button => {
            button.addEventListener('click', (e) => {
                closeModal(e.target.closest('.modal').id);
            });
        });

        window.addEventListener('click', (event) => {
            document.querySelectorAll('.modal.active').forEach(modal => {
                if (event.target === modal) {
                    closeModal(modal.id);
                }
            });
        });

        // Trap focus inside modal
        document.addEventListener('keydown', function (event) {
            const activeModal = document.querySelector('.modal.active');
            if (!activeModal) return;

            const focusableElements = activeModal.querySelectorAll('input:not([type="hidden"]):not(:disabled), select:not(:disabled), textarea:not(:disabled), button:not(:disabled), [tabindex]:not([tabindex="-1"]):not(:disabled)');
            const firstFocusableElement = focusableElements[0];
            const lastFocusableElement = focusableElements[focusableElements.length - 1];

            if (event.key === 'Tab') {
                if (event.shiftKey) { // Shift + Tab
                    if (document.activeElement === firstFocusableElement || document.activeElement === activeModal.querySelector('.modal-content')) {
                        lastFocusableElement.focus();
                        event.preventDefault();
                    }
                } else { // Tab
                    if (document.activeElement === lastFocusableElement) {
                        firstFocusableElement.focus();
                        event.preventDefault();
                    }
                }
            }

            // Close modal on Escape key
            if (event.key === 'Escape') {
                closeModal(activeModal.id);
            }
        });


        // --- Form Validation (Basic Client-Side) ---
        function validateFormGroup(formGroup) {
            const input = formGroup.querySelector('input:not([type="hidden"]), select, textarea');
            const errorMessage = formGroup.querySelector('.error-message');
            const checkboxGroupError = formGroup.querySelector('.checkbox-group-error');
            let isValid = true;
            let message = '';

            if (!input) {
                // Handle checkbox groups separately
                if (checkboxGroupError) {
                    const checkboxes = formGroup.querySelectorAll('input[type="checkbox"]');
                    const checkedCount = Array.from(checkboxes).filter(cb => cb.checked).length;
                    if (checkedCount === 0) {
                        isValid = false;
                        message = checkboxGroupError.textContent || 'Please make a selection.';
                    }
                } else {
                    // No input or checkbox group found, assume valid or skip
                    return true;
                }
            } else {
                // Standard input validation
                if (input.hasAttribute('required') && !input.value.trim()) {
                    isValid = false;
                    message = input.placeholder ? `${input.placeholder.split(',')[0]} is required.` : `${formGroup.querySelector('label')?.textContent.trim().replace(':', '')} is required.`;
                } else if (input.type === 'number' && input.min && parseFloat(input.value) < parseFloat(input.min)) {
                    // Check if value is actually a number before comparing min
                    if (!isNaN(parseFloat(input.value))) {
                        isValid = false;
                        message = `${formGroup.querySelector('label')?.textContent.trim().replace(':', '')} must be at least ${input.min}.`;
                    }
                } else if (input.id === 'abTestStrategies') {
                    const selectedOptions = Array.from(input.selectedOptions);
                    if (selectedOptions.length < 2) {
                        isValid = false;
                        message = 'Select at least 2 strategies.';
                    }
                } else if (input.id === 'abTestTrafficSplit') {
                    const value = input.value.trim();
                    if (!/^\d+(\s*\/\s*\d+)+$/.test(value)) {
                        isValid = false;
                        message = 'Invalid format (e.g., 50/50).';
                    } else {
                        const parts = value.split('/').map(p => parseInt(p.trim()));
                        const sum = parts.reduce((acc, val) => acc + val, 0);
                        if (sum !== 100) {
                            isValid = false;
                            message = 'Traffic split percentages must sum to 100.';
                        }
                    }
                } else if (input.id === 'algorithmParameters') {
                    // Basic JSON validation
                    if (input.value.trim()) {
                        try {
                            JSON.parse(input.value);
                        } catch (e) {
                            isValid = false;
                            message = 'Invalid JSON format.';
                        }
                    }
                } else if (input.id === 'sqlQuery') {
                    const strategyType = strategyModal.querySelector('.strategy-type-card.active')?.dataset.type;
                    if (strategyType === 'sql' && !input.value.trim()) {
                        isValid = false;
                        message = 'SQL Query is required for this type.';
                    }
                }
            }


            if (isValid) {
                formGroup.classList.remove('invalid');
                if (errorMessage) errorMessage.style.display = 'none';
                if (checkboxGroupError) checkboxGroupError.style.display = 'none';
            } else {
                formGroup.classList.add('invalid');
                if (errorMessage) {
                    errorMessage.textContent = message;
                    errorMessage.style.display = 'block';
                }
                if (checkboxGroupError) {
                    checkboxGroupError.textContent = message;
                    checkboxGroupError.style.display = 'block';
                }
            }
            return isValid;
        }

        function validateContainer(container) {
            const formGroups = container.querySelectorAll('.form-group');
            let containerIsValid = true;

            formGroups.forEach(formGroup => {
                // Skip validation for hidden config details in strategy modal step 2
                if (container.id === 'step2') {
                    const configDetails = formGroup.closest('#strategyConfigDetails');
                    if (configDetails && !formGroup.closest('.config-type-content.active')) {
                        return; // Skip validation for inactive config sections
                    }
                }
                if (!validateFormGroup(formGroup)) {
                    containerIsValid = false;
                }
            });

            // Additional validation for Strategy Modal Step 1 (Strategy Type)
            if (container.id === 'step1') {
                const selectedType = container.querySelector('.strategy-type-card.active');
                const typeErrorMessage = document.getElementById('strategyTypeErrorMessage');
                if (!selectedType) {
                    containerIsValid = false;
                    typeErrorMessage.style.display = 'block';
                } else {
                    typeErrorMessage.style.display = 'none';
                }
            }

            // Additional validation for Strategy Modal Step 3 (Placements)
            if (container.id === 'step3') {
                const selectedPlacements = container.querySelectorAll('input[type="checkbox"]:checked');
                const placementErrorMessage = document.getElementById('placementErrorMessage');
                if (selectedPlacements.length === 0) {
                    containerIsValid = false;
                    placementErrorMessage.style.display = 'block';
                } else {
                    placementErrorMessage.style.display = 'none';
                }
            }


            return containerIsValid;
        }

        function resetFormValidation(container) {
            container.querySelectorAll('.form-group').forEach(formGroup => {
                formGroup.classList.remove('invalid');
                const errorMessage = formGroup.querySelector('.error-message');
                if (errorMessage) errorMessage.style.display = 'none';
                const checkboxGroupError = formGroup.querySelector('.checkbox-group-error');
                if (checkboxGroupError) checkboxGroupError.style.display = 'none';
            });
            // Reset specific error messages for strategy modal steps
            const typeErrorMessage = document.getElementById('strategyTypeErrorMessage');
            if (typeErrorMessage) typeErrorMessage.style.display = 'none';
            const placementErrorMessage = document.getElementById('placementErrorMessage');
            if (placementErrorMessage) placementErrorMessage.style.display = 'none';
        }

        // Add validation listeners to form inputs (basic implementation)
        function addValidationListeners(container) {
            container.querySelectorAll('input:not([type="hidden"]), select, textarea').forEach(input => {
                // Use 'blur' for most inputs, 'change' for selects/checkboxes
                const eventType = (input.tagName === 'SELECT' || input.type === 'checkbox' || input.type === 'radio') ? 'change' : 'blur';
                input.addEventListener(eventType, () => {
                    validateFormGroup(input.closest('.form-group'));
                });
            });
            // Add listeners for checkbox groups
            container.querySelectorAll('.form-group input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    const formGroup = checkbox.closest('.form-group');
                    if (formGroup.querySelector('.checkbox-group-error')) {
                        validateFormGroup(formGroup);
                    }
                });
            });
        }


        // --- Strategy Modal Steps ---
        let currentStep = 1;
        const strategyModal = document.getElementById('strategyModal');
        const step1NextBtn = document.getElementById('step1NextBtn');
        const step2NextBtn = document.getElementById('step2NextBtn');
        const saveStrategyBtn = document.getElementById('saveStrategyBtn');
        let editingStrategyId = null; // To track if we are editing or adding

        function showStep(stepNumber) {
            document.querySelectorAll('#strategyModal .step-content').forEach(step => step.classList.remove('active'));
            document.querySelectorAll('#strategyModal .step-indicator .step').forEach(step => step.classList.remove('active'));

            document.getElementById('step' + stepNumber).classList.add('active');
            document.querySelector('#strategyModal .step-indicator .step[data-step="' + stepNumber + '"]').classList.add('active');
            currentStep = stepNumber;

            // Update button visibility/text
            step1NextBtn.style.display = currentStep === 1 ? 'inline-block' : 'none';
            step2NextBtn.style.display = currentStep === 2 ? 'inline-block' : 'none';
            saveStrategyBtn.style.display = currentStep === 3 ? 'inline-block' : 'none';

            // Focus the first element in the new step for accessibility
            const firstFocusable = document.getElementById('step' + stepNumber).querySelector('input:not([type="hidden"]), button, select, textarea, [tabindex]:not([tabindex="-1"])');
            if (firstFocusable) {
                firstFocusable.focus();
            } else {
                // Fallback focus on modal content
                strategyModal.querySelector('.modal-content').focus();
            }
        }

        function nextStep() {
            if (validateContainer(document.getElementById('step' + currentStep))) {
                if (currentStep < 3) {
                    showStep(currentStep + 1);
                }
            } else {
                showToast('Please fix the errors before proceeding.', 'danger');
            }
        }

        function prevStep() {
            if (currentStep > 1) {
                showStep(currentStep - 1);
                // Reset validation for the step we are leaving
                resetFormValidation(document.getElementById('step' + (currentStep + 1)));
            }
        }

        function resetStrategyModal() {
            editingStrategyId = null;
            showStep(1);
            document.getElementById('strategyModalTitle').textContent = 'Step 1: Choose Strategy Type';
            // Reset form fields
            document.getElementById('strategyName').value = '';
            document.getElementById('strategyDataSource').value = '';
            document.getElementById('strategyDescription').value = '';
            document.getElementById('strategyStatus').value = 'active';
            document.querySelectorAll('.strategy-type-card').forEach(card => {
                card.classList.remove('active');
                card.setAttribute('aria-pressed', 'false');
            });
            document.querySelectorAll('.config-type-content').forEach(content => content.style.display = 'none');
            document.querySelectorAll('#step3 input[type="checkbox"]').forEach(cb => cb.checked = false);

            // Reset specific config fields (basic)
            document.getElementById('popularTimeframe').value = 'day';
            document.getElementById('popularLimit').value = '10';
            document.getElementById('sqlQuery').value = '';
            document.getElementById('algorithmType').value = 'collaborative';
            document.getElementById('algorithmParameters').value = '';
            // Reset rules editor (more complex) - currently just text inputs
            document.querySelectorAll('#rulesEditor input[type="text"]').forEach(input => input.value = '');


            // Reset validation states
            resetFormValidation(strategyModal);
        }

        function loadStrategyIntoModal(strategy) {
            editingStrategyId = strategy.id;
            document.getElementById('strategyModalTitle').textContent = 'Edit Strategy';

            // Step 1: Select Type
            document.querySelectorAll('.strategy-type-card').forEach(card => {
                if (card.dataset.type === strategy.type) {
                    card.classList.add('active');
                    card.setAttribute('aria-pressed', 'true');
                } else {
                    card.classList.remove('active');
                    card.setAttribute('aria-pressed', 'false');
                }
            });
            // Show relevant config section
            document.querySelectorAll('.config-type-content').forEach(content => content.style.display = 'none');
            const configContent = document.getElementById('config-' + strategy.type);
            if (configContent) configContent.style.display = 'block';


            // Step 2: Configure Details
            document.getElementById('strategyName').value = strategy.name;
            document.getElementById('strategyDataSource').value = strategy.dataSourceId || '';

            // Load specific config details
            if (strategy.type === 'popular' && strategy.config) {
                document.getElementById('popularTimeframe').value = strategy.config.timeframe || 'day';
                document.getElementById('popularLimit').value = strategy.config.limit || '10';
            } else if (strategy.type === 'sql' && strategy.config) {
                document.getElementById('sqlQuery').value = strategy.config.query || '';
            } else if (strategy.type === 'algorithm' && strategy.config) {
                document.getElementById('algorithmType').value = strategy.config.algorithmType || 'collaborative';
                document.getElementById('algorithmParameters').value = strategy.config.parameters || '';
            } else if (strategy.type === 'rules' && strategy.config && strategy.config.rules) {
                // Basic loading for placeholder rules editor
                const ruleInputs = document.querySelectorAll('#rulesEditor input[type="text"]');
                strategy.config.rules.forEach((rule, index) => {
                    if (ruleInputs[index]) ruleInputs[index].value = rule;
                });
            }

            // Step 3: Placement & Activation
            document.querySelectorAll('#step3 input[type="checkbox"]').forEach(cb => {
                cb.checked = strategy.placements.includes(cb.value);
            });
            document.getElementById('strategyStatus').value = strategy.status.toLowerCase();
            document.getElementById('strategyDescription').value = strategy.description || '';

            // Show the first step (user will navigate from there)
            showStep(1);
            openModal('strategyModal');
        }


        document.getElementById('addStrategyBtn').addEventListener('click', () => {
            resetStrategyModal(); // Ensure modal is clean
            populateDataSourceSelects(); // Refresh data source list
            openModal('strategyModal');
        });

        document.querySelectorAll('.strategy-type-card').forEach(card => {
            card.addEventListener('click', () => {
                const isActive = card.classList.contains('active');
                document.querySelectorAll('.strategy-type-card').forEach(c => {
                    c.classList.remove('active');
                    c.setAttribute('aria-pressed', 'false');
                });

                // If it was already active, clicking again deactivates it
                if (!isActive) {
                    card.classList.add('active');
                    card.setAttribute('aria-pressed', 'true');
                    const type = card.dataset.type;
                    document.querySelectorAll('.config-type-content').forEach(content => content.style.display = 'none');
                    const configContent = document.getElementById('config-' + type);
                    if (configContent) configContent.style.display = 'block';
                    // Clear type validation error if a type is selected
                    document.getElementById('strategyTypeErrorMessage').style.display = 'none';
                    // Reset validation for the config details section when type changes
                    resetFormValidation(document.getElementById('strategyConfigDetails'));
                } else {
                    // Hide all config content if deactivated
                    document.querySelectorAll('.config-type-content').forEach(content => content.style.display = 'none');
                }
                // Re-validate step 1 after type selection changes
                validateContainer(document.getElementById('step1'));
            });
        });

        // Add listeners for step navigation buttons
        step1NextBtn.addEventListener('click', nextStep);
        step2NextBtn.addEventListener('click', nextStep);

        // Save Strategy Button Click
        saveStrategyBtn.addEventListener('click', () => {
            if (validateContainer(document.getElementById('step3'))) {
                // Gather all strategy data
                const strategyType = strategyModal.querySelector('.strategy-type-card.active')?.dataset.type;
                const strategyName = document.getElementById('strategyName').value.trim();
                const strategyDataSourceId = document.getElementById('strategyDataSource').value;
                const strategyStatus = document.getElementById('strategyStatus').value;
                const strategyDescription = document.getElementById('strategyDescription').value.trim();
                const selectedPlacements = Array.from(document.querySelectorAll('#step3 input[type="checkbox"]:checked')).map(cb => cb.value);

                let strategyConfig = {};
                if (strategyType === 'popular') {
                    strategyConfig = {
                        timeframe: document.getElementById('popularTimeframe').value,
                        limit: parseInt(document.getElementById('popularLimit').value)
                    };
                } else if (strategyType === 'sql') {
                    strategyConfig = {
                        query: document.getElementById('sqlQuery').value.trim()
                    };
                } else if (strategyType === 'algorithm') {
                    strategyConfig = {
                        algorithmType: document.getElementById('algorithmType').value,
                        parameters: document.getElementById('algorithmParameters').value.trim()
                    };
                } else if (strategyType === 'rules') {
                    // Basic rule gathering for placeholder
                    strategyConfig = {
                        rules: Array.from(document.querySelectorAll('#rulesEditor input[type="text"]')).map(input => input.value.trim()).filter(rule => rule !== '')
                    };
                }

                const newStrategy = {
                    id: editingStrategyId || 's' + Date.now(), // Simple ID generation
                    name: strategyName,
                    type: strategyType,
                    status: strategyStatus.charAt(0).toUpperCase() + strategyStatus.slice(1), // Capitalize status
                    performance: editingStrategyId ? (strategies.find(s => s.id === editingStrategyId)?.performance || 'N/A') : 'N/A', // Keep existing performance or set N/A
                    dataSourceId: strategyDataSourceId,
                    config: strategyConfig,
                    placements: selectedPlacements,
                    description: strategyDescription
                };

                if (editingStrategyId) {
                    // Update existing strategy
                    const index = strategies.findIndex(s => s.id === editingStrategyId);
                    if (index !== -1) {
                        strategies[index] = newStrategy;
                        showToast('Strategy updated (placeholder).', 'success');
                    }
                } else {
                    // Add new strategy
                    strategies.push(newStrategy);
                    showToast('Strategy added (placeholder).', 'success');
                }

                saveState();
                renderStrategiesTable();
                renderStrategyPriorityList(); // Update priority list with new/updated strategy
                populateABTestStrategiesSelect(); // Update A/B test strategy options
                closeModal('strategyModal');

            } else {
                showToast('Please fix the errors before saving.', 'danger');
            }
        });

        // Add validation listeners to strategy modal inputs
        addValidationListeners(strategyModal);


        // --- Data Source Modal ---
        const dataSourceModal = document.getElementById('dataSourceModal');
        let editingDataSourceId = null;

        function resetDataSourceModal() {
            editingDataSourceId = null;
            document.getElementById('dataSourceModalTitle').textContent = 'Add Data Source';
            dataSourceModal.querySelectorAll('input:not([type="hidden"]), select, textarea').forEach(input => {
                if (input.type === 'checkbox' || input.type === 'radio') {
                    input.checked = false;
                } else {
                    input.value = '';
                }
            });
            document.getElementById('dsType').value = ''; // Ensure select is reset to placeholder
            resetFormValidation(dataSourceModal);
        }

        function loadDataSourceIntoModal(dataSource) {
            editingDataSourceId = dataSource.id;
            document.getElementById('dataSourceModalTitle').textContent = 'Edit Data Source';

            document.getElementById('dsName').value = dataSource.name;
            document.getElementById('dsType').value = dataSource.type;
            document.getElementById('dsHost').value = dataSource.connection.host || '';
            document.getElementById('dsPort').value = dataSource.connection.port || '';
            document.getElementById('dsDatabase').value = dataSource.connection.database || '';
            document.getElementById('dsUser').value = dataSource.connection.user || '';
            // Password is not typically loaded for security
            document.getElementById('dsPassword').value = '';
            document.getElementById('dsConnectionString').value = dataSource.connection.connectionString || '';

            resetFormValidation(dataSourceModal); // Clear previous validation states
            openModal('dataSourceModal');
        }


        document.getElementById('addDataSourceBtn').addEventListener('click', () => {
            resetDataSourceModal(); // Ensure modal is clean
            openModal('dataSourceModal');
        });

        document.getElementById('saveDataSourceBtn').addEventListener('click', () => {
            if (validateContainer(dataSourceModal)) {
                // Placeholder for saving data source
                console.log('Saving Data Source...');
                const dsName = document.getElementById('dsName').value.trim();
                const dsType = document.getElementById('dsType').value;
                const dsHost = document.getElementById('dsHost').value.trim();
                const dsPort = document.getElementById('dsPort').value.trim();
                const dsDatabase = document.getElementById('dsDatabase').value.trim();
                const dsUser = document.getElementById('dsUser').value.trim();
                const dsPassword = document.getElementById('dsPassword').value; // In a real app, handle securely
                const dsConnectionString = document.getElementById('dsConnectionString').value.trim();

                const newDataSource = {
                    id: editingDataSourceId || 'ds' + Date.now(), // Simple ID generation
                    name: dsName,
                    type: dsType,
                    status: 'Connected', // Assume connected on save for placeholder
                    lastUpdated: 'Just now',
                    connection: {
                        host: dsHost,
                        port: dsPort,
                        database: dsDatabase,
                        user: dsUser,
                        // password: dsPassword, // Do not store password in frontend state
                        connectionString: dsConnectionString
                    }
                };

                if (editingDataSourceId) {
                    // Update existing data source
                    const index = dataSources.findIndex(ds => ds.id === editingDataSourceId);
                    if (index !== -1) {
                        // Keep old password if not updated, but in real app this is backend logic
                        dataSources[index] = newDataSource;
                        showToast('Data source updated (placeholder).', 'success');
                    }
                } else {
                    // Add new data source
                    dataSources.push(newDataSource);
                    showToast('Data source saved (placeholder).', 'success');
                }

                saveState();
                renderDataSourcesTable();
                populateDataSourceSelects(); // Update strategy data source options
                closeModal('dataSourceModal');

            } else {
                showToast('Please fix the errors before saving.', 'danger');
            }
        });

        document.getElementById('testConnectionBtn').addEventListener('click', () => {
            // Basic validation before testing
            const requiredFields = dataSourceModal.querySelectorAll('input[required], select[required], textarea[required]');
            let allRequiredValid = true;
            requiredFields.forEach(field => {
                if (!validateFormGroup(field.closest('.form-group'))) {
                    allRequiredValid = false;
                }
            });

            if (allRequiredValid) {
                console.log('Testing Connection...');
                showLoading();
                // Simulate network request
                setTimeout(() => {
                    hideLoading();
                    // Simulate success or failure randomly
                    const isSuccess = Math.random() > 0.2; // 80% success rate
                    if (isSuccess) {
                        showToast('Connection successful (placeholder).', 'success');
                    } else {
                        showToast('Connection failed (placeholder). Check credentials.', 'danger');
                    }
                }, 1500);
            } else {
                showToast('Please fill in required connection details.', 'warning');
            }
        });

        // Add validation listeners to data source modal inputs
        addValidationListeners(dataSourceModal);


        // --- A/B Test Modal ---
        const abTestModal = document.getElementById('abTestModal');
        let editingABTestId = null;

        function resetABTestModal() {
            editingABTestId = null;
            document.getElementById('abTestModalTitle').textContent = 'Create A/B Test';
            abTestModal.querySelectorAll('input:not([type="hidden"]), select, textarea').forEach(input => {
                if (input.type === 'checkbox' || input.type === 'radio') {
                    input.checked = false;
                } else if (input.type === 'number') {
                    input.value = input.min || '';
                }
                else {
                    input.value = '';
                }
            });
            document.getElementById('abTestMetric').value = ''; // Reset select
            document.getElementById('abTestStrategies').value = ''; // Reset multi-select
            resetFormValidation(abTestModal);
        }

        function loadABTestIntoModal(test) {
            editingABTestId = test.id;
            document.getElementById('abTestModalTitle').textContent = 'Edit A/B Test';

            document.getElementById('abTestName').value = test.name;
            populateABTestStrategiesSelect(); // Ensure options are fresh before setting selected
            Array.from(document.getElementById('abTestStrategies').options).forEach(option => {
                if (test.strategies.includes(option.value)) {
                    option.selected = true;
                }
            });
            document.getElementById('abTestTrafficSplit').value = test.split;
            document.getElementById('abTestDuration').value = test.duration; // Assuming duration is stored
            document.getElementById('abTestMetric').value = test.metric.toLowerCase().replace(' ', ''); // Match select option value

            resetFormValidation(abTestModal); // Clear previous validation states
            openModal('abTestModal');
        }


        document.getElementById('createABTestBtn').addEventListener('click', () => {
            resetABTestModal(); // Ensure modal is clean
            populateABTestStrategiesSelect(); // Refresh strategy list
            openModal('abTestModal');
        });

        document.getElementById('saveABTestBtn').addEventListener('click', () => {
            if (validateContainer(abTestModal)) {
                // Placeholder for creating A/B test
                console.log('Creating A/B Test...');
                const testName = document.getElementById('abTestName').value.trim();
                const selectedStrategies = Array.from(document.getElementById('abTestStrategies').selectedOptions).map(opt => opt.value);
                const trafficSplit = document.getElementById('abTestTrafficSplit').value.trim();
                const duration = parseInt(document.getElementById('abTestDuration').value);
                const metric = document.getElementById('abTestMetric').value;

                const newTest = {
                    id: editingABTestId || 'ab' + Date.now(), // Simple ID generation
                    name: testName,
                    strategies: selectedStrategies,
                    split: trafficSplit,
                    status: 'Running', // Assume new test is running
                    startDate: new Date().toISOString().split('T')[0], // Current date
                    endDate: null, // Null until ended
                    duration: duration, // Store duration
                    metric: document.getElementById('abTestMetric').options[document.getElementById('abTestMetric').selectedIndex].text // Store full text
                };

                if (editingABTestId) {
                    // Update existing test (less common for A/B tests once started)
                    const index = abTests.findIndex(t => t.id === editingABTestId);
                    if (index !== -1) {
                        // Note: Editing a running test is complex in reality.
                        // This placeholder just updates the state object.
                        abTests[index] = newTest;
                        showToast('A/B Test updated (placeholder).', 'success');
                    }
                } else {
                    // Add new test
                    abTests.push(newTest);
                    showToast('A/B Test created (placeholder).', 'success');
                }

                saveState();
                renderABTestsTable();
                closeModal('abTestModal');

            } else {
                showToast('Please fix the errors before creating the test.', 'danger');
            }
        });

        document.getElementById('cancelABTestBtn').addEventListener('click', () => {
            closeModal('abTestModal');
        });

        // Add validation listeners to A/B test modal inputs
        addValidationListeners(abTestModal);


        // --- Loading Indicator ---
        const loadingIndicator = document.getElementById('loadingIndicator');

        function showLoading() {
            loadingIndicator.classList.add('active');
        }

        function hideLoading() {
            loadingIndicator.classList.remove('active');
        }

        // --- Toast Notification ---
        const toastNotification = document.getElementById('toastNotification');
        let toastTimeout;

        function showToast(message, type = 'info') {
            toastNotification.textContent = message;
            // Remove previous type classes
            toastNotification.classList.remove('success', 'danger', 'warning', 'info');
            // Add current type class
            toastNotification.classList.add(type);

            toastNotification.classList.add('active');

            clearTimeout(toastTimeout);
            toastTimeout = setTimeout(() => {
                toastNotification.classList.remove('active');
            }, 3000); // Hide after 3 seconds
        }


        // --- Data Visualization (Chart.js) ---

        // Performance Chart
        const performanceCtx = document.getElementById('performanceChart').getContext('2d');
        let performanceChart = null; // Use let to reassign chart instance

        function createPerformanceChart(type = 'line', metric = 'conversion', timeframe = 'week') {
            if (performanceChart) {
                performanceChart.destroy(); // Destroy existing chart before creating a new one
            }

            // Placeholder data based on metric and timeframe
            const labels = timeframe === 'week' ? ['Day 1', 'Day 2', 'Day 3', 'Day 4', 'Day 5', 'Day 6', 'Day 7'] :
                timeframe === 'month' ? ['Week 1', 'Week 2', 'Week 3', 'Week 4'] :
                    ['Month 1', 'Month 2', 'Month 3'];
            const data = metric === 'conversion' ? [3.0, 3.2, 3.1, 3.3, 3.4, 3.5, 3.45] :
                metric === 'aov' ? [14.0, 14.5, 15.0, 14.8, 15.1, 15.3, 15.2] :
                    [7.5, 7.8, 8.0, 7.9, 8.2, 8.1, 8.05];
            const label = metric === 'conversion' ? 'Conversion Rate (%)' : metric === 'aov' ? 'AOV Lift ($)' : 'CTR (%)';

            // Generate multiple colors for each data point
            const bgColors = [
                varToRgb("var(--primary-color)") + '40',
                varToRgb("var(--success-color)") + '40',
                varToRgb("var(--warning-color)") + '40',
                varToRgb("var(--danger-color)") + '40',
                varToRgb("var(--info-color)") + '40',
                '#9b59b6' + '40', // Changed from '#4e79a7' (Tableau Blue) to Amethyst Purple
                '#f28e2b' + '40'
            ];

            const borderColors = [
                varToRgb("var(--primary-color)"),
                varToRgb("var(--success-color)"),
                varToRgb("var(--warning-color)"),
                varToRgb("var(--danger-color)"),
                varToRgb("var(--info-color)"),
                '#9b59b6', // Changed from '#4e79a7' (Tableau Blue) to Amethyst Purple
                '#f28e2b'
            ];

            // For bar charts, we want each bar to have a different color
            // For line charts, we'll create multiple datasets
            if (type === 'bar') {
                performanceChart = new Chart(performanceCtx, {
                    type: type,
                    data: {
                        labels: labels,
                        datasets: [{
                            label: label,
                            data: data,
                            backgroundColor: bgColors.slice(0, data.length),
                            borderColor: borderColors.slice(0, data.length),
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        onClick: (e) => { // Toggle controls on chart click (desktop only)
                            if (window.innerWidth > 768) showControls(e, 'performanceChartControls');
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += new Intl.NumberFormat('en-US', { style: 'decimal', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(context.parsed.y);
                                            if (metric === 'conversion' || metric === 'ctr') label += '%';
                                            if (metric === 'aov') label = '$' + label;
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: label
                                },
                                ticks: {
                                    callback: function (value) {
                                        if (metric === 'conversion' || metric === 'ctr') return value + '%';
                                        if (metric === 'aov') return '$' + value;
                                        return value;
                                    }
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Time'
                                }
                            }
                        }
                    }
                });
            } else {
                // For line charts, we'll keep the original implementation with one dataset
                // but we'll still use a specific color based on the metric
                const lineOverallColor = metric === 'conversion' ? varToRgb("var(--primary-color)") :
                    metric === 'aov' ? varToRgb("var(--success-color)") :
                        varToRgb("var(--info-color)");

                performanceChart = new Chart(performanceCtx, {
                    type: type,
                    data: {
                        labels: labels,
                        datasets: [{
                            label: label,
                            data: data,
                            backgroundColor: lineOverallColor.replace('rgb(', 'rgba(').replace(')', ', 0.25)'), // Correctly format to rgba
                            borderColor: lineOverallColor,           // Color of the line itself
                            borderWidth: 2,
                            fill: true, // Fill for line charts
                            tension: 0.3, // Smooth line
                            pointBackgroundColor: bgColors, // Use different colors for each data point
                            pointBorderColor: borderColors,
                            pointRadius: 6, // Adjust point size as needed
                            pointHoverRadius: 8 // Adjust hover size as needed
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        onClick: (e) => { // Toggle controls on chart click (desktop only)
                            if (window.innerWidth > 768) showControls(e, 'performanceChartControls');
                        },
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top',
                            },
                            tooltip: {
                                callbacks: {
                                    label: function (context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += new Intl.NumberFormat('en-US', { style: 'decimal', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(context.parsed.y);
                                            if (metric === 'conversion' || metric === 'ctr') label += '%';
                                            if (metric === 'aov') label = '$' + label;
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: label
                                },
                                ticks: {
                                    callback: function (value) {
                                        if (metric === 'conversion' || metric === 'ctr') return value + '%';
                                        if (metric === 'aov') return '$' + value;
                                        return value;
                                    }
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: 'Time'
                                }
                            }
                        }
                    }
                });
            }
        }

        // Strategy Distribution Chart
        const distributionCtx = document.getElementById('distributionChart').getContext('2d');
        let distributionChart = null; // Use let to reassign chart instance

        function createDistributionChart(type = 'pie', metric = 'served') {
            if (distributionChart) {
                distributionChart.destroy(); // Destroy existing chart before creating a new one
            }

            // Placeholder data based on metric
            const labels = strategies.map(s => s.name); // Use actual strategy names
            const data = metric === 'served' ? [4000, 3000, 2000, 1000] : // Placeholder distribution
                metric === 'clicks' ? [320, 250, 180, 80] :
                    [120, 90, 60, 30];
            const label = metric === 'served' ? 'Recommendations Served' : metric === 'clicks' ? 'Clicks' : 'Conversions';
            const colors = [
                varToRgb("var(--primary-color)"),
                varToRgb("var(--success-color)"),
                varToRgb("var(--warning-color)"),
                varToRgb("var(--danger-color)"),
                '#9b59b6', // Changed from '#4e79a7' (Tableau Blue) to Amethyst Purple
                '#f28e2b', '#e15759', '#76b7b2', '#59a14f', '#edc948', '#b07aa1', '#ff9da7', '#9c755f', '#bab0ac' // More colors if needed
            ].slice(0, labels.length); // Use enough colors for the number of strategies


            distributionChart = new Chart(distributionCtx, {
                type: type,
                data: {
                    labels: labels,
                    datasets: [{
                        label: label,
                        data: data,
                        backgroundColor: colors,
                        borderColor: varToRgb("var(--surface-color)"),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (e) => { // Toggle controls on chart click (desktop only)
                        if (window.innerWidth > 768) showControls(e, 'distributionChartControls');
                    },
                    plugins: {
                        legend: {
                            position: type === 'bar' ? 'top' : 'right',
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== undefined) { // For bar chart
                                        label += new Intl.NumberFormat('en-US').format(context.parsed.y);
                                    } else if (context.parsed !== null) { // For pie/doughnut
                                        label += new Intl.NumberFormat('en-US').format(context.parsed);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: type === 'bar' ? {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: label
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Strategy Type'
                            }
                        }
                    } : {} // No scales for pie/doughnut
                }
            });
        }


        // Helper to convert CSS variable string to RGB(A)
        function varToRgb(colorString) {
            // console.log('Input to varToRgb:', colorString); // For debugging if needed
            const tempDiv = document.createElement('div');
            // Assign the colorString (e.g., "var(--primary-color)", "#FF0000", "blue").
            // The browser will compute its actual value.
            tempDiv.style.color = colorString;
            // Append to body so computed styles are applied
            document.body.appendChild(tempDiv);
            const computedColor = getComputedStyle(tempDiv).color;
            // Clean up the temporary div
            document.body.removeChild(tempDiv);
            console.log('computedColor', computedColor);
            // console.log('varToRgb computed color:', computedColor, 'for input:', colorString); // For debugging if needed
            return computedColor; // Returns in "rgb(r, g, b)" or "rgba(r, g, b, a)" format
        }


        // Floating Chart Controls Logic
        function showControls(event, controlsId) {
            const controls = document.getElementById(controlsId);
            // Check if click was inside the chart area
            const chartContainer = event.chart.canvas.closest('.chart-container');
            if (chartContainer) {
                // Close other active controls
                document.querySelectorAll('.floating-controls.active').forEach(c => {
                    if (c.id !== controlsId) {
                        c.classList.remove('active');
                    }
                });
                controls.classList.toggle('active');
            }
        }

        // Close panel when clicking outside controls or chart (desktop only)
        document.addEventListener('click', (e) => {
            if (window.innerWidth > 768) {
                document.querySelectorAll('.floating-controls.active').forEach(controls => {
                    const chartContainer = controls.closest('.card').querySelector('.chart-container');
                    if (!e.target.closest('.floating-controls') &&
                        !e.target.closest('.chart-container')) {
                        controls.classList.remove('active');
                    }
                });
            }
        });

        // Performance Chart Control Listeners
        document.getElementById('performanceChartType').addEventListener('change', (e) => {
            const type = e.target.value;
            const metric = document.getElementById('performanceMetricSelect').value;
            const timeframe = document.getElementById('performanceTimeframe').value;
            createPerformanceChart(type, metric, timeframe);
        });
        document.getElementById('performanceMetricSelect').addEventListener('change', (e) => {
            const type = document.getElementById('performanceChartType').value;
            const metric = e.target.value;
            const timeframe = document.getElementById('performanceTimeframe').value;
            createPerformanceChart(type, metric, timeframe);
        });
        document.getElementById('performanceTimeframe').addEventListener('change', (e) => {
            const type = document.getElementById('performanceChartType').value;
            const metric = document.getElementById('performanceMetricSelect').value;
            const timeframe = e.target.value;
            createPerformanceChart(type, metric, timeframe);
        });

        // Distribution Chart Control Listeners
        document.getElementById('distributionChartType').addEventListener('change', (e) => {
            const type = e.target.value;
            const metric = document.getElementById('distributionMetricSelect').value;
            createDistributionChart(type, metric);
        });
        document.getElementById('distributionMetricSelect').addEventListener('change', (e) => {
            const type = document.getElementById('distributionChartType').value;
            const metric = e.target.value;
            createDistributionChart(type, metric);
        });


        // --- Drag and Drop for Strategy Prioritization ---
        const strategyPriorityList = document.getElementById('strategyPriorityList');
        let draggingItem = null;

        strategyPriorityList.addEventListener('dragstart', (e) => {
            draggingItem = e.target;
            if (!draggingItem.classList.contains('drag-list-item')) {
                e.preventDefault(); // Only allow dragging list items
                return;
            }
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', draggingItem.dataset.id); // Use data-id
            // Set aria-grabbed state
            draggingItem.setAttribute('aria-grabbed', 'true');

            setTimeout(() => {
                draggingItem.classList.add('dragging');
            }, 0); // Add class after dragstart event finishes
        });

        strategyPriorityList.addEventListener('dragover', (e) => {
            e.preventDefault(); // Necessary to allow dropping
            e.dataTransfer.dropEffect = 'move';

            const targetItem = e.target.closest('.drag-list-item');
            if (targetItem && targetItem !== draggingItem) {
                const rect = targetItem.getBoundingClientRect();
                const midpoint = rect.y + rect.height / 2;

                if (e.clientY < midpoint) {
                    // Dragging above the target item
                    strategyPriorityList.insertBefore(draggingItem, targetItem);
                } else {
                    // Dragging below the target item
                    strategyPriorityList.insertBefore(draggingItem, targetItem.nextSibling);
                }
            }
        });

        strategyPriorityList.addEventListener('dragend', () => {
            if (draggingItem) {
                draggingItem.classList.remove('dragging');
                draggingItem.setAttribute('aria-grabbed', 'false');
                draggingItem = null;
                // Save the new order based on item data-id
                const newOrderIds = Array.from(strategyPriorityList.children).map(item => item.dataset.id);
                console.log('New strategy order:', newOrderIds);
                // Reorder the strategies array in state
                strategies.sort((a, b) => newOrderIds.indexOf(a.id) - newOrderIds.indexOf(b.id));
                saveState();
                showToast('Strategy priority updated.', 'info');
            }
        });

        // Add keyboard drag-and-drop support
        strategyPriorityList.addEventListener('keydown', (e) => {
            const currentItem = document.activeElement;
            if (!currentItem || !currentItem.classList.contains('drag-list-item')) return;

            if (e.key === ' ' || e.key === 'Enter') { // Space or Enter to 'grab'/'drop'
                e.preventDefault();
                if (draggingItem === currentItem) {
                    // Drop the item
                    draggingItem.classList.remove('dragging');
                    draggingItem.setAttribute('aria-grabbed', 'false');
                    draggingItem = null;
                    // Save the new order based on item data-id
                    const newOrderIds = Array.from(strategyPriorityList.children).map(item => item.dataset.id);
                    strategies.sort((a, b) => newOrderIds.indexOf(a.id) - newOrderIds.indexOf(b.id));
                    saveState();
                    showToast('Strategy priority updated.', 'info');
                } else {
                    // Grab the item
                    if (draggingItem) { // If another item was grabbed, drop it first
                        draggingItem.classList.remove('dragging');
                        draggingItem.setAttribute('aria-grabbed', 'false');
                    }
                    draggingItem = currentItem;
                    draggingItem.classList.add('dragging');
                    draggingItem.setAttribute('aria-grabbed', 'true');
                    showToast(`Grabbed "${currentItem.textContent.trim()}". Use arrow keys to move, Space/Enter to drop.`, 'info');
                }
            } else if (draggingItem === currentItem && (e.key === 'ArrowUp' || e.key === 'ArrowDown')) {
                e.preventDefault();
                const items = Array.from(strategyPriorityList.children);
                const currentIndex = items.indexOf(draggingItem);
                let newIndex = currentIndex;

                if (e.key === 'ArrowUp' && currentIndex > 0) {
                    newIndex = currentIndex - 1;
                } else if (e.key === 'ArrowDown' && currentIndex < items.length - 1) {
                    newIndex = currentIndex + 1;
                }

                if (newIndex !== currentIndex) {
                    const targetItem = items[newIndex];
                    if (e.key === 'ArrowUp') {
                        strategyPriorityList.insertBefore(draggingItem, targetItem);
                    } else {
                        strategyPriorityList.insertBefore(draggingItem, targetItem.nextSibling);
                    }
                    // Keep focus on the item being moved
                    draggingItem.focus();
                }
            }
        });


        // --- Table Actions (Delegation) ---
        function addTableActionListeners(tbodyId) {
            const tbody = document.getElementById(tbodyId);
            tbody.removeEventListener('click', handleTableAction); // Prevent duplicate listeners
            tbody.addEventListener('click', handleTableAction);
        }

        function handleTableAction(e) {
            const button = e.target.closest('button');
            if (!button) return;

            const action = button.dataset.action;
            const id = button.dataset.id;
            const row = button.closest('tr');
            const name = row.querySelector('td:first-child').textContent.trim(); // Get name from the first cell

            console.log(`Action "${action}" clicked for item ID: "${id}" (Name: "${name}")`);

            if (button.closest('#strategiesTableBody')) {
                handleStrategyAction(action, id, name);
            } else if (button.closest('#dataSourcesTableBody')) {
                handleDataSourceAction(action, id, name);
            } else if (button.closest('#abTestsTableBody')) {
                handleABTestAction(action, id, name);
            }
        }

        function handleStrategyAction(action, id, name) {
            const strategy = strategies.find(s => s.id === id);
            if (!strategy) return;

            if (action === 'edit') {
                loadStrategyIntoModal(strategy);
            } else if (action === 'duplicate') {
                const duplicatedStrategy = JSON.parse(JSON.stringify(strategy)); // Deep copy
                duplicatedStrategy.id = 's' + Date.now() + '_copy';
                duplicatedStrategy.name = `${strategy.name} (Copy)`;
                strategies.push(duplicatedStrategy);
                saveState();
                renderStrategiesTable();
                renderStrategyPriorityList();
                populateABTestStrategiesSelect();
                showToast(`Strategy "${name}" duplicated.`, 'success');
            } else if (action === 'deactivate') {
                strategy.status = 'Inactive';
                saveState();
                renderStrategiesTable();
                showToast(`Strategy "${name}" deactivated.`, 'info');
            } else if (action === 'activate') {
                strategy.status = 'Active';
                saveState();
                renderStrategiesTable();
                showToast(`Strategy "${name}" activated.`, 'info');
            } else if (action === 'delete') {
                // In a real app, add a confirmation modal
                strategies = strategies.filter(s => s.id !== id);
                saveState();
                renderStrategiesTable();
                renderStrategyPriorityList(); // Update priority list
                populateABTestStrategiesSelect(); // Update A/B test strategy options
                showToast(`Strategy "${name}" deleted.`, 'danger');
            }
        }

        function handleDataSourceAction(action, id, name) {
            const dataSource = dataSources.find(ds => ds.id === id);
            if (!dataSource) return;

            if (action === 'edit') {
                loadDataSourceIntoModal(dataSource);
            } else if (action === 'test') {
                showToast(`Testing connection for "${name}" (placeholder)...`, 'info');
                showLoading();
                setTimeout(() => {
                    hideLoading();
                    const isSuccess = Math.random() > 0.2; // 80% success rate
                    if (isSuccess) {
                        showToast('Connection successful (placeholder).', 'success');
                    } else {
                        showToast('Connection failed (placeholder).', 'danger');
                    }
                }, 1500);
            } else if (action === 'delete') {
                // In a real app, add a confirmation modal and check for dependencies (strategies using this source)
                dataSources = dataSources.filter(ds => ds.id !== id);
                saveState();
                renderDataSourcesTable();
                populateDataSourceSelects(); // Update strategy data source options
                showToast(`Data source "${name}" deleted.`, 'danger');
            }
        }

        function handleABTestAction(action, id, name) {
            const test = abTests.find(t => t.id === id);
            if (!test) return;

            if (action === 'view') {
                showToast(`Viewing results for "${name}" (placeholder).`, 'info');
                // In a real app, navigate to a results page or show a modal
            } else if (action === 'end') {
                // In a real app, add confirmation and backend call to stop the test
                test.status = 'Completed';
                test.endDate = new Date().toISOString().split('T')[0]; // Set end date
                saveState();
                renderABTestsTable();
                showToast(`A/B Test "${name}" ended.`, 'info');
            } else if (action === 'archive') {
                // In a real app, move to an archive list or hide
                showToast(`A/B Test "${name}" archived (placeholder).`, 'info');
            } else if (action === 'delete') {
                // In a real app, add confirmation
                abTests = abTests.filter(t => t.id !== id);
                saveState();
                renderABTestsTable();
                showToast(`A/B Test "${name}" deleted.`, 'danger');
            }
        }


        // --- Reports Section ---
        document.getElementById('reportTimeframeSelect').addEventListener('change', (e) => {
            const customTimeframeDiv = document.getElementById('customTimeframe');
            if (e.target.value === 'custom') {
                customTimeframeDiv.style.display = 'block';
            } else {
                customTimeframeDiv.style.display = 'none';
            }
        });

        document.getElementById('generateReportBtn').addEventListener('click', () => {
            const reportType = document.getElementById('reportTypeSelect').value;
            const timeframe = document.getElementById('reportTimeframeSelect').value;
            let startDate = null;
            let endDate = null;

            if (timeframe === 'custom') {
                startDate = document.getElementById('reportStartDate').value;
                endDate = document.getElementById('reportEndDate').value;
                if (!startDate || !endDate) {
                    showToast('Please select both start and end dates for a custom range.', 'warning');
                    return;
                }
            }

            console.log(`Generating Report: Type=${reportType}, Timeframe=${timeframe}, Dates=${startDate} to ${endDate}`);
            showLoading();
            // Simulate report generation
            setTimeout(() => {
                hideLoading();
                showToast('Report generated (placeholder).', 'success');
                // In a real app, update the #reportViewer content with actual data
            }, 1500);
        });

        document.getElementById('downloadReportBtn').addEventListener('click', () => {
            const reportType = document.getElementById('reportTypeSelect').value;
            const timeframe = document.getElementById('reportTimeframeSelect').value;
            let startDate = null;
            let endDate = null;

            if (timeframe === 'custom') {
                startDate = document.getElementById('reportStartDate').value;
                endDate = document.getElementById('reportEndDate').value;
                if (!startDate || !endDate) {
                    showToast('Cannot download report: Please select both start and end dates for a custom range.', 'warning');
                    return;
                }
            }

            console.log(`Downloading Report: Type=${reportType}, Timeframe=${timeframe}, Dates=${startDate} to ${endDate}`);
            showToast('Downloading report (placeholder CSV)...', 'info');
        });


        // --- Initial Setup ---
        // Load state from localStorage
        loadState();

        // Render initial tables and lists
        renderStrategiesTable();
        renderDataSourcesTable();
        renderABTestsTable();
        renderStrategyPriorityList();
        populateDataSourceSelects();
        populateABTestStrategiesSelect();

        // Create initial charts
        createPerformanceChart();
        createDistributionChart();

        // Ensure the first section is active on load
        // This is already handled by the click simulation on the first nav link


    </script>

</body>

</html>