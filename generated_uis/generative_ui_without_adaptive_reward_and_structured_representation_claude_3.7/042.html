<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Startup Financial Projections</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        :root {
            --primary-color: #007bff;
            --primary-color-dark: #0056b3;
            --primary-color-light: #e9f5ff;
            --secondary-color: #6c757d;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --background-color: #f8f9fa;
            --surface-color: #ffffff;
            --border-color: #dee2e6;
            --text-color: #212529;
            --text-light-color: #6c757d;
            --font-family: 'Inter', sans-serif;
            --spacing-unit: 8px;
            --header-height: 60px;
            --sidebar-width: 250px;
            --border-radius: 4px;
            --box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            --transition-speed: 0.2s;
        }

        body {
            font-family: var(--font-family);
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--background-color);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }

        header {
            background-color: var(--surface-color);
            color: var(--text-color);
            padding: 0 calc(var(--spacing-unit) * 3);
            height: var(--header-height);
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: var(--box-shadow);
            position: fixed;
            width: 100%;
            top: 0;
            left: 0;
            z-index: 1000;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        nav a {
            color: var(--text-light-color);
            text-decoration: none;
            margin-left: calc(var(--spacing-unit) * 3);
            font-weight: 500;
            transition: color var(--transition-speed) ease;
        }

        nav a:hover {
            color: var(--primary-color);
        }

        .container {
            display: flex;
            flex: 1;
            margin-top: var(--header-height);
        }

        aside {
            width: var(--sidebar-width);
            background-color: var(--surface-color);
            padding: calc(var(--spacing-unit) * 3) 0;
            box-shadow: var(--box-shadow);
            flex-shrink: 0;
            position: fixed;
            top: var(--header-height);
            bottom: 0;
            left: 0;
            overflow-y: auto;
            z-index: 999;
            transition: left var(--transition-speed) ease-in-out;
        }

        aside h3 {
            font-size: 1.1rem;
            color: var(--text-light-color);
            padding: 0 calc(var(--spacing-unit) * 3) var(--spacing-unit);
            margin-top: 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        aside nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        aside nav li a {
            display: block;
            padding: calc(var(--spacing-unit) * 1.5) calc(var(--spacing-unit) * 3);
            color: var(--text-color);
            text-decoration: none;
            transition: background-color var(--transition-speed) ease, color var(--transition-speed) ease;
            border-left: 3px solid transparent;
            font-weight: 500;
        }

        aside nav li a:hover {
            background-color: var(--background-color);
            color: var(--primary-color);
        }

        aside nav li a.active {
            background-color: var(--primary-color);
            color: var(--surface-color);
            font-weight: 600;
            border-left-color: var(--primary-color);
        }

        main {
            flex: 1;
            padding: calc(var(--spacing-unit) * 4);
            margin-left: var(--sidebar-width);
            transition: margin-left var(--transition-speed) ease-in-out;
        }

        section {
            background-color: var(--surface-color);
            padding: calc(var(--spacing-unit) * 4);
            margin-bottom: calc(var(--spacing-unit) * 4);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        h1, h2, h3 {
            color: var(--text-color);
            margin-top: 0;
            margin-bottom: calc(var(--spacing-unit) * 3);
        }

        h1 {
            font-size: 2rem;
            font-weight: 700;
        }

        h2 {
            font-size: 1.5rem;
            font-weight: 600;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: calc(var(--spacing-unit) * 2);
            margin-bottom: calc(var(--spacing-unit) * 4);
        }

        h3 {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: calc(var(--spacing-unit) * 2);
        }

        .form-group {
            margin-bottom: calc(var(--spacing-unit) * 3);
        }

        label {
            display: block;
            margin-bottom: var(--spacing-unit);
            font-weight: 500;
            color: var(--text-color);
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            display: block;
            width: 100%;
            padding: calc(var(--spacing-unit) * 1.5);
            font-size: 1rem;
            line-height: 1.5;
            color: var(--text-color);
            background-color: var(--surface-color);
            background-clip: padding-box;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            transition: border-color var(--transition-speed) ease-in-out, box-shadow var(--transition-speed) ease-in-out;
            box-sizing: border-box;
        }

         input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="date"]:focus,
        select:focus,
        textarea:focus {
            border-color: var(--primary-color);
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        input.error, select.error, textarea.error {
            border-color: var(--danger-color);
        }

        button {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            color: var(--surface-color);
            text-align: center;
            vertical-align: middle;
            user-select: none;
            background-color: var(--primary-color);
            border: 1px solid var(--primary-color);
            padding: calc(var(--spacing-unit) * 1.5) calc(var(--spacing-unit) * 3);
            font-size: 1rem;
            line-height: 1.5;
            border-radius: var(--border-radius);
            transition: color var(--transition-speed) ease-in-out, background-color var(--transition-speed) ease-in-out, border-color var(--transition-speed) ease-in-out, box-shadow var(--transition-speed) ease-in-out, opacity var(--transition-speed) ease-in-out;
            cursor: pointer;
            margin-right: var(--spacing-unit);
            gap: var(--spacing-unit);
        }

        button:hover {
            background-color: var(--primary-color-dark);
            border-color: var(--primary-color-dark);
            color: var(--surface-color);
        }

        button:active {
            background-color: #004085;
            border-color: #004085;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        button:focus {
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        button.secondary {
            color: var(--text-color);
            background-color: var(--background-color);
            border-color: var(--border-color);
        }

        button.secondary:hover {
            color: var(--primary-color);
            background-color: #e9ecef;
            border-color: #ced4da;
        }

        button.secondary:active {
            color: var(--primary-color);
            background-color: #dae0e5;
            border-color: #d3d9df;
            box-shadow: 0 0 0 0.2rem rgba(108, 117, 125, 0.25);
        }

        button.icon-button {
            padding: var(--spacing-unit);
            background-color: transparent;
            border: none;
            color: var(--text-light-color);
            margin-right: 0;
            transition: color var(--transition-speed) ease, background-color var(--transition-speed) ease;
            border-radius: var(--border-radius); /* Make icon buttons slightly rounded */
        }

        button.icon-button:hover {
            color: var(--text-color);
            background-color: var(--background-color);
        }

        button.icon-button:active {
            color: var(--primary-color);
            background-color: var(--primary-color-light);
        }

        button.icon-button .material-symbols-rounded {
            font-size: 20px;
            vertical-align: middle;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: calc(var(--spacing-unit) * 3);
        }

        th, td {
            padding: calc(var(--spacing-unit) * 1.5);
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: var(--background-color);
            font-weight: 600;
            color: var(--text-color);
        }

        tbody tr:hover {
            background-color: var(--primary-color-light);
        }

        td .actions button {
            margin-right: var(--spacing-unit);
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: calc(var(--spacing-unit) * 3);
            margin-top: calc(var(--spacing-unit) * 4);
        }

        .summary-card {
            background-color: var(--background-color);
            padding: calc(var(--spacing-unit) * 3);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }

        .summary-card h3 {
            margin-bottom: var(--spacing-unit);
            font-size: 1.1rem;
            color: var(--text-light-color);
        }

        .summary-card p {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
            color: var(--primary-color);
        }

        .chart-container {
            position: relative;
            height: 400px;
            margin-top: calc(var(--spacing-unit) * 4);
            padding: calc(var(--spacing-unit) * 3);
            background-color: var(--background-color);
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
            opacity: 0;
            transition: opacity var(--transition-speed) ease-in-out;
        }

        .modal.show {
            display: flex;
            opacity: 1;
        }

        .modal-content {
            background-color: var(--surface-color);
            margin: auto;
            padding: calc(var(--spacing-unit) * 4);
            border-radius: var(--border-radius);
            width: 90%;
            max-width: 600px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            transform: translateY(-20px);
            transition: transform var(--transition-speed) ease-in-out;
        }

        .modal.show .modal-content {
             transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: calc(var(--spacing-unit) * 2);
            margin-bottom: calc(var(--spacing-unit) * 3);
        }

        .modal-header h3 {
            margin: 0;
        }

        .modal-close {
            color: var(--text-light-color);
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: color var(--transition-speed) ease;
        }

        .modal-close:hover,
        .modal-close:focus {
            color: var(--text-color);
            text-decoration: none;
            outline: none;
        }

        .modal-footer {
            border-top: 1px solid var(--border-color);
            padding-top: calc(var(--spacing-unit) * 3);
            margin-top: calc(var(--spacing-unit) * 3);
            text-align: right;
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-unit);
        }

        .loading-indicator {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .loading-indicator.show {
            display: flex;
        }

        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        [title]:hover {
            cursor: help;
        }

        .sidebar-toggle {
            display: none;
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 1.5rem;
            cursor: pointer;
            padding: var(--spacing-unit);
            margin-right: var(--spacing-unit);
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            aside {
                left: calc(-1 * var(--sidebar-width));
            }

            aside.open {
                left: 0;
            }

            main {
                margin-left: 0;
                padding: calc(var(--spacing-unit) * 2);
            }

            header {
                padding: 0 calc(var(--spacing-unit) * 2);
            }

            .logo {
                font-size: 1.2rem;
            }

            nav {
                display: none;
            }

            .sidebar-toggle {
                display: block;
            }

            .summary-cards {
                grid-template-columns: 1fr;
            }

            .chart-container {
                height: 300px;
            }
        }

        @media (min-width: 769px) {
            .sidebar-toggle {
                display: none;
            }
        }

        /* Chart.js Floating Controls */
        .chart-controls {
            position: absolute;
            top: calc(var(--spacing-unit) * 2);
            right: calc(var(--spacing-unit) * 2);
            background: rgba(255, 255, 255, 0.9);
            padding: calc(var(--spacing-unit) * 2);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            display: flex;
            gap: var(--spacing-unit);
            z-index: 10;
        }

        .chart-controls select {
            padding: var(--spacing-unit);
            font-size: 0.9rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            background-color: var(--surface-color);
            color: var(--text-color);
            cursor: pointer;
        }

        .chart-controls select:focus {
             border-color: var(--primary-color);
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .input-group {
            display: flex;
            gap: calc(var(--spacing-unit) * 2);
            align-items: flex-start;
            margin-bottom: calc(var(--spacing-unit) * 3);
            padding-bottom: calc(var(--spacing-unit) * 3);
            border-bottom: 1px solid var(--border-color);
        }

        .input-group:last-child {
             border-bottom: none;
             padding-bottom: 0;
        }

        .input-group .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .input-group .remove-item-button {
             margin-top: calc(var(--spacing-unit) * 3); /* Align with label/input top */
             flex-shrink: 0;
        }

        .scenario-controls, .report-controls {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-unit);
            margin-top: calc(var(--spacing-unit) * 3);
        }

        .report-modal-body table {
             width: 100%;
             border-collapse: collapse;
             margin-top: calc(var(--spacing-unit) * 3);
             font-size: 0.9rem;
             overflow-x: auto; /* Enable horizontal scrolling for wide tables */
             display: block; /* Needed for overflow-x to work on table */
             white-space: nowrap; /* Prevent wrapping */
        }

         .report-modal-body thead th,
         .report-modal-body tbody td {
             padding: calc(var(--spacing-unit) * 1);
             border: 1px solid var(--border-color);
             min-width: 80px; /* Ensure columns have minimum width */
         }

         .report-modal-body thead th {
             background-color: var(--background-color);
             font-weight: 600;
             position: sticky;
             top: 0; /* Stick header to top */
             z-index: 1;
         }

         .report-modal-body tbody tr:nth-child(even) {
             background-color: var(--background-color);
         }

         .report-modal-body tbody tr:hover {
             background-color: var(--primary-color-light);
         }

         .report-modal-body td:first-child {
             font-weight: 500;
             position: sticky;
             left: 0; /* Stick first column */
             background-color: var(--surface-color);
             z-index: 2;
         }

         .report-modal-body tbody tr:nth-child(even) td:first-child {
             background-color: var(--background-color);
         }


         .report-modal-body th:first-child {
             position: sticky;
             left: 0; /* Stick first header column */
             z-index: 3; /* Ensure it's above body cells */
         }

         .report-modal-body .total-column {
             font-weight: 700;
             background-color: var(--primary-color-light);
             position: sticky;
             right: 0; /* Stick total column */
             z-index: 2;
         }

          .report-modal-body thead .total-column {
             background-color: var(--background-color);
             z-index: 3;
         }


        /* Visually hidden class for accessibility */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            margin: -1px;
            padding: 0;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

    </style>
</head>
<body>

    <header>
        <button class="sidebar-toggle" aria-label="Toggle Sidebar">
             <span class="material-symbols-rounded">menu</span>
        </button>
        <div class="logo">StartupProjections</div>
        <nav aria-label="Main navigation">
            <a href="#dashboard">Dashboard</a>
            <a href="#scenarios">Scenarios</a>
            <a href="#reports">Reports</a>
        </nav>
    </header>

    <div class="container">
        <aside id="sidebar" aria-label="Input sections navigation">
            <h3>Input Sections</h3>
            <nav>
                <ul>
                    <li><a href="#revenue" class="sidebar-link active">Revenue</a></li>
                    <li><a href="#expenses" class="sidebar-link">Expenses</a></li>
                    <li><a href="#funding" class="sidebar-link">Funding</a></li>
                    <li><a href="#personnel" class="sidebar-link">Personnel</a></li>
                </ul>
            </nav>
        </aside>

        <main>
            <section id="dashboard" class="content-section" style="display: block;" aria-labelledby="dashboard-heading">
                <h1 id="dashboard-heading">Dashboard</h1>
                <p>Overview of key financial projections.</p>

                <div class="summary-cards" aria-live="polite">
                    <div class="summary-card">
                        <h3>Total Revenue (Year 1)</h3>
                        <p id="summary-revenue">$0.00</p>
                    </div>
                    <div class="summary-card">
                        <h3>Total Expenses (Year 1)</h3>
                        <p id="summary-expenses">$0.00</p>
                    </div>
                    <div class="summary-card">
                        <h3>Net Income (Year 1)</h3>
                        <p id="summary-netincome">$0.00</p>
                    </div>
                     <div class="summary-card">
                        <h3>Ending Cash Balance (Year 1)</h3>
                        <p id="summary-cash">$0.00</p>
                    </div>
                </div>

                <h2>Key Metrics Trend</h2>
                <div id="keyMetricsChartContainer" class="chart-container" role="img" aria-label="Key financial metrics over time chart">
                    <canvas id="keyMetricsChart"></canvas>
                     <div class="chart-controls" id="keyMetricsChartControls">
                         <label for="keyMetricsChartType" class="visually-hidden">Select Chart Type</label>
                        <select id="keyMetricsChartType" aria-label="Select chart type">
                            <option value="line">Line</option>
                            <option value="bar">Bar</option>
                        </select>
                         <label for="keyMetricsChartData" class="visually-hidden">Select Data View</label>
                         <select id="keyMetricsChartData" aria-label="Select data view">
                             <option value="all">All Metrics</option>
                             <option value="revenue">Revenue Only</option>
                             <option value="expenses">Expenses Only</option>
                             <option value="netIncome">Net Income Only</option>
                             <option value="cashFlow">Cash Flow Only</option>
                             <option value="endingCash">Ending Cash Only</option>
                         </select>
                    </div>
                </div>

            </section>

            <section id="revenue" class="content-section" style="display: none;" aria-labelledby="revenue-heading">
                <h2 id="revenue-heading">Revenue Projections</h2>
                <p>Define your revenue streams.</p>

                <div id="revenue-items">
                    <!-- Dynamic revenue items will be added here -->
                     <div class="input-group" data-id="1">
                         <div class="form-group">
                            <label for="revenue-item-name-1">Revenue Stream Name</label>
                            <input type="text" id="revenue-item-name-1" placeholder="e.g., Product Sales" required aria-required="true">
                        </div>
                         <div class="form-group">
                            <label for="revenue-item-type-1">Type</label>
                            <select id="revenue-item-type-1" aria-required="true">
                                <option value="monthly">Monthly Recurring</option>
                                <option value="one-time">One-Time</option>
                                <option value="per-unit">Per Unit</option>
                            </select>
                        </div>
                         <div class="form-group">
                            <label for="revenue-item-amount-1">Monthly/Unit Amount</label>
                            <input type="number" id="revenue-item-amount-1" value="0" min="0" required aria-required="true">
                        </div>
                         <div class="form-group">
                            <label for="revenue-item-start-month-1">Start Month</label>
                            <input type="number" id="revenue-item-start-month-1" value="1" min="1" max="120" title="Month number from projection start (1-120)" required aria-required="true">
                        </div>
                        <button class="icon-button remove-item-button" data-section="revenue" data-id="1" aria-label="Remove Revenue Item">
                             <span class="material-symbols-rounded">delete</span>
                        </button>
                    </div>
                </div>

                <button id="add-revenue-item" aria-controls="revenue-items">
                     <span class="material-symbols-rounded">add</span>
                     Add Revenue Stream
                </button>

                <h3>Revenue Items Table</h3>
                <table id="revenue-table" aria-live="polite">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Start Month</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be populated here -->
                    </tbody>
                </table>

            </section>

            <section id="expenses" class="content-section" style="display: none;" aria-labelledby="expenses-heading">
                <h2 id="expenses-heading">Expense Projections</h2>
                <p>Define your operating expenses.</p>

                 <div id="expense-items">
                    <!-- Dynamic expense items will be added here -->
                     <div class="input-group" data-id="1">
                         <div class="form-group">
                            <label for="expense-item-name-1">Expense Name</label>
                            <input type="text" id="expense-item-name-1" placeholder="e.g., Rent" required aria-required="true">
                        </div>
                         <div class="form-group">
                            <label for="expense-item-type-1">Type</label>
                            <select id="expense-item-type-1" aria-required="true">
                                <option value="monthly">Monthly Recurring</option>
                                <option value="one-time">One-Time</option>
                            </select>
                        </div>
                         <div class="form-group">
                            <label for="expense-item-amount-1">Monthly/One-Time Amount</label>
                            <input type="number" id="expense-item-amount-1" value="0" min="0" required aria-required="true">
                        </div>
                         <div class="form-group">
                            <label for="expense-item-start-month-1">Start Month</label>
                            <input type="number" id="expense-item-start-month-1" value="1" min="1" max="120" title="Month number from projection start (1-120)" required aria-required="true">
                        </div>
                         <button class="icon-button remove-item-button" data-section="expenses" data-id="1" aria-label="Remove Expense Item">
                             <span class="material-symbols-rounded">delete</span>
                        </button>
                    </div>
                </div>

                <button id="add-expense-item" aria-controls="expense-items">
                     <span class="material-symbols-rounded">add</span>
                     Add Expense Item
                </button>

                <h3>Expense Items Table</h3>
                 <table id="expense-table" aria-live="polite">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Start Month</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be populated here -->
                    </tbody>
                </table>

            </section>

            <section id="funding" class="content-section" style="display: none;" aria-labelledby="funding-heading">
                <h2 id="funding-heading">Funding Projections</h2>
                <p>Define your funding sources.</p>

                 <div id="funding-items">
                    <!-- Dynamic funding items will be added here -->
                     <div class="input-group" data-id="1">
                         <div class="form-group">
                            <label for="funding-item-name-1">Funding Source Name</label>
                            <input type="text" id="funding-item-name-1" placeholder="e.g., Seed Round" required aria-required="true">
                        </div>
                         <div class="form-group">
                            <label for="funding-item-type-1">Type</label>
                            <select id="funding-item-type-1" aria-required="true">
                                <option value="equity">Equity</option>
                                <option value="debt">Debt</option>
                                <option value="grant">Grant</option>
                            </select>
                        </div>
                         <div class="form-group">
                            <label for="funding-item-amount-1">Amount</label>
                            <input type="number" id="funding-item-amount-1" value="0" min="0" required aria-required="true">
                        </div>
                         <div class="form-group">
                            <label for="funding-item-month-1">Month Received</label>
                            <input type="number" id="funding-item-month-1" value="1" min="1" max="120" title="Month number from projection start (1-120)" required aria-required="true">
                        </div>
                         <button class="icon-button remove-item-button" data-section="funding" data-id="1" aria-label="Remove Funding Item">
                             <span class="material-symbols-rounded">delete</span>
                        </button>
                    </div>
                </div>

                <button id="add-funding-item" aria-controls="funding-items">
                     <span class="material-symbols-rounded">add</span>
                     Add Funding Source
                </button>

                <h3>Funding Sources Table</h3>
                 <table id="funding-table" aria-live="polite">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Month Received</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </section>

            <section id="personnel" class="content-section" style="display: none;" aria-labelledby="personnel-heading">
                <h2 id="personnel-heading">Personnel Projections</h2>
                <p>Define your team and associated costs.</p>

                 <div id="personnel-items">
                    <!-- Dynamic personnel items will be added here -->
                     <div class="input-group" data-id="1">
                         <div class="form-group">
                            <label for="personnel-item-role-1">Role/Title</label>
                            <input type="text" id="personnel-item-role-1" placeholder="e.g., Software Engineer" required aria-required="true">
                        </div>
                         <div class="form-group">
                            <label for="personnel-item-salary-1">Annual Salary</label>
                            <input type="number" id="personnel-item-salary-1" value="0" min="0" required aria-required="true">
                        </div>
                         <div class="form-group">
                            <label for="personnel-item-start-month-1">Start Month</label>
                            <input type="number" id="personnel-item-start-month-1" value="1" min="1" max="120" title="Month number from projection start (1-120)" required aria-required="true">
                        </div>
                         <div class="form-group">
                            <label for="personnel-item-benefits-1">Benefits/Tax % (of salary)</label>
                            <input type="number" id="personnel-item-benefits-1" value="15" min="0" max="100" required aria-required="true">
                        </div>
                         <button class="icon-button remove-item-button" data-section="personnel" data-id="1" aria-label="Remove Personnel Item">
                             <span class="material-symbols-rounded">delete</span>
                        </button>
                    </div>
                </div>

                <button id="add-personnel-item" aria-controls="personnel-items">
                     <span class="material-symbols-rounded">add</span>
                     Add Personnel
                </button>

                <h3>Personnel Table</h3>
                 <table id="personnel-table" aria-live="polite">
                    <thead>
                        <tr>
                            <th>Role</th>
                            <th>Annual Salary</th>
                            <th>Start Month</th>
                            <th>Benefits/Tax %</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </section>

            <section id="scenarios" class="content-section" style="display: none;" aria-labelledby="scenarios-heading">
                <h2 id="scenarios-heading">Scenario Management</h2>
                <p>Create and manage different projection scenarios.</p>
                 <div class="form-group">
                    <label for="scenario-select">Select Scenario</label>
                    <select id="scenario-select" aria-label="Select projection scenario">
                        <option value="default">Default Scenario</option>
                    </select>
                 </div>
                 <div class="scenario-controls">
                     <button id="create-scenario-button">
                         <span class="material-symbols-rounded">add</span>
                         Create New Scenario
                     </button>
                     <button id="duplicate-scenario-button" class="secondary">
                         <span class="material-symbols-rounded">content_copy</span>
                         Duplicate Scenario
                     </button>
                     <button id="rename-scenario-button" class="secondary">
                         <span class="material-symbols-rounded">edit</span>
                         Rename Scenario
                     </button>
                     <button id="delete-scenario-button" class="secondary">
                         <span class="material-symbols-rounded">delete</span>
                         Delete Scenario
                     </button>
                 </div>
            </section>

             <section id="reports" class="content-section" style="display: none;" aria-labelledby="reports-heading">
                <h2 id="reports-heading">Reports</h2>
                <p>Generate financial reports.</p>
                <div class="report-controls">
                    <button id="generate-income-statement">Generate Income Statement</button>
                    <button id="generate-cash-flow">Generate Cash Flow Statement</button>
                    <button id="generate-balance-sheet">Generate Balance Sheet</button>
                    <button id="export-csv" class="secondary">Export to CSV</button>
                    <button id="export-pdf" class="secondary">Export to PDF</button>
                </div>
            </section>

            <button id="calculate-projections" aria-live="polite">
                 <span class="material-symbols-rounded">calculate</span>
                 Calculate Projections
            </button>

        </main>
    </div>

    <!-- Modals -->
    <div id="editItemModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Edit Item</h3>
                <span class="modal-close" aria-label="Close modal">&times;</span>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Form fields for editing will be dynamically loaded here -->
            </div>
            <div class="modal-footer">
                <button class="secondary modal-cancel">Cancel</button>
                <button class="modal-save">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="reportModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="report-modal-title">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h3 id="report-modal-title">Financial Report</h3>
                <span class="modal-close report-modal-close" aria-label="Close modal">&times;</span>
            </div>
            <div class="modal-body" id="report-modal-body">
                <!-- Report content will be loaded here -->
                 <table id="report-table">
                    <thead>
                        <tr>
                            <th>Metric</th>
                            <!-- Month headers will be added by JS -->
                            <th class="total-column">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Data rows will be added by JS -->
                    </tbody>
                </table>
            </div>
            <div class="modal-footer">
                 <button class="secondary report-modal-close">Close</button>
            </div>
        </div>
    </div>


     <!-- Loading Indicator -->
    <div id="loading-indicator" class="loading-indicator" aria-label="Loading" role="status">
        <div class="spinner"></div>
    </div>

    <script type="module">
        import { Chart } from "https://esm.sh/chart.js/auto";

        const sidebar = document.getElementById('sidebar');
        const sidebarToggle = document.querySelector('.sidebar-toggle');
        const sidebarLinks = document.querySelectorAll('.sidebar-link');
        const contentSections = document.querySelectorAll('.content-section');
        const calculateButton = document.getElementById('calculate-projections');
        const loadingIndicator = document.getElementById('loading-indicator');

        // Dynamic Form Item Counters (using UUIDs or timestamps in a real app)
        let nextItemId = 2; // Start after the initial item

        // Add Item Buttons
        const addRevenueButton = document.getElementById('add-revenue-item');
        const addExpenseButton = document.getElementById('add-expense-item');
        const addFundingButton = document.getElementById('add-funding-item');
        const addPersonnelButton = document.getElementById('add-personnel-item');

        // Item Containers
        const revenueItemsContainer = document.getElementById('revenue-items');
        const expenseItemsContainer = document.getElementById('expense-items');
        const fundingItemsContainer = document.getElementById('funding-items');
        const personnelItemsContainer = document.getElementById('personnel-items');


        // Tables
        const revenueTableBody = document.querySelector('#revenue-table tbody');
        const expenseTableBody = document.querySelector('#expense-table tbody');
        const fundingTableBody = document.querySelector('#funding-table tbody');
        const personnelTableBody = document.querySelector('#personnel-table tbody');

        // Modals
        const editItemModal = document.getElementById('editItemModal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalClose = document.querySelector('.modal-close');
        const modalCancel = document.querySelector('.modal-cancel');
        const modalSave = document.querySelector('.modal-save');

        const reportModal = document.getElementById('reportModal');
        const reportModalTitle = document.getElementById('report-modal-title');
        const reportModalBody = document.getElementById('report-modal-body');
        const reportModalClose = document.querySelector('.report-modal-close');
        const reportTable = document.getElementById('report-table');


        // Chart Instance and Controls
        let keyMetricsChart = null;
        const keyMetricsChartCanvas = document.getElementById('keyMetricsChart');
        const keyMetricsChartTypeSelect = document.getElementById('keyMetricsChartType');
        const keyMetricsChartDataSelect = document.getElementById('keyMetricsChartData');
        const keyMetricsChartContainer = document.getElementById('keyMetricsChartContainer');
        const keyMetricsChartControls = document.getElementById('keyMetricsChartControls');


        // Data Storage (Simulated State Management)
        let currentProjectionData = {
            revenue: [],
            expenses: [],
            funding: [],
            personnel: []
        };

        let calculatedMonthlyData = {
             labels: [],
             revenue: [],
             expenses: [],
             personnelCosts: [], // Store personnel costs separately for cash flow/reports
             funding: [], // Store funding monthly for cash flow/reports
             netIncome: [],
             cashFlow: [],
             endingCash: []
        };

        const PROJECTION_MONTHS = 36; // Project for 3 years

        // --- Navigation and Section Switching ---
        sidebarToggle.addEventListener('click', () => {
            sidebar.classList.toggle('open');
        });

        sidebarLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const targetId = link.getAttribute('href').substring(1);

                // Collect data from the section being LEFT
                const activeSection = document.querySelector('.content-section[style*="block"]');
                if (activeSection && ['revenue', 'expenses', 'funding', 'personnel'].includes(activeSection.id)) {
                     collectDataFromForms(activeSection.id);
                }

                // Update active sidebar link
                sidebarLinks.forEach(nav => nav.classList.remove('active'));
                link.classList.add('active');

                // Hide all content sections and chart controls
                contentSections.forEach(section => {
                    section.style.display = 'none';
                    section.setAttribute('aria-hidden', 'true');
                });
                keyMetricsChartControls.style.display = 'none';


                // Show the target section
                const targetSection = document.getElementById(targetId);
                if (targetSection) {
                    targetSection.style.display = 'block';
                    targetSection.setAttribute('aria-hidden', 'false');
                }

                 // If navigating to dashboard, ensure chart is rendered/updated and controls are visible
                if (targetId === 'dashboard') {
                     updateSummaryDashboard(); // Ensure summary is updated with latest calculated data
                     renderKeyMetricsChart(calculatedMonthlyData);
                     keyMetricsChartControls.style.display = 'flex';
                }
            });
        });

        // Set initial section visibility and aria-hidden
         contentSections.forEach(section => {
             if (section.id !== 'dashboard') {
                 section.style.display = 'none';
                 section.setAttribute('aria-hidden', 'true');
             } else {
                 section.setAttribute('aria-hidden', 'false');
             }
         });
         keyMetricsChartControls.style.display = 'flex'; // Initially show controls on dashboard


        // --- Dynamic Form Item Addition ---

        function createInputGroup(section, id) {
            let formHtml = '';
            switch (section) {
                case 'revenue':
                    formHtml = `
                        <div class="form-group">
                           <label for="revenue-item-name-${id}">Revenue Stream Name</label>
                           <input type="text" id="revenue-item-name-${id}" placeholder="e.g., Product Sales" required aria-required="true">
                       </div>
                        <div class="form-group">
                           <label for="revenue-item-type-${id}">Type</label>
                           <select id="revenue-item-type-${id}" aria-required="true">
                               <option value="monthly">Monthly Recurring</option>
                               <option value="one-time">One-Time</option>
                               <option value="per-unit">Per Unit</option>
                           </select>
                       </div>
                        <div class="form-group">
                           <label for="revenue-item-amount-${id}">Monthly/Unit Amount</label>
                           <input type="number" id="revenue-item-amount-${id}" value="0" min="0" required aria-required="true">
                       </div>
                        <div class="form-group">
                           <label for="revenue-item-start-month-${id}">Start Month</label>
                           <input type="number" id="revenue-item-start-month-${id}" value="1" min="1" max="${PROJECTION_MONTHS}" title="Month number from projection start (1-${PROJECTION_MONTHS})" required aria-required="true">
                       </div>
                   `;
                    break;
                case 'expenses':
                    formHtml = `
                        <div class="form-group">
                           <label for="expense-item-name-${id}">Expense Name</label>
                           <input type="text" id="expense-item-name-${id}" placeholder="e.g., Rent" required aria-required="true">
                       </div>
                        <div class="form-group">
                           <label for="expense-item-type-${id}">Type</label>
                           <select id="expense-item-type-${id}" aria-required="true">
                               <option value="monthly">Monthly Recurring</option>
                               <option value="one-time">One-Time</option>
                           </select>
                       </div>
                        <div class="form-group">
                           <label for="expense-item-amount-${id}">Monthly/One-Time Amount</label>
                           <input type="number" id="expense-item-amount-${id}" value="0" min="0" required aria-required="true">
                       </div>
                        <div class="form-group">
                           <label for="expense-item-start-month-${id}">Start Month</label>
                           <input type="number" id="expense-item-start-month-${id}" value="1" min="1" max="${PROJECTION_MONTHS}" title="Month number from projection start (1-${PROJECTION_MONTHS})" required aria-required="true">
                       </div>
                   `;
                    break;
                case 'funding':
                    formHtml = `
                        <div class="form-group">
                           <label for="funding-item-name-${id}">Funding Source Name</label>
                           <input type="text" id="funding-item-name-${id}" placeholder="e.g., Seed Round" required aria-required="true">
                       </div>
                        <div class="form-group">
                           <label for="funding-item-type-${id}">Type</label>
                           <select id="funding-item-type-${id}" aria-required="true">
                               <option value="equity">Equity</option>
                               <option value="debt">Debt</option>
                               <option value="grant">Grant</option>
                           </select>
                       </div>
                        <div class="form-group">
                           <label for="funding-item-amount-${id}">Amount</label>
                           <input type="number" id="funding-item-amount-${id}" value="0" min="0" required aria-required="true">
                       </div>
                        <div class="form-group">
                           <label for="funding-item-month-${id}">Month Received</label>
                           <input type="number" id="funding-item-month-${id}" value="1" min="1" max="${PROJECTION_MONTHS}" title="Month number from projection start (1-${PROJECTION_MONTHS})" required aria-required="true">
                       </div>
                   `;
                    break;
                case 'personnel':
                    formHtml = `
                        <div class="form-group">
                           <label for="personnel-item-role-${id}">Role/Title</label>
                           <input type="text" id="personnel-item-role-${id}" placeholder="e.g., Software Engineer" required aria-required="true">
                       </div>
                        <div class="form-group">
                           <label for="personnel-item-salary-${id}">Annual Salary</label>
                           <input type="number" id="personnel-item-salary-${id}" value="0" min="0" required aria-required="true">
                       </div>
                        <div class="form-group">
                           <label for="personnel-item-start-month-${id}">Start Month</label>
                           <input type="number" id="personnel-item-start-month-${id}" value="1" min="1" max="${PROJECTION_MONTHS}" title="Month number from projection start (1-${PROJECTION_MONTHS})" required aria-required="true">
                       </div>
                         <div class="form-group">
                            <label for="personnel-item-benefits-${id}">Benefits/Tax % (of salary)</label>
                            <input type="number" id="personnel-item-benefits-${id}" value="15" min="0" max="100" required aria-required="true">
                        </div>
                   `;
                    break;
            }

             const itemDiv = document.createElement('div');
             itemDiv.classList.add('input-group');
             itemDiv.dataset.id = id;
             itemDiv.innerHTML = formHtml + `
                 <button class="icon-button remove-item-button" data-section="${section}" data-id="${id}" aria-label="Remove Item">
                     <span class="material-symbols-rounded">delete</span>
                 </button>
             `;
             return itemDiv;
        }


        function addItemToForms(section) {
            const id = nextItemId++;
            const newItemDiv = createInputGroup(section, id);
            document.getElementById(`${section}-items`).appendChild(newItemDiv);
        }

        addRevenueButton.addEventListener('click', () => addItemToForms('revenue'));
        addExpenseButton.addEventListener('click', () => addItemToForms('expenses'));
        addFundingButton.addEventListener('click', () => addItemToForms('funding'));
        addPersonnelButton.addEventListener('click', () => addItemToForms('personnel'));

        // Event delegation for remove buttons within input groups
        document.addEventListener('click', (e) => {
            if (e.target.closest('.remove-item-button')) {
                const button = e.target.closest('.remove-item-button');
                const section = button.dataset.section;
                const id = parseInt(button.dataset.id);
                removeItemFromForms(section, id);
            }
        });

        function removeItemFromForms(section, id) {
             const itemDiv = document.querySelector(`#${section}-items .input-group[data-id="${id}"]`);
             if (itemDiv) {
                 itemDiv.remove();
                 // Also remove from internal data and table if it exists
                 currentProjectionData[section] = currentProjectionData[section].filter(item => item.id !== id);
                 populateTable(section, currentProjectionData[section]);
             }
        }


        // --- Data Handling and Table Population ---

        function collectDataFromForms(section) {
             const itemsContainer = document.getElementById(`${section}-items`);
             const itemDivs = itemsContainer.querySelectorAll('.input-group');
             const collectedData = [];
             let validationError = false;

             itemDivs.forEach(itemDiv => {
                 const id = parseInt(itemDiv.dataset.id);
                 let item = { id: id };
                 let isValid = true;

                 // Basic validation and data collection
                 if (section === 'revenue') {
                     const nameInput = itemDiv.querySelector(`#revenue-item-name-${id}`);
                     const typeSelect = itemDiv.querySelector(`#revenue-item-type-${id}`);
                     const amountInput = itemDiv.querySelector(`#revenue-item-amount-${id}`);
                     const startMonthInput = itemDiv.querySelector(`#revenue-item-start-month-${id}`);

                     if (!nameInput.value.trim() || amountInput.value === '' || startMonthInput.value === '' || parseFloat(amountInput.value) < 0 || parseInt(startMonthInput.value) < 1 || parseInt(startMonthInput.value) > PROJECTION_MONTHS) {
                         isValid = false;
                     } else {
                         item.name = nameInput.value.trim();
                         item.type = typeSelect.value;
                         item.amount = parseFloat(amountInput.value);
                         item.startMonth = parseInt(startMonthInput.value);
                     }
                     [nameInput, amountInput, startMonthInput].forEach(input => {
                         if (!input.checkValidity() || (input.type === 'number' && parseFloat(input.value) < 0) || (input.id.includes('month') && (parseInt(input.value) < 1 || parseInt(input.value) > PROJECTION_MONTHS))) {
                             input.classList.add('error');
                             validationError = true;
                         } else {
                             input.classList.remove('error');
                         }
                     });

                 } else if (section === 'expenses') {
                     const nameInput = itemDiv.querySelector(`#expense-item-name-${id}`);
                     const typeSelect = itemDiv.querySelector(`#expense-item-type-${id}`);
                     const amountInput = itemDiv.querySelector(`#expense-item-amount-${id}`);
                     const startMonthInput = itemDiv.querySelector(`#expense-item-start-month-${id}`);

                     if (!nameInput.value.trim() || amountInput.value === '' || startMonthInput.value === '' || parseFloat(amountInput.value) < 0 || parseInt(startMonthInput.value) < 1 || parseInt(startMonthInput.value) > PROJECTION_MONTHS) {
                         isValid = false;
                     } else {
                         item.name = nameInput.value.trim();
                         item.type = typeSelect.value;
                         item.amount = parseFloat(amountInput.value);
                         item.startMonth = parseInt(startMonthInput.value);
                     }
                      [nameInput, amountInput, startMonthInput].forEach(input => {
                         if (!input.checkValidity() || (input.type === 'number' && parseFloat(input.value) < 0) || (input.id.includes('month') && (parseInt(input.value) < 1 || parseInt(input.value) > PROJECTION_MONTHS))) {
                             input.classList.add('error');
                             validationError = true;
                         } else {
                             input.classList.remove('error');
                         }
                     });

                 } else if (section === 'funding') {
                     const nameInput = itemDiv.querySelector(`#funding-item-name-${id}`);
                     const typeSelect = itemDiv.querySelector(`#funding-item-type-${id}`);
                     const amountInput = itemDiv.querySelector(`#funding-item-amount-${id}`);
                     const monthInput = itemDiv.querySelector(`#funding-item-month-${id}`);

                     if (!nameInput.value.trim() || amountInput.value === '' || monthInput.value === '' || parseFloat(amountInput.value) < 0 || parseInt(monthInput.value) < 1 || parseInt(monthInput.value) > PROJECTION_MONTHS) {
                         isValid = false;
                     } else {
                         item.name = nameInput.value.trim();
                         item.type = typeSelect.value;
                         item.amount = parseFloat(amountInput.value);
                         item.month = parseInt(monthInput.value);
                     }
                      [nameInput, amountInput, monthInput].forEach(input => {
                         if (!input.checkValidity() || (input.type === 'number' && parseFloat(input.value) < 0) || (input.id.includes('month') && (parseInt(input.value) < 1 || parseInt(input.value) > PROJECTION_MONTHS))) {
                             input.classList.add('error');
                             validationError = true;
                         } else {
                             input.classList.remove('error');
                         }
                     });

                 } else if (section === 'personnel') {
                     const roleInput = itemDiv.querySelector(`#personnel-item-role-${id}`);
                     const salaryInput = itemDiv.querySelector(`#personnel-item-salary-${id}`);
                     const startMonthInput = itemDiv.querySelector(`#personnel-item-start-month-${id}`);
                     const benefitsInput = itemDiv.querySelector(`#personnel-item-benefits-${id}`);

                     if (!roleInput.value.trim() || salaryInput.value === '' || startMonthInput.value === '' || benefitsInput.value === '' || parseFloat(salaryInput.value) < 0 || parseInt(startMonthInput.value) < 1 || parseInt(startMonthInput.value) > PROJECTION_MONTHS || parseFloat(benefitsInput.value) < 0 || parseFloat(benefitsInput.value) > 100) {
                         isValid = false;
                     } else {
                         item.role = roleInput.value.trim();
                         item.salary = parseFloat(salaryInput.value);
                         item.startMonth = parseInt(startMonthInput.value);
                         item.benefits = parseFloat(benefitsInput.value);
                     }
                      [roleInput, salaryInput, startMonthInput, benefitsInput].forEach(input => {
                         if (!input.checkValidity() || (input.type === 'number' && parseFloat(input.value) < 0) || (input.id.includes('month') && (parseInt(input.value) < 1 || parseInt(input.value) > PROJECTION_MONTHS)) || (input.id.includes('benefits') && (parseFloat(input.value) < 0 || parseFloat(input.value) > 100))) {
                             input.classList.add('error');
                             validationError = true;
                         } else {
                             input.classList.remove('error');
                         }
                     });
                 }

                 if (isValid) {
                    collectedData.push(item);
                 }
             });

             currentProjectionData[section] = collectedData;
             populateTable(section, collectedData);

             return !validationError; // Return true if no validation errors found
        }

        function populateTable(section, data) {
            const tableBody = document.querySelector(`#${section}-table tbody`);
            if (!tableBody) return;

            tableBody.innerHTML = ''; // Clear current table

            data.forEach(item => {
                const row = tableBody.insertRow();
                row.dataset.id = item.id; // Add data attribute for easy lookup

                let cellHtml = '';
                if (section === 'revenue') {
                     cellHtml = `
                        <td>${item.name}</td>
                        <td>${item.type}</td>
                        <td>${formatCurrency(item.amount)}</td>
                        <td>${item.startMonth}</td>
                    `;
                } else if (section === 'expenses') {
                    cellHtml = `
                        <td>${item.name}</td>
                        <td>${item.type}</td>
                        <td>${formatCurrency(item.amount)}</td>
                        <td>${item.startMonth}</td>
                    `;
                } else if (section === 'funding') {
                    cellHtml = `
                        <td>${item.name}</td>
                        <td>${item.type}</td>
                        <td>${formatCurrency(item.amount)}</td>
                        <td>${item.month}</td>
                    `;
                } else if (section === 'personnel') {
                     cellHtml = `
                        <td>${item.role}</td>
                        <td>${formatCurrency(item.salary)}</td>
                        <td>${item.startMonth}</td>
                        <td>${item.benefits.toFixed(1)}%</td>
                    `;
                }

                row.innerHTML = cellHtml + `
                    <td class="actions">
                        <button class="icon-button edit-item" data-section="${section}" data-id="${item.id}" aria-label="Edit item">
                            <span class="material-symbols-rounded">edit</span>
                        </button>
                        <button class="icon-button delete-item" data-section="${section}" data-id="${item.id}" aria-label="Delete item">
                            <span class="material-symbols-rounded">delete</span>
                        </button>
                    </td>
                `;
            });
        }


        // --- Calculation Logic ---

        function calculateProjections() {
            // Collect data from all sections and check validation
            const isValidRevenue = collectDataFromForms('revenue');
            const isValidExpenses = collectDataFromForms('expenses');
            const isValidFunding = collectDataFromForms('funding');
            const isValidPersonnel = collectDataFromForms('personnel');

            if (!isValidRevenue || !isValidExpenses || !isValidFunding || !isValidPersonnel) {
                 alert('Please fix validation errors in the input forms before calculating.');
                 return;
            }

            loadingIndicator.classList.add('show');

            const months = Array.from({ length: PROJECTION_MONTHS }, (_, i) => `Month ${i + 1}`);

            let monthlyRevenue = new Array(PROJECTION_MONTHS).fill(0);
            let monthlyExpenses = new Array(PROJECTION_MONTHS).fill(0);
            let monthlyPersonnelCost = new Array(PROJECTION_MONTHS).fill(0);
            let monthlyFunding = new Array(PROJECTION_MONTHS).fill(0);
            let monthlyNetIncome = new Array(PROJECTION_MONTHS).fill(0);
            let monthlyCashFlow = new Array(PROJECTION_MONTHS).fill(0);
            let monthlyEndingCash = new Array(PROJECTION_MONTHS).fill(0);

            // Calculate monthly revenue
            currentProjectionData.revenue.forEach(item => {
                const startIdx = item.startMonth - 1;
                if (startIdx < PROJECTION_MONTHS) {
                    if (item.type === 'monthly') {
                        for (let i = startIdx; i < PROJECTION_MONTHS; i++) {
                            monthlyRevenue[i] += item.amount;
                        }
                    } else if (item.type === 'one-time') {
                         monthlyRevenue[startIdx] += item.amount;
                    }
                    // 'per-unit' would require sales volume data - ignored for now
                }
            });

            // Calculate monthly expenses
            currentProjectionData.expenses.forEach(item => {
                 const startIdx = item.startMonth - 1;
                 if (startIdx < PROJECTION_MONTHS) {
                    if (item.type === 'monthly') {
                        for (let i = startIdx; i < PROJECTION_MONTHS; i++) {
                            monthlyExpenses[i] += item.amount;
                        }
                    } else if (item.type === 'one-time') {
                         monthlyExpenses[startIdx] += item.amount;
                    }
                 }
            });

            // Calculate monthly personnel costs
            currentProjectionData.personnel.forEach(item => {
                 const startIdx = item.startMonth - 1;
                 if (startIdx < PROJECTION_MONTHS) {
                    const monthlySalary = item.salary / 12;
                    const monthlyCost = monthlySalary * (1 + item.benefits / 100);
                    for (let i = startIdx; i < PROJECTION_MONTHS; i++) {
                        monthlyPersonnelCost[i] += monthlyCost;
                    }
                 }
            });

             // Calculate monthly funding received
            currentProjectionData.funding.forEach(item => {
                 const monthIdx = item.month - 1;
                 if (monthIdx < PROJECTION_MONTHS) {
                    monthlyFunding[monthIdx] += item.amount;
                 }
            });


            // Calculate monthly Net Income, Cash Flow, and Ending Cash
            let cumulativeCash = 0; // Assume starting cash is 0 for simplicity
            for (let i = 0; i < PROJECTION_MONTHS; i++) {
                // Total Expenses = Operating Expenses + Personnel Costs
                const totalMonthlyExpenses = monthlyExpenses[i] + monthlyPersonnelCost[i];

                monthlyNetIncome[i] = monthlyRevenue[i] - totalMonthlyExpenses;

                // Simplified cash flow: Cash In (Revenue + Funding) - Cash Out (Total Expenses)
                monthlyCashFlow[i] = monthlyRevenue[i] + monthlyFunding[i] - totalMonthlyExpenses;

                cumulativeCash += monthlyCashFlow[i];
                monthlyEndingCash[i] = cumulativeCash;
            }


            // Store calculated data
             calculatedMonthlyData = {
                labels: months,
                revenue: monthlyRevenue,
                expenses: monthlyExpenses, // Keep operating expenses separate
                personnelCosts: monthlyPersonnelCost, // Keep personnel costs separate
                totalExpenses: monthlyExpenses.map((exp, i) => exp + monthlyPersonnelCost[i]), // Total expenses for reports
                funding: monthlyFunding,
                netIncome: monthlyNetIncome,
                cashFlow: monthlyCashFlow,
                endingCash: monthlyEndingCash
             };

            // Update Summary Dashboard (Year 1 totals)
            updateSummaryDashboard();

            setTimeout(() => {
                 // Update Chart
                 renderKeyMetricsChart(calculatedMonthlyData);

                loadingIndicator.classList.remove('show');
                alert('Projections Calculated!');

            }, 500); // Simulate calculation time
        }

        calculateButton.addEventListener('click', calculateProjections);

        // Helper to update dashboard summary values
        function updateSummaryDashboard() {
             const totalRevenueY1 = calculatedMonthlyData.revenue.slice(0, 12).reduce((sum, val) => sum + val, 0);
             const totalExpensesY1 = calculatedMonthlyData.totalExpenses.slice(0, 12).reduce((sum, val) => sum + val, 0); // Use totalExpenses
             const netIncomeY1 = totalRevenueY1 - totalExpensesY1;
             const endingCashY1 = calculatedMonthlyData.endingCash[11] || 0; // Ending cash at month 12 (index 11)

             document.getElementById('summary-revenue').textContent = formatCurrency(totalRevenueY1);
             document.getElementById('summary-expenses').textContent = formatCurrency(totalExpensesY1);
             document.getElementById('summary-netincome').textContent = formatCurrency(netIncomeY1);
             document.getElementById('summary-cash').textContent = formatCurrency(endingCashY1);
        }

        // Helper for currency formatting
        function formatCurrency(amount) {
             return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(amount);
        }


        // --- Chart Rendering ---

         function renderKeyMetricsChart(data) {
            if (keyMetricsChart) {
                keyMetricsChart.destroy(); // Destroy existing chart if it exists
            }

            const ctx = keyMetricsChartCanvas.getContext('2d');
            const chartType = keyMetricsChartTypeSelect.value;
            const dataView = keyMetricsChartDataSelect.value;

            let datasets = [];

            // Define datasets based on the selected data view
            if (dataView === 'all' || dataView === 'revenue') {
                 datasets.push({
                    label: 'Revenue',
                    data: data.revenue,
                    borderColor: "var('--primary-color')",
                    backgroundColor: chartType === 'bar' ? "var('--primary-color')" : "rgba(0, 123, 255, 0.1)",
                    fill: chartType !== 'bar',
                    tension: chartType === 'line' ? 0.1 : 0
                });
            }
            if (dataView === 'all' || dataView === 'expenses') {
                 datasets.push({
                    label: 'Total Expenses', // Use total expenses for chart
                    data: data.totalExpenses,
                    borderColor: "var('--danger-color')",
                    backgroundColor: chartType === 'bar' ? "var('--danger-color')" : "rgba(220, 53, 69, 0.1)",
                    fill: chartType !== 'bar',
                    tension: chartType === 'line' ? 0.1 : 0
                });
            }
             if (dataView === 'all' || dataView === 'netIncome') {
                 datasets.push({
                    label: 'Net Income',
                    data: data.netIncome,
                    borderColor: "var('--success-color')",
                    backgroundColor: chartType === 'bar' ? "var('--success-color')" : "rgba(40, 167, 69, 0.1)",
                    fill: chartType !== 'bar',
                    tension: chartType === 'line' ? 0.1 : 0
                });
            }
             if (dataView === 'all' || dataView === 'cashFlow') {
                 datasets.push({
                    label: 'Cash Flow',
                    data: data.cashFlow,
                    borderColor: "var('--info-color')",
                    backgroundColor: chartType === 'bar' ? "var('--info-color')" : "rgba(23, 162, 184, 0.1)",
                    fill: chartType !== 'bar',
                    tension: chartType === 'line' ? 0.1 : 0
                });
            }
             if (dataView === 'all' || dataView === 'endingCash') {
                 datasets.push({
                    label: 'Ending Cash',
                    data: data.endingCash,
                    borderColor: "var('--secondary-color')",
                    backgroundColor: chartType === 'bar' ? "var('--secondary-color')" : "rgba(108, 117, 125, 0.1)",
                    fill: chartType !== 'bar',
                    tension: chartType === 'line' ? 0.1 : 0
                });
            }


            keyMetricsChart = new Chart(ctx, {
                type: chartType,
                data: {
                    labels: data.labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                     plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: false, // Title handled by section heading
                        },
                         tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatCurrency(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value).replace('.00', ''); // Simplify currency ticks
                                }
                            }
                        }
                    }
                }
            });
        }

         // Update chart type dynamically
         keyMetricsChartTypeSelect.addEventListener('change', () => {
             renderKeyMetricsChart(calculatedMonthlyData); // Re-render with the last calculated data
         });

         // Update chart data view dynamically
         keyMetricsChartDataSelect.addEventListener('change', () => {
             renderKeyMetricsChart(calculatedMonthlyData); // Re-render with the last calculated data
         });


        // --- Modal Handling (Edit/Delete) ---

        // Event delegation for edit/delete buttons on tables
        document.addEventListener('click', (e) => {
            if (e.target.closest('.edit-item')) {
                const button = e.target.closest('.edit-item');
                const section = button.dataset.section;
                const id = parseInt(button.dataset.id);
                openEditModal(section, id);
            } else if (e.target.closest('.delete-item')) {
                 const button = e.target.closest('.delete-item');
                const section = button.dataset.section;
                const id = parseInt(button.dataset.id);
                deleteItem(section, id);
            }
        });

        modalClose.addEventListener('click', () => {
            closeEditModal();
        });

        modalCancel.addEventListener('click', () => {
            closeEditModal();
        });

        modalSave.addEventListener('click', () => {
            saveModalChanges();
        });

        reportModalClose.addEventListener('click', () => {
            closeReportModal();
        });

        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === editItemModal) {
                closeEditModal();
            }
             if (e.target === reportModal) {
                closeReportModal();
            }
        });

        function openEditModal(section, id) {
            modalTitle.textContent = `Edit ${section.charAt(0).toUpperCase() + section.slice(1)} Item`;
            modalBody.innerHTML = ''; // Clear previous content

            const itemData = currentProjectionData[section].find(item => item.id === id);
            let formHtml = '';

            if (!itemData) {
                alert('Item not found.');
                return;
            }

            // Generate form HTML based on section and item data
            if (section === 'revenue') {
                 formHtml = `
                    <div class="form-group">
                        <label for="modal-revenue-name">Name</label>
                        <input type="text" id="modal-revenue-name" value="${itemData.name}" required aria-required="true">
                    </div>
                    <div class="form-group">
                        <label for="modal-revenue-type">Type</label>
                        <select id="modal-revenue-type" aria-required="true">
                            <option value="monthly" ${itemData.type === 'monthly' ? 'selected' : ''}>Monthly Recurring</option>
                            <option value="one-time" ${itemData.type === 'one-time' ? 'selected' : ''}>One-Time</option>
                            <option value="per-unit" ${itemData.type === 'per-unit' ? 'selected' : ''}>Per Unit</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="modal-revenue-amount">Amount</label>
                        <input type="number" id="modal-revenue-amount" value="${itemData.amount}" min="0" required aria-required="true">
                    </div>
                    <div class="form-group">
                        <label for="modal-revenue-start-month">Start Month</label>
                        <input type="number" id="modal-revenue-start-month" value="${itemData.startMonth}" min="1" max="${PROJECTION_MONTHS}" required aria-required="true">
                    </div>
                `;
            } else if (section === 'expenses') {
                 formHtml = `
                    <div class="form-group">
                        <label for="modal-expense-name">Name</label>
                        <input type="text" id="modal-expense-name" value="${itemData.name}" required aria-required="true">
                    </div>
                    <div class="form-group">
                        <label for="modal-expense-type">Type</label>
                        <select id="modal-expense-type" aria-required="true">
                            <option value="monthly" ${itemData.type === 'monthly' ? 'selected' : ''}>Monthly Recurring</option>
                            <option value="one-time" ${itemData.type === 'one-time' ? 'selected' : ''}>One-Time</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="modal-expense-amount">Amount</label>
                        <input type="number" id="modal-expense-amount" value="${itemData.amount}" min="0" required aria-required="true">
                    </div>
                    <div class="form-group">
                        <label for="modal-expense-start-month">Start Month</label>
                        <input type="number" id="modal-expense-start-month" value="${itemData.startMonth}" min="1" max="${PROJECTION_MONTHS}" required aria-required="true">
                    </div>
                `;
            } else if (section === 'funding') {
                 formHtml = `
                    <div class="form-group">
                        <label for="modal-funding-name">Name</label>
                        <input type="text" id="modal-funding-name" value="${itemData.name}" required aria-required="true">
                    </div>
                    <div class="form-group">
                        <label for="modal-funding-type">Type</label>
                        <select id="modal-funding-type" aria-required="true">
                            <option value="equity" ${itemData.type === 'equity' ? 'selected' : ''}>Equity</option>
                            <option value="debt" ${itemData.type === 'debt' ? 'selected' : ''}>Debt</option>
                            <option value="grant" ${itemData.type === 'grant' ? 'selected' : ''}>Grant</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="modal-funding-amount">Amount</label>
                        <input type="number" id="modal-funding-amount" value="${itemData.amount}" min="0" required aria-required="true">
                    </div>
                    <div class="form-group">
                        <label for="modal-funding-month">Month Received</label>
                        <input type="number" id="modal-funding-month" value="${itemData.month}" min="1" max="${PROJECTION_MONTHS}" required aria-required="true">
                    </div>
                `;
            } else if (section === 'personnel') {
                 formHtml = `
                    <div class="form-group">
                        <label for="modal-personnel-role">Role/Title</label>
                        <input type="text" id="modal-personnel-role" value="${itemData.role}" required aria-required="true">
                    </div>
                    <div class="form-group">
                        <label for="modal-personnel-salary">Annual Salary</label>
                        <input type="number" id="modal-personnel-salary" value="${itemData.salary}" min="0" required aria-required="true">
                    </div>
                    <div class="form-group">
                        <label for="modal-personnel-start-month">Start Month</label>
                        <input type="number" id="modal-personnel-start-month" value="${itemData.startMonth}" min="1" max="${PROJECTION_MONTHS}" required aria-required="true">
                    </div>
                     <div class="form-group">
                        <label for="modal-personnel-benefits">Benefits/Tax %</label>
                        <input type="number" id="modal-personnel-benefits" value="${itemData.benefits}" min="0" max="100" required aria-required="true">
                    </div>
                `;
            }

            modalBody.innerHTML = formHtml;
            modalSave.dataset.section = section;
            modalSave.dataset.id = id;
            editItemModal.classList.add('show');
            editItemModal.setAttribute('aria-hidden', 'false');
        }

        function closeEditModal() {
            editItemModal.classList.remove('show');
            editItemModal.setAttribute('aria-hidden', 'true');
             modalSave.dataset.section = '';
             modalSave.dataset.id = '';
             modalBody.innerHTML = ''; // Clear modal body on close
        }

        function saveModalChanges() {
            const section = modalSave.dataset.section;
            const id = parseInt(modalSave.dataset.id);

            const itemIndex = currentProjectionData[section].findIndex(item => item.id === id);
            if (itemIndex === -1) {
                alert('Item not found in data.');
                return;
            }

            let updatedItem = { id: id };
            let validationError = false;

            // Collect data from modal form and update item
            if (section === 'revenue') {
                 const nameInput = document.getElementById('modal-revenue-name');
                 const typeSelect = document.getElementById('modal-revenue-type');
                 const amountInput = document.getElementById('modal-revenue-amount');
                 const startMonthInput = document.getElementById('modal-revenue-start-month');

                 if (!nameInput.value.trim() || amountInput.value === '' || startMonthInput.value === '' || parseFloat(amountInput.value) < 0 || parseInt(startMonthInput.value) < 1 || parseInt(startMonthInput.value) > PROJECTION_MONTHS) {
                     validationError = true;
                 } else {
                     updatedItem.name = nameInput.value.trim();
                     updatedItem.type = typeSelect.value;
                     updatedItem.amount = parseFloat(amountInput.value);
                     updatedItem.startMonth = parseInt(startMonthInput.value);
                 }

            } else if (section === 'expenses') {
                 const nameInput = document.getElementById('modal-expense-name');
                 const typeSelect = document.getElementById('modal-expense-type');
                 const amountInput = document.getElementById('modal-expense-amount');
                 const startMonthInput = document.getElementById('modal-expense-start-month');

                 if (!nameInput.value.trim() || amountInput.value === '' || startMonthInput.value === '' || parseFloat(amountInput.value) < 0 || parseInt(startMonthInput.value) < 1 || parseInt(startMonthInput.value) > PROJECTION_MONTHS) {
                     validationError = true;
                 } else {
                     updatedItem.name = nameInput.value.trim();
                     updatedItem.type = typeSelect.value;
                     updatedItem.amount = parseFloat(amountInput.value);
                     updatedItem.startMonth = parseInt(startMonthInput.value);
                 }
            } else if (section === 'funding') {
                 const nameInput = document.getElementById('modal-funding-name');
                 const typeSelect = document.getElementById('modal-funding-type');
                 const amountInput = document.getElementById('modal-funding-amount');
                 const monthInput = document.getElementById('modal-funding-month');

                 if (!nameInput.value.trim() || amountInput.value === '' || monthInput.value === '' || parseFloat(amountInput.value) < 0 || parseInt(monthInput.value) < 1 || parseInt(monthInput.value) > PROJECTION_MONTHS) {
                     validationError = true;
                 } else {
                     updatedItem.name = nameInput.value.trim();
                     updatedItem.type = typeSelect.value;
                     updatedItem.amount = parseFloat(amountInput.value);
                     updatedItem.month = parseInt(monthInput.value);
                 }
            } else if (section === 'personnel') {
                 const roleInput = document.getElementById('modal-personnel-role');
                 const salaryInput = document.getElementById('modal-personnel-salary');
                 const startMonthInput = document.getElementById('modal-personnel-start-month');
                 const benefitsInput = document.getElementById('modal-personnel-benefits');

                 if (!roleInput.value.trim() || salaryInput.value === '' || startMonthInput.value === '' || benefitsInput.value === '' || parseFloat(salaryInput.value) < 0 || parseInt(startMonthInput.value) < 1 || parseInt(startMonthInput.value) > PROJECTION_MONTHS || parseFloat(benefitsInput.value) < 0 || parseFloat(benefitsInput.value) > 100) {
                     validationError = true;
                 } else {
                     updatedItem.role = roleInput.value.trim();
                     updatedItem.salary = parseFloat(salaryInput.value);
                     updatedItem.startMonth = parseInt(startMonthInput.value);
                     updatedItem.benefits = parseFloat(benefitsInput.value);
                 }
            }

            if (validationError) {
                alert('Please fill in all required fields and ensure values are valid.');
                return;
            }

            currentProjectionData[section][itemIndex] = updatedItem;

            // Update the corresponding form inputs and table row
            updateFormInputs(section, updatedItem);
            populateTable(section, currentProjectionData[section]);

            closeEditModal();
             // Optionally re-calculate projections after saving
             // calculateProjections();
        }

        function updateFormInputs(section, item) {
            const itemDiv = document.querySelector(`#${section}-items .input-group[data-id="${item.id}"]`);
            if (!itemDiv) return;

            if (section === 'revenue') {
                itemDiv.querySelector(`#revenue-item-name-${item.id}`).value = item.name;
                itemDiv.querySelector(`#revenue-item-type-${item.id}`).value = item.type;
                itemDiv.querySelector(`#revenue-item-amount-${item.id}`).value = item.amount;
                itemDiv.querySelector(`#revenue-item-start-month-${item.id}`).value = item.startMonth;
            } else if (section === 'expenses') {
                 itemDiv.querySelector(`#expense-item-name-${item.id}`).value = item.name;
                itemDiv.querySelector(`#expense-item-type-${item.id}`).value = item.type;
                itemDiv.querySelector(`#expense-item-amount-${item.id}`).value = item.amount;
                itemDiv.querySelector(`#expense-item-start-month-${item.id}`).value = item.startMonth;
            } else if (section === 'funding') {
                 itemDiv.querySelector(`#funding-item-name-${item.id}`).value = item.name;
                itemDiv.querySelector(`#funding-item-type-${item.id}`).value = item.type;
                itemDiv.querySelector(`#funding-item-amount-${item.id}`).value = item.amount;
                itemDiv.querySelector(`#funding-item-month-${item.id}`).value = item.month;
            } else if (section === 'personnel') {
                 itemDiv.querySelector(`#personnel-item-role-${item.id}`).value = item.role;
                itemDiv.querySelector(`#personnel-item-salary-${item.id}`).value = item.salary;
                itemDiv.querySelector(`#personnel-item-start-month-${item.id}`).value = item.startMonth;
                itemDiv.querySelector(`#personnel-item-benefits-${item.id}`).value = item.benefits;
            }
        }


        function deleteItem(section, id) {
            if (confirm(`Are you sure you want to delete item ID ${id} from ${section}?`)) {
                // Remove from internal data
                currentProjectionData[section] = currentProjectionData[section].filter(item => item.id !== id);

                // Remove from table
                const tableRow = document.querySelector(`#${section}-table tbody tr[data-id="${id}"]`);
                if (tableRow) {
                    tableRow.remove();
                }

                // Remove from forms
                 const formItem = document.querySelector(`#${section}-items .input-group[data-id="${id}"]`);
                 if (formItem) {
                     formItem.remove();
                 }

                 // Optionally re-calculate projections after deleting
                 // calculateProjections();
            }
        }

        // --- Scenario Management (Simulated) ---
        const scenarioSelect = document.getElementById('scenario-select');
        const createScenarioButton = document.getElementById('create-scenario-button');
        const duplicateScenarioButton = document.getElementById('duplicate-scenario-button');
        const renameScenarioButton = document.getElementById('rename-scenario-button');
        const deleteScenarioButton = document.getElementById('delete-scenario-button');

        let scenarios = {
            'default': {
                 name: 'Default Scenario',
                 data: { revenue: [], expenses: [], funding: [], personnel: [] },
                 calculatedData: { labels: [], revenue: [], expenses: [], personnelCosts: [], totalExpenses: [], funding: [], netIncome: [], cashFlow: [], endingCash: [] }
            }
        };
        let currentScenario = 'default';

        function saveCurrentScenario() {
             // Collect data from forms before saving
             // Note: This might be redundant if collectDataFromForms is called on section change
             // but ensures the latest form data is saved.
             collectDataFromForms('revenue');
             collectDataFromForms('expenses');
             collectDataFromForms('funding');
             collectDataFromForms('personnel');


             scenarios[currentScenario] = {
                 name: scenarios[currentScenario].name, // Keep existing name
                 data: JSON.parse(JSON.stringify(currentProjectionData)), // Deep clone input data
                 calculatedData: JSON.parse(JSON.stringify(calculatedMonthlyData)) // Deep clone calculated data
             };
             // alert(`Scenario "${scenarios[currentScenario].name}" saved.`); // Optional confirmation
             updateScenarioDropdown();
        }

        function loadScenario(scenarioKey) {
             if (!scenarios[scenarioKey]) {
                 alert('Scenario not found.');
                 return;
             }

             // Save current scenario state before loading new one
             saveCurrentScenario();

             currentScenario = scenarioKey;
             currentProjectionData = JSON.parse(JSON.stringify(scenarios[scenarioKey].data)); // Deep clone
             calculatedMonthlyData = JSON.parse(JSON.stringify(scenarios[scenarioKey].calculatedData || { labels: [], revenue: [], expenses: [], personnelCosts: [], totalExpenses: [], funding: [], netIncome: [], cashFlow: [], endingCash: [] }));

             // Populate forms and tables from loaded data
             populateForms('revenue', currentProjectionData.revenue);
             populateForms('expenses', currentProjectionData.expenses);
             populateForms('funding', currentProjectionData.funding);
             populateForms('personnel', currentProjectionData.personnel);

             populateTable('revenue', currentProjectionData.revenue);
             populateTable('expenses', currentProjectionData.expenses);
             populateTable('funding', currentProjectionData.funding);
             populateTable('personnel', currentProjectionData.personnel);

             // Update dashboard and chart if currently visible
             if (document.getElementById('dashboard').style.display !== 'none') {
                 updateSummaryDashboard();
                 renderKeyMetricsChart(calculatedMonthlyData);
             }

             alert(`Scenario "${scenarios[currentScenario].name}" loaded.`);
             scenarioSelect.value = currentScenario;
        }

        function populateForms(section, data) {
             const itemsContainer = document.getElementById(`${section}-items`);
             itemsContainer.innerHTML = ''; // Clear existing forms
             let maxId = 1;
             data.forEach(item => {
                 const newItemDiv = createInputGroup(section, item.id);
                 itemsContainer.appendChild(newItemDiv);
                 updateFormInputs(section, item); // Populate inputs with data
                 if (item.id >= maxId) maxId = item.id + 1;
             });
             nextItemId = maxId > 1 ? maxId : 2; // Ensure nextId is greater than any existing ID
        }


        function createNewScenario() {
             const scenarioName = prompt('Enter name for new scenario:');
             if (scenarioName && scenarioName.trim() !== '') {
                 const newKey = scenarioName.trim().toLowerCase().replace(/\s+/g, '-');
                 if (scenarios[newKey]) {
                     alert(`Scenario "${scenarioName}" already exists.`);
                     return;
                 }
                 // Save current scenario before creating a new empty one
                 saveCurrentScenario();

                 scenarios[newKey] = {
                     name: scenarioName.trim(),
                     data: { revenue: [], expenses: [], funding: [], personnel: [] }, // Start with empty data
                     calculatedData: { labels: [], revenue: [], expenses: [], personnelCosts: [], totalExpenses: [], funding: [], netIncome: [], cashFlow: [], endingCash: [] } // Start with empty calculated data
                 };
                 loadScenario(newKey); // Load the new empty scenario
                 alert(`Scenario "${scenarioName}" created.`);
             }
        }

        function duplicateScenario() {
             const currentName = scenarios[currentScenario].name;
             const newName = prompt(`Enter name for duplicated scenario (from "${currentName}"):`);
             if (newName && newName.trim() !== '') {
                 const newKey = newName.trim().toLowerCase().replace(/\s+/g, '-');
                  if (scenarios[newKey]) {
                     alert(`Scenario "${newName}" already exists.`);
                     return;
                 }
                 // Ensure current data is saved before duplicating
                 saveCurrentScenario();

                 // Deep clone current scenario data
                 scenarios[newKey] = {
                     name: newName.trim(),
                     data: JSON.parse(JSON.stringify(currentProjectionData)),
                     calculatedData: JSON.parse(JSON.stringify(calculatedMonthlyData))
                 };
                 loadScenario(newKey); // Load the duplicated scenario
                 alert(`Scenario "${newName}" duplicated.`);
             }
        }

        function renameScenario() {
             if (currentScenario === 'default') {
                 alert('Cannot rename the default scenario.');
                 return;
             }
             const currentName = scenarios[currentScenario].name;
             const newName = prompt(`Enter new name for scenario "${currentName}":`, currentName);
             if (newName && newName.trim() !== '' && newName.trim() !== currentName) {
                 const newKey = newName.trim().toLowerCase().replace(/\s+/g, '-');
                  if (scenarios[newKey]) {
                     alert(`Scenario "${newName}" already exists.`);
                     return;
                 }
                 // Save current scenario under the old key first
                 saveCurrentScenario();

                 // Transfer data to new key and delete old key
                 scenarios[newKey] = scenarios[currentScenario];
                 scenarios[newKey].name = newName.trim();
                 delete scenarios[currentScenario];
                 currentScenario = newKey;
                 alert(`Scenario renamed to "${newName}".`);
                 updateScenarioDropdown();
                 scenarioSelect.value = currentScenario;
             }
        }

        function deleteScenario() {
             if (currentScenario === 'default') {
                 alert('Cannot delete the default scenario.');
                 return;
             }
             if (confirm(`Are you sure you want to delete scenario "${scenarios[currentScenario].name}"?`)) {
                 delete scenarios[currentScenario];
                 alert(`Scenario "${scenarios[currentScenario].name}" deleted.`);
                 loadScenario('default'); // Load default after deleting
                 updateScenarioDropdown();
             }
        }


        function updateScenarioDropdown() {
             scenarioSelect.innerHTML = ''; // Clear existing options
             for (const key in scenarios) {
                 const option = document.createElement('option');
                 option.value = key;
                 option.textContent = scenarios[key].name;
                 scenarioSelect.appendChild(option);
             }
             scenarioSelect.value = currentScenario; // Select the current scenario
        }

        scenarioSelect.addEventListener('change', (e) => {
             loadScenario(e.target.value);
        });

        createScenarioButton.addEventListener('click', createNewScenario);
        duplicateScenarioButton.addEventListener('click', duplicateScenario);
        renameScenarioButton.addEventListener('click', renameScenario);
        deleteScenarioButton.addEventListener('click', deleteScenario);


        // --- Reporting ---
        const generateIncomeStatementButton = document.getElementById('generate-income-statement');
        const generateCashFlowButton = document.getElementById('generate-cash-flow');
        const generateBalanceSheetButton = document.getElementById('generate-balance-sheet');
        const exportCsvButton = document.getElementById('export-csv');
        const exportPdfButton = document.getElementById('export-pdf');
        const reportTableHeadRow = document.querySelector('#report-table thead tr');
        const reportTableBody = document.querySelector('#report-table tbody');


        function openReportModal(reportType) {
             reportModalTitle.textContent = `${reportType} Report (${scenarios[currentScenario].name})`;
             reportTableBody.innerHTML = ''; // Clear previous content
             reportTableHeadRow.innerHTML = '<th>Metric</th>'; // Reset header

             const data = calculatedMonthlyData;
             const months = data.labels.length;
             const year1Months = Math.min(months, 12);
             const year2Months = Math.min(months, 24);
             const year3Months = Math.min(months, 36);


             let metricsToShow = [];
             let rowData = {};

             if (reportType === 'Income Statement') {
                 metricsToShow = ['Revenue', 'Total Expenses', 'Net Income'];
                 rowData = {
                     'Revenue': data.revenue,
                     'Total Expenses': data.totalExpenses,
                     'Net Income': data.netIncome
                 };
             } else if (reportType === 'Cash Flow Statement') {
                 metricsToShow = ['Revenue', 'Total Expenses', 'Funding', 'Cash Flow', 'Ending Cash'];
                 rowData = {
                     'Revenue': data.revenue,
                     'Total Expenses': data.totalExpenses,
                     'Funding': data.funding,
                     'Cash Flow': data.cashFlow,
                     'Ending Cash': data.endingCash
                 };
             } else if (reportType === 'Balance Sheet') {
                 metricsToShow = ['Cash', 'Assets', 'Liabilities', 'Equity'];
                 // Balance Sheet requires more complex calculation logic (Assets = Liabilities + Equity)
                 // This is a very simplified placeholder based on ending cash.
                 rowData = {
                     'Cash': data.endingCash, // Ending cash as a proxy for Cash Asset
                     'Assets': data.endingCash.map(cash => Math.max(0, cash + 10000)), // Placeholder: Cash + some arbitrary assets
                     'Liabilities': data.endingCash.map(cash => Math.max(0, cash * 0.1)), // Placeholder: 10% of cash (debt?)
                     'Equity': data.endingCash.map((cash, i) => rowData['Assets'][i] - rowData['Liabilities'][i]) // Placeholder: Assets - Liabilities
                 };
             } else {
                 // Default to showing key metrics if type is unknown
                 metricsToShow = ['Revenue', 'Total Expenses', 'Net Income', 'Cash Flow', 'Ending Cash'];
                 rowData = {
                     'Revenue': data.revenue,
                     'Total Expenses': data.totalExpenses,
                     'Funding': data.funding,
                     'Cash Flow': data.cashFlow,
                     'Ending Cash': data.endingCash
                 };
             }

             // Add month headers
             for(let i = 0; i < months; i++) {
                 reportTableHeadRow.innerHTML += `<th>${data.labels[i]}</th>`;
             }
             // Add total column header
             reportTableHeadRow.innerHTML += `<th class="total-column">Total</th>`;


             // Populate table body
             metricsToShow.forEach(metric => {
                 const row = reportTableBody.insertRow();
                 row.innerHTML += `<td>${metric}</td>`; // Metric Name

                 const monthlyValues = rowData[metric] || new Array(months).fill(0);
                 let total = 0;
                 for(let i = 0; i < months; i++) {
                     const value = monthlyValues[i] || 0;
                     row.innerHTML += `<td>${formatCurrency(value)}</td>`;
                     total += value;
                 }
                  row.innerHTML += `<td class="total-column"><strong>${formatCurrency(total)}</strong></td>`; // Total column
             });


             reportModal.classList.add('show');
             reportModal.setAttribute('aria-hidden', 'false');
        }

        function closeReportModal() {
             reportModal.classList.remove('show');
             reportModal.setAttribute('aria-hidden', 'true');
        }

        generateIncomeStatementButton.addEventListener('click', () => openReportModal('Income Statement'));
        generateCashFlowButton.addEventListener('click', () => openReportModal('Cash Flow Statement'));
        generateBalanceSheetButton.addEventListener('click', () => openReportModal('Balance Sheet'));

        exportCsvButton.addEventListener('click', () => {
             alert('Export to CSV (Simulated)');
             // In a real app, you would format calculatedMonthlyData into CSV and trigger download
        });

         exportPdfButton.addEventListener('click', () => {
             alert('Export to PDF (Simulated)');
              // In a real app, you would use a library like jsPDF or send data to a backend service
         });


        // --- Initial Setup ---

        // Add initial default form items
        addItemToForms('revenue');
        addItemToForms('expenses');
        addItemToForms('funding');
        addItemToForms('personnel');

        // Collect initial data from default forms and populate tables
        collectDataFromForms('revenue');
        collectDataFromForms('expenses');
        collectDataFromForms('funding');
        collectDataFromForms('personnel');

        // Save the initial state as the default scenario
        saveCurrentScenario();

        // Initial chart render with empty data
        renderKeyMetricsChart(calculatedMonthlyData);

        // Add keyboard listeners for modals
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (editItemModal.classList.contains('show')) {
                    closeEditModal();
                }
                if (reportModal.classList.contains('show')) {
                    closeReportModal();
                }
            }
        });


    </script>

</body>
</html>
