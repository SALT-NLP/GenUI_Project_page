<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Management Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        :root {
            --primary-color: #007bff;
            --primary-color-dark: #0056b3;
            --secondary-color: #6c757d;
            --secondary-color-dark: #545b62;
            --success-color: #28a745;
            --success-color-dark: #1e7e34;
            --warning-color: #ffc107;
            --warning-color-dark: #d39e00;
            --danger-color: #dc3545;
            --danger-color-dark: #bd2130;
            --info-color: #17a2b8;
            --info-color-dark: #117a8b;
            --background-color: #f8f9fa;
            --surface-color: #ffffff;
            --text-color: #212529;
            --text-color-secondary: #6c757d;
            --border-color: #dee2e6;
            --spacing-unit: 8px;
            --border-radius: 8px;
            --shadow-light: 0 2px 4px rgba(0, 0, 0, 0.05);
            --shadow-medium: 0 4px 12px rgba(0, 0, 0, 0.1);
            --transition-speed: 0.2s ease-in-out;
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            min-height: 100vh;
            overflow: hidden; /* Prevent body scroll */
        }

        .dashboard-container {
            display: grid;
            grid-template-columns: 240px 1fr;
            grid-template-rows: auto 1fr;
            height: 100vh;
            width: 100%;
        }

        .sidebar {
            grid-column: 1;
            grid-row: 1 / 3;
            background-color: var(--surface-color);
            padding: calc(var(--spacing-unit) * 3);
            border-right: 1px solid var(--border-color);
            box-shadow: var(--shadow-light);
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* Allow sidebar scrolling if needed */
        }

        .sidebar__logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: calc(var(--spacing-unit) * 4);
            text-align: center;
        }

        .sidebar__nav-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar__nav-item {
            margin-bottom: var(--spacing-unit);
        }

        .sidebar__nav-link {
            display: flex;
            align-items: center;
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 2);
            color: var(--text-color-secondary);
            text-decoration: none;
            border-radius: var(--border-radius);
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }

        .sidebar__nav-link:hover,
        .sidebar__nav-link:focus {
             background-color: var(--background-color);
             color: var(--text-color);
             outline: none; /* Remove default focus outline */
        }

         .sidebar__nav-link--active {
            background-color: var(--primary-color);
            color: var(--surface-color);
        }

        .sidebar__nav-link--active .icon {
             color: var(--surface-color); /* Ensure icon color matches active state */
        }

        .sidebar__nav-link span {
            margin-right: var(--spacing-unit);
        }

        .header {
            grid-column: 2;
            grid-row: 1;
            background-color: var(--surface-color);
            padding: calc(var(--spacing-unit) * 2) calc(var(--spacing-unit) * 3);
            border-bottom: 1px solid var(--border-color);
            box-shadow: var(--shadow-light);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: calc(var(--spacing-unit) * 2); /* Add gap for responsiveness */
            flex-wrap: wrap; /* Allow controls to wrap on smaller screens */
        }

        .header__title {
            font-size: 1.25rem;
            font-weight: 600;
            margin: 0;
        }

        .header__controls {
            display: flex;
            align-items: center;
            gap: calc(var(--spacing-unit) * 2);
            flex-wrap: wrap; /* Allow controls to wrap */
        }

        .header__control-group {
            display: flex;
            align-items: center;
            gap: var(--spacing-unit);
        }

        .header__control-group label {
            font-size: 0.9rem;
            color: var(--text-color-secondary);
        }

        .header__select,
        .header__date-input {
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 1.5);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 0.9rem;
            color: var(--text-color);
            background-color: var(--surface-color);
            cursor: pointer;
            transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
        }

        .header__select:hover,
        .header__date-input:hover {
            border-color: var(--secondary-color);
        }

        .header__select:focus,
        .header__date-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .header__notifications {
            position: relative;
        }

        .header__notifications-button {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-color-secondary);
            padding: var(--spacing-unit);
            border-radius: 50%;
            transition: background-color var(--transition-speed), color var(--transition-speed);
            display: flex;
            align-items: center;
            justify-content: center;
            outline: none; /* Remove default focus outline */
        }

        .header__notifications-button:hover,
        .header__notifications-button:focus {
            background-color: var(--background-color);
            color: var(--text-color);
        }

        .header__notifications-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--danger-color);
            color: var(--surface-color);
            font-size: 0.7rem;
            font-weight: 600;
            border-radius: 50%;
            padding: 2px 6px;
            min-width: 20px; /* Ensure padding for single/double digits */
            text-align: center;
            line-height: 1;
        }

        .main-content {
            grid-column: 2;
            grid-row: 2;
            padding: calc(var(--spacing-unit) * 3);
            overflow-y: auto; /* Allow main content scrolling */
            position: relative; /* Needed for spinner positioning */
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: calc(var(--spacing-unit) * 3);
            transition: opacity var(--transition-speed);
        }

        .card {
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            padding: calc(var(--spacing-unit) * 3);
            display: flex;
            flex-direction: column;
            position: relative; /* Needed for floating controls */
        }

        .card__title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: calc(var(--spacing-unit) * 2);
            color: var(--text-color);
        }

        .summary-card__value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: var(--spacing-unit);
        }

        .summary-card__label {
            font-size: 0.9rem;
            color: var(--text-color-secondary);
        }

        .chart-card__container {
            flex-grow: 1;
            min-height: 250px; /* Ensure chart has space */
            position: relative;
            cursor: pointer; /* Indicate interactivity */
        }

        .floating-controls {
            position: absolute;
            top: var(--spacing-unit);
            right: var(--spacing-unit);
            background: rgba(255, 255, 255, 0.98); /* Slightly less transparent */
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 1.5);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-light);
            opacity: 0;
            transform: translateY(-10px);
            transition: all var(--transition-speed);
            pointer-events: none;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-unit);
            min-width: 150px; /* Give controls a minimum width */
        }

        .floating-controls.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: calc(var(--spacing-unit) * 0.5);
        }

        .control-group label {
            font-size: 0.8rem;
            color: var(--text-color-secondary);
            font-weight: 500;
        }

        .control-group input[type="color"],
        .control-group select,
        .control-group input[type="number"] {
            padding: var(--spacing-unit);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 0.8rem;
            background-color: var(--surface-color);
            color: var(--text-color);
            transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
        }

         .control-group input[type="color"]:focus,
         .control-group select:focus,
         .control-group input[type="number"]:focus {
             outline: none;
             border-color: var(--primary-color);
             box-shadow: 0 0 0 0.1rem rgba(0, 123, 255, 0.25);
         }

        .control-group input[type="color"] {
            padding: 4px; /* Adjust padding for color input */
            height: 30px;
            cursor: pointer;
        }


        .table-card {
            grid-column: span 2; /* Span across two columns */
             overflow-x: auto; /* Allow table to scroll horizontally */
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: var(--spacing-unit);
            min-width: 600px; /* Ensure table is wide enough on desktop */
        }

        .data-table th,
        .data-table td {
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 1.5);
            text-align: left;
            border-bottom: 1px solid var(--border-color);
            font-size: 0.9rem;
        }

        .data-table th {
            background-color: var(--background-color);
            font-weight: 600;
            color: var(--text-color-secondary);
            white-space: nowrap; /* Prevent header text wrapping */
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        .data-table tbody tr:hover {
            background-color: var(--background-color);
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: var(--spacing-unit);
            vertical-align: middle; /* Align with text */
        }

        .status-indicator--success { background-color: var(--success-color); }
        .status-indicator--warning { background-color: var(--warning-color); }
        .status-indicator--danger { background-color: var(--danger-color); }
        .status-indicator--info { background-color: var(--info-color); }

        .control-panel {
            grid-column: span 1; /* Adjust span as needed */
        }

        .control-panel__section {
            margin-bottom: calc(var(--spacing-unit) * 2);
            padding-bottom: calc(var(--spacing-unit) * 2);
            border-bottom: 1px solid var(--border-color);
        }

        .control-panel__section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .control-panel__section-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: var(--spacing-unit);
            color: var(--text-color);
        }

        .control-panel__item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-unit);
            flex-wrap: wrap; /* Allow items to wrap */
            gap: var(--spacing-unit); /* Add gap for wrapped items */
        }

        .control-panel__item label {
            font-size: 0.9rem;
            color: var(--text-color);
            flex-grow: 1;
            margin-right: var(--spacing-unit); /* Keep margin for non-wrapped items */
             min-width: 120px; /* Ensure label has minimum width */
        }

        .control-panel__item input[type="range"] {
            flex-grow: 1;
            margin-right: var(--spacing-unit); /* Keep margin for non-wrapped items */
            min-width: 150px; /* Ensure slider has minimum width */
            cursor: pointer;
        }

        .control-panel__item input[type="number"] {
             width: 80px; /* Fixed width for number inputs */
             padding: var(--spacing-unit);
             border: 1px solid var(--border-color);
             border-radius: var(--border-radius);
             font-size: 0.9rem;
             text-align: center;
             transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
        }

         .control-panel__item input[type="number"]:focus {
             outline: none;
             border-color: var(--primary-color);
             box-shadow: 0 0 0 0.1rem rgba(0, 123, 255, 0.25);
         }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 24px;
            flex-shrink: 0; /* Prevent shrinking */
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-switch__slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .toggle-switch__slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-switch__slider {
            background-color: var(--success-color);
        }

        input:focus + .toggle-switch__slider {
            box-shadow: 0 0 1px var(--success-color);
            outline: none;
        }

        input:checked + .toggle-switch__slider:before {
            transform: translateX(16px);
        }

        .button {
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 2);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 0.9rem;
            transition: background-color var(--transition-speed), opacity var(--transition-speed), box-shadow var(--transition-speed);
            font-weight: 500;
            text-align: center;
            display: inline-flex; /* Use flex for centering content */
            align-items: center;
            justify-content: center;
            gap: var(--spacing-unit);
            outline: none; /* Remove default focus outline */
        }

        .button--primary {
            background-color: var(--primary-color);
            color: var(--surface-color);
        }

        .button--primary:hover,
        .button--primary:focus {
            background-color: var(--primary-color-dark);
             box-shadow: var(--shadow-light);
        }

        .button--secondary {
            background-color: var(--secondary-color);
            color: var(--surface-color);
        }

        .button--secondary:hover,
        .button--secondary:focus {
            background-color: var(--secondary-color-dark);
             box-shadow: var(--shadow-light);
        }

         .button--danger {
            background-color: var(--danger-color);
            color: var(--surface-color);
        }

        .button--danger:hover,
        .button--danger:focus {
            background-color: var(--danger-color-dark);
             box-shadow: var(--shadow-light);
        }


        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Modal */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6); /* Darker overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            visibility: hidden;
            opacity: 0;
            transition: opacity var(--transition-speed), visibility var(--transition-speed);
        }

        .modal--visible {
            visibility: visible;
            opacity: 1;
        }

        .modal__content {
            background-color: var(--surface-color);
            padding: calc(var(--spacing-unit) * 4);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            max-width: 500px;
            width: 90%;
            text-align: center;
            position: relative;
            transform: translateY(-20px); /* Slight animation effect */
            transition: transform var(--transition-speed) ease-out;
        }

         .modal--visible .modal__content {
             transform: translateY(0);
         }

        .modal__close-button {
            position: absolute;
            top: var(--spacing-unit);
            right: var(--spacing-unit);
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-color-secondary);
            padding: var(--spacing-unit); /* Increase click area */
            border-radius: 50%;
            transition: background-color var(--transition-speed), color var(--transition-speed);
            outline: none;
        }

         .modal__close-button:hover,
         .modal__close-button:focus {
             background-color: var(--background-color);
             color: var(--text-color);
         }

        .modal__title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: calc(var(--spacing-unit) * 2);
        }

        .modal__actions {
            margin-top: calc(var(--spacing-unit) * 3);
            display: flex;
            justify-content: center;
            gap: var(--spacing-unit);
        }

        .loading-spinner {
            display: none; /* Hidden by default */
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            width: 40px; /* Slightly larger */
            height: 40px; /* Slightly larger */
            animation: spin 1s linear infinite;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 50;
        }

        .loading-spinner--visible {
            display: block;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Iconography (using Material Symbols Rounded via Google Fonts) */
        .material-symbols-rounded {
          font-variation-settings:
          'FILL' 0,
          'wght' 400,
          'GRAD' 0,
          'opsz' 24
        }

        .icon {
            font-family: 'Material Symbols Rounded';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
            vertical-align: middle; /* Align icons in lists/buttons */
        }

         /* Responsive Adjustments */
         @media (max-width: 768px) {
            .dashboard-container {
                grid-template-columns: 1fr; /* Stack sidebar and main content */
                grid-template-rows: auto auto 1fr; /* Header, Sidebar, Main */
            }

            .sidebar {
                grid-column: 1;
                grid-row: 2; /* Place sidebar below header */
                border-right: none;
                border-bottom: 1px solid var(--border-color);
                padding: calc(var(--spacing-unit) * 2);
                flex-direction: row; /* Arrange sidebar items horizontally */
                overflow-x: auto; /* Allow horizontal scrolling for sidebar */
                -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
            }

             .sidebar__nav-list {
                 display: flex;
                 gap: var(--spacing-unit);
             }

             .sidebar__nav-item {
                 margin-bottom: 0; /* Remove bottom margin */
             }

             .sidebar__nav-link {
                 padding: var(--spacing-unit) calc(var(--spacing-unit) * 1.5);
                 white-space: nowrap; /* Prevent wrapping in horizontal nav */
             }

             .sidebar__logo {
                 display: none; /* Hide logo on small screens */
             }

            .header {
                grid-column: 1;
                grid-row: 1;
                padding: calc(var(--spacing-unit) * 2);
                flex-direction: column; /* Stack header items */
                align-items: flex-start;
                gap: var(--spacing-unit);
            }

             .header__controls {
                 width: 100%; /* Make controls take full width */
                 justify-content: flex-start;
             }

             .header__control-group {
                 flex-grow: 1; /* Allow control groups to grow */
                 min-width: 150px; /* Ensure minimum width */
             }


            .main-content {
                grid-column: 1;
                grid-row: 3; /* Place main content below sidebar */
                padding: calc(var(--spacing-unit) * 2);
            }

            .dashboard-grid {
                grid-template-columns: 1fr; /* Stack cards */
                gap: calc(var(--spacing-unit) * 2);
            }

             .table-card,
             .control-panel {
                 grid-column: span 1; /* Reset span for stacked layout */
             }

             .data-table {
                 min-width: 100%; /* Allow table to shrink */
             }

             .floating-controls {
                 top: auto; /* Adjust position */
                 bottom: var(--spacing-unit);
                 right: var(--spacing-unit);
                 transform: translateY(10px); /* Adjust animation */
             }

              .floating-controls.active {
                 transform: translateY(0);
             }
         }

         @media (max-width: 480px) {
             .header__controls {
                 flex-direction: column; /* Stack controls even more */
                 align-items: stretch;
             }

             .header__control-group {
                 width: 100%; /* Full width */
                 min-width: auto;
             }

             .header__select,
             .header__date-input {
                 width: 100%; /* Full width inputs */
             }

             .control-panel__item {
                 flex-direction: column;
                 align-items: flex-start;
                 gap: calc(var(--spacing-unit) * 0.5);
             }

             .control-panel__item label,
             .control-panel__item input[type="range"],
             .control-panel__item input[type="number"],
             .toggle-switch {
                 width: 100%;
                 margin-right: 0;
                 min-width: auto;
             }

             .control-panel__item input[type="number"] {
                 width: auto; /* Auto width for number input in stacked layout */
                 align-self: stretch; /* Stretch to fill container */
             }

             .toggle-switch {
                 align-self: flex-end; /* Align toggle to the right */
                 width: 40px; /* Keep fixed width for toggle */
             }

             .button {
                 width: 100%; /* Full width buttons */
             }

             .modal__content {
                 padding: calc(var(--spacing-unit) * 3);
             }
         }


    </style>
</head>
<body>

    <div class="dashboard-container">
        <aside class="sidebar">
            <div class="sidebar__logo">Energy AI</div>
            <nav class="sidebar__nav">
                <ul class="sidebar__nav-list">
                    <li class="sidebar__nav-item">
                        <a href="#" class="sidebar__nav-link sidebar__nav-link--active" aria-current="page">
                            <span class="icon" aria-hidden="true">dashboard</span>
                            Dashboard
                        </a>
                    </li>
                    <li class="sidebar__nav-item">
                        <a href="#" class="sidebar__nav-link">
                            <span class="icon" aria-hidden="true">business</span>
                            Buildings
                        </a>
                    </li>
                    <li class="sidebar__nav-item">
                        <a href="#" class="sidebar__nav-link">
                            <span class="icon" aria-hidden="true">settings</span>
                            Settings
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <header class="header">
            <h1 class="header__title">Building Overview</h1>
            <div class="header__controls">
                <div class="header__control-group">
                    <label for="building-select">Building:</label>
                    <select id="building-select" class="header__select" aria-label="Select Building">
                        <option value="building-1">Building A</option>
                        <option value="building-2">Building B</option>
                        <option value="building-3">Building C</option>
                    </select>
                </div>
                <div class="header__control-group">
                    <label for="date-start">From:</label>
                    <input type="date" id="date-start" class="header__date-input" aria-label="Start Date">
                </div>
                <div class="header__control-group">
                    <label for="date-end">To:</label>
                    <input type="date" id="date-end" class="header__date-input" aria-label="End Date">
                </div>
                <div class="header__notifications">
                    <button class="header__notifications-button" aria-label="Notifications">
                        <span class="icon" aria-hidden="true">notifications</span>
                        <span class="header__notifications-count" id="notification-count" aria-live="polite">3</span>
                    </button>
                    <!-- Notification dropdown/modal could go here -->
                </div>
            </div>
        </header>

        <main class="main-content">
            <div class="loading-spinner" id="main-loading-spinner" role="status" aria-label="Loading data"></div>
            <div class="dashboard-grid" id="dashboard-grid">
                <!-- Summary Cards -->
                <div class="card summary-card">
                    <h2 class="card__title">Total Energy Usage (kWh)</h2>
                    <div class="summary-card__value" id="total-energy-usage">--</div>
                    <div class="summary-card__label">Period Total</div>
                </div>
                <div class="card summary-card">
                    <h2 class="card__title">Estimated Cost Savings</h2>
                    <div class="summary-card__value" id="cost-savings">--</div>
                    <div class="summary-card__label">vs Baseline</div>
                </div>
                <div class="card summary-card">
                    <h2 class="card__title">Average Comfort Level</h2>
                    <div class="summary-card__value" id="comfort-level">--</div>
                    <div class="summary-card__label">Occupant Feedback</div>
                </div>
                <div class="card summary-card">
                    <h2 class="card__title">AI Optimization Status</h2>
                    <div class="summary-card__value" id="ai-status">
                        <span class="status-indicator status-indicator--info" aria-hidden="true"></span>
                        Loading...
                    </div>
                    <div class="summary-card__label">System Health</div>
                </div>

                <!-- Charts -->
                <div class="card chart-card">
                    <h2 class="card__title">Energy Consumption Over Time</h2>
                    <div class="chart-card__container" id="energy-chart-container" role="img" aria-label="Energy Consumption Chart">
                        <canvas id="energyChart"></canvas>
                         <!-- Floating control panel for Energy Chart -->
                        <div class="floating-controls" id="energyChart-controls" aria-hidden="true">
                            <div class="control-group">
                                <label for="energyChart-lineColor">Line Color</label>
                                <input type="color" id="energyChart-lineColor" value="#007bff" aria-label="Energy Chart Line Color">
                            </div>
                             <div class="control-group">
                                <label for="energyChart-fillColor">Fill Color</label>
                                <input type="color" id="energyChart-fillColor" value="rgba(0, 123, 255, 0.2)" aria-label="Energy Chart Fill Color">
                            </div>
                            <div class="control-group">
                                <label for="energyChart-chartType">Chart Type</label>
                                <select id="energyChart-chartType" aria-label="Energy Chart Type">
                                    <option value="line">Line</option>
                                    <option value="bar">Bar</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label for="energyChart-fontSize">Font Size</label>
                                <input type="number" id="energyChart-fontSize" value="12" min="8" max="20" aria-label="Energy Chart Font Size">
                            </div>
                        </div>
                    </div>
                </div>

                 <div class="card chart-card">
                    <h2 class="card__title">System Performance Metrics</h2>
                    <div class="chart-card__container" id="performance-chart-container" role="img" aria-label="System Performance Chart">
                        <canvas id="performanceChart"></canvas>
                         <!-- Floating control panel for Performance Chart -->
                        <div class="floating-controls" id="performanceChart-controls" aria-hidden="true">
                            <div class="control-group">
                                <label for="performanceChart-barColor">Bar Color</label>
                                <input type="color" id="performanceChart-barColor" value="#28a745" aria-label="Performance Chart Bar Color">
                            </div>
                             <div class="control-group">
                                <label for="performanceChart-borderColor">Border Color</label>
                                <input type="color" id="performanceChart-borderColor" value="#1e7e34" aria-label="Performance Chart Border Color">
                            </div>
                            <div class="control-group">
                                <label for="performanceChart-chartType">Chart Type</label>
                                <select id="performanceChart-chartType" aria-label="Performance Chart Type">
                                    <option value="bar">Bar</option>
                                    <option value="line">Line</option>
                                </select>
                            </div>
                            <div class="control-group">
                                <label for="performanceChart-fontSize">Font Size</label>
                                <input type="number" id="performanceChart-fontSize" value="12" min="8" max="20" aria-label="Performance Chart Font Size">
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Control Panel -->
                <div class="card control-panel">
                    <h2 class="card__title">System Controls & Overrides</h2>

                    <div class="control-panel__section">
                        <h3 class="control-panel__section-title">AI Automated Control</h3>
                        <div class="control-panel__item">
                             <label for="ai-control-toggle">Enable AI Control:</label>
                             <label class="toggle-switch" aria-label="Enable AI Control">
                                <input type="checkbox" id="ai-control-toggle" checked>
                                <span class="toggle-switch__slider"></span>
                            </label>
                        </div>
                         <div class="control-panel__item">
                             <label for="ai-mode-select">AI Mode:</label>
                             <select id="ai-mode-select" class="header__select" aria-label="AI Mode Selection">
                                <option value="balanced">Balanced (Energy/Comfort)</option>
                                <option value="energy-priority">Energy Priority</option>
                                <option value="comfort-priority">Comfort Priority</option>
                            </select>
                        </div>
                    </div>

                     <div class="control-panel__section">
                        <h3 class="control-panel__section-title">Manual Overrides</h3>
                        <div class="control-panel__item">
                            <label for="hvac-temp-slider">HVAC Setpoint (<span id="hvac-temp-display">21.0</span>°C):</label>
                             <input type="range" id="hvac-temp-slider" min="18" max="25" value="21" step="0.5" aria-labelledby="hvac-temp-display">
                             <input type="number" id="hvac-temp-input" min="18" max="25" value="21" step="0.5" aria-label="HVAC Setpoint Temperature">
                        </div>
                         <div class="control-panel__item">
                            <label for="lighting-level-slider">Lighting Level (<span id="lighting-level-display">75</span>%):</label>
                             <input type="range" id="lighting-level-slider" min="0" max="100" value="75" step="5" aria-labelledby="lighting-level-display">
                             <input type="number" id="lighting-level-input" min="0" max="100" value="75" step="5" aria-label="Lighting Level Percentage">
                        </div>
                         <div class="control-panel__item">
                            <label for="override-duration">Override Duration (hours):</label>
                             <input type="number" id="override-duration" min="0.5" max="24" value="4" step="0.5" aria-label="Override Duration in Hours">
                        </div>
                        <button class="button button--danger" id="apply-override-button">
                            <span class="icon" aria-hidden="true">settings_power</span>
                            Apply Manual Override
                        </button>
                    </div>
                </div>

                 <!-- AI Suggestions/Recommendations -->
                <div class="card">
                    <h2 class="card__title">AI Recommendations</h2>
                    <ul id="ai-recommendations-list" style="list-style: none; padding: 0; margin: 0;">
                        <!-- Recommendations will be loaded here -->
                        <li><span class="icon" style="font-size: 1rem; vertical-align: middle; margin-right: var(--spacing-unit);" aria-hidden="true">lightbulb</span>AI suggests adjusting HVAC schedule for zone 3 based on predicted occupancy.</li>
                         <li style="margin-top: var(--spacing-unit);"><span class="icon" style="font-size: 1rem; vertical-align: middle; margin-right: var(--spacing-unit);" aria-hidden="true">lightbulb</span>Consider dimming lights in unoccupied areas during off-peak hours.</li>
                    </ul>
                </div>


                <!-- Tables -->
                <div class="card table-card">
                    <h2 class="card__title">System Status Overview</h2>
                    <table class="data-table" id="system-status-table">
                        <thead>
                            <tr>
                                <th scope="col">System</th>
                                <th scope="col">Zone</th>
                                <th scope="col">Status</th>
                                <th scope="col">Current Value</th>
                                <th scope="col">AI Target</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Table rows will be loaded here -->
                            <tr>
                                <td>HVAC</td>
                                <td>Zone 1</td>
                                <td><span class="status-indicator status-indicator--success" aria-hidden="true"></span>Operating</td>
                                <td>21.5°C</td>
                                <td>22.0°C</td>
                            </tr>
                            <tr>
                                <td>HVAC</td>
                                <td>Zone 2</td>
                                <td><span class="status-indicator status-indicator--warning" aria-hidden="true"></span>Idle</td>
                                <td>23.0°C</td>
                                <td>21.0°C</td>
                            </tr>
                             <tr>
                                <td>Lighting</td>
                                <td>Zone 1</td>
                                <td><span class="status-indicator status-indicator--info" aria-hidden="true"></span>Dimmed</td>
                                <td>50%</td>
                                <td>45%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                 <div class="card table-card">
                    <h2 class="card__title">Override Log</h2>
                    <table class="data-table" id="override-log-table">
                        <thead>
                            <tr>
                                <th scope="col">Timestamp</th>
                                <th scope="col">User</th>
                                <th scope="col">System</th>
                                <th scope="col">Zone</th>
                                <th scope="col">Action</th>
                                <th scope="col">Value</th>
                                <th scope="col">Duration</th>
                            </tr>
                        </thead>
                        <tbody>
                             <!-- Table rows will be loaded here -->
                            <tr>
                                <td>2023-10-27 10:30</td>
                                <td>Manager A</td>
                                <td>HVAC</td>
                                <td>Zone 2</td>
                                <td>Override Setpoint</td>
                                <td>24.0°C</td>
                                <td>2 hours</td>
                            </tr>
                             <tr>
                                <td>2023-10-27 09:00</td>
                                <td>System</td>
                                <td>Lighting</td>
                                <td>Zone 3</td>
                                <td>AI Adjustment</td>
                                <td>70%</td>
                                <td>N/A</td>
                            </tr>
                        </tbody>
                    </table>
                </div>

            </div>
        </main>
    </div>

    <!-- Override Confirmation Modal -->
    <div class="modal" id="override-confirm-modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="modal__content">
            <button class="modal__close-button" id="modal-close-button" aria-label="Close modal">&times;</button>
            <h3 class="modal__title" id="modal-title">Confirm Override</h3>
            <p>Are you sure you want to apply the manual override for HVAC and Lighting settings?</p>
            <div class="modal__actions">
                <button class="button button--secondary" id="modal-cancel-button">Cancel</button>
                <button class="button button--danger" id="modal-confirm-button">Confirm</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { Chart } from "https://esm.sh/chart.js/auto";

        // --- DOM Elements ---
        const buildingSelect = document.getElementById('building-select');
        const dateStartInput = document.getElementById('date-start');
        const dateEndInput = document.getElementById('date-end');
        const totalEnergyUsageEl = document.getElementById('total-energy-usage');
        const costSavingsEl = document.getElementById('cost-savings');
        const comfortLevelEl = document.getElementById('comfort-level');
        const aiStatusEl = document.getElementById('ai-status');
        const aiControlToggle = document.getElementById('ai-control-toggle');
        const aiModeSelect = document.getElementById('ai-mode-select');
        const hvacTempSlider = document.getElementById('hvac-temp-slider');
        const hvacTempInput = document.getElementById('hvac-temp-input');
        const hvacTempDisplay = document.getElementById('hvac-temp-display');
        const lightingLevelSlider = document.getElementById('lighting-level-slider');
        const lightingLevelInput = document.getElementById('lighting-level-input');
        const lightingLevelDisplay = document.getElementById('lighting-level-display');
        const overrideDurationInput = document.getElementById('override-duration');
        const applyOverrideButton = document.getElementById('apply-override-button');
        const systemStatusTableBody = document.getElementById('system-status-table').querySelector('tbody');
        const overrideLogTableBody = document.getElementById('override-log-table').querySelector('tbody');
        const overrideConfirmModal = document.getElementById('override-confirm-modal');
        const modalCloseButton = document.getElementById('modal-close-button');
        const modalCancelButton = document.getElementById('modal-cancel-button');
        const modalConfirmButton = document.getElementById('modal-confirm-button');
        const mainLoadingSpinner = document.getElementById('main-loading-spinner');
        const dashboardGrid = document.getElementById('dashboard-grid');

        // --- Chart Elements and Controls ---
        const energyChartCanvas = document.getElementById('energyChart');
        const performanceChartCanvas = document.getElementById('performanceChart');

        const energyChartControls = document.getElementById('energyChart-controls');
        const energyChartLineColorInput = document.getElementById('energyChart-lineColor');
        const energyChartFillColorInput = document.getElementById('energyChart-fillColor');
        const energyChartTypeSelect = document.getElementById('energyChart-chartType');
        const energyChartFontSizeInput = document.getElementById('energyChart-fontSize');

        const performanceChartControls = document.getElementById('performanceChart-controls');
        const performanceChartBarColorInput = document.getElementById('performanceChart-barColor');
        const performanceChartBorderColorInput = document.getElementById('performanceChart-borderColor');
        const performanceChartTypeSelect = document.getElementById('performanceChart-chartType');
        const performanceChartFontSizeInput = document.getElementById('performanceChart-fontSize');

        let energyChart = null;
        let performanceChart = null;

        // --- State ---
        let currentBuildingId = buildingSelect.value;
        let currentDateRange = {
            start: dateStartInput.value,
            end: dateEndInput.value
        };
        let isDataLoading = false;

        // --- Dummy Data (Replace with API Calls) ---
        const dummyData = {
            'building-1': {
                summary: {
                    totalEnergyUsage: '15,230',
                    costSavings: '$2,150',
                    comfortLevel: '7.8',
                    aiStatus: { status: 'Active', indicator: 'success' }
                },
                energyData: {
                    labels: ['Oct 1', 'Oct 2', 'Oct 3', 'Oct 4', 'Oct 5', 'Oct 6', 'Oct 7'],
                    datasets: [{
                        label: 'Energy Usage (kWh)',
                        data: [1500, 1450, 1600, 1550, 1700, 1650, 1580],
                        borderColor: "var(--primary-color)",
                        backgroundColor: "rgba(0, 123, 255, 0.2)",
                        fill: true,
                        tension: 0.3
                    }]
                },
                 performanceData: {
                    labels: ['HVAC Efficiency', 'Lighting Usage', 'Occupancy Matching'],
                    datasets: [{
                        label: 'Score (%)',
                        data: [85, 70, 92],
                        backgroundColor: "var(--success-color)",
                        borderColor: "var(--primary-color)",
                        borderWidth: 1
                    }]
                },
                systemStatus: [
                    { system: 'HVAC', zone: 'Zone 1', status: 'Operating', indicator: 'success', currentValue: '21.5°C', aiTarget: '22.0°C' },
                    { system: 'HVAC', zone: 'Zone 2', status: 'Idle', indicator: 'warning', currentValue: '23.0°C', aiTarget: '21.0°C' },
                    { system: 'Lighting', zone: 'Zone 1', status: 'Dimmed', indicator: 'info', currentValue: '50%', aiTarget: '45%' },
                     { system: 'Lighting', zone: 'Zone 2', status: 'Active', indicator: 'success', currentValue: '80%', aiTarget: '75%' },
                ],
                overrideLog: [
                     { timestamp: '2023-10-27 10:30', user: 'Manager A', system: 'HVAC', zone: 'Zone 2', action: 'Override Setpoint', value: '24.0°C', duration: '2 hours' },
                     { timestamp: '2023-10-27 09:00', user: 'System', system: 'Lighting', zone: 'Zone 3', action: 'AI Adjustment', value: '70%', duration: 'N/A' },
                ]
            },
             'building-2': {
                summary: {
                    totalEnergyUsage: '21,500',
                    costSavings: '$3,500',
                    comfortLevel: '8.1',
                    aiStatus: { status: 'Active', indicator: 'success' }
                },
                energyData: {
                    labels: ['Oct 1', 'Oct 2', 'Oct 3', 'Oct 4', 'Oct 5', 'Oct 6', 'Oct 7'],
                    datasets: [{
                        label: 'Energy Usage (kWh)',
                        data: [2100, 2050, 2200, 2150, 2300, 2250, 2180],
                        borderColor: "var(--primary-color)",
                        backgroundColor: "rgba(0, 123, 255, 0.2)",
                        fill: true,
                        tension: 0.3
                    }]
                },
                 performanceData: {
                    labels: ['HVAC Efficiency', 'Lighting Usage', 'Occupancy Matching'],
                    datasets: [{
                        label: 'Score (%)',
                        data: [78, 85, 88],
                        backgroundColor: "var(--success-color)",
                        borderColor: "var(--primary-color)",
                        borderWidth: 1
                    }]
                },
                systemStatus: [
                    { system: 'HVAC', zone: 'Zone A', status: 'Operating', indicator: 'success', currentValue: '22.0°C', aiTarget: '21.8°C' },
                    { system: 'Lighting', zone: 'Zone A', status: 'Active', indicator: 'success', currentValue: '90%', aiTarget: '85%' },
                ],
                overrideLog: [
                     { timestamp: '2023-10-26 14:00', user: 'System', system: 'HVAC', zone: 'Zone A', action: 'AI Adjustment', value: '21.8°C', duration: 'N/A' },
                ]
            },
             'building-3': {
                summary: {
                    totalEnergyUsage: '18,900',
                    costSavings: '$1,800',
                    comfortLevel: '7.5',
                    aiStatus: { status: 'Warning', indicator: 'warning' }
                },
                energyData: {
                    labels: ['Oct 1', 'Oct 2', 'Oct 3', 'Oct 4', 'Oct 5', 'Oct 6', 'Oct 7'],
                    datasets: [{
                        label: 'Energy Usage (kWh)',
                        data: [1800, 1750, 1900, 1850, 2000, 1950, 1880],
                        borderColor: "var(--primary-color)",
                        backgroundColor: "rgba(0, 123, 255, 0.2)",
                        fill: true,
                        tension: 0.3
                    }]
                },
                 performanceData: {
                    labels: ['HVAC Efficiency', 'Lighting Usage', 'Occupancy Matching'],
                    datasets: [{
                        label: 'Score (%)',
                        data: [65, 78, 80],
                        backgroundColor: "var(--success-color)",
                        borderColor: "var(--primary-color)",
                        borderWidth: 1
                    }]
                },
                systemStatus: [
                    { system: 'HVAC', zone: 'Floor 1', status: 'Error', indicator: 'danger', currentValue: '25.0°C', aiTarget: '--' },
                    { system: 'Lighting', zone: 'Floor 1', status: 'Active', indicator: 'success', currentValue: '100%', aiTarget: '90%' },
                ],
                overrideLog: [
                     { timestamp: '2023-10-27 08:00', user: 'System', system: 'HVAC', zone: 'Floor 1', action: 'AI Adjustment Failed', value: '--', duration: 'N/A' },
                ]
            }
        };

        // --- Functions ---

        function showLoading() {
            isDataLoading = true;
            mainLoadingSpinner.classList.add('loading-spinner--visible');
             dashboardGrid.style.opacity = '0.5'; // Dim content
             dashboardGrid.style.pointerEvents = 'none'; // Disable interaction
             // Hide floating controls while loading
             document.querySelectorAll('.floating-controls').forEach(controls => {
                 controls.classList.remove('active');
                 controls.setAttribute('aria-hidden', 'true');
             });
        }

        function hideLoading() {
            isDataLoading = false;
            mainLoadingSpinner.classList.remove('loading-spinner--visible');
             dashboardGrid.style.opacity = '1';
             dashboardGrid.style.pointerEvents = 'auto';
        }

        function fetchData(buildingId, dateRange) {
            showLoading();
            // Simulate API call delay
            return new Promise((resolve, reject) => {
                setTimeout(() => {
                    const data = dummyData[buildingId];
                    if (data) {
                         // In a real app, filter data by dateRange here
                        resolve(data);
                    } else {
                        // Simulate error for non-existent building
                        reject(new Error(`Data not found for building: ${buildingId}`));
                    }
                    hideLoading();
                }, 500); // Simulate 500ms load time
            }).catch(error => {
                 console.error("Error fetching data:", error);
                 // Display error message on dashboard?
                 hideLoading();
                 // Potentially show empty state or error message in cards/tables
                 updateSummaryCards({ totalEnergyUsage: '--', costSavings: '--', comfortLevel: '--', aiStatus: { status: 'Error', indicator: 'danger' } });
                 renderCharts({ labels: [], datasets: [] }, { labels: [], datasets: [] });
                 updateTable(systemStatusTableBody, []);
                 updateTable(overrideLogTableBody, []);
            });
        }

        function updateSummaryCards(summary) {
            totalEnergyUsageEl.textContent = summary.totalEnergyUsage;
            costSavingsEl.textContent = summary.costSavings;
            comfortLevelEl.textContent = summary.comfortLevel;
            aiStatusEl.innerHTML = `<span class="status-indicator status-indicator--${summary.aiStatus.indicator}" aria-hidden="true"></span>${summary.aiStatus.status}`;
        }

        function updateTable(tableBodyEl, data) {
            tableBodyEl.innerHTML = ''; // Clear current rows
            if (data.length === 0) {
                 const noDataRow = document.createElement('tr');
                 const cell = document.createElement('td');
                 cell.setAttribute('colspan', tableBodyEl.previousElementSibling.querySelectorAll('th').length); // Span all columns
                 cell.textContent = 'No data available.';
                 cell.style.textAlign = 'center';
                 cell.style.fontStyle = 'italic';
                 cell.style.color = 'var(--text-color-secondary)';
                 noDataRow.appendChild(cell);
                 tableBodyEl.appendChild(noDataRow);
                 return;
            }

            data.forEach(rowData => {
                const row = document.createElement('tr');
                // Manually map keys to ensure order and handle indicator
                const orderedKeys = ['timestamp', 'user', 'system', 'zone', 'status', 'currentValue', 'aiTarget', 'action', 'value', 'duration'];
                const relevantKeys = orderedKeys.filter(key => rowData.hasOwnProperty(key) && key !== 'indicator');


                relevantKeys.forEach(key => {
                    const cell = document.createElement('td');
                    if (key === 'status' && rowData.hasOwnProperty('indicator')) {
                         cell.innerHTML = `<span class="status-indicator status-indicator--${rowData.indicator}" aria-hidden="true"></span>${rowData[key]}`;
                    } else {
                        cell.textContent = rowData[key];
                    }
                    row.appendChild(cell);
                });
                tableBodyEl.appendChild(row);
            });
        }

        function renderCharts(energyData, performanceData) {
            // Destroy existing charts if they exist
            if (energyChart) energyChart.destroy();
            if (performanceChart) performanceChart.destroy();

            // Energy Chart
            energyChart = new Chart(energyChartCanvas, {
                type: energyChartTypeSelect.value, // Use control value
                data: energyData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: (e) => toggleFloatingControls(energyChartControls),
                     plugins: {
                        legend: {
                            labels: {
                                font: {
                                    size: parseInt(energyChartFontSizeInput.value) // Use control value
                                }
                            }
                        }
                    },
                     scales: {
                        y: {
                            beginAtZero: true,
                             ticks: {
                                font: {
                                     size: parseInt(energyChartFontSizeInput.value) // Use control value
                                }
                            }
                        },
                        x: {
                             ticks: {
                                font: {
                                     size: parseInt(energyChartFontSizeInput.value) // Use control value
                                }
                            }
                        }
                    },
                     hover: {
                         mode: 'nearest', // Highlight nearest element on hover
                         intersect: true
                     },
                     tooltips: { // Chart.js v3+ uses `tooltip` instead of `tooltips`
                         mode: 'index',
                         intersect: false,
                     }
                }
            });

            // Performance Chart
             performanceChart = new Chart(performanceChartCanvas, {
                type: performanceChartTypeSelect.value, // Use control value
                data: performanceData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                     onClick: (e) => toggleFloatingControls(performanceChartControls),
                     plugins: {
                        legend: {
                            labels: {
                                font: {
                                    size: parseInt(performanceChartFontSizeInput.value) // Use control value
                                }
                            }
                        }
                    },
                     scales: {
                        y: {
                            beginAtZero: true,
                             ticks: {
                                font: {
                                     size: parseInt(performanceChartFontSizeInput.value) // Use control value
                                }
                            }
                        },
                        x: {
                             ticks: {
                                font: {
                                     size: parseInt(performanceChartFontSizeInput.value) // Use control value
                                }
                            }
                        }
                    },
                     hover: {
                         mode: 'nearest',
                         intersect: true
                     },
                      tooltips: {
                         mode: 'index',
                         intersect: false,
                     }
                }
            });
        }

        function toggleFloatingControls(controlsElement) {
             // Close all other controls first
            document.querySelectorAll('.floating-controls.active').forEach(controls => {
                if (controls !== controlsElement) {
                    controls.classList.remove('active');
                    controls.setAttribute('aria-hidden', 'true');
                }
            });
            const isActive = controlsElement.classList.toggle('active');
            controlsElement.setAttribute('aria-hidden', !isActive);
        }

        function updateChartAppearance(chart, controlsId) {
            const controls = document.getElementById(controlsId);
            const chartType = controls.querySelector('select').value;
            const fontSize = parseInt(controls.querySelector('input[type="number"]').value);

            chart.config.type = chartType;

            // Update colors based on chart type and controls
            if (chartType === 'line') {
                 const lineColor = controls.querySelector('input[type="color"][id$="-lineColor"]').value;
                 const fillColor = controls.querySelector('input[type="color"][id$="-fillColor"]').value;
                 chart.config.data.datasets.forEach(dataset => {
                     dataset.borderColor = lineColor;
                     dataset.backgroundColor = fillColor;
                     dataset.fill = true;
                     dataset.borderWidth = 2; // Standard line width
                 });
            } else if (chartType === 'bar') {
                 const barColor = controls.querySelector('input[type="color"][id$="-barColor"]').value;
                 const borderColor = controls.querySelector('input[type="color"][id$="-borderColor"]').value;
                 chart.config.data.datasets.forEach(dataset => {
                     dataset.backgroundColor = barColor;
                     dataset.borderColor = borderColor;
                     dataset.borderWidth = 1; // Bars typically have borders
                     dataset.fill = false; // Bars are not typically filled areas
                 });
            }


            // Update font size
             const updateFont = (obj) => obj?.font && (obj.font.size = fontSize);
            if (chart.options.plugins.legend?.labels) updateFont(chart.options.plugins.legend.labels);
            if (chart.options.scales?.y?.ticks) updateFont(chart.options.scales.y.ticks);
            if (chart.options.scales?.x?.ticks) updateFont(chart.options.scales.x.ticks);


            chart.update();
        }


        function loadDashboard(buildingId, dateRange) {
            fetchData(buildingId, dateRange).then(data => {
                if (data) { // Only update if data was successfully fetched
                    updateSummaryCards(data.summary);
                    renderCharts(data.energyData, data.performanceData); // Initial render
                    updateTable(systemStatusTableBody, data.systemStatus);
                    updateTable(overrideLogTableBody, data.overrideLog);
                }
            });
        }

        function showModal(modalElement) {
            modalElement.classList.add('modal--visible');
            modalElement.setAttribute('aria-hidden', 'false');
             // Trap focus inside modal (basic implementation)
             const focusableElements = modalElement.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
             const firstElement = focusableElements[0];
             const lastElement = focusableElements[focusableElements.length - 1];

             if (firstElement) firstElement.focus();

             modalElement.addEventListener('keydown', function handler(e) {
                 if (e.key === 'Tab') {
                     if (e.shiftKey) { // Shift + Tab
                         if (document.activeElement === firstElement) {
                             lastElement.focus();
                             e.preventDefault();
                         }
                     } else { // Tab
                         if (document.activeElement === lastElement) {
                             firstElement.focus();
                             e.preventDefault();
                         }
                     }
                 }
                  if (e.key === 'Escape') {
                      hideModal(modalElement);
                  }
             });
        }

        function hideModal(modalElement) {
            modalElement.classList.remove('modal--visible');
            modalElement.setAttribute('aria-hidden', 'true');
             // Remove focus trap listener
             const oldHandler = modalElement.onkeydown; // This is a simplified way; consider named functions or better event management
             if (oldHandler) modalElement.removeEventListener('keydown', oldHandler);
             // Return focus to element that opened the modal (if possible)
             // This requires storing the triggering element's reference
        }

         function updateOverrideInputs(value, type) {
             if (type === 'hvac') {
                 hvacTempSlider.value = value;
                 hvacTempInput.value = value;
                 hvacTempDisplay.textContent = parseFloat(value).toFixed(1); // Ensure one decimal place
             } else if (type === 'lighting') {
                 lightingLevelSlider.value = value;
                 lightingLevelInput.value = value;
                 lightingLevelDisplay.textContent = parseInt(value); // Ensure integer
             }
         }


        // --- Event Listeners ---

        buildingSelect.addEventListener('change', (event) => {
            currentBuildingId = event.target.value;
            loadDashboard(currentBuildingId, currentDateRange);
        });

        // Note: Date range change currently logs but doesn't trigger data reload
        // Uncomment loadDashboard below if date changes should refetch data
        dateStartInput.addEventListener('change', (event) => {
            currentDateRange.start = event.target.value;
            console.log("Date range start changed:", currentDateRange.start);
             // loadDashboard(currentBuildingId, currentDateRange);
        });

        dateEndInput.addEventListener('change', (event) => {
            currentDateRange.end = event.target.value;
            console.log("Date range end changed:", currentDateRange.end);
             // loadDashboard(currentBuildingId, currentDateRange);
        });

        aiControlToggle.addEventListener('change', (event) => {
            const isEnabled = event.target.checked;
            aiModeSelect.disabled = !isEnabled;
            applyOverrideButton.disabled = isEnabled; // Disable manual override if AI is enabled
            // Simulate sending command to backend
            console.log(`AI Control ${isEnabled ? 'Enabled' : 'Disabled'}`);
             // Update AI status indicator/text based on toggle state if needed
             // Example: aiStatusEl.innerHTML = `<span class="status-indicator status-indicator--${isEnabled ? 'success' : 'info'}" aria-hidden="true"></span>${isEnabled ? 'Active' : 'Manual Override Possible'}`;
        });

        aiModeSelect.addEventListener('change', (event) => {
             console.log(`AI Mode changed to: ${event.target.value}`);
             // Simulate sending command to backend
        });

        hvacTempSlider.addEventListener('input', (event) => {
             updateOverrideInputs(event.target.value, 'hvac');
        });

         hvacTempInput.addEventListener('change', (event) => {
             // Ensure input value is within range and update slider
             let value = parseFloat(event.target.value);
             const min = parseFloat(hvacTempInput.min);
             const max = parseFloat(hvacTempInput.max);
             if (isNaN(value) || value < min) value = min;
             if (value > max) value = max;
             event.target.value = value.toFixed(1); // Keep one decimal place
             updateOverrideInputs(value, 'hvac');
         });

         lightingLevelSlider.addEventListener('input', (event) => {
             updateOverrideInputs(event.target.value, 'lighting');
        });

         lightingLevelInput.addEventListener('change', (event) => {
             // Ensure input value is within range and update slider
             let value = parseInt(event.target.value);
             const min = parseInt(lightingLevelInput.min);
             const max = parseInt(lightingLevelInput.max);
             if (isNaN(value) || value < min) value = min;
             if (value > max) value = max;
             event.target.value = value;
             updateOverrideInputs(value, 'lighting');
         });


        applyOverrideButton.addEventListener('click', () => {
            showModal(overrideConfirmModal);
        });

        modalCloseButton.addEventListener('click', () => {
            hideModal(overrideConfirmModal);
        });

        modalCancelButton.addEventListener('click', () => {
            hideModal(overrideConfirmModal);
        });

        modalConfirmButton.addEventListener('click', () => {
            // Simulate applying override
            const hvacSetpoint = hvacTempInput.value;
            const lightingLevel = lightingLevelInput.value;
            const duration = overrideDurationInput.value;
            const building = buildingSelect.options[buildingSelect.selectedIndex].text;

            console.log(`Override applied for ${building}: HVAC=${hvacSetpoint}°C, Lighting=${lightingLevel}%, Duration=${duration} hours`);

            // In a real app, send override command to backend
            // On success, update override log table (simulated)
             const newLogEntry = {
                 timestamp: new Date().toLocaleString(),
                 user: 'Facility Manager', // Replace with actual user
                 system: 'HVAC/Lighting',
                 zone: 'Multiple', // Or specific zones if applicable
                 action: 'Manual Override',
                 value: `HVAC: ${hvacSetpoint}°C, Light: ${lightingLevel}%`,
                 duration: `${duration} hours`
             };
             // Add to dummy data and re-render table (simplified)
             // Check if currentBuildingId exists in dummyData before pushing
             if (dummyData[currentBuildingId]) {
                 dummyData[currentBuildingId].overrideLog.unshift(newLogEntry); // Add to beginning
                 updateTable(overrideLogTableBody, dummyData[currentBuildingId].overrideLog);
             } else {
                 console.error("Cannot add override log, building data not found.");
                  // Handle case where building data is missing
             }


            hideModal(overrideConfirmModal);
        });

         // Close floating controls when clicking outside
        document.addEventListener('click', (e) => {
            document.querySelectorAll('.floating-controls.active').forEach(controls => {
                // Check if click is outside the controls AND outside the chart canvas/container
                const chartContainer = controls.closest('.chart-card__container');
                if (!controls.contains(e.target) && (!chartContainer || !chartContainer.contains(e.target))) {
                    controls.classList.remove('active');
                    controls.setAttribute('aria-hidden', 'true');
                }
            });
        });

        // Chart Control Listeners
        document.querySelectorAll('.floating-controls input, .floating-controls select').forEach(element => {
            element.addEventListener('change', (event) => {
                 const controls = event.target.closest('.floating-controls');
                 if (!controls) return; // Should not happen with correct structure
                 const controlsId = controls.id;

                 // Update the chart based on which controls panel triggered the change
                 if (controlsId === 'energyChart-controls') {
                     if (energyChart) updateChartAppearance(energyChart, controlsId);
                 } else if (controlsId === 'performanceChart-controls') {
                     if (performanceChart) updateChartAppearance(performanceChart, controlsId);
                 }
            });
        });


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set default date range (e.g., last 7 days)
            const today = new Date();
            const sevenDaysAgo = new Date(today);
            sevenDaysAgo.setDate(today.getDate() - 7);

            const formatDate = (date) => {
                const yyyy = date.getFullYear();
                const mm = String(date.getMonth() + 1).padStart(2, '0'); // Months are 0-indexed
                const dd = String(date.getDate()).padStart(2, '0');
                return `${yyyy}-${mm}-${dd}`;
            };

            dateEndInput.value = formatDate(today);
            dateStartInput.value = formatDate(sevenDaysAgo);

            currentDateRange = {
                start: dateStartInput.value,
                end: dateEndInput.value
            };

            // Load initial data for the default building and date range
            loadDashboard(currentBuildingId, currentDateRange);

            // Initial state for controls
            aiModeSelect.disabled = !aiControlToggle.checked;
            applyOverrideButton.disabled = aiControlToggle.checked;

            // Sync slider and number input for HVAC and Lighting on load
            updateOverrideInputs(hvacTempSlider.value, 'hvac');
            updateOverrideInputs(lightingLevelSlider.value, 'lighting');

             // Set initial aria-hidden state for floating controls
             energyChartControls.setAttribute('aria-hidden', 'true');
             performanceChartControls.setAttribute('aria-hidden', 'true');
             overrideConfirmModal.setAttribute('aria-hidden', 'true');
        });


    </script>

</body>
</html>
