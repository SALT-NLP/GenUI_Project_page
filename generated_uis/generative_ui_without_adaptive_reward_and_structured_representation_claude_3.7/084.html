<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Children's Hospital Foundation Communications Platform</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,400,0,0" rel="stylesheet" />
    <style>
        :root {
            --primary-color: #007acc; /* Vibrant Blue */
            --primary-color-dark: #005f99;
            --secondary-color: #4CAF50; /* Green for success/consent */
            --secondary-color-dark: #388E3C;
            --accent-color: #FF9800; /* Orange for warnings/highlights */
            --accent-color-dark: #F57C00;
            --danger-color: #f44336; /* Red for errors/expired consent */
            --danger-color-dark: #D32F2F;
            --background-color: #f4f6f8; /* Light grey background */
            --surface-color: #ffffff; /* White for cards/panels */
            --text-color-primary: #333333;
            --text-color-secondary: #666666;
            --border-color: #e0e0e0;
            --spacing-unit: 8px;
            --border-radius: 8px;
            --shadow-subtle: 0 1px 3px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 6px rgba(0, 0, 0, 0.15); /* Slightly stronger shadow */
            --transition-speed: 0.2s;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: var(--text-color-primary);
            background-color: var(--background-color);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .sidebar {
            width: 250px;
            background-color: var(--surface-color);
            box-shadow: var(--shadow-medium);
            padding: calc(var(--spacing-unit) * 2);
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            transition: width var(--transition-speed) ease-in-out;
        }

        .sidebar h2 {
            font-size: 1.5em;
            margin-bottom: calc(var(--spacing-unit) * 3);
            color: var(--primary-color-dark);
            text-align: center;
            transition: opacity var(--transition-speed);
        }

        .sidebar nav ul {
            list-style: none;
            padding: 0;
        }

        .sidebar nav li {
            margin-bottom: var(--spacing-unit);
        }

        .sidebar nav a {
            display: flex;
            align-items: center;
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 2);
            color: var(--text-color-secondary);
            text-decoration: none;
            border-radius: var(--border-radius);
            transition: background-color var(--transition-speed), color var(--transition-speed), transform var(--transition-speed);
             outline-offset: 2px; /* Ensure outline is visible */
        }

        .sidebar nav a:hover {
            background-color: var(--background-color);
            color: var(--text-color-primary);
            transform: translateX(4px); /* Subtle hover effect */
        }

        .sidebar nav a:focus-visible {
             outline: 2px solid var(--primary-color);
             background-color: var(--background-color); /* Keep hover style on focus */
             color: var(--text-color-primary);
        }


        .sidebar nav a.active {
            background-color: var(--primary-color);
            color: var(--surface-color);
            font-weight: 500;
             transform: translateX(0); /* Reset transform for active */
        }

         .sidebar nav a.active:hover {
             background-color: var(--primary-color-dark);
             color: var(--surface-color);
             transform: translateX(4px); /* Apply hover effect to active state too */
         }

          .sidebar nav a.active:focus-visible {
             outline: 2px solid var(--background-color); /* Contrast outline for active state */
             background-color: var(--primary-color-dark);
             color: var(--surface-color);
             transform: translateX(4px);
         }


        .sidebar nav a .material-symbols-rounded {
            margin-right: var(--spacing-unit);
            font-size: 20px;
             flex-shrink: 0;
        }


        .main-content {
            flex-grow: 1;
            padding: calc(var(--spacing-unit) * 3);
            overflow-y: auto;
        }

        .section {
            display: none;
            animation: fadeIn 0.5s ease-in-out;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        h2 {
            font-size: 2em;
            margin-bottom: calc(var(--spacing-unit) * 3);
            color: var(--text-color-primary);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: var(--spacing-unit);
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: calc(var(--spacing-unit) * 3);
            margin-bottom: calc(var(--spacing-unit) * 4);
        }

        .card {
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-subtle);
            padding: calc(var(--spacing-unit) * 3);
            display: flex;
            flex-direction: column;
            transition: transform var(--transition-speed), box-shadow var(--transition-speed);
            cursor: default;
             outline-offset: 4px; /* Ensure outline is visible */
        }

         .card.interactive {
             cursor: pointer;
         }

        .card:hover {
            transform: translateY(-4px); /* More pronounced lift */
            box-shadow: var(--shadow-medium);
        }

         .card.interactive:focus-visible {
             outline: 2px solid var(--primary-color);
             transform: translateY(-4px); /* Keep hover style on focus */
             box-shadow: var(--shadow-medium);
         }


        .card h3 {
            margin-top: 0;
            margin-bottom: calc(var(--spacing-unit) * 2);
            color: var(--primary-color);
            font-size: 1.2em;
        }

        .card p {
            color: var(--text-color-secondary);
            flex-grow: 1;
        }

        .card .metric {
            font-size: 2.5em; /* Larger metric font */
            font-weight: 700;
            color: var(--primary-color-dark);
            margin-bottom: var(--spacing-unit);
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-top: calc(var(--spacing-unit) * 2);
            cursor: pointer;
            outline-offset: 4px;
        }

         .chart-container:focus-visible {
             outline: 2px solid var(--primary-color);
         }


        .floating-controls {
            position: absolute;
            top: calc(var(--spacing-unit) * 2);
            right: calc(var(--spacing-unit) * 2);
            background: rgba(255, 255, 255, 0.95);
            padding: calc(var(--spacing-unit) * 2);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            pointer-events: none;
            z-index: 10;
            min-width: 180px;
            outline: none;
        }

        .floating-controls.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        .control-group {
            margin-bottom: var(--spacing-unit);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-unit);
        }

        .control-group label {
            font-size: 0.9em;
            color: var(--text-color-secondary);
        }

        .control-group input[type="color"],
        .control-group input[type="number"],
        .control-group select {
            padding: var(--spacing-unit);
            border: 1px solid var(--border-color);
            border-radius: calc(var(--border-radius) / 2);
            font-size: 0.9em;
            color: var(--text-color-primary);
             transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
             outline-offset: 2px;
        }

         .control-group input[type="color"]:focus,
         .control-group input[type="number"]:focus,
         .control-group select:focus {
             border-color: var(--primary-color);
             box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.2);
             outline: none;
         }

         .control-group input[type="color"]:focus-visible,
         .control-group input[type="number"]:focus-visible,
         .control-group select:focus-visible {
             outline: 2px solid var(--primary-color);
             outline-offset: 2px;
         }


        .button {
            display: inline-flex;
            align-items: center;
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 2);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1em;
            font-weight: 500;
            transition: background-color var(--transition-speed), opacity var(--transition-speed), box-shadow var(--transition-speed), transform var(--transition-speed);
            text-decoration: none;
            text-align: center;
            outline-offset: 2px;
        }

        .button:focus-visible {
             outline: 2px solid var(--primary-color);
        }

        .button:hover:not(:disabled) {
             transform: translateY(-1px); /* Subtle lift on hover */
             box-shadow: var(--shadow-subtle);
        }


        .button-primary {
            background-color: var(--primary-color);
            color: var(--surface-color);
        }

        .button-primary:hover:not(:disabled) {
            background-color: var(--primary-color-dark);
        }

        .button-secondary {
            background-color: var(--background-color);
            color: var(--text-color-primary);
            border: 1px solid var(--border-color);
        }

        .button-secondary:hover:not(:disabled) {
            background-color: #e9ecef;
        }

        .button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            box-shadow: none;
            transform: none;
        }

        .button .material-symbols-rounded {
            margin-right: var(--spacing-unit);
            font-size: 18px;
        }

         .button:only-child .material-symbols-rounded {
             margin-right: 0;
         }


        .actions {
            margin-bottom: calc(var(--spacing-unit) * 2);
            display: flex;
            gap: calc(var(--spacing-unit) * 2);
            align-items: center;
            flex-wrap: wrap;
        }

         .actions > input[type="text"] {
             flex-grow: 1;
             max-width: 300px;
             padding: var(--spacing-unit) calc(var(--spacing-unit) * 1.5);
             border: 1px solid var(--border-color);
             border-radius: var(--border-radius);
             font-size: 1em;
             transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
             outline-offset: 2px;
         }

          .actions > input[type="text"]:focus {
             border-color: var(--primary-color);
             box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.2);
             outline: none;
         }

          .actions > input[type="text"]:focus-visible {
             outline: 2px solid var(--primary-color);
             outline-offset: 2px;
         }


        .content-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: calc(var(--spacing-unit) * 2);
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow-subtle);
        }

        .content-table th,
        .content-table td {
            padding: calc(var(--spacing-unit) * 1.5);
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        .content-table th {
            background-color: var(--background-color);
            font-weight: 600;
            color: var(--text-color-primary);
            cursor: pointer;
            transition: background-color var(--transition-speed);
            outline-offset: -2px;
        }

        .content-table th:hover {
            background-color: #e9ecef;
        }

         .content-table th:focus-visible {
             outline: 2px solid var(--primary-color);
             outline-offset: -2px;
         }


        .content-table tbody tr {
            transition: background-color var(--transition-speed);
            cursor: pointer;
            outline-offset: -2px;
        }

        .content-table tbody tr:hover {
            background-color: var(--background-color);
        }

         .content-table tbody tr:focus-visible {
             outline: 2px solid var(--primary-color);
             background-color: var(--background-color);
             outline-offset: -2px;
         }


        .content-table td .status-indicator {
            display: inline-block;
            padding: calc(var(--spacing-unit) / 2) var(--spacing-unit);
            border-radius: calc(var(--border-radius) / 2);
            font-size: 0.8em;
            font-weight: 500;
        }

        .status-indicator.draft {
            background-color: #ffecb3;
            color: var(--accent-color);
        }

        .status-indicator.review {
            background-color: #bbdefb;
            color: var(--primary-color);
        }

        .status-indicator.approved {
            background-color: #c8e6c9;
            color: var(--secondary-color);
        }

        .status-indicator.published {
            background-color: #e1bee7;
            color: #9c27b0; /* Purple */
        }

        .content-detail-form {
            background-color: var(--surface-color);
            padding: calc(var(--spacing-unit) * 3);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-subtle);
        }

        .form-group {
            margin-bottom: calc(var(--spacing-unit) * 2);
        }

        .form-group label {
            display: block;
            margin-bottom: var(--spacing-unit);
            font-weight: 600;
            color: var(--text-color-primary);
        }

        .form-group input[type="text"],
        .form-group input[type="date"],
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: calc(var(--spacing-unit) * 1.5);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1em;
            color: var(--text-color-primary);
            transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
             outline-offset: 2px;
        }

         .form-group input.invalid,
         .form-group select.invalid,
         .form-group textarea.invalid {
             border-color: var(--danger-color);
             box-shadow: 0 0 0 2px rgba(244, 67, 54, 0.2);
         }

         .form-group input.invalid:focus,
         .form-group select.invalid:focus,
         .form-group textarea.invalid:focus {
             border-color: var(--danger-color-dark);
             box-shadow: 0 0 0 2px rgba(244, 67, 54, 0.3);
         }


        .form-group input[type="text"]:focus,
        .form-group input[type="date"]:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.2);
            outline: none;
        }

         .form-group input[type="text"]:focus-visible,
         .form-group input[type="date"]:focus-visible,
         .form-group select:focus-visible,
         .form-group textarea:focus-visible {
             outline: 2px solid var(--primary-color);
             outline-offset: 2px;
         }


        .form-group textarea {
            min-height: 150px;
            resize: vertical;
        }

        .form-group .validation-error {
            color: var(--danger-color);
            font-size: 0.9em;
            margin-top: calc(var(--spacing-unit) / 2);
             min-height: 1.2em;
             display: block;
        }

        .form-actions {
            margin-top: calc(var(--spacing-unit) * 3);
            display: flex;
            gap: calc(var(--spacing-unit) * 2);
             flex-wrap: wrap;
        }

        .patient-story-section {
            border: 1px dashed var(--border-color);
            padding: calc(var(--spacing-unit) * 2);
            border-radius: var(--border-radius);
            margin-bottom: calc(var(--spacing-unit) * 3);
        }

        .patient-story-section h4 {
            margin-top: 0;
            margin-bottom: calc(var(--spacing-unit) * 2);
            color: var(--primary-color-dark);
        }

        .consent-status {
            display: inline-flex;
            align-items: center;
            font-weight: 500;
            cursor: pointer;
            transition: opacity var(--transition-speed);
            outline-offset: 2px;
        }

        .consent-status:hover {
            opacity: 0.8;
        }

         .consent-status:focus-visible {
             outline: 2px solid var(--primary-color);
         }


        .consent-status .material-symbols-rounded {
            margin-right: var(--spacing-unit);
        }

        .consent-status.valid {
            color: var(--secondary-color);
        }

        .consent-status.expired {
            color: var(--danger-color);
        }

        .consent-status.missing,
        .consent-status.unknown {
            color: var(--accent-color);
        }

        .consent-status-icon.valid { color: var(--secondary-color); }
        .consent-status-icon.expired { color: var(--danger-color); }
        .consent-status-icon.missing,
        .consent-status-icon.unknown { color: var(--accent-color); }


        .linked-media-list {
            margin-top: var(--spacing-unit);
            margin-bottom: var(--spacing-unit) * 2;
        }

        .linked-media-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-unit);
            margin-bottom: var(--spacing-unit);
            padding: var(--spacing-unit);
            background-color: var(--background-color);
            border-radius: var(--border-radius);
        }

        .linked-media-item span:last-child {
            flex-grow: 1;
        }

        .linked-media-item .remove-media-button {
            padding: calc(var(--spacing-unit) / 2) var(--spacing-unit);
            font-size: 0.8em;
        }


        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity var(--transition-speed) ease-in-out, visibility var(--transition-speed) ease-in-out;
        }

        .modal-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background-color: var(--surface-color);
            padding: calc(var(--spacing-unit) * 3);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            width: 90%;
            max-width: 600px;
            transform: translateY(-20px);
            transition: transform var(--transition-speed) ease-in-out;
             max-height: 90vh;
             overflow-y: auto;
             outline: none;
        }

        .modal-overlay.visible .modal-content {
            transform: translateY(0);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: calc(var(--spacing-unit) * 2);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: var(--spacing-unit);
        }

        .modal-header h3 {
            margin: 0;
            color: var(--text-color-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--text-color-secondary);
            transition: color var(--transition-speed);
             outline-offset: 2px;
        }

         .modal-close:hover {
             color: var(--text-color-primary);
         }

         .modal-close:focus-visible {
             outline: 2px solid var(--primary-color);
         }


        .modal-body {
            margin-bottom: calc(var(--spacing-unit) * 3);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-unit);
             flex-wrap: wrap;
        }

         .modal-media-list {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
             gap: var(--spacing-unit);
             margin-top: var(--spacing-unit);
             max-height: 300px; /* Limit height */
             overflow-y: auto; /* Add scroll */
             padding-right: var(--spacing-unit); /* Space for scrollbar */
         }

         .modal-media-item {
             border: 1px solid var(--border-color);
             border-radius: var(--border-radius);
             overflow: hidden;
             cursor: pointer;
             transition: transform var(--transition-speed), box-shadow var(--transition-speed), border-color var(--transition-speed);
             text-align: center;
             padding: var(--spacing-unit);
             background-color: var(--background-color);
             display: flex;
             flex-direction: column;
             align-items: center;
             justify-content: center;
             gap: var(--spacing-unit);
             outline-offset: 2px;
         }

          .modal-media-item:hover {
              transform: translateY(-2px);
              box-shadow: var(--shadow-subtle);
              border-color: var(--primary-color);
          }

          .modal-media-item:focus-visible {
              outline: 2px solid var(--primary-color);
              transform: translateY(-2px);
              box-shadow: var(--shadow-subtle);
          }


         .modal-media-item.selected {
             border-color: var(--primary-color-dark);
             background-color: #e3f2fd; /* Light blue */
             box-shadow: var(--shadow-medium);
         }

         .modal-media-item img {
             max-width: 100%;
             height: 80px;
             object-fit: cover;
             border-radius: calc(var(--border-radius) / 2);
         }

         .modal-media-item .material-symbols-rounded {
             font-size: 3em;
             color: var(--text-color-secondary);
         }

         .modal-media-item span {
             font-size: 0.9em;
             color: var(--text-color-primary);
             word-break: break-word;
             white-space: normal;
         }


        /* Context Menu */
        .context-menu {
            display: none;
            position: fixed;
            background-color: var(--surface-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            z-index: 1001;
            list-style: none;
            padding: var(--spacing-unit);
            min-width: 150px;
            outline: none;
        }

        .context-menu.visible {
            display: block;
        }

        .context-menu li {
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 2);
            cursor: pointer;
            color: var(--text-color-primary);
            transition: background-color var(--transition-speed);
            border-radius: calc(var(--border-radius) / 2);
             outline-offset: 2px;
        }

        .context-menu li:hover {
            background-color: var(--background-color);
        }

         .context-menu li:focus-visible {
             outline: 2px solid var(--primary-color);
             background-color: var(--background-color);
         }


        /* Data Operations */
        .data-operations {
            margin-top: calc(var(--spacing-unit) * 2);
            margin-bottom: calc(var(--spacing-unit) * 2);
            display: flex;
            gap: calc(var(--spacing-unit) * 2);
            align-items: center;
             flex-wrap: wrap;
        }

        .data-operations label {
             font-weight: 500;
             color: var(--text-color-secondary);
        }

        .data-operations input[type="text"],
         .data-operations select {
            padding: var(--spacing-unit);
            border: 1px solid var(--border-color);
            border-radius: calc(var(--border-radius) / 2);
            font-size: 0.9em;
            color: var(--text-color-primary);
             transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
             outline-offset: 2px;
        }

         .data-operations input[type="text"]:focus,
         .data-operations select:focus {
             border-color: var(--primary-color);
             box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.2);
             outline: none;
         }

         .data-operations input[type="text"]:focus-visible,
         .data-operations select:focus-visible {
             outline: 2px solid var(--primary-color);
             outline-offset: 2px;
         }


        .pagination {
            display: flex;
            justify-content: center;
            margin-top: calc(var(--spacing-unit) * 3);
            gap: var(--spacing-unit);
             flex-wrap: wrap;
        }

        .pagination button {
            padding: var(--spacing-unit) calc(var(--spacing-unit) * 1.5);
            border: 1px solid var(--border-color);
            background-color: var(--surface-color);
            border-radius: calc(var(--border-radius) / 2);
            cursor: pointer;
            transition: background-color var(--transition-speed);
             outline-offset: 2px;
        }

        .pagination button:hover:not(:disabled) {
            background-color: var(--background-color);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

         .pagination button:focus-visible {
             outline: 2px solid var(--primary-color);
         }


        /* Placeholder Sections */
        .calendar-placeholder,
        .resource-library-placeholder,
        .audience-profiles-placeholder {
            background-color: var(--surface-color);
            padding: calc(var(--spacing-unit) * 3);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-subtle);
            text-align: center;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color-secondary);
            font-size: 1.2em;
            flex-direction: column;
            gap: calc(var(--spacing-unit) * 2);
        }

         .placeholder-icon .material-symbols-rounded {
             font-size: 4em;
             color: var(--border-color);
         }

         .placeholder-content {
             max-width: 600px;
         }


        /* Drag and Drop Example (Integrated into Calendar Placeholder) */
        .calendar-placeholder .drag-drop-example {
             margin-top: calc(var(--spacing-unit)*3);
             padding-top: calc(var(--spacing-unit)*3);
             border-top: 1px solid var(--border-color);
             width: 100%;
        }

        .calendar-placeholder .draggable-item {
            background-color: var(--primary-color);
            color: var(--surface-color);
            padding: var(--spacing-unit);
            margin: var(--spacing-unit) auto; /* Center item */
            border-radius: calc(var(--border-radius) / 2);
            cursor: grab;
            width: 120px; /* Wider item */
            text-align: center;
             outline-offset: 2px;
             font-size: 0.9em;
             transition: transform var(--transition-speed);
        }

         .calendar-placeholder .draggable-item:focus-visible {
             outline: 2px solid var(--primary-color-dark);
         }

         .calendar-placeholder .draggable-item:active {
             cursor: grabbing;
             transform: scale(1.05);
         }


        .calendar-placeholder .drop-target {
            background-color: var(--background-color);
            border: 2px dashed var(--border-color);
            padding: calc(var(--spacing-unit) * 3);
            min-height: 150px; /* Taller drop target */
            margin-top: calc(var(--spacing-unit) * 2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color-secondary);
            border-radius: var(--border-radius);
            transition: border-color var(--transition-speed), background-color var(--transition-speed);
             outline-offset: 2px;
             text-align: center;
             font-size: 1em;
        }

         .calendar-placeholder .drop-target.drag-over {
             border-color: var(--primary-color);
             background-color: #e3f2fd; /* Light blue */
         }

         .calendar-placeholder .drop-target:focus-visible {
              outline: 2px solid var(--primary-color);
         }


        /* Accessibility - Visually Hidden */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            margin: -1px;
            padding: 0;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }


         /* Loading Spinner */
         .loading-spinner {
             display: none;
             position: fixed;
             top: 50%;
             left: 50%;
             transform: translate(-50%, -50%);
             z-index: 1002;
             width: 50px;
             height: 50px;
             border: 5px solid rgba(0, 0, 0, 0.1); /* Subtle border */
             border-top: 5px solid var(--primary-color);
             border-radius: 50%;
             animation: spin 1s linear infinite;
         }

         .loading-spinner.visible {
             display: block;
         }

         @keyframes spin {
             0% { transform: translate(-50%, -50%) rotate(0deg); }
             100% { transform: translate(-50%, -50%) rotate(360deg); }
         }

         /* Responsive Adjustments */
        @media (max-width: 1024px) {
             .sidebar {
                 width: 220px; /* Slightly narrower sidebar */
             }

            .main-content {
                padding: calc(var(--spacing-unit) * 2);
            }

            .dashboard-grid {
                gap: calc(var(--spacing-unit) * 2);
            }

             .actions,
             .data-operations,
             .form-actions,
             .pagination {
                 gap: var(--spacing-unit);
             }

             .actions > input[type="text"] {
                 max-width: 100%;
             }
        }

        @media (max-width: 768px) {
            body {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                height: auto;
                flex-direction: row;
                padding: var(--spacing-unit);
                box-shadow: var(--shadow-subtle);
                 overflow-x: auto;
                 white-space: nowrap;
                 justify-content: flex-start;
            }

             .sidebar h2 {
                 display: block;
                 margin-bottom: 0;
                 margin-right: calc(var(--spacing-unit) * 2);
                 font-size: 1.2em;
                 align-self: center;
                 flex-shrink: 0;
             }

            .sidebar nav ul {
                display: flex;
                 gap: var(--spacing-unit);
                 flex-grow: 1;
                 overflow-x: auto;
                 white-space: nowrap;
            }

            .sidebar nav li {
                margin-bottom: 0;
                 flex-shrink: 0;
            }

            .sidebar nav a {
                padding: var(--spacing-unit);
                 flex-direction: column;
                 font-size: 0.8em;
                 text-align: center;
                 min-width: 60px;
                 white-space: normal;
                 height: 100%;
                 justify-content: center;
                 transform: none; /* Disable horizontal transform on mobile */
            }

             .sidebar nav a:hover {
                 transform: none; /* Disable horizontal transform on mobile */
             }

             .sidebar nav a .material-symbols-rounded {
                 margin-right: 0;
                 margin-bottom: calc(var(--spacing-unit) / 2);
             }

             .sidebar nav a span:last-child {
                 display: block;
             }


            .main-content {
                padding: calc(var(--spacing-unit) * 1.5);
            }

            h2 {
                font-size: 1.5em;
                margin-bottom: calc(var(--spacing-unit) * 2);
            }

            .dashboard-grid {
                grid-template-columns: 1fr;
                gap: calc(var(--spacing-unit) * 1.5);
            }

             .actions,
             .data-operations,
             .form-actions,
             .pagination {
                 flex-direction: column;
                 align-items: stretch;
             }

             .actions > input[type="text"],
             .data-operations input[type="text"],
             .data-operations select,
             .button {
                 width: 100%;
                 max-width: none;
             }

             .data-operations label {
                 width: 100%;
             }

             .content-table,
             .content-detail-form,
             .calendar-placeholder,
             .resource-library-placeholder,
             .audience-profiles-placeholder {
                 padding: calc(var(--spacing-unit) * 1.5);
             }

             /* Table adjustments for small screens */
             .content-table thead {
                 display: none;
             }

             .content-table tbody,
             .content-table tr,
             .content-table td {
                 display: block;
                 width: 100%;
             }

             .content-table tr {
                 margin-bottom: var(--spacing-unit);
                 border: 1px solid var(--border-color);
                 border-radius: var(--border-radius);
                 overflow: hidden;
                 box-shadow: var(--shadow-subtle);
             }

             .content-table td {
                 text-align: right;
                 padding-left: 50%;
                 position: relative;
             }

             .content-table td::before {
                 content: attr(data-label);
                 position: absolute;
                 left: calc(var(--spacing-unit) * 1.5);
                 width: calc(50% - var(--spacing-unit) * 3);
                 padding-right: var(--spacing-unit);
                 white-space: nowrap;
                 overflow: hidden;
                 text-overflow: ellipsis;
                 font-weight: 600;
                 color: var(--text-color-primary);
                 text-align: left;
             }

             .modal-content {
                 padding: calc(var(--spacing-unit) * 2);
             }

             .modal-media-list {
                 grid-template-columns: repeat(auto-fit, minmax(100px, 1fr)); /* Smaller grid items on mobile */
             }
        }

    </style>
</head>
<body>

    <aside class="sidebar" aria-label="Main Navigation">
        <h2>Foundation Comms</h2>
        <nav aria-label="Primary">
            <ul>
                <li><a href="#dashboard" class="nav-link active" aria-current="page"><span class="material-symbols-rounded" aria-hidden="true">dashboard</span> Dashboard</a></li>
                <li><a href="#content" class="nav-link"><span class="material-symbols-rounded" aria-hidden="true">article</span> Content Management</a></li>
                <li><a href="#calendar" class="nav-link"><span class="material-symbols-rounded" aria-hidden="true">calendar_month</span> Content Calendar</a></li>
                <li><a href="#resources" class="nav-link"><span class="material-symbols-rounded" aria-hidden="true">library_books</span> Resource Library</a></li>
                <li><a href="#audiences" class="nav-link"><span class="material-symbols-rounded" aria-hidden="true">group</span> Audience Profiles</a></li>
                <li><a href="#privacy" class="nav-link"><span class="material-symbols-rounded" aria-hidden="true">lock</span> Privacy & Consent</a></li>
            </ul>
        </nav>
    </aside>

    <main class="main-content">

        <!-- Dashboard Section -->
        <section id="dashboard" class="section active" aria-labelledby="dashboard-heading" role="region">
            <h2 id="dashboard-heading">Dashboard</h2>
            <div class="dashboard-grid">
                <div class="card interactive" role="region" aria-label="Content Overview Chart">
                    <h3>Content Overview</h3>
                    <p>Summary of content types and statuses.</p>
                    <div class="chart-container" id="contentOverviewChartContainer" role="img" aria-label="Chart showing content distribution by type. Click or press Enter/Space to show chart controls." tabindex="0">
                        <canvas id="contentOverviewChart"></canvas>
                        <div class="floating-controls" id="contentOverviewChartControls" aria-hidden="true" aria-label="Content Overview Chart Controls">
                             <div class="control-group">
                                <label for="contentOverviewChartType">Chart Type</label>
                                <select id="contentOverviewChartType" aria-controls="contentOverviewChart">
                                    <option value="bar">Bar</option>
                                    <option value="pie">Pie</option>
                                    <option value="doughnut">Doughnut</option>
                                </select>
                            </div>
                             <div class="control-group">
                                <label for="contentOverviewFontSize">Font Size</label>
                                <input type="number" id="contentOverviewFontSize" value="12" min="8" max="20" aria-controls="contentOverviewChart">
                            </div>
                        </div>
                    </div>
                </div>
                 <div class="card interactive" role="region" aria-label="Content Output Over Time Chart">
                    <h3>Content Output Over Time</h3>
                    <p>Monthly content creation trends.</p>
                     <div class="chart-container" id="contentOutputChartContainer" role="img" aria-label="Line chart showing content items published or planned over time. Click or press Enter/Space to show chart controls." tabindex="0">
                        <canvas id="contentOutputChart"></canvas>
                         <div class="floating-controls" id="contentOutputChartControls" aria-hidden="true" aria-label="Content Output Over Time Chart Controls">
                             <div class="control-group">
                                <label for="contentOutputChartType">Chart Type</label>
                                <select id="contentOutputChartType" aria-controls="contentOutputChart">
                                    <option value="line">Line</option>
                                    <option value="bar">Bar</option>
                                </select>
                            </div>
                             <div class="control-group">
                                <label for="contentOutputFontSize">Font Size</label>
                                <input type="number" id="contentOutputFontSize" value="12" min="8" max="20" aria-controls="contentOutputChart">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card interactive" role="region" aria-label="Upcoming Deadlines Quick Link" tabindex="0" onclick="navigateTo('#calendar')" onkeydown="if(event.key === 'Enter' || event.key === ' ') navigateTo('#calendar')">
                    <h3>Upcoming Deadlines</h3>
                    <p>View critical dates for planned content.</p>
                    <a href="#calendar" class="button button-secondary" onclick="navigateTo('#calendar'); event.preventDefault();" aria-label="View Content Calendar"><span class="material-symbols-rounded" aria-hidden="true">event</span> View Calendar</a>
                </div>
                 <div class="card interactive" role="region" aria-label="Patient Stories Quick Link" tabindex="0" onclick="navigateTo('#content')" onkeydown="if(event.key === 'Enter' || event.key === ' ') navigateTo('#content')">
                    <h3>Patient Stories</h3>
                    <p>Manage patient stories and consent.</p>
                    <a href="#content" class="button button-secondary" onclick="navigateTo('#content'); event.preventDefault();" aria-label="Manage Patient Stories"><span class="material-symbols-rounded" aria-hidden="true">article</span> Manage Stories</a>
                </div>
            </div>

            <h3>Key Metrics</h3>
            <div class="dashboard-grid" id="dashboard-metrics">
                <div class="card" role="region" aria-label="Total Content Items Metric">
                    <h3>Total Content Items</h3>
                    <p class="metric" id="metric-total-content">0</p>
                    <p>Across all types and statuses.</p>
                </div>
                 <div class="card" role="region" aria-label="Stories with Valid Consent Metric">
                    <h3>Stories with Valid Consent</h3>
                    <p class="metric" id="metric-valid-consent">0</p>
                    <p>Ready for use in content.</p>
                </div>
                 <div class="card" role="region" aria-label="Content in Review Metric">
                    <h3>Content in Review</h3>
                    <p class="metric" id="metric-in-review">0</p>
                    <p>Awaiting approval.</p>
                </div>
                 <div class="card" role="region" aria-label="Content Published Last Month Metric">
                    <h3>Published Last Month</h3>
                    <p class="metric" id="metric-published-last-month">0</p>
                    <p>Content items published.</p>
                </div>
            </div>

        </section>

        <!-- Content Management Section -->
        <section id="content" class="section" aria-labelledby="content-heading" role="region">
            <h2 id="content-heading">Content Management</h2>

            <div id="content-list-view">
                 <div class="actions">
                    <button class="button button-primary" id="add-content-button" aria-label="Add New Content"><span class="material-symbols-rounded" aria-hidden="true">add</span> Add New Content</button>
                     <input type="text" id="content-search" placeholder="Search content..." aria-label="Search content list">
                 </div>

                <div class="data-operations">
                    <label for="filter-status">Filter by Status:</label>
                    <select id="filter-status" aria-label="Filter content by status">
                        <option value="">All</option>
                        <option value="Draft">Draft</option>
                        <option value="Review">Review</option>
                        <option value="Approved">Approved</option>
                        <option value="Published">Published</option>
                    </select>

                    <label for="sort-by">Sort by:</label>
                    <select id="sort-by" aria-label="Sort content by column">
                        <option value="title">Title</option>
                        <option value="date">Date</option>
                        <option value="status">Status</option>
                    </select>

                     <button class="button button-secondary" id="export-data-button" aria-label="Export content data as CSV"><span class="material-symbols-rounded" aria-hidden="true">download</span> Export CSV</button>
                     <input type="file" id="import-data-input" accept=".csv" style="display: none;" aria-label="Select CSV file to import">
                     <button class="button button-secondary" id="import-data-button" aria-label="Import content data from CSV"><span class="material-symbols-rounded" aria-hidden="true">upload</span> Import CSV</button>
                </div>


                <table class="content-table" aria-live="polite" aria-atomic="true" role="grid">
                    <thead>
                        <tr role="row">
                            <th data-sort="title" scope="col" aria-sort="none" tabindex="0">Title</th>
                            <th data-sort="type" scope="col" aria-sort="none" tabindex="0">Type</th>
                            <th data-sort="audience" scope="col" aria-sort="none" tabindex="0">Audience</th>
                            <th data-sort="status" scope="col" aria-sort="none" tabindex="0">Status</th>
                            <th data-sort="date" scope="col" aria-sort="descending" tabindex="0">Date</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Content rows will be populated here by JS -->
                    </tbody>
                </table>
                 <div class="pagination" id="content-pagination" aria-label="Content list pagination">
                    <!-- Pagination buttons here -->
                 </div>
            </div>

            <div id="content-detail-view" class="content-detail-form" style="display: none;">
                <h3 id="content-form-heading">Add/Edit Content</h3>
                <form id="content-form" aria-labelledby="content-form-heading">
                    <input type="hidden" id="content-id">
                    <div class="form-group">
                        <label for="content-title">Title<span aria-hidden="true">*</span></label>
                        <input type="text" id="content-title" required aria-required="true">
                        <div class="validation-error" id="title-error" aria-atomic="true" aria-live="polite"></div>
                    </div>
                    <div class="form-group">
                        <label for="content-type">Type<span aria-hidden="true">*</span></label>
                        <select id="content-type" required aria-required="true">
                            <option value="">Select Type</option>
                            <option value="Patient Story">Patient Story</option>
                            <option value="Medical Innovation">Medical Innovation</option>
                            <option value="Hospital Need">Hospital Need</option>
                            <option value="Event Promo">Event Promo</option>
                            <option value="General Update">General Update</option>
                        </select>
                         <div class="validation-error" id="type-error" aria-atomic="true" aria-live="polite"></div>
                    </div>
                     <div class="form-group">
                        <label for="content-audience">Audience<span aria-hidden="true">*</span></label>
                        <select id="content-audience" required aria-required="true">
                            <option value="">Select Audience</option>
                            <option value="Individual Donors">Individual Donors</option>
                            <option value="Corporate Sponsors">Corporate Sponsors</option>
                            <option value="Healthcare Professionals">Healthcare Professionals</option>
                            <option value="Former Patients/Families">Former Patients/Families</option>
                            <option value="General Public">General Public</option>
                        </select>
                         <div class="validation-error" id="audience-error" aria-atomic="true" aria-live="polite"></div>
                    </div>
                     <div class="form-group">
                        <label for="content-status">Status<span aria-hidden="true">*</span></label>
                        <select id="content-status" required aria-required="true">
                            <option value="Draft">Draft</option>
                            <option value="Review">Review</option>
                            <option value="Approved">Approved</option>
                            <option value="Published">Published</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="content-date">Planned/Publish Date<span aria-hidden="true">*</span></label>
                        <input type="date" id="content-date" required aria-required="true">
                         <div class="validation-error" id="date-error" aria-atomic="true" aria-live="polite"></div>
                    </div>
                    <div class="form-group">
                        <label for="content-body">Content Body</label>
                        <textarea id="content-body" rows="10" aria-label="Content body text"></textarea>
                    </div>

                    <!-- Patient Story Specific Fields -->
                    <div class="patient-story-section" id="patient-story-fields" style="display: none;" role="region" aria-labelledby="patient-story-heading">
                        <h4 id="patient-story-heading">Patient Story Details</h4>
                        <div class="form-group">
                            <label for="patient-id">Anonymized Patient ID</label>
                            <input type="text" id="patient-id" aria-label="Anonymized Patient ID">
                        </div>
                         <div class="form-group">
                            <label for="consent-id">Consent Record ID</label>
                            <input type="text" id="consent-id" aria-label="Consent Record ID">
                             <button type="button" class="button button-secondary" id="check-consent-button" aria-label="Check Consent Status"><span class="material-symbols-rounded" aria-hidden="true">check_circle</span> Check Consent Status</button>
                        </div>
                         <div class="form-group">
                            <label>Consent Status:</label>
                            <div id="consent-status-display" class="consent-status unknown" role="status" aria-live="polite" tabindex="0">
                                <span class="material-symbols-rounded consent-status-icon" aria-hidden="true">help</span>
                                <span>Unknown</span>
                            </div>
                        </div>
                         <div class="form-group">
                            <label for="patient-quote">Key Quote</label>
                            <textarea id="patient-quote" rows="3" aria-label="Key quote from patient story"></textarea>
                        </div>
                         <div class="form-group">
                            <label>Linked Media</label>
                            <div id="linked-media-list" class="linked-media-list" aria-label="Linked media items">
                                <!-- Linked media items here -->
                                <p style="font-size:0.9em; color: var(--text-color-secondary);">No media linked yet.</p>
                            </div>
                             <button type="button" class="button button-secondary" id="link-media-button" aria-label="Link Media Resources"><span class="material-symbols-rounded" aria-hidden="true">add_photo_alternate</span> Link Media</button>
                        </div>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="button button-primary" aria-label="Save Content"><span class="material-symbols-rounded" aria-hidden="true">save</span> Save Content</button>
                        <button type="button" class="button button-secondary" id="cancel-edit-button" aria-label="Cancel Editing"><span class="material-symbols-rounded" aria-hidden="true">cancel</span> Cancel</button>
                    </div>
                </form>
            </div>
        </section>

        <!-- Content Calendar Section -->
        <section id="calendar" class="section" aria-labelledby="calendar-heading" role="region">
            <h2 id="calendar-heading">Content Calendar</h2>
            <div class="calendar-placeholder" role="region" aria-label="Content calendar placeholder">
                 <span class="material-symbols-rounded placeholder-icon" aria-hidden="true">calendar_month</span>
                <div class="placeholder-content">
                    <p>This section will feature a visual content calendar with drag-and-drop functionality for scheduling and rescheduling content items.</p>
                    <p style="font-size:0.9em; color: var(--text-color-secondary); margin-top: var(--spacing-unit);">Planned features include month/week/day views, color-coded entries by type or status, and direct links to content detail views.</p>
                </div>

             <!-- Simple Drag and Drop Example -->
            <div class="drag-drop-example">
                <h4>Drag & Drop Concept Example</h4>
                <p style="font-size:0.9em; color: var(--text-color-secondary);">Drag the item below onto the target area to see a basic drag-and-drop interaction.</p>
                <div class="draggable-item" draggable="true" aria-grabbed="false" tabindex="0">Content Item</div>
                <div class="drop-target" aria-dropeffect="move" tabindex="0" aria-label="Drop target for content items">Drop Area (e.g., a calendar day)</div>
            </div>
            </div>
        </section>

        <!-- Resource Library Section -->
        <section id="resources" class="section" aria-labelledby="resources-heading" role="region">
            <h2 id="resources-heading">Resource Library</h2>
            <div class="resource-library-placeholder" role="region" aria-label="Resource library placeholder">
                 <span class="material-symbols-rounded placeholder-icon" aria-hidden="true">library_books</span>
                <div class="placeholder-content">
                    <p>This section will provide a searchable and filterable library of approved resources, such as images, videos, documents, and contact information.</p>
                    <p style="font-size:0.9em; color: var(--text-color-secondary); margin-top: var(--spacing-unit);">Resources can be linked directly to content items, especially patient stories.</p>
                </div>
                 <button class="button button-secondary" aria-label="Browse Resources"><span class="material-symbols-rounded" aria-hidden="true">search</span> Browse Resources</button>
                 <button class="button button-secondary" aria-label="Upload New Resource"><span class="material-symbols-rounded" aria-hidden="true">upload</span> Upload Resource</button>
            </div>
        </section>

        <!-- Audience Profiles Section -->
        <section id="audiences" class="section" aria-labelledby="audiences-heading" role="region">
            <h2 id="audiences-heading">Audience Profiles</h2>
            <div class="audience-profiles-placeholder" role="region" aria-label="Audience profiles placeholder">
                 <span class="material-symbols-rounded placeholder-icon" aria-hidden="true">group</span>
                <div class="placeholder-content">
                    <p>This section will contain detailed profiles for each audience segment, including their demographics, interests, preferred communication channels, and tailored messaging strategies.</p>
                    <p style="font-size:0.9em; color: var(--text-color-secondary); margin-top: var(--spacing-unit);">Understanding our audiences helps tailor content for maximum impact and engagement.</p>
                </div>
                 <button class="button button-secondary" aria-label="View Audience Segments"><span class="material-symbols-rounded" aria-hidden="true">visibility</span> View Segments</button>
            </div>
        </section>

         <!-- Privacy & Consent Section -->
        <section id="privacy" class="section" aria-labelledby="privacy-heading" role="region">
            <h2 id="privacy-heading">Privacy & Consent Management</h2>
             <div class="card" role="region" aria-label="Consent Records Management">
                 <h3>Consent Records</h3>
                 <p>Manage patient and family consent forms and expiration dates. Ensure all content using patient data has valid, documented consent.</p>
                 <div class="actions" style="margin-top: var(--spacing-unit);">
                    <button class="button button-primary" aria-label="Add New Consent Record"><span class="material-symbols-rounded" aria-hidden="true">add</span> Add New Record</button>
                    <button class="button button-secondary" aria-label="Search Consent Records"><span class="material-symbols-rounded" aria-hidden="true">search</span> Search Records</button>
                 </div>
             </div>
             <div class="card" style="margin-top: calc(var(--spacing-unit)*3);" role="region" aria-label="Data Usage Policies">
                 <h3>Data Usage Policies</h3>
                 <p>Review and link to internal data privacy policies and guidelines for content creation.</p>
                  <div class="actions" style="margin-top: var(--spacing-unit);">
                    <button class="button button-secondary" aria-label="View Data Usage Policies"><span class="material-symbols-rounded" aria-hidden="true">policy</span> View Policies</button>
                  </div>
             </div>
        </section>

    </main>

    <!-- Modal Overlay -->
    <div id="app-modal" class="modal-overlay" role="dialog" aria-modal="true" aria-labelledby="modal-title">
        <div class="modal-content" tabindex="-1">
            <div class="modal-header">
                <h3 id="modal-title">Modal Title</h3>
                <button class="modal-close" aria-label="Close modal">&times;</button>
            </div>
            <div class="modal-body" id="modal-body">
                <!-- Modal content goes here -->
                <p>This is a generic modal body.</p>
            </div>
            <div class="modal-footer">
                <button class="button button-secondary modal-cancel" aria-label="Cancel">Cancel</button>
                <button class="button button-primary modal-confirm" aria-label="Confirm">OK</button>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <ul id="context-menu" class="context-menu" role="menu" tabindex="-1">
        <li data-action="edit" role="menuitem" tabindex="-1">Edit</li>
        <li data-action="duplicate" role="menuitem" tabindex="-1">Duplicate</li>
        <li data-action="delete" role="menuitem" tabindex="-1">Delete</li>
    </ul>

    <!-- Loading Spinner -->
    <div id="loading-spinner" class="loading-spinner" role="status" aria-label="Loading...">
        <span class="visually-hidden">Loading...</span>
    </div>


    <script type="module">
        import { Chart } from "https://esm.sh/chart.js/auto";

        // --- State Management ---
        let currentSection = '#dashboard';
        let contentData = []; // Initialize as empty, will load from local storage
        let filteredContent = [];
        let sortColumn = 'date';
        let sortDirection = 'desc'; // 'asc' or 'desc'
        let currentPage = 1;
        const rowsPerPage = 5;
        let currentLinkedMedia = []; // State for media linked to the current content item


        // --- DOM Elements ---
        const navLinks = document.querySelectorAll('.nav-link');
        const sections = document.querySelectorAll('.section');
        const contentListView = document.getElementById('content-list-view');
        const contentDetailView = document.getElementById('content-detail-view');
        const addContentButton = document.getElementById('add-content-button');
        const contentForm = document.getElementById('content-form');
        const cancelEditButton = document.getElementById('cancel-edit-button');
        const patientStoryFields = document.getElementById('patient-story-fields');
        const contentTypeSelect = document.getElementById('content-type');
        const checkConsentButton = document.getElementById('check-consent-button');
        const consentStatusDisplay = document.getElementById('consent-status-display');
        const contentTableBody = document.querySelector('.content-table tbody');
        const contentTableHeaders = document.querySelectorAll('.content-table th[data-sort]');
        const filterStatusSelect = document.getElementById('filter-status');
        const sortBySelect = document.getElementById('sort-by');
        const contentSearchInput = document.getElementById('content-search');
        const contentPagination = document.getElementById('content-pagination');
        const linkedMediaList = document.getElementById('linked-media-list');
        const linkMediaButton = document.getElementById('link-media-button');

        // Dashboard Metrics
        const metricTotalContent = document.getElementById('metric-total-content');
        const metricValidConsent = document.getElementById('metric-valid-consent');
        const metricInReview = document.getElementById('metric-in-review');
        const metricPublishedLastMonth = document.getElementById('metric-published-last-month');


        const modalOverlay = document.getElementById('app-modal');
        const modalContent = modalOverlay.querySelector('.modal-content');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCloseButton = modalOverlay.querySelector('.modal-close');
        const modalCancelButton = modalOverlay.querySelector('.modal-cancel');
        const modalConfirmButton = modalOverlay.querySelector('.modal-confirm');

        const contextMenu = document.getElementById('context-menu');
        const loadingSpinner = document.getElementById('loading-spinner');

        const exportDataButton = document.getElementById('export-data-button');
        const importDataButton = document.getElementById('import-data-button');
        const importDataInput = document.getElementById('import-data-input');

        // --- Utility Functions ---
        function showSpinner() { loadingSpinner.classList.add('visible'); }
        function hideSpinner() { loadingSpinner.classList.remove('visible'); }

         function varCss(name) {
             return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
         }


        // --- Navigation ---
        function navigateTo(sectionId, pushState = true) {
            const activeSection = document.querySelector('.section.active');
            if (activeSection) {
                 activeSection.classList.remove('active');
                 activeSection.setAttribute('aria-hidden', 'true');
            }

            const targetSection = document.querySelector(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
                targetSection.setAttribute('aria-hidden', 'false');
                currentSection = sectionId;

                navLinks.forEach(link => {
                    link.classList.remove('active');
                    link.removeAttribute('aria-current');
                });
                const activeNavLink = document.querySelector(`.nav-link[href="${sectionId}"]`);
                if (activeNavLink) {
                    activeNavLink.classList.add('active');
                    activeNavLink.setAttribute('aria-current', 'page');
                }

                 if (pushState) {
                    history.pushState(null, '', sectionId);
                 } else {
                     history.replaceState(null, '', sectionId);
                 }

                if (sectionId === '#content') {
                    renderContentTable();
                    showListView();
                } else if (sectionId === '#dashboard') {
                    updateDashboardMetrics();
                    renderDashboardCharts();
                }
            }

            hideContextMenu();
        }

        navLinks.forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const sectionId = link.getAttribute('href');
                navigateTo(sectionId);
            });
        });

        window.addEventListener('popstate', () => {
             const sectionId = window.location.hash || '#dashboard';
             navigateTo(sectionId, false);
        });

        if (window.location.hash && document.querySelector(window.location.hash)) {
             navigateTo(window.location.hash, false);
        } else {
             navigateTo(currentSection, false);
        }


        // --- Dashboard Metrics ---
        function updateDashboardMetrics() {
            const totalContent = contentData.length;
            const validConsentStories = contentData.filter(item => item.type === 'Patient Story' && item.consentStatus === 'Valid').length;
            const contentInReview = contentData.filter(item => item.status === 'Review').length;

            const now = new Date();
            const lastMonth = new Date(now.getFullYear(), now.getMonth() - 1, 1);
            const thisMonth = new Date(now.getFullYear(), now.getMonth(), 1);

            const publishedLastMonth = contentData.filter(item => {
                if (item.status === 'Published' && item.date) {
                    const publishDate = new Date(item.date);
                    return publishDate >= lastMonth && publishDate < thisMonth;
                }
                return false;
            }).length;


            metricTotalContent.textContent = totalContent;
            metricValidConsent.textContent = validConsentStories;
            metricInReview.textContent = contentInReview;
            metricPublishedLastMonth.textContent = publishedLastMonth;
        }


        // --- Content Management ---

        function showListView() {
            contentListView.style.display = 'block';
            contentDetailView.style.display = 'none';
             setTimeout(() => {
                 document.querySelector('#content-heading').focus();
             }, 100);
        }

        function showDetailView(contentItem = {}) {
            contentListView.style.display = 'none';
            contentDetailView.style.display = 'block';

            document.getElementById('content-id').value = contentItem.id || '';
            document.getElementById('content-title').value = contentItem.title || '';
            document.getElementById('content-type').value = contentItem.type || '';
            document.getElementById('content-audience').value = contentItem.audience || '';
            document.getElementById('content-status').value = contentItem.status || 'Draft';
            document.getElementById('content-date').value = contentItem.date || '';
            document.getElementById('content-body').value = contentItem.body || '';

            document.getElementById('content-form-heading').textContent = contentItem.id ? 'Edit Content' : 'Add New Content';

            const isPatientStory = contentItem.type === 'Patient Story';
            if (isPatientStory) {
                patientStoryFields.style.display = 'block';
                document.getElementById('patient-id').value = contentItem.patientId || '';
                document.getElementById('consent-id').value = contentItem.consentId || '';
                document.getElementById('patient-quote').value = contentItem.quote || '';
                updateConsentStatusDisplay(contentItem.consentStatus || 'Unknown');
                currentLinkedMedia = [...(contentItem.media || [])]; // Load linked media into state
                renderLinkedMedia(currentLinkedMedia);
            } else {
                patientStoryFields.style.display = 'none';
                document.getElementById('patient-id').value = '';
                document.getElementById('consent-id').value = '';
                document.getElementById('patient-quote').value = '';
                updateConsentStatusDisplay('Unknown');
                currentLinkedMedia = []; // Clear linked media state
                renderLinkedMedia(currentLinkedMedia);
            }

            document.querySelectorAll('.validation-error').forEach(el => el.textContent = '');
             document.querySelectorAll('.form-group input, .form-group select, .form-group textarea').forEach(el => {
                 el.classList.remove('invalid');
                 el.removeAttribute('aria-invalid');
                 el.removeAttribute('aria-describedby');
             });

             setTimeout(() => {
                 document.getElementById('content-title').focus();
             }, 100);
        }

        function updateConsentStatusDisplay(status) {
            consentStatusDisplay.className = 'consent-status';
            const icon = consentStatusDisplay.querySelector('.material-symbols-rounded');
            const text = consentStatusDisplay.querySelector('span:last-child');

            const lowerStatus = status.toLowerCase().replace(' ', '-');
            consentStatusDisplay.classList.add(lowerStatus);
            icon.classList.remove('valid', 'expired', 'missing', 'unknown');
            icon.classList.add(lowerStatus);
            consentStatusDisplay.setAttribute('aria-label', `Consent Status: ${status}. Click for details.`);


            switch (status) {
                case 'Valid':
                    icon.textContent = 'check_circle';
                    text.textContent = 'Consent Valid';
                    break;
                case 'Expired':
                    icon.textContent = 'warning';
                    text.textContent = 'Consent Expired';
                    break;
                case 'Missing':
                    icon.textContent = 'help';
                    text.textContent = 'Consent Missing';
                    break;
                 default:
                     icon.textContent = 'help';
                     text.textContent = 'Unknown';
                     consentStatusDisplay.classList.add('unknown');
                     icon.classList.add('unknown');
                    break;
            }
        }

        function renderLinkedMedia(mediaItems) {
            linkedMediaList.innerHTML = '';
            if (!mediaItems || mediaItems.length === 0) {
                 linkedMediaList.innerHTML = `<p style="font-size:0.9em; color: ${varCss('--text-color-secondary')};">No media linked yet.</p>`;
                 return;
            }
            mediaItems.forEach(media => {
                const mediaEl = document.createElement('div');
                mediaEl.classList.add('linked-media-item');
                mediaEl.dataset.id = media.id; // Store media ID
                mediaEl.setAttribute('aria-label', `Linked media: ${media.name}`);
                mediaEl.innerHTML = `
                    <span class="material-symbols-rounded" aria-hidden="true">${media.type === 'image' ? 'image' : 'attachment'}</span>
                    <span>${media.name}</span>
                    <button type="button" class="button button-secondary remove-media-button" style="padding: ${parseInt(varCss('--spacing-unit'))/2}px ${parseInt(varCss('--spacing-unit'))}px; font-size: 0.8em;" aria-label="Remove linked media ${media.name}"><span class="material-symbols-rounded" aria-hidden="true">close</span></button>
                `;
                linkedMediaList.appendChild(mediaEl);
            });
        }

        // Add event listener for removing linked media using event delegation
        linkedMediaList.addEventListener('click', (e) => {
            const removeButton = e.target.closest('.remove-media-button');
            if (removeButton) {
                const itemElement = removeButton.closest('.linked-media-item');
                if (itemElement) {
                    const mediaIdToRemove = parseInt(itemElement.dataset.id);
                    currentLinkedMedia = currentLinkedMedia.filter(media => media.id !== mediaIdToRemove);
                    renderLinkedMedia(currentLinkedMedia); // Re-render the list
                     // Announce removal for screen readers
                     const itemName = itemElement.querySelector('span:last-child').textContent;
                     announce(`Removed linked media: ${itemName}`);
                }
            }
        });


        addContentButton.addEventListener('click', () => {
            showDetailView({});
        });

        cancelEditButton.addEventListener('click', () => {
            showListView();
        });

        contentTypeSelect.addEventListener('change', (e) => {
            const isPatientStory = e.target.value === 'Patient Story';
            if (isPatientStory) {
                patientStoryFields.style.display = 'block';
                 updateConsentStatusDisplay('Unknown');
                 currentLinkedMedia = []; // Clear linked media state on type change
                 renderLinkedMedia(currentLinkedMedia);
            } else {
                patientStoryFields.style.display = 'none';
                document.getElementById('patient-id').value = '';
                document.getElementById('consent-id').value = '';
                document.getElementById('patient-quote').value = '';
                updateConsentStatusDisplay('Unknown');
                currentLinkedMedia = [];
                renderLinkedMedia(currentLinkedMedia);
            }
        });

        checkConsentButton.addEventListener('click', () => {
            const consentId = document.getElementById('consent-id').value.trim();
            if (!consentId) {
                updateConsentStatusDisplay('Missing');
                showModal('Consent Check', '<p>Please enter a Consent Record ID to check status.</p>', false);
                return;
            }

            showSpinner();
            setTimeout(() => {
                let status = 'Missing';
                let details = 'No record found for this ID.';
                if (consentId === 'C-VALID') {
                    status = 'Valid';
                    details = 'Consent is valid until 2025-12-31. Covers photos, videos, and quotes.';
                } else if (consentId === 'C-EXPIRED') {
                    status = 'Expired';
                    details = 'Consent expired on 2023-01-15. Usage requires renewal.';
                } else {
                     details = 'No record found for this ID. Please verify or add a new consent record.';
                }

                updateConsentStatusDisplay(status);
                hideSpinner();
                showModal('Consent Check Result', `<p>Consent Record ID "${consentId}" status: <strong>${status}</strong></p><p>${details}</p>`, false);
            }, 1000);
        });

        consentStatusDisplay.addEventListener('click', () => {
             const statusText = consentStatusDisplay.querySelector('span:last-child').textContent;
             const consentId = document.getElementById('consent-id').value.trim();
             let details = 'Details not available.';
             let title = 'Consent Details';

             if (consentId) {
                 title = `Consent Details for ID: ${consentId}`;
                 if (statusText === 'Consent Valid') {
                     details = 'Consent is valid until 2025-12-31. Covers photos, videos, and quotes.';
                 } else if (statusText === 'Consent Expired') {
                     details = 'Consent expired on 2023-01-15. Usage requires renewal.';
                 } else if (statusText === 'Consent Missing') {
                     details = 'No Consent Record ID provided or found. Please enter or verify the ID.';
                 } else { // Unknown
                      details = 'Status is currently unknown. Please check the Consent Record ID.';
                 }
                 showModal(title, `<p>Status: <strong>${statusText.replace('Consent ', '')}</strong></p><p>${details}</p>`, false);
             } else {
                 showModal(title, '<p>No Consent Record ID provided.</p><p>Status: <strong>Missing</strong></p>', false);
             }
        });

         consentStatusDisplay.addEventListener('keydown', (e) => {
             if (e.key === 'Enter' || e.key === ' ') {
                 e.preventDefault();
                 consentStatusDisplay.click();
             }
         });


        // Simulated Media Library Data
        const simulatedMediaLibrary = [
            { id: 101, name: 'Patient Photo 1', type: 'image', url: 'https://placehold.co/100x80?text=Photo+1' },
            { id: 102, name: 'Patient Video Clip', type: 'video', url: 'https://placehold.co/100x80?text=Video+Clip' },
            { id: 103, name: 'Hospital Exterior', type: 'image', url: 'https://placehold.co/100x80?text=Hospital' },
            { id: 104, name: 'Doctor Interview', type: 'video', url: 'https://placehold.co/100x80?text=Interview' },
            { id: 105, name: 'Playroom Photo', type: 'image', url: 'https://placehold.co/100x80?text=Playroom' },
            { id: 106, name: 'Research Paper PDF', type: 'document', url: null }, // No preview for document
            { id: 107, name: 'Patient Photo 2', type: 'image', url: 'https://placehold.co/100x80?text=Photo+2' },
        ];

        linkMediaButton.addEventListener('click', () => {
            showModal('Link Media Resources', '', true); // Show OK/Cancel buttons
             modalBody.innerHTML = `
                <p>Select media items to link to this content:</p>
                <div class="modal-media-list" role="listbox" aria-label="Select media items">
                    <!-- Media items will be loaded here -->
                </div>
             `;
             renderMediaLibraryInModal(simulatedMediaLibrary);

             // Override confirm button to handle linking
             modalConfirmButton.onclick = () => {
                 const selectedItems = Array.from(modalBody.querySelectorAll('.modal-media-item.selected')).map(itemEl => {
                     const id = parseInt(itemEl.dataset.id);
                     return simulatedMediaLibrary.find(media => media.id === id);
                 }).filter(item => item); // Filter out any potential undefined

                 // Add selected items to currentLinkedMedia, avoiding duplicates
                 selectedItems.forEach(selectedItem => {
                     if (!currentLinkedMedia.some(linkedItem => linkedItem.id === selectedItem.id)) {
                         currentLinkedMedia.push(selectedItem);
                     }
                 });

                 renderLinkedMedia(currentLinkedMedia); // Update the linked media list in the form
                 hideModal();
                 announce(`${selectedItems.length} media item(s) linked.`);
             };
        });

        function renderMediaLibraryInModal(mediaItems) {
            const mediaListEl = modalBody.querySelector('.modal-media-list');
            if (!mediaListEl) return;

            mediaListEl.innerHTML = ''; // Clear current list

            if (mediaItems.length === 0) {
                mediaListEl.innerHTML = `<p style="text-align:center; color: ${varCss('--text-color-secondary')};">No media items available.</p>`;
                return;
            }

            mediaItems.forEach(media => {
                const itemEl = document.createElement('div');
                itemEl.classList.add('modal-media-item');
                itemEl.dataset.id = media.id;
                itemEl.setAttribute('role', 'option');
                itemEl.setAttribute('aria-selected', 'false');
                itemEl.setAttribute('tabindex', '0'); // Make selectable items focusable
                itemEl.setAttribute('aria-label', `Media item: ${media.name}, Type: ${media.type}. Press Enter or Space to select.`);


                let previewHtml = '';
                if (media.type === 'image' && media.url) {
                    previewHtml = `<img src="${media.url}" alt="${media.name} preview">`;
                } else if (media.type === 'video') {
                    previewHtml = `<span class="material-symbols-rounded" aria-hidden="true">videocam</span>`;
                } else {
                    previewHtml = `<span class="material-symbols-rounded" aria-hidden="true">attachment</span>`;
                }

                itemEl.innerHTML = `
                    ${previewHtml}
                    <span>${media.name}</span>
                `;

                 // Check if this item is already linked and mark as selected
                 if (currentLinkedMedia.some(linkedItem => linkedItem.id === media.id)) {
                     itemEl.classList.add('selected');
                     itemEl.setAttribute('aria-selected', 'true');
                 }


                itemEl.addEventListener('click', () => {
                    itemEl.classList.toggle('selected');
                     const isSelected = itemEl.classList.contains('selected');
                     itemEl.setAttribute('aria-selected', isSelected);
                     // Announce selection change
                     announce(`${media.name} ${isSelected ? 'selected' : 'deselected'}.`);
                });

                 // Add keyboard selection
                 itemEl.addEventListener('keydown', (e) => {
                     if (e.key === 'Enter' || e.key === ' ') {
                         e.preventDefault();
                         itemEl.click(); // Trigger click for selection toggle
                     } else if (e.key === 'ArrowRight' || e.key === 'ArrowLeft' || e.key === 'ArrowDown' || e.key === 'ArrowUp') {
                          // Basic grid navigation (can be improved)
                          e.preventDefault();
                          const items = Array.from(mediaListEl.querySelectorAll('.modal-media-item'));
                          const currentIndex = items.indexOf(itemEl);
                          let nextIndex = -1;

                          if (e.key === 'ArrowRight') nextIndex = currentIndex + 1;
                          if (e.key === 'ArrowLeft') nextIndex = currentIndex - 1;
                          // Simple row navigation assuming roughly 3 items per row on desktop
                          if (e.key === 'ArrowDown') nextIndex = currentIndex + 3;
                          if (e.key === 'ArrowUp') nextIndex = currentIndex - 3;

                          if (nextIndex >= 0 && nextIndex < items.length) {
                              items[nextIndex].focus();
                          }
                     }
                 });

                mediaListEl.appendChild(itemEl);
            });
        }


        contentForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (!validateContentForm()) {
                showModal('Validation Error', '<p>Please fill in all required fields.</p>', false);
                return;
            }

            showSpinner();

            const id = document.getElementById('content-id').value;
            const title = document.getElementById('content-title').value;
            const type = document.getElementById('content-type').value;
            const audience = document.getElementById('content-audience').value;
            const status = document.getElementById('content-status').value;
            const date = document.getElementById('content-date').value;
            const body = document.getElementById('content-body').value;

            const contentItem = {
                id: id ? parseInt(id) : Date.now(),
                title,
                type,
                audience,
                status,
                date,
                body,
            };

            if (type === 'Patient Story') {
                contentItem.patientId = document.getElementById('patient-id').value;
                contentItem.consentId = document.getElementById('consent-id').value;
                contentItem.consentStatus = consentStatusDisplay.querySelector('span:last-child').textContent.replace('Consent ', '');
                 contentItem.quote = document.getElementById('patient-quote').value;
                 contentItem.media = [...currentLinkedMedia]; // Save the linked media from state
            }

            setTimeout(() => {
                if (id) {
                    const index = contentData.findIndex(item => item.id === parseInt(id));
                    if (index > -1) {
                        contentData[index] = contentItem;
                    }
                     showModal('Content Saved', `<p>Content "${title}" updated successfully!</p>`, false);
                } else {
                    contentData.push(contentItem);
                     showModal('Content Saved', `<p>Content "${title}" added successfully!</p>`, false);
                }

                saveContentData();
                applyFiltersAndSort();
                renderContentTable();
                updateDashboardMetrics();
                showListView();
                hideSpinner();
            }, 1000);
        });

        function validateContentForm() {
            let isValid = true;
            const requiredFields = ['content-title', 'content-type', 'content-audience', 'content-date'];
            requiredFields.forEach(fieldId => {
                const input = document.getElementById(fieldId);
                const errorDiv = document.getElementById(fieldId.replace('content-', '') + '-error');
                if (!input.value.trim()) {
                    input.classList.add('invalid');
                    errorDiv.textContent = 'This field is required.';
                    input.setAttribute('aria-invalid', 'true');
                    input.setAttribute('aria-describedby', errorDiv.id);
                    isValid = false;
                } else {
                    input.classList.remove('invalid');
                    errorDiv.textContent = '';
                    input.removeAttribute('aria-invalid');
                    input.removeAttribute('aria-describedby');
                }
            });
            return isValid;
        }

        // --- Content Table Rendering, Filtering, Sorting, Pagination ---

        function renderContentTable() {
            contentTableBody.innerHTML = '';
             const start = (currentPage - 1) * rowsPerPage;
             const end = start + rowsPerPage;
             const paginatedData = filteredContent.slice(start, end);

            if (paginatedData.length === 0) {
                 contentTableBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">No content found.</td></tr>`;
                 renderPagination(0);
                 return;
            }

            paginatedData.forEach(item => {
                const row = document.createElement('tr');
                row.dataset.id = item.id;
                 row.setAttribute('role', 'row');
                 row.setAttribute('tabindex', '0');
                 row.setAttribute('aria-label', `Content item: ${item.title}, Type: ${item.type}, Audience: ${item.audience}, Status: ${item.status}, Date: ${item.date}. Press Enter to edit.`);

                row.innerHTML = `
                    <td data-label="Title" role="cell">${item.title}</td>
                    <td data-label="Type" role="cell">${item.type}</td>
                    <td data-label="Audience" role="cell">${item.audience}</td>
                    <td data-label="Status" role="cell"><span class="status-indicator ${item.status.toLowerCase()}">${item.status}</span></td>
                    <td data-label="Date" role="cell">${item.date}</td>
                `;
                contentTableBody.appendChild(row);
            });

             renderPagination(filteredContent.length);

             contentTableHeaders.forEach(th => {
                 if (th.dataset.sort === sortColumn) {
                     th.setAttribute('aria-sort', sortDirection === 'asc' ? 'ascending' : 'descending');
                 } else {
                     th.setAttribute('aria-sort', 'none');
                 }
             });
        }

        function applyFiltersAndSort() {
            const searchTerm = contentSearchInput.value.toLowerCase();
            const filterStatus = filterStatusSelect.value;

            filteredContent = contentData.filter(item => {
                const matchesSearch = item.title.toLowerCase().includes(searchTerm) ||
                                      item.type.toLowerCase().includes(searchTerm) ||
                                      item.audience.toLowerCase().includes(searchTerm) ||
                                      item.status.toLowerCase().includes(searchTerm) ||
                                      (item.body || '').toLowerCase().includes(searchTerm) ||
                                      (item.patientId || '').toLowerCase().includes(searchTerm) ||
                                      (item.consentId || '').toLowerCase().includes(searchTerm) ||
                                      (item.quote || '').toLowerCase().includes(searchTerm);


                const matchesStatus = filterStatus === '' || item.status === filterStatus;

                return matchesSearch && matchesStatus;
            });

            const sortKey = sortBySelect.value;
            filteredContent.sort((a, b) => {
                const aValue = a[sortKey] || '';
                const bValue = b[sortKey] || '';

                if (aValue < bValue) return sortDirection === 'asc' ? -1 : 1;
                if (aValue > bValue) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });

             currentPage = 1;
        }

        function renderPagination(totalItems) {
            const totalPages = Math.ceil(totalItems / rowsPerPage);
            contentPagination.innerHTML = '';

            if (totalPages <= 1) return;

            const prevButton = document.createElement('button');
            prevButton.textContent = 'Prev';
            prevButton.disabled = currentPage === 1;
            prevButton.setAttribute('aria-label', 'Previous page');
            prevButton.addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderContentTable();
                }
            });
            contentPagination.appendChild(prevButton);

            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);

            if (startPage > 1) {
                 const firstButton = document.createElement('button');
                 firstButton.textContent = 1;
                 firstButton.setAttribute('aria-label', 'Page 1');
                 firstButton.addEventListener('click', () => { currentPage = 1; renderContentTable(); });
                 contentPagination.appendChild(firstButton);
                 if (startPage > 2) {
                     const ellipsis = document.createElement('span');
                     ellipsis.textContent = '...';
                     ellipsis.style.margin = `0 ${varCss('--spacing-unit')}px`;
                     contentPagination.appendChild(ellipsis);
                 }
            }


            for (let i = startPage; i <= endPage; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.setAttribute('aria-label', `Page ${i}`);
                if (i === currentPage) {
                    pageButton.disabled = true;
                    pageButton.setAttribute('aria-current', 'page');
                } else {
                     pageButton.removeAttribute('aria-current');
                }
                pageButton.addEventListener('click', () => {
                    currentPage = i;
                    renderContentTable();
                });
                contentPagination.appendChild(pageButton);
            }

            if (endPage < totalPages) {
                 if (endPage < totalPages - 1) {
                     const ellipsis = document.createElement('span');
                     ellipsis.textContent = '...';
                     ellipsis.style.margin = `0 ${varCss('--spacing-unit')}px`;
                     contentPagination.appendChild(ellipsis);
                 }
                 const lastButton = document.createElement('button');
                 lastButton.textContent = totalPages;
                 lastButton.setAttribute('aria-label', `Page ${totalPages}`);
                 lastButton.addEventListener('click', () => { currentPage = totalPages; renderContentTable(); });
                 contentPagination.appendChild(lastButton);
            }


            const nextButton = document.createElement('button');
            nextButton.textContent = 'Next';
            nextButton.disabled = currentPage === totalPages;
             nextButton.setAttribute('aria-label', 'Next page');
             nextButton.addEventListener('click', () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    renderContentTable();
                }
            });
            contentPagination.appendChild(nextButton);
        }


        filterStatusSelect.addEventListener('change', () => {
            applyFiltersAndSort();
            renderContentTable();
        });

        sortBySelect.addEventListener('change', () => {
            applyFiltersAndSort();
            renderContentTable();
        });

        contentSearchInput.addEventListener('input', () => {
            applyFiltersAndSort();
            renderContentTable();
        });

        contentTableHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const column = header.dataset.sort;
                if (sortColumn === column) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = column;
                    sortDirection = 'asc';
                }
                applyFiltersAndSort();
                renderContentTable();
            });
             header.addEventListener('keydown', (e) => {
                 if (e.key === 'Enter' || e.key === ' ') {
                     e.preventDefault();
                     header.click();
                 }
             });
        });

        contentTableBody.addEventListener('click', (e) => {
            const row = e.target.closest('tr');
            if (row && row.dataset.id) {
                const id = parseInt(row.dataset.id);
                const itemToEdit = contentData.find(item => item.id === id);
                if (itemToEdit) {
                    showDetailView(itemToEdit);
                }
            }
        });

        contentTableBody.addEventListener('keydown', (e) => {
             const row = e.target.closest('tr');
             if (row && row.dataset.id) {
                 if (e.key === 'Enter' || e.key === ' ') {
                     e.preventDefault();
                     const id = parseInt(row.dataset.id);
                     const itemToEdit = contentData.find(item => item.id === id);
                     if (itemToEdit) {
                         showDetailView(itemToEdit);
                     }
                 } else if (e.key === 'ArrowDown') {
                     e.preventDefault();
                     const nextRow = row.nextElementSibling;
                     if (nextRow) nextRow.focus();
                 } else if (e.key === 'ArrowUp') {
                     e.preventDefault();
                     const prevRow = row.previousElementSibling;
                     if (prevRow) prevRow.focus();
                 }
             }
        });


        // --- Data Persistence (Local Storage) ---
        function saveContentData() {
            localStorage.setItem('foundationContentData', JSON.stringify(contentData));
        }

        function loadContentData() {
            const savedData = localStorage.getItem('foundationContentData');
            if (savedData) {
                try {
                    contentData = JSON.parse(savedData);
                    contentData.forEach(item => {
                        if (typeof item.id === 'string') {
                            item.id = parseInt(item.id) || item.id;
                        }
                         // Ensure media is an array
                         if (item.type === 'Patient Story' && !Array.isArray(item.media)) {
                             item.media = [];
                         }
                    });
                } catch (e) {
                    console.error("Error loading data from local storage:", e);
                    contentData = [];
                     showModal('Data Load Error', '<p>Could not load saved data. Starting with empty data.</p>', false);
                }
            } else {
                 contentData = [
                    { id: 1, title: 'Sharing Sarah\'s Smile', type: 'Patient Story', audience: 'Individual Donors', status: 'Approved', date: '2023-10-26', body: 'Sarah\'s story highlights...', patientId: 'PS-001', consentId: 'C-VALID', consentStatus: 'Valid', quote: 'The hospital felt like home.', media: [{id: 101, name: 'Patient Photo 1', type: 'image', url: 'https://placehold.co/100x80?text=Photo+1'}] },
                    { id: 2, title: 'New MRI Technology', type: 'Medical Innovation', audience: 'Healthcare Professionals', status: 'Published', date: '2023-10-20', body: 'Our latest MRI machine...' },
                    { id: 3, title: 'Urgent Need for Playroom Supplies', type: 'Hospital Need', audience: 'General Public', status: 'Draft', date: '2023-11-15', body: 'Our playrooms need updating...' },
                    { id: 4, title: 'Annual Gala Announcement', type: 'Event Promo', audience: 'Corporate Sponsors', status: 'Review', date: '2023-12-01', body: 'Join us for our annual gala...' },
                    { id: 5, title: 'Meet Dr. Anya Sharma', type: 'General Update', audience: 'General Public', status: 'Published', date: '2023-10-18', body: 'Introducing our new lead pediatrician...' },
                     { id: 6, title: 'Baby Leo\'s Journey', type: 'Patient Story', audience: 'Former Patients/Families', status: 'Draft', date: '2023-11-10', body: 'Leo\'s incredible fight...', patientId: 'PS-002', consentId: 'C-EXPIRED', consentStatus: 'Expired', quote: 'We are forever grateful.', media: [] },
                     { id: 7, title: 'Pediatric Research Breakthrough', type: 'Medical Innovation', audience: 'Healthcare Professionals', status: 'Approved', date: '2023-11-05', body: 'Exciting new research findings...' },
                     { id: 8, title: 'Volunteer Opportunities', type: 'Hospital Need', audience: 'General Public', status: 'Published', date: '2023-10-25', body: 'Ways you can help the hospital...' },
                 ];
            }
             applyFiltersAndSort();
        }

        loadContentData();


        // --- Data Export/Import ---
        exportDataButton.addEventListener('click', () => {
            const csvHeader = ["id", "title", "type", "audience", "status", "date", "body", "patientId", "consentId", "consentStatus", "quote", "media"].join(",");
            const csvRows = contentData.map(item => {
                const escapeCsv = (value) => {
                    if (value === undefined || value === null) return '';
                    const stringValue = String(value);
                    if (/[,"\n]/.test(stringValue)) {
                        return `"${stringValue.replace(/"/g, '""')}"`;
                    }
                    return stringValue;
                };

                 // Handle media array: stringify it for CSV
                const mediaString = item.media ? JSON.stringify(item.media) : '';


                return [
                    escapeCsv(item.id),
                    escapeCsv(item.title),
                    escapeCsv(item.type),
                    escapeCsv(item.audience),
                    escapeCsv(item.status),
                    escapeCsv(item.date),
                    escapeCsv(item.body),
                    escapeCsv(item.patientId),
                    escapeCsv(item.consentId),
                    escapeCsv(item.consentStatus),
                    escapeCsv(item.quote),
                    escapeCsv(mediaString) // Export media as string
                ].join(",");
            });

            const csvString = [csvHeader, ...csvRows].join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'foundation_content_export.csv';
            link.click();
            URL.revokeObjectURL(link.href);
        });

        importDataButton.addEventListener('click', () => {
            importDataInput.click();
        });

        importDataInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            showSpinner();

            const reader = new FileReader();
            reader.onload = (e) => {
                const csvString = e.target.result;
                parseCsv(csvString);
                hideSpinner();
            };
            reader.onerror = () => {
                 hideSpinner();
                 showModal('Import Error', '<p>Failed to read file.</p>', false);
            }
            reader.readAsText(file);
        });

        function parseCsv(csvString) {
            const lines = csvString.split(/\r\n|\n/).filter(line => line.trim() !== '');
            if (lines.length < 1) {
                 showModal('Import Error', '<p>CSV file is empty.</p>', false);
                return;
            }

            // Basic CSV parsing - improved to handle quoted fields for simple cases
            // This is still not a full CSV parser but handles quoted commas/newlines
            const parseLine = (line) => {
                 const values = [];
                 let currentValue = '';
                 let inQuotes = false;
                 for (let i = 0; i < line.length; i++) {
                     const char = line[i];
                     const nextChar = line[i + 1];

                     if (char === '"') {
                         if (inQuotes && nextChar === '"') {
                             currentValue += '"';
                             i++; // Skip the next quote
                         } else {
                             inQuotes = !inQuotes;
                         }
                     } else if (char === ',' && !inQuotes) {
                         values.push(currentValue.trim());
                         currentValue = '';
                     } else {
                         currentValue += char;
                     }
                 }
                 values.push(currentValue.trim()); // Add the last value
                 return values.map(val => {
                     // Remove surrounding quotes if present and unescape double quotes
                     if (val.startsWith('"') && val.endsWith('"')) {
                         return val.substring(1, val.length - 1).replace(/""/g, '"');
                     }
                     return val;
                 });
            };


            const header = parseLine(lines[0]);
            const expectedHeaders = ["id", "title", "type", "audience", "status", "date", "body", "patientId", "consentId", "consentStatus", "quote", "media"];

             if (header.length < expectedHeaders.length || !expectedHeaders.every(h => header.includes(h))) {
                  console.warn("CSV header might be incomplete or incorrect.", { expected: expectedHeaders, actual: header });
             }

            const newData = [];

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i];
                const values = parseLine(line);

                if (values.length !== header.length) {
                    console.warn(`Skipping row ${i + 1} due to incorrect column count or parsing issue: ${line}`);
                    continue;
                }

                const item = {};
                header.forEach((key, index) => {
                    item[key] = values[index];
                });

                if (item.id) item.id = parseInt(item.id) || item.id;

                 // Attempt to parse media string back into an array
                 if (item.media) {
                     try {
                         item.media = JSON.parse(item.media);
                         if (!Array.isArray(item.media)) item.media = []; // Ensure it's an array
                     } catch (e) {
                         console.error(`Failed to parse media for item ID ${item.id}:`, item.media, e);
                         item.media = []; // Default to empty array on error
                     }
                 } else {
                     item.media = []; // Default to empty array if media field is empty
                 }


                newData.push(item);
            }

            const newDataMap = new Map(newData.map(item => [item.id, item]));
            const mergedData = contentData.map(item => newDataMap.has(item.id) ? newDataMap.get(item.id) : item);
            newData.forEach(item => {
                if (!contentData.some(existing => existing.id === item.id)) {
                    mergedData.push(item);
                }
            });

            contentData = mergedData;
            saveContentData();
            applyFiltersAndSort();
            renderContentTable();
            updateDashboardMetrics();
            showModal('Import Successful', `<p>${newData.length} items processed. Data updated.</p>`, false);

             importDataInput.value = '';
        }


        // --- Modal Handling ---
        let elementBeforeModal = null;

        function showModal(title, bodyHtml, showConfirm = true) {
            elementBeforeModal = document.activeElement;
            modalTitle.textContent = title;
            modalBody.innerHTML = bodyHtml;
            modalConfirmButton.style.display = showConfirm ? 'inline-flex' : 'none';
             modalConfirmButton.onclick = hideModal;

            modalOverlay.classList.add('visible');
             setTimeout(() => {
                 trapFocus(modalContent);
             }, parseInt(varCss('--transition-speed').replace('s', '')) * 1000 + 50); // Delay slightly more than transition
        }

        function hideModal() {
            modalOverlay.classList.remove('visible');
             if (elementBeforeModal) {
                 elementBeforeModal.focus();
                 elementBeforeModal = null;
             }
        }

        modalCloseButton.addEventListener('click', hideModal);
        modalCancelButton.addEventListener('click', hideModal);

        modalOverlay.addEventListener('click', (e) => {
            if (e.target === modalOverlay) {
                hideModal();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && modalOverlay.classList.contains('visible')) {
                hideModal();
            }
            if (e.ctrlKey && e.key === 'n') {
                if (currentSection === '#content' && contentListView.style.display !== 'none') {
                    e.preventDefault();
                    showDetailView({});
                }
            }
             if (e.ctrlKey && e.key === 's') {
                 if (currentSection === '#content' && contentDetailView.style.display !== 'none') {
                     e.preventDefault();
                     contentForm.dispatchEvent(new Event('submit'));
                 }
             }
        });

         function trapFocus(element) {
             const focusableEls = element.querySelectorAll('button, [href], input:not([type="hidden"]), select, textarea, [tabindex]:not([tabindex="-1"])');
             const firstFocusableEl = focusableEls[0];
             const lastFocusableEl = focusableEls[focusableEls.length - 1];

             if (!firstFocusableEl) {
                 element.setAttribute('tabindex', '0');
                 element.focus();
                 return;
             } else {
                  element.removeAttribute('tabindex');
             }

             const handleTab = (e) => {
                 const isTabPressed = e.key === 'Tab' || e.keyCode === 9;
                 if (!isTabPressed) return;

                 if (e.shiftKey) { // Shift + Tab
                     if (document.activeElement === firstFocusableEl) {
                         lastFocusableEl.focus();
                         e.preventDefault();
                     }
                 } else { // Tab
                     if (document.activeElement === lastFocusableEl) {
                         firstFocusableEl.focus();
                         e.preventDefault();
                     }
                 }
             };

             modalOverlay.addEventListener('keydown', handleTab);
             // Store the listener so it can be removed later if needed (more complex for multiple modals)
             // For this simple app, we assume only one modal at a time.

             firstFocusableEl.focus();
         }


        // --- Context Menu ---
        let currentContextItem = null;
        let elementBeforeContextMenu = null;

        contentTableBody.addEventListener('contextmenu', (e) => {
            const row = e.target.closest('tr');
            if (row && row.dataset.id) {
                e.preventDefault();
                elementBeforeContextMenu = row;
                currentContextItem = contentData.find(item => item.id === parseInt(row.dataset.id));
                showContextMenu(e.clientX, e.clientY);
            } else {
                hideContextMenu();
            }
        });

        document.addEventListener('click', (e) => {
            if (!contextMenu.contains(e.target)) {
                hideContextMenu();
            }
        });

         document.addEventListener('scroll', hideContextMenu);


        function showContextMenu(x, y) {
            contextMenu.style.top = `${y}px`;
            contextMenu.style.left = `${x}px`;
            contextMenu.classList.add('visible');
             const firstMenuItem = contextMenu.querySelector('[role="menuitem"]');
             if (firstMenuItem) {
                 firstMenuItem.focus();
             }
        }

        function hideContextMenu() {
            contextMenu.classList.remove('visible');
            currentContextItem = null;
             if (elementBeforeContextMenu) {
                 elementBeforeContextMenu.focus();
                 elementBeforeContextMenu = null;
             }
        }

        contextMenu.addEventListener('click', (e) => {
            if (currentContextItem) {
                const action = e.target.dataset.action;
                if (action) {
                    handleContextAction(action, currentContextItem);
                }
            }
        });

         contextMenu.addEventListener('keydown', (e) => {
             const isMenuItem = e.target.getAttribute('role') === 'menuitem';
             if (!isMenuItem) return;

             const items = Array.from(contextMenu.querySelectorAll('[role="menuitem"]'));
             const currentIndex = items.indexOf(e.target);

             if (e.key === 'ArrowDown') {
                 e.preventDefault();
                 const nextIndex = (currentIndex + 1) % items.length;
                 items[nextIndex].focus();
             } else if (e.key === 'ArrowUp') {
                 e.preventDefault();
                 const prevIndex = (currentIndex - 1 + items.length) % items.length;
                 items[prevIndex].focus();
             } else if (e.key === 'Enter' || e.key === ' ') {
                 e.preventDefault();
                 e.target.click();
             } else if (e.key === 'Escape') {
                 hideContextMenu();
             }
         });


        function handleContextAction(action, item) {
            console.log(`Action: ${action} on item ID: ${item.id}`);
            switch (action) {
                case 'edit':
                    showDetailView(item);
                    break;
                case 'duplicate':
                    showSpinner();
                    setTimeout(() => {
                        const newItem = { ...item, id: Date.now(), title: `${item.title} (Copy)`, status: 'Draft', date: '' };
                         if (item.type === 'Patient Story') {
                             newItem.patientId = item.patientId;
                             newItem.consentId = item.consentId;
                             newItem.consentStatus = 'Unknown';
                             newItem.quote = item.quote;
                             newItem.media = [...(item.media || [])];
                         }
                        contentData.push(newItem);
                        saveContentData();
                        applyFiltersAndSort();
                        renderContentTable();
                        updateDashboardMetrics();
                        hideSpinner();
                        showModal('Item Duplicated', `<p>Duplicated "${item.title}". New draft created.</p>`, false);
                    }, 500);
                    break;
                case 'delete':
                    showModal('Confirm Delete', `<p>Are you sure you want to delete "${item.title}"?</p>`, true);
                    modalConfirmButton.onclick = () => {
                        showSpinner();
                        setTimeout(() => {
                            contentData = contentData.filter(content => content.id !== item.id);
                            saveContentData();
                            applyFiltersAndSort();
                            renderContentTable();
                            updateDashboardMetrics();
                            hideModal();
                            showModal('Item Deleted', `<p>"${item.title}" has been deleted.</p>`, false);
                            hideSpinner();
                        }, 500);
                    };
                    break;
            }
        }

        // --- Drag and Drop Example (Integrated into Calendar Placeholder) ---
        const draggableItem = document.querySelector('.calendar-placeholder .draggable-item');
        const dropTarget = document.querySelector('.calendar-placeholder .drop-target');

        if (draggableItem && dropTarget) {
            draggableItem.addEventListener('dragstart', (e) => {
                e.dataTransfer.setData('text/plain', e.target.textContent); // Pass text content
                e.target.style.opacity = '0.5';
                 e.dataTransfer.effectAllowed = 'move';
                 e.target.setAttribute('aria-grabbed', 'true');
            });

            draggableItem.addEventListener('dragend', (e) => {
                e.target.style.opacity = '1';
                 e.target.setAttribute('aria-grabbed', 'false');
            });

            dropTarget.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropTarget.classList.add('drag-over');
                 e.dataTransfer.dropEffect = 'move';
            });

            dropTarget.addEventListener('dragleave', (e) => {
                dropTarget.classList.remove('drag-over');
            });

            dropTarget.addEventListener('drop', (e) => {
                e.preventDefault();
                dropTarget.classList.remove('drag-over');
                const data = e.dataTransfer.getData('text/plain');
                dropTarget.innerHTML = `Dropped: <strong>${data}</strong><br> (Simulated Scheduling)`;
                // In a real calendar, you'd update the item's date/position here
            });

             // Add keyboard accessibility to drop target
             dropTarget.addEventListener('keydown', (e) => {
                 if (e.key === 'Enter' || e.key === ' ') {
                     e.preventDefault();
                     // Simulate dropping a conceptual item
                     dropTarget.innerHTML = `Dropped: <strong>(Simulated Item)</strong><br> (Simulated Scheduling)`;
                     dropTarget.style.borderColor = varCss("--secondary-color");
                 }
             });
        }


        // --- Dashboard Charts ---
        let contentOverviewChart = null;
        let contentOutputChart = null;

        function renderDashboardCharts() {
            if (contentOverviewChart) contentOverviewChart.destroy();
            if (contentOutputChart) contentOutputChart.destroy();

            const contentTypeCounts = contentData.reduce((acc, item) => {
                acc[item.type] = (acc[item.type] || 0) + 1;
                return acc;
            }, {});
            const overviewLabels = Object.keys(contentTypeCounts);
            const overviewData = Object.values(contentTypeCounts);

            const contentMonthlyCounts = contentData.reduce((acc, item) => {
                if (item.date) {
                    const [year, month] = item.date.split('-');
                    const monthYear = `${year}-${month}`;
                     acc[monthYear] = (acc[monthYear] || 0) + 1;
                }
                return acc;
            }, {});
            const outputLabels = Object.keys(contentMonthlyCounts).sort();
            const outputData = outputLabels.map(monthYear => contentMonthlyCounts[monthYear]);

            const ctx1 = document.getElementById('contentOverviewChart').getContext('2d');
            const overviewChartType = document.getElementById('contentOverviewChartType').value;
            const overviewFontSize = parseInt(document.getElementById('contentOverviewFontSize').value);

            contentOverviewChart = new Chart(ctx1, {
                type: overviewChartType,
                data: {
                    labels: overviewLabels,
                    datasets: [{
                        label: 'Content Type Count',
                        data: overviewData,
                        backgroundColor: [
                            varCss("--primary-color"),
                            varCss("--secondary-color"),
                            varCss("--accent-color"),
                            varCss("--danger-color"),
                            'rgba(156, 39, 176, 0.8)',
                            'rgba(0, 188, 212, 0.8)',
                             'rgba(121, 85, 72, 0.8)',
                        ],
                         borderColor: varCss("--surface-color"),
                         borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                     onClick: (e) => toggleChartControls('contentOverviewChartControls', 'contentOverviewChartContainer'),
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    size: overviewFontSize,
                                    family: 'Inter, sans-serif'
                                }
                            }
                        },
                        title: {
                            display: false,
                        },
                         tooltip: {
                            bodyFont: {
                                size: overviewFontSize,
                                family: 'Inter, sans-serif'
                            },
                            titleFont: {
                                size: overviewFontSize + 2,
                                weight: 'bold',
                                family: 'Inter, sans-serif'
                            }
                        }
                    },
                     scales: overviewChartType === 'pie' || overviewChartType === 'doughnut' || overviewChartType === 'polarArea' ? {} : {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: overviewFontSize,
                                    family: 'Inter, sans-serif'
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: overviewFontSize,
                                    family: 'Inter, sans-serif'
                                }
                            }
                        }
                    }
                }
            });

            const ctx2 = document.getElementById('contentOutputChart').getContext('2d');
            const outputChartType = document.getElementById('contentOutputChartType').value;
            const outputFontSize = parseInt(document.getElementById('contentOutputFontSize').value);

            contentOutputChart = new Chart(ctx2, {
                type: outputChartType,
                data: {
                    labels: outputLabels,
                    datasets: [{
                        label: 'Content Items Published/Planned',
                        data: outputData,
                        backgroundColor: varCss("--primary-color"),
                        borderColor: varCss("--primary-color-dark"),
                        borderWidth: 2,
                         fill: outputChartType === 'line' ? 'start' : false,
                         tension: outputChartType === 'line' ? 0.3 : 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                     onClick: (e) => toggleChartControls('contentOutputChartControls', 'contentOutputChartContainer'),
                    plugins: {
                        legend: {
                            position: 'top',
                             labels: {
                                font: {
                                    size: outputFontSize,
                                    family: 'Inter, sans-serif'
                                }
                            }
                        },
                        title: {
                             display: false,
                        },
                         tooltip: {
                            bodyFont: {
                                size: outputFontSize,
                                family: 'Inter, sans-serif'
                            },
                            titleFont: {
                                size: outputFontSize + 2,
                                weight: 'bold',
                                family: 'Inter, sans-serif'
                            }
                        }
                    },
                    scales: outputChartType === 'pie' || outputChartType === 'doughnut' || outputChartType === 'polarArea' ? {} : {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                font: {
                                    size: outputFontSize,
                                    family: 'Inter, sans-serif'
                                }
                            }
                        },
                        x: {
                            ticks: {
                                font: {
                                    size: outputFontSize,
                                    family: 'Inter, sans-serif'
                                }
                            }
                        }
                    }
                }
            });

            setupChartControls('contentOverviewChart', contentOverviewChart, {
                type: 'contentOverviewChartType',
                fontSize: 'contentOverviewFontSize'
            });
             setupChartControls('contentOutputChart', contentOutputChart, {
                type: 'contentOutputChartType',
                fontSize: 'contentOutputFontSize'
            });
        }

        function toggleChartControls(controlsId, containerId) {
             const controls = document.getElementById(controlsId);
             const container = document.getElementById(containerId);
             const isActive = controls.classList.toggle('active');
             container.setAttribute('aria-expanded', isActive);
             if (isActive) {
                 controls.querySelector('select, input, button')?.focus();
             } else {
                 container.focus();
             }
        }


        function setupChartControls(chartId, chartInstance, controlIds) {
            const controls = document.getElementById(`${chartId}Controls`);
            const chartContainer = document.getElementById(`${chartId}Container`);
            if (!controls || !chartContainer) return;

            const typeSelect = document.getElementById(controlIds.type);
            const fontSizeInput = document.getElementById(controlIds.fontSize);

            if (chartInstance._controlListeners) {
                 chartInstance._controlListeners.forEach(({ element, event, handler }) => {
                    element.removeEventListener(event, handler);
                 });
                 chartInstance._controlListeners = [];
            } else {
                 chartInstance._controlListeners = [];
            }

             if (chartInstance._hideControlsListener) {
                 document.removeEventListener('click', chartInstance._hideControlsListener);
             }
             if (chartInstance._keyboardToggleListener) {
                 chartContainer.removeEventListener('keydown', chartInstance._keyboardToggleListener);
             }
              if (chartInstance._controlsFocusOutListener) {
                 controls.removeEventListener('focusout', chartInstance._controlsFocusOutListener);
             }


            const updateHandler = () => {
                 const newType = typeSelect.value;
                 const newFontSize = parseInt(fontSizeInput.value);

                 chartInstance.config.type = newType;

                 const updateFont = (obj) => obj?.font && (obj.font.size = newFontSize);
                 if (chartInstance.options.plugins?.legend?.labels) updateFont(chartInstance.options.plugins.legend.labels);
                 if (chartInstance.options.plugins?.tooltip?.bodyFont) updateFont(chartInstance.options.plugins.tooltip.bodyFont);
                 if (chartInstance.options.plugins?.tooltip?.titleFont) updateFont(chartInstance.options.plugins.tooltip.titleFont);

                if (newType === 'pie' || newType === 'doughnut' || newType === 'polarArea') {
                    chartInstance.options.scales = {};
                } else {
                     if (!chartInstance.options.scales || Object.keys(chartInstance.options.scales).length === 0) {
                         chartInstance.options.scales = {
                             y: { beginAtZero: true },
                             x: {}
                         };
                     }
                     if (chartInstance.options.scales?.y?.ticks) updateFont(chartInstance.options.scales.y.ticks);
                     if (chartInstance.options.scales?.x?.ticks) updateFont(chartInstance.options.scales.x.ticks);
                     if (chartInstance.options.scales?.r?.ticks) updateFont(chartInstance.options.scales.r.ticks);
                }

                 chartInstance.update();
             };

            const typeListener = { element: typeSelect, event: 'change', handler: updateHandler };
            const fontSizeListener = { element: fontSizeInput, event: 'change', handler: updateHandler };

            typeSelect.addEventListener('change', updateHandler);
            fontSizeInput.addEventListener('change', updateHandler);

            chartInstance._controlListeners.push(typeListener, fontSizeListener);

            const hideControlsHandler = (e) => {
                if (!e.target.closest('.floating-controls') && !e.target.closest(`#${chartId}Container`)) {
                    controls.classList.remove('active');
                     chartContainer.setAttribute('aria-expanded', 'false');
                }
            };
            document.addEventListener('click', hideControlsHandler);
            chartInstance._hideControlsListener = hideControlsHandler;


             chartContainer.setAttribute('tabindex', '0');
             chartContainer.setAttribute('role', 'button');
             chartContainer.setAttribute('aria-haspopup', 'true');
             chartContainer.setAttribute('aria-expanded', 'false');

             const keyboardToggleHandler = (e) => {
                 if (e.key === 'Enter' || e.key === ' ') {
                     e.preventDefault();
                     toggleChartControls(controls.id, chartContainer.id);
                 }
             };
             chartContainer.addEventListener('keydown', keyboardToggleHandler);
             chartInstance._keyboardToggleListener = keyboardToggleHandler;


             const controlsFocusOutHandler = (e) => {
                 if (!controls.contains(e.relatedTarget) && e.relatedTarget !== chartContainer) {
                     controls.classList.remove('active');
                      chartContainer.setAttribute('aria-expanded', 'false');
                 }
             };
             controls.addEventListener('focusout', controlsFocusOutHandler);
             chartInstance._controlsFocusOutListener = controlsFocusOutHandler;

             controls.setAttribute('tabindex', '-1');
        }

         // --- Accessibility Announcer ---
         // A simple way to announce dynamic changes for screen readers
         function announce(message) {
             let announcer = document.getElementById('announcer');
             if (!announcer) {
                 announcer = document.createElement('div');
                 announcer.id = 'announcer';
                 announcer.setAttribute('aria-live', 'polite');
                 announcer.classList.add('visually-hidden');
                 document.body.appendChild(announcer);
             }
             announcer.textContent = ''; // Clear before adding new message
             // Use a timeout to ensure the message is announced even if rapidly changing
             setTimeout(() => {
                 announcer.textContent = message;
             }, 100);
         }


        // Initial data load and rendering handled by navigateTo('#dashboard', false) and loadContentData()

    </script>

</body>
</html>
