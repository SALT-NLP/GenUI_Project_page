<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Climate Change Research Notes</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet" />
    <style>
        :root {
            --primary-color: #4CAF50; /* Green */
            --secondary-color: #2196F3; /* Blue */
            --background-color: #f4f7f6; /* Light gray/white */
            --surface-color: #ffffff; /* Pure white */
            --text-color: #333;
            --text-secondary-color: #666;
            --border-color: #ddd;
            --hover-color: #e0e0e0;
            --focus-color: #bbdefb; /* Light blue */
            --danger-color: #f44336; /* Red */
            --spacing-extra-small: 4px;
            --spacing-small: 8px;
            --spacing-medium: 16px;
            --spacing-large: 24px;
            --border-radius: 8px;
            --box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            --transition-speed: 0.2s;
        }

        *, *::before, *::after {
            box-sizing: border-box; /* Ensure padding and border are included in element's total width and height */
        }

        body {
            font-family: 'Lato', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-y: hidden; /* Prevent body scroll when main/aside scroll */
        }

        header {
            background-color: var(--surface-color);
            padding: var(--spacing-medium) var(--spacing-large);
            box-shadow: var(--box-shadow);
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: var(--spacing-large);
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            flex-shrink: 0; /* Prevent shrinking when content overflows */
        }

        header h1 {
            margin: 0;
            font-size: 1.8em;
            color: var(--primary-color);
            flex-shrink: 0; /* Prevent shrinking */
        }

        .search-container {
            flex-grow: 1;
            max-width: 400px;
            position: relative;
            min-width: 200px; /* Ensure search input is usable */
        }

        .search-container input {
            width: 100%;
            padding: var(--spacing-small) var(--spacing-medium) var(--spacing-small) 40px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1em;
            transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
            font-family: inherit; /* Inherit font */
        }

        .search-container input:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
        }

        .search-container .material-symbols-rounded {
            position: absolute;
            left: var(--spacing-medium);
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary-color);
            font-size: 1.2em;
            pointer-events: none; /* Allow clicks to pass through icon */
        }

        .layout-container {
            display: flex;
            flex: 1;
            overflow-y: hidden; /* Allow children to scroll */
        }

        aside {
            width: 280px; /* Slightly wider sidebar */
            background-color: var(--surface-color);
            padding: var(--spacing-large) var(--spacing-medium);
            box-shadow: var(--box-shadow);
            border-right: 1px solid var(--border-color);
            flex-shrink: 0;
            overflow-y: auto; /* Allow scrolling if categories overflow */
            display: flex;
            flex-direction: column;
        }

        aside h2 {
            margin-top: 0;
            font-size: 1.3em;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: var(--spacing-small);
            margin-bottom: var(--spacing-medium);
        }

        .category-list {
            list-style: none;
            padding: 0;
            margin: 0;
            flex-grow: 1; /* Allow list to take space */
        }

        .category-item {
            padding: var(--spacing-small) var(--spacing-medium);
            margin-bottom: var(--spacing-small);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color var(--transition-speed), color var(--transition-speed);
            display: flex;
            align-items: center;
            justify-content: space-between;
            user-select: none; /* Prevent text selection */
            min-height: 36px; /* Ensure minimum click target size */
        }

        .category-item:hover {
            background-color: var(--hover-color);
        }
         .category-item:focus {
             outline: none;
             box-shadow: 0 0 0 2px var(--focus-color);
         }


        .category-item.active {
            background-color: var(--secondary-color);
            color: white;
            font-weight: bold;
        }

        .category-item.active .category-count {
             background-color: rgba(255, 255, 255, 0.3);
             color: white;
        }

        .category-item span {
            flex-grow: 1;
            margin-right: var(--spacing-small); /* Space between name and count */
        }

        .category-count {
            background-color: var(--border-color);
            color: var(--text-color);
            padding: 2px 8px;
            border-radius: 12px; /* Pill shape */
            font-size: 0.8em;
            min-width: 20px; /* Ensure minimum width */
            text-align: center;
            transition: background-color var(--transition-speed), color var(--transition-speed);
        }


        .add-category-button {
            display: flex;
            align-items: center;
            width: 100%;
            padding: var(--spacing-small) var(--spacing-medium);
            margin-top: var(--spacing-medium);
            border: 1px dashed var(--border-color);
            background: none;
            color: var(--text-secondary-color);
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: background-color var(--transition-speed), color var(--transition-speed), border-color var(--transition-speed);
            font-size: 1em;
            font-family: 'Lato', sans-serif;
            text-align: left;
            min-height: 36px; /* Ensure minimum click target size */
        }

        .add-category-button:hover {
            background-color: var(--hover-color);
            color: var(--text-color);
            border-color: var(--text-color);
        }
         .add-category-button:focus {
             outline: none;
             box-shadow: 0 0 0 2px var(--focus-color);
         }


        .add-category-button .material-symbols-rounded {
            margin-right: var(--spacing-small);
            font-size: 1.2em;
        }


        main {
            flex-grow: 1;
            padding: var(--spacing-large);
            display: flex;
            flex-direction: column;
            overflow-y: auto; /* Allow scrolling if notes overflow */
        }

        .main-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-large);
            flex-wrap: wrap;
            gap: var(--spacing-medium);
            flex-shrink: 0; /* Prevent shrinking */
        }

        .main-header h2 {
            margin: 0;
            font-size: 1.5em;
            color: var(--text-color);
        }

        .main-header-controls {
            display: flex;
            align-items: center;
            gap: var(--spacing-medium);
            flex-wrap: wrap; /* Allow controls to wrap */
        }

        #sort-select {
            padding: var(--spacing-small);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1em;
            font-family: inherit;
            cursor: pointer;
            transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
            min-height: 36px; /* Match button height */
        }

        #sort-select:focus {
             outline: none;
             border-color: var(--secondary-color);
             box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
        }

        .add-note-button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: var(--spacing-small) var(--spacing-medium);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1em;
            display: flex;
            align-items: center;
            transition: background-color var(--transition-speed), box-shadow var(--transition-speed);
            font-family: inherit;
             min-height: 36px; /* Ensure minimum click target size */
        }

        .add-note-button:hover {
            background-color: #43a047; /* Darker green */
            box-shadow: var(--box-shadow);
        }
         .add-note-button:focus {
             outline: none;
             box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.4);
         }


        .add-note-button .material-symbols-rounded {
            margin-right: var(--spacing-small);
            font-size: 1.2em;
        }

        .note-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); /* Adjusted min width for larger screens */
            gap: var(--spacing-medium);
            flex-grow: 1; /* Allow list to take available space */
            align-content: start; /* Align items to the start when there are few */
        }

        .note-card {
            background-color: var(--surface-color);
            padding: var(--spacing-medium);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            border: 1px solid var(--border-color);
            transition: transform var(--transition-speed), box-shadow var(--transition-speed), border-color var(--transition-speed);
            display: flex;
            flex-direction: column;
            cursor: pointer;
            position: relative; /* For action button positioning */
        }

        .note-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
         .note-card:focus {
             outline: none;
             box-shadow: 0 0 0 3px var(--focus-color);
             border-color: var(--secondary-color);
         }


        .note-card h3 {
            margin-top: 0;
            margin-bottom: var(--spacing-small);
            font-size: 1.2em;
            color: var(--text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .note-card p {
            margin: 0 0 var(--spacing-small) 0;
            font-size: 0.9em;
            color: var(--text-secondary-color);
            flex-grow: 1;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        .note-card .note-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8em;
            color: var(--text-secondary-color);
            margin-top: var(--spacing-small);
            padding-top: var(--spacing-small);
            border-top: 1px solid var(--border-color);
        }

         .note-card .note-meta .meta-left {
             display: flex;
             align-items: center;
             gap: var(--spacing-small);
         }

        .note-card .note-category {
            background-color: var(--secondary-color);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            flex-shrink: 0; /* Prevent shrinking */
        }
         .note-card .note-date {
             font-style: italic;
             flex-shrink: 0;
         }


        .note-card .note-actions {
            display: flex;
            gap: var(--spacing-extra-small); /* Smaller gap for icons */
            flex-shrink: 0;
        }

        .note-card .note-actions button {
            background: none;
            border: none;
            color: var(--text-secondary-color);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: color var(--transition-speed), background-color var(--transition-speed);
            font-size: 1em; /* Ensure icon size is consistent */
            display: flex; /* Center icon */
            align-items: center;
            justify-content: center;
             min-width: 32px; /* Ensure minimum click target size */
             min-height: 32px; /* Ensure minimum click target size */
        }

        .note-card .note-actions button:hover,
        .note-card .note-actions button:focus {
            color: var(--text-color);
            background-color: var(--hover-color);
            outline: none; /* Remove default focus outline */
        }

        .note-card .note-actions button.delete:hover,
        .note-card .note-actions button.delete:focus {
            color: var(--danger-color);
        }

        .empty-state {
            text-align: center;
            padding: var(--spacing-large);
            color: var(--text-secondary-color);
            font-size: 1.2em;
            grid-column: 1 / -1; /* Span across all columns */
        }

         .visually-hidden {
             position: absolute;
             width: 1px;
             height: 1px;
             margin: -1px;
             padding: 0;
             overflow: hidden;
             clip: rect(0, 0, 0, 0);
             border: 0;
         }


        /* Modal/Dialog Styles */
        dialog {
            border: none;
            border-radius: var(--border-radius);
            padding: var(--spacing-large);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            max-width: 600px;
            width: 90%;
            background-color: var(--surface-color);
            animation: modal-fade-in var(--transition-speed) ease-out;
        }

         @keyframes modal-fade-in {
             from { opacity: 0; transform: translateY(-20px); }
             to { opacity: 1; transform: translateY(0); }
         }

         dialog[open] {
             display: block; /* Override default display: flex for simpler styling */
         }


        dialog::backdrop {
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            animation: backdrop-fade-in var(--transition-speed) ease-out;
        }
         @keyframes backdrop-fade-in {
             from { opacity: 0; }
             to { opacity: 1; }
         }


        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--spacing-medium);
            padding-bottom: var(--spacing-small);
            border-bottom: 1px solid var(--border-color);
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.4em;
            color: var(--text-color);
        }

        .modal-close-button {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--text-secondary-color);
            transition: color var(--transition-speed);
            padding: var(--spacing-extra-small); /* Make click target larger */
            border-radius: var(--border-radius);
             min-width: 36px; /* Ensure minimum click target size */
             min-height: 36px; /* Ensure minimum click target size */
        }

        .modal-close-button:hover,
        .modal-close-button:focus {
            color: var(--text-color);
            background-color: var(--hover-color);
            outline: none;
        }

        .note-form label {
            display: block;
            margin-bottom: var(--spacing-small);
            font-weight: bold;
            color: var(--text-color);
        }

        .note-form input[type="text"],
        .note-form textarea,
        .note-form select,
        .note-form input[type="date"] {
            width: 100%;
            padding: var(--spacing-small);
            margin-bottom: var(--spacing-medium);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1em;
            transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
            font-family: 'Lato', sans-serif;
        }

         .note-form textarea {
             min-height: 150px;
             resize: vertical;
         }

        .note-form input[type="text"]:focus,
        .note-form textarea:focus,
        .note-form select:focus,
        .note-form input[type="date"]:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 2px rgba(33, 150, 243, 0.2);
        }

        .note-form .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-medium);
            margin-top: var(--spacing-medium);
        }

        .note-form button {
            padding: var(--spacing-small) var(--spacing-medium);
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 1em;
            transition: background-color var(--transition-speed), box-shadow var(--transition-speed);
            font-family: inherit;
             min-height: 36px; /* Ensure minimum click target size */
        }

        .note-form button[type="submit"] {
            background-color: var(--primary-color);
            color: white;
        }

        .note-form button[type="submit"]:hover {
            background-color: #43a047; /* Darker green */
            box-shadow: var(--box-shadow);
        }
         .note-form button[type="submit"]:focus {
             outline: none;
             box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.4);
         }


        .note-form button[type="button"] { /* Cancel button */
            background-color: var(--border-color);
            color: var(--text-color);
        }

        .note-form button[type="button"]:hover {
            background-color: var(--hover-color);
             box-shadow: var(--box-shadow);
        }
         .note-form button[type="button"]:focus {
             outline: none;
             box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.2);
         }


        .note-form .error-message {
            color: var(--danger-color);
            font-size: 0.9em;
            margin-top: calc(-1 * var(--spacing-small)); /* Adjust margin when hidden */
            margin-bottom: var(--spacing-medium);
            /* Using visibility: hidden and aria-hidden for accessibility */
            visibility: hidden;
            height: 0; /* Prevent layout shift */
            overflow: hidden; /* Prevent content from being visible */
        }

        .note-form .error-message[aria-hidden="false"] {
             visibility: visible;
             height: auto;
             margin-top: var(--spacing-extra-small); /* Adjust margin when visible */
             margin-bottom: var(--spacing-medium);
        }


         .note-form input:invalid:not(:placeholder-shown),
         .note-form textarea:invalid:not(:placeholder-shown),
         .note-form select:invalid:not([value=""]):not(:placeholder-shown) {
             border-color: var(--danger-color);
         }
         .note-form input:invalid:not(:placeholder-shown):focus,
         .note-form textarea:invalid:not(:placeholder-shown):focus,
         .note-form select:invalid:not([value=""]):not(:placeholder-shown):focus {
             box-shadow: 0 0 0 2px rgba(244, 67, 54, 0.2);
         }


        /* Category Modal */
         #category-modal {
            max-width: 400px;
         }

         #category-modal .category-list-edit {
             list-style: none;
             padding: 0;
             margin: 0;
             max-height: 200px; /* Limit height for scrolling */
             overflow-y: auto;
         }

         #category-modal .category-item-edit {
             display: flex;
             align-items: center;
             justify-content: space-between;
             padding: var(--spacing-small) 0;
             border-bottom: 1px solid var(--border-color);
         }

         #category-modal .category-item-edit:last-child {
             border-bottom: none;
         }

         #category-modal .category-item-edit span {
             flex-grow: 1;
             margin-right: var(--spacing-small);
         }

         #category-modal .category-item-edit button {
             background: none;
             border: none;
             color: var(--text-secondary-color);
             cursor: pointer;
             padding: 4px;
             border-radius: 4px;
             transition: color var(--transition-speed), background-color var(--transition-speed);
              min-width: 32px; /* Ensure minimum click target size */
              min-height: 32px; /* Ensure minimum click target size */
         }

         #category-modal .category-item-edit button:hover,
         #category-modal .category-item-edit button:focus {
             color: var(--danger-color);
             background-color: var(--hover-color);
             outline: none;
         }

         #category-modal .add-category-input-container {
             display: flex;
             gap: var(--spacing-small);
             margin-top: var(--spacing-medium);
             padding-top: var(--spacing-medium);
             border-top: 1px solid var(--border-color);
             align-items: center;
         }

         #category-modal .add-category-input-container input {
             flex-grow: 1;
             margin-bottom: 0;
             font-family: inherit;
         }

         #category-modal .add-category-input-container button {
             background-color: var(--primary-color);
             color: white;
             border: none;
             padding: var(--spacing-small) var(--spacing-medium);
             border-radius: var(--border-radius);
             cursor: pointer;
             font-size: 1em;
             transition: background-color var(--transition-speed), box-shadow var(--transition-speed);
             font-family: inherit;
             flex-shrink: 0;
              min-height: 36px; /* Ensure minimum click target size */
         }

         #category-modal .add-category-input-container button:hover {
              background-color: #43a047; /* Darker green */
              box-shadow: var(--box-shadow);
         }
          #category-modal .add-category-input-container button:focus {
              outline: none;
              box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.4);
          }


         /* Responsive adjustments */
         @media (max-width: 768px) {
             .layout-container {
                 flex-direction: column;
                 overflow-y: auto; /* Allow body scroll on small screens */
             }

             body {
                 overflow-y: auto;
             }

             aside {
                 width: 100%;
                 padding: var(--spacing-medium);
                 border-right: none;
                 border-bottom: 1px solid var(--border-color);
                 max-height: 200px; /* Limit height on mobile */
                 overflow-y: auto;
             }

             header {
                 flex-direction: column;
                 gap: var(--spacing-medium);
                 padding: var(--spacing-medium);
                 align-items: stretch; /* Stretch items to fill width */
             }
             header h1 {
                 text-align: center;
             }

             .search-container {
                 max-width: 100%;
             }

             main {
                 padding: var(--spacing-medium);
             }

             .main-header {
                 flex-direction: column;
                 align-items: stretch;
             }
             .main-header-controls {
                 justify-content: space-between; /* Distribute controls */
             }
             #sort-select {
                 flex-grow: 1; /* Allow select to grow */
             }
             .add-note-button {
                 flex-grow: 1; /* Allow button to grow */
                 justify-content: center; /* Center text/icon */
             }


             .note-list {
                 grid-template-columns: 1fr;
             }

             dialog {
                 width: 95%;
             }
         }

    </style>
</head>
<body>

    <header>
        <h1>Climate Notes</h1>
        <div class="search-container">
            <span class="material-symbols-rounded" aria-hidden="true">search</span>
            <input type="text" id="search-input" placeholder="Search notes..." aria-label="Search notes">
        </div>
    </header>

    <div class="layout-container">
        <aside>
            <h2>Categories</h2>
            <ul class="category-list" id="category-list" role="navigation" aria-label="Note categories">
                <!-- Categories populated by JavaScript -->
            </ul>
             <button class="add-category-button" id="manage-categories-button" aria-haspopup="dialog" aria-controls="category-modal">
                 <span class="material-symbols-rounded" aria-hidden="true">add</span>
                 Manage Categories
             </button>
        </aside>

        <main>
            <div class="main-header">
                <h2 id="current-category-title">All Notes</h2>
                <div class="main-header-controls">
                     <label for="sort-select" class="visually-hidden">Sort by:</label>
                     <select id="sort-select" aria-label="Sort notes by">
                         <option value="date-desc">Date (Newest First)</option>
                         <option value="date-asc">Date (Oldest First)</option>
                         <option value="title-asc">Title (A-Z)</option>
                         <option value="title-desc">Title (Z-A)</option>
                     </select>
                    <button class="add-note-button" id="add-note-button" aria-haspopup="dialog" aria-controls="note-modal">
                        <span class="material-symbols-rounded" aria-hidden="true">add</span>
                        Add Note
                    </button>
                </div>
            </div>

            <div class="note-list" id="note-list" role="feed" aria-live="polite">
                <!-- Note cards will be populated here by JavaScript -->
                 <div class="empty-state" id="empty-state" style="display: none;" role="status">
                     No notes found for this category or search term.
                 </div>
            </div>
        </main>
    </div>

    <!-- Note Form Modal -->
    <dialog id="note-modal" aria-labelledby="note-modal-title">
        <div class="modal-header">
            <h3 id="note-modal-title">Add New Note</h3>
            <button class="modal-close-button" id="close-note-modal" aria-label="Close modal">&times;</button>
        </div>
        <form id="note-form" novalidate> <!-- novalidate to handle validation with JS -->
            <input type="hidden" id="note-id">
            <div>
                <label for="note-title">Title:</label>
                <input type="text" id="note-title" required aria-required="true" aria-describedby="title-error">
                <div class="error-message" id="title-error" aria-live="polite" aria-hidden="true">Title is required.</div>
            </div>
            <div>
                <label for="note-content">Content:</label>
                <textarea id="note-content" required aria-required="true" aria-describedby="content-error"></textarea>
                 <div class="error-message" id="content-error" aria-live="polite" aria-hidden="true">Content is required.</div>
            </div>
            <div>
                <label for="note-category">Category:</label>
                <select id="note-category" required aria-required="true" aria-describedby="category-error">
                    <option value="">Select Category</option>
                    <!-- Options populated by JavaScript -->
                </select>
                 <div class="error-message" id="category-error" aria-live="polite" aria-hidden="true">Category is required.</div>
            </div>
             <div>
                <label for="note-source">Source (Optional):</label>
                <input type="text" id="note-source">
            </div>
             <div>
                <label for="note-date">Date (Optional):</label>
                <input type="date" id="note-date">
            </div>
            <div class="form-actions">
                <button type="button" id="cancel-note-button">Cancel</button>
                <button type="submit">Save Note</button>
            </div>
        </form>
    </dialog>

    <!-- Category Management Modal -->
    <dialog id="category-modal" aria-labelledby="category-modal-title">
         <div class="modal-header">
            <h3 id="category-modal-title">Manage Categories</h3>
            <button class="modal-close-button" id="close-category-modal" aria-label="Close modal">&times;</button>
         </div>
         <ul class="category-list-edit" id="category-list-edit" role="list">
             <!-- Categories will be listed here by JavaScript -->
         </ul>
         <div class="add-category-input-container">
             <input type="text" id="new-category-input" placeholder="New category name" aria-label="New category name">
             <button id="add-category-button-modal">Add</button>
         </div>
    </dialog>


    <script>
        const notes = JSON.parse(localStorage.getItem('climateNotes') || '[]');
        let categories = JSON.parse(localStorage.getItem('climateCategories') || '["General", "Policy", "Science", "Impacts"]');
        let currentCategory = 'all';
        let searchTerm = '';
        let currentSort = 'date-desc'; // Default sort order

        const noteListEl = document.getElementById('note-list');
        const categoryListEl = document.getElementById('category-list');
        const currentCategoryTitleEl = document.getElementById('current-category-title');
        const addNoteButtonEl = document.getElementById('add-note-button');
        const searchInputEl = document.getElementById('search-input');
        const emptyStateEl = document.getElementById('empty-state');
        const sortSelectEl = document.getElementById('sort-select'); // Get sort select element

        const noteModalEl = document.getElementById('note-modal');
        const noteModalTitleEl = document.getElementById('note-modal-title');
        const noteFormEl = document.getElementById('note-form');
        const noteIdEl = document.getElementById('note-id');
        const noteTitleEl = document.getElementById('note-title');
        const noteContentEl = document.getElementById('note-content');
        const noteCategoryEl = document.getElementById('note-category');
        const noteSourceEl = document.getElementById('note-source');
        const noteDateEl = document.getElementById('note-date');
        const closeNoteModalButtonEl = document.getElementById('close-note-modal');
        const cancelNoteButtonEl = document.getElementById('cancel-note-button');

        const categoryModalEl = document.getElementById('category-modal');
        const manageCategoriesButtonEl = document.getElementById('manage-categories-button');
        const categoryListEditEl = document.getElementById('category-list-edit');
        const newCategoryInputEl = document.getElementById('new-category-input');
        const addCategoryButtonModalEl = document.getElementById('add-category-button-modal');
        const closeCategoryModalButtonEl = document.getElementById('close-category-modal');

        // Error message elements
        const titleErrorEl = document.getElementById('title-error');
        const contentErrorEl = document.getElementById('content-error');
        const categoryErrorEl = document.getElementById('category-error');

        // --- Data Persistence ---
        function saveNotes() {
            localStorage.setItem('climateNotes', JSON.stringify(notes));
        }

        function saveCategories() {
            localStorage.setItem('climateCategories', JSON.stringify(categories));
        }

        // --- Rendering ---
        function renderCategories() {
            categoryListEl.innerHTML = ''; // Clear existing list

            // Add "All Notes" category
            const allNotesCount = notes.length;
            const allNotesItem = document.createElement('li');
            allNotesItem.classList.add('category-item');
            if (currentCategory === 'all') {
                allNotesItem.classList.add('active');
            }
            allNotesItem.dataset.category = 'all';
            allNotesItem.setAttribute('role', 'menuitem');
            allNotesItem.setAttribute('tabindex', '0'); // Make focusable
            allNotesItem.setAttribute('aria-selected', currentCategory === 'all'); // ARIA state
            allNotesItem.innerHTML = `
                <span>All Notes</span>
                <span class="category-count">${allNotesCount}</span>
            `;
            categoryListEl.appendChild(allNotesItem);

            // Add user-defined categories
            categories.forEach(category => {
                const categoryNotesCount = notes.filter(note => note.category === category).length;
                const categoryItem = document.createElement('li');
                categoryItem.classList.add('category-item');
                if (currentCategory === category) {
                    categoryItem.classList.add('active');
                }
                categoryItem.dataset.category = category;
                categoryItem.setAttribute('role', 'menuitem');
                categoryItem.setAttribute('tabindex', '0'); // Make focusable
                categoryItem.setAttribute('aria-selected', currentCategory === category); // ARIA state
                categoryItem.innerHTML = `
                    <span>${escapeHTML(category)}</span>
                    <span class="category-count">${categoryNotesCount}</span>
                `;
                categoryListEl.appendChild(categoryItem);
            });

            // Populate category select dropdown in note form
            noteCategoryEl.innerHTML = '<option value="">Select Category</option>'; // Default option
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                noteCategoryEl.appendChild(option);
            });

             renderCategoryManagementList();
        }

        function renderCategoryManagementList() {
             categoryListEditEl.innerHTML = '';
             categories.forEach(category => {
                 const li = document.createElement('li');
                 li.classList.add('category-item-edit');
                 li.setAttribute('role', 'listitem');
                 li.innerHTML = `
                     <span>${escapeHTML(category)}</span>
                     <button data-category="${escapeHTML(category)}" class="delete-category-button" aria-label="Delete category ${escapeHTML(category)}">
                         <span class="material-symbols-rounded" aria-hidden="true">delete</span>
                     </button>
                 `;
                 categoryListEditEl.appendChild(li);
             });
        }

        function renderNotes() {
            noteListEl.innerHTML = ''; // Clear existing notes

            const lowerSearchTerm = searchTerm.toLowerCase();
            const filteredNotes = notes.filter(note => {
                const matchesCategory = currentCategory === 'all' || note.category === currentCategory;
                const matchesSearch = note.title.toLowerCase().includes(lowerSearchTerm) ||
                                      note.content.toLowerCase().includes(lowerSearchTerm) ||
                                      (note.source || '').toLowerCase().includes(lowerSearchTerm) || // Handle null/undefined source
                                      note.category.toLowerCase().includes(lowerSearchTerm);
                return matchesCategory && matchesSearch;
            });

            // Sorting logic
            filteredNotes.sort((a, b) => {
                switch (currentSort) {
                    case 'date-desc':
                        // Treat empty/invalid dates as older (0 timestamp)
                        const dateA_desc = a.date ? new Date(a.date).getTime() : 0;
                        const dateB_desc = b.date ? new Date(b.date).getTime() : 0;
                        // Handle NaN results from invalid dates, treat as 0
                        const timeA_desc = isNaN(dateA_desc) ? 0 : dateA_desc;
                        const timeB_desc = isNaN(dateB_desc) ? 0 : dateB_desc;
                        return timeB_desc - timeA_desc;
                    case 'date-asc':
                         // Treat empty/invalid dates as newest (Infinity timestamp)
                         const dateA_asc = a.date ? new Date(a.date).getTime() : Infinity;
                         const dateB_asc = b.date ? new Date(b.date).getTime() : Infinity;
                         // Handle NaN results, treat as Infinity
                         const timeA_asc = isNaN(dateA_asc) ? Infinity : dateA_asc;
                         const timeB_asc = isNaN(dateB_asc) ? Infinity : dateB_asc;
                         return timeA_asc - timeB_asc;
                    case 'title-asc':
                        return a.title.localeCompare(b.title);
                    case 'title-desc':
                        return b.title.localeCompare(a.title);
                    default:
                        return 0; // No sorting
                }
            });


            if (filteredNotes.length === 0) {
                emptyStateEl.style.display = 'block';
                 noteListEl.setAttribute('aria-busy', 'false'); // Not busy when empty
            } else {
                emptyStateEl.style.display = 'none';
                 noteListEl.setAttribute('aria-busy', 'true'); // Busy while rendering
                filteredNotes.forEach(note => {
                    const noteCard = document.createElement('div');
                    noteCard.classList.add('note-card');
                    noteCard.dataset.id = note.id; // Use data attribute for ID
                    noteCard.setAttribute('tabindex', '0'); // Make card focusable
                    noteCard.setAttribute('role', 'article'); // Semantic role
                    noteCard.setAttribute('aria-label', `Note: ${escapeHTML(note.title)}`); // ARIA label for card

                    // Sanitize content snippet
                    const snippet = escapeHTML(note.content).substring(0, 150) + (note.content.length > 150 ? '...' : '');
                    const displayDate = note.date ? new Date(note.date).toLocaleDateString() : '';


                    noteCard.innerHTML = `
                        <h3>${escapeHTML(note.title)}</h3>
                        <p>${snippet}</p>
                        <div class="note-meta">
                            <div class="meta-left">
                                <span class="note-category">${escapeHTML(note.category)}</span>
                                ${displayDate ? `<span class="note-date">${displayDate}</span>` : ''}
                            </div>
                            <div class="note-actions">
                                <button class="edit-note-button" aria-label="Edit note ${escapeHTML(note.title)}">
                                    <span class="material-symbols-rounded" aria-hidden="true">edit</span>
                                </button>
                                <button class="delete-note-button delete" aria-label="Delete note ${escapeHTML(note.title)}">
                                    <span class="material-symbols-rounded" aria-hidden="true">delete</span>
                                </button>
                            </div>
                        </div>
                    `;
                    noteListEl.appendChild(noteCard);
                });
                 noteListEl.setAttribute('aria-busy', 'false'); // Finished rendering
            }

            // Update main header title
            currentCategoryTitleEl.textContent = currentCategory === 'all' ? 'All Notes' : escapeHTML(currentCategory);
        }

        // --- Note Management ---
        function openNoteModal(note = null) {
            // Reset form and error messages
            noteFormEl.reset();
            noteIdEl.value = '';
            hideError(titleErrorEl);
            hideError(contentErrorEl);
            hideError(categoryErrorEl);
            noteTitleEl.setAttribute('aria-invalid', 'false');
            noteContentEl.setAttribute('aria-invalid', 'false');
            noteCategoryEl.setAttribute('aria-invalid', 'false');


            if (note) {
                noteModalTitleEl.textContent = 'Edit Note';
                noteIdEl.value = note.id;
                noteTitleEl.value = note.title;
                noteContentEl.value = note.content;
                noteCategoryEl.value = note.category;
                noteSourceEl.value = note.source || '';
                noteDateEl.value = note.date || '';
            } else {
                noteModalTitleEl.textContent = 'Add New Note';
                 // Pre-select category if one is active (but not 'all')
                 if (currentCategory !== 'all' && categories.includes(currentCategory)) {
                     noteCategoryEl.value = currentCategory;
                 } else {
                     noteCategoryEl.value = ''; // Default to 'Select Category'
                 }
            }
            noteModalEl.showModal();
             // Focus on the first input field for accessibility
             noteTitleEl.focus();
        }

        function closeNoteModal() {
            noteModalEl.close();
        }

         function showError(element, message) {
             element.textContent = message;
             element.setAttribute('aria-hidden', 'false');
         }

         function hideError(element) {
             element.textContent = '';
             element.setAttribute('aria-hidden', 'true');
         }


        function saveNote(event) {
            event.preventDefault();

            // Basic validation
            let isValid = true;

            if (!noteTitleEl.value.trim()) {
                showError(titleErrorEl, 'Title is required.');
                noteTitleEl.setAttribute('aria-invalid', 'true');
                isValid = false;
            } else {
                 hideError(titleErrorEl);
                 noteTitleEl.setAttribute('aria-invalid', 'false');
            }

             if (!noteContentEl.value.trim()) {
                showError(contentErrorEl, 'Content is required.');
                 noteContentEl.setAttribute('aria-invalid', 'true');
                isValid = false;
            } else {
                 hideError(contentErrorEl);
                 noteContentEl.setAttribute('aria-invalid', 'false');
            }

             if (!noteCategoryEl.value) {
                showError(categoryErrorEl, 'Category is required.');
                 noteCategoryEl.setAttribute('aria-invalid', 'true');
                isValid = false;
            } else {
                 hideError(categoryErrorEl);
                 noteCategoryEl.setAttribute('aria-invalid', 'false');
            }

            if (!isValid) {
                // Focus the first invalid field
                const firstInvalid = noteFormEl.querySelector('[aria-invalid="true"]');
                if (firstInvalid) {
                    firstInvalid.focus();
                }
                return;
            }

            const id = noteIdEl.value || Date.now().toString(); // Use timestamp as simple ID
            const title = noteTitleEl.value.trim();
            const content = noteContentEl.value.trim();
            const category = noteCategoryEl.value;
            const source = noteSourceEl.value.trim();
            const date = noteDateEl.value; // Keep date as entered

            const newNote = { id, title, content, category, source, date };

            const existingIndex = notes.findIndex(note => note.id === id);

            if (existingIndex > -1) {
                // Update existing note
                notes[existingIndex] = newNote;
            } else {
                // Add new note
                notes.push(newNote);
            }

            saveNotes();
            renderNotes(); // Re-render the list
            renderCategories(); // Update counts
            closeNoteModal(); // Close the modal
        }

        function deleteNote(id) {
            const noteIndex = notes.findIndex(note => note.id === id);
            if (noteIndex > -1) {
                if (confirm(`Are you sure you want to delete "${notes[noteIndex].title}"?`)) {
                    notes.splice(noteIndex, 1);
                    saveNotes();
                    renderNotes(); // Re-render the list
                    renderCategories(); // Update counts
                }
            }
        }

        // --- Category Management ---
        function openCategoryModal() {
             renderCategoryManagementList();
             newCategoryInputEl.value = ''; // Clear input
             categoryModalEl.showModal();
             newCategoryInputEl.focus(); // Focus input
        }

        function closeCategoryModal() {
             categoryModalEl.close();
        }

        function addCategory() {
             const newCategory = newCategoryInputEl.value.trim();
             if (newCategory) {
                 if (!categories.includes(newCategory)) {
                    categories.push(newCategory);
                    saveCategories();
                    renderCategories(); // Update sidebar and form dropdown
                    renderCategoryManagementList(); // Update modal list
                    newCategoryInputEl.value = ''; // Clear input
                 } else {
                     alert('Category already exists.'); // Simple feedback for duplicate
                 }
             }
             newCategoryInputEl.focus(); // Keep focus on input
        }

        function deleteCategory(categoryToDelete) {
             // Check if any notes use this category
             const notesInCategory = notes.filter(note => note.category === categoryToDelete);
             if (notesInCategory.length > 0) {
                 alert(`Cannot delete category "${categoryToDelete}" because ${notesInCategory.length} note(s) are assigned to it. Please re-categorize or delete those notes first.`);
                 return;
             }

             if (confirm(`Are you sure you want to delete the category "${categoryToDelete}"?`)) {
                 categories = categories.filter(cat => cat !== categoryToDelete);
                 saveCategories();
                 renderCategories(); // Update sidebar and form dropdown
                 renderCategoryManagementList(); // Update modal list

                 // If the deleted category was the active one, switch to 'all'
                 if (currentCategory === categoryToDelete) {
                     selectCategory('all');
                 }
             }
        }


        // --- Filtering, Searching, and Sorting ---
        function selectCategory(category) {
            currentCategory = category;
            renderNotes(); // Re-render notes based on new category
            renderCategories(); // Update active state in sidebar
        }

        function handleSearchInput() {
            searchTerm = searchInputEl.value.trim();
            renderNotes(); // Re-render notes based on search term
        }

        function handleSortChange() {
            currentSort = sortSelectEl.value;
            renderNotes(); // Re-render notes based on new sort order
        }


        // --- Utility ---
        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            const div = document.createElement('div');
            div.appendChild(document.createTextNode(str));
            return div.innerHTML;
        }

        // --- Event Listeners ---
        addNoteButtonEl.addEventListener('click', () => openNoteModal());
        closeNoteModalButtonEl.addEventListener('click', closeNoteModal);
        cancelNoteButtonEl.addEventListener('click', closeNoteModal);
        noteFormEl.addEventListener('submit', saveNote);

        // Event delegation for edit/delete buttons on note cards and card click
        noteListEl.addEventListener('click', (event) => {
            const target = event.target;
            const noteCard = target.closest('.note-card');
            if (!noteCard) return;

            const noteId = noteCard.dataset.id;
            const note = notes.find(n => n.id === noteId);
            if (!note) return;

            if (target.closest('.edit-note-button')) {
                openNoteModal(note);
            } else if (target.closest('.delete-note-button')) {
                deleteNote(noteId);
            } else {
                // Clicking the card itself opens for edit
                 openNoteModal(note);
            }
        });

         // Keyboard navigation for note cards
         noteListEl.addEventListener('keydown', (event) => {
             const target = event.target;
             if (target.classList.contains('note-card') && event.key === 'Enter') {
                 const noteId = target.dataset.id;
                 const note = notes.find(n => n.id === noteId);
                 if (note) {
                     openNoteModal(note);
                 }
             }
         });


        // Event delegation for category selection in sidebar
        categoryListEl.addEventListener('click', (event) => {
            const target = event.target.closest('.category-item');
            if (target) {
                const category = target.dataset.category;
                selectCategory(category);
            }
        });

         // Keyboard navigation for category selection in sidebar
         categoryListEl.addEventListener('keydown', (event) => {
             const target = event.target;
             if (target.classList.contains('category-item') && event.key === 'Enter') {
                 const category = target.dataset.category;
                 selectCategory(category);
             }
         });


        // Search input listener with debounce
        let searchTimeout;
        searchInputEl.addEventListener('input', () => {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(handleSearchInput, 300); // Delay search by 300ms
        });

        // Sort select listener
        sortSelectEl.addEventListener('change', handleSortChange);


        // Category Management Modal Listeners
        manageCategoriesButtonEl.addEventListener('click', openCategoryModal);
        closeCategoryModalButtonEl.addEventListener('click', closeCategoryModal);
        addCategoryButtonModalEl.addEventListener('click', addCategory);
        newCategoryInputEl.addEventListener('keypress', (event) => {
            if (event.key === 'Enter') {
                event.preventDefault(); // Prevent form submission if input is inside a form
                addCategory();
            }
        });

        // Event delegation for delete category buttons in modal
        categoryListEditEl.addEventListener('click', (event) => {
            const target = event.target.closest('.delete-category-button');
            if (target) {
                const categoryToDelete = target.dataset.category;
                deleteCategory(categoryToDelete);
            }
        });

        // Close modals with Escape key
        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                if (noteModalEl.open) {
                    closeNoteModal();
                } else if (categoryModalEl.open) {
                    closeCategoryModal();
                }
            }
        });


        // --- Initial Load ---
        renderCategories();
        renderNotes();

    </script>

</body>
</html>
